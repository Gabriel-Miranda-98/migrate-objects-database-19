
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "ARTERH"."VW_DATA_APURACAO_FREQUENCIA" ("ORDEM_LOCAL", "FECHAMENTO_ORGANOGRAMA", "FECHAMENTO_AGRUPADOR", "FECHAMENTO_GERAL", "ID_AGRUP", "NIVEL_AGRUP_ESTRUT", "ID_AGRUP_SUP", "NIVEL_SUP_AGR_EST", "ORDEM_ESTRUT", "CODIGO_EMPRESA", "TIPO_AGRUP", "COD_AGRUP1", "COD_AGRUP2", "COD_AGRUP3", "COD_AGRUP4", "COD_AGRUP5", "COD_AGRUP6", "DESCRICAO", "ABREVIACAO", "CGC", "RAZAO_SOCIAL", "DATA_EXTINCAO") AS 
  SELECT W."ORDEM_LOCAL",W."FECHAMENTO_ORGANOGRAMA",W."FECHAMENTO_AGRUPADOR",W."FECHAMENTO_GERAL",W."ID_AGRUP",W."NIVEL_AGRUP_ESTRUT",W."ID_AGRUP_SUP",W."NIVEL_SUP_AGR_EST",W."ORDEM_ESTRUT",W."CODIGO_EMPRESA",W."TIPO_AGRUP",W."COD_AGRUP1",W."COD_AGRUP2",W."COD_AGRUP3",W."COD_AGRUP4",W."COD_AGRUP5",W."COD_AGRUP6",W."DESCRICAO",W."ABREVIACAO",W."CGC",W."RAZAO_SOCIAL",W."DATA_EXTINCAO" FROM(
SELECT
ROW_NUMBER()OVER(PARTITION BY Z.ID_AGRUP ORDER BY Z.COD_AGRUP1, Z.COD_AGRUP2, Z.COD_AGRUP3, Z.COD_AGRUP4, Z.COD_AGRUP5, Z.COD_AGRUP6, Z.ORDEM_ESTRUT, Z.NIVEL_SUP_AGR_EST) AS ORDEM_LOCAL,
Z.* FROM(
SELECT
FO.DATA_FIM_LOCAL FECHAMENTO_ORGANOGRAMA,
O.* FROM(
SELECT FA.DATA_FIM_LOCAL FECHAMENTO_AGRUPADOR,
(
SELECT MAX(x.data_fim_folha)from RHPONT_APUR_AGRUP x where x.codigo_empresa = '0001' and x.tipo_apur = 'F' AND c_livre_selec01 = 2 AND id_agrup = 152123)FECHAMENTO_GERAL,
--FG.DATA_FIM_LOCAL FECHAMENTO_GERAL,
--inicio--raiz de tudo
E.ID_AGRUP, E.NIVEL_AGRUP_ESTRUT, E.ID_AGRUP_SUP, E.NIVEL_SUP_AGR_EST, E.ORDEM_ESTRUT
,A.CODIGO_EMPRESA, A.TIPO_AGRUP, A.COD_AGRUP1, A.COD_AGRUP2, A.COD_AGRUP3, A.COD_AGRUP4, A.COD_AGRUP5, A.COD_AGRUP6, A.DESCRICAO, A.ABREVIACAO, A.CGC, A.RAZAO_SOCIAL, A.DATA_EXTINCAO
FROM RHORGA_ESTRUT_AGR E
LEFT OUTER JOIN RHORGA_AGRUPADOR A ON E.ID_AGRUP = A.ID_AGRUP
--fim--raiz de tudo
LEFT OUTER JOIN
(
--inicio--FECHAMENTO POR AGRUPADOR
select ID_AGRUP, MAX(DATA_INI_FOLHA) DATA_INI_LOCAL, MAX(DATA_FIM_FOLHA) DATA_FIM_LOCAL, C_LIVRE_OPCAO01
from RHPONT_APUR_AGRUP
WHERE --CODIGO_EMPRESA = '0001' AND --talvez comentar em 10/3/21
C_LIVRE_SELEC01 = 1 AND STATUS_APUR = 'P' AND C_LIVRE_DATA02 IS NOT NULL AND C_LIVRE_DATA03 IS NULL AND C_LIVRE_OPCAO01 = 'S'
GROUP BY ID_AGRUP, C_LIVRE_OPCAO01
--fim--FECHAMENTO POR AGRUPADOR
)FA ON FA.ID_AGRUP = E.ID_AGRUP

LEFT OUTER JOIN RHORGA_EMPRESA EM ON TRIM(A.CGC)=TRIM(EM.CGC) AND EM.CODIGO = A.CODIGO_EMPRESA --AND EM.c_livre_selec02 = 1 --novo em 10/3/21

WHERE --E.CODIGO_EMPRESA = '0001' AND--talvez comentar em 10/3/21
--AND E.ID_AGRUP_SUP = C1.ID_AGRUP--152123--PBH--25415--SMPOG---------COD DA TELA DE FECHAMENTO
--AND ((A.COD_AGRUP1 = '000094' AND A.DESCRICAO NOT LIKE '%ESCOLA%' AND A.DESCRICAO NOT LIKE '%EMEI%')OR A.COD_AGRUP1 <> '000094')--tirando escolas e emeis da SMED
 E.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHORGA_ESTRUT_AGR AUX WHERE AUX.ID_AGRUP = E.ID_AGRUP)
AND A.CODIGO_EMPRESA IN ('0001','0003','0013','0014')---NOVO EM 31/5/21--COLOCAR TODAS EMPRESAS JÁ INTEGRADAS E USAM O IFPONTO
AND TRIM(A.CGC)=TRIM(EM.CGC) AND A.TIPO_AGRUP = 'G'--novo em 10/3/21
AND A.DATA_EXTINCAO IS NULL
--AND E.NIVEL_AGRUP_ESTRUT = 2 AND A.CGC = '18715383000140'--TESTES DE NIVEL SECRETARIA
--AND E.NIVEL_AGRUP_ESTRUT = E.NIVEL_SUP_AGR_EST
ORDER BY A.COD_AGRUP1, A.COD_AGRUP2, A.COD_AGRUP3, A.COD_AGRUP4, A.COD_AGRUP5, A.COD_AGRUP6, E.ORDEM_ESTRUT, E.NIVEL_SUP_AGR_EST

)O
LEFT OUTER JOIN
(
--inicio--FECHAMENTO POR ORGANOGRAMA
select ID_AGRUP, MAX(DATA_INI_FOLHA) DATA_INI_LOCAL, MAX(DATA_FIM_FOLHA) DATA_FIM_LOCAL, C_LIVRE_OPCAO01
from RHPONT_APUR_AGRUP
WHERE --CODIGO_EMPRESA = '0001' AND --talvez comentar em 10/3/21
C_LIVRE_SELEC01 = 1 AND STATUS_APUR = 'P' AND C_LIVRE_DATA02 IS NOT NULL AND C_LIVRE_DATA03 IS NULL AND C_LIVRE_OPCAO01 = 'N'
GROUP BY ID_AGRUP, C_LIVRE_OPCAO01
--FIM--FECHAMENTO POR ORGANOGRAMA
)FO ON FO.ID_AGRUP = O.ID_AGRUP_SUP

)Z
WHERE (Z.FECHAMENTO_AGRUPADOR IS NOT NULL OR Z.FECHAMENTO_ORGANOGRAMA IS NOT NULL) OR Z.ID_AGRUP = Z.ID_AGRUP_SUP --Z.FECHAMENTO_GERAL IS NOT NULL
ORDER BY Z.COD_AGRUP1, Z.COD_AGRUP2, Z.COD_AGRUP3, Z.COD_AGRUP4, Z.COD_AGRUP5, Z.COD_AGRUP6, Z.ORDEM_ESTRUT, Z.NIVEL_SUP_AGR_EST
)W
WHERE W.ORDEM_LOCAL = 1

/* ----inicio----comentado em 31/5/21 
UNION ALL
SELECT 
1 ORDEM_LOCAL,
NULL FECHAMENTO_ORGANOGRAMA, NULL FECHAMENTO_AGRUPADOR, 
(SELECT MAX(x.data_fim_folha)from RHPONT_APUR_AGRUP x where x.codigo_empresa = '0001' and x.tipo_apur = 'F' AND c_livre_selec01 = 2 AND id_agrup = 152123) FECHAMENTO_GERAL,
A.ID_AGRUP, A.NIVEL_AGRUP_ESTRUT, NULL ID_AGRUP_SUP, NULL NIVEL_SUP_AGR_EST,NULL ORDEM_ESTRUT, A.CODIGO_EMPRESA, A.TIPO_AGRUP, A.COD_AGRUP1, A.COD_AGRUP2, A.COD_AGRUP3, A.COD_AGRUP4, A.COD_AGRUP5, A.COD_AGRUP6, 
A.DESCRICAO, A.ABREVIACAO, A.CGC, A.RAZAO_SOCIAL, A.DATA_EXTINCAO
FROM RHORGA_AGRUPADOR A WHERE CODIGO_EMPRESA = '0001' AND A.TIPO_AGRUP = 'G'
AND((A.COD_AGRUP1 = '000099' AND A.COD_AGRUP2 = '000098' AND A.COD_AGRUP3 = '000004' AND A.COD_AGRUP4 = '000000' AND A.COD_AGRUP5 = '000000' AND A.COD_AGRUP6 = '000001')OR
(A.COD_AGRUP1 = '000099' AND A.COD_AGRUP2 = '000098' AND A.COD_AGRUP3 = '000004' AND A.COD_AGRUP4 = '000000' AND A.COD_AGRUP5 = '000000' AND A.COD_AGRUP6 = '000002')OR
(A.COD_AGRUP1 = '000099' AND A.COD_AGRUP2 = '000098' AND A.COD_AGRUP3 = '000004' AND A.COD_AGRUP4 = '000000' AND A.COD_AGRUP5 = '000000' AND A.COD_AGRUP6 = '000005'))
 */----fim----comentado em 31/5/21 

----------------------------novo em  31/5/21 
UNION ALL ---------------------NOVO
SELECT 
1 ORDEM_LOCAL,
NULL FECHAMENTO_ORGANOGRAMA, NULL FECHAMENTO_AGRUPADOR, 
(SELECT MAX(x.data_fim_folha)from RHPONT_APUR_AGRUP x where x.codigo_empresa = '0001' and x.tipo_apur = 'F' AND c_livre_selec01 = 2 AND id_agrup = 152123) FECHAMENTO_GERAL,
A.ID_AGRUP, A.NIVEL_AGRUP_ESTRUT, NULL ID_AGRUP_SUP, NULL NIVEL_SUP_AGR_EST,NULL ORDEM_ESTRUT, A.CODIGO_EMPRESA, A.TIPO_AGRUP, A.COD_AGRUP1, A.COD_AGRUP2, A.COD_AGRUP3, A.COD_AGRUP4, A.COD_AGRUP5, A.COD_AGRUP6, 
A.DESCRICAO, A.ABREVIACAO, A.CGC, A.RAZAO_SOCIAL, A.DATA_EXTINCAO
FROM RHORGA_AGRUPADOR A 
WHERE CODIGO_EMPRESA IN('0001','0003','0013','0014')
AND A.TIPO_AGRUP = 'G'
AND A.DATA_EXTINCAO IS NULL
AND A.ID_AGRUP NOT IN 
(
SELECT  W.ID_AGRUP FROM(
SELECT
ROW_NUMBER()OVER(PARTITION BY Z.ID_AGRUP ORDER BY Z.COD_AGRUP1, Z.COD_AGRUP2, Z.COD_AGRUP3, Z.COD_AGRUP4, Z.COD_AGRUP5, Z.COD_AGRUP6, Z.ORDEM_ESTRUT, Z.NIVEL_SUP_AGR_EST) AS ORDEM_LOCAL,
Z.* FROM(
SELECT
FO.DATA_FIM_LOCAL FECHAMENTO_ORGANOGRAMA,
O.* FROM(
SELECT FA.DATA_FIM_LOCAL FECHAMENTO_AGRUPADOR,
(
SELECT MAX(x.data_fim_folha)from RHPONT_APUR_AGRUP x where x.codigo_empresa = '0001' and x.tipo_apur = 'F' AND c_livre_selec01 = 2 AND id_agrup = 152123)FECHAMENTO_GERAL,
--FG.DATA_FIM_LOCAL FECHAMENTO_GERAL,
--inicio--raiz de tudo
E.ID_AGRUP, E.NIVEL_AGRUP_ESTRUT, E.ID_AGRUP_SUP, E.NIVEL_SUP_AGR_EST, E.ORDEM_ESTRUT
,A.CODIGO_EMPRESA, A.TIPO_AGRUP, A.COD_AGRUP1, A.COD_AGRUP2, A.COD_AGRUP3, A.COD_AGRUP4, A.COD_AGRUP5, A.COD_AGRUP6, A.DESCRICAO, A.ABREVIACAO, A.CGC, A.RAZAO_SOCIAL, A.DATA_EXTINCAO
FROM RHORGA_ESTRUT_AGR E
LEFT OUTER JOIN RHORGA_AGRUPADOR A ON E.ID_AGRUP = A.ID_AGRUP
--fim--raiz de tudo
LEFT OUTER JOIN
(
--inicio--FECHAMENTO POR AGRUPADOR
select ID_AGRUP, MAX(DATA_INI_FOLHA) DATA_INI_LOCAL, MAX(DATA_FIM_FOLHA) DATA_FIM_LOCAL, C_LIVRE_OPCAO01
from RHPONT_APUR_AGRUP
WHERE --CODIGO_EMPRESA = '0001' AND --talvez comentar em 10/3/21
C_LIVRE_SELEC01 = 1 AND STATUS_APUR = 'P' AND C_LIVRE_DATA02 IS NOT NULL AND C_LIVRE_DATA03 IS NULL AND C_LIVRE_OPCAO01 = 'S'
GROUP BY ID_AGRUP, C_LIVRE_OPCAO01
--fim--FECHAMENTO POR AGRUPADOR
)FA ON FA.ID_AGRUP = E.ID_AGRUP

LEFT OUTER JOIN RHORGA_EMPRESA EM ON TRIM(A.CGC)=TRIM(EM.CGC) AND EM.CODIGO = A.CODIGO_EMPRESA --AND EM.c_livre_selec02 = 1 --novo em 10/3/21

WHERE --E.CODIGO_EMPRESA = '0001' AND--talvez comentar em 10/3/21
--AND E.ID_AGRUP_SUP = C1.ID_AGRUP--152123--PBH--25415--SMPOG---------COD DA TELA DE FECHAMENTO
--AND ((A.COD_AGRUP1 = '000094' AND A.DESCRICAO NOT LIKE '%ESCOLA%' AND A.DESCRICAO NOT LIKE '%EMEI%')OR A.COD_AGRUP1 <> '000094')--tirando escolas e emeis da SMED
 E.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHORGA_ESTRUT_AGR AUX WHERE AUX.ID_AGRUP = E.ID_AGRUP)
--COMENTADO EM 31/5/21--AND A.CODIGO_EMPRESA in ('0001','0003') --novo em 10/21 incluindo empresa 3--AND A.CODIGO_EMPRESA = '0001' --talvez comentar em 10/3/21
AND A.CODIGO_EMPRESA  IN ('0001','0003','0013','0014')---NOVO EM 31/5/21--COLOCAR TODAS EMPRESAS JÁ INTEGRADAS E USAM O IFPONTO
AND TRIM(A.CGC)=TRIM(EM.CGC) AND A.TIPO_AGRUP = 'G'--novo em 10/3/21
AND A.DATA_EXTINCAO IS NULL
--AND E.NIVEL_AGRUP_ESTRUT = 2 AND A.CGC = '18715383000140'--TESTES DE NIVEL SECRETARIA
--AND E.NIVEL_AGRUP_ESTRUT = E.NIVEL_SUP_AGR_EST
ORDER BY A.COD_AGRUP1, A.COD_AGRUP2, A.COD_AGRUP3, A.COD_AGRUP4, A.COD_AGRUP5, A.COD_AGRUP6, E.ORDEM_ESTRUT, E.NIVEL_SUP_AGR_EST

)O
LEFT OUTER JOIN
(
--inicio--FECHAMENTO POR ORGANOGRAMA
select ID_AGRUP, MAX(DATA_INI_FOLHA) DATA_INI_LOCAL, MAX(DATA_FIM_FOLHA) DATA_FIM_LOCAL, C_LIVRE_OPCAO01
from RHPONT_APUR_AGRUP
WHERE --CODIGO_EMPRESA = '0001' AND --talvez comentar em 10/3/21
C_LIVRE_SELEC01 = 1 AND STATUS_APUR = 'P' AND C_LIVRE_DATA02 IS NOT NULL AND C_LIVRE_DATA03 IS NULL AND C_LIVRE_OPCAO01 = 'N'
GROUP BY ID_AGRUP, C_LIVRE_OPCAO01
--FIM--FECHAMENTO POR ORGANOGRAMA
)FO ON FO.ID_AGRUP = O.ID_AGRUP_SUP

)Z
WHERE (Z.FECHAMENTO_AGRUPADOR IS NOT NULL OR Z.FECHAMENTO_ORGANOGRAMA IS NOT NULL) OR Z.ID_AGRUP = Z.ID_AGRUP_SUP --Z.FECHAMENTO_GERAL IS NOT NULL
ORDER BY Z.COD_AGRUP1, Z.COD_AGRUP2, Z.COD_AGRUP3, Z.COD_AGRUP4, Z.COD_AGRUP5, Z.COD_AGRUP6, Z.ORDEM_ESTRUT, Z.NIVEL_SUP_AGR_EST
)W
WHERE W.ORDEM_LOCAL = 1)

----------------------------fim em  31/5/21