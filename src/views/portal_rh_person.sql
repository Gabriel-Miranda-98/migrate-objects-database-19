
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "ARTERH"."portal_rh_person" ("loginAd", "contractCode", "name", "homeSecretary", "workPlace", "birthDate", "noteUltimaEvaluation", "currentPosition", "scale", "functionalSituation", "email") AS 
  SELECT 
--EMP.CODIGO||'-'||emp.razao_social AS empresa,
u.codigo_usuario as "loginAd",
--TP.CODIGO||'-'||TP.DESCRICAO AS TIPO_CONTRATO,
C.CODIGO AS "contractCode",
CASE WHEN  TRIM(P.NOME_SOCIAL) IS NOT NULL THEN TRIM(P.NOME_SOCIAL)  ELSE TRIM(P.NOME) END AS "name",
g.cod_cgerenc1||'-'||NVL(sec.DESCRICAO,sec.texto_associado) AS "homeSecretary",
G.cod_cgerenc1||'.'||G.cod_cgerenc2||'.'||G.cod_cgerenc3||'.'||G.cod_cgerenc4||'.'||G.cod_cgerenc5||'.'||G.cod_cgerenc6||'-'||NVL(G.DESCRICAO,G.texto_associado) AS "workPlace",
p.data_nascimento "birthDate",
--FLOOR(MONTHS_BETWEEN(SYSDATE, p.data_nascimento) / 12) AS anos,
--FLOOR(MOD(MONTHS_BETWEEN(SYSDATE, p.data_nascimento), 12)) AS meses,
--TRUNC(SYSDATE - ADD_MONTHS(p.data_nascimento, FLOOR(MONTHS_BETWEEN(SYSDATE, p.data_nascimento) / 12) * 12 + FLOOR(MOD(MONTHS_BETWEEN(SYSDATE, p.data_nascimento), 12)))) AS dias,
x.PONTUAC_TOTAL as "noteUltimaEvaluation",
CG.DESCRICAO AS "currentPosition",
EL.CODIGO||'-'||EL.DESCRICAO AS "scale",
SF.DESCRICAO AS "functionalSituation",
C.e_mail "email"
FROM ARTERH.RHUSER_P_SIST U
INNER JOIN ARTERH.RHPESS_CONTRATO C
ON C.CODIGO_EMPRESA=U.EMPRESA_USUARIO
AND C.TIPO_CONTRATO=U.TP_CONTR_USUARIO
AND C.CODIGO=U.CONTRATO_USUARIO
INNER JOIN ARTERH.RHPESS_PESSOA P 
ON P.CODIGO=C.CODIGO_PESSOA
AND P.CODIGO_EMPRESA=C.CODIGO_EMPRESA
INNER JOIN ARTERH.RHORGA_CUSTO_GEREN G
ON G.CODIGO_EMPRESA=C.CODIGO_EMPRESA
AND g.cod_cgerenc1=c.cod_custo_gerenc1
AND g.cod_cgerenc2=c.cod_custo_gerenc2
AND g.cod_cgerenc3=c.cod_custo_gerenc3
AND g.cod_cgerenc4=c.cod_custo_gerenc4
AND g.cod_cgerenc5=c.cod_custo_gerenc5
AND g.cod_cgerenc6=c.cod_custo_gerenc6
INNER JOIN ARTERH.RHORGA_CUSTO_GEREN sec
ON sec.CODIGO_EMPRESA=C.CODIGO_EMPRESA
AND sec.cod_cgerenc1=c.cod_custo_gerenc1
AND sec.cod_cgerenc2='000000'
AND sec.cod_cgerenc3='000000'
AND sec.cod_cgerenc4='000000'
AND sec.cod_cgerenc5='000000'
AND sec.cod_cgerenc6='000000'
INNER JOIN ARTERH.RHPLCS_CARGO CG 
ON CG.CODIGO_EMPRESA=C.CODIGO_EMPRESA
AND CG.CODIGO=C.COD_CARGO_EFETIVO
LEFT OUTER JOIN (
SELECT VL.CODIGO_EMPRESA,VL.TIPO_CONTRATO,VL.CODIGO_CONTRATO,VL.PONTUAC_TOTAL FROM ARTERH.RHCOMP_AVALIACAO VL
WHERE  VL.STATUS_AVALIACAO=10
AND VL.ID_AVALIACAO=(SELECT MAX(AUX.ID_AVALIACAO) FROM ARTERH.RHCOMP_AVALIACAO AUX 
WHERE AUX.CODIGO_EMPRESA=VL.CODIGO_EMPRESA
AND AUX.TIPO_CONTRATO=VL.TIPO_CONTRATO
AND AUX.CODIGO_CONTRATO=VL.CODIGO_CONTRATO
AND AUX.STATUS_AVALIACAO=VL.STATUS_AVALIACAO)
)X
ON X.CODIGO_EMPRESA=C.CODIGO_EMPRESA
AND X.TIPO_CONTRATO=C.TIPO_CONTRATO
AND X.CODIGO_CONTRATO=C.CODIGO
INNER JOIN ARTERH.RHORGA_EMPRESA EMP
ON EMP.CODIGO=C.CODIGO_EMPRESA
INNER JOIN ARTERH.RHPESS_TP_CONTRATO TP
ON TP.CODIGO=C.TIPO_CONTRATO
INNER JOIN ARTERH.RHPONT_ESCALA EL
ON EL.CODIGO_EMPRESA=C.CODIGO_EMPRESA
AND EL.CODIGO=C.CODIGO_ESCALA
INNER JOIN ARTERH.RHPARM_SIT_FUNC SF
ON SF.CODIGO=C.SITUACAO_FUNCIONAL
WHERE C.ANO_MES_REFERENCIA=(SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM ARTERH.RHPESS_CONTRATO AUX 
WHERE AUX.CODIGO=C.CODIGO
AND AUX.TIPO_CONTRATO=C.TIPO_CONTRATO
AND AUX.CODIGO_EMPRESA=C.CODIGO_EMPRESA)
AND C.DATA_RESCISAO IS NULL