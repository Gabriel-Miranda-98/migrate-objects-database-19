
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "PONTO_ELETRONICO"."VIEW_CONTRATO_GESTOR_PESSOA" ("CODIGO_PESSOA", "CODIGO", "TIPO_CONTRATO", "CODIGO_EMPRESA") AS 
  SELECT

x.CODIGO_PESSOA,
CASE WHEN X.QUANT >1 THEN GESTOR2.CODIGO ELSE GESTOR1.CODIGO END AS CODIGO,
CASE WHEN X.QUANT >1 THEN GESTOR2.TIPO_CONTRATO ELSE GESTOR1.TIPO_CONTRATO END AS TIPO_CONTRATO,
CASE WHEN X.QUANT >1 THEN GESTOR2.CODIGO_EMPRESA ELSE GESTOR1.CODIGO_EMPRESA END AS CODIGO_EMPRESA

FROM
(
SELECT
COUNT(1) quant, TIPO_CONTRATO,CODIGO_EMPRESA,CODIGO_PESSOA
FROM
arterh.rhpess_contrato c
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT')PONT
ON SUBSTR(PONT.DADO_ORIGEM,20,4)=C.CODIGO_EMPRESA AND SUBSTR(PONT.DADO_ORIGEM,24,4)=C.TIPO_CONTRATO

WHERE c.ano_mes_referencia = (
SELECT
MAX(aux.ano_mes_referencia)
FROM
arterh.rhpess_contrato aux
WHERE
aux.codigo = c.codigo
AND aux.tipo_contrato = c.tipo_contrato
AND aux.codigo_empresa = c.codigo_empresa
)
AND SUBSTR(PONT.DADO_ORIGEM,20,4) IS NOT NULL

GROUP BY TIPO_CONTRATO,CODIGO_EMPRESA,CODIGO_PESSOA
) x
LEFT OUTER JOIN (SELECT * FROM arterh.rhpess_contrato c WHERE c.ano_mes_referencia = (
SELECT
MAX(aux.ano_mes_referencia)
FROM
arterh.rhpess_contrato aux
WHERE
aux.codigo = c.codigo
AND aux.tipo_contrato = c.tipo_contrato
AND aux.codigo_empresa = c.codigo_empresa
)
)
GESTOR1
ON GESTOR1.CODIGO_PESSOA=X.CODIGO_PESSOA
AND GESTOR1.CODIGO_EMPRESA=X.CODIGO_EMPRESA
AND GESTOR1.TIPO_CONTRATO=X.TIPO_CONTRATO
LEFT OUTER JOIN (SELECT * FROM arterh.rhpess_contrato c WHERE c.ano_mes_referencia = (
SELECT
MAX(aux.ano_mes_referencia)
FROM
arterh.rhpess_contrato aux
WHERE
aux.codigo = c.codigo
AND aux.tipo_contrato = c.tipo_contrato
AND aux.codigo_empresa = c.codigo_empresa
)

AND C.SITUACAO_FUNCIONAL =(SELECT CODIGO FROM ARTERH.RHPARM_SIT_FUNC SF WHERE SF.CODIGO =C.SITUACAO_FUNCIONAL AND SF.CONTROLE_FOLHA NOT IN('D','S')
AND SF.DATA_FIM_VIGENCIA IS NULL
)
AND C.DATA_RESCISAO IS NULL
AND C.situacao_funcional NOT IN (1017)
)
GESTOR2
ON GESTOR2.CODIGO_PESSOA=X.CODIGO_PESSOA
AND GESTOR2.CODIGO_EMPRESA=X.CODIGO_EMPRESA
AND GESTOR2.TIPO_CONTRATO=X.TIPO_CONTRATO

GROUP BY x.CODIGO_PESSOA,
CASE WHEN X.QUANT >1 THEN GESTOR2.CODIGO ELSE GESTOR1.CODIGO END ,
CASE WHEN X.QUANT >1 THEN GESTOR2.TIPO_CONTRATO ELSE GESTOR1.TIPO_CONTRATO END ,
CASE WHEN X.QUANT >1 THEN GESTOR2.CODIGO_EMPRESA ELSE GESTOR1.CODIGO_EMPRESA END