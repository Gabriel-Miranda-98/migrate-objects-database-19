
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "ARTERH"."ENDERECOS_ATIVOS" ("COD_ORG", "MATRICULA_SEGURADO", "DIGITO_MATRICULA", "CPF", "TIPO_LOGRADOURO", "LOGRADOURO", "NUMERO", "COMPLEMENTO", "BAIRRO", "MUNICIPIO", "UF", "CEP", "CAIXA_POSTAL", "DATA_CADASTRO") AS 
  SELECT 
  1 AS COD_ORG,
  SUBSTR(EP.CODIGO_PESSOA, 5,10) AS MATRICULA_SEGURADO,
  CASE WHEN SUBSTR(EP.CODIGO_PESSOA, 15,1) = 'X' THEN '7' ELSE SUBSTR(EP.CODIGO_PESSOA, 15,1) END AS DIGITO_MATRICULA,
  SUBSTR(PE.CPF, 1,11) AS CPF,
  CASE          
  WHEN  EP.TIPO_LOGRADOURO  = '0004'  THEN  004
  WHEN  EP.TIPO_LOGRADOURO  = '0002'  THEN  008
  WHEN  EP.TIPO_LOGRADOURO  = '0010'  THEN  008
  WHEN  EP.TIPO_LOGRADOURO  = '0005'  THEN  031
  WHEN  EP.TIPO_LOGRADOURO  = '0003'  THEN  065
  WHEN  EP.TIPO_LOGRADOURO  = '0012'  THEN  077
  WHEN  EP.TIPO_LOGRADOURO  = '0001'  THEN  081
  WHEN  EP.TIPO_LOGRADOURO  = '0011'  THEN  090
  WHEN  EP.TIPO_LOGRADOURO  = '0009'  THEN  100
  WHEN  EP.TIPO_LOGRADOURO  = '0016'  THEN  104
  WHEN  EP.TIPO_LOGRADOURO  = '0006'  THEN  031
  WHEN  EP.TIPO_LOGRADOURO  = '0008'  THEN  004
  WHEN  EP.TIPO_LOGRADOURO  = '0017'  THEN  104
  WHEN  EP.TIPO_LOGRADOURO  = '0018'  THEN  004
  WHEN  EP.TIPO_LOGRADOURO  = '0019'  THEN  004
  else  004/*NULL*/
  END AS TIPO_LOGRADOURO,
  TRIM(EP.ENDERECO) AS LOGRADOURO,
  to_number(NVL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(TRANSLATE(TRIM(EP.NUMERO),'ABCDEFGHIJKLMNOPQRSTUVXYWZabcdefghijklmnopqrstuvxywz',' '),' ',''),',',''),'/',''),'-',''),'.',''),'ยบ',''),'*****',''),':',''),'''',''),'0')) AS NUMERO,
  TRIM(EP.COMPLEMENTO) AS COMPLEMENTO,
  SUBSTR(TRIM(EP.BAIRRO),1,50) AS BAIRRO,
  SUBSTR(TRIM(M.DESCRICAO),1,40) AS MUNICIPIO,
  SUBSTR(TRIM(EP.UF),1,2) AS UF,
  NVL(SUBSTR(TRIM(EP.CEP), 1,8),'0') AS CEP,
  (NVL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(SUBSTR(TRIM(EP.CAIXA_POSTAL),1,8),' ',''),',',''),'/',''),'-',''),'.',''),'0')) AS CAIXA_POSTAL,  
  TRIM(ANO_MES_REFERENCIA) AS DATA_CADASTRO

FROM RHPESS_CONTRATO CO
LEFT OUTER JOIN RHPESS_ENDERECO_P EP
ON EP.CODIGO_EMPRESA = CO.CODIGO_EMPRESA
AND EP.CODIGO_PESSOA = CO.CODIGO_PESSOA
LEFT OUTER JOIN RHPESS_PESSOA PE
ON CO.CODIGO_EMPRESA = PE.CODIGO_EMPRESA
AND CO.CODIGO_PESSOA = PE.CODIGO
AND EP.CODIGO_PESSOA = PE.CODIGO
LEFT OUTER JOIN RHTABS_TP_LOGRAD L
ON EP.TIPO_LOGRADOURO = L.CODIGO
LEFT OUTER JOIN RHTABS_MUNICIPIO M
ON EP.MUNICIPIO = M.CODIGO
LEFT OUTER JOIN RHTABS_UF
ON EP.UF                  = RHTABS_UF.CODIGO

WHERE 
CO.CODIGO_EMPRESA = ('0001')
AND CO.TIPO_CONTRATO = ('0001')
AND CO.VINCULO IN ('0000','0002')
--and pe.codigo = '000000000179586'
AND CO.SITUACAO_FUNCIONAL NOT IN ('1715','1800','1850','1900','5005','5006','5008','5009','5011','5200','5700','5900','5901','6002','8000')
AND (CO.CODIGO < '000000001530000' AND CO.CODIGO NOT IN('000000000777777','000000000823701','000000000833014','000000000866265','000000000747428','000000000190072','000000000420534'))
--AND SUBSTR(CO.CODIGO,5,10) ='0000091112' --'0000009627'
AND CO.ANO_MES_REFERENCIA  =
  (SELECT MAX(A.ANO_MES_REFERENCIA)
  FROM RHPESS_CONTRATO A
  WHERE A.CODIGO            = CO.CODIGO
  AND A.CODIGO_EMPRESA      = CO.CODIGO_EMPRESA
  AND A.TIPO_CONTRATO       = CO.TIPO_CONTRATO
  AND A.ANO_MES_REFERENCIA <= add_months(sysdate,(-1))-0)
  and not exists (select c.codigo from rhpess_contrato c where 
C.CODIGO_EMPRESA = ('1700')
AND C.TIPO_CONTRATO = '0001'
AND C.VINCULO IN ('0000','0002')
AND C.SITUACAO_FUNCIONAL = '5800'
--AND CO.SITUACAO_FUNCIONAL NOT IN ('1700','1002','1701','1715','1800','1900','5000','5002','5003','5004','5005','5006','5008','5009','5011','5200','5700','5900','5901','6002','8000')
--AND SUBSTR(CO.CODIGO,5,10) ='0000091112' --'0000009627'
AND C.CODIGO < '000000010000000'
AND C.ANO_MES_REFERENCIA  =
  (SELECT MAX(B.ANO_MES_REFERENCIA)
  FROM RHPESS_CONTRATO B
  WHERE B.CODIGO            = C.CODIGO
  AND B.CODIGO_EMPRESA      = C.CODIGO_EMPRESA
  AND B.TIPO_CONTRATO       = C.TIPO_CONTRATO
  AND B.ANO_MES_REFERENCIA <= add_months(sysdate,(-1))-0)AND C.CODIGO = CO.CODIGO)
  
      ORDER BY CO.CODIGO