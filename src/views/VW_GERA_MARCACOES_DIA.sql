
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "PONTO_ELETRONICO"."VW_GERA_MARCACOES_DIA" ("ORDEM_DIA_CPF", "DATA_DIA", "DIA_SEMANA", "NRO_DIA_SEMANA", "NRO_SEMANA_MES", "CPF", "BM_U", "TIPO_JORNADA_U", "TURNO_U", "ORDEM_TURNO", "ORDEM_ID_HORARIO", "ID_HORARIO", "DATA", "ULTIMO_REGISTRO", "ULT_ORDEM_ID_HORARIO", "ULT_DATA_PROCESSAMENTO", "ULT_DATA_INICIO", "ULT_DATA_FIM", "ULT_DATA_CANCELAMENTO", "ULT_MARCACOES", "ULT_DADOS_REGENCIA", "ULT_INI_TURNO", "ULT_PRIMEIRA_MARCACAO", "ULT_SEGUNDA_MARCACAO", "ULT_TERCEIRA_MARCACAO", "ULT_QUARTA_MARCACAO", "ULT_QUINTA_MARCACAO", "ULT_SEXTA_MARCACAO", "PENULTIMO_REGISTRO", "PENUL_ORDEM_ID_HORARIO", "PENUL_DATA_PROCESSAMENTO", "PENUL_DATA_INICIO", "PENUL_DATA_FIM", "PENUL_DATA_CANCELAMENTO", "PENUL_MARCACOES", "PENUL_DADOS_REGENCIA", "PENUL_INI_TURNO", "PENUL_PRIMEIRA_MARCACAO", "PENUL_SEGUNDA_MARCACAO", "PENUL_TERCEIRA_MARCACAO", "PENUL_QUARTA_MARCACAO", "PENUL_QUINTA_MARCACAO", "PENUL_SEXTA_MARCACAO") AS 
  (
  

SELECT
ROW_NUMBER() OVER(PARTITION BY X2.CPF, X2.DATA ORDER BY X2.CPF, X2.ID_HORARIO, DT.DATA_DIA, X2.DATA)ORDEM_DIA_CPF, 
DT.DATA_DIA, DT.DIA_SEMANA ,DT.NRO_DIA_SEMANA ,DT.NRO_SEMANA_MES,
X2.CPF, X2.BM_U, X2.TIPO_JORNADA_U, X2.TURNO_U, X2.ORDEM_TURNO, X2.ORDEM_ID_HORARIO, X2.ID_HORARIO, X2.DATA, X2.ULTIMO_REGISTRO, X2.ULT_ORDEM_ID_HORARIO, X2.ULT_DATA_PROCESSAMENTO, X2.ULT_DATA_INICIO, X2.ULT_DATA_FIM, X2.ULT_DATA_CANCELAMENTO, X2.ULT_MARCACOES, X2.ULT_DADOS_REGENCIA, X2.ULT_INI_TURNO, X2.ULT_PRIMEIRA_MARCACAO, X2.ULT_SEGUNDA_MARCACAO, X2.ULT_TERCEIRA_MARCACAO, X2.ULT_QUARTA_MARCACAO, X2.ULT_QUINTA_MARCACAO, X2.ULT_SEXTA_MARCACAO, X2.PENULTIMO_REGISTRO, X2.PENUL_ORDEM_ID_HORARIO, X2.PENUL_DATA_PROCESSAMENTO, X2.PENUL_DATA_INICIO, X2.PENUL_DATA_FIM, X2.PENUL_DATA_CANCELAMENTO, X2.PENUL_MARCACOES, X2.PENUL_DADOS_REGENCIA, X2.PENUL_INI_TURNO, X2.PENUL_PRIMEIRA_MARCACAO, X2.PENUL_SEGUNDA_MARCACAO, X2.PENUL_TERCEIRA_MARCACAO, X2.PENUL_QUARTA_MARCACAO, X2.PENUL_QUINTA_MARCACAO, X2.PENUL_SEXTA_MARCACAO
FROM(
SELECT
--LEAD(X.DATA, 1, NULL) OVER(PARTITION BY X.ID_HORARIO ORDER BY X.ID_HORARIO, X.DATA, X. ULT_DATA_PROCESSAMENTO DESC) DATA_SEGUINTE,
X.* FROM (
SELECT 
D.CPF, D.BM_U, D.TIPO_JORNADA_U, D.TURNO_U, 
D.ORDEM_TURNO, D.ORDEM_ID_HORARIO, 
D.ID_HORARIO, D.DATA, 
'ULTIMO_REGISTRO' ULTIMO_REGISTRO, D.ORDEM_ID_HORARIO ULT_ORDEM_ID_HORARIO, D.DATA_PROCESSAMENTO ULT_DATA_PROCESSAMENTO, D.DATA_INICIO_U ULT_DATA_INICIO, D.DATA_FIM_U ULT_DATA_FIM, D.DATA_CANCELAMENTO_U ULT_DATA_CANCELAMENTO,
D.MARCACOES ULT_MARCACOES, D.DADOS_REGENCIA ULT_DADOS_REGENCIA, 
LTRIM(SUBSTR(D.DADOS_REGENCIA,1,4),0) ULT_INI_TURNO, LTRIM(SUBSTR(D.DADOS_REGENCIA,6,4),0) ULT_PRIMEIRA_MARCACAO, LTRIM(SUBSTR(D.DADOS_REGENCIA,11,4),0) ULT_SEGUNDA_MARCACAO, 
LTRIM(SUBSTR(D.DADOS_REGENCIA,16,4),0) ULT_TERCEIRA_MARCACAO, LTRIM(SUBSTR(D.DADOS_REGENCIA,21,4),0) ULT_QUARTA_MARCACAO,
LTRIM(SUBSTR(D.DADOS_REGENCIA,26,4),0) ULT_QUINTA_MARCACAO, LTRIM(SUBSTR(D.DADOS_REGENCIA,31,4),0) ULT_SEXTA_MARCACAO
--D.MARCACAO_1 ULT_MARCACAO_1, D.MARCACAO_2 ULT_MARCACAO_2, D.MARCACAO_3 ULT_MARCACAO_3, D.MARCACAO_4 ULT_MARCACAO_4, D.MARCACAO_5 ULT_MARCACAO_5, D.MARCACAO_6 ULT_MARCACAO_6
,'PENULTIMO_REGISTRO' PENULTIMO_REGISTRO, 
LEAD(D.ORDEM_ID_HORARIO, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_ORDEM_ID_HORARIO,
LEAD(D.DATA_PROCESSAMENTO, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_DATA_PROCESSAMENTO,
LEAD(D.DATA_INICIO_U, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_DATA_INICIO,
LEAD(D.DATA_FIM_U, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_DATA_FIM,
LEAD(D.DATA_CANCELAMENTO_U, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_DATA_CANCELAMENTO,
LEAD(D.MARCACOES, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_MARCACOES,
LEAD(D.DADOS_REGENCIA, 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_DADOS_REGENCIA
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,1,4),0), 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_INI_TURNO
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,6,4),0), 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_PRIMEIRA_MARCACAO
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,11,4),0), 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_SEGUNDA_MARCACAO
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,16,4),0), 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_TERCEIRA_MARCACAO
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,21,4),0) , 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_QUARTA_MARCACAO
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,26,4),0), 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_QUINTA_MARCACAO
,LEAD(LTRIM(SUBSTR(D.DADOS_REGENCIA,31,4),0), 1, NULL) OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC) PENUL_SEXTA_MARCACAO
FROM (
SELECT 
P.CPF,
A.BM_U, A.TIPO_JORNADA_U, A.TURNO_U, A.DATA_INICIO_U, A.DATA_FIM_U, A.DATA_CANCELAMENTO_U,
CASE WHEN A.TURNO_U = 'MANHÃ' THEN 1 WHEN A.TURNO_U = 'INTERMEDIÁRIO' THEN 2 WHEN A.TURNO_U = 'TARDE' THEN 3 WHEN A.TURNO_U = 'NOITE' THEN 4 END ORDEM_TURNO,
ROW_NUMBER() OVER(PARTITION BY D.ID_HORARIO, D.DATA ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC)ORDEM_ID_HORARIO, 
CASE 
WHEN D.MARCACAO_5 IS NOT NULL THEN D.ID_HORARIO||','||A.TIPO_JORNADA_U||','||SUBSTR(D.MARCACAO_1,10,5)||'-'||SUBSTR(D.MARCACAO_2,10,5)||'-'||SUBSTR(D.MARCACAO_3,10,5)||'-'||SUBSTR(D.MARCACAO_4,10,5)||'-'||SUBSTR(D.MARCACAO_5,10,5)||'-'||SUBSTR(D.MARCACAO_6,10,5)
WHEN D.MARCACAO_3 IS NOT NULL THEN D.ID_HORARIO||','||A.TIPO_JORNADA_U||','||SUBSTR(D.MARCACAO_1,10,5)||'-'||SUBSTR(D.MARCACAO_2,10,5)||'-'||SUBSTR(D.MARCACAO_3,10,5)||'-'||SUBSTR(D.MARCACAO_4,10,5)
ELSE D.ID_HORARIO||','||A.TIPO_JORNADA_U||','||SUBSTR(D.MARCACAO_1,10,5)||'-'||SUBSTR(D.MARCACAO_2,10,5)END MARCACOES,
D.* 
FROM PONTO_ELETRONICO.SUGESP_SGE_JORNADAS_ARQ_DATAS D 
LEFT OUTER JOIN (SELECT * FROM PONTO_ELETRONICO.SUGESP_SGE_JORNADAS_AJUSTES  WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
                    AND ID_HORARIO IN(2356,2401,2458,2611,2634,2636, 2787,2784,2783,2790,2788)--TESTE
                    ) A 
ON A.ID_HORARIO = D.ID_HORARIO
LEFT OUTER JOIN 
(SELECT M.CODIGO_EMPRESA, M.TIPO_CONTRATO, M.CODIGO_CONTRATO, M.CODIGO_PESSOA, P.CPF FROM ARTERH.RHPESS_CONTR_MEST M LEFT OUTER JOIN ARTERH.RHPESS_PESSOA P ON P.CODIGO_EMPRESA = M.CODIGO_EMPRESA AND P.CODIGO = M.CODIGO_PESSOA)P
ON P.CODIGO_EMPRESA = '0001' AND P.TIPO_CONTRATO = '0001' AND P.CODIGO_CONTRATO = A.BM_U
WHERE D.ID_HORARIO IN --(2356,2401,2458,2611,2634,2636, 2787,2784,2783,2790,2788)--TESTES
(SELECT ID_HORARIO FROM(SELECT ID_HORARIO, COUNT(1) FROM PONTO_ELETRONICO.SUGESP_SGE_JORNADAS_AJUSTES  WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
                    AND ID_HORARIO IN(2356,2401,2458,2611,2634,2636, 2787,2784,2783,2790,2788)--TESTE
GROUP BY ID_HORARIO))--CARGA DO DIA
ORDER BY D.ID_HORARIO, D.DATA, D.DATA_PROCESSAMENTO DESC
)D WHERE D.ORDEM_ID_HORARIO < 3
)X 
--LEFT OUTER JOIN ARTERH.RHTABS_DATAS DT ON TRUNC(DT.DATA_DIA) = TRUNC(X.DATA)
--LEFT OUTER JOIN ARTERH.RHTABS_DATAS DT ON TRUNC(DT.DATA_DIA) BETWEEN TO_DATE(X.ULT_DATA_INICIO,'DD/MM/YYYY') AND TO_DATE(X.ULT_DATA_FIM,'DD/MM/YYYY') OR TRUNC(DT.DATA_DIA) BETWEEN TO_DATE(X.PENUL_DATA_INICIO,'DD/MM/YYYY') AND TO_DATE(X.PENUL_DATA_FIM,'DD/MM/YYYY')
--LEFT OUTER JOIN ARTERH.RHTABS_DATAS DT ON TRUNC(DT.DATA_DIA) BETWEEN TO_DATE(X.DATA,'DD/MM/YYYY') AND TO_DATE(X.DATA_SEGUINTE,'DD/MM/YYYY') 
WHERE X.ORDEM_ID_HORARIO = 1
)X2
--LEFT OUTER JOIN ARTERH.RHTABS_DATAS DT ON TRUNC(DT.DATA_DIA) BETWEEN TO_DATE(X2.DATA,'DD/MM/YYYY') AND TO_DATE(X2.DATA_SEGUINTE,'DD/MM/YYYY') 
LEFT OUTER JOIN ARTERH.RHTABS_DATAS DT ON TRUNC(DT.DATA_DIA) = TO_DATE(X2.DATA,'DD/MM/YYYY')


)