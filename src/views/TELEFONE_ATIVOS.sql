
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "ARTERH"."TELEFONE_ATIVOS" ("COD_ORG", "MATRICULA", "CPF", "TIPO_TELEFONE", "DDD_TELEFONE", "NUMERO_TELEFONE", "COD_SEQUENCIAL_REGISTRO") AS 
  SELECT 
      TABELA."COD_ORG",TABELA."MATRICULA",TABELA."CPF",TABELA."TIPO_TELEFONE",TABELA."DDD_TELEFONE",TABELA."NUMERO_TELEFONE",
      row_number() OVER (PARTITION BY TABELA.MATRICULA ORDER BY TABELA.MATRICULA) AS COD_SEQUENCIAL_REGISTRO
FROM
(SELECT
       CO.CODIGO_EMPRESA as COD_ORG,
       
       SUBSTR(CO.CODIGO, 5,10) ||
       
       CASE WHEN SUBSTR(CO.CODIGO, 15,1) != 'X' THEN TO_NUMBER(SUBSTR(CO.CODIGO, 15,1)) ELSE 7 END AS MATRICULA,
       
       SUBSTR(PE.CPF, 1,11) AS CPF,
       
       CASE TP.COD_TIPO_TELEFONE
           -- WHEN '0001' THEN 'R' 
           WHEN '0002' THEN 'E' 
           WHEN '0003' THEN 'D' 
           WHEN '0004' THEN 'F' 
           WHEN '0005' THEN 'C' 
           WHEN '0006' THEN 'C'
           WHEN '0007' THEN 'C' 
           WHEN '0008' THEN 'D' 
           ELSE 'R' 
       END AS TIPO_TELEFONE,
       
       TO_NUMBER(TP.DDD) as DDD_TELEFONE,
       
       REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(SUBSTR(TP.TELEFONE,1,9),' ',''),',',''),'/',''),'-',''),'.','') AS NUMERO_TELEFONE

       /*CONTROLE INTERNO*/
from   
    RHPESS_CONTRATO CO

    LEFT OUTER JOIN RHPESS_PESSOA PE ON 
        CO.CODIGO_EMPRESA = PE.CODIGO_EMPRESA 
        AND CO.CODIGO_PESSOA = PE.CODIGO  

    LEFT OUTER JOIN RHPESS_TELEFONE_P TP ON 
        TP.CODIGO_EMPRESA = PE.CODIGO_EMPRESA 
        AND TP.CODIGO_PESSOA = PE.CODIGO 
        AND CO.CODIGO_EMPRESA = TP.CODIGO_EMPRESA 
        AND CO.CODIGO_PESSOA = TP.CODIGO_PESSOA

WHERE 
      cO.codigo_empresa IN  ('0013','0014','0001')
      AND CO.TIPO_CONTRATO  = '0001'
      AND CO.VINCULO IN ('0000','0002')
      AND (CO.CODIGO < '000000099999999' AND CO.CODIGO NOT IN('000000000777777','000000000823701','000000000833014','000000000866265','000000000747428','000000000190072','000000000420534')) /*FALECIDOS PIA*/
      AND CO.SITUACAO_FUNCIONAL NOT IN ('1710', '1715', '1800', '1850', '1900', '5000', '5001', '5002', '5003', '5004', '5005', '5006',
                                      '5008', '5009', '5011', '5019', '5022', '5026', '5028', '5200', '5201', '5400', '5555', '5700', '5800',
                                      '5801', '5808', '5900', '5901', '6002', '6003', '8000')
      AND TP.TELEFONE IS NOT NULL
      AND TP.TELEFONE <> ' '
      --AND TP.TELEFONE <> '' /*NÃO ESTÁ TRAZENDO NINGUÉM COM ESSA CONDIÇÃO*/
      --AND PE.CODIGO = '00000000112660X'
      AND CO.ANO_MES_REFERENCIA  =
        (SELECT MAX(A.ANO_MES_REFERENCIA)
        FROM RHPESS_CONTRATO A
        WHERE A.CODIGO            = CO.CODIGO
        AND A.CODIGO_EMPRESA      = CO.CODIGO_EMPRESA
        AND A.TIPO_CONTRATO       = CO.TIPO_CONTRATO
        AND A.ANO_MES_REFERENCIA <= add_months(sysdate,(-1))-0)
        and not exists (select c.codigo from rhpess_contrato c where 
C.CODIGO_EMPRESA = ('1700')
AND C.TIPO_CONTRATO = '0001'
AND C.VINCULO IN ('0000','0002')
AND C.SITUACAO_FUNCIONAL = '5800'
--AND CO.SITUACAO_FUNCIONAL NOT IN ('1700','1002','1701','1715','1800','1900','5000','5002','5003','5004','5005','5006','5008','5009','5011','5200','5700','5900','5901','6002','8000')
--AND SUBSTR(CO.CODIGO,5,10) ='0000091112' --'0000009627'
AND C.CODIGO < '000000099999999'
AND C.ANO_MES_REFERENCIA  =
  (SELECT MAX(B.ANO_MES_REFERENCIA)
  FROM RHPESS_CONTRATO B
  WHERE B.CODIGO            = C.CODIGO
  AND B.CODIGO_EMPRESA      = C.CODIGO_EMPRESA
  AND B.TIPO_CONTRATO       = C.TIPO_CONTRATO
  AND B.ANO_MES_REFERENCIA <= add_months(sysdate,(-1))-0)AND C.CODIGO = CO.CODIGO)

) TABELA

GROUP BY
COD_ORG,
MATRICULA,
CPF,
--COD_SEQUENCIAL_REGISTRO,
TIPO_TELEFONE,
DDD_TELEFONE,
NUMERO_TELEFONE