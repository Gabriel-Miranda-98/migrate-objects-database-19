
  CREATE OR REPLACE FORCE EDITIONABLE VIEW "ARTERH"."LOTA_APOSENTADOS" ("COD_PLANO", "COD_ORG", "MATRICULA_SEGURADO", "DIGITO_MATRICULA", "CPF_SEGURADO", "DATA_ADMISSAO", "COD_LOTACAO", "COD_LOTACAO_SUPERIOR", "DATA_DESLIGAMENTO", "CODIGO_SITUACAO", "PRIMEIRO_EMPREGO") AS 
  SELECT 
   /*CONDIÇÃO PARA O PLANO*/
  CASE
    WHEN CO.DATA_ADMISSAO < '20111230'
    THEN '0001'
    WHEN CO.DATA_ADMISSAO >= '20111230'
    THEN '0002'
  END AS COD_PLANO,
  /*CONDIÇÃO ORGANIZAÇÃO*/
  1 AS COD_ORG, 
      SUBSTR(CO.CODIGO, 5,10) AS MATRICULA_SEGURADO , 
      CASE WHEN SUBSTR(CO.CODIGO, 15,1)!= 'X' THEN SUBSTR(CO.CODIGO, 15,1) ELSE '7' END AS DIGITO_MATRICULA, 
      SUBSTR(PE.CPF, 1,11) AS CPF_SEGURADO,
      trim(CO.DATA_ADMISSAO) AS DATA_ADMISSAO,

      SUBSTR(CO.COD_CUSTO_GERENC1,5,2)||SUBSTR(CO.COD_CUSTO_GERENC2,5,2)||SUBSTR(CO.COD_CUSTO_GERENC3,5,2)|| 
      SUBSTR(CO.COD_CUSTO_GERENC4,5,2)||SUBSTR(CO.COD_CUSTO_GERENC5,5,2)||SUBSTR(CO.COD_CUSTO_GERENC6,4,3) AS COD_LOTACAO,


      /*LOTAÇÃO SUPERIOR*/
nvl(SUBSTR(CG.COD_CGERENC_SUP1,5,2)||SUBSTR(CG.COD_CGERENC_SUP2,5,2)||SUBSTR(CG.COD_CGERENC_SUP3,5,2)
||SUBSTR(CG.COD_CGERENC_SUP4,5,2)||SUBSTR(CG.COD_CGERENC_SUP5,5,2)||SUBSTR(CG.COD_CGERENC_SUP6,4,3),'9999999999998') AS COD_LOTACAO_SUPERIOR,


 CASE  WHEN   co.situacao_funcional = '5800' and PE.DATA_FALECIMENTO  IS NULL AND CO.DATA_RESCISAO IS NOT NULL THEN trim(CO.DATA_RESCISAO)
       WHEN co.situacao_funcional = '5800' and PE.DATA_FALECIMENTO  IS NULL AND CO.DATA_RESCISAO IS NULL THEN trim(to_DATE('20000101','YYYYMMDD'))
       WHEN co.situacao_funcional  NOT IN ('1000','1002','1004','1700','1701' )  THEN trim(CO.DATA_INIC_AFAST )
       else trim(PE.DATA_FALECIMENTO)
       END  AS  DATA_DESLIGAMENTO,

       case when CO.SITUACAO_FUNCIONAL in ('5300') then 2
            when CO.SITUACAO_FUNCIONAL in ('5800') then 3
			when CO.SITUACAO_FUNCIONAL in('5000','5002','5003','5004') then 6
			when CO.SITUACAO_FUNCIONAL between '5100' and '5110' then 7
			when CO.SITUACAO_FUNCIONAL in ('5500','5555','5600','5610','6000','6003','6010','8000') then 8
            else 1 end AS CODIGO_SITUACAO,
            NULL AS PRIMEIRO_EMPREGO

  FROM RHPESS_CONTRATO CO
  LEFT OUTER JOIN RHPESS_PESSOA PE ON CO.CODIGO_EMPRESA = PE.CODIGO_EMPRESA AND CO.CODIGO_PESSOA = PE.CODIGO 
  LEFT OUTER JOIN RHORGA_CUSTO_GEREN CG ON CO.CODIGO_EMPRESA = CG.CODIGO_EMPRESA AND CO.COD_CUSTO_GERENC1 = CG.COD_CGERENC1 AND CO.COD_CUSTO_GERENC2 = CG.COD_CGERENC2 AND CO.COD_CUSTO_GERENC3 = CG.COD_CGERENC3  AND  
                                           CO.COD_CUSTO_GERENC4 = CG.COD_CGERENC4 AND CO.COD_CUSTO_GERENC5 = CG.COD_CGERENC5 AND CO.COD_CUSTO_GERENC6 = CG.COD_CGERENC6
  LEFT OUTER JOIN RHPARM_SIT_FUNC ST ON CO.SITUACAO_FUNCIONAL = ST.CODIGO
    WHERE 
    CO.CODIGO_EMPRESA = ('0001')
AND CO.TIPO_CONTRATO = '0001'
AND CO.VINCULO IN ('0000','0002')
AND CO.SITUACAO_FUNCIONAL NOT IN ('1715','1800','1900','5000','5002','5003','5004','5005','5006','5008','5009','5011','5200','5700','5900','5901','6002','8000')


AND CO.ANO_MES_REFERENCIA  =
  (SELECT MAX(A.ANO_MES_REFERENCIA)
  FROM RHPESS_CONTRATO A
  WHERE A.CODIGO            = CO.CODIGO
  AND A.CODIGO_EMPRESA      = CO.CODIGO_EMPRESA
  AND A.TIPO_CONTRATO       = CO.TIPO_CONTRATO
  AND A.ANO_MES_REFERENCIA = add_months(sysdate,(-1))-1)
  and not exists (select c.codigo from rhpess_contrato c where 
C.CODIGO_EMPRESA = ('1700')
AND C.TIPO_CONTRATO = '0001'
AND C.VINCULO IN ('0000','0002')
AND C.SITUACAO_FUNCIONAL = '5800'
--AND CO.SITUACAO_FUNCIONAL NOT IN ('1700','1002','1701','1715','1800','1900','5000','5002','5003','5004','5005','5006','5008','5009','5011','5200','5700','5900','5901','6002','8000')
--AND SUBSTR(CO.CODIGO,5,10) ='0000091112' --'0000009627'
AND C.CODIGO < '000000010000000'
AND C.ANO_MES_REFERENCIA  =
  (SELECT MAX(B.ANO_MES_REFERENCIA)
  FROM RHPESS_CONTRATO B
  WHERE B.CODIGO            = C.CODIGO
  AND B.CODIGO_EMPRESA      = C.CODIGO_EMPRESA
  AND B.TIPO_CONTRATO       = C.TIPO_CONTRATO
  AND B.ANO_MES_REFERENCIA = add_months(sysdate,(-1))-1)AND C.CODIGO = CO.CODIGO)


      ORDER BY CO.CODIGO