
  CREATE OR REPLACE EDITIONABLE FUNCTION "ARTERH"."VALIDA_SGE" (vCPF IN VARCHAR2, vTP_CONT IN CHAR, vCOD_EMPRESA IN CHAR, vDT_INI DATE)
/*VERIFICA SE A PESSOA POSSUI VALE EXTRA ATIVO, OU SEJA,  COM DATA FIM MENOR QUE A vDT_INI OU DATA FIM NULA */
    RETURN NUMBER
  AS
    RETOR NUMBER:=0;
  BEGIN
    SELECT COUNT(1)QUANT INTO RETOR
    FROM ARTERH.RHVALE_DESLOCA DL
    LEFT OUTER JOIN ARTERH.RHVALE_RL_DESL_LIN L
    ON L.CODIGO_CONTRATO =DL.CODIGO_CONTRATO
    AND L.TIPO_CONTRATO  =DL.TIPO_CONTRATO
    AND L.CODIGO_CONTRATO=DL.CODIGO_CONTRATO
    AND l.DATA_INICIO=DL.DATA_INICIO
    LEFT OUTER JOIN ARTERH.RHVALE_ITINERARIO IT
    ON IT.CODIGO=L.CODIGO_ITINERARIO
    LEFT OUTER JOIN ARTERH.RHVALE_LINHA_TRANS LI
    ON LI.CODIGO    =L.CODIGO_LINHA
    AND IT.TIPO_VALE=LI.TIPO_VALE
    LEFT OUTER JOIN
      (SELECT *
      FROM ARTERH.RHPESS_CONTRATO CN
      WHERE CN.ANO_MES_REFERENCIA=
        (SELECT MAX(AUX.ANO_MES_REFERENCIA)
        FROM ARTERH.RHPESS_CONTRATO AUX
        WHERE AUX.TIPO_CONTRATO =CN.TIPO_CONTRATO
        AND AUX.CODIGO_EMPRESA  = CN.CODIGO_EMPRESA
        AND AUX.CODIGO          =CN.CODIGO
        )
      ) CN
    ON CN.CODIGO         =DL.CODIGO_CONTRATO
    AND CN.TIPO_CONTRATO =DL.TIPO_CONTRATO
    AND CN.CODIGO_EMPRESA=DL.CODIGO_EMPRESA
    LEFT OUTER JOIN ARTERH.RHPESS_PESSOA P
    ON P.CODIGO             =CN.CODIGO_PESSOA
    AND P.CODIGO_EMPRESA    =CN.CODIGO_EMPRESA
    WHERE DL.CODIGO_EMPRESA =vCOD_EMPRESA
    AND DL.TIPO_CONTRATO    =vTP_CONT
    AND L.CODIGO_LINHA NOT IN (SELECT DADO_DESTINO FROM ARTERH.RHINTE_ED_IT_CONV XL WHERE XL.CODIGO_CONVERSAO='VRLC'
    AND TRIM(L.CODIGO_LINHA)=TRIM(XL.DADO_ORIGEM))
    AND ( vDT_INI BETWEEN L.DATA_INICIO AND L.DATA_FIM
    or ( vDT_INI >= L.DATA_INICIO and L.DATA_FIM is null ) )
    and DL.C_LIVRE_DATA02 is null /*INCLUIDO EM 06/07/2022 POR LETÍCIA -  PARA NÃO VALIDAR SE A DATA DE CANCELAMENTO DO SGE ESTIVER PREENCHIDA */
    AND P.CPF=vCPF
    AND LI.TIPO_VALE        ='0002';

    RETURN RETOR;
  END;
