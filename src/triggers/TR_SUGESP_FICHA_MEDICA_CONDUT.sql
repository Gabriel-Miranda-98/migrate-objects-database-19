
  CREATE OR REPLACE EDITIONABLE TRIGGER "ARTERH"."TR_SUGESP_FICHA_MEDICA_CONDUT" 
AFTER INSERT OR UPDATE OR DELETE ON "ARTERH"."RHMEDI_RL_FICH_PRO"
FOR EACH ROW
 DECLARE
v_DML SUGESP_FICHAS_MEDICAS.TIPO_DML%TYPE;

vID NUMBER;
vTIPO_DML VARCHAR2(1);
vTABELA VARCHAR2(30);
    vLOGIN_USUARIO_NEW VARCHAR2(40);
    vLOGIN_USUARIO_OLD VARCHAR2(40);
    vLOGIN_OS_NEW VARCHAR2(40);
    vLOGIN_OS_OLD VARCHAR2(40);
    vLOGIN_NEW VARCHAR2(40);
    vLOGIN_OLD VARCHAR2(40);

vULT_ID NUMBER;

BEGIN

vTABELA := 'RHMEDI_RL_FICH_PRO';

    vLOGIN_USUARIO_NEW := :NEW.LOGIN_USUARIO;
    vLOGIN_USUARIO_OLD := :OLD.LOGIN_USUARIO;
    vLOGIN_OS_NEW := SYS_CONTEXT ('USERENV', 'OS_USER');
    vLOGIN_OS_OLD := SYS_CONTEXT ('USERENV', 'OS_USER');
    vLOGIN_NEW := NULL;
    vLOGIN_OLD := NULL;

--definir login a usar NEW
    IF vLOGIN_USUARIO_NEW = 'ARTERH_UPBH' then 
    vLOGIN_NEW := vLOGIN_OS_NEW;
    ELSE 
    vLOGIN_NEW := vLOGIN_USUARIO_NEW;
    END IF;

--definir login a usar OLD
    IF vLOGIN_USUARIO_OLD = 'ARTERH_UPBH' then 
    vLOGIN_NEW := vLOGIN_OS_OLD;
    ELSE 
    vLOGIN_OLD := vLOGIN_USUARIO_OLD;
    END IF;

vULT_ID := 0;       
--------------------------------------------------------------------------INSERT-------------------------------------------------------------------------------------------------------------------------------------------
IF INSERTING THEN 
v_DML := 'I';

INSERT INTO SUGESP_FICHAS_MEDICAS(
ID,
TIPO_DML,
TABELA,
CODIGO_EMPRESA,
CODIGO_PESSOA,
DT_REG_OCORRENCIA,
OCORRENCIA,
NEW_OCOR_PROC_MED,
OLD_OCOR_PROC_MED,
NEW_CODIGO_PROC_MED,
OLD_CODIGO_PROC_MED,
DT_ULT_ALTER_USUA,
LOGIN_USUARIO,
LOGIN_OS
,PROCESSADO
)
VALUES
(ARTERH.SEQUENCE_SUGESP_FICHAS_MEDICAS.NEXTVAL,--ATE 16/7/20--(SELECT MAX(ID)+1 FROM SUGESP_FICHAS_MEDICAS),
v_DML,
vTABELA,
:NEW.CODIGO_EMPRESA,
:NEW.CODIGO_PESSOA,
:NEW.DT_REG_OCORRENCIA,
:NEW.OCORRENCIA,
:NEW.OCOR_PROC_MED,
NULL,
:NEW.CODIGO_PROC_MED,
NULL,
SYSDATE,
vLOGIN_NEW,
vLOGIN_NEW
,'N'
);
--------------------------------------------------------------------------UPDATE-------------------------------------------------------------------------------------------------------------------------------------------
ELSIF UPDATING THEN
v_DML := 'U';

INSERT INTO SUGESP_FICHAS_MEDICAS(
ID,
TIPO_DML,
TABELA,
CODIGO_EMPRESA,
CODIGO_PESSOA,
DT_REG_OCORRENCIA,
OCORRENCIA,
NEW_OCOR_PROC_MED,
OLD_OCOR_PROC_MED,
NEW_CODIGO_PROC_MED,
OLD_CODIGO_PROC_MED,
DT_ULT_ALTER_USUA,
LOGIN_USUARIO,
LOGIN_OS
,PROCESSADO
)
VALUES
(ARTERH.SEQUENCE_SUGESP_FICHAS_MEDICAS.NEXTVAL,--ATE 16/7/20--(SELECT MAX(ID)+1 FROM SUGESP_FICHAS_MEDICAS),
v_DML,
vTABELA,
:NEW.CODIGO_EMPRESA,
:NEW.CODIGO_PESSOA,
:NEW.DT_REG_OCORRENCIA,
:NEW.OCORRENCIA,
:NEW.OCOR_PROC_MED,
:OLD.OCOR_PROC_MED,
:NEW.CODIGO_PROC_MED,
:OLD.CODIGO_PROC_MED,
SYSDATE,
vLOGIN_NEW,
vLOGIN_OLD
,'N'
);
--------------------------------------------------------------------------DELETE-------------------------------------------------------------------------------------------------------------------------------------------
ELSIF DELETING THEN
v_DML := 'D';

INSERT INTO SUGESP_FICHAS_MEDICAS(
ID,
TIPO_DML,
TABELA,
CODIGO_EMPRESA,
CODIGO_PESSOA,
DT_REG_OCORRENCIA,
OCORRENCIA,
NEW_OCOR_PROC_MED,
OLD_OCOR_PROC_MED,
NEW_CODIGO_PROC_MED,
OLD_CODIGO_PROC_MED,
DT_ULT_ALTER_USUA,
LOGIN_USUARIO,
LOGIN_OS
,PROCESSADO
)
VALUES
(ARTERH.SEQUENCE_SUGESP_FICHAS_MEDICAS.NEXTVAL,--ATE 16/7/20--(SELECT MAX(ID)+1 FROM SUGESP_FICHAS_MEDICAS),
v_DML,
vTABELA,
:OLD.CODIGO_EMPRESA,
:OLD.CODIGO_PESSOA,
:OLD.DT_REG_OCORRENCIA,
:OLD.OCORRENCIA,
NULL,
:OLD.OCOR_PROC_MED,
NULL,
:OLD.CODIGO_PROC_MED,
SYSDATE,
vLOGIN_OLD,
vLOGIN_OLD
,'N'
);

END IF;

--------------------------------------------------------------------------------CHAMAR PROCEDURE DE FICHAS MEDICAS E FILHAS
--select ID into vULT_ID FROM SUGESP_FICHAS_MEDICAS WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS);
--PR_SUGESP_FICHAS_MEDICAS('RHMEDI_RL_FICH_PRO', vULT_ID);
--------------------------------------------------------------------------------CHAMAR PROCEDURE DE FICHAS MEDICAS E FILHAS

END;




ALTER TRIGGER "ARTERH"."TR_SUGESP_FICHA_MEDICA_CONDUT" ENABLE