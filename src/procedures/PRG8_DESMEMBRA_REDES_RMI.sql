
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PRG8_DESMEMBRA_REDES_RMI" AS
BEGIN

DECLARE
CONT NUMBER:=1;
QTD NUMBER:=0;
vIP_REDE VARCHAR2(4000);
vCONTADOR1 NUMBER; 
vSUB_REDE NUMBER;
vCADA_RANGE_IP VARCHAR2(30);
vCONTADOR2 NUMBER;

  TYPE rRECORD IS RECORD ( TIPO_LOCAL_SMSA VARCHAR2(4), DESCRICAO VARCHAR2(200), COD_CGERENC1 VARCHAR2(6), COD_CGERENC2 VARCHAR2(6), COD_CGERENC3 VARCHAR2(6), COD_CGERENC4 VARCHAR2(6), COD_CGERENC5 VARCHAR2(6), COD_CGERENC6 VARCHAR2(6),
                            LATIT VARCHAR2(30), LONGI VARCHAR2(30), ENDERECO_ARTERH VARCHAR2(30), RANGE_IP VARCHAR2(30), ENDERECO VARCHAR2(200), NUMERO VARCHAR2(200), BAIRRO VARCHAR2(200) );--CRIO O RECORD
  iRECORD rRECORD; --INSTANCIO O RECORD
  TYPE a_lista IS TABLE of rRECORD INDEX BY binary_integer;--TRANSFORMA O RECORD EM LISTA
  lista a_lista;--INSTANCIA LISTA

BEGIN 
dbms_output.enable(null);
vCONTADOR1 := 0;
vSUB_REDE := 0;
vCADA_RANGE_IP := NULL;
vCONTADOR2 := 1;

FOR R1 IN(

SELECT 
cg.c_livre_selec10 COD_LOCAL_SMSA,
CASE WHEN CG.c_livre_selec10 = '1' THEN 'APS'
WHEN CG.c_livre_selec10 = '2' THEN 'COM'
WHEN CG.c_livre_selec10 = '3' THEN 'UPA'
WHEN CG.c_livre_selec10 = '4' THEN 'SUP'
WHEN CG.c_livre_selec10 = '5' THEN 'CER'
ELSE 'ERRO'
END TIPO_LOCAL_SMSA,
CG.DESCRICAO, CG.cod_cgerenc1, CG.cod_cgerenc2, CG.cod_cgerenc3, CG.cod_cgerenc4, CG.cod_cgerenc5, CG.cod_cgerenc6,  length(E.TEXTO_ASSOC)largura_ips,
E.CODIGO COD_ENDERECO, E.CAIXA_POSTAL LATIT, E.TELEX LONGI, E.TEXTO_ASSOC IPS_REDE, E.DESCRICAO DESC_ENDERECO, E.ENDERECO, E.NUMERO, E.BAIRRO, E.CEP
FROM ARTERH.RHORGA_CUSTO_GEREN CG  
LEFT OUTER JOIN ARTERH.RHORGA_ENDERECO E ON CG.COD_ENDERECO = E.CODIGO 
WHERE 
CG.CODIGO_EMPRESA = '0001' AND 
CG.data_extincao IS NULL and
e.caixa_postal is not null and  e.telex is not null 
AND E.c_livre_data02 IS NULL --DATA DE EXTINCAO NULA
and cg.cod_cgerenc1 not in ('000099','000098') 
AND E.TEXTO_ASSOC IS NOT NULL
--and CG.c_livre_selec10 in ('1','2','3','4','5')--somente locais verbas SMSA
--AND E.CODIGO = '003191013000501'--TESTES
ORDER BY CG.cod_cgerenc1, CG.cod_cgerenc2, CG.cod_cgerenc3, CG.cod_cgerenc4, CG.cod_cgerenc5, CG.cod_cgerenc6--E.CODIGO, CG.DESCRICAO

)

LOOP
vCONTADOR1 := vCONTADOR1 + 1;
dbms_output.put_line('vCONTADOR1: '||vCONTADOR1|| ' R1.LARGURA_IPS: '||R1.LARGURA_IPS|| ' R1.COD_ENDERECO: '||R1.COD_ENDERECO|| ' R1.TIPO_LOCAL_SMSA: '||R1.TIPO_LOCAL_SMSA||' R1.DESCRICAO: '||R1.DESCRICAO
||' R1.COD_CGERENC1: '||R1.COD_CGERENC1|| ' R1.COD_CGERENC2: '||R1.COD_CGERENC2||' R1.COD_CGERENC3: '||R1.COD_CGERENC3||' R1.COD_CGERENC4: '|| R1.COD_CGERENC4|| ' R1.COD_CGERENC5: '||R1.COD_CGERENC5
||' R1.COD_CGERENC6: '||R1.COD_CGERENC6||' R1.LATIT: '||R1.LATIT||' R1.LONGI: '||R1.LONGI|| ' R1.IPS_REDE: '||R1.IPS_REDE);
SELECT TEXTO_ASSOC INTO vIP_REDE  FROM ARTERH.RHORGA_ENDERECO  WHERE c_livre_data01 IS NOT NULL AND CODIGO = R1.COD_ENDERECO;
DBMS_Output.PUT_LINE('vIP_REDE: '|| vIP_REDE );
SELECT REGEXP_COUNT(TEXTO_ASSOC,',') AS QUANT INTO  QTD FROM ARTERH.RHORGA_ENDERECO  WHERE c_livre_data01 IS NOT NULL AND CODIGO = R1.COD_ENDERECO;
DBMS_Output.PUT_LINE('QTD: '|| QTD );
FOR R2 IN 0..QTD LOOP
FOR X IN (
SELECT regexp_substr(REPLACE(TEXTO_ASSOC,',,',', ,'), '[^,]+', 1, CONT) AS DADOS FROM  ARTERH.RHORGA_ENDERECO  WHERE c_livre_data01 IS NOT NULL AND CODIGO = R1.COD_ENDERECO
)LOOP
DBMS_Output.PUT_LINE ('--------*************CADA SUB-REDE**************----');
DBMS_Output.PUT_LINE('X.DADOS: '||X.DADOS);
DBMS_Output.PUT_LINE('P1: '|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 1) ||' P2: '|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 2)||' P3: '|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 3)||' P4: '|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 4)||' SUB-REDE: '|| REGEXP_SUBSTR(X.DADOS, '[^/"]+', 1, 1)||' CLASSE: '|| REGEXP_SUBSTR(X.DADOS, '[^/"]+', 1, 2));

IF REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 4) IS NOT NULL THEN --NOVO 13/1/23

vSUB_REDE := (REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 3));
DBMS_Output.PUT_LINE ('vSUB_REDE: '||vSUB_REDE);

---INICIO----IF DOS TESTES DE SUB-REDES
IF REGEXP_SUBSTR(X.DADOS, '[^/"]+', 1, 2) = '24' THEN
DBMS_Output.PUT_LINE('TESTA APENAS 1 SUB-REDE- QUE SER O RANGE DO IP DA MARCACAO');
vCADA_RANGE_IP := REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 1) ||'.'|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 2) ||'.'|| vSUB_REDE;
DBMS_Output.PUT_LINE ('vCADA_RANGE_IP: '||vCADA_RANGE_IP);
--iRECORD.ENDERECO_ARTERH := R1.COD_ENDERECO; iRECORD.RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).TIPO_LOCAL_SMSA := R1.TIPO_LOCAL_SMSA;
lista(vCONTADOR2).DESCRICAO := R1.DESCRICAO;
lista(vCONTADOR2).COD_CGERENC1 := R1.COD_CGERENC1;
lista(vCONTADOR2).COD_CGERENC2 := R1.COD_CGERENC2;
lista(vCONTADOR2).COD_CGERENC3 := R1.COD_CGERENC3;
lista(vCONTADOR2).COD_CGERENC4 := R1.COD_CGERENC4;
lista(vCONTADOR2).COD_CGERENC5 := R1.COD_CGERENC5;
lista(vCONTADOR2).COD_CGERENC6 := R1.COD_CGERENC6;
lista(vCONTADOR2).LATIT := R1.LATIT;
lista(vCONTADOR2).LONGI := R1.LONGI;
lista(vCONTADOR2).ENDERECO_ARTERH := R1.COD_ENDERECO;
lista(vCONTADOR2).RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).ENDERECO := R1.ENDERECO;
lista(vCONTADOR2).NUMERO := R1.NUMERO;
lista(vCONTADOR2).BAIRRO := R1.BAIRRO;
vCONTADOR2 := vCONTADOR2 + 1;

ELSIF REGEXP_SUBSTR(X.DADOS, '[^/"]+', 1, 2) = '21' THEN
vCADA_RANGE_IP := REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 1) ||'.'|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 2) ||'.'|| vSUB_REDE;
DBMS_Output.PUT_LINE ('vCADA_RANGE_IP: '||vCADA_RANGE_IP);
--iRECORD.ENDERECO_ARTERH := R1.COD_ENDERECO; iRECORD.RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).TIPO_LOCAL_SMSA := R1.TIPO_LOCAL_SMSA;
lista(vCONTADOR2).DESCRICAO := R1.DESCRICAO;
lista(vCONTADOR2).COD_CGERENC1 := R1.COD_CGERENC1;
lista(vCONTADOR2).COD_CGERENC2 := R1.COD_CGERENC2;
lista(vCONTADOR2).COD_CGERENC3 := R1.COD_CGERENC3;
lista(vCONTADOR2).COD_CGERENC4 := R1.COD_CGERENC4;
lista(vCONTADOR2).COD_CGERENC5 := R1.COD_CGERENC5;
lista(vCONTADOR2).COD_CGERENC6 := R1.COD_CGERENC6;
lista(vCONTADOR2).LATIT := R1.LATIT;
lista(vCONTADOR2).LONGI := R1.LONGI;
lista(vCONTADOR2).ENDERECO_ARTERH := R1.COD_ENDERECO;
lista(vCONTADOR2).RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).ENDERECO := R1.ENDERECO;
lista(vCONTADOR2).NUMERO := R1.NUMERO;
lista(vCONTADOR2).BAIRRO := R1.BAIRRO;
vCONTADOR2 := vCONTADOR2 + 1;
DBMS_Output.PUT_LINE('TESTA MAIS 3 SUB-REDE');
FOR R3 IN 1..3 LOOP
vSUB_REDE := vSUB_REDE + 1;
DBMS_Output.PUT_LINE ('vSUB_REDE: '||vSUB_REDE);
vCADA_RANGE_IP := REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 1) ||'.'|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 2) ||'.'|| vSUB_REDE;
DBMS_Output.PUT_LINE ('vCADA_RANGE_IP: '||vCADA_RANGE_IP);
--iRECORD.ENDERECO_ARTERH := R1.COD_ENDERECO; iRECORD.RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).TIPO_LOCAL_SMSA := R1.TIPO_LOCAL_SMSA;
lista(vCONTADOR2).DESCRICAO := R1.DESCRICAO;
lista(vCONTADOR2).COD_CGERENC1 := R1.COD_CGERENC1;
lista(vCONTADOR2).COD_CGERENC2 := R1.COD_CGERENC2;
lista(vCONTADOR2).COD_CGERENC3 := R1.COD_CGERENC3;
lista(vCONTADOR2).COD_CGERENC4 := R1.COD_CGERENC4;
lista(vCONTADOR2).COD_CGERENC5 := R1.COD_CGERENC5;
lista(vCONTADOR2).COD_CGERENC6 := R1.COD_CGERENC6;
lista(vCONTADOR2).LATIT := R1.LATIT;
lista(vCONTADOR2).LONGI := R1.LONGI;
lista(vCONTADOR2).ENDERECO_ARTERH := R1.COD_ENDERECO;
lista(vCONTADOR2).RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).ENDERECO := R1.ENDERECO;
lista(vCONTADOR2).NUMERO := R1.NUMERO;
lista(vCONTADOR2).BAIRRO := R1.BAIRRO;
vCONTADOR2 := vCONTADOR2 + 1;
END LOOP;

ELSE
DBMS_Output.PUT_LINE('CLASSES DE SUB-REDE MENOS COMUM-TESTA APENAS O RANGE DO IP DA MARCACAO');
vCADA_RANGE_IP := REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 1) ||'.'|| REGEXP_SUBSTR(X.DADOS, '[^."]+', 1, 2) ||'.'|| vSUB_REDE;
DBMS_Output.PUT_LINE ('vCADA_RANGE_IP: '||vCADA_RANGE_IP);
--iRECORD.ENDERECO_ARTERH := R1.COD_ENDERECO; iRECORD.RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).TIPO_LOCAL_SMSA := R1.TIPO_LOCAL_SMSA;
lista(vCONTADOR2).DESCRICAO := R1.DESCRICAO;
lista(vCONTADOR2).COD_CGERENC1 := R1.COD_CGERENC1;
lista(vCONTADOR2).COD_CGERENC2 := R1.COD_CGERENC2;
lista(vCONTADOR2).COD_CGERENC3 := R1.COD_CGERENC3;
lista(vCONTADOR2).COD_CGERENC4 := R1.COD_CGERENC4;
lista(vCONTADOR2).COD_CGERENC5 := R1.COD_CGERENC5;
lista(vCONTADOR2).COD_CGERENC6 := R1.COD_CGERENC6;
lista(vCONTADOR2).LATIT := R1.LATIT;
lista(vCONTADOR2).LONGI := R1.LONGI;
lista(vCONTADOR2).ENDERECO_ARTERH := R1.COD_ENDERECO;
lista(vCONTADOR2).RANGE_IP := vCADA_RANGE_IP;
lista(vCONTADOR2).ENDERECO := R1.ENDERECO;
lista(vCONTADOR2).NUMERO := R1.NUMERO;
lista(vCONTADOR2).BAIRRO := R1.BAIRRO;
vCONTADOR2 := vCONTADOR2 + 1;
END IF;
---FIM----IF DOS TESTES DE SUB-REDES
CONT:=CONT+1;

END IF; --NOVO--13/1/23

END LOOP; --FOR X
END LOOP;--FOR R2
CONT :=1;
QTD :=0;
vSUB_REDE := 0;
DBMS_Output.PUT_LINE('----------------------------------------------------------------------------');
END LOOP; --FOR R1
--DBMS_Output.PUT_LINE(iRECORD.ENDERECO_ARTERH||'-'|| iRECORD.RANGE_IP) ;
DBMS_Output.PUT_LINE('----------------------********************LISTA DE ENDERECOS ARTERH COM SEUS RANGES DE SUB-REDES*************************------------------------------') ;
  FOR i IN lista.first .. lista.last loop
    dbms_output.put_line('LISTA_RANGE: '||i||'-'||lista(i).ENDERECO_ARTERH ||'-'||lista(i).RANGE_IP ||'-'||lista(i).TIPO_LOCAL_SMSA||'-'||lista(i).DESCRICAO||'-'||lista(i).COD_CGERENC1||'-'||lista(i).COD_CGERENC2||'-'||lista(i).COD_CGERENC3
    ||'-'||lista(i).COD_CGERENC4||'-'||lista(i).COD_CGERENC5||'-'||lista(i).COD_CGERENC6||'-'||lista(i).LATIT||'-'||lista(i).LONGI);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CODIGO_EMPRESA, DATA_DADOS, CONSIDERACOES, CAMPO_1, CAMPO_2, CAMPO_3, CAMPO_4, CAMPO_5, CAMPO_6, CAMPO_7, CAMPO_8, CAMPO_9, CAMPO_10)
VALUES('0001',SYSDATE,'PRG8_DESMEMBRA_REDES_RMI',lista(i).ENDERECO_ARTERH, lista(i).RANGE_IP, lista(i).LATIT, lista(i).LONGI, lista(i).TIPO_LOCAL_SMSA, lista(i).DESCRICAO,
lista(i).COD_CGERENC1||'.'||lista(i).COD_CGERENC2||'.'||lista(i).COD_CGERENC3||'.'||lista(i).COD_CGERENC4||'.'||lista(i).COD_CGERENC5||'.'||lista(i).COD_CGERENC6, lista(i).ENDERECO,lista(i).NUMERO, lista(i).BAIRRO);COMMIT;

--SELECT CODIGO_EMPRESA, DATA_DADOS, CONSIDERACOES, CAMPO_VALOR_1 ENDERECO_ARTERH, CAMPO_VALOR_2 RANGE_IP, CAMPO_VALOR_3 LATIT, CAMPO_VALOR_4 LONGI, CAMPO_VALOR_5 TIPO_LOCAL_SMSA, CAMPO_VALOR_6 DESCRICAO, CAMPO_VALOR_7 COD_LOCAL , CAMPO_VALOR_8 ENDERECO, CAMPO_VALOR_9 NUMERO, CAMPO_VALOR_10 BAIRRO FROM SUGESP_AJUSTE_LOTE_CAMPO_HIST WHERE CONSIDERACOES = 'LISTA DO SCRIPT desmembra faixa de rede todos_enderecos_pbh_com_organograma.sql' AND TRUNC(DATA_DADOS)= TRUNC(SYSDATE)

  end loop;

END;

END;
