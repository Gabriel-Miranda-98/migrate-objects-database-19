
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_INCORPORACOES_ATIVOS" (PVMES IN  VARCHAR2,PVANO IN  VARCHAR2, vCOD_EMPRESA IN  VARCHAR2,vTP_CONTRATO IN  VARCHAR2,BM IN  VARCHAR2) AS
BEGIN
DECLARE
--VANO_MES VARCHAR2(30);
VMES  VARCHAR2(02) := PVMES;
VANO VARCHAR2(04) := PVANO;
/*VMES1  VARCHAR2(02) := PVMES1;
VANO1 VARCHAR2(04) := PVANO1;
VDATA1 VARCHAR2(10);*/
VDATA VARCHAR2(10);
VDATA_I VARCHAR2(10);
CONT NUMBER;
REC_RETORNO NUMBER;
vMAT VARCHAR2(15) := BM;
vQUANT NUMBER;
vSQL VARCHAR2(500);


BEGIN
VDATA := TO_CHAR('01/'|| VMES||'/'||VANO);
--VDATA1 := TO_CHAR('01/'|| VMES1||'/'||VANO1);
dbms_output.put_line('VDATA: '||VDATA);
--dbms_output.put_line('VDATA1: '||VDATA1);

vSQL := 'DELETE FROM INCORPORACOES_ATIVOS_APOSENT';

/*18/08 A PEDIDO DA MARILANE EXCLUIR TODOS OS REGISTRO E PERMANECER APENAS O CONTRATO QUE ESTA SENDO INSERIDO NA TABELA INCORPORACOES_ATIVOS_APOSENT*/
/*vSQL := 'DELETE FROM INCORPORACOES_ATIVOS_APOSENT WHERE ANO_MES_REFERENCIA <= TRUNC(TO_DATE('''||VDATA||''',''DD/MM/YYYY'')) AND CODIGO_EMPRESA = '''||vCOD_EMPRESA||''' 
AND TIPO_CONTRATO = '''||vTP_CONTRATO||''' AND MATRICULA = '''||BM||'''';*/


dbms_output.put_line('vSQL: '||vSQL);
EXECUTE IMMEDIATE vSQL;
vQUANT := SQL%ROWCOUNT; COMMIT WORK;
--dbms_output.put_line('vQUANT: '||vQUANT);
DBMS_OUTPUT.ENABLE (buffer_size => NULL);
FOR C1 IN (
SELECT X.ANO_MES_REFERENCIA,  X.COD_PLANO,  X.CODIGO_EMPRESA,  X.TIPO_CONTRATO,  X.CODIGO,  X.CPF,  X.NOME_SERVIDOR,  X.CARGO_EFETIVO,  X.DESCR_CARGO_EFE,
       X.VINCULO,  X.DESC_VINCULO,  X.VERBA,  X.VERBA_DESCRICAO,  X.VALOR,  X.TIPO_MOVIMENTO,  X.BASE_CALC_VERBA,  X.QUANT_DIAS_PAGOS,  X.FATOR_CALCULO,  X.DATA_PAGAMENTO,
       X.DECIMO_TERCEIRO,  X.FERIAS,  X.RESCISAO,  X.NUMERO_LINHA,  X.DATA_CARGA,  X.LOGIN_USUARIO,  X.ORGANIZACAO  
FROM (
SELECT --TO_CHAR(MOVI.ANO_MES_REFERENCIA,'YYYYMM') AS ANO_MES_REFERENCIA,
  M.ANO_MES_REFERENCIA,
  CASE WHEN C.DATA_ADMISSAO < TO_DATE('30/12/2011','DD/MM/YYYY') THEN 1 ELSE 2 END AS COD_PLANO,
  C.CODIGO_EMPRESA,
  C.TIPO_CONTRATO,
  C.CODIGO,
  --SUBSTR(X.CODIGO, 5,10)||CASE WHEN SUBSTR(X.CODIGO, 15,1) != 'X' THEN SUBSTR(X.CODIGO, 15,1) ELSE '7' END AS MATRICULA,
  SUBSTR(TRIM(P.CPF),1,11)  AS CPF,
  SUBSTR(TRIM(P.NOME),1,80) AS NOME_SERVIDOR,
  C.COD_CARGO_EFETIVO       AS CARGO_EFETIVO,
  SUBSTR(RHPLCS_CARGO.DESCRICAO,1,40)    AS DESCR_CARGO_EFE,
  C.VINCULO,
  RHTABS_VINCULO_EMP.DESCRICAO   AS DESC_VINCULO,
  M.CODIGO_VERBA                 AS VERBA,
  SUBSTR(TRIM(V.DESCRICAO),1,80) AS VERBA_DESCRICAO,
  TRIM(M.VALOR_VERBA)            AS VALOR,
  M.TIPO_MOVIMENTO,
  0           AS BASE_CALC_VERBA,
  30          AS QUANT_DIAS_PAGOS,
  M.REF_VERBA AS FATOR_CALCULO,
  30||TO_CHAR(M.ANO_MES_REFERENCIA,'MMYYYY') AS DATA_PAGAMENTO,
  'N'                                      AS DECIMO_TERCEIRO,
  'N'                                      AS FERIAS,
  'N'                                      AS RESCISAO,
  '' NUMERO_LINHA,
  SYSDATE DATA_CARGA,
  '' LOGIN_USUARIO,
  1 AS ORGANIZACAO 
  FROM RHPESS_CONTRATO C
     INNER JOIN RHPLCS_CARGO       ON C.COD_CARGO_EFETIVO = RHPLCS_CARGO.CODIGO AND C.CODIGO_EMPRESA      = RHPLCS_CARGO.CODIGO_EMPRESA
     INNER JOIN RHTABS_VINCULO_EMP ON C.VINCULO = RHTABS_VINCULO_EMP.CODIGO
     INNER JOIN RHPESS_PESSOA    P ON C.CODIGO_EMPRESA = P.CODIGO_EMPRESA AND C.CODIGO_PESSOA = P.CODIGO
     INNER JOIN RHMOVI_MOVIMENTO M ON M.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C.CODIGO
     INNER JOIN RHPARM_VERBA     V ON V.CODIGO = M.CODIGO_VERBA
 WHERE
    C.ANO_MES_REFERENCIA =(
        SELECT MAX( X.ANO_MES_REFERENCIA )
          FROM RHPESS_CONTRATO X
         WHERE
                X.CODIGO_EMPRESA = C.CODIGO_EMPRESA
               AND X.TIPO_CONTRATO = C.TIPO_CONTRATO
               AND X.CODIGO        = C.CODIGO
               AND TRUNC( X.ANO_MES_REFERENCIA )<= TRUNC( TO_DATE( VDATA, 'DD/MM/YYYY' ))
    )
    AND C.VINCULO IN( '0000', '0002', '0001' )
    AND V.INC50L             = 'S'
    AND M.CTRL_DEMO          = 'N'
    AND M.TIPO_MOVIMENTO     = 'ME'
    AND M.MODO_OPERACAO      = 'R'
    AND M.VALOR_VERBA > 0
    AND M.CODIGO_VERBA BETWEEN '1000' AND '1300'
    AND TRUNC( M.ANO_MES_REFERENCIA ) <= TRUNC( TO_DATE( VDATA, 'DD/MM/YYYY' ))
    AND C.TIPO_CONTRATO      = '0001'
UNION ALL
SELECT --TO_CHAR(MOVI.ANO_MES_REFERENCIA,'YYYYMM') AS ANO_MES_REFERENCIA,
  M.ANO_MES_REFERENCIA,
  CASE WHEN C.DATA_ADMISSAO < TO_DATE('30/12/2011','DD/MM/YYYY') THEN 1 ELSE 2 END AS COD_PLANO,
  C.CODIGO_EMPRESA,
  C.TIPO_CONTRATO,
  C.CODIGO,
  --SUBSTR(X.CODIGO, 5,10)||CASE WHEN SUBSTR(X.CODIGO, 15,1) != 'X' THEN SUBSTR(X.CODIGO, 15,1) ELSE '7' END AS MATRICULA,
  SUBSTR(TRIM(P.CPF),1,11)  AS CPF,
  SUBSTR(TRIM(P.NOME),1,80) AS NOME_SERVIDOR,
  C.COD_CARGO_EFETIVO       AS CARGO_EFETIVO,
  SUBSTR(RHPLCS_CARGO.DESCRICAO,1,40)    AS DESCR_CARGO_EFE,
  C.VINCULO,
  RHTABS_VINCULO_EMP.DESCRICAO   AS DESC_VINCULO,
  M.CODIGO_VERBA                 AS VERBA,
  SUBSTR(TRIM(V.DESCRICAO),1,80) AS VERBA_DESCRICAO,
  TRIM(M.VALOR_VERBA)            AS VALOR,
  M.TIPO_MOVIMENTO,
  0           AS BASE_CALC_VERBA,
  30          AS QUANT_DIAS_PAGOS,
  M.REF_VERBA AS FATOR_CALCULO,
  30||TO_CHAR(M.ANO_MES_REFERENCIA,'MMYYYY') AS DATA_PAGAMENTO,
  'N'                                      AS DECIMO_TERCEIRO,
  'N'                                      AS FERIAS,
  'N'                                      AS RESCISAO,
  '' NUMERO_LINHA,
  SYSDATE DATA_CARGA,
  '' LOGIN_USUARIO,
  1 AS ORGANIZACAO 
  FROM RHPESS_CONTRATO C
     INNER JOIN RHPLCS_CARGO       ON C.COD_CARGO_EFETIVO = RHPLCS_CARGO.CODIGO AND C.CODIGO_EMPRESA      = RHPLCS_CARGO.CODIGO_EMPRESA
     INNER JOIN RHTABS_VINCULO_EMP ON C.VINCULO = RHTABS_VINCULO_EMP.CODIGO
     INNER JOIN RHPESS_PESSOA    P ON C.CODIGO_EMPRESA = P.CODIGO_EMPRESA AND C.CODIGO_PESSOA = P.CODIGO
     INNER JOIN RHMOVI_MOVIMENTO M ON M.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C.CODIGO
     INNER JOIN RHPARM_VERBA     V ON V.CODIGO = M.CODIGO_VERBA
 WHERE
    C.ANO_MES_REFERENCIA =(
        SELECT MAX( X.ANO_MES_REFERENCIA )
          FROM RHPESS_CONTRATO X
         WHERE
                X.CODIGO_EMPRESA = C.CODIGO_EMPRESA
               AND X.TIPO_CONTRATO = C.TIPO_CONTRATO
               AND X.CODIGO        = C.CODIGO
               AND TRUNC( X.ANO_MES_REFERENCIA )<= TRUNC( TO_DATE( VDATA, 'DD/MM/YYYY' ))
    )
    --AND C.CODIGO = '000000000384090'
    AND (M.CODIGO_VERBA IN( '100C', '100Y', '101N', '105A', '105H', '1082', '1089', '1098', '1137', '1139', '1156', '1159', '1166', '1167', '1173',
                           '117A', '117F', '117G', '1196', '1200', '1217', '1219', '1230', '130C', '1335', '1336', '135A', '137A', '1382', '1398',
                           '1437', '1456', '1459', '1466', '1473', '1517', '1555', '1556', '1582', '1589', '177B', '1782', '1817', '1889', '1898',
                           '1937', '1956', '1959', '1966', '1973', '197A', '2157', '2159', '230C', '2335', '2336', '2357', '2382', '2533', '2534',
                           '2541', '2542', '2589', '2617', '2682', '2737', '2756', '2759', '2766', '2773', '277A', '2798', '2817', '2857', '2866',
                           '2899', '290C', '2937', '2956', '2959', '2973', '297A', '1467', '1496', '1519', '1819', '1967', '1996', '2619', '2632',
                           '2767', '2796', '2819', '2832', '2940', '2967', '2996', '11A7', '12A7', '130Y', '131N', '14A7', '15A7', '180Y', '181N',
                           '185A', '18A7', '18A7', '195H', '205A', '230Y', '231N', '235H', '26A7', '27A7', '280Y', '281N', '285A', '285H', '28AE',
                           '298A', '29AZ' )
        OR( M.CODIGO_VERBA IN( '1001', '1102', '1103', '1117' )
       AND C.COD_CARGO_EFETIVO >= '000000000001501'
       AND C.COD_CARGO_EFETIVO <= '000000000001515' )
        OR(( M.CODIGO_VERBA IN( '1140', '1232', '1233', '1440', '1940', '2940', '2740', '1532', '1832', '2832',
                                '2632', '1533', '1843', '2843', '2643', '1165', '1465', '1965', '2765', '286A' )
       AND M.ANO_MES_REFERENCIA < TO_DATE( '01/02/2019', 'dd/mm/yyyy' )))
        OR(( M.CODIGO_VERBA IN( '1001' )
       AND C.COD_CARGO_EFETIVO >= '000000000001434' AND C.COD_CARGO_EFETIVO <= '000000000001436' )
       AND M.ANO_MES_REFERENCIA >= TO_DATE( '01/02/2019', 'dd/mm/yyyy' ))
        OR(( M.CODIGO_VERBA IN( '1178', '1220', '1257', '1258' )
       AND M.ANO_MES_REFERENCIA >= TO_DATE( '01/01/2001', 'dd/mm/yyyy' )
       AND M.ANO_MES_REFERENCIA <= TO_DATE( '31/03/2010', 'dd/mm/yyyy' ))
        OR( M.CODIGO_VERBA IN( '1178', '1220', '1257', '1258' )
       AND M.ANO_MES_REFERENCIA >= TO_DATE( '01/09/2017', 'dd/mm/yyyy' ))))
       AND M.VALOR_VERBA > 0
       AND M.CODIGO_EMPRESA     = '0001'
       AND M.TIPO_MOVIMENTO IN( 'ME', 'PS' )
       AND M.MODO_OPERACAO      = 'R'
       AND TRUNC( M.ANO_MES_REFERENCIA ) <= TRUNC( TO_DATE( VDATA, 'DD/MM/YYYY' ))
       AND M.TIPO_CONTRATO      = '0001'
       AND C.VINCULO IN( '0000', '0002', '0001' )
) X WHERE X.CODIGO = vMAT
GROUP BY X.ANO_MES_REFERENCIA,  X.COD_PLANO,  X.CODIGO_EMPRESA,  X.TIPO_CONTRATO,  X.CODIGO,  X.CPF,  X.NOME_SERVIDOR,  X.CARGO_EFETIVO,  X.DESCR_CARGO_EFE,
         X.VINCULO,  X.DESC_VINCULO,  X.VERBA,  X.VERBA_DESCRICAO,  X.VALOR,  X.TIPO_MOVIMENTO,  X.BASE_CALC_VERBA,  X.QUANT_DIAS_PAGOS,  X.FATOR_CALCULO,  X.DATA_PAGAMENTO,
         X.DECIMO_TERCEIRO,  X.FERIAS,  X.RESCISAO,  X.NUMERO_LINHA,  X.DATA_CARGA,  X.LOGIN_USUARIO,  X.ORGANIZACAO 
)LOOP
CONT :=CONT+1;
dbms_output.put_line(CONT);
/*
dbms_output.put_line('INSERT INTO ARTERH.INCORPORACOES_ATIVOS_APOSENT (ANO_MES_REFERENCIA, COD_PLANO, MATRICULA, CPF, NOME_SERVIDOR, CARGO_EFETIVO, DESCR_CARGO_EFE, VINCULO, DESC_VINCULO, VERBA, VERBA_DESCRICAO, VALOR, TIPO_MOVIMENTO, BASE_CALC_VERBA, QUANT_DIAS_PAGOS, FATOR_CALCULO, DATA_PAGAMENTO, DECIMO_TERCEIRO, FERIAS, RESCISAO, NUMERO_LINHA, DATA_CARGA, LOGIN_USUARIO, ORGANIZACAO, CODIGO_EMPRESA, TIPO_CONTRATO) 
VALUES('''||C1.ANO_MES_REFERENCIA||''','''||C1.COD_PLANO||''','''||C1.CODIGO||''','''||C1.CPF||''','''||C1.NOME_SERVIDOR||''','''||C1.CARGO_EFETIVO||''','''||C1.DESCR_CARGO_EFE||''','''||C1.VINCULO||''','''||C1.DESC_VINCULO||''','''||C1.VERBA||''','''||C1.VERBA_DESCRICAO||''','''||C1.VALOR||''','''||C1.TIPO_MOVIMENTO||''','''||C1.BASE_CALC_VERBA||''','''||C1.QUANT_DIAS_PAGOS||''','''||C1.FATOR_CALCULO||''','''||C1.DATA_PAGAMENTO||''','''||C1.DECIMO_TERCEIRO||''','''||C1.FERIAS||''','''||C1.RESCISAO||''','''||SEQUENCE_INCORPORACOES_ATIVOS.NEXTVAL||''','''||C1.DATA_CARGA||''','''||C1.LOGIN_USUARIO||''','''||C1.ORGANIZACAO||''','''||C1.CODIGO_EMPRESA||''','''||C1.TIPO_CONTRATO||''');' );
--COMMIT WORK;
*/

INSERT INTO INCORPORACOES_ATIVOS_APOSENT (ANO_MES_REFERENCIA, COD_PLANO, MATRICULA, CPF, NOME_SERVIDOR, CARGO_EFETIVO, DESCR_CARGO_EFE, VINCULO, DESC_VINCULO, VERBA, VERBA_DESCRICAO, VALOR, TIPO_MOVIMENTO, BASE_CALC_VERBA, QUANT_DIAS_PAGOS, FATOR_CALCULO, DATA_PAGAMENTO, DECIMO_TERCEIRO, FERIAS, RESCISAO, NUMERO_LINHA, DATA_CARGA, LOGIN_USUARIO, ORGANIZACAO, CODIGO_EMPRESA, TIPO_CONTRATO) 
VALUES(C1.ANO_MES_REFERENCIA, C1.COD_PLANO, C1.CODIGO, C1.CPF, C1.NOME_SERVIDOR, C1.CARGO_EFETIVO, C1.DESCR_CARGO_EFE, C1.VINCULO, C1.DESC_VINCULO, C1.VERBA, C1.VERBA_DESCRICAO, C1.VALOR, C1.TIPO_MOVIMENTO, C1.BASE_CALC_VERBA, C1.QUANT_DIAS_PAGOS, C1.FATOR_CALCULO, C1.DATA_PAGAMENTO, C1.DECIMO_TERCEIRO, C1.FERIAS, C1.RESCISAO, SEQUENCE_INCORPORACOES_ATIVOS.NEXTVAL, C1.DATA_CARGA, C1.LOGIN_USUARIO, C1.ORGANIZACAO, C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO );
COMMIT WORK;

END LOOP;
END;

END PR_INCORPORACOES_ATIVOS;