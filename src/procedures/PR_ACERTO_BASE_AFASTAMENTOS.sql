
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PR_ACERTO_BASE_AFASTAMENTOS" (DATA_CORTE IN DATE) AS 
CONT NUMBER :=0;
vFECHAMENTO_SISTEMA DATE;--NOVO EM 18/11/22

BEGIN 


SELECT MAX(TO_DATE(DADO_ORIGEM,'DD/MM/YYYY')) INTO vFECHAMENTO_SISTEMA FROM  ARTERH.RHINTE_ED_IT_CONV CV WHERE CODIGO_CONVERSAO = 'FCPT'; --NOVO EM 18/11/22

/*INICIO-- PARTE DE FERIAS*/
BEGIN
FOR C1 IN
    ( SELECT LTRIM(XX.CODIGO_CONTRATO, 0) || XX.TIPO_CONTRATO || XX.CODIGO_EMPRESA || XX.CODIGO_JUSTIFICATIVA || XX.DATA_INICIO || XX.DATA_FIM AS CODIGO_LEGADO,
       XX.*
FROM (SELECT X.EMPRESA,
           X.AGRUPAMENTO_EMPRESA,
           X.CODIGO_EMPRESA,
           X.TIPO_CONTRATO,
           X.CODIGO_CONTRATO,
           X.TIPO,
           X.SITUACAO_PONTO AS CODIGO_JUSTIFICATIVA,
           CASE
               WHEN TO_DATE(X.DT_INI_GOZO, 'DD/MM/YYYY') <= TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY') AND X.FECHAMENTO_SISTEMA IS NOT NULL THEN TO_CHAR(TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY') + 1, 'DD/MM/YYYY')
               WHEN TO_DATE(X.DT_INI_GOZO, 'DD/MM/YYYY') > TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY') AND X.FECHAMENTO_SISTEMA IS NOT NULL THEN DT_INI_GOZO
               ELSE X.DT_INI_GOZO
           END              AS DATA_INICIO,
           X.DT_FIM_GOZO    AS DATA_FIM,
           X.DT_SAIU_ARTE,
           'FERIAS'         ORIGEM,
           X.DESCRICAO_JUSTIFICATIVA
           ,X.PK_ARTE
           FROM (select x.* from (SELECT TG.CODIGO_EMPRESA,
       CASE
           WHEN TG.CODIGO_EMPRESA = '0001' THEN 'PREF.MUN.BELO HORIZONTE'
           WHEN TG.CODIGO_EMPRESA = '0098' THEN 'PREF.MUN.BH CONTRATOS'
       END                                       AS EMPRESA,
       'ADM DIRETA'                              AS AGRUPAMENTO_EMPRESA,
       PF.SITUACAO_PONTO,
       TG.TIPO_CONTRATO,
       TG.CODIGO_CONTRATO,
       TG.NEW_DT_INI_AQUISICAO                   AS DT_INI_AQUISICAO,
       TG.NEW_TIPO_FERIAS                        AS TIPO_FERIAS,
       TG.NEW_PERIODO                            AS PERIODO,
       TO_CHAR(TG.NEW_DT_INI_GOZO, 'dd/mm/yyyy') AS DT_INI_GOZO,
       CASE
           WHEN TG.NEW_STATUS_CONFIRMACAO = 1 THEN TG.NEW_DT_FIM_GOZO
           WHEN TG.NEW_STATUS_CONFIRMACAO IN ( '5', 'D' ) THEN (
                   SELECT MAX(DT.DATA_DIA)
                   FROM PONTO_ELETRONICO.SUGESP_BI_RHFERI_FERIAS FE,
                        ARTERH.RHTABS_DATAS                      DT
                   WHERE FE.CODIGO_EMPRESA = TG.CODIGO_EMPRESA AND FE.TIPO_CONTRATO = TG.TIPO_CONTRATO AND FE.NEW_DT_INI_AQUISICAO = TG.NEW_DT_INI_AQUISICAO AND FE.NEW_DT_FIM_AQUISICAO = TG.NEW_DT_FIM_AQUISICAO AND FE.CODIGO_CONTRATO = TG.CODIGO_CONTRATO AND DT.DATA_DIA BETWEEN TG.NEW_DT_INI_GOZO AND TG.NEW_DT_RETORNO - 1 AND FE.NEW_STATUS_CONFIRMACAO = TG.NEW_STATUS_CONFIRMACAO AND DT.DATA_DIA NOT IN (
                       SELECT F.DATA_DIA
                       FROM ARTERH.RHPARM_CALEND_DT F
                       WHERE F.CODIGO = '0001' AND DT.DATA_DIA = F.DATA_DIA
                   )
               )
           ELSE TG.NEW_DT_FIM_GOZO
       END                                       DT_FIM_GOZO,
       SYSDATE                                   AS DT_SAIU_ARTE,
       'INCLUIR'                                 AS TIPO,
       TG.DT_ULT_ALTER_USUA                      AS DT_ULT_ALTER_USUA,
      /* COMENTADO EM 18/11/22--(
           SELECT DADO_ORIGEM
           FROM ARTERH.RHINTE_ED_IT_CONV CV
           WHERE CODIGO_CONVERSAO = 'FCPT' AND TO_DATE(DADO_ORIGEM, 'DD/MM/YYYY') = (
               SELECT MAX(TO_DATE(AUX.DADO_ORIGEM, 'DD/MM/YYYY'))
               FROM ARTERH.RHINTE_ED_IT_CONV AUX
               WHERE CV.CODIGO_CONVERSAO = AUX.CODIGO_CONVERSAO
           )
       )   */      vFECHAMENTO_SISTEMA FECHAMENTO_SISTEMA,
       PF.DESCRICAO                              AS DESCRICAO_JUSTIFICATIVA
,TG.CODIGO_EMPRESA||TG.TIPO_CONTRATO||TG.CODIGO_CONTRATO 
||CASE WHEN TG.TIPO_COMANDO = 'D' THEN TG.OLD_DT_INI_AQUISICAO ELSE TG.NEW_DT_INI_AQUISICAO END-- DT_INI_AQUISICAO,
||CASE WHEN TG.TIPO_COMANDO = 'D' THEN TG.OLD_TIPO_FERIAS ELSE TG.NEW_TIPO_FERIAS END --TIPO_FERIAS,
||CASE WHEN TG.TIPO_COMANDO = 'D' THEN TG.OLD_PERIODO ELSE TG.NEW_PERIODO END --PERIODO
PK_ARTE       
FROM PONTO_ELETRONICO.SUGESP_BI_RHFERI_FERIAS TG
INNER JOIN ARTERH.RHINTE_ED_IT_CONV PONTR ON SUBSTR(PONTR.DADO_ORIGEM, 20, 4) = TG.CODIGO_EMPRESA AND SUBSTR(PONTR.DADO_ORIGEM, 24, 4) = TG.TIPO_CONTRATO AND PONTR.CODIGO_CONVERSAO = 'PONT'
INNER JOIN ARTERH.RHPARM_P_FERI     PF ON PF.CODIGO = TG.NEW_TIPO_FERIAS AND PF.CODIGO_EMPRESA = TG.CODIGO_EMPRESA
INNER JOIN ARTERH.RHFERI_FERIAS     F ON F.CODIGO_CONTRATO = TG.CODIGO_CONTRATO AND F.TIPO_CONTRATO = TG.TIPO_CONTRATO AND F.CODIGO_EMPRESA = TG.CODIGO_EMPRESA AND F.TIPO_FERIAS = TG.NEW_TIPO_FERIAS AND F.PERIODO = TG.NEW_PERIODO AND F.DT_INI_AQUISICAO = TG.NEW_DT_INI_AQUISICAO AND F.DT_FIM_AQUISICAO = TG.NEW_DT_FIM_AQUISICAO AND F.DT_INI_GOZO = TG.NEW_DT_INI_GOZO AND F.DT_FIM_GOZO = TG.NEW_DT_FIM_GOZO
WHERE TG.NEW_DT_INI_GOZO IS NOT NULL 
AND TG.NEW_DT_FIM_GOZO IS NOT NULL 
AND TG.NEW_STATUS_CONFIRMACAO IN ( '1', '5', 'D' ) 
AND TRUNC(TG.DT_ULT_ALTER_USUA) < TRUNC(SYSDATE) 
AND ( TG.NEW_DT_INI_GOZO >= TO_DATE(DATA_CORTE, 'DD/MM/YYYY') OR TG.NEW_DT_FIM_GOZO >= TO_DATE(DATA_CORTE, 'DD/MM/YYYY') ) AND TG.TIPO_COMANDO IN ( 'I', 'U' ) 
AND TG.ID = (
    SELECT MAX(AUX.ID)
    FROM PONTO_ELETRONICO.SUGESP_BI_RHFERI_FERIAS AUX
    WHERE AUX.CODIGO_EMPRESA = TG.CODIGO_EMPRESA AND AUX.CODIGO_CONTRATO = TG.CODIGO_CONTRATO AND AUX.TIPO_CONTRATO = TG.TIPO_CONTRATO AND AUX.NEW_TIPO_FERIAS = TG.NEW_TIPO_FERIAS AND AUX.NEW_PERIODO = TG.NEW_PERIODO AND AUX.NEW_DT_INI_AQUISICAO = TG.NEW_DT_INI_AQUISICAO AND AUX.NEW_DT_FIM_AQUISICAO = TG.NEW_DT_FIM_AQUISICAO
)
)x
INNER JOIN  ARTERH.VW_SIT_FUNC_PONTO_ATIVO xx 
        ON xx.codigo_contrato = x.codigo_contrato
        AND xx.tipo_contrato = x.tipo_contrato
        AND xx.codigo_empresa = x.codigo_empresa
        INNER JOIN arterh.rhparm_sit_func             sf 
        ON sf.codigo = xx.cod_sit_funcional
        INNER JOIN PONTO_ELETRONICO.SMARH_INT_CHAVE_INTEGRACAO      CHAVE 
ON CHAVE.CODIGO_EMPRESA = XX.CODIGO_EMPRESA 
AND CHAVE.CODIGO_SITUACAO_FUNCIONAL = Sf.CODIGO 
        where  sf.controle_folha NOT IN ( 'D', 'S' )
        AND sf.codigo NOT IN ( '1017' --COMENTADO EM 1/8/22 CASO BM 3099618--, '1851' 
        )
        AND CHAVE.CHAVE_IFPONTO='ATIVO'
        )X
        WHERE 
    ( ( TO_DATE(X.DT_INI_GOZO) > CASE
                                           WHEN TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020', 'DD/MM/YYYY')
                                           ELSE TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY')
                                       END ) 
OR ( TO_DATE(X.DT_FIM_GOZO) > CASE WHEN TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020', 'DD/MM/YYYY')
                                                                               ELSE TO_DATE(X.FECHAMENTO_SISTEMA, 'DD/MM/YYYY')
                                                                           END ) )
) XX)
    LOOP

      INSERT
      INTO PONTO_ELETRONICO.sugesp_bi_afastamentos
        (
          EMPRESA,
          AGRUPAMENTO_EMPRESA,
          CODIGO_LEGADO,
          TIPO,
          CODIGO_EMPRESA,
          TIPO_CONTRATO,
          CODIGO_CONTRATO,
          CODIGO_JUSTIFICATIVA,
          DESCRICAO,
          DATA_INICIO,
          DATA_FIM,
          DT_SAIU_ARTE,
          ORIGEM
          ,PK_ARTE
        )
        VALUES
        (
          C1.EMPRESA,
          C1.AGRUPAMENTO_EMPRESA,
          C1.CODIGO_LEGADO,
          C1.TIPO,
          C1.CODIGO_EMPRESA,
          C1.TIPO_CONTRATO,
          C1.CODIGO_CONTRATO,
          C1.CODIGO_JUSTIFICATIVA,
          C1.DESCRICAO_JUSTIFICATIVA,
          C1.DATA_INICIO,
          C1.DATA_FIM,
          C1.DT_SAIU_ARTE,
          'ACERTO_BASE'
          ,C1.PK_ARTE
        );
      COMMIT;
    END LOOP;
  END;
/*FIM-- PARTE DE FERIAS*/


/*INICIO--AFASTAMENTOS COM DATA FIM */
BEGIN 
FOR C1 IN
(
SELECT X3.* FROM (SELECT CASE WHEN XX.CODIGO_EMPRESA = '0001' THEN 'PREF.MUN.BELO HORIZONTE' WHEN XX.CODIGO_EMPRESA = '0098' THEN 'PREF.MUN.BH CONTRATOS' END AS EMPRESA, CASE WHEN XX.CODIGO_EMPRESA IN ('0001','0098','0015','0021','0032') THEN 'ADM DIRETA' ELSE 'ADM INDIRETA' END AS AGRUPAMENTO_EMPRESA,
XX.CODIGO_EMPRESA || XX.TIPO_CONTRATO || LTRIM(XX.CODIGO_CONTRATO,0) || XX.CODIGO_JUSTIFICATIVA || TO_CHAR(TO_DATE(XX.DATA_INICIO,'DD/MM/YYYY'),'YYYY-MM-DD HH24:MI:SS') AS CODIGO_LEGADO, XX.*
FROM (SELECT FIM.TIPO, FIM.CODIGO_EMPRESA, FIM.TIPO_CONTRATO, FIM.CODIGO_CONTRATO, FIM.CODIGO_JUSTIFICATIVA, FIM.DESCRICAO, SYSDATE AS DT_SAIU_ARTE, NULL AS DT_ENVIADO_IFPONTO_SURICATO
,CASE WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')<= TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') AND FIM.FECHAMENTO_SISTEMA IS NOT NULL THEN TO_CHAR(TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')+1,'DD/MM/YYYY') WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')>TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') AND FIM.FECHAMENTO_SISTEMA IS NOT NULL THEN DATA_INICIO ELSE FIM.DATA_INICIO END AS DATA_INICIO, 
FIM.DATA_FIM, FIM.PK_ARTE FROM(
-----------
SELECT X.* FROM (
SELECT 'INCLUIR' AS TIPO, LC.ID, LC.CODIGO_EMPRESA, LC.TIPO_CONTRATO, LC.CODIGO AS CODIGO_CONTRATO, LC.NEW_COD_SIT_FUNCIONAL AS SITUACAO_FUNCIONAL, PN.CODIGO AS CODIGO_JUSTIFICATIVA, PN.DESCRICAO, 
TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')AS DATA_INICIO, TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') AS DATA_FIM,
--(SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV CV WHERE CODIGO_CONVERSAO = 'FCPT' AND TO_DATE(DADO_ORIGEM,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.DADO_ORIGEM,'DD/MM/YYYY')) FROM ARTERH.RHINTE_ED_IT_CONV AUX WHERE CV.CODIGO_CONVERSAO = AUX.CODIGO_CONVERSAO))   
vFECHAMENTO_SISTEMA FECHAMENTO_SISTEMA
, LC.CODIGO_EMPRESA||LC.TIPO_CONTRATO||LC.CODIGO||LC.DATA_INIC_SITUACAO AS PK_ARTE
FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDBKP LC
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF ON LC.NEW_COD_SIT_FUNCIONAL=SF.CODIGO
LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO PN ON SF.SITUACAO_PONTO=PN.CODIGO
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT')PONTR ON SUBSTR(PONTR.DADO_ORIGEM,20,4) = LC.CODIGO_EMPRESA AND SUBSTR(PONTR.DADO_ORIGEM,24,4) = LC.TIPO_CONTRATO
LEFT OUTER JOIN  ARTERH.VW_SIT_FUNC_PONTO_ATIVO X ON X.CODIGO_CONTRATO = LC.CODIGO AND X.TIPO_CONTRATO = LC.TIPO_CONTRATO AND X.CODIGO_EMPRESA = LC.CODIGO_EMPRESA
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC S ON S.CODIGO=X.COD_SIT_FUNCIONAL
INNER JOIN PONTO_ELETRONICO.SMARH_INT_CHAVE_INTEGRACAO CHAVE ON CHAVE.CODIGO_EMPRESA = LC.CODIGO_EMPRESA AND CHAVE.CODIGO_SITUACAO_FUNCIONAL = S.CODIGO 
WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4) IS NOT NULL AND TIPO_DML IN ('I')
AND LC.ID = (SELECT MAX(AUX.ID) FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDBKP AUX WHERE AUX.CODIGO = LC.CODIGO AND AUX.TIPO_CONTRATO = LC.TIPO_CONTRATO AND AUX.CODIGO_EMPRESA = LC.CODIGO_EMPRESA AND TRUNC(AUX.DATA_INIC_SITUACAO)=TRUNC(LC.DATA_INIC_SITUACAO))
AND PN.TIPO_SITUACAO IN ('P','I','F') AND (S.CONTROLE_FOLHA NOT IN ('D','S'))AND S.CODIGO NOT IN ('1017','1851') AND CHAVE.CHAVE_IFPONTO='ATIVO'AND PN.C_LIVRE_VALOR01='1' AND TRUNC(LC.DT_ULT_ALTER_USUA)<TRUNC(SYSDATE)
)X
LEFT OUTER JOIN  ARTERH.RHCGED_ALT_SIT_FUN F
ON F.CODIGO = X.CODIGO_CONTRATO AND F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.TIPO_CONTRATO = X.TIPO_CONTRATO AND F.COD_SIT_FUNCIONAL = X.SITUACAO_FUNCIONAL AND TRUNC(F.DATA_INIC_SITUACAO)=TRUNC(TO_DATE(X.DATA_INICIO,'DD/MM/YYYY'))
WHERE F.CODIGO_EMPRESA IS NOT NULL
AND (TO_DATE(X.DATA_INICIO,'DD/MM/YYYY')>= TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY') OR TO_DATE(X.DATA_FIM,'DD/MM/YYYY')>= TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY'))

UNION ALL-----------------------------------------------------------------------------------------------------------------------------
SELECT X.* FROM (
SELECT 'INCLUIR' AS TIPO,LC.ID, LC.CODIGO_EMPRESA, LC.TIPO_CONTRATO, LC.CODIGO AS CODIGO_CONTRATO, LC.NEW_COD_SIT_FUNCIONAL AS SITUACAO_FUNCIONAL, PN.CODIGO AS CODIGO_JUSTIFICATIVA, PN.DESCRICAO, TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')AS DATA_INICIO, TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') AS DATA_FIM,
--(SELECT    DADO_ORIGEM FROM     ARTERH.RHINTE_ED_IT_CONV CV WHERE CODIGO_CONVERSAO = 'FCPT' AND TO_DATE(DADO_ORIGEM,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.DADO_ORIGEM,'DD/MM/YYYY')) FROM ARTERH.RHINTE_ED_IT_CONV AUX WHERE CV.CODIGO_CONVERSAO = AUX.CODIGO_CONVERSAO))
vFECHAMENTO_SISTEMA FECHAMENTO_SISTEMA
, LC.CODIGO_EMPRESA||LC.TIPO_CONTRATO||LC.CODIGO||LC.DATA_INIC_SITUACAO AS PK_ARTE
FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDBKP LC
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF ON LC.NEW_COD_SIT_FUNCIONAL=SF.CODIGO
LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO PN ON SF.SITUACAO_PONTO=PN.CODIGO
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT')PONTR ON SUBSTR(PONTR.DADO_ORIGEM,20,4) = LC.CODIGO_EMPRESA AND SUBSTR(PONTR.DADO_ORIGEM,24,4) = LC.TIPO_CONTRATO
LEFT OUTER JOIN  ARTERH.VW_SIT_FUNC_PONTO_ATIVO  X ON X.CODIGO_CONTRATO = LC.CODIGO AND X.TIPO_CONTRATO = LC.TIPO_CONTRATO AND X.CODIGO_EMPRESA = LC.CODIGO_EMPRESA
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC S ON S.CODIGO=X.COD_SIT_FUNCIONAL
INNER JOIN PONTO_ELETRONICO.SMARH_INT_CHAVE_INTEGRACAO CHAVE  ON CHAVE.CODIGO_EMPRESA = LC.CODIGO_EMPRESA AND CHAVE.CODIGO_SITUACAO_FUNCIONAL = S.CODIGO 
WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4) IS NOT NULL AND TIPO_DML IN ('U')
AND LC.ID = (SELECT MAX(AUX.ID) FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDBKP AUX WHERE AUX.CODIGO = LC.CODIGO AND AUX.TIPO_CONTRATO = LC.TIPO_CONTRATO AND AUX.CODIGO_EMPRESA = LC.CODIGO_EMPRESA AND TRUNC(AUX.DATA_INIC_SITUACAO) = TRUNC(LC.DATA_INIC_SITUACAO))
AND PN.TIPO_SITUACAO IN ('P','I','F') AND (S.CONTROLE_FOLHA NOT IN ('D','S')) AND S.CODIGO NOT IN ('1017','1851')      
AND CHAVE.CHAVE_IFPONTO='ATIVO' AND PN.C_LIVRE_VALOR01='1' AND TRUNC(LC.DT_ULT_ALTER_USUA)<TRUNC(SYSDATE)
)X
LEFT OUTER JOIN  ARTERH.RHCGED_ALT_SIT_FUN F
ON F.CODIGO = X.CODIGO_CONTRATO AND F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.TIPO_CONTRATO = X.TIPO_CONTRATO AND F.COD_SIT_FUNCIONAL = X.SITUACAO_FUNCIONAL AND TRUNC(F.DATA_INIC_SITUACAO)=TRUNC(TO_DATE(X.DATA_INICIO,'DD/MM/YYYY'))
WHERE F.CODIGO_EMPRESA IS NOT NULL
AND (TO_DATE(X.DATA_INICIO,'DD/MM/YYYY')>= TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY') OR TO_DATE(X.DATA_FIM,'DD/MM/YYYY')>= TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY'))
-------------
)FIM WHERE TO_DATE(FIM.DATA_FIM,'DD/MM/YYYY')>CASE WHEN TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020','DD/MM/YYYY') ELSE TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') END
)XX)X3 GROUP BY X3.EMPRESA, X3.AGRUPAMENTO_EMPRESA, X3.CODIGO_LEGADO, X3.TIPO, X3.CODIGO_EMPRESA, X3.TIPO_CONTRATO, X3.CODIGO_CONTRATO, X3.CODIGO_JUSTIFICATIVA, X3.DESCRICAO, X3.DT_SAIU_ARTE, X3.DT_ENVIADO_IFPONTO_SURICATO, X3.DATA_INICIO, X3.DATA_FIM, X3.PK_ARTE

)LOOP
INSERT INTO PONTO_ELETRONICO.sugesp_bi_afastamentos
(EMPRESA, AGRUPAMENTO_EMPRESA,CODIGO_LEGADO,CODIGO_EMPRESA,TIPO_CONTRATO,CODIGO_CONTRATO,CODIGO_JUSTIFICATIVA,DESCRICAO,DATA_INICIO,DATA_FIM,TIPO,DT_SAIU_ARTE,DT_ENVIADO_IFPONTO_SURICATO,ORIGEM, PK_ARTE)
VALUES
(C1.EMPRESA,C1.AGRUPAMENTO_EMPRESA,C1.CODIGO_LEGADO,C1.CODIGO_EMPRESA,C1.TIPO_CONTRATO,C1.CODIGO_CONTRATO,C1.CODIGO_JUSTIFICATIVA,C1.DESCRICAO,C1.DATA_INICIO,C1.DATA_FIM,C1.TIPO,C1.DT_SAIU_ARTE,C1.DT_ENVIADO_IFPONTO_SURICATO,'ACERTO_BASE', C1.PK_ARTE);
COMMIT;
END LOOP;
END;
/*FIM--AFASTAMENTOS COM DATA FIM */


/*INICIO---AFASTAMENTOS SEM DATA FIM */
BEGIN 
FOR C2 IN (

SELECT X3.* FROM (SELECT CASE WHEN XX.CODIGO_EMPRESA = '0001' THEN 'PREF.MUN.BELO HORIZONTE' WHEN XX.CODIGO_EMPRESA = '0098' THEN 'PREF.MUN.BH CONTRATOS' END AS EMPRESA,
CASE WHEN XX.CODIGO_EMPRESA IN ('0001','0098','0015','0021','0032') THEN 'ADM DIRETA' ELSE 'ADM INDIRETA' END AS AGRUPAMENTO_EMPRESA,
XX.CODIGO_EMPRESA||XX.TIPO_CONTRATO||LTRIM(XX.CODIGO_CONTRATO,0)|| XX.CODIGO_JUSTIFICATIVA||TO_CHAR(TO_DATE(XX.DATA_INICIO,'DD/MM/YYYY'),'YYYY-MM-DD HH24:MI:SS') AS CODIGO_LEGADO,
XX.* FROM
(SELECT FIM.TIPO, FIM.CODIGO_EMPRESA, FIM.TIPO_CONTRATO, FIM.CODIGO_CONTRATO, FIM.CODIGO_JUSTIFICATIVA, FIM.DESCRICAO, SYSDATE AS DT_SAIU_ARTE, NULL AS DT_ENVIADO_IFPONTO_SURICATO,
CASE
WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')<= TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')  AND FIM.FECHAMENTO_SISTEMA IS NOT NULL
THEN TO_CHAR(TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')+1,'DD/MM/YYYY')
WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')>TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') AND FIM.FECHAMENTO_SISTEMA IS NOT  NULL
THEN DATA_INICIO
ELSE FIM.DATA_INICIO END AS DATA_INICIO, FIM.DATA_INICIO_REAL, FIM.DATA_FIM, FIM.SIMULA_DATA, FIM.DATA_SIMULADA, FIM.PK_ARTE
FROM(
SELECT X.*  FROM (SELECT 'INCLUIR' AS TIPO, LC.ID, LC.CODIGO_EMPRESA, LC.TIPO_CONTRATO, LC.CODIGO AS CODIGO_CONTRATO, LC.NEW_COD_SIT_FUNCIONAL AS SITUACAO_FUNCIONAL, PN.CODIGO AS CODIGO_JUSTIFICATIVA, PN.DESCRICAO,
TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY') AS DATA_INICIO, TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')AS DATA_INICIO_REAL,
CASE WHEN TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') IS NULL THEN TO_CHAR(LAST_DAY(SYSDATE),'DD/MM/YYYY') ELSE TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') END AS DATA_FIM,
CASE WHEN TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') IS NULL THEN'SIM' ELSE 'NAO' END AS SIMULA_DATA,
CASE WHEN TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') IS NULL THEN TO_CHAR(LAST_DAY(SYSDATE),'DD/MM/YYYY') ELSE NULL END AS DATA_SIMULADA,
--(SELECT  DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV CV WHERE CODIGO_CONVERSAO = 'FCPT' AND TO_DATE(DADO_ORIGEM,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.DADO_ORIGEM,'DD/MM/YYYY')) FROM ARTERH.RHINTE_ED_IT_CONV AUX WHERE CV.CODIGO_CONVERSAO = AUX.CODIGO_CONVERSAO))
vFECHAMENTO_SISTEMA FECHAMENTO_SISTEMA
, LC.CODIGO_EMPRESA||LC.TIPO_CONTRATO||LC.CODIGO||LC.DATA_INIC_SITUACAO AS PK_ARTE
FROM  ARTERH.SMARH_INT_PE_ALTSITFUN_AUDBKP  LC
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF ON LC.NEW_COD_SIT_FUNCIONAL=SF.CODIGO
LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO PN ON SF.SITUACAO_PONTO=PN.CODIGO
LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO C ON C.CODIGO_EMPRESA=LC.CODIGO_EMPRESA AND C.CODIGO = LC.CODIGO AND C.TIPO_CONTRATO = LC.TIPO_CONTRATO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT')PONTR ON SUBSTR(PONTR.DADO_ORIGEM,20,4) = LC.CODIGO_EMPRESA AND SUBSTR(PONTR.DADO_ORIGEM,24,4) = LC.TIPO_CONTRATO
LEFT OUTER JOIN  ARTERH.VW_SIT_FUNC_PONTO_ATIVO  X ON X.CODIGO_CONTRATO = LC.CODIGO AND X.TIPO_CONTRATO = LC.TIPO_CONTRATO AND X.CODIGO_EMPRESA = LC.CODIGO_EMPRESA
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC S ON S.CODIGO=X.COD_SIT_FUNCIONAL
INNER JOIN PONTO_ELETRONICO.SMARH_INT_CHAVE_INTEGRACAO CHAVE ON CHAVE.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND CHAVE.CODIGO_SITUACAO_FUNCIONAL = S.CODIGO 
WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4) IS NOT NULL AND TIPO_DML IN ('U','I')
AND LC.ID =(SELECT MAX(AUX.ID)FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDBKP AUX WHERE AUX.CODIGO = LC.CODIGO AND AUX.TIPO_CONTRATO = LC.TIPO_CONTRATO AND AUX.CODIGO_EMPRESA = LC.CODIGO_EMPRESA AND TRUNC(AUX.DATA_INIC_SITUACAO)=TRUNC(LC.DATA_INIC_SITUACAO))
AND PN.TIPO_SITUACAO IN ('P','I','F') AND (S.CONTROLE_FOLHA NOT IN ('D','S')) AND S.CODIGO NOT IN ('1017','1851') AND CHAVE.CHAVE_IFPONTO='ATIVO' AND PN.C_LIVRE_VALOR01='1' AND TRUNC(LC.DT_ULT_ALTER_USUA)<TRUNC(SYSDATE)
)X
WHERE EXISTS
(SELECT F.* FROM ARTERH.RHCGED_ALT_SIT_FUN F WHERE F.CODIGO = X.CODIGO_CONTRATO AND F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.TIPO_CONTRATO = X.TIPO_CONTRATO AND F.COD_SIT_FUNCIONAL = X.SITUACAO_FUNCIONAL 
AND TRUNC(F.DATA_INIC_SITUACAO)=TRUNC(TO_DATE(X.DATA_INICIO,'DD/MM/YYYY'))
)AND X.SIMULA_DATA='SIM')FIM
WHERE TO_DATE(FIM.DATA_FIM,'DD/MM/YYYY')>CASE WHEN TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020','DD/MM/YYYY') ELSE TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') END)XX)X3
GROUP BY X3.EMPRESA, X3.AGRUPAMENTO_EMPRESA, X3.CODIGO_LEGADO, X3.TIPO, X3.CODIGO_EMPRESA, X3.TIPO_CONTRATO, X3.CODIGO_CONTRATO, X3.CODIGO_JUSTIFICATIVA, X3.DESCRICAO, X3.DT_SAIU_ARTE, X3.DT_ENVIADO_IFPONTO_SURICATO, X3.DATA_INICIO, X3.DATA_INICIO_REAL, X3.DATA_FIM, X3.SIMULA_DATA, X3.DATA_SIMULADA, X3.PK_ARTE


)LOOP

INSERT INTO PONTO_ELETRONICO.sugesp_bi_afastamentos
(EMPRESA, AGRUPAMENTO_EMPRESA,CODIGO_LEGADO,CODIGO_EMPRESA,TIPO_CONTRATO,CODIGO_CONTRATO,CODIGO_JUSTIFICATIVA,DESCRICAO,DATA_INICIO,DATA_FIM,SIMULA_DATA,DATA_SIMULADA,TIPO,DT_SAIU_ARTE,DT_ENVIADO_IFPONTO_SURICATO,DATA_INICIO_REAL,ORIGEM, PK_ARTE)
VALUES
(C2.EMPRESA,C2.AGRUPAMENTO_EMPRESA,C2.CODIGO_LEGADO,C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO_CONTRATO,C2.CODIGO_JUSTIFICATIVA,C2.DESCRICAO,C2.DATA_INICIO,C2.DATA_FIM,C2.SIMULA_DATA,C2.DATA_SIMULADA,C2.TIPO,C2.DT_SAIU_ARTE,C2.DT_ENVIADO_IFPONTO_SURICATO,C2.DATA_INICIO_REAL,'ACERTO_BASE', C2.PK_ARTE);
COMMIT;
END LOOP;
END;
/*FIM---AFASTAMENTOS SEM DATA FIM */


END;
