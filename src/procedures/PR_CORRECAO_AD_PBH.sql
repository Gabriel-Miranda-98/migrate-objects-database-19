
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_CORRECAO_AD_PBH" 
/*****************************************************************************
  -- Descricao.....: PROCEDURE DIÁRIA PARA GERAR INFORMAÇÕES DE INCLUÃO,
                     ALTERAÇÃO E EXCLUSÃO DE UMA DETERMINADA MATRÍCULA
                     E GRAVAR NA TABELA RHPBH_REGISTRO_AD

  -- Autor.........: MARCELO SOARES / WAGNER SOUZA / PEDRO PAULO LARA RESENDE
  --           Data: 11/04/2019

  -- Parametros....: NA
  -- Funcionamento.: PROCESSO BATCH
  -- Periodicidade.: batch = TODOS OS DIAS ÀS 23:00
*****************************************************************************/
IS

-- padrao de seleçao de ativos de folha das empresas
/*
  EMPRESA = 0001  PADRAO DE SELEÇÃO CNT:  0000 / 1000 (ATIVOS) E 0000 / 1800 (ESTAGIARIOS)
  EMPRESA = 0002  PADRAO DE SELEÇÃO CNT:  0000 / 0004 (ATIVOS) E 0000 / 1800 (ESTAGIARIOS)
  EMPRESA = 0003  PADRAO DE SELEÇÃO CNT:  0000 / 0190 + 1100 (ATIVOS) E 0000 / 1800 (ESTAGIARIOS)
  EMPRESA = 0007  PADRAO DE SELEÇÃO CNT:  0000 / 0011 (ATIVOS) E 0000 / 1800 (ESTAGIARIOS)
  EMPRESA = 0009  PADRAO DE SELEÇÃO CNT:  0000 / 1003 (ATIVOS) NÃO POSSUEM ESTAGIARIO
  EMPRESA = 0010  PADRAO DE SELEÇÃO CNT:  0000 / 0004 (ATIVOS)
  EMPRESA = 0011  PADRAO DE SELEÇÃO CNT:  UTILIZAR A SITUAÇÃO FUNCIONAL IGUAL 1900
  EMPRESA = 0013  PADRAO DE SELEÇÃO CNT:  0001 / 0004 (ATIVOS) / 0001 / 0006 (ESTAGIARIOS)  TC 0001 ATIVO  0003 ESTAG
  EMPRESA = 0014  PADRAO DE SELEÇÃO CNT:  0002 / 0004 (ATIVOS) / 0002 / 0006 (ESTAGIARIOS)  TC 0001 ATIVO  0003 ESTAG
  EMPRESA = 0015  PADRAO DE SELEÇÃO CNT:  0021 / 0015
  EMPRESA = 0021  PADRAO DE SELEÇÃO CNT:  0021 / 7715
  EMPRESA = 0032  PADRAO DE SELEÇÃO CNT:  0021 / 0007

                                              EMPRESA FANTASIA                  FROM                        DIRETORIO
  EMPRESA = 0001  ARTERH_PBH_PRD            - PREFEITURA       -- existe    -- 'Smarh/Gepe'             -- '/trab/arquivos_pbh_ad'          -- PR_GERA_REGISTRO_AD_PBH_NEW
  EMPRESA = 0002  ARTERH_PRODABEL_PRD       - PRODABEL         -- existe    -- 'SRA/GPRA'               -- '/trab/arquivos_prodabel_ad'     -- PR_GERA_REGISTRO_AD_PDBL_NEW
  EMPRESA = 0003  ARTERH_SUDECAP_PRD        - SUDECAP          -- existe    -- 'Dep.pes/sudecap'        -- '/trab/arquivos_sudecap_ad'      -- PR_GERA_REGISTRO_AD_SUDE_NEW
  EMPRESA = 0007  ARTERH_SLU_PRD            - SLU              -- existe    -- 'Dep.pes/slu'            -- '/trab/arquivos_slu_ad'          -- PR_GERA_REGISTRO_AD_SLU_NEW
  EMPRESA = 0009  ARTERH_BELOTUR            - BELOTUR          -- existe    -- 'Dep.pes/belotur'        -- '/trab/arquivos_belotur_ad'      -- PR_GERA_REGISTRO_AD_BELO_NEW
  EMPRESA = 0010  ARTERH_URBEL_PRD          - URBEL            -- existe    -- 'Dep.pes/urbel'          -- '/trab/arquivos_urbel_ad'        -- PR_GERA_REGISTRO_AD_URBL_NEW
  EMPRESA = 0011  ARTERH_PENSAO_FUFIN_PRD   - PENSAO           -- não       -- 'Dep.pes/pensao'         -- '/trab/arquivos_pensao_ad'       -- PR_GERA_REGISTRO_AD_PNSAO_NEW
  EMPRESA = 0013  ARTERH_FMC_PRD            - FMC              -- existe    -- 'Dep.pes/Cultura'        -- '/trab/arquivos_cultura_ad'      -- PR_GERA_REGISTRO_AD_FMC_NEW
  EMPRESA = 0014  ARTERH_FMC_PRD            - FMP              -- existe    -- 'Dep.pes/fpm'            -- '/trab/arquivos_fpm_ad'          -- PR_GERA_REGISTRO_AD_FMP_NEW
  EMPRESA = 0015  PBH_SAUDE_PRD             - PBH SAUDE        -- não       -- 'Dep.pes/PBHSaude'       -- '/trab/arquivos_pbhsaude_ad'     -- PR_GERA_REGISTRO_AD_SAUDE_NEW
  EMPRESA = 0021  PBH_SAUDE_PRD             - CONTRATOS SA     -- não       -- 'Dep.pes/ContratosSA'    -- '/trab/arquivos_contratossa_ad'  -- PR_GERA_REGISTRO_AD_SAUDE_NEW
  EMPRESA = 0032  PBH_SAUDE_PRD             - PBH ZOONOZES     -- não       -- 'Dep.pes/Zoonozes'       -- '/trab/arquivos_zoonozes_ad'     -- PR_GERA_REGISTRO_AD_ZOONZ_NEW
  EMPRESA = 0098  ARTERH_PBH_PRD            - CONTRATOS PBH    -- não       -- 'Dep.pes/ContratosPBH'   -- '/trab/arquivos_contratospbh_ad' -- PR_GERA_REGISTRO_AD_CNTPBH_NEW
  EMPRESA = 1700  ARTERH_PBH_PRD            - APOSENTADOS      -- não       -- 'Dep.pes/Aposentados'    -- '/trab/arquivos_aposentados_ad'  -- PR_GERA_REGISTRO_AD_APSTD_NEW
*/
  --VARIAVEIS CONFORME OS TIPOS CRIADOS NA TABELA RHPBH_REGISTRO_AD

  V_NOME                     RHPBH_REGISTRO_AD.NOME%TYPE;
  V_CARGO                    RHPBH_REGISTRO_AD.CARGO%TYPE;
  V_SECRETARIA               RHPBH_REGISTRO_AD.SECRETARIA%TYPE;
  V_UNIDADE                  RHPBH_REGISTRO_AD.UNIDADE%TYPE;
  V_OPERACAO_JOIN            RHPBH_REGISTRO_AD.IND_OPERACAO%TYPE;
  --VARIAVEIS COMUM
  V_QTD_REGISTRO             INTEGER;
  V_QTD_ARQUIVO_CRIADO       INTEGER;
  V_CONT_INC                 INTEGER;
  V_CONT_ALT                 INTEGER;
  V_CONT_EXE                 INTEGER;
  V_CONT_ERR                 INTEGER;
  V_TELEFONE                 VARCHAR(20);
  V_EMAIL                    VARCHAR(200);
  V_ULT_IND_OPERACAO         VARCHAR(01);  
  V_ULT_DATA_RESCISAO        DATE;
  V_INSERE                   BOOLEAN;

  --VARIÁVEIS REFERENTE A GERAÇÃO DE ARQUIVO TXT
  ID_ARQ                     UTL_FILE.FILE_TYPE;
  LINHA                      VARCHAR(2000) := '';
  DIRETORIO                  VARCHAR(50)   := '/trab/arquivos_pbh_ad';
  ARQUIVO_INC                VARCHAR(50)   := 'Inclusao_AD_PBH_' || TO_CHAR(sysdate,'DDMMYYYY')||'.txt';
  ARQUIVO_ALT                VARCHAR(50)   := 'Alteracao_AD_PBH_'|| TO_CHAR(sysdate,'DDMMYYYY')||'.txt';
  ARQUIVO_EXC                VARCHAR(50)   := 'Exclusao_AD_PBH_' || TO_CHAR(sysdate,'DDMMYYYY')||'.txt';
  ARQUIVO_ERR                VARCHAR(50)   := 'Erro_AD_PBH_'     || TO_CHAR(sysdate,'DDMMYYYY')||'.txt';
  V_TIPO_ARQUIVO             VARCHAR(01)   := 'I';
  V_CONTA_REGISTRO           INTEGER       := 0;

  --VARIÁVEIS REFERENTE A GERAÇÃO DE EMAIL
  AV_NAME_FROM               VARCHAR(200) := 'Smarh/Gepe';
  AV_MSG_FROM                VARCHAR(200) := 'servicos@pbh.gov.br';
  AV_NAME_TO                 VARCHAR(200) := 'servicos@pbh.gov.br';
  AV_MSG_TO                  VARCHAR(200) := 'servicos@pbh.gov.br;gss@pbh.gov.br';
  AV_MSG_SUBJECT_INC         VARCHAR(200) := 'Arquivo para incluir funcionários da PBH no AD';
  AV_MSG_SUBJECT_ALT         VARCHAR(200) := 'Arquivo para alterar funcionários da PBH no AD';
  AV_MSG_SUBJECT_EXC         VARCHAR(200) := 'Arquivo para excluir funcionários da PBH no AD';
  AV_MSG_TEXT_INC            VARCHAR(200) := 'Senhores,'||CHR(13)||CHR(13)||'  Segue em anexo o Arquivo com as inclusões de funcionários da PBH';
  AV_MSG_TEXT_ALT            VARCHAR(200) := 'Senhores,'||CHR(13)||CHR(13)||'  Segue em anexo o Arquivo com as alterações de funcionários da PBH';
  AV_MSG_TEXT_EXC            VARCHAR(200) := 'Senhores,'||CHR(13)||CHR(13)||'  Segue em anexo o Arquivo com as exclusões de funcionários da PBH';
  AV_BODY_HTML               VARCHAR(01)  := 'N';

BEGIN
  -- ******************************************************************************************************
  -- *******************************************  BUSCA ATIVOS E DEMITIDOS ********************************
  -- ******************************************************************************************************
  FOR I IN (	SELECT  CNT.CODIGO   AS MATRICULA,
						CASE 
							WHEN ( (CNT.C_LIVRE_SELEC02 NOT IN (21,32)) AND  ( CG.DESCRICAO NOT LIKE '%ESTAG%')) THEN 'pr'   || LOWER(SUBSTR(CNT.CODIGO,9,6))
							WHEN ( (CNT.C_LIVRE_SELEC02 NOT IN (21,32)) AND  ( CG.DESCRICAO     LIKE '%ESTAG%')) THEN 'pres' || LOWER(SUBSTR(CNT.CODIGO,9,6))
							WHEN ( (CNT.C_LIVRE_SELEC02     IN (21)))                                            THEN 'prct' || LOWER(SUBSTR(CNT.CODIGO,9,7))
							WHEN ( (CNT.C_LIVRE_SELEC02     IN (32)))                                            THEN 'przo' || LOWER(SUBSTR(CNT.CODIGO,9,7))
						ELSE
							'NÃO DEFINIDA'
						END LOGIN,
						CNT.NOME        AS NOME,
						CG.DESCRICAO    AS CARGO_PGTO,
						CASE 
							WHEN ( (CNT.C_LIVRE_SELEC02 NOT IN (21,32))) THEN 'PBH'
							WHEN ( (CNT.C_LIVRE_SELEC02     IN (21)))    THEN 'CONTRATOS SA'
							WHEN ( (CNT.C_LIVRE_SELEC02     IN (32)))    THEN 'ZOONOZES'
						ELSE
							'NÃO DEFINIDA'
						END EMPRESA,      
						DIR.ABREVIACAO  AS SECRETARIA,
						GER.ABREVIACAO  AS UNIDADE,
						PES.CPF         AS CPF,
						CNT.DATA_ADMISSAO,
						CNT.DATA_RESCISAO,
						CNT.DATA_INIC_AFAST,
						CNT.SITUACAO_FUNCIONAL,
						CNT.CODIGO_EMPRESA,
						CNT.CODIGO_PESSOA,
						CNT.TIPO_CONTRATO,
						CNT.C_LIVRE_SELEC02
				FROM  	RHPESS_CONTRATO CNT
						INNER JOIN RHORGA_EMPRESA EMP ON (EMP.CODIGO          = CNT.CODIGO_EMPRESA  AND EMP.DATA_EXTINCAO IS NULL)
						INNER JOIN RHPESS_PESSOA PES  ON (PES.CODIGO          = CNT.CODIGO_PESSOA   AND PES.CODIGO_EMPRESA = CNT.CODIGO_EMPRESA)
						INNER JOIN RHPLCS_CARGO CG    ON (CG.CODIGO           = CNT.COD_CARGO_PAGTO AND CG.CODIGO_EMPRESA  = CNT.CODIGO_EMPRESA)
						LEFT  JOIN RHORGA_UNIDADE DIR ON (DIR.COD_UNIDADE1    = CNT.COD_UNIDADE1
													 AND  DIR.COD_UNIDADE2    = CNT.COD_UNIDADE2
													 AND  DIR.COD_UNIDADE3    = '000000'
													 AND  DIR.COD_UNIDADE4    = '000000'
													 AND  DIR.COD_UNIDADE5    = '000000'
													 AND  DIR.COD_UNIDADE6    = '000000'
													 AND  DIR.CODIGO_EMPRESA  = CNT.CODIGO_EMPRESA)
						LEFT  JOIN RHORGA_UNIDADE GER ON (GER.COD_UNIDADE1    = CNT.COD_UNIDADE1
													 AND  GER.COD_UNIDADE2    = CNT.COD_UNIDADE2
													 AND  GER.COD_UNIDADE3    = CNT.COD_UNIDADE3
													 AND  GER.COD_UNIDADE4    = CNT.COD_UNIDADE4
													 AND  GER.COD_UNIDADE5    = CNT.COD_UNIDADE5
													 AND  GER.COD_UNIDADE6    = CNT.COD_UNIDADE6
													 AND  GER.CODIGO_EMPRESA  = CNT.CODIGO_EMPRESA)
				WHERE 1 = 1
				AND   CNT.ANO_MES_REFERENCIA  = (SELECT MAX (CNT2.ANO_MES_REFERENCIA)
												 FROM RHPESS_CONTRATO CNT2
												 WHERE CNT2.CODIGO       		= CNT.CODIGO
												 AND   CNT2.CODIGO_EMPRESA 		= CNT.CODIGO_EMPRESA
												 AND   CNT2.TIPO_CONTRATO  		= CNT.TIPO_CONTRATO
												 AND   CNT2.ANO_MES_REFERENCIA <= SYSDATE)
				AND   CNT.TIPO_CONTRATO       IN ('0001', '0211')
				AND   CNT.CODIGO_EMPRESA      = '0001'
				AND   CNT.CODIGO NOT IN ('00000000000001X', '000000000913670','000000000913676')
				AND   CNT.SITUACAO_FUNCIONAL <> '1715'
				AND   (     (CNT.DATA_RESCISAO IS NULL)
						OR  (     CNT.DATA_RESCISAO > (SYSDATE - (EMP.C_LIVRE_SELEC01 + 1))
				AND   CNT.COD_UNIDADE1 <> '000099'
				AND   CNT.COD_UNIDADE2 <> '000001'))
				AND   CNT.DATA_ADMISSAO IS NOT NULL
				AND   CNT.C_LIVRE_SELEC02 IS NOT NULL
				AND   PES.CPF IN ('00018498671','00063868652','00069455627','00118234617','00134344626','00148702660','00225611619','00356774651','00361919654','00375041699',
								  '00375399658','00400321670','00827064179','00834462656','00940863626','00952775603','01161828141','01163498599','01190375648','01207465658',
								  '01222806606','01246397633','01274782643','01287553699','01288900619','01297140621','01297515617','01298509696','01309017689','01330181646',
								  '01333880693','01367435609','01368211623','01374546607','01376161630','01378157605','01379686636','01433274612','01444872680','01449787681',
								  '01459069650','01472253531','01481813684','01492003662','01512705624','01513261002','01520922698','01533437610','01555877656','01568780621',
								  '01582162611','01603465685','01613005610','01642476617','01644395606','01765767628','01777309603','01787432670','01787975614','01838170600',
								  '01839796642','01865060666','01896353630','01897000685','01902688678','01920364595','01968205616','02009296150','02141030641','02174950600',
								  '02383038105','02388440645','02508093629','02512701654','02534699610','02613481676','02618505638','02684645612','02694232655','02723637662',
								  '02738719600','02743630620','02775356621','02810120676','02892271606','02904563636','02966061626','02973393620','03008283659','03034285620',
								  '03037164603','03067729650','03092108604','03110353610','03123700674','03169706624','03200541601','03214631616','03236938650','03253440605',
								  '03272986693','03353871608','03380035688','03439296512','03565341629','03575645612','03599942617','03605324622','03621337601','03650601605',
								  '03690906679','03709519640','03750275645','03762944695','03799424105','03837142655','03844744622','03873300621','03880477639','03897120607',
								  '03950029664','03951432683','03955572161','03998782621','04009880627','04024055607','04043925638','04057640657','04078626688','04103253681',
								  '04107394646','04113958580','04120491633','04142124609','04192376660','04196626696','04198625603','04199591656','04263196643','04272716654',
								  '04300169640','04377960601','04387601663','04393114620','04401195612','04409984683','04427266606','04444420650','04458577654','04465932650',
								  '04595844646','04658336677','04664695608','04690293660','04704640620','04707628613','04733039654','04805320605','04809411141','04817799307',
								  '04820013645','04843836630','04859264665','04860424646','04910562656','04915260674','04918980619','04967196616','04971711635','05013346967',
								  '05028843635','05079524642','05123464611','05127217694','05150634603','05220722670','05253518681','05291841680','05320691610','05331291686',
								  '05392727603','05476400648','05514973603','05520658625','05560336637','05585942638','05613871680','05688050624','05698398666','05799918657',
								  '05800324697','05800373639','05803130699','05812342601','05821168643','05828024663','05918709673','05943512608','05998983645','06008460677',
								  '06098970637','06129789661','06151848632','06249994750','06253880624','06267187675','06273140669','06286316698','06304328648','06313142616',
								  '06505692614','06517321667','06526384650','06613150614','06625677655','06626658646','06629194675','06634964971','06647385673','06676788675',
								  '06691783654','06723297601','06742872667','06760194632','06834683674','06838576651','06860325607','06909466608','06919698684','06923505607',
								  '06946521641','06973229638','06973776604','06990044624','07017765605','07039293641','07049859699','07086703699','07114628609','07128395695',
								  '07130108606','07181184644','07186519601','07192244627','07197419638','07299036304','07317974692','07326083681','07341190620','07454728693',
								  '07458832657','07478479677','07617082606','07617333617','07637057640','07644771611','07725631607','07740186660','07741013696','07797928665',
								  '07803746659','07843252606','07861351661','07879700692','07881133643','07893344610','07899163633','07899433606','07938682624','07948872604',
								  '07953375664','07988016628','07998867698','08002570650','08011491695','08011496654','08041500609','08063236637','08078861656','08084934694',
								  '08100220603','08100992681','08138074680','08145505682','08187980680','08193729609','08212346684','08224751627','08263500621','08268210656',
								  '08295437674','08336961658','08363845639','08401522641','08474534640','08568402623','08617932694','08622783685','08639883696','08645547619',
								  '08656912666','08659795610','08663465629','08672279662','08688224692','08689244662','08696806689','08719194609','08736662674','08741032667',
								  '08756784678','08762153633','08763148684','08763459680','08796299673','08824232663','08828492635','08832441608','08840923640','08847478677',
								  '08856463636','08888346678','08902827658','08925702614','08927800613','08932121648','08940276620','08963976610','08965066654','08972998680',
								  '08973188623','08998889684','09014908652','09056198629','09077254498','09095070662','09114295652','09120954662','09129270626','09158301674',
								  '09186810650','09187082659','09195586660','09244877635','09271402685','09356748616','09361432664','09400247648','09406809630','09430154648',
								  '09447427693','09521462663','09542311630','09569433655','09619833619','09621078679','09648378622','09672593635','09738191629','09782766631',
								  '09835966621','09854153630','09860905657','09867947673','09882716644','09890895684','09901599652','09919299693','09933007661','10075071606',
								  '10076410617','10112369669','10128015608','10188013679','10188605681','10219940657','10223314692','10226821641','10236416669','10287257606',
								  '10311085644','10312554605','10346356628','10397737610','10414075641','10425174603','10430290608','10436876612','10471713686','10477185614',
								  '10510533663','10520779789','10522249620','10548245681','10568756665','10591881632','10621048623','10719564697','10757487637','10758180608',
								  '10800811607','10814697658','10827974647','10832775614','10874292697','10894204637','10984643621','11006529659','11016980639','11035691639',
								  '11077339607','11183182694','11206704624','11232796670','11233187600','11238822665','11279124610','11286452627','11317721640','11338574698',
								  '11340309670','11342160681','11342211693','11351930613','11388001632','11400866693','11438034695','11479424633','11490986600','11520157614',
								  '11520160674','11520844611','11547711647','11560951664','11615653619','11668743620','11695452623','11747932604','11757679642','11773213601',
								  '11891768662','11942654642','11979443629','11990720609','12045399605','12048206603','12056709635','12097588654','12163489604','12165661609',
								  '12257491661','12314771648','12351123654','12360135651','12370845635','12474359621','12478888602','12486382631','12537529669','12600160647',
								  '12615567632','12647775664','12654460673','12692106610','12736754603','12899729667','12906860689','13009640650','13251338684','13557510638',
								  '13770247680','13854716702','13926967633','13988380636','13991832658','14105333607','14119776611','14270444657','14322927653','14502060690',
								  '14514033642','14546592620','14711687602','15369131627','15506174608','15568686696','15879335607','15988134637','17569116658','29741688687',
								  '30123429668','30562147691','34222569895','34460888653','36651776851','37049756806','37091522672','37785001634','38549891649','41457536668',
								  '44203926653','44221991615','45701997634','45940258620','46257624649','48525626600','48598127604','48639168687','50639358691','50873245687',
								  '51419998668','51917246404','52968510215','53335945620','53443381634','55644180697','55806562620','55903690610','56333757691','57489696704',
								  '57747598220','58489690600','58523090606','60729791653','61046116649','61805947672','63600765604','64574199687','67067760682','67177832653',
								  '69653801600','70010803653','70287511634','70518653668','71779442653','72529474320','72906197653','73035009600','73043710649','73165263604',
								  '74534300620','74722301620','74779664691','76033970659','76786315615','78565316653','78566142691','78881951649','79500170663','81166508668',
								  '81207174653','82396493604','84452374620','84565640600','85137910678','85203114587','86697978600','87931850653','88371620659','89273818749',
								  '90138341672','91784255653','92528279604','93504284668','94142980610','94384401604','94805300663','95116826600','95390170687','95642102672',
								  '95688153687','96115289653','97090590682','97226360659','97314455368','97768952634','98798847600','98816837691','98858254600','98893785668',
								  '98920669600','99267071653','99486350604','99673665672') )
  LOOP
    BEGIN
      /************************************ T E L E F O N E ***********************************************************/
	  SELECT '('||SUBSTR(TRIM(NVL(TO_CHAR(TEL.DDD, '000'), '031')), 2, 2)||')'||
                 DECODE(LENGTH(TEL.TELEFONE), 8, '9'||TRIM(SUBSTR(TEL.TELEFONE, 1, 4))||'-'||SUBSTR(TEL.TELEFONE, 5, 8),
                        TRIM(SUBSTR(TEL.TELEFONE, 1, 5))||'-'||SUBSTR(TEL.TELEFONE, 6, 9)) INTO V_TELEFONE
      FROM   (SELECT P.CODIGO_EMPRESA, C.CODIGO,
                     TRIM(TRANSLATE(P.TELEFONE, TRANSLATE('('||P.TELEFONE, '1234567890', ' '), ' ')) TELEFONE,
                     TRIM(TRANSLATE(P.DDD, TRANSLATE('('||P.DDD, '1234567890', ' '), ' ')) DDD
              FROM   RHPESS_TELEFONE_P P, RHPESS_CONTRATO C
              WHERE  P.COD_TIPO_TELEFONE = 2
              AND    P.CODIGO_EMPRESA    = C.CODIGO_EMPRESA
              AND    P.CODIGO_PESSOA     = C.CODIGO_PESSOA
              AND    C.TIPO_CONTRATO     = I.TIPO_CONTRATO
              AND    P.PREFERENCIAL      = 'S') TEL
      WHERE   TEL.CODIGO_EMPRESA = '0001'
      AND     TEL.CODIGO         = I.MATRICULA;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        V_TELEFONE := NULL;
      WHEN TOO_MANY_ROWS THEN
        V_TELEFONE := NULL;
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE(I.MATRICULA);
        V_TELEFONE := 1/0;
    END;
    /************************************ E M A I L *******************************************************************/
    BEGIN
      SELECT NVL(E.ENDER_ELETRONICO, ' ') INTO V_EMAIL
      FROM   (SELECT P.ENDER_ELETRONICO, P.CODIGO_EMPRESA, C.CODIGO,
                     SUBSTR(TRIM(TRANSLATE(ENDER_ELETRONICO, TRANSLATE(ENDER_ELETRONICO, '@', ' '), ' ')), 1, 1) ARROBA
              FROM   RHPESS_ENDERECO_P P, RHPESS_CONTRATO C
              WHERE  P.ENDER_ELETRONICO IS NOT NULL
              AND    P.CODIGO_EMPRESA   = C.CODIGO_EMPRESA
              AND    P.CODIGO_PESSOA    = C.CODIGO_PESSOA
			  AND    C.TIPO_CONTRATO    = I.TIPO_CONTRATO) E
      WHERE  E.CODIGO_EMPRESA = '0001'
      AND    E.ARROBA         = '@'
      AND    E.CODIGO         = I.MATRICULA;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        V_EMAIL := NULL;
      WHEN TOO_MANY_ROWS THEN
        V_EMAIL := NULL;
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE(I.MATRICULA);
        V_EMAIL := 1/0;
    END;
    -- VERIFICA SE A MATRICULA ENCONTRADA NO LOOP EXISTE NA TABELA RHPBH_REGISTRO_AD
    SELECT NVL(COUNT(*),0) INTO V_QTD_ARQUIVO_CRIADO
    FROM RHPBH_REGISTRO_AD AD
    WHERE LOWER(AD.BM_MATRIC) = I.LOGIN
	AND   AD.EMPRESA          = I.EMPRESA;

    V_INSERE        := FALSE;
    V_OPERACAO_JOIN := 'I';

    IF V_QTD_ARQUIVO_CRIADO = 0 THEN
      --NÃO EXISTE NA TABELA RHPBH_REGISTRO_AD
      V_INSERE := TRUE;
      IF I.DATA_RESCISAO IS NOT NULL THEN
        V_OPERACAO_JOIN := 'E';
      END IF;
    ELSE
      --EXISTE NA TABELA RHPBH_REGISTRO_AD
      --BUSCA NOME, CARGO, SECRETARIA, UNIDADE, DATA_RESCISAO E IND_OPERACAO DO ÚLTIMO REGISTRO PARA COMPARAÇÃO
      BEGIN
        SELECT NOME, CARGO, SECRETARIA, UNIDADE, DATA_RESCISAO, IND_OPERACAO INTO
               V_NOME, V_CARGO, V_SECRETARIA, V_UNIDADE, V_ULT_DATA_RESCISAO, V_ULT_IND_OPERACAO
        FROM  RHPBH_REGISTRO_AD AD
        WHERE LOWER(AD.BM_MATRIC)     = I.LOGIN
		AND   AD.EMPRESA              = I.EMPRESA
        AND   AD.ID_RHPBH_REGISTRO_AD = (SELECT MAX(A.ID_RHPBH_REGISTRO_AD) AS ID_RHPBH_REGISTRO_AD
                                         FROM   RHPBH_REGISTRO_AD A
                                         WHERE  LOWER(A.BM_MATRIC) = I.LOGIN
                                         AND    A.EMPRESA          = I.EMPRESA);
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          V_NOME       := NULL;
          V_CARGO      := NULL;
          V_SECRETARIA := NULL;
          V_UNIDADE    := NULL;
        WHEN OTHERS THEN
          DBMS_OUTPUT.PUT_LINE(I.MATRICULA);
          V_NOME       := 1/0;
      END;

      IF I.DATA_RESCISAO IS NOT NULL THEN --DEMITIDO NO RH
        V_OPERACAO_JOIN := 'E';
        V_INSERE := (V_ULT_IND_OPERACAO <> 'E');--ULTIMO REGISTRO NA TABELA RHPBH_REGISTRO_AD NÃO É DEMISSÃO
      ELSE --ATIVO NO RH
        V_OPERACAO_JOIN := 'A';
        V_INSERE := (V_NOME <> I.NOME) OR (V_CARGO <> I.CARGO_PGTO) OR (V_SECRETARIA <> I.SECRETARIA) OR
                    (V_UNIDADE <> I.UNIDADE) OR (V_ULT_DATA_RESCISAO <> I.DATA_RESCISAO);--EXISTE ALGUMA ALTERAÇÃO NOS CAMPOS
      END IF;
    END IF;

    IF V_INSERE THEN
      INSERT INTO RHPBH_REGISTRO_AD
      VALUES (ID_SEQ_REGISTRO_AD.NEXTVAL, I.LOGIN, I.NOME, I.CARGO_PGTO, I.EMPRESA, I.SECRETARIA, I.UNIDADE, I.CPF, 'N', V_OPERACAO_JOIN,
              TRUNC(SYSDATE), I.DATA_ADMISSAO, I.DATA_RESCISAO, I.DATA_INIC_AFAST, NULL, NULL, I.SITUACAO_FUNCIONAL, V_TELEFONE, V_EMAIL);

      SELECT NVL(COUNT(*),0) INTO V_QTD_REGISTRO
      FROM   RHUSER_P_SIST U
      WHERE  LOWER(U.CODIGO_USUARIO) = I.LOGIN;

      IF V_QTD_REGISTRO = 0 THEN
        INSERT INTO RHUSER_P_SIST (CODIGO_USUARIO,          GERA_LOG,                USA_JANELA_ACOMP,        DT_M_OPER_PROPRIO,       DATA_SISTEMA,
                                   ANO_BASE,                USA_SAL_PRINCIPAL,       MODO_OPER_MOVI,          CTRL_OPER_AUXILIAR,      MODO_OPER_TSAL,
                                   MODO_OPER_PONTO,         EMPR_TP_CONTR_PROP,      EMPRESA_SELEC,           TIPO_CONTR_SELEC,        LOGIN_USUARIO,
                                   DT_ULT_ALTER_USUA,       ALT_MOV_LIQUIDO,         COD_PAD_CONTRATO,        MSG_PARA_ARQ_TEXTO,      EXIBE_IDENT_TABELA,
                                   USA_DELIMIT_EXPORT,      DELIMITADOR_EXPORT,      EXPORT_NRO_REAL,         ALT_MV_PT_DT_RETRO,      USA_COD_ALTER_VERB,
                                   CODIGO_GRUPO,            GRUPO_SEL_CONTRATO,      GRUPO_SEL_PESSOA,        COD_SEL_PESSOA,          GRUPO_SEL_CAND,
                                   COD_SEL_CANDIDATO,       GRUPO_SEL_VERBA,         COD_SEL_VERBA,           ALT_PROPRIEDADES,        QTDE_MIN_ATIVO,
                                   PERMITE_INCLUSAO,        PERMITE_EXCLUSAO,        PERMITE_ALTERACAO,       PERMITE_EXECUCAO,        GRUPO_SEL_UNID,
                                   COD_SEL_UNID,            GRUPO_SEL_CCONT,         COD_SEL_CCONT,           GRUPO_SEL_CGER,          COD_SEL_CGER,
                                   EMPRESA_USUARIO,         TP_CONTR_USUARIO,        CONTRATO_USUARIO,        PESSOA_USUARIO,          GRUPO_SEL_LOC,
                                   COD_SEL_LOC,             USA_DT_MAQUINA,          CTRL_ATIVO,              NRO_MOD_SIMULT,          QTDE_REG_AUTO,
                                   CONSISTE_LANC_VERB,      INSERE_LIQUIDO,          BLOQUEIA_CONTRATO,       BLOQUEIA_PESSOA,         EXIBE_DICA,
                                   ALT_CONT_DT_RETRO,       ALT_PESS_DT_RETRO,       ALT_DATA_GERAL,          COD_PERIODO,             EDITA_SALARIO,
                                   NATUR_PROC_SELEC,        GRUPO_SEGURANCA,         MENU_DEF_ENABLED,        MENU_DEF_VISIBLE,        SENHA_USUARIO,
                                   STATUS_USUARIO,          DT_ULT_TROCA_SENHA,      CODIGO_SGBD_PADRAO,      DIAS_EXPIRA_SENHA,       PW_QTDE_POSIC,
                                   PW_ALFANUM,              PW_SUBSET_USUA,          PW_QTDE_TENTA,           PW_COMECA_VOGAL,         APLIC_PROPRIEDADES,
                                   NOME_USUARIO,            CODIGO_IDIOMA,           DIAS_EXP_SEM_ACESS,      DT_ULT_ACESSO,           CT_APLIC_PSEL_CONT,
                                   CT_APLIC_PSEL_PESS,      C_LIVRE_SELEC01,         C_LIVRE_SELEC02,         C_LIVRE_SELEC03,         C_LIVRE_VALOR01,
                                   C_LIVRE_VALOR02,         C_LIVRE_VALOR03,         C_LIVRE_DESCR01,         C_LIVRE_DESCR02,         C_LIVRE_DESCR03,
                                   C_LIVRE_OPCAO01,         C_LIVRE_OPCAO02,         C_LIVRE_OPCAO03,         C_LIVRE_DATA01,          C_LIVRE_DATA02,
                                   C_LIVRE_DATA03,          ALT_MOV_LIQ_AGRUP,       EXPAND_CAMINHO,          EDITA_GRUPO,             GRAVA_TEMPO_FORM,
                                   MIN_TESTE_ESCALONA,      ACERTO_BASE_HIST,        MODULO_ACESSADO,         ALT_PONTO_DT_RETRO,      CTRL_ACESSO_IND,
                                   APELIDO,                 TIPO_AGRUP_USUARIO,      PERMITE_TPAGR_ESP,       DEPURA,                  PW_SUBSET_NOME,
                                   PW_DATAS_PESSOAIS,       PW_DOCS_PESSOAIS,        USUARIO_LDAP,            TIPO_LOGIN,              CODIGO_SERV_AUTENT,
                                   INS_MOV_MEST_CONTR,      INS_MOV_MEST_AGRUP,      INS_MOV_MEST_VAGA,       ACESSA_OUTRO_USUA,       MODULO_ACES_WEB,
                                   ESTACAO_REDE,            LOG_DETALHADO,           PERSISTE_ARG_SEL,        DATA_CRIACAO,            EXEC_INST_ESCALONA,
                                   PERMITE_EFETIVAR_SQL,    CONTROLE_BPM,            ULTIMO_PERFIL_ACESSO_AZC)
        SELECT I.LOGIN,                      USR.GERA_LOG,                 USR.USA_JANELA_ACOMP,         USR.DT_M_OPER_PROPRIO,        USR.DATA_SISTEMA,
               USR.ANO_BASE,                 USR.USA_SAL_PRINCIPAL,        USR.MODO_OPER_MOVI,           USR.CTRL_OPER_AUXILIAR,       USR.MODO_OPER_TSAL,
               USR.MODO_OPER_PONTO,          USR.EMPR_TP_CONTR_PROP,       USR.EMPRESA_SELEC,            USR.TIPO_CONTR_SELEC,         USR.LOGIN_USUARIO,
               USR.DT_ULT_ALTER_USUA,        USR.ALT_MOV_LIQUIDO,          USR.COD_PAD_CONTRATO,         USR.MSG_PARA_ARQ_TEXTO,       USR.EXIBE_IDENT_TABELA,
               USR.USA_DELIMIT_EXPORT,       USR.DELIMITADOR_EXPORT,       USR.EXPORT_NRO_REAL,          USR.ALT_MV_PT_DT_RETRO,       USR.USA_COD_ALTER_VERB,
               USR.CODIGO_GRUPO,             USR.GRUPO_SEL_CONTRATO,       USR.GRUPO_SEL_PESSOA,         USR.COD_SEL_PESSOA,           USR.GRUPO_SEL_CAND,
               USR.COD_SEL_CANDIDATO,        USR.GRUPO_SEL_VERBA,          USR.COD_SEL_VERBA,            USR.ALT_PROPRIEDADES,         USR.QTDE_MIN_ATIVO,
               USR.PERMITE_INCLUSAO,         USR.PERMITE_EXCLUSAO,         USR.PERMITE_ALTERACAO,        USR.PERMITE_EXECUCAO,         USR.GRUPO_SEL_UNID,
               USR.COD_SEL_UNID,             USR.GRUPO_SEL_CCONT,          USR.COD_SEL_CCONT,            USR.GRUPO_SEL_CGER,           USR.COD_SEL_CGER,
               I.CODIGO_EMPRESA,             I.TIPO_CONTRATO,              I.MATRICULA,                  I.CODIGO_PESSOA,              USR.GRUPO_SEL_LOC,
               USR.COD_SEL_LOC,              USR.USA_DT_MAQUINA,           USR.CTRL_ATIVO,               USR.NRO_MOD_SIMULT,           USR.QTDE_REG_AUTO,
               USR.CONSISTE_LANC_VERB,       USR.INSERE_LIQUIDO,           USR.BLOQUEIA_CONTRATO,        USR.BLOQUEIA_PESSOA,          USR.EXIBE_DICA,
               USR.ALT_CONT_DT_RETRO,        USR.ALT_PESS_DT_RETRO,        USR.ALT_DATA_GERAL,           USR.COD_PERIODO,              USR.EDITA_SALARIO,
               USR.NATUR_PROC_SELEC,         USR.GRUPO_SEGURANCA,          USR.MENU_DEF_ENABLED,         USR.MENU_DEF_VISIBLE,         USR.SENHA_USUARIO,
               USR.STATUS_USUARIO,           USR.DT_ULT_TROCA_SENHA,       USR.CODIGO_SGBD_PADRAO,       USR.DIAS_EXPIRA_SENHA,        USR.PW_QTDE_POSIC,
               USR.PW_ALFANUM,               USR.PW_SUBSET_USUA,           USR.PW_QTDE_TENTA,            USR.PW_COMECA_VOGAL,          USR.APLIC_PROPRIEDADES,
               I.NOME,                       USR.CODIGO_IDIOMA,            USR.DIAS_EXP_SEM_ACESS,       USR.DT_ULT_ACESSO,            USR.CT_APLIC_PSEL_CONT,
               USR.CT_APLIC_PSEL_PESS,       USR.C_LIVRE_SELEC01,          USR.C_LIVRE_SELEC02,          USR.C_LIVRE_SELEC03,          USR.C_LIVRE_VALOR01,
               USR.C_LIVRE_VALOR02,          USR.C_LIVRE_VALOR03,          USR.C_LIVRE_DESCR01,          USR.C_LIVRE_DESCR02,          USR.C_LIVRE_DESCR03,
               USR.C_LIVRE_OPCAO01,          USR.C_LIVRE_OPCAO02,          USR.C_LIVRE_OPCAO03,          USR.C_LIVRE_DATA01,           USR.C_LIVRE_DATA02,
               USR.C_LIVRE_DATA03,           USR.ALT_MOV_LIQ_AGRUP,        USR.EXPAND_CAMINHO,           USR.EDITA_GRUPO,              USR.GRAVA_TEMPO_FORM,
               USR.MIN_TESTE_ESCALONA,       USR.ACERTO_BASE_HIST,         USR.MODULO_ACESSADO,          USR.ALT_PONTO_DT_RETRO,       USR.CTRL_ACESSO_IND,
               USR.APELIDO,                  USR.TIPO_AGRUP_USUARIO,       USR.PERMITE_TPAGR_ESP,        USR.DEPURA,                   USR.PW_SUBSET_NOME,
               USR.PW_DATAS_PESSOAIS,        USR.PW_DOCS_PESSOAIS,         I.LOGIN,                      USR.TIPO_LOGIN,               USR.CODIGO_SERV_AUTENT,
               USR.INS_MOV_MEST_CONTR,       USR.INS_MOV_MEST_AGRUP,       USR.INS_MOV_MEST_VAGA,        USR.ACESSA_OUTRO_USUA,        USR.MODULO_ACES_WEB,
               USR.ESTACAO_REDE,             USR.LOG_DETALHADO,            USR.PERSISTE_ARG_SEL,         SYSDATE,                      USR.EXEC_INST_ESCALONA,
               USR.PERMITE_EFETIVAR_SQL,     USR.CONTROLE_BPM,             USR.ULTIMO_PERFIL_ACESSO_AZC
        FROM   RHUSER_P_SIST USR
        WHERE  USR.CODIGO_USUARIO = 'MODELO';

        DELETE RHUSER_RL_USR_GRP WHERE LOWER(CODIGO_USUARIO) = I.LOGIN;

        INSERT INTO RHUSER_RL_USR_GRP (CODIGO_USUARIO, CODIGO_GRUPO, LOGIN_USUARIO, DT_ULT_ALTER_USUA)
        SELECT I.LOGIN, T.CODIGO_GRUPO, 'PROCEDURE_AD', SYSDATE
        FROM   RHUSER_RL_USR_GRP T
        WHERE  T.CODIGO_USUARIO = 'MODELO';

      END IF;
    END IF;

  END LOOP;
  COMMIT;

  -- ******************************************************************************************************
  -- ******************************** GERAR ARQUIVO TXT E MODIFICAR PARÂMETROS ****************************
  -- ******************************************************************************************************

  SELECT NVL(COUNT(*),0) INTO V_CONT_INC
  FROM   RHPBH_REGISTRO_AD AD
  WHERE  AD.IND_OPERACAO = 'I'
  AND    AD.IND_GEROU_ARQ_TXT = 'N';

  SELECT NVL(COUNT(*),0) INTO V_CONT_ALT
  FROM   RHPBH_REGISTRO_AD AD
  WHERE  AD.IND_OPERACAO = 'A'
  AND    AD.IND_GEROU_ARQ_TXT = 'N';

  SELECT NVL(COUNT(*),0) INTO V_CONT_EXE
  FROM   RHPBH_REGISTRO_AD AD
  WHERE  AD.IND_OPERACAO = 'E'
  AND    AD.IND_GEROU_ARQ_TXT = 'N';

  FOR I IN 1..3
  LOOP
    V_CONTA_REGISTRO := 0;
    CASE WHEN I = 1 THEN
      BEGIN
        V_TIPO_ARQUIVO := 'I';
        ID_ARQ := UTL_FILE.FOPEN(DIRETORIO,ARQUIVO_INC,'W');
      END;
      WHEN I = 2 THEN
      BEGIN
        V_TIPO_ARQUIVO := 'A';
        ID_ARQ := UTL_FILE.FOPEN(DIRETORIO,ARQUIVO_ALT,'W');
      END;
      WHEN I = 3 THEN
      BEGIN
        V_TIPO_ARQUIVO := 'E';
        ID_ARQ := UTL_FILE.FOPEN(DIRETORIO,ARQUIVO_EXC,'W');
      END;
    END CASE;

    FOR ARQTXT IN(SELECT TRIM(BM_MATRIC)  ||';'|| TRIM(NOME)    ||';'|| TRIM(CARGO) ||';'|| TRIM(EMPRESA)    ||';'||
                         TRIM(SECRETARIA) ||';'|| TRIM(UNIDADE) ||';'|| TRIM(CPF)   ||';'|| IND_OPERACAO     ||';'||
                         TO_CHAR(DATA_INCLUSAO, 'DD/MM/YYYY')   ||';'|| TO_CHAR(DATA_ADMISSAO, 'DD/MM/YYYY') ||';'||
                         TO_CHAR(DATA_RESCISAO, 'DD/MM/YYYY')   ||';'|| TELEFONE    ||';'|| EMAIL AS REGISTRO
                  FROM   RHPBH_REGISTRO_AD WHERE IND_GEROU_ARQ_TXT = 'N' AND IND_OPERACAO = V_TIPO_ARQUIVO
                  ORDER  BY BM_MATRIC)
    LOOP
      V_CONTA_REGISTRO := V_CONTA_REGISTRO + 1;
      LINHA := TRIM(RPAD(ARQTXT.REGISTRO, 477)) || CHR(13);
      UTL_FILE.PUT_LINE(ID_ARQ, LINHA);
    END LOOP;

    IF V_CONTA_REGISTRO > 0 THEN
      UTL_FILE.FCLOSE(ID_ARQ);
      UPDATE RHPBH_REGISTRO_AD SET IND_GEROU_ARQ_TXT = 'S', DATA_PROCESSAMENTO_ARQ = TRUNC(SYSDATE)
      WHERE  IND_OPERACAO = V_TIPO_ARQUIVO AND IND_GEROU_ARQ_TXT = 'N';
      COMMIT;
    END IF;
  END LOOP;
  -- ******************************************************************************************************
  -- ******************** ENVIA ARQUIVO TXT DE INCLUSÃO E EXCLUSÃO POR E-MAIL *****************************
  -- ******************************************************************************************************
  FOR I IN 1..3
  LOOP
    CASE
      WHEN I = 1 THEN
        IF V_CONT_INC > 0 THEN
          PR_ENVIA_EMAIL_AD(AV_NAME_FROM, AV_MSG_FROM, AV_NAME_TO, AV_MSG_TO, AV_MSG_SUBJECT_INC, AV_MSG_TEXT_INC, ARQUIVO_INC, DIRETORIO, AV_BODY_HTML);
        END IF;
      WHEN I = 2 THEN
        IF V_CONT_ALT > 0 THEN
          PR_ENVIA_EMAIL_AD(AV_NAME_FROM, AV_MSG_FROM, AV_NAME_TO, AV_MSG_TO, AV_MSG_SUBJECT_ALT, AV_MSG_TEXT_ALT, ARQUIVO_ALT, DIRETORIO, AV_BODY_HTML);
        END IF;
      WHEN I = 3 THEN
        IF V_CONT_EXE > 0 THEN
          PR_ENVIA_EMAIL_AD(AV_NAME_FROM, AV_MSG_FROM, AV_NAME_TO, AV_MSG_TO, AV_MSG_SUBJECT_EXC, AV_MSG_TEXT_EXC, ARQUIVO_EXC, DIRETORIO, AV_BODY_HTML);
        END IF;
    END CASE;
  END LOOP;

  -- IMPLEMENTADO GERAÇÃO DE ARQUIVO COM ERROS DO EXCEPT E ENVIO DO MESMO
  IF V_CONT_ERR > 0 THEN
	PR_ENVIA_EMAIL_AD(AV_NAME_FROM, AV_MSG_FROM, AV_NAME_TO, AV_MSG_TO, AV_MSG_SUBJECT_EXC, AV_MSG_TEXT_EXC, ARQUIVO_ERR, DIRETORIO, AV_BODY_HTML);
  END IF;

END PR_CORRECAO_AD_PBH;