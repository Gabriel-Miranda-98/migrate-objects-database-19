
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_SUGESP_REPSITFUNCFERIAS_SAN" (EMPRESA IN VARCHAR2, TIPO_CONTRATO IN VARCHAR2, BM IN VARCHAR2) AS 
--KELLYSSON 18/2/20

--reprocessar_sit_func_ferias_saneamentov1.sql

BEGIN-- 1Ã‚Âº BEGIN


--KELLYSSON EM 21/10/19 continuando em 29/10/19
--/*
declare
vEMPRESA VARCHAR2(4);
vTIPO_CONTRATO VARCHAR2(4);
vBM VARCHAR2(15);

vCONTADOR NUMBER;
data_inicial date;
data_final date;
num_dias number;
vDATA_DIA date;
vANO_MES_REF DATE;

vDATA_CORTE DATE;

begin
dbms_output.enable(null);
vCONTADOR :=0;
vANO_MES_REF := NULL;

vEMPRESA := EMPRESA;--'0001';
vTIPO_CONTRATO := TIPO_CONTRATO;--'0001';
vBM :=  BM;  --'000000000170171';

SELECT S.DATA_CORTE_SIT_FUNC_PONTO INTO vDATA_CORTE FROM  SUGESP_SANEAMENTO_CONTRATOS S 
WHERE S.DATA_INI_SIT_FUNC_PONTO IS NOT NULL AND S.DATA_FIM_SIT_FUNC_PONTO IS NULL
AND S.CODIGO_EMPRESA  =  vEMPRESA--'0001'-- 
AND S.TIPO_CONTRATO = vTIPO_CONTRATO--'0001'-- 
AND CODIGO_CONTRATO = vBM ;--'000000000170171';-- 


for c1 in(


--SELECT PARA BUSCAR OS REGISTROS
SELECT
X2.* 
,CASE WHEN X2.DATA_INICIO < X2.ULTIMA_DATA_INI_FOLHA THEN X2.ULTIMA_DATA_INI_FOLHA ELSE X2.DATA_INICIO END DATA_INICIO_SIT_PONTO
,CASE WHEN X2.DATA_FIM > X2.ULTIMA_DATA_FIM_FOLHA THEN X2.ULTIMA_DATA_FIM_FOLHA ELSE X2.DATA_FIM END DATA_FIM_SIT_PONTO
FROM 
(--INICIO X2
SELECT 
----------------------------------------------------------------INICIO-----PARA SABER PERIODO A SER PROCESSADO NA SITUAÃ‡AO DE PONTO BASEADO NO ULTIMO FECHAMENTO IFPONTO CADASTRADO NO ARTERH
TO_DATE('01/01/1940','DD/MM/YYYY')ULTIMA_DATA_INI_FOLHA,
TO_DATE(vDATA_CORTE,'DD/MM/YY') ULTIMA_DATA_FIM_FOLHA,---------------DATA CORTE SANEAMENTO BM
----------------------------------------------------------------FIM-----PARA SABER PERIODO A SER PROCESSADO NA SITUAÃ‡AO DE PONTO BASEADO NO ULTIMO FECHAMENTO IFPONTO CADASTRADO NO ARTERH

ROW_NUMBER() OVER   (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CONTRATO ORDER BY X.DATA_INICIO) AS ORDEM_BM,
X.* 
,C.ANO_MES_REFERENCIA,C.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6, TEG4.DADO_ORIGEM, TEG4.DADO_DESTINO COD_SIT_PONTO_DIFERENCIADA
FROM ----------------------inicio X
(------------------------------------------------INICIO DO UNION
select  'ALT_SIT_FUNC' TIPO, A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO CONTRATO, A.COD_SIT_FUNCIONAL CODIGO, SF.DESCRICAO DESCRICAO, SF.SITUACAO_PONTO COD_SIT_PONTO, SP.DESCRICAO SITUACAO_PONTO, 
A.DATA_INIC_SITUACAO DATA_INICIO, A.DATA_FIM_SITUACAO DATA_FIM
,A.LOGIN_USUARIO, A.DT_ULT_ALTER_USUA
from RHCGED_ALT_SIT_FUN A 
LEFT OUTER JOIN RHPARM_SIT_FUNC SF ON SF.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO SP ON SP.CODIGO = SF.SITUACAO_PONTO
WHERE 
--SF.CONTROLE_FOLHA IN ('L','M')
SF.SITUACAO_PONTO is not null
AND SF.data_fim_vigencia IS NULL


UNION ALL

SELECT  'FERIAS' TIPO, FE.CODIGO_EMPRESA, FE.TIPO_CONTRATO, FE.CODIGO_CONTRATO CONTRATO, PF.CODIGO CODIGO, PF.DESCRICAO DESCRICAO, SP.CODIGO COD_SIT_PONTO, SP.DESCRICAO SITUACAO_PONTO, 
FE.dt_ini_gozo DATA_INICIO, 
CASE
    WHEN FE.STATUS_CONFIRMACAO in ('5','D')
    THEN
      (SELECT MAX(DT.DATA_DIA)
      FROM RHFERI_FERIAS F,
        RHTABS_DATAS DT
      WHERE F.CODIGO_EMPRESA = FE.CODIGO_EMPRESA
      AND F.TIPO_CONTRATO = FE.TIPO_CONTRATO
      AND F.DT_INI_AQUISICAO = FE.DT_INI_AQUISICAO
      AND F.DT_FIM_AQUISICAO = FE.DT_FIM_AQUISICAO
      AND F.CODIGO_CONTRATO = FE.codigo_contrato
      AND DT.DATA_DIA BETWEEN FE.DT_INI_GOZO AND FE.DT_RETORNO-1
      AND F.STATUS_CONFIRMACAO =FE.STATUS_CONFIRMACAO
      AND DT.DATA_DIA NOT          IN
        (SELECT D.DATA_DIA
        FROM RHPARM_CALEND_DT D
        WHERE D.CODIGO  = '0001'
        AND DT.DATA_DIA = D.DATA_DIA))
        else FE.DT_FIM_GOZO
  END

DATA_FIM
,FE.LOGIN_USUARIO, FE.DT_ULT_ALTER_USUA
FROM RHFERI_FERIAS FE
LEFT OUTER JOIN RHPARM_P_FERI PF ON PF.CODIGO_EMPRESA = FE.CODIGO_EMPRESA AND PF.CODIGO = FE.TIPO_FERIAS
LEFT OUTER JOIN RHPONT_SITUACAO SP ON SP.CODIGO = PF.SITUACAO_PONTO
WHERE
fe.STATUS_CONFIRMACAO in ('1','5','D','G')


)X ----------------FIM X
------------------------------------------------FIM DO UNION
----------------------INICIO--novo em 29/11/19 para diferenciar SITUAÃ‡ÃƒO PONTO nas CESSÃ•ES referente a CONTAGEM DE TEMPO
--LEFT OUTER JOIN RHPESS_CONTRATO C ON C.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND C.TIPO_CONTRATO = X.TIPO_CONTRATO AND C.CODIGO = X.CONTRATO
LEFT OUTER JOIN (SELECT C.* FROM RHPESS_CONTRATO C WHERE C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX 
where c.codigo_empresa = AUX.codigo_empresa and c.tipo_contrato = AUX.tipo_contrato and c.codigo = auX.codigo /*and to_date(aux.ano_mes_referencia,'dd/mm/yyyy') <= to_date(x.data_inicio, 'dd/mm/yyyy')*/))
C ON C.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND C.TIPO_CONTRATO = X.TIPO_CONTRATO AND C.CODIGO = X.CONTRATO and to_date(c.ano_mes_referencia,'dd/mm/yyyy') <= to_date(x.data_inicio, 'dd/mm/yyyy')

LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG4')TEG4 ON SUBSTR(TEG4.DADO_ORIGEM,37,40) = X.CODIGO AND SUBSTR(TEG4.DADO_ORIGEM,1,36)= C.COD_CUSTO_GERENC1||C.COD_CUSTO_GERENC2||C.COD_CUSTO_GERENC3||C.COD_CUSTO_GERENC4||C.COD_CUSTO_GERENC5||C.COD_CUSTO_GERENC6

WHERE 
--C.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = C.TIPO_CONTRATO AND AUX.CODIGO = C.CODIGO /*AND TO_DATE(C.ANO_MES_REFERENCIA,'DD/MM/YYYY') <= TO_DATE(X.DATA_INICIO,'DD/MM/YYYY')--*/)AND 
----------------------FIM--novo em 29/11/19 para diferenciar SITUAÃ‡ÃƒO PONTO nas CESSÃ•ES referente a CONTAGEM DE TEMPO


X.COD_SIT_PONTO IS NOT NULL ----------------------------SOMENTE REGISTROS DE FERIAS E SIT FUNC QUE POSSUEM SITUACAO DE PONTO VINCULADP
AND X.DATA_FIM IS NOT NULL   ----------------------------------DATA FIM DESTES LANÃ‡AMENTOS NÃƒO ESTA NULA
and------------------------------------------------------------ PERIODO INICIO E FIM DO AFASTAMENTO/FERIAS DENTRO DO PERIODO QUE DEVE SER CARIMBADO, OU SEJA O ULTIMO REGISTRO CRIADO DE FECHAMENTO
(--inicio do and de datas
x.data_inicio between TO_DATE('01/01/1940','DD/MM/YYYY') AND TO_DATE(vDATA_CORTE,'DD/MM/YY')---------------DATA CORTE SANEAMENTO BM
OR x.data_fim between TO_DATE('01/01/1940','DD/MM/YYYY') AND TO_DATE(vDATA_CORTE,'DD/MM/YY')---------------DATA CORTE SANEAMENTO BM
-------------------------INICIO-----PARTE NOVA EM 20/11/19
OR (trunc(X.DATA_INICIO) <= to_date('01/01/1940','DD/MM/YYYY') AND trunc(X.DATA_FIM)>= to_date(vDATA_CORTE,'dd/mm/yy'))---------------DATA CORTE SANEAMENTO BM
-------------------------FIM-----PARTE NOVA EM 20/11/19
)--fim do and de datas

ORDER BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CONTRATO, X.DATA_INICIO, X.TIPO, x.codigo
)X2
WHERE X2.CODIGO_EMPRESA = vEMPRESA --'0001' --
AND X2.TIPO_CONTRATO =  vTIPO_CONTRATO--'0001'--
and X2.CONTRATO = vBM--'000000000170171'--


)
loop
--/*
FOR C2 IN (
SELECT CC.ANO_MES_REFERENCIA,  Cc.Cod_CUSTO_GERENC1 C2_CUSTO_GERENC1, Cc.Cod_CUSTO_GERENC2 C2_CUSTO_GERENC2, Cc.Cod_CUSTO_GERENC3 C2_CUSTO_GERENC3, Cc.Cod_CUSTO_GERENC4 C2_CUSTO_GERENC4, Cc.Cod_CUSTO_GERENC5 C2_CUSTO_GERENC5, Cc.Cod_CUSTO_GERENC6 C2_CUSTO_GERENC6, TEG4_2.DADO_DESTINO COD_SIT_PONTO_DIFERENCIADA_2
--INTO vANO_MES_REF 
FROM RHPESS_CONTRATO CC 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG4')TEG4_2 ON SUBSTR(TEG4_2.DADO_ORIGEM,37,40) = c1.CODIGO AND SUBSTR(TEG4_2.DADO_ORIGEM,1,36)= Cc.COD_CUSTO_GERENC1||Cc.COD_CUSTO_GERENC2||Cc.COD_CUSTO_GERENC3||Cc.COD_CUSTO_GERENC4||Cc.COD_CUSTO_GERENC5||Cc.COD_CUSTO_GERENC6
WHERE 
Cc.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX 
where cc.codigo_empresa = AUX.codigo_empresa and cc.tipo_contrato = AUX.tipo_contrato and cc.codigo = auX.codigo and to_date(aux.ano_mes_referencia,'dd/mm/yyyy') <= to_date(C1.data_inicio, 'dd/mm/yyyy')
)AND
c1.codigo_empresa = CC.codigo_empresa and c1.tipo_contrato = CC.tipo_contrato and c1.contrato = CC.codigo 
--AND TRUNC(CC.ano_mes_referencia) <= to_date(C1.data_inicio, 'dd/mm/yy')

--;
)
LOOP
--dbms_output.put_line('--'||C2.ANO_MES_REFERENCIA);
--*/


vCONTADOR :=vCONTADOR+1;
dbms_output.put_line( '' );
--dbms_output.put_line( vANO_MES_REF );
dbms_output.put_line('--' ||c2.COD_SIT_PONTO_DIFERENCIADA_2 ||'-'|| C2.ANO_MES_REFERENCIA ||'-'|| c2.C2_CUSTO_GERENC1 ||'-'|| C2.C2_CUSTO_GERENC2 ||'-'|| C2.C2_CUSTO_GERENC3 ||'-'|| C2.C2_CUSTO_GERENC4 ||'-'|| C2.C2_CUSTO_GERENC5 ||'-'|| C2.C2_CUSTO_GERENC6);
dbms_output.put_line('--'||vCONTADOR||'-'|| /*C2.ANO_MES_REFERENCIA|| '-'||*/ C1.ORDEM_BM ||'-'|| C1.TIPO ||'-'|| C1.CODIGO_EMPRESA ||'-'|| C1.TIPO_CONTRATO ||'-'|| C1.CONTRATO ||'-'|| C1.CODIGO ||'-'|| C1.DESCRICAO ||'-'|| C1.DATA_INICIO ||'-'|| C1.DATA_FIM);

--POPULAR VARIAVEIS
data_inicial := to_date(c1.DATA_INICIO_SIT_PONTO,'DD/MM/YYYY');
data_final := to_date(c1.DATA_FIM_SIT_PONTO,'DD/MM/YYYY');
--dbms_output.put_line( '--DATA INICIO ANALISE: ' || to_date(data_inicial,'DD/MM/YYYY'));
--dbms_output.put_line( '--DATA FIM ANALISE: ' || to_date(data_final,'DD/MM/YYYY'));
num_dias := (data_final - data_inicial)+1;
dbms_output.put_line( '--TOTAL DE DIAS: ' || num_dias);


for i in 1..num_dias loop
   vDATA_DIA :=  to_date(to_char((data_inicial-1)+i,'DD/MM/YYYY'),'DD/MM/YYYY');

--dbms_output.put_line('--'||C1.COD_SIT_PONTO ||'-'|| C1.COD_SIT_PONTO_DIFERENCIADA ||'-'|| C2.COD_SIT_PONTO_DIFERENCIADA_2);
--/*
IF C2.COD_SIT_PONTO_DIFERENCIADA_2 IS NULL THEN   
--dbms_output.put_line( '--| DIA: ' || i|| ' DATA: ' || to_char((data_inicial-1)+i,'DD/MM/YYYY')||'|'|| c1.codigo_empresa  ||'|'|| c1.tipo_contrato ||'|'||c1.CONTRATO ||'|'|| vDATA_DIA  ||'|'||C1.COD_SIT_PONTO ||'|'||C1.SITUACAO_PONTO);
--dbms_output.put_line('INSERT INTO RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO) VALUES ('''||C1.CODIGO_EMPRESA ||''','''|| C1.TIPO_CONTRATO ||''','''|| C1.CONTRATO ||''', TO_DATE('''|| vDATA_DIA ||''',''DD/MM/YYYY''),''' || C1.COD_SIT_PONTO ||''', 1, ''F'', SYSDATE, '''|| C1.LOGIN_USUARIO ||'''); COMMIT;' );  
delete RHPONT_RES_SIT_DIA where CODIGO_EMPRESA = C1.CODIGO_EMPRESA and  TIPO_CONTRATO = C1.TIPO_CONTRATO and CODIGO_CONTRATO =  C1.CONTRATO and trunc(DATA) =  TO_DATE(vDATA_DIA,'DD/MM/YYYY')and CODIGO_SITUACAO = C1.COD_SIT_PONTO and TIPO_APURACAO = 'F'; COMMIT;  
INSERT INTO RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO ) VALUES (C1.CODIGO_EMPRESA,C1.TIPO_CONTRATO,C1.CONTRATO, TO_DATE(vDATA_DIA,'DD/MM/YYYY'), C1.COD_SIT_PONTO, 1, 'F', C1.DT_ULT_ALTER_USUA, C1.LOGIN_USUARIO, 'N'); COMMIT;


ELSE
--dbms_output.put_line('INSERT INTO RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO) VALUES ('''||C1.CODIGO_EMPRESA ||''','''|| C1.TIPO_CONTRATO ||''','''|| C1.CONTRATO ||''', TO_DATE('''|| vDATA_DIA ||''',''DD/MM/YYYY''),''' || C2.COD_SIT_PONTO_DIFERENCIADA_2 ||''', 1, ''F'', SYSDATE, '''|| C1.LOGIN_USUARIO ||'''); COMMIT;' );  
delete RHPONT_RES_SIT_DIA where CODIGO_EMPRESA = C1.CODIGO_EMPRESA and  TIPO_CONTRATO = C1.TIPO_CONTRATO and CODIGO_CONTRATO =  C1.CONTRATO and trunc(DATA) =  TO_DATE(vDATA_DIA,'DD/MM/YYYY')and CODIGO_SITUACAO = C2.COD_SIT_PONTO_DIFERENCIADA_2 and TIPO_APURACAO = 'F'; COMMIT;  
INSERT INTO RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO ) VALUES (C1.CODIGO_EMPRESA,C1.TIPO_CONTRATO,C1.CONTRATO, TO_DATE(vDATA_DIA,'DD/MM/YYYY'), C2.COD_SIT_PONTO_DIFERENCIADA_2, 1, 'F', C1.DT_ULT_ALTER_USUA, C1.LOGIN_USUARIO,'N'); COMMIT;


END IF;
--*/
END LOOP; ---FIM LOOP DIAS

END LOOP;---FIM LOOP 2

END LOOP;---FIM LOOP 1

END;


END;-- 1Ã‚Âº BEGIN

