
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_FICHA_MEDICA_AJUSTE_SITFUNC" (ID IN NUMBER) AS 

BEGIN

DECLARE
VCONTADOR NUMBER;
--VLOGIN_USUARIO VARCHAR2(40);
VID NUMBER;

VSIT_FUNC_DEFERIDA VARCHAR2(4); --NOVO EM 7/6/22


BEGIN

DBMS_OUTPUT.ENABLE(NULL);
VCONTADOR :=0;
--VLOGIN_USUARIO :=NULL;
VID := ID;

VSIT_FUNC_DEFERIDA := NULL;  --NOVO EM 7/6/22

------------------------------------------------------1 PARTE APENAS PARA GRAVAR TROCAR SIT FUNCIONAL/ PONTO E EXCLUIR PONTO CASO NECESSARIO E GRAVAR P NO CAMPO PROCESSADO
FOR C1 IN(



SELECT COUNT(1)QUANT, 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 7/6/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 7/6/22
X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, X.DATA_INI_AFAST, X.DATA_FIM_AFAST,
X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OCOR_PROC_MED, X.CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL, X.LOGIN_USUARIO
,X.EMPRESA_ATENDENTE, X.CODIGO_ATENDENTE, X.NOME_ATENDENTE, X.INSCRICAO_CONSELHO, X.UF_INSCRICAO, X.CONSELHO_REGIONAL, X.COD_DOENCA, X.INFO_MESMO_MOTIVO, X.DT_EFEITO_MESMO_MOTIVO
,X.data_aposenta_fgts, X.CODIGO_PESSOA, X.data_aposenta--LINHA NOVA EM 20/7/21 PARA O FOR C5
,X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10 --NOVO EM 7/6/22
FROM (
SELECT 
F.CODIGO_EMPRESA, F.TIPO_CONTRATO, F.CODIGO_CONTRATO, F.DATA_INI_AFAST, F.DATA_FIM_AFAST,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL,  F.LOGIN_USUARIO
,F.EMPRESA_ATENDENTE, F.CODIGO_ATENDENTE, F.NOME_ATENDENTE, F.INSCRICAO_CONSELHO, F.UF_INSCRICAO, F.CONSELHO_REGIONAL, D.COD_DOENCA, F.INFO_MESMO_MOTIVO, F.DT_EFEITO_MESMO_MOTIVO
,A.data_aposenta_fgts, X.CODIGO_PESSOA, P.data_aposenta
,TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10  --NOVO EM 7/6/22
FROM SUGESP_FICHAS_MEDICAS X 
LEFT OUTER JOIN RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN
RHMEDI_RL_FICH_DOE D ON D.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND D.CODIGO_PESSOA = X.CODIGO_PESSOA AND D.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND D.OCORRENCIA = X.OCORRENCIA
AND D.OCOR_DOENCA = 1
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHPESS_PESSOA P ON P.CODIGO_EMPRESA = X.CODIGO_EMPRESA  AND P.CODIGO = X.CODIGO_PESSOA --LINHA NOVA EM 20/7/21 PARA O FOR C5
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ON SUBSTR(TC1.DADO_ORIGEM,1,24) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO --ate 2/7/20
ON SUBSTR(TC1.DADO_ORIGEM,1,23) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --PROCEDIMENTO --novo em 2/7/20

LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 7/6/22

WHERE 

X.ID = VID
--X.TABELA = 'RHMEDI_FICHA_MED' AND X.CODIGO_EMPRESA <> '1700'  AND X.CODIGO_PESSOA = '000000000377868' AND X.PROCESSADO = 'S' 

AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL --NOVO EM 7/6/22

GROUP BY 
X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, X.DATA_INI_AFAST, X.DATA_FIM_AFAST,
X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OCOR_PROC_MED, X.CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL, X.LOGIN_USUARIO
,X.EMPRESA_ATENDENTE, X.CODIGO_ATENDENTE, X.NOME_ATENDENTE, X.INSCRICAO_CONSELHO, X.UF_INSCRICAO, X.CONSELHO_REGIONAL, X.COD_DOENCA, X.INFO_MESMO_MOTIVO, X.DT_EFEITO_MESMO_MOTIVO
,X.data_aposenta_fgts, X.CODIGO_PESSOA, X.data_aposenta--LINHA NOVA EM 20/7/21 PARA O FOR C5
, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10 --NOVO EM 7/6/22

)
LOOP
VCONTADOR :=VCONTADOR+1;
DBMS_OUTPUT.PUT_LINE('--'||VCONTADOR);
DBMS_OUTPUT.PUT_LINE('--'||C1.CODIGO_CONTRATO ||'-'|| C1.CODIGO_EMPRESA ||'-'|| C1.TIPO_CONTRATO ||'-'|| C1.CODIGO_CONTRATO ||'-'|| C1.DATA_INI_AFAST ||'-'|| C1.DATA_FIM_AFAST ||'-'|| C1.DADO_ORIGEM_TC1 ||'-'|| C1.DADO_DESTINO_TC1 ||'-'|| C1.OCOR_PROC_MED ||'-'|| C1.CODIGO_PROC_MED ||'-'|| C1.ANO_MES_REFERENCIA ||'-'|| C1.VINCULO ||'-'|| C1.TP_REGIME_TRAB_ESOCIAL ||'-'|| C1.TP_REGIME_PREV_ESOCIAL ||'-'|| C1.COD_CATEG_ESOCIAL);

--NOVO INICIO -- EM 7/6/22
IF LENGTH(C1.DADO_ORIGEM_FINAL) = 23 THEN
VSIT_FUNC_DEFERIDA := SUBSTR(C1.DADO_DESTINO_FINAL,1,4);--O QUE DIFERE
ELSIF LENGTH(C1.DADO_ORIGEM_FINAL) = 27 THEN
VSIT_FUNC_DEFERIDA := SUBSTR(C1.DADO_DESTINO_FINAL,5,4);--O QUE DIFERE
END IF;
--NOVO FIM -- EM 7/6/22


---------------------------------------------------------INICIO-----------------TROCAR AS SITUACOES QUE PODEM SER SUBSTITUIDAS PELA DA FICHA MEDICA
FOR C2 IN(
SELECT 
T.CODIGO_EMPRESA, T.TIPO_CONTRATO, T.CODIGO, T.COD_SIT_FUNC, T.SITUACAO_FUNCIONAL, T.COD_SIT_PONTO, T.SITUACAO_PONTO,  T.DATA_INICIO, T.DATA_FIM--, T.LOGIN_USUARIO, A.DT_ULT_ALTER_USUA
,T.CONTROLE_FOLHA, T.SUSPENDE_REMUNERA, T.E_AFASTAMENTO
 FROM (
SELECT   A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO,
A.COD_SIT_FUNCIONAL COD_SIT_FUNC, S.DESCRICAO SITUACAO_FUNCIONAL, S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO,  A.DATA_INIC_SITUACAO DATA_INICIO, A.DATA_FIM_SITUACAO DATA_FIM--, A.LOGIN_USUARIO, A.DT_ULT_ALTER_USUA
,S.CONTROLE_FOLHA, S.SUSPENDE_REMUNERA, S.E_AFASTAMENTO
FROM RHCGED_ALT_SIT_FUN A 
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA  
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO 
AND A.CODIGO = C1.CODIGO_CONTRATO
/*
AND A.COD_SIT_FUNCIONAL IN ('1220','1221'
--,'1019','1030','1005', '1007', '1232','1223', '1231', '1222', '1027'
)
*/
--AND S.CODIGO_RAIS = '9998'-- COMENTADO EM 18/12/19
AND S.C_LIVRE_SELEC02 = '2' --NOVO EM 18/12/19

AND 
((TRUNC(A.DATA_INIC_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST)) 
OR (TRUNC(A.DATA_FIM_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST))
OR (TRUNC(A.DATA_INIC_SITUACAO) <= TRUNC(C1.DATA_INI_AFAST) AND TRUNC(A.DATA_FIM_SITUACAO) >= TRUNC(C1.DATA_FIM_AFAST)) )
)T
GROUP BY 
T.CODIGO_EMPRESA, T.TIPO_CONTRATO, T.CODIGO, T.COD_SIT_FUNC, T.SITUACAO_FUNCIONAL, T.COD_SIT_PONTO, T.SITUACAO_PONTO,  T.DATA_INICIO, T.DATA_FIM--, T.LOGIN_USUARIO, A.DT_ULT_ALTER_USUA
,T.CONTROLE_FOLHA, T.SUSPENDE_REMUNERA, T.E_AFASTAMENTO
ORDER BY T.DATA_INICIO 

)
LOOP
DBMS_OUTPUT.PUT_LINE('--'||C2.COD_SIT_FUNC ||'-'|| C2.SITUACAO_FUNCIONAL||'-'|| C2.COD_SIT_PONTO||'-'|| C2.SITUACAO_PONTO||'-'|| C2.DATA_INICIO||'-'|| C2.DATA_FIM );

--INICIO--IF PARA O QUE FAZER
IF C1.DATA_INI_AFAST <= C2.DATA_INICIO AND C1.DATA_FIM_AFAST >= C2.DATA_FIM THEN
DBMS_OUTPUT.PUT_LINE('1-FICHA ABRANGE TODA SITUCAO FUNCIONAL LANCaDA');
DBMS_OUTPUT.PUT_LINE('1-ENTAO TROCA A SIT FUNC LANCADA PELA A DA FICHA MEDICA');
UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4), 
LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE  
,EMPRESA_ATENDENTE = C1.EMPRESA_ATENDENTE, CODIGO_ATENDENTE = C1.CODIGO_ATENDENTE, NOME_ATENDENTE = C1.NOME_ATENDENTE, INSCRICAO_CONSELHO = C1.INSCRICAO_CONSELHO, UF_CONSELHO = C1.UF_INSCRICAO, CONSELHO_REGIONAL = C1.CONSELHO_REGIONAL, CODIGO_DOENCA = C1.COD_DOENCA, INFO_MESMO_MOTIVO = C1.INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO = C1.DT_EFEITO_MESMO_MOTIVO
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INICIO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

ELSIF C1.DATA_INI_AFAST <= C2.DATA_INICIO AND C1.DATA_FIM_AFAST < C2.DATA_FIM THEN
DBMS_OUTPUT.PUT_LINE('2-FICHA COMECA ANTES OU NO DIA QUE COMECA SIT FUNC E ACABA ANTES QUE SIT FUNC');
DBMS_OUTPUT.PUT_LINE('2-ENTAO 1: DIMINUI DATA FIM DA SIT FUNC LANCADA PARA A DATA FIM DA FICHA E TROCA O CODIGO PELA A DA FICHA MEDICA');
UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
DATA_FIM_SITUACAO = TRUNC(C1.DATA_FIM_AFAST), LOGIN_USUARIO = C1.LOGIN_USUARIO, DT_ULT_ALTER_USUA = SYSDATE 
,EMPRESA_ATENDENTE = C1.EMPRESA_ATENDENTE, CODIGO_ATENDENTE = C1.CODIGO_ATENDENTE, NOME_ATENDENTE = C1.NOME_ATENDENTE, INSCRICAO_CONSELHO = C1.INSCRICAO_CONSELHO, UF_CONSELHO = C1.UF_INSCRICAO, CONSELHO_REGIONAL = C1.CONSELHO_REGIONAL, CODIGO_DOENCA = C1.COD_DOENCA, INFO_MESMO_MOTIVO = C1.INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO = C1.DT_EFEITO_MESMO_MOTIVO
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INICIO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');
DBMS_OUTPUT.PUT_LINE('2-ENTAO 2: CRIA REGISTRO DA SIT FUNC LANCADA COM DATA INICIO = DATA FIM FICHA +1 E DATA FIM QUE ESTAVA LANCADA');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND  TIPO_CONTRATO = C1.TIPO_CONTRATO AND  CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.DATA_FIM_AFAST)+1 AND COD_SIT_FUNCIONAL = C2.COD_SIT_FUNC; COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL,CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA)VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.DATA_FIM_AFAST)+1, TRUNC(C2.DATA_FIM), C2.COD_SIT_FUNC, C1.LOGIN_USUARIO, SYSDATE);COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

ELSIF C1.DATA_INI_AFAST > C2.DATA_INICIO AND C1.DATA_FIM_AFAST < C2.DATA_FIM THEN
DBMS_OUTPUT.PUT_LINE('3-FICHA COMECA DEPOIS QUE COMECA SIT FUNC E ACABA ANTES QUE SIT FUNC');
DBMS_OUTPUT.PUT_LINE('3-ENTAO 1: DIMINUI DATA FIM DA SIT FUNC LANCADA PARA A DATA INICIO -1D DA FICHA');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = TRUNC(C1.DATA_INI_AFAST)-1, LOGIN_USUARIO = C1.LOGIN_USUARIO, DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INICIO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');
DBMS_OUTPUT.PUT_LINE('3-ENTAO 2: CRIA REGISTRO DA FICHA PERIODO TODO');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO  AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.DATA_INI_AFAST) AND COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
;COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA
,EMPRESA_ATENDENTE, CODIGO_ATENDENTE, NOME_ATENDENTE, INSCRICAO_CONSELHO, UF_CONSELHO, CONSELHO_REGIONAL, CODIGO_DOENCA, INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO ) 
VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.DATA_INI_AFAST), TRUNC(C1.DATA_FIM_AFAST), SUBSTR(C1.DADO_DESTINO_TC1,1,4), C1.LOGIN_USUARIO, SYSDATE
,C1.EMPRESA_ATENDENTE, C1.CODIGO_ATENDENTE, C1.NOME_ATENDENTE, C1.INSCRICAO_CONSELHO, C1.UF_INSCRICAO, C1.CONSELHO_REGIONAL, C1.COD_DOENCA, C1.INFO_MESMO_MOTIVO, C1.DT_EFEITO_MESMO_MOTIVO);COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');
DBMS_OUTPUT.PUT_LINE('3-ENTAO 3: CRIA REGISTRO DA SIT FUNC LANCADA COM DATA INICIO = DATA FIM FICHA +1 E DATA FIM QUE ESTAVA LANCADA');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO  AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.DATA_FIM_AFAST)+1 AND COD_SIT_FUNCIONAL = C2.COD_SIT_FUNC; COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA)VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.DATA_FIM_AFAST)+1, TRUNC(C2.DATA_FIM), C2.COD_SIT_FUNC, C1.LOGIN_USUARIO, SYSDATE);COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

ELSIF C1.DATA_INI_AFAST > C2.DATA_INICIO AND C1.DATA_FIM_AFAST >= C2.DATA_FIM THEN
DBMS_OUTPUT.PUT_LINE('4-FICHA COMECA DEPOIS QUE COMECA SIT FUNC E ACABA NO DIA OU DEPOIS QUE ACABA SIT FUNC');
DBMS_OUTPUT.PUT_LINE('4-ENTAO 1: DIMINUI DATA FIM DA SIT FUNC LANCADA PARA A DATA INICIO -1D DA FICHA');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = TRUNC(C1.DATA_INI_AFAST)-1, LOGIN_USUARIO = C1.LOGIN_USUARIO, DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INICIO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');
DBMS_OUTPUT.PUT_LINE('4-ENTAO 2: CRIA REGISTRO DA FICHA PERIODO TODO OU A PARTE QUE FALTA PEGAR DATA_FIM QUE ESTAVA LANCADA');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO  AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.DATA_INI_AFAST) AND COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
;COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA
,EMPRESA_ATENDENTE, CODIGO_ATENDENTE, NOME_ATENDENTE, INSCRICAO_CONSELHO, UF_CONSELHO, CONSELHO_REGIONAL, CODIGO_DOENCA , INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO)
VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.DATA_INI_AFAST), TRUNC(C2.DATA_FIM),  VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
C1.LOGIN_USUARIO, SYSDATE
,C1.EMPRESA_ATENDENTE, C1.CODIGO_ATENDENTE, C1.NOME_ATENDENTE, C1.INSCRICAO_CONSELHO, C1.UF_INSCRICAO, C1.CONSELHO_REGIONAL, C1.COD_DOENCA, C1.INFO_MESMO_MOTIVO, C1.DT_EFEITO_MESMO_MOTIVO);COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

--INICIO -- NOVO EM 29/10/20 PARA OS AJUSTES DE DATAS NA FICHA MEDICA
ELSIF C1.DATA_INI_AFAST < C2.DATA_INICIO AND C1.DATA_FIM_AFAST >= C2.DATA_INICIO AND C2.DATA_FIM IS NULL 
AND C2.CONTROLE_FOLHA = 'N' AND C2.SUSPENDE_REMUNERA  = 'N' AND C2.E_AFASTAMENTO  = 'N' THEN
DBMS_OUTPUT.PUT_LINE('5-FICHA COMECA ANTES DA SIT FUNC ATIVA ACABA DEPOIS QUE COMECA ESSA SIT FUNC ATIVA');

IF TRUNC(C1.DATA_FIM_AFAST) >= TRUNC(SYSDATE)THEN
DBMS_OUTPUT.PUT_LINE('5-ENTAO 1.1: TROCA A SIT FUNC LANCADA PELA A DA FICHA MEDICA COLOCANDO DATA FIM NELA com PROXIMA SITUACAO PREENCHIDA');
UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
DATA_FIM_SITUACAO = TRUNC(C1.DATA_FIM_AFAST), PROXIMA_SITUACAO = C2.COD_SIT_FUNC, LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE 
,EMPRESA_ATENDENTE = C1.EMPRESA_ATENDENTE, CODIGO_ATENDENTE = C1.CODIGO_ATENDENTE, NOME_ATENDENTE = C1.NOME_ATENDENTE, INSCRICAO_CONSELHO = C1.INSCRICAO_CONSELHO, UF_CONSELHO = C1.UF_INSCRICAO, CONSELHO_REGIONAL = C1.CONSELHO_REGIONAL, CODIGO_DOENCA = C1.COD_DOENCA, INFO_MESMO_MOTIVO = C1.INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO = C1.DT_EFEITO_MESMO_MOTIVO
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INICIO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

ELSIF TRUNC(C1.DATA_FIM_AFAST) < TRUNC(SYSDATE)THEN
DBMS_OUTPUT.PUT_LINE('5-ENTAO 1.2: TROCA A SIT FUNC LANCADA PELA A DA FICHA MEDICA COLOCANDO DATA FIM NELA sem PROXIMA SITUACAO PREENCHIDA');
UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
DATA_FIM_SITUACAO = TRUNC(C1.DATA_FIM_AFAST), LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE 
,EMPRESA_ATENDENTE = C1.EMPRESA_ATENDENTE, CODIGO_ATENDENTE = C1.CODIGO_ATENDENTE, NOME_ATENDENTE = C1.NOME_ATENDENTE, INSCRICAO_CONSELHO = C1.INSCRICAO_CONSELHO, UF_CONSELHO = C1.UF_INSCRICAO, CONSELHO_REGIONAL = C1.CONSELHO_REGIONAL, CODIGO_DOENCA = C1.COD_DOENCA, INFO_MESMO_MOTIVO = C1.INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO = C1.DT_EFEITO_MESMO_MOTIVO
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INICIO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

DBMS_OUTPUT.PUT_LINE('5-ENTAO 2: CRIA REGISTRO APOS O FIM DA FICHA PARA VOLTAR A SITUACAO FUNCIONAL QUE ESTAVA ATIVA ANTES DA FICHA');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO  AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.DATA_FIM_AFAST)+1 AND COD_SIT_FUNCIONAL = C2.COD_SIT_FUNC ;COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA)VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.DATA_FIM_AFAST)+1, C2.COD_SIT_FUNC, C1.LOGIN_USUARIO, SYSDATE);COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');
END IF;
--FIM -- NOVO EM 29/10/20 PARA OS AJUSTES DE DATAS NA FICHA MEDICA


END IF;
--FIM--IF PARA O QUE FAZER

END LOOP; ---FIM C2
---------------------------------------------------------FIM----------------TROCAR AS SITUAÃƒÂ€¡OES QUE PODEM SER SUBSTITUIDAS PELA DA FICHA MEDICA

----------------------------------------------------INICIO-------------------------C3-CRIAR PRIMEIRA PARTE DA FICHA COM A SIT FUNC DA FICHA
FOR C3 IN (
SELECT S.* FROM (
SELECT 
K.* FROM (
SELECT 
TRUNC(Q.DATA_INICIO_COMPARAR) - TRUNC(Q.DATA_FIM_COMPARAR)-1 AS LACUNAS 
,Q.* 
FROM(
SELECT 
T.* 
,CASE 
WHEN T.ORDEM_BM = 1 THEN TO_DATE(TO_CHAR(SYSDATE,'DD/MM/YYYY'),'DD/MM/YYYY')+1 
ELSE TO_DATE(TO_CHAR(T.PROXIMA_DATA_INICIO,'DD/MM/YYYY'),'DD/MM/YYYY') END DATA_INICIO_COMPARAR
,CASE 
WHEN T.CONTROLE_FOLHA NOT IN ('L','M') AND T.DATA_FIM IS NULL AND T.ORDEM_BM = 1 THEN TO_DATE(TO_CHAR(SYSDATE,'DD/MM/YYYY'),'DD/MM/YYYY')
WHEN T.CONTROLE_FOLHA NOT IN ('L','M') AND T.DATA_FIM IS NULL AND T.ORDEM_BM <> 1 THEN TO_DATE(TO_CHAR(T.DATA_INICIO,'DD/MM/YYYY'),'DD/MM/YYYY') 
ELSE TO_DATE(TO_CHAR(T.DATA_FIM,'DD/MM/YYYY'),'DD/MM/YYYY') END DATA_FIM_COMPARAR
FROM (
SELECT 
ROW_NUMBER() OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC) AS ORDEM_BM,
A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO, A.COD_SIT_FUNCIONAL, S.CONTROLE_FOLHA, CASE WHEN S.C_LIVRE_SELEC02 = 1 THEN 'NAO' ELSE 'SIM' END GERA_SIT_FUNC, TO_DATE(TO_CHAR(A.DATA_INIC_SITUACAO,'DD/MM/YYYY'),'DD/MM/YYYY') DATA_INICIO, TO_DATE(TO_CHAR(A.DATA_FIM_SITUACAO,'DD/MM/YYYY'),'DD/MM/YYYY') DATA_FIM--, A.PROXIMA_SITUACAO 
,LEAD(A.COD_SIT_FUNCIONAL, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO ) AS PROXIMA_COD_SIT_FUNCIONAL
,LEAD(S.CONTROLE_FOLHA, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO ) AS PROXIMO_CONTROLE_FOLHA
,LEAD(CASE WHEN S.C_LIVRE_SELEC02 = 1 THEN 'NAO' ELSE 'SIM' END, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO ) AS PROXIMO_GERA_SIT_FUNC
,LEAD(TO_DATE(TO_CHAR(A.DATA_INIC_SITUACAO,'DD/MM/YYYY'),'DD/MM/YYYY'), 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO  ORDER BY A.DATA_INIC_SITUACAO) AS PROXIMA_DATA_INICIO
,LEAD(TO_DATE(TO_CHAR(A.DATA_FIM_SITUACAO,'DD/MM/YYYY'),'DD/MM/YYYY'), 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO  ORDER BY A.DATA_INIC_SITUACAO ) AS PROXIMA_DATA_FIM
FROM RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
WHERE 
A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA--'0001'
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO-- '0001'
AND A.CODIGO = C1.CODIGO_CONTRATO-- '000000000883291'
)T
)Q
)K
LEFT OUTER JOIN RHPESS_CONTRATO C ON C.CODIGO_EMPRESA = K.CODIGO_EMPRESA AND C.TIPO_CONTRATO = K.TIPO_CONTRATO AND C.CODIGO = K.CODIGO
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = C.VINCULO
LEFT OUTER JOIN (SELECT * FROM RHTABS_ITDS_SIST WHERE CODIGO_DOMINIO IN (SELECT CODIGO_DOMINIO FROM RHTABS_COLS_SIST  WHERE CODIGO_TABELA = 'RHTABS_VINCULO_EMP' AND CODIGO_COLUNA = 'TP_REGIME_TRAB_ESOCIAL'))RG_TRAB
ON RG_TRAB.CONTEUDO_INICIAL = V.TP_REGIME_TRAB_ESOCIAL
LEFT OUTER JOIN (SELECT * FROM RHTABS_ITDS_SIST WHERE CODIGO_DOMINIO IN (SELECT CODIGO_DOMINIO FROM RHTABS_COLS_SIST  WHERE CODIGO_TABELA = 'RHTABS_VINCULO_EMP' AND CODIGO_COLUNA = 'TP_REGIME_PREV_ESOCIAL'))RG_PREV
ON RG_PREV.CONTEUDO_INICIAL = V.TP_REGIME_PREV_ESOCIAL
LEFT OUTER JOIN (SELECT * FROM RHTABS_ITDS_SIST WHERE CODIGO_DOMINIO IN (SELECT CODIGO_DOMINIO FROM RHTABS_COLS_SIST  WHERE CODIGO_TABELA = 'RHTABS_VINCULO_EMP' AND CODIGO_COLUNA = 'COD_CATEG_ESOCIAL'))COD_CATEG
ON COD_CATEG.CONTEUDO_INICIAL = V.COD_CATEG_ESOCIAL
WHERE K.LACUNAS <> 0
AND C.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA)FROM RHPESS_CONTRATO AUX WHERE C.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND C.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND C.CODIGO = AUX.CODIGO)
AND C.CODIGO_EMPRESA = C1.CODIGO_EMPRESA--'0001'
AND C.TIPO_CONTRATO = C1.TIPO_CONTRATO--'0001'
AND C.CODIGO = C1.CODIGO_CONTRATO--'000000000883291'
)S
WHERE
--(TRUNC(S.DATA_INICIO) BETWEEN TO_DATE('01/08/2019')AND TO_DATE('10/08/2019'))--0
--OR(TRUNC(S.DATA_FIM) BETWEEN TO_DATE('01/08/2019')AND TO_DATE('10/08/2019'))--0
--OR
(TRUNC(S.PROXIMA_DATA_INICIO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST))--1
--OR(TRUNC(S.PROXIMA_DATA_FIM) BETWEEN TO_DATE('01/08/2019')AND TO_DATE('10/08/2019'))--0

)

LOOP
DBMS_OUTPUT.PUT_LINE('C3-CRIAR PRIMEIRA PARTE DA FICHA COM A SIT FUNC DA FICHA');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C3.DATA_FIM)+1 
AND COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
;COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA
,EMPRESA_ATENDENTE, CODIGO_ATENDENTE, NOME_ATENDENTE, INSCRICAO_CONSELHO, UF_CONSELHO, CONSELHO_REGIONAL, CODIGO_DOENCA, INFO_MESMO_MOTIVO,DT_EFEITO_MESMO_MOTIVO )
VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C3.DATA_FIM)+1, TRUNC(C3.PROXIMA_DATA_INICIO)-1,  VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
C1.LOGIN_USUARIO, SYSDATE
,C1.EMPRESA_ATENDENTE, C1.CODIGO_ATENDENTE, C1.NOME_ATENDENTE, C1.INSCRICAO_CONSELHO, C1.UF_INSCRICAO, C1.CONSELHO_REGIONAL, C1.COD_DOENCA, C1.INFO_MESMO_MOTIVO, C1.DT_EFEITO_MESMO_MOTIVO
);COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

END LOOP; ---FIM C3
----------------------------------------------------FIM-------------------------C3-CRIAR PRIMEIRA PARTE DA FICHA COM A SIT FUNC DA FICHA

----------------------------------------------------INICIO-----------------------------PARA PREENCHER COM O CODIGO DA SIT FUNC DA FICHA OS PERIODOS DA FICHA AINDA QUE ESTAO COM SIT FUNC  S.CONTROLE_FOLHA = 'N' AND S.E_AFASTAMENTO = 'N' AND S.SUSPENDE_REMUNERA = 'N'
FOR C4 IN (
SELECT A.* FROM RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
WHERE 
A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA--'0001' 
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO-- '0001'
AND A.CODIGO = C1.CODIGO_CONTRATO--'000000000883291'

AND S.CONTROLE_FOLHA = 'N' AND S.E_AFASTAMENTO = 'N' AND S.SUSPENDE_REMUNERA = 'N'

AND 
(TRUNC(A.DATA_INIC_SITUACAO) 
BETWEEN TRUNC(C1.DATA_INI_AFAST) --TO_DATE('01/08/19','DD/MM/YY')
AND TRUNC(C1.DATA_FIM_AFAST)--TO_DATE('10/08/19','DD/MM/YY')
)

AND 
(TRUNC(A.DATA_FIM_SITUACAO) 
BETWEEN TRUNC(C1.DATA_INI_AFAST) --TO_DATE('01/08/19','DD/MM/YY')
AND TRUNC(C1.DATA_FIM_AFAST)--TO_DATE('10/08/19','DD/MM/YY')
)
)

LOOP
DBMS_OUTPUT.PUT_LINE('C4-PARA PREENCHER COM O CODIGO DA SIT FUNC DA FICHA OS PERIODOS DA FICHA AINDA QUE ESTAO COM SIT FUNC  S.CONTROLE_FOLHA = N AND S.E_AFASTAMENTO = N AND S.SUSPENDE_REMUNERA = N');
UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL =  VSIT_FUNC_DEFERIDA, -- NOVO EM 7/6/22 --SUBSTR(C1.DADO_DESTINO_TC1,1,4)
LOGIN_USUARIO = C1.LOGIN_USUARIO, DT_ULT_ALTER_USUA = SYSDATE 
,EMPRESA_ATENDENTE = C1.EMPRESA_ATENDENTE, CODIGO_ATENDENTE = C1.CODIGO_ATENDENTE, NOME_ATENDENTE = C1.NOME_ATENDENTE, INSCRICAO_CONSELHO = C1.INSCRICAO_CONSELHO, UF_CONSELHO = C1.UF_INSCRICAO, CONSELHO_REGIONAL = C1.CONSELHO_REGIONAL, CODIGO_DOENCA = C1.COD_DOENCA, INFO_MESMO_MOTIVO = C1.INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO = C1.DT_EFEITO_MESMO_MOTIVO
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C4.DATA_INIC_SITUACAO) AND TRUNC(DATA_FIM_SITUACAO) = TRUNC(C4.DATA_FIM_SITUACAO);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');
END LOOP; --FIM C4
----------------------------------------------------FIM----------------------------PARA PREENCHER COM O CODIGO DA SIT FUNC DA FICHA OS PERIODOS DA FICHA AINDA QUE ESTÃƒÆ’O COM SIT FUNC  S.CONTROLE_FOLHA = 'N' AND S.E_AFASTAMENTO = 'N' AND S.SUSPENDE_REMUNERA = 'N'


---INICIO-NOVO EM 20/07/21-----------PARTE 5-----------------------------------------------------------PARA TROCAR O CODIGO DA SIT FUNC DE AFASTAMENTO DE PESSOAS APOSENTADAS ONDE FICHA MEDICA TEVE CONDUTA 38 MAIOR QUE 15 AFASTADOS
--EM 20/7/21 MESMO NAO CHEGOU A SER USADA POIS O LOCAL CERTO QUE HA AJUSTES PARA A CONDUTA 38 ESTA NA PROCEDURE PR_FICHA_MEDICA_AJUSTE_FICHAS
/*
FOR C5 IN 
()
LOOP
END LOOP;
*/
/*
IF C1.CODIGO_PROC_MED = '000000000000038' AND (C1.DATA_APOSENTA_FGTS IS NOT NULL OR C1.DATA_APOSENTA IS NOT NULL) THEN

UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = '6121'
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO 
AND COD_SIT_FUNCIONAL = SUBSTR(C1.DADO_DESTINO_TC1,1,4) AND TRUNC(DATA_INIC_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_6121');
DBMS_OUTPUT.PUT_LINE('2-ENTAO 2: CRIA REGISTRO DA SIT FUNC LANCADA COM DATA INICIO = DATA FIM FICHA +1 E DATA FIM QUE ESTAVA LANCADA');

SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

DBMS_OUTPUT.PUT_LINE('PARTE 5-ATUALIZA SIT FUNC DE ENCAMINHAMENTO PARA O INSS PARA  6121-LICENÇA MÉDICA P/ APOSENTADO PELO INSS');

END IF; --PARTE 5
*/
--FIM-NOVO EM 20/07/21----------PARTE 5-------------------------------------------------------------PARA TROCAR O CODIGO DA SIT FUNC DE AFASTAMENTO DE PESSOAS APOSENTADAS ONDE FICHA MEDICA TEVE CONDUTA 38 MAIOR QUE 15 AFASTADOS


END LOOP; --FIM C1


--EM 3/11/20 - AJUSTAR DOENCAS GRAVES
--dbms_output.put_line('chama procedure PR_FICHA_MEDICA_AJUSTE_DOENCAS da PR_FICHA_MEDICA_AJUSTE_SITFUNC com VID = '||VID );
--PR_FICHA_MEDICA_AJUSTE_DOENCAS(VID);
--EM 3/11/20 - AJUSTAR DOENCAS GRAVES

--EM 9/12/20 - AJUSTAR DE FERIAS CONCOMITAR COM AFASTAMENTO
dbms_output.put_line('chama procedure PR_FICHA_MEDICA_AJUSTE_FERIAS da PR_FICHA_MEDICA_AJUSTE_SITFUNC com VID = '||VID );
PR_FICHA_MEDICA_AJUSTE_FERIAS(VID);
--EM 9/12/20 - AJUSTAR DE FERIAS CONCOMITAR COM AFASTAMENTO


END;




END;