
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_GERA_TOTALIZADORA_BANCO_HORAS" (pCOD_FECHAMENTO IN NUMBER, pCOD_EMPRESA IN VARCHAR2, pCOD_TABELA_CONVERSAO IN VARCHAR2)
-- *****************************************************************************
-- Descricao.....: PROCEDURE RESPONSÁVEL PELA GRAVAÇÃO DOS REGISTROS DE BANCO DE 
--                 HORAS INTEGRADOS ENTRE O SISTEMA IFPONTO E TABELA DE APOIO
--                 "PONTO_ELETRONICO.IFPONTO_BANCO_HORAS" 

-- Autor................: MARCELO SOARES
-- Última alteração.....: 25/28/2023
-- Compilada em PRODUÇÃO: SIM

-- Observação....: PROCEDURE PARA SER EXECUTADA DE DENTRO DO ARTERH NÃO PRECISA TER COMMIT

-- Parametros....: INFORMAR O CÓDIGO DE FECHAMENTO CRIADO NO SISTEMA IFPONTO
-- Funcionamento.: EXECUÇÃO MANUAL
-- Periodicidade.: CONFORME A NECESSIDADE DO RH DA EMPRESA

--  PASSOS DE EXECUÇÃO PARA INTEGRAÇÃO DA PRODABEL:

--	1) CRIAR O FECHAMENTO DO ESPELHO NO SISTEMA
--	2) ENTRAR NO SISTEMA POWER CENTER E EXECUTAR O WORKFLOW:
--		2.1) INTEGRAÇÃO DO ESPELHO
--		2.1) INTEGRAÇÃO DE BANCO DE HORAS
--	3) ENTRAR  NO SISTEMA ARTERH NA OPÇÃO COMANDO SQL  E EXECUTAR OS SQL´S:
--		3.1) GERAR TOTALIZADORA DE ESPELHO
--		3.2) GERAR TOTALIZADORA DE BANCO DE HORAS
--		3.3) GRAVAR REGISTROS NA PLANILHA SITUAÇÃO PONTO
-- 	4) SE EXISTIR A NECESSIDADE DE REPROCESSAMENTO DA INTEGRAÇÃO 
-- 		4.1) EXECUTAR O SQL QUE APAGARÁ TODOS OS REGISTROS CRIADOS NA PLANILHA SITUAÇÃO PONTO E NAS TABELAS DE APOIO

-- *****************************************************************************
IS
    vDATA_SAIU_IFPONTO DATE;
BEGIN
	-- BUSCA DATA DO PROCESSAMENTO DO IFPONTO NO ESPELHO
     SELECT DISTINCT NVL(TRUNC(DATA_PROCESSAMENTO),TRUNC(SYSDATE)) INTO vDATA_SAIU_IFPONTO
     FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA 
     WHERE COD_PONTO_FECHAMENTO = pCOD_FECHAMENTO
     AND COD_EMPRESA = pCOD_EMPRESA;


    FOR SP IN ( SELECT DISTINCT TRIM(DADO_ORIGEM) AS DADO_ORIGEM, TRIM(DADO_DESTINO) AS DADO_DESTINO
				FROM ARTERH.RHINTE_ED_IT_CONV 
				WHERE CODIGO_CONVERSAO = pCOD_TABELA_CONVERSAO
				AND TRIM(DADO_ORIGEM) = 'BANCO_HORAS'
				ORDER BY DADO_ORIGEM
			  )
	LOOP
        IF SP.DADO_ORIGEM = 'BANCO_HORAS' THEN
			-- BUSCA DA COLUNA VALOR
			INSERT INTO PONTO_ELETRONICO.IFPONTO_ESPELHO_TOTALIZADORES
			(CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, SITUACAO, VALOR, DATA_SAIU_IFPONTO) 

            SELECT BHE.COD_EMPRESA,CNT.TIPO_CONTRATO,BHE.MATRICULA,TRUNC(BHE.DATA),SP.DADO_DESTINO,
                   BHE.VALOR,TRUNC(vDATA_SAIU_IFPONTO)
            FROM PONTO_ELETRONICO.IFPONTO_BANCO_HORAS BHE 
                 INNER JOIN ARTERH.RHPESS_CONTRATO CNT ON CNT.CODIGO = BHE.MATRICULA 
                                                      AND CNT.ANO_MES_REFERENCIA = ( SELECT MAX (CNT2.ANO_MES_REFERENCIA)
                                                                                     FROM ARTERH.RHPESS_CONTRATO CNT2
                                                                                     WHERE CNT2.CODIGO = CNT.CODIGO											  
                                                                                     AND TRUNC(CNT2.ANO_MES_REFERENCIA) <= (SELECT DT_MAX_DATAS FROM ARTERH.RHPARM_P_SIST)
                                                                                     AND CNT2.TIPO_CONTRATO = CNT.TIPO_CONTRATO
                                                                                     AND CNT2.CODIGO_EMPRESA = CNT.CODIGO_EMPRESA)
                                                      AND CNT.CODIGO_EMPRESA = BHE.COD_EMPRESA
                                                      AND CNT.DATA_RESCISAO IS NULL
            WHERE BHE.COD_EMPRESA = pCOD_EMPRESA
            AND BHE.COD_PONTO_FECHAMENTO = pCOD_FECHAMENTO
            AND BHE.VALOR > 0
            AND BHE.DATA_PROCESSAMENTO IS NULL;          

            COMMIT;

            -- PREENCHE A DATA_PROCESSAMENTO DA TABELA IFPONTO_BANCO_HORAS
            UPDATE PONTO_ELETRONICO.IFPONTO_BANCO_HORAS BH SET BH.DATA_PROCESSAMENTO = TO_DATE(SYSDATE,'DD/MM/YYYY')
            WHERE BH.COD_EMPRESA = pCOD_EMPRESA
            AND BH.COD_PONTO_FECHAMENTO = pCOD_FECHAMENTO
            AND BH.DATA_PROCESSAMENTO IS NULL
            AND BH.MATRICULA IN (SELECT DISTINCT ET.CODIGO_CONTRATO FROM  PONTO_ELETRONICO.IFPONTO_ESPELHO_TOTALIZADORES ET
                                 WHERE ET.CODIGO_EMPRESA = BH.COD_EMPRESA
                                 AND SITUACAO = SP.DADO_DESTINO
                                 AND ET.CODIGO_CONTRATO = BH.MATRICULA
                                 AND ET.DATA = BH.DATA);

            COMMIT;
		END IF;
    END LOOP;    
END PR_GERA_TOTALIZADORA_BANCO_HORAS;
