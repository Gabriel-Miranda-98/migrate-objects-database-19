
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_ATUALIZA_DADOS_DESIG" (
    p_DATA_INI IN DATE,
    p_DATA_FIM IN DATE
) AS 
BEGIN

/*
QUANDO: DEVE SER RODADA TODO DIA 
ORIENTAÇÃO: PARA AS DESIGNAÇÕES EM QUE OS UPDATES ABAIXO RODAR A TRIGGER TR_DESIG_SUBST IRÁ REALIZAR AS DEVIDAS ATUALIZAÇÕES NECESSÁRIAS
*/

-------------------------------------------------- ATUALIZA DADOS PARA DESIGNAÇÕES INICIADAS HOJE----------------------------------------------------------------------------------


FOR C1 IN (
    SELECT MAX(A.ID_SOL_DES_FUNC) AS ID_SOL_DES_FUNC,A.CODIGO_CONTRATO,A.TIPO_CONTRATO,A.CODIGO_EMPRESA,A.OCORRENCIA,A.DATA_INICIO_DESVIO,A.DATA_FIM_DESVIO, MAX(D.ID) AS ID
    FROM RHPLCS_DESVIO_FUNC A, SMARH_INT_DESIGNACAO D
    WHERE A.DATA_INICIO_DESVIO = p_DATA_INI
    AND A.DATA_CANCELAMENTO IS NULL
    AND A.CODIGO_CONTRATO = D.CODIGO_CONTRATO 
    AND A.CODIGO_EMPRESA = D.CODIGO_EMPRESA 
    AND A.TIPO_CONTRATO = D.TIPO_CONTRATO 
    and A.DATA_INICIO_DESVIO = d.DATA_INICIO_DESVIO
    and A.DATA_FIM_DESVIO = d.DATA_FIM_DESVIO
    group by A.ID_SOL_DES_FUNC, A.CODIGO_CONTRATO, A.TIPO_CONTRATO, A.CODIGO_EMPRESA, A.OCORRENCIA, 
    A.DATA_INICIO_DESVIO, A.DATA_FIM_DESVIO 
)
LOOP

      INSERT
      INTO SMARH_INT_DESIGNACAO_HIST
        (SELECT 
          'I',
          case when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC' 
          when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHCGED_TRANSFERENC;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is  null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPLCS_ALT_FUNCAO;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHPLCS_ALT_CARGO;RHCGED_TRANSFERENC'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPONT_ALT_ESCALA;RHCGED_TRANSFERENC'
          when C.DT_ALTER_CARGO IS null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHCGED_TRANSFERENC' 
          when C.DT_ALTER_CARGO IS null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is null then 'RHPLCS_ALT_CARGO'
          when C.DT_ALTER_CARGO IS null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is null then 'RHPLCS_ALT_FUNCAO'
          else ''
          end as nome_tabela,
            CT.CODIGO_EMPRESA,
            CT.TIPO_CONTRATO,
            CT.CODIGO,
            C1.ID,
            sysdate DT_saiu_arte,
            CT.ANO_MES_REFERENCIA,
            F.DATA_INICIO_FUNCAO,
            F.CODIGO_FUNCAO ,
            F.DT_FIM_TEMP,
            F.CODIGO_HIST_FUNCAO ,
            F.DOCUMENTO_PUBLIC ,
            F.TEXTO_ASSOCIADO ,
            F.ID_LEI,
            F.COD_FUNCAO_AVALIACAO,
            F.ALTERA_SAL_PAGTO_CONTR ,
            C.DT_ALTER_CARGO,
            C.MOTIVO_ALTERACAO ,
            C.COD_CARGO_EFET_AT,
            C.NIV_CARGO_EFET_AT ,
            C.COD_CARGO_COMIS_AT ,
            C.NIV_CARGO_COMIS_AT ,
            C.COD_CARGO_AMPAR_AT ,
            C.NIV_CARGO_AMPAR_AT ,
            C.DT_FIM_TEMP ,
            C.DOCUMENTO_PUBLIC ,
            C.OCORRENCIA ,
            C.SALARIO_PAGTO ,
            C.ID_LEI ,
            C.COD_CARGO_AVALIACAO ,
            M.DT_ALT_UNID_CUSTO,
            M.COD_MOVIMENTACAO,
            M.COD_LOTACAO_ATUAL1,
            M.COD_LOTACAO_ATUAL2,
            M.COD_LOTACAO_ATUAL3,
            M.COD_LOTACAO_ATUAL4,
            M.COD_LOTACAO_ATUAL5,
            M.COD_LOTACAO_ATUAL6,
            M.COD_UNIDADE_ATUAL1,
            M.COD_UNIDADE_ATUAL2,
            M.COD_UNIDADE_ATUAL3,
            M.COD_UNIDADE_ATUAL4,
            M.COD_UNIDADE_ATUAL5,
            M.COD_UNIDADE_ATUAL6,
            M.COD_CCONTAB_ATUAL1,
            M.COD_CCONTAB_ATUAL2,
            M.COD_CCONTAB_ATUAL3,
            M.COD_CCONTAB_ATUAL4,
            M.COD_CCONTAB_ATUAL5,
            M.COD_CCONTAB_ATUAL6,
            M.COD_CGERENC_ATUAL1,
            M.COD_CGERENC_ATUAL2,
            M.COD_CGERENC_ATUAL3,
            M.COD_CGERENC_ATUAL4,
            M.COD_CGERENC_ATUAL5,
            M.COD_CGERENC_ATUAL6,
            M.TEXTO_ASSOCIADO,
            M.MOTIVO_ALTERACAO,
            M.DT_FIM_TEMP,
            M.DOCUMENTO_PUBLIC,
            E.DT_INICIO_TROCA ,
            E.DT_FIM_TROCA ,
            E.COD_ESCALA ,
            E.COD_HORARIO,
            E.COD_MOTIVO ,
            E.COD_SITUACAO ,
            E.ORIGEM_PROGRAMACAO ,
            E.ALTER_DEFINITIVA ,
            E.DOCUMENTO_PUBLIC,
            E.ANALISA_ALTERN,
            E.TEXTO_ASSOCIADO,
            E.COD_MOT_CANCEL_SOL ,
            E.TIPO_HORARIO,
            C1.ocorrencia,
            'S'
          FROM RHPESS_CONTRATO CT
          LEFT JOIN
            (SELECT *
            FROM RHPLCS_ALT_FUNCAO F
            WHERE F.DATA_INICIO_FUNCAO =
              (SELECT MAX(AUX.DATA_INICIO_FUNCAO)
              FROM RHPLCS_ALT_FUNCAO AUX
              WHERE AUX.CODIGO_EMPRESA    = F.CODIGO_EMPRESA
              AND AUX.TIPO_CONTRATO       = F.TIPO_CONTRATO
              AND AUX.CODIGO_CONTRATO     = F.CODIGO_CONTRATO
              AND AUX.DATA_INICIO_FUNCAO <= C1.DATA_INICIO_DESVIO
              )
            )F
          ON F.CODIGO_EMPRESA   = CT.CODIGO_EMPRESA
          AND F.TIPO_CONTRATO   = CT.TIPO_CONTRATO
          AND F.CODIGO_CONTRATO = CT.CODIGO
          LEFT JOIN
            (SELECT *
            FROM RHPLCS_ALT_CARGO C
            WHERE C.DT_ALTER_CARGO =
               (SELECT MAX(AUX.DT_ALTER_CARGO)
              FROM RHPLCS_ALT_CARGO AUX
              WHERE AUX.CODIGO_EMPRESA = C.CODIGO_EMPRESA
              AND AUX.TIPO_CONTRATO    = C.TIPO_CONTRATO
              AND AUX.CODIGO_CONTRATO  = C.CODIGO_CONTRATO
              AND AUX.DT_ALTER_CARGO  <= C1.DATA_INICIO_DESVIO
              )
            ) C
          ON C.CODIGO_EMPRESA   = CT.CODIGO_EMPRESA
          AND C.TIPO_CONTRATO   = CT.TIPO_CONTRATO
          AND C.CODIGO_CONTRATO = CT.CODIGO
          LEFT JOIN (SELECT * FROM RHCGED_TRANSFERENC M
          WHERE M.DT_ALT_UNID_CUSTO =
            (SELECT MAX(AUX.DT_ALT_UNID_CUSTO)
            FROM RHCGED_TRANSFERENC AUX
            WHERE AUX.CODIGO_EMPRESA   = M.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO      = M.TIPO_CONTRATO
            AND AUX.CODIGO             = M.CODIGO
            AND AUX.DT_ALT_UNID_CUSTO <= C1.DATA_INICIO_DESVIO
            )) M
          ON M.CODIGO_EMPRESA = CT.CODIGO_EMPRESA
          AND M.TIPO_CONTRATO = CT.TIPO_CONTRATO
          AND M.CODIGO        = CT.CODIGO
          LEFT JOIN (SELECT * FROM RHPONT_ALT_ESCALA E
          WHERE  E.DT_INICIO_TROCA =
            (SELECT MAX(AUX.DT_INICIO_TROCA)
            FROM RHPONT_ALT_ESCALA AUX
            WHERE AUX.CODIGO_EMPRESA    = E.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO       = E.TIPO_CONTRATO
            AND AUX.CODIGO_CONTRATO     = E.CODIGO_CONTRATO
            AND AUX.DT_INICIO_TROCA <= C1.DATA_INICIO_DESVIO
            )) E
          ON E.CODIGO_EMPRESA         = CT.CODIGO_EMPRESA
          AND E.TIPO_CONTRATO         = CT.TIPO_CONTRATO
          AND E.CODIGO_CONTRATO       = CT.CODIGO
          WHERE CT.ANO_MES_REFERENCIA =
            (SELECT MAX(AUX.ANO_MES_REFERENCIA)
            FROM RHPESS_CONTRATO AUX
            WHERE AUX.CODIGO_EMPRESA    = CT.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO       = CT.TIPO_CONTRATO
            AND AUX.CODIGO              = CT.CODIGO
            AND AUX.ANO_MES_REFERENCIA <= C1.DATA_INICIO_DESVIO
            ) 
            --incluido em 26-10-2020 para exibir apenas uma ocorrencia
            AND ( C.OCORRENCIA = (SELECT MAX(AUX2.OCORRENCIA)
              FROM RHPLCS_ALT_CARGO AUX2
              WHERE AUX2.CODIGO_EMPRESA = C.CODIGO_EMPRESA
              AND AUX2.TIPO_CONTRATO    = C.TIPO_CONTRATO
              AND AUX2.CODIGO_CONTRATO  = C.CODIGO_CONTRATO
              and aux2.DT_ALTER_CARGO = c.DT_ALTER_CARGO ) 
              or c.ocorrencia is null )
          AND CT.CODIGO_EMPRESA = C1.codigo_empresa
          AND CT.TIPO_CONTRATO  = C1.tipo_contrato
          AND CT.CODIGO         = C1.codigo_contrato
        );


     BEGIN
      FOR C2 IN
      (select 
      ANO_MES_REFERENCIA , 	CODIGO_EMPRESA  , 	TIPO_CONTRATO  , 	CODIGO  ,   CODIGO_PESSOA	,  COD_LOCAL1	,  COD_LOCAL2	,  COD_LOCAL3	,  COD_LOCAL4	,  COD_LOCAL5	,  COD_LOCAL6	,  DT_ULT_ALT_LOC	,  COD_UNIDADE1	,
      COD_UNIDADE2	,  COD_UNIDADE3	,  COD_UNIDADE4	,  COD_UNIDADE5	,  COD_UNIDADE6	,  DT_ULT_ALT_UNID	,  COD_CUSTO_CONTAB1	,  COD_CUSTO_CONTAB2	,  COD_CUSTO_CONTAB3	,  COD_CUSTO_CONTAB4	,  COD_CUSTO_CONTAB5	,  COD_CUSTO_CONTAB6	,
      DT_ULT_ALT_CONT	,  COD_CUSTO_GERENC1	,  COD_CUSTO_GERENC2	,  COD_CUSTO_GERENC3	,  COD_CUSTO_GERENC4	,  COD_CUSTO_GERENC5	,  COD_CUSTO_GERENC6	,  DT_ULT_ALT_GER	,  SALARIO_PAGTO	,  COD_CARGO_PAGTO	,
      NIVEL_CARGO_PAGTO	,  COD_CARGO_EFETIVO	,  NIVEL_CARGO_EFETIV	,  DT_ULT_CARGO_EFET	,  COD_CARGO_COMISS	,  NIVEL_CARGO_COMISS	,  DT_ULT_CARGO_COM	,  COD_CARGO_AMPAR	,  NIVEL_CARGO_AMPAR	,  DT_ULT_CARGO_AMPAR	,  
      CODIGO_FUNCAO	,  DT_ULT_FUNCAO	,  CODIGO_ESCALA	,  DT_ULT_ESCALA	,  LOGIN_USUARIO	,  DT_ULT_ALTER_USUA	,SITUACAO_FUNCIONAL
      from rhpess_contrato CT WHERE 

            ( ( CT.ANO_MES_REFERENCIA BETWEEN   trunc(C1.DATA_INICIO_DESVIO,'MM')    AND  NVL(C1.DATA_FIM_DESVIO,TRUNC(SYSDATE)) 
              AND CT.ANO_MES_REFERENCIA =
              (SELECT MAX(AUX.ANO_MES_REFERENCIA)
              FROM RHPESS_CONTRATO AUX
              WHERE AUX.CODIGO_EMPRESA    = CT.CODIGO_EMPRESA
              AND AUX.TIPO_CONTRATO       = CT.TIPO_CONTRATO
              AND AUX.CODIGO              = CT.CODIGO )

            ) or (CT.ANO_MES_REFERENCIA =
            (SELECT MAX(AUX.ANO_MES_REFERENCIA)
            FROM RHPESS_CONTRATO AUX
            WHERE AUX.CODIGO_EMPRESA    = CT.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO       = CT.TIPO_CONTRATO
            AND AUX.CODIGO              = CT.CODIGO
            AND AUX.ANO_MES_REFERENCIA <=  NVL(C1.DATA_FIM_DESVIO,TRUNC(SYSDATE))
            )
            ) 
            OR ( CT.ANO_MES_REFERENCIA >= trunc(C1.DATA_INICIO_DESVIO,'MM')AND  C1.DATA_FIM_DESVIO IS NULL)
            )        
              AND CT.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
              AND CT.TIPO_CONTRATO  = C1.TIPO_CONTRATO
              AND CT.CODIGO         = C1.CODIGO_CONTRATO

      )
      LOOP


      INSERT INTO SMARH_INT_DESIGNACAO_CONTR
      ( TIPO_DML, ID, DT_SAIU_ARTE, ANO_MES_REFERENCIA,CODIGO_EMPRESA,TIPO_CONTRATO,CODIGO,CODIGO_PESSOA,COD_LOCAL1,COD_LOCAL2,COD_LOCAL3,COD_LOCAL4,COD_LOCAL5,
      COD_LOCAL6,DT_ULT_ALT_LOC,COD_UNIDADE1,COD_UNIDADE2,COD_UNIDADE3,COD_UNIDADE4,COD_UNIDADE5,COD_UNIDADE6,DT_ULT_ALT_UNID,COD_CUSTO_CONTAB1,COD_CUSTO_CONTAB2,COD_CUSTO_CONTAB3,COD_CUSTO_CONTAB4,COD_CUSTO_CONTAB5,
      COD_CUSTO_CONTAB6,DT_ULT_ALT_CONT,COD_CUSTO_GERENC1,COD_CUSTO_GERENC2,COD_CUSTO_GERENC3,COD_CUSTO_GERENC4,COD_CUSTO_GERENC5,COD_CUSTO_GERENC6,DT_ULT_ALT_GER,SALARIO_PAGTO,COD_CARGO_PAGTO,NIVEL_CARGO_PAGTO,COD_CARGO_EFETIVO,
      NIVEL_CARGO_EFETIV,LT_ULT_CARGO_EFET,COD_CARGO_COMISS,NIVEL_CARGO_COMISS,DT_ULT_CARGO_COM,COD_CARGO_AMPAR,NIVEL_CARGO_AMPAR,DT_ULT_CARGO_AMPAR,CODIGO_FUNCAO,DT_ULT_FUNCAO,CODIGO_ESCALA,DT_ULT_ESCALA,LOGIN_USUARIO,DT_ULT_ALTER_USUA, OCORRENCIA, CONSIDERAR, SITUACAO_FUNCIONAL) 
      VALUES ( 'I', C1.ID, sysdate, trunc(C2.ANO_MES_REFERENCIA), C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO ,C2.CODIGO_PESSOA	,  C2.COD_LOCAL1	,  C2.COD_LOCAL2	, 
      C2.COD_LOCAL3	,  C2.COD_LOCAL4	,  C2.COD_LOCAL5	,  C2.COD_LOCAL6	,  C2.DT_ULT_ALT_LOC	,  C2.COD_UNIDADE1	,  C2.COD_UNIDADE2	,  C2.COD_UNIDADE3	,  C2.COD_UNIDADE4	,  C2.COD_UNIDADE5	,  C2.COD_UNIDADE6	,  
      C2.DT_ULT_ALT_UNID	, C2.COD_CUSTO_CONTAB1	,  C2.COD_CUSTO_CONTAB2	,  C2.COD_CUSTO_CONTAB3	,  C2.COD_CUSTO_CONTAB4	,  C2.COD_CUSTO_CONTAB5	,  C2.COD_CUSTO_CONTAB6	,  C2.DT_ULT_ALT_CONT	,  C2.COD_CUSTO_GERENC2	, 
      C2.COD_CUSTO_GERENC2	,  C2.COD_CUSTO_GERENC3	,  C2.COD_CUSTO_GERENC4	,  C2.COD_CUSTO_GERENC5	,  C2.COD_CUSTO_GERENC6	,  C2.DT_ULT_ALT_GER	,  C2.SALARIO_PAGTO	,  C2.COD_CARGO_PAGTO	,  C2.NIVEL_CARGO_PAGTO	, 
      C2.COD_CARGO_EFETIVO	,  C2.NIVEL_CARGO_EFETIV	,  C2.DT_ULT_CARGO_EFET	,  C2.COD_CARGO_COMISS	,  C2.NIVEL_CARGO_COMISS	,  C2.DT_ULT_CARGO_COM	,  C2.COD_CARGO_AMPAR	,  C2.NIVEL_CARGO_AMPAR	,  C2.DT_ULT_CARGO_AMPAR	,
      C2.CODIGO_FUNCAO	,  C2.DT_ULT_FUNCAO	, C2.CODIGO_ESCALA	,  C2.DT_ULT_ESCALA	,  C2.LOGIN_USUARIO	,  C2.DT_ULT_ALTER_USUA,  C1.OCORRENCIA, 'S', C2.SITUACAO_FUNCIONAL);

      END LOOP;

      END;
     PR_MIGRA_DADOS_DESIG(C1.CODIGO_EMPRESA,C1.TIPO_CONTRATO,C1.CODIGO_CONTRATO,C1.DATA_INICIO_DESVIO,  C1.DATA_FIM_DESVIO, C1.ID,'INSERIR','PR_ATUALIZA_DADOS_DESIG');

 END LOOP;



----------------------------------------------------- ENCERRA HISTÓRICOS PARA DESIGNAÇÕES FINALIZADAS ONTEM ---------------------------------------------------------------------------

FOR C1 IN (
    SELECT MAX(A.ID_SOL_DES_FUNC) AS ID_SOL_DES_FUNC,A.CODIGO_CONTRATO,A.TIPO_CONTRATO,A.CODIGO_EMPRESA,A.OCORRENCIA,A.DATA_INICIO_DESVIO,A.DATA_FIM_DESVIO, MAX(D.ID) AS ID
    FROM RHPLCS_DESVIO_FUNC A, SMARH_INT_DESIGNACAO D
    WHERE A.DATA_FIM_DESVIO = p_DATA_FIM
    AND A.DATA_CANCELAMENTO IS NULL
    AND A.CODIGO_CONTRATO = D.CODIGO_CONTRATO 
    AND A.CODIGO_EMPRESA = D.CODIGO_EMPRESA 
    AND A.TIPO_CONTRATO = D.TIPO_CONTRATO 
    and A.DATA_INICIO_DESVIO = d.DATA_INICIO_DESVIO
    and A.DATA_FIM_DESVIO = d.DATA_FIM_DESVIO
    group by A.ID_SOL_DES_FUNC, A.CODIGO_CONTRATO, A.TIPO_CONTRATO, A.CODIGO_EMPRESA, A.OCORRENCIA, 
    A.DATA_INICIO_DESVIO, A.DATA_FIM_DESVIO 
)
LOOP
      -- É preciso fazer um update aqui para armazenar o histórico! Por isso o considerar é = a 'H' (histórico)
      UPDATE SMARH_INT_DESIGNACAO_HIST SET CONSIDERAR = 'H' where 
      CODIGO_EMPRESA = C1.CODIGO_EMPRESA
      AND TIPO_CONTRATO    = C1.TIPO_CONTRATO
      AND CODIGO = C1.CODIGO_CONTRATO 
      AND OCORRENCIA_DESIG = C1.OCORRENCIA
      AND CONSIDERAR = 'S';

      INSERT
      INTO SMARH_INT_DESIGNACAO_HIST
        (SELECT 
          'I',
          case when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC' 
          when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHCGED_TRANSFERENC;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is  null then 'RHPLCS_ALT_CARGO;RHPLCS_ALT_FUNCAO'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPLCS_ALT_FUNCAO;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPLCS_ALT_CARGO;RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHPLCS_ALT_FUNCAO;RHCGED_TRANSFERENC'
          when C.DT_ALTER_CARGO is not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHPLCS_ALT_CARGO;RHCGED_TRANSFERENC'
          when C.DT_ALTER_CARGO is null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is not null then 'RHPONT_ALT_ESCALA;RHCGED_TRANSFERENC'
          when C.DT_ALTER_CARGO IS null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is not null and e.COD_ESCALA is null then 'RHCGED_TRANSFERENC' 
          when C.DT_ALTER_CARGO IS null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is not null then 'RHPONT_ALT_ESCALA'
          when C.DT_ALTER_CARGO IS not null and F.CODIGO_FUNCAO is null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is null then 'RHPLCS_ALT_CARGO'
          when C.DT_ALTER_CARGO IS null and F.CODIGO_FUNCAO is not null and m.COD_LOTACAO_ATUAL1 is null and e.COD_ESCALA is null then 'RHPLCS_ALT_FUNCAO'
          else ''
          end as nome_tabela,
            CT.CODIGO_EMPRESA,
            CT.TIPO_CONTRATO,
            CT.CODIGO,
            C1.ID,
            sysdate DT_saiu_arte,
            CT.ANO_MES_REFERENCIA,
            F.DATA_INICIO_FUNCAO,
            F.CODIGO_FUNCAO ,
            F.DT_FIM_TEMP,
            F.CODIGO_HIST_FUNCAO ,
            F.DOCUMENTO_PUBLIC ,
            F.TEXTO_ASSOCIADO ,
            F.ID_LEI,
            F.COD_FUNCAO_AVALIACAO,
            F.ALTERA_SAL_PAGTO_CONTR ,
            C.DT_ALTER_CARGO,
            C.MOTIVO_ALTERACAO ,
            C.COD_CARGO_EFET_AT,
            C.NIV_CARGO_EFET_AT ,
            C.COD_CARGO_COMIS_AT ,
            C.NIV_CARGO_COMIS_AT ,
            C.COD_CARGO_AMPAR_AT ,
            C.NIV_CARGO_AMPAR_AT ,
            C.DT_FIM_TEMP ,
            C.DOCUMENTO_PUBLIC ,
            C.OCORRENCIA ,
            C.SALARIO_PAGTO ,
            C.ID_LEI ,
            C.COD_CARGO_AVALIACAO ,
            M.DT_ALT_UNID_CUSTO,
            M.COD_MOVIMENTACAO,
            M.COD_LOTACAO_ATUAL1,
            M.COD_LOTACAO_ATUAL2,
            M.COD_LOTACAO_ATUAL3,
            M.COD_LOTACAO_ATUAL4,
            M.COD_LOTACAO_ATUAL5,
            M.COD_LOTACAO_ATUAL6,
            M.COD_UNIDADE_ATUAL1,
            M.COD_UNIDADE_ATUAL2,
            M.COD_UNIDADE_ATUAL3,
            M.COD_UNIDADE_ATUAL4,
            M.COD_UNIDADE_ATUAL5,
            M.COD_UNIDADE_ATUAL6,
            M.COD_CCONTAB_ATUAL1,
            M.COD_CCONTAB_ATUAL2,
            M.COD_CCONTAB_ATUAL3,
            M.COD_CCONTAB_ATUAL4,
            M.COD_CCONTAB_ATUAL5,
            M.COD_CCONTAB_ATUAL6,
            M.COD_CGERENC_ATUAL1,
            M.COD_CGERENC_ATUAL2,
            M.COD_CGERENC_ATUAL3,
            M.COD_CGERENC_ATUAL4,
            M.COD_CGERENC_ATUAL5,
            M.COD_CGERENC_ATUAL6,
            M.TEXTO_ASSOCIADO,
            M.MOTIVO_ALTERACAO,
            M.DT_FIM_TEMP,
            M.DOCUMENTO_PUBLIC,
            E.DT_INICIO_TROCA ,
            E.DT_FIM_TROCA ,
            E.COD_ESCALA ,
            E.COD_HORARIO,
            E.COD_MOTIVO ,
            E.COD_SITUACAO ,
            E.ORIGEM_PROGRAMACAO ,
            E.ALTER_DEFINITIVA ,
            E.DOCUMENTO_PUBLIC,
            E.ANALISA_ALTERN,
            E.TEXTO_ASSOCIADO,
            E.COD_MOT_CANCEL_SOL ,
            E.TIPO_HORARIO,
            C1.ocorrencia,
            'S'
          FROM RHPESS_CONTRATO CT
          LEFT JOIN
            (SELECT *
            FROM RHPLCS_ALT_FUNCAO F
            WHERE F.DATA_INICIO_FUNCAO =
              (SELECT MAX(AUX.DATA_INICIO_FUNCAO)
              FROM RHPLCS_ALT_FUNCAO AUX
              WHERE AUX.CODIGO_EMPRESA    = F.CODIGO_EMPRESA
              AND AUX.TIPO_CONTRATO       = F.TIPO_CONTRATO
              AND AUX.CODIGO_CONTRATO     = F.CODIGO_CONTRATO
              AND AUX.DATA_INICIO_FUNCAO <= C1.DATA_INICIO_DESVIO
              )
            )F
          ON F.CODIGO_EMPRESA   = CT.CODIGO_EMPRESA
          AND F.TIPO_CONTRATO   = CT.TIPO_CONTRATO
          AND F.CODIGO_CONTRATO = CT.CODIGO
          LEFT JOIN
            (SELECT *
            FROM RHPLCS_ALT_CARGO C
            WHERE C.DT_ALTER_CARGO =
               (SELECT MAX(AUX.DT_ALTER_CARGO)
              FROM RHPLCS_ALT_CARGO AUX
              WHERE AUX.CODIGO_EMPRESA = C.CODIGO_EMPRESA
              AND AUX.TIPO_CONTRATO    = C.TIPO_CONTRATO
              AND AUX.CODIGO_CONTRATO  = C.CODIGO_CONTRATO
              AND AUX.DT_ALTER_CARGO  <= C1.DATA_INICIO_DESVIO
              )
            ) C
          ON C.CODIGO_EMPRESA   = CT.CODIGO_EMPRESA
          AND C.TIPO_CONTRATO   = CT.TIPO_CONTRATO
          AND C.CODIGO_CONTRATO = CT.CODIGO
          LEFT JOIN (SELECT * FROM RHCGED_TRANSFERENC M
          WHERE M.DT_ALT_UNID_CUSTO =
            (SELECT MAX(AUX.DT_ALT_UNID_CUSTO)
            FROM RHCGED_TRANSFERENC AUX
            WHERE AUX.CODIGO_EMPRESA   = M.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO      = M.TIPO_CONTRATO
            AND AUX.CODIGO             = M.CODIGO
            AND AUX.DT_ALT_UNID_CUSTO <= C1.DATA_INICIO_DESVIO
            )) M
          ON M.CODIGO_EMPRESA = CT.CODIGO_EMPRESA
          AND M.TIPO_CONTRATO = CT.TIPO_CONTRATO
          AND M.CODIGO        = CT.CODIGO
          LEFT JOIN (SELECT * FROM RHPONT_ALT_ESCALA E
          WHERE  E.DT_INICIO_TROCA =
            (SELECT MAX(AUX.DT_INICIO_TROCA)
            FROM RHPONT_ALT_ESCALA AUX
            WHERE AUX.CODIGO_EMPRESA    = E.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO       = E.TIPO_CONTRATO
            AND AUX.CODIGO_CONTRATO     = E.CODIGO_CONTRATO
            AND AUX.DT_INICIO_TROCA <= C1.DATA_INICIO_DESVIO
            )) E
          ON E.CODIGO_EMPRESA         = CT.CODIGO_EMPRESA
          AND E.TIPO_CONTRATO         = CT.TIPO_CONTRATO
          AND E.CODIGO_CONTRATO       = CT.CODIGO
          WHERE CT.ANO_MES_REFERENCIA =
            (SELECT MAX(AUX.ANO_MES_REFERENCIA)
            FROM RHPESS_CONTRATO AUX
            WHERE AUX.CODIGO_EMPRESA    = CT.CODIGO_EMPRESA
            AND AUX.TIPO_CONTRATO       = CT.TIPO_CONTRATO
            AND AUX.CODIGO              = CT.CODIGO
            AND AUX.ANO_MES_REFERENCIA <= C1.DATA_INICIO_DESVIO
            ) 
            --incluido em 26-10-2020 para exibir apenas uma ocorrencia
            AND ( C.OCORRENCIA = (SELECT MAX(AUX2.OCORRENCIA)
              FROM RHPLCS_ALT_CARGO AUX2
              WHERE AUX2.CODIGO_EMPRESA = C.CODIGO_EMPRESA
              AND AUX2.TIPO_CONTRATO    = C.TIPO_CONTRATO
              AND AUX2.CODIGO_CONTRATO  = C.CODIGO_CONTRATO
              and aux2.DT_ALTER_CARGO = c.DT_ALTER_CARGO ) 
              or c.ocorrencia is null )
          AND CT.CODIGO_EMPRESA = C1.codigo_empresa
          AND CT.TIPO_CONTRATO  = C1.tipo_contrato
          AND CT.CODIGO         = C1.codigo_contrato
        );

     PR_MIGRA_DADOS_DESIG(C1.CODIGO_EMPRESA,C1.TIPO_CONTRATO,C1.CODIGO_CONTRATO,C1.DATA_INICIO_DESVIO,  C1.DATA_FIM_DESVIO, C1.ID, 'ENCERRAR', 'PR_ATUALIZA_DADOS_DESIG');

     -- È preciso voltar o histórico para que ele seja considerado caso a designação ainda sofra alteraçoes após ser findada!
     UPDATE SMARH_INT_DESIGNACAO_HIST SET CONSIDERAR = 'S' where 
      CODIGO_EMPRESA = C1.CODIGO_EMPRESA
      AND TIPO_CONTRATO    = C1.TIPO_CONTRATO
      AND CODIGO = C1.CODIGO_CONTRATO 
      AND OCORRENCIA_DESIG = C1.OCORRENCIA
      AND CONSIDERAR = 'H';


 END LOOP;    


END PR_ATUALIZA_DADOS_DESIG;