
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PR_SGE_DP5_REGRA2_EXTRA" 
AS 
BEGIN 

--Kellysson em 19/1/24 baseado (sql_4_regras_extraclasse_p2_b3.sql)

--Kellysson novo em 4/9/23 nova em sql_4_regras_extraclasse_p2_b3.sql--alterando NOT IN ('EXCLUI','CONCOMITA') PARA IN ('ACUMULA','TOTALIZA')
--Kellysson em 4/8/23 baseado no sql_4_regras_extraclasse_p1_b5.sql
--Kellysson novo em 2/8/23 nova em sql_4_regras_extraclasse_p1_b4.sql --trocando de tabela
--Kellysson novo em 1/8/23 nova em sql_4_regras_extraclasse_b3.sql
--Kellysson novo em 31/7/23 ---nova abordagem apos ajustes na ultima semana
DECLARE
--vCONTADOR NUMBER;
vSALDO_HORAS_DISPONIVEIS_TURNO NUMBER;
vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR NUMBER;
vMINUTOS_DIA_TURNO_LIVRES NUMBER;
vTRUE BOOLEAN := TRUE ;

BEGIN
dbms_output.enable(null);
--vCONTADOR :=0;
vSALDO_HORAS_DISPONIVEIS_TURNO := 0 ;
vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR := 0 ;
vMINUTOS_DIA_TURNO_LIVRES := 0 ;

------------------------------------------------------------------------------------------------INICIO ----PRIMEIRA PARTE ---CONTROLE MESMO TURNO E DIA----------------------------------------------------------------------------------------------------------
FOR C1 IN (

--SELECT COUNT(1) FROM (--COUNT

SELECT
ROW_NUMBER() OVER(PARTITION BY M.CPF, SEMANA_ANO, M.INICIO_TURNO ORDER BY M.CPF, SEMANA_ANO, M.INICIO_TURNO, M.DATA, M.INICIO_REGENCIA )ORDEM_NA_SEMANA_DO_TURNO,
CASE
WHEN M.INICIO_REGENCIA <> 0 AND TST.SOMA_MINUTOS_REGENCIA_TST/2 < TST.SOMA_EXTRA_IGUAL_TURNO_E_DIA THEN '0_POSSIVEL_ERRO_DISTRIBUIDO_MAIS_EXTRA_QUE_REGENCIA'
WHEN M.INICIO_REGENCIA <> 0 AND TST.SOMA_MINUTOS_REGENCIA_TST/2 = TST.SOMA_EXTRA_IGUAL_TURNO_E_DIA THEN '1_OK_TODA_EXTRACLASSE_DISTRIBUIDA_REGRA_1'
WHEN M.INICIO_REGENCIA <> 0 AND TST.SOMA_MINUTOS_REGENCIA_TST/2 > TST.SOMA_EXTRA_IGUAL_TURNO_E_DIA AND TST.SOMA_MINUTOS_REGENCIA_TST < 1350 THEN '2_OK_DISTRIBUIR_O_POSSIVEL_NA_REGRA_2'
WHEN M.INICIO_REGENCIA <> 0 AND TST.SOMA_MINUTOS_REGENCIA_TST/2 > TST.SOMA_EXTRA_IGUAL_TURNO_E_DIA AND TST.SOMA_MINUTOS_REGENCIA_TST >= 1350 THEN '3_OK_DISTRIBUIR_O_POSSIVEL_NA_REGRA_3'
END CENARIO,
ROW_NUMBER () OVER (PARTITION BY M.CPF, M.DATA, M.INICIO_TURNO ORDER BY M.CPF, M.DATA, M.INICIO_TURNO, M.INICIO_REGENCIA)ORDEM_MESMO_CPF_DIA_TURNO, 
TST.QTD_REG_MESMO_DIA_TURNO_TST, TST.SOMA_MINUTOS_REGENCIA_TST,  TST.SOMA_EXTRA_IGUAL_TURNO_E_DIA SOMA_EXTRA_IGUAL_TURNO_E_DIA_TST,
--TDST.MAX_SOMA_MINUTOS_DIA_TURNO_USADO MAX_SOMA_MINUTOS_DIA_TURNO_USADO_TDST,
                                TDT.SOMA_MINUTOS_DIA_TURNO_USADO SOMA_MINUTOS_DIA_TURNO_USADO_TDT,
M.CPF, TO_NUMBER(TO_CHAR(TO_DATE(M.DATA),'WW')) SEMANA_ANO, D.NRO_DIA_SEMANA, M.DATA, M.ID_HORARIO, M.INICIO_TURNO, M.INICIO_REGENCIA, M.FIM_REGENCIA,M.OBS_PROCESSAMENTO, 
--LAG(M.TOTAL_REGENCIA, 1, NULL) OVER(PARTITION BY M.CPF, M.DATA, M.INICIO_TURNO ORDER BY M.CPF, M.DATA, M.INICIO_TURNO, M.INICIO_REGENCIA) TOTAL_REGENCIA_ANTERIOR,
M.TOTAL_REGENCIA,   
--LEAD(M.TOTAL_REGENCIA, 1, NULL) OVER(PARTITION BY M.CPF, M.DATA, M.INICIO_TURNO ORDER BY M.CPF, M.DATA, M.INICIO_TURNO, M.INICIO_REGENCIA) PROXIMO_TOTAL_REGENCIA,
M.EXTRA_IGUAL_TURNO_E_DIA, M.EXTRA_IGUAL_TURNO_DIA_DIFERE, M.EXTRA_DIFERE_TURNO_DIA_IGUAL, M.EXTRA_DIFERE_TURNO_E_DIA
--, A.BM_U, A.TIPO_JORNADA_U, A.TURNO_U, A.HORA_INI_TURNO_U, A.DURACAO_AULA_U, A.CARGA_HORARIA, A.DATA_INICIO_U, A.DATA_FIM_U, A.DATA_CANCELAMENTO_U
FROM PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS M 

LEFT OUTER JOIN
(
    SELECT CPF, DATA, INICIO_TURNO, SUM(TOTAL_REGENCIA+EXTRA_IGUAL_TURNO_E_DIA) SOMA_MINUTOS_DIA_TURNO_USADO, COUNT(1)QTD_REG_MESMO_DIA_TURNO_TST FROM
            (
            SELECT CPF, DATA, INICIO_TURNO, TOTAL_REGENCIA, EXTRA_IGUAL_TURNO_E_DIA
             FROM PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
             AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
             AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA')  ORDER BY CPF, DATA, INICIO_TURNO
            ) GROUP BY CPF, DATA, INICIO_TURNO
             ORDER BY CPF,DATA,  INICIO_TURNO    
)TDT ------------------------------------------TOTAL SEMANA DE CADA DIA DE TURNO
    ON TDT.CPF = M.CPF AND TRUNC(TDT.DATA) = TRUNC(M.DATA) AND TDT.INICIO_TURNO = M.INICIO_TURNO


LEFT OUTER JOIN 
    ( SELECT CPF, SEMANA_ANO, INICIO_TURNO, SUM(TOTAL_REGENCIA) SOMA_MINUTOS_REGENCIA_TST, SUM(EXTRA_IGUAL_TURNO_E_DIA) SOMA_EXTRA_IGUAL_TURNO_E_DIA, COUNT(1)QTD_REG_MESMO_DIA_TURNO_TST FROM
            (
            SELECT CPF, TO_NUMBER(TO_CHAR(TO_DATE(DATA),'WW')) SEMANA_ANO, INICIO_TURNO, TOTAL_REGENCIA, EXTRA_IGUAL_TURNO_E_DIA
             FROM PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
             AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
             AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA') ORDER BY CPF, SEMANA_ANO, INICIO_TURNO
            ) GROUP BY CPF, SEMANA_ANO, INICIO_TURNO
             ORDER BY CPF, SEMANA_ANO, INICIO_TURNO       
             )TST ------------------------------------------TOTAL SEMANA DE CADA TURNO
    ON TST.CPF = M.CPF AND TST.SEMANA_ANO = TO_NUMBER(TO_CHAR(TO_DATE(M.DATA),'WW')) AND TST.INICIO_TURNO = M.INICIO_TURNO


/*
LEFT OUTER JOIN 
(
    SELECT CPF, TO_NUMBER(TO_CHAR(TO_DATE(DATA),'WW')) SEMANA_ANO_D, INICIO_TURNO, MAX(SOMA_MINUTOS_DIA_TURNO_USADO)MAX_SOMA_MINUTOS_DIA_TURNO_USADO FROM (
            SELECT CPF, DATA, INICIO_TURNO, SUM(TOTAL_REGENCIA+EXTRA_IGUAL_TURNO_E_DIA) SOMA_MINUTOS_DIA_TURNO_USADO, COUNT(1)QTD_REG_MESMO_DIA_TURNO_TST FROM
            (
            SELECT CPF, DATA, INICIO_TURNO, TOTAL_REGENCIA, EXTRA_IGUAL_TURNO_E_DIA
             FROM PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
             AND OBS_PROCESSAMENTO NOT IN ('EXCLUI','CONCOMITA')  ORDER BY CPF, DATA, INICIO_TURNO
            ) GROUP BY CPF, DATA, DATA, INICIO_TURNO
             ORDER BY CPF,DATA,  INICIO_TURNO 
)GROUP BY CPF, TO_NUMBER(TO_CHAR(TO_DATE(DATA),'WW')), INICIO_TURNO ORDER BY CPF, TO_NUMBER(TO_CHAR(TO_DATE(DATA),'WW')), INICIO_TURNO 
)TDST 
    ON TDST.CPF = M.CPF AND TDST.SEMANA_ANO_D = TO_NUMBER(TO_CHAR(TO_DATE(M.DATA),'WW')) AND TDST.INICIO_TURNO = M.INICIO_TURNO
*/

LEFT OUTER JOIN ARTERH.RHTABS_DATAS D ON TRUNC(D.DATA_DIA) = TRUNC(M.DATA)
/*
LEFT OUTER JOIN 
(SELECT * FROM PONTO_ELETRONICO.SUGESP_SGE_JORNADAS_AJUSTES WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE))A ON A.ID_HORARIO = M.ID_HORARIO
*/
LEFT OUTER JOIN (
SELECT * FROM (SELECT ROW_NUMBER() OVER (PARTITION BY ID_HORARIO ORDER BY ID_HORARIO, COORDENACAO_U)ORDEM_ID,
ID_HORARIO, COORDENACAO_U, COUNT(1)QTD FROM PONTO_ELETRONICO.SUGESP_SGE_JORNADAS_AJUSTES WHERE TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
AND TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)--NOVO EM 16/10/23
GROUP BY ID_HORARIO, COORDENACAO_U ORDER BY COUNT(1)DESC, ID_HORARIO, COORDENACAO_U ) WHERE ORDEM_ID = 1
)C ON C.ID_HORARIO = M.ID_HORARIO
--FIM---NOVO EM 25/9/23


WHERE TRUNC(M.DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
AND M.OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA')
AND M.TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
AND C.COORDENACAO_U = 'NÃƒO' --NOVO EM 25/9/23 --- PARA NAO ADICIONAR EXTRACLASSE PARA COORDENADORES
--AND M.CPF IN ('00544706684','05096889696','00064003612','88434974649','07465582601','03385076633')
--= '65902084687' ---TESTES
--in ('65902084687','44395426620','05977311605','67548989687','03324512670','03268343627','03611128660','74393383672','02762267633','44773854634','06364973647','76755622672','56482396615','96067845687','88203255604','04224017652','91774802600','07865358652','84200626691','79280382691','85124133600','06401982608','02996366662','50666240663','03456317654','06090534692','78772010606','59375280691','07820101644','16083584884','02613598603','94361347620','02744482625','00821066650','09267702688','08756655606','01282420607','85883840604','40378365649','06054125613','11944452680','01542390621','01192300629','01041868367','56121784687','54177413615')
ORDER BY M.CPF, SEMANA_ANO, M.INICIO_TURNO, M.DATA, M.INICIO_REGENCIA, M.ID_HORARIO

--)--count

--UPDATE PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS SET EXTRA_IGUAL_TURNO_DIA_DIFERE = NULL WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE) AND EXTRA_IGUAL_TURNO_DIA_DIFERE IS NOT NULL; COMMIT;

)LOOP
--vCONTADOR := vCONTADOR +1;
--dbms_output.put_line('vCONTADOR: '||vCONTADOR||'-'||C1.CPF||'-'||C1.SEMANA_ANO||'-'||C1.NRO_DIA_SEMANA||'-'||C1.DATA||'-'||C1.INICIO_TURNO||'-'||C1.INICIO_REGENCIA||'-'||C1.FIM_REGENCIA||'-'||C1.TOTAL_REGENCIA||'-'||C1.ID_HORARIO||'-'||C1.TIPO_MARCACAO||'-'||C1.OBS_PROCESSAMENTO);



--INICIO---APENAS PARA SETAR OS SALDO DO MESMO TURNO NA SEMANA
IF C1.ORDEM_NA_SEMANA_DO_TURNO = 1 THEN
--dbms_output.put_line('PRIMEIRO_REGISTRO_MESMO_TURNO_SETA_VARIAVEIS');
--vSALDO_HORAS_DISPONIVEIS_TURNO := 1350-(C1.SOMA_MINUTOS_REGENCIA_TST - C1.SOMA_EXTRA_IGUAL_TURNO_E_DIA_TST) ;
vSALDO_HORAS_DISPONIVEIS_TURNO := 1350-(C1.SOMA_MINUTOS_REGENCIA_TST + C1.SOMA_EXTRA_IGUAL_TURNO_E_DIA_TST) ;
vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR := C1.SOMA_MINUTOS_REGENCIA_TST/2 - C1.SOMA_EXTRA_IGUAL_TURNO_E_DIA_TST;
--dbms_output.put_line('0-'||vSALDO_HORAS_DISPONIVEIS_TURNO);
END IF;
--FIM---APENAS PARA SETAR OS SALDO DO MESMO DIA/TURNO


--INICIO VARIAVEL CONTROLE USO DO DIA
IF C1.NRO_DIA_SEMANA > 1 AND C1.ORDEM_MESMO_CPF_DIA_TURNO = 1 THEN
vMINUTOS_DIA_TURNO_LIVRES := 270-C1.SOMA_MINUTOS_DIA_TURNO_USADO_TDT;
END IF;


--INICIO-------IF GERAL SALDO DO TURNO NO DIA --NOVO EM 1/8/23 AS 09H04------------------------------------------------------------ 
--IF C1.CENARIO = '2_OK_DISTRIBUIR_O_POSSIVEL_NA_REGRA_2' THEN
--IF C1.NRO_DIA_SEMANA > 1 AND C1.SOMA_MINUTOS_DIA_TURNO_USADO < 270 THEN
--IF C1.NRO_DIA_SEMANA > 1 AND C1.MAX_SOMA_MINUTOS_DIA_TURNO_USADO_TDST < 270 THEN
--IF C1.SOMA_EXTRA_IGUAL_TURNO_E_DIA_TST < C1.SOMA_MINUTOS_REGENCIA_TST/2 THEN	
IF C1.NRO_DIA_SEMANA > 1 AND vSALDO_HORAS_DISPONIVEIS_TURNO > 0 AND vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR > 0  AND vMINUTOS_DIA_TURNO_LIVRES > 0 THEN
--TURNO ONDE HA HORAS EXTRACLASSES SUFICIENTES PARA COBRIR AS HORAS DE REGENCIA DO DIA/TURNO

    IF /*vSALDO_HORAS_DISPONIVEIS_TURNO >= vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR AND*/ vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR >= vMINUTOS_DIA_TURNO_LIVRES THEN
    UPDATE PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS SET EXTRA_IGUAL_TURNO_DIA_DIFERE = vMINUTOS_DIA_TURNO_LIVRES
    WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE) AND CPF = C1.CPF AND DATA = C1.DATA AND INICIO_TURNO = C1.INICIO_TURNO AND INICIO_REGENCIA = C1.INICIO_REGENCIA  AND ID_HORARIO = C1.ID_HORARIO
    AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA')--NOVO EM 4/9/23
    AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
    ; COMMIT;
    vSALDO_HORAS_DISPONIVEIS_TURNO := vSALDO_HORAS_DISPONIVEIS_TURNO - vMINUTOS_DIA_TURNO_LIVRES;
    vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR := vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR - vMINUTOS_DIA_TURNO_LIVRES;
    vMINUTOS_DIA_TURNO_LIVRES := vMINUTOS_DIA_TURNO_LIVRES - vMINUTOS_DIA_TURNO_LIVRES;

    ELSIF /*vSALDO_HORAS_DISPONIVEIS_TURNO >= vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR AND*/ vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR < vMINUTOS_DIA_TURNO_LIVRES THEN
    UPDATE PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS SET EXTRA_IGUAL_TURNO_DIA_DIFERE = vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR
    WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE) AND CPF = C1.CPF AND DATA = C1.DATA AND INICIO_TURNO = C1.INICIO_TURNO AND INICIO_REGENCIA = C1.INICIO_REGENCIA AND ID_HORARIO = C1.ID_HORARIO
    AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA')--NOVO EM 4/9/23
    AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
    ; COMMIT;
    vSALDO_HORAS_DISPONIVEIS_TURNO := vSALDO_HORAS_DISPONIVEIS_TURNO - vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR;
    vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR := vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR - vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR;
    vMINUTOS_DIA_TURNO_LIVRES := vMINUTOS_DIA_TURNO_LIVRES - vSALDO_HORAS_EXTRA_PARA_DISTRIBUIR;


    END IF;

ELSE
UPDATE PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS SET EXTRA_IGUAL_TURNO_DIA_DIFERE = 0 WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE) --AND TIPO_MARCACAO = C1.TIPO_MARCACAO
AND CPF = C1.CPF AND DATA = C1.DATA AND INICIO_TURNO = C1.INICIO_TURNO AND INICIO_REGENCIA = C1.INICIO_REGENCIA AND ID_HORARIO = C1.ID_HORARIO
AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA')--NOVO EM 4/9/23
AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
; COMMIT;

END IF;
--FIM-------IF GERAL SALDO DO TURNO NO DIA --NOVO EM 1/8/23 AS 09H04------------------------------------------------------------ 
--dbms_output.put_line('--------------------');
END LOOP;---FIM FOR C1
------------------------------------------------------------------------------------------------INICIO ----PRIMEIRA PARTE ---CONTROLE MESMO TURNO E DIA----------------------------------------------------------------------------------------------------------
END;
END;