
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PR_SGE_DP5_RETIRA_HRSEM_EXTRA" 
AS 
BEGIN 

--Kellysson em 19/1/24 baseado (sql_atualiza_data_horarios_b2.sql)
--Kellysson novo em 3/10/23 --- retirar registros que nÃ£o geral extraclasse
BEGIN
dbms_output.enable(null);

FOR C1 IN(

--SELECT GERA_EXTRACLASSE, TIPO_JORNADA_U, COORDENACAO_U, MAIOR_TOTAL_POR_TURNO_NA_SEMANA, COUNT(1)QTD_REGISTROS FROM (--SINTETICO

SELECT CASE WHEN X.COORDENACAO_U = 'SIM' OR /*(X.TIPO_JORNADA_U = 0 AND*/ X.MAIOR_TOTAL_POR_TURNO_NA_SEMANA > 900/*)*/ THEN 'NAO' ELSE 'SIM' END GERA_EXTRACLASSE, X.* FROM (

SELECT ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, MAX(TOTAL_POR_TURNO_NA_SEMANA) MAIOR_TOTAL_POR_TURNO_NA_SEMANA FROM(

SELECT ROW_NUMBER() OVER(PARTITION BY ID_HORARIO ORDER BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, INICIO_TURNO, MIN_INICIO_REGENCIA, MAX_FIM_REGENCIA, TOTAL_POR_TURNO_NA_SEMANA) ORDEM_ID_HORARIO, COUNT(1)QTD_SEMANAS_IGUAIS, 
ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, INICIO_TURNO, MIN_INICIO_REGENCIA, MAX_FIM_REGENCIA, TOTAL_POR_TURNO_NA_SEMANA FROM (

SELECT ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, CPF, SEMANA_ANO, INICIO_TURNO, MIN(INICIO_REGENCIA)MIN_INICIO_REGENCIA, MAX(FIM_REGENCIA)MAX_FIM_REGENCIA, SUM(TOTAL_REGENCIA)TOTAL_POR_TURNO_NA_SEMANA FROM(

SELECT D.CPF, TO_NUMBER(TO_CHAR(TO_DATE(D.DATA),'WW')) SEMANA_ANO, D.DATA, D.INICIO_TURNO, D.INICIO_REGENCIA, D.FIM_REGENCIA, D.FIM_REGENCIA-D.INICIO_REGENCIA TOTAL_REGENCIA,  
D.ID_HORARIO, D.TIPO, D.DATA_PROCESSAMENTO, D.OBS_PROCESSAMENTO, D.TIPO_REGISTRO, C.TIPO_JORNADA_U, C.COORDENACAO_U
FROM PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS D
--INICIO ---NOVO EM 25/9/23
LEFT OUTER JOIN (

SELECT * FROM (
SELECT ROW_NUMBER() OVER (PARTITION BY ID_HORARIO ORDER BY ID_HORARIO, TIPO_JORNADA_U)ORDEM_ID,
ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, COUNT(1)QTD FROM PONTO_ELETRONICO.SUGESP_SGE_JORNADAS_AJUSTES WHERE TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023' 
AND TRUNC(DATA_PROCESSAMENTO) =TRUNC(SYSDATE)--NOVO EM 16/10/23
GROUP BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U ORDER BY COUNT(1)DESC, ID_HORARIO, TIPO_JORNADA_U 
) WHERE ORDEM_ID = 1

)C ON C.ID_HORARIO = D.ID_HORARIO
--FIM---NOVO EM 25/9/23
WHERE TRUNC(D.DATA_PROCESSAMENTO)= TRUNC(SYSDATE)
AND D.OBS_PROCESSAMENTO IN ('ACUMULA')
AND D.TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023'
ORDER BY D.CPF, D.DATA, D.INICIO_TURNO, D.INICIO_REGENCIA, D.FIM_REGENCIA

)GROUP BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, CPF, SEMANA_ANO, INICIO_TURNO ORDER BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, CPF, SEMANA_ANO, INICIO_TURNO, ID_HORARIO, TIPO_JORNADA_U

)GROUP BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, INICIO_TURNO, MIN_INICIO_REGENCIA, MAX_FIM_REGENCIA, TOTAL_POR_TURNO_NA_SEMANA ORDER BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U, INICIO_TURNO, MIN_INICIO_REGENCIA, MAX_FIM_REGENCIA, TOTAL_POR_TURNO_NA_SEMANA

)GROUP BY ID_HORARIO, TIPO_JORNADA_U, COORDENACAO_U ORDER BY TIPO_JORNADA_U, COORDENACAO_U, ID_HORARIO

)X

--)GROUP BY GERA_EXTRACLASSE, TIPO_JORNADA_U, COORDENACAO_U, MAIOR_TOTAL_POR_TURNO_NA_SEMANA ORDER BY GERA_EXTRACLASSE, TIPO_JORNADA_U, COORDENACAO_U, MAIOR_TOTAL_POR_TURNO_NA_SEMANA --SINTETICO

)

LOOP

IF C1.GERA_EXTRACLASSE = 'SIM' THEN
UPDATE PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS SET GERA_EXTRACLASSE = 'SIM' WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA') AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023' AND ID_HORARIO = C1.ID_HORARIO;COMMIT;
ELSE
UPDATE PONTO_ELETRONICO.SUGESP_SGE_PAR_REGE_ARQ_DATAS SET GERA_EXTRACLASSE = 'NAO' WHERE TRUNC(DATA_PROCESSAMENTO)= TRUNC(SYSDATE)AND OBS_PROCESSAMENTO IN ('ACUMULA','TOTALIZA') AND TIPO_REGISTRO = 'DE/PARA_EXTENSOES_2023' AND ID_HORARIO = C1.ID_HORARIO;COMMIT;
END IF;

END LOOP;

END;

END;