
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."IMPORTACAO_ADM_PER" (aCODIGO_EMPRESA IN VARCHAR2, aCPF IN VARCHAR2, aDT_REG_OCORRENCIA IN DATE, aDATA_CARGA IN DATE, 
                                                       aNATUREZA_EXAME IN VARCHAR2, aCODIGO_ATENDENTE IN VARCHAR2, aNOME_ATENDENTE_ATENDENTE IN VARCHAR2, aINSCRICAO_CONSELHO_ATENDENTE IN VARCHAR2, 
                                                       aUF_CONSELHO_ATENDENTE IN VARCHAR2, aCONSELHO_REGIONAL_ATENDENTE IN VARCHAR2) AS 

BEGIN
EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/YYYY'''; 

DECLARE
ANALISA_FICHA TP_IMPORT_ADM_PER;
APTIDAO NUMBER;
LINHA NUMBER;

/*A FUNCAO ANALISA_FICHA_MEDICA VERIFICA SE EXISTE O CANDIDATO, FICHA MEDICA, CODIGO DE PESSOA*/
FUNCTION ANALISA_FICHA_MEDICA (VCPF_CAND IN VARCHAR, VCANDIDATO IN VARCHAR, VDT_OCORRENCIA IN DATE, VCODIGO_EMPRESA IN VARCHAR, VCODIGO_EVENTO IN VARCHAR, VDATA_CARGA IN DATE)
RETURN TP_IMPORT_ADM_PER IS 
DADOS_CAND TP_IMPORT_ADM_PER;

BEGIN 
DADOS_CAND := TP_IMPORT_ADM_PER (0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL);

FOR C2 IN ( 
SELECT SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA, SUGESP_IMPORTACAO_ADM_PER.CPF, RHPESS_PESSOA.CODIGO, RHMEDI_FICHA_MED.CODIGO_CANDIDATO, RHMEDI_FICHA_MED.DT_REG_OCORRENCIA, 
RHMEDI_FICHA_MED.NATUREZA_EXAME, /*RHMEDI_FICHA_MED.OCORRENCIA,*/ RHMEDI_FICHA_MED.CODIGO_EVENTO_SEL, SUGESP_IMPORTACAO_ADM_PER.CTRL_APTIDAO, RHMEDI_CTRL_APTID.TP_RESULT_ASO_ESOCIAL,
RHSELE_EVENTO_SEL.COD_VINCULO, CASE WHEN RHMEDI_FICHA_MED.PARECER_MEDICO IS NULL THEN 'ATUALIZA' ELSE 'INSERE FICHA' END AS ACAO,
CASE WHEN RHMEDI_FICHA_MED.PARECER_MEDICO IS NULL THEN RHMEDI_FICHA_MED.OCORRENCIA ELSE NVL(RHMEDI_FICHA_MED.OCORRENCIA,0)+1 END AS NOVA_OCORRENCIA_FICHA
FROM SUGESP_IMPORTACAO_ADM_PER
LEFT JOIN RHPESS_PESSOA
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA  = RHPESS_PESSOA.CODIGO_EMPRESA
AND LPAD(SUGESP_IMPORTACAO_ADM_PER.CPF,11,0) = RHPESS_PESSOA.CPF
AND RHPESS_PESSOA.DT_TERMINO IS NULL 
LEFT JOIN RHPESS_CANDIDATO
ON RHPESS_PESSOA.CODIGO                                       = RHPESS_CANDIDATO.CODIGO_PESSOA
AND RHPESS_PESSOA.CODIGO_EMPRESA                              = RHPESS_CANDIDATO.CODIGO_EMPRESA
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA                  = RHPESS_CANDIDATO.CODIGO_EMPRESA
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_CANDIDATO                = RHPESS_CANDIDATO.CODIGO
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_EVENTO_SEL               = RHPESS_CANDIDATO.CODIGO_EVENTO_SEL
AND TO_DATE(RHPESS_CANDIDATO.DATA_CADASTRAMENTO,'DD/MM/YYYY') = TRUNC(VDT_OCORRENCIA) --TO_DATE(VDT_OCORRENCIA,'DD/MM/YYYY')
AND RHPESS_CANDIDATO.SITUACAO_CANDIDATO NOT IN ('0002') /*INCLUIDO POR LETICIA EM 22/09/2023 PARA DESCONSIDERAR CANDIDATOS COM STATUS ELIMINADO*/
LEFT JOIN RHMEDI_FICHA_MED
ON RHPESS_CANDIDATO.CODIGO_EMPRESA                     = RHMEDI_FICHA_MED.CODIGO_EMPRESA
AND RHPESS_CANDIDATO.CODIGO                            = RHMEDI_FICHA_MED.CODIGO_CANDIDATO
AND RHPESS_CANDIDATO.CODIGO_EVENTO_SEL                 = RHMEDI_FICHA_MED.CODIGO_EVENTO_SEL
AND RHPESS_CANDIDATO.CODIGO_PESSOA                     = RHMEDI_FICHA_MED.CODIGO_PESSOA
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA           = RHMEDI_FICHA_MED.CODIGO_EMPRESA
AND TRUNC(SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA) = TRUNC(RHMEDI_FICHA_MED.DT_REG_OCORRENCIA)
AND RHMEDI_FICHA_MED.DT_REG_OCORRENCIA                 = TRUNC(RHPESS_CANDIDATO.DATA_CADASTRAMENTO)
AND RHMEDI_FICHA_MED.OCORRENCIA = (SELECT MAX(A.OCORRENCIA) FROM RHMEDI_FICHA_MED A WHERE
   RHMEDI_FICHA_MED.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND 
   RHMEDI_FICHA_MED.CODIGO_PESSOA = A.CODIGO_PESSOA AND 
   RHMEDI_FICHA_MED.DT_REG_OCORRENCIA= A.DT_REG_OCORRENCIA )
LEFT JOIN RHMEDI_CTRL_APTID
ON SUGESP_IMPORTACAO_ADM_PER.CTRL_APTIDAO       = RHMEDI_CTRL_APTID.CODIGO
LEFT JOIN RHSELE_EVENTO_SEL ON 
SUGESP_IMPORTACAO_ADM_PER.CODIGO_EVENTO_SEL     = RHSELE_EVENTO_SEL.CODIGO_EVENTO_SEL AND 
SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA        = RHSELE_EVENTO_SEL.CODIGO_EMPRESA
WHERE SUGESP_IMPORTACAO_ADM_PER.CPF             = VCPF_CAND
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_CANDIDATO  = VCANDIDATO
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_EVENTO_SEL = VCODIGO_EVENTO
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA    = VCODIGO_EMPRESA
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA = TRUNC(VDT_OCORRENCIA) --TO_DATE(VDT_OCORRENCIA,'DD/MM/YYYY')
AND SUGESP_IMPORTACAO_ADM_PER.DATA_CARGA        = TRUNC(VDATA_CARGA)
GROUP BY SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA, SUGESP_IMPORTACAO_ADM_PER.CPF, RHPESS_PESSOA.CODIGO, RHMEDI_FICHA_MED.CODIGO_CANDIDATO, RHMEDI_FICHA_MED.DT_REG_OCORRENCIA, 
RHMEDI_FICHA_MED.NATUREZA_EXAME, /*RHMEDI_FICHA_MED.OCORRENCIA,*/ RHMEDI_FICHA_MED.CODIGO_EVENTO_SEL, SUGESP_IMPORTACAO_ADM_PER.CTRL_APTIDAO, RHMEDI_CTRL_APTID.TP_RESULT_ASO_ESOCIAL,
RHSELE_EVENTO_SEL.COD_VINCULO, CASE WHEN RHMEDI_FICHA_MED.PARECER_MEDICO IS NULL THEN 'ATUALIZA' ELSE 'INSERE FICHA' END ,
CASE WHEN RHMEDI_FICHA_MED.PARECER_MEDICO IS NULL THEN RHMEDI_FICHA_MED.OCORRENCIA ELSE NVL(RHMEDI_FICHA_MED.OCORRENCIA,0)+1 END 
) LOOP

IF (C2.CODIGO IS NULL OR C2.DT_REG_OCORRENCIA IS NULL) AND C2.COD_VINCULO IN ('0001','0002') THEN 

DADOS_CAND.VERIFICA:= 0;
DADOS_CAND.CODIGO_EMPRESA := NULL;
DADOS_CAND.CODIGO_PESSOA := NULL;
DADOS_CAND.APTIDAO := NULL;
DADOS_CAND.OCORRENCIA:= NULL;
DADOS_CAND.NOME_ATENDENTE_ATENDENTE := NULL;
DADOS_CAND.INSCRICAO_CONSELHO_ATENDENTE := NULL;
DADOS_CAND.UF_CONSELHO_ATENDENTE := NULL;
DADOS_CAND.CODIGO_ATENDENTE := NULL;
DADOS_CAND.NATUREZA_EXAME := NULL;
DADOS_CAND.PROCEDIMENTO_CONDUTA := NULL;
DADOS_CAND.CONSELHO_REGIONAL_ATENDENTE := NULL;
DADOS_CAND.ACAO := NULL;

UPDATE SUGESP_IMPORTACAO_ADM_PER SET VERIFICA_PESSOA = 'NÃO ENCONTRADO', VERIFICA_CANDIDATO = 'NÃO ENCONTRADO', VERIFICA_DT_OCORR = 'NÃO ENCONTRADO'
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CPF  = C2.CPF AND DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND DATA_CARGA = TRUNC(VDATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(VDT_OCORRENCIA); COMMIT WORK;

END IF;

IF C2.CODIGO IS NOT NULL AND C2.DT_REG_OCORRENCIA IS NOT NULL  AND C2.COD_VINCULO IN ('0001','0002') THEN 

DADOS_CAND.VERIFICA:= 1;
DADOS_CAND.CODIGO_EMPRESA := C2.CODIGO_EMPRESA;
DADOS_CAND.CODIGO_PESSOA := C2.CODIGO;
DADOS_CAND.APTIDAO := C2.TP_RESULT_ASO_ESOCIAL;
DADOS_CAND.OCORRENCIA:= C2.NOVA_OCORRENCIA_FICHA;
DADOS_CAND.NOME_ATENDENTE_ATENDENTE := NULL;
DADOS_CAND.INSCRICAO_CONSELHO_ATENDENTE := NULL;
DADOS_CAND.UF_CONSELHO_ATENDENTE := NULL;
DADOS_CAND.CODIGO_ATENDENTE := NULL;
DADOS_CAND.NATUREZA_EXAME := NULL;
DADOS_CAND.PROCEDIMENTO_CONDUTA := NULL;
DADOS_CAND.CONSELHO_REGIONAL_ATENDENTE := NULL;
DADOS_CAND.ACAO := C2.ACAO ;

UPDATE SUGESP_IMPORTACAO_ADM_PER SET VERIFICA_PESSOA = 'ENCONTRADO', VERIFICA_CANDIDATO = 'ENCONTRADO', VERIFICA_DT_OCORR = 'ENCONTRADO'
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CPF  = C2.CPF AND DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND TRUNC(DATA_CARGA) = TRUNC(VDATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(VDT_OCORRENCIA); COMMIT WORK;

END IF;
IF C2.DT_REG_OCORRENCIA IS NOT NULL AND (C2.COD_VINCULO NOT IN ('0001','0002') OR C2.COD_VINCULO IS NULL) THEN 

UPDATE SUGESP_IMPORTACAO_ADM_PER SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO = 'NÃO', ANALISE_DADOS = 'NÃO É PERMITIDO O VINCULO DO CANDIDATO, MAS EXISTE FICHA ENTÃO ENTRE NO MODULO DA MEDICINA E REALIZE A EXCLUSÃO DA FICHA'
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CPF  = C2.CPF AND DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND DATA_CARGA = TRUNC(VDATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(VDT_OCORRENCIA); COMMIT WORK;

END IF;

IF C2.DT_REG_OCORRENCIA IS NULL AND (C2.COD_VINCULO NOT IN ('0001','0002') OR C2.COD_VINCULO IS NULL) THEN 

UPDATE SUGESP_IMPORTACAO_ADM_PER SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO = 'NÃO', ANALISE_DADOS = 'NÃO EXISTE FICHA E NÃO SERÁ IMPORTADO, POIS O VINCULO NÃO ESTA CONTEMPLADO'
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CPF  = C2.CPF AND DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND DATA_CARGA = TRUNC(VDATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(VDT_OCORRENCIA); COMMIT WORK;

END IF;
END LOOP;
RETURN DADOS_CAND; 

END;

/*A PROCEDURE PR_IMPORTA_EXAME ATUALIZA OU INSERE INFORMACOES NA TABELA RHMEDI_RL_FICH_EXA DE EXAMES NO MODULO DE MEDICINA*/
PROCEDURE PR_IMPORTA_EXAME (VCOD_EMPRESA_EXAME CHAR, VCPF_EXAME VARCHAR, VNUMERO_L_EXAME NUMBER, VDT_REG_EXAME DATE, VDATA_C_EXAME DATE, VCOD_PESS_EXAME VARCHAR, VCOD_EXAME VARCHAR, VOCORRENCIA_EXAME NUMBER,
VCODIGO_ATENDENTE CHAR, VNOME_ATENDENTE_ATENDENTE CHAR, VINSCRICAO_CONSELHO_ATENDENTE CHAR, VUF_CONSELHO_ATENDENTE CHAR, VCONSELHO_REGIONAL_ATENDENTE CHAR) AS
CONT NUMBER;
BEGIN
FOR A1 IN (
SELECT rank() over (PARTITION BY RHMEDI_EXAME.CODIGO ORDER BY SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA) rank,SUGESP_IMPORTACAO_ADM_PER.CPF, RHMEDI_RL_FICH_EXA.DT_REG_OCORRENCIA, 
RHMEDI_RL_FICH_EXA.CODIGO_EMPRESA, SUGESP_IMPORTACAO_ADM_PER.COD_EXAME, SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA,
RHMEDI_EXAME.CODIGO  AS CAD_EXAME, SUGESP_IMPORTACAO_ADM_PER.ANALISE_DADOS, SUGESP_IMPORTACAO_ADM_PER.C_LIVRE_VALOR01, SUGESP_IMPORTACAO_ADM_PER.DATA_REALIZACAO, 
SUGESP_IMPORTACAO_ADM_PER.RESULT_REFERENCIA, SUGESP_IMPORTACAO_ADM_PER.CODIGO_SEQUENCIAL, SUGESP_IMPORTACAO_ADM_PER.LOGIN_CARGA, RHMEDI_RL_FICH_EXA.OCORRENCIA,
SUGESP_IMPORTACAO_ADM_PER.CODIGO_CANDIDATO, SUGESP_IMPORTACAO_ADM_PER.NATUREZA_EXAME, SUGESP_IMPORTACAO_ADM_PER.CODIGO_EVENTO_SEL, RHMEDI_ITEM_EXAME.COD_ITEM_EXAME
FROM SUGESP_IMPORTACAO_ADM_PER
LEFT JOIN RHMEDI_RL_FICH_EXA
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA            = RHMEDI_RL_FICH_EXA.CODIGO_EMPRESA
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA        = TRUNC(RHMEDI_RL_FICH_EXA.DT_REG_OCORRENCIA)
AND SUGESP_IMPORTACAO_ADM_PER.COD_EXAME                = RHMEDI_RL_FICH_EXA.COD_EXAME
AND RHMEDI_RL_FICH_EXA.CODIGO_PESSOA                   = VCOD_PESS_EXAME
AND RHMEDI_RL_FICH_EXA.OCORRENCIA                      = VOCORRENCIA_EXAME
LEFT JOIN RHMEDI_EXAME
ON RHMEDI_EXAME.CODIGO                              = SUGESP_IMPORTACAO_ADM_PER.COD_EXAME
LEFT JOIN RHMEDI_ITEM_EXAME ON 
RHMEDI_ITEM_EXAME.COD_EXAME                         = RHMEDI_EXAME.CODIGO   
WHERE SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA      = VCOD_EMPRESA_EXAME
AND SUGESP_IMPORTACAO_ADM_PER.CPF                   = VCPF_EXAME
AND SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA          = VNUMERO_L_EXAME
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA     = TRUNC(VDT_REG_EXAME) --TO_DATE(VDT_REG_EXAME,'DD/MM/YYYY')
AND SUGESP_IMPORTACAO_ADM_PER.DATA_CARGA            = TRUNC(VDATA_C_EXAME)
AND SUGESP_IMPORTACAO_ADM_PER.COD_EXAME             = VCOD_EXAME
AND SUGESP_IMPORTACAO_ADM_PER.STATUS_PROCESSAMENTO IS NULL
AND SUGESP_IMPORTACAO_ADM_PER.DATA_PROCESSAMENTO   IS NULL
GROUP BY SUGESP_IMPORTACAO_ADM_PER.CPF, RHMEDI_RL_FICH_EXA.DT_REG_OCORRENCIA, RHMEDI_RL_FICH_EXA.CODIGO_EMPRESA, SUGESP_IMPORTACAO_ADM_PER.COD_EXAME, SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA,
RHMEDI_EXAME.CODIGO, SUGESP_IMPORTACAO_ADM_PER.ANALISE_DADOS, SUGESP_IMPORTACAO_ADM_PER.C_LIVRE_VALOR01, SUGESP_IMPORTACAO_ADM_PER.DATA_REALIZACAO, 
SUGESP_IMPORTACAO_ADM_PER.RESULT_REFERENCIA, SUGESP_IMPORTACAO_ADM_PER.CODIGO_SEQUENCIAL, SUGESP_IMPORTACAO_ADM_PER.LOGIN_CARGA, RHMEDI_RL_FICH_EXA.OCORRENCIA,
SUGESP_IMPORTACAO_ADM_PER.CODIGO_CANDIDATO, SUGESP_IMPORTACAO_ADM_PER.NATUREZA_EXAME, SUGESP_IMPORTACAO_ADM_PER.CODIGO_EVENTO_SEL, RHMEDI_ITEM_EXAME.COD_ITEM_EXAME
)LOOP

IF  A1.CAD_EXAME IS NULL THEN

UPDATE SUGESP_IMPORTACAO_ADM_PER SET ANALISE_DADOS = A1.ANALISE_DADOS||'- EXAME NÃO ENCONTRADO'
WHERE CODIGO_EMPRESA = VCOD_EMPRESA_EXAME AND CPF = VCPF_EXAME AND NUMERO_LINHA = VNUMERO_L_EXAME AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_EXAME) AND DATA_CARGA = TRUNC(VDATA_C_EXAME); COMMIT WORK;

END IF;


IF A1.DT_REG_OCORRENCIA IS NULL AND A1.CAD_EXAME IS NOT NULL THEN

INSERT INTO RHMEDI_RL_FICH_EXA (CODIGO_PESSOA,DT_REG_OCORRENCIA,OCORRENCIA,COD_EXAME,CODIGO_EMPRESA,C_LIVRE_VALOR01, DATA_REALIZACAO,COD_CLASSIFICACAO ,C_LIVRE_VALOR02,CODIGO_ATENDENTE,EMPRESA_ATENDENTE,INDIC_REFERENCIA,INDIC_OCUPACIONAL,AUTORIZA_INDRESUL,OBRIGATORIO_PCMSO,C_LIVRE_OPCAO01,C_LIVRE_OPCAO02,C_LIVRE_OPCAO03, LOGIN_USUARIO, DT_ULT_ALTER_USUA, NOME_DO_MEDICO, CRM, UF_CRM) 
VALUES (VCOD_PESS_EXAME, VDT_REG_EXAME, VOCORRENCIA_EXAME , VCOD_EXAME, VCOD_EMPRESA_EXAME, A1.C_LIVRE_VALOR01, A1.DATA_REALIZACAO, LPAD(A1.RESULT_REFERENCIA,4,0), A1.CODIGO_SEQUENCIAL, VCODIGO_ATENDENTE ,VCOD_EMPRESA_EXAME, 'N','N','N','N','N','N','N', A1.LOGIN_CARGA, SYSDATE, VNOME_ATENDENTE_ATENDENTE, VINSCRICAO_CONSELHO_ATENDENTE, VUF_CONSELHO_ATENDENTE );
COMMIT WORK;      

IF VCOD_EXAME = '0023' THEN
UPDATE RHMEDI_RL_FICH_EXA SET OBRIGATORIO_PCMSO = 'S' WHERE 
CODIGO_PESSOA = VCOD_PESS_EXAME AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_EXAME) AND OCORRENCIA = VOCORRENCIA_EXAME AND COD_EXAME = VCOD_EXAME AND CODIGO_EMPRESA = VCOD_EMPRESA_EXAME;
END IF;

IF A1.COD_ITEM_EXAME IS NOT NULL THEN 

INSERT INTO RHMEDI_RL_FI_IT_EX (CODIGO_EMPRESA, CODIGO_PESSOA, DT_REG_OCORRENCIA, OCORRENCIA, COD_EXAME, COD_ITEM_EXAME, COD_CLASSIFICACAO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, ORDEM, AUTORIZA_INDRESUL )  
VALUES  ( VCOD_EMPRESA_EXAME, VCOD_PESS_EXAME, VDT_REG_EXAME, VOCORRENCIA_EXAME , VCOD_EXAME, A1.COD_ITEM_EXAME, LPAD(A1.RESULT_REFERENCIA,4,0),  A1.LOGIN_CARGA, SYSDATE, '1','N'); COMMIT WORK;
END IF;
END IF;

IF A1.COD_EXAME = '0023' AND A1.CAD_EXAME IS NOT NULL THEN
UPDATE RHMEDI_FICHA_MED SET CODIGO_ATENDENTE = VCODIGO_ATENDENTE, NOME_ATENDENTE = VNOME_ATENDENTE_ATENDENTE, INSCRICAO_CONSELHO = VINSCRICAO_CONSELHO_ATENDENTE, UF_INSCRICAO = VUF_CONSELHO_ATENDENTE, CONSELHO_REGIONAL = VCONSELHO_REGIONAL_ATENDENTE, DATA_EFETIV_ATEND = TRUNC(A1.DATA_REALIZACAO) 
WHERE CODIGO_PESSOA = VCOD_PESS_EXAME AND CODIGO_CANDIDATO = A1.CODIGO_CANDIDATO AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_EXAME) AND NATUREZA_EXAME = A1.NATUREZA_EXAME AND OCORRENCIA = VOCORRENCIA_EXAME AND CODIGO_EMPRESA = VCOD_EMPRESA_EXAME AND CODIGO_EVENTO_SEL = A1.CODIGO_EVENTO_SEL; COMMIT WORK;

END IF;

IF A1.DT_REG_OCORRENCIA IS NOT NULL AND A1.COD_EXAME IS NOT NULL AND A1.CAD_EXAME IS NOT NULL THEN

UPDATE RHMEDI_RL_FICH_EXA SET 
C_LIVRE_VALOR01 = A1.C_LIVRE_VALOR01, DATA_REALIZACAO = TRUNC(A1.DATA_REALIZACAO) /*TO_DATE(A1.DATA_REALIZACAO,'DD/MM/YYYY')*/,COD_CLASSIFICACAO = LPAD(A1.RESULT_REFERENCIA,4,0) ,C_LIVRE_VALOR02 = A1.CODIGO_SEQUENCIAL, CODIGO_ATENDENTE = VCODIGO_ATENDENTE, EMPRESA_ATENDENTE = VCOD_EMPRESA_EXAME, INDIC_REFERENCIA = 'N', INDIC_OCUPACIONAL= 'N', AUTORIZA_INDRESUL= 'N', OBRIGATORIO_PCMSO= 'S', C_LIVRE_OPCAO01= 'N',C_LIVRE_OPCAO02= 'N',C_LIVRE_OPCAO03= 'N', LOGIN_USUARIO = A1.LOGIN_CARGA, DT_ULT_ALTER_USUA = SYSDATE,
NOME_DO_MEDICO = VNOME_ATENDENTE_ATENDENTE, CRM = VINSCRICAO_CONSELHO_ATENDENTE, UF_CRM = VUF_CONSELHO_ATENDENTE
WHERE CODIGO_PESSOA = VCOD_PESS_EXAME AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_EXAME) /*TO_DATE(VDT_REG_EXAME,'DD/MM/YYYY')*/ AND CODIGO_EMPRESA = VCOD_EMPRESA_EXAME AND OCORRENCIA = A1.OCORRENCIA AND COD_EXAME = VCOD_EXAME;
COMMIT WORK;

END IF;

END LOOP;

END;

/*A PROCEDURE PR_IMPORTA_CONDUTA ATUALIZA OU INSERE INFORMACOES NA TABELA RHMEDI_RL_FICH_PRO DE CONDUTA NO MODULO DE MEDICINA*/
PROCEDURE PR_IMPORTA_CONDUTA (VCOD_EMPRESA_CONDUTA CHAR, VCPF_CONDUTA VARCHAR, VNUMERO_L_CONDUTA NUMBER, VDT_REG_CONDUTA DATE, VDATA_C_CONDUTA DATE, VCOD_PESS_CONDUTA VARCHAR, VCODIGO_PROC_MED VARCHAR,
VOCORRENCIA_FICHA NUMBER) AS
CONT NUMBER;
BEGIN
FOR A2 IN (
SELECT SUGESP_IMPORTACAO_ADM_PER.CPF, RHMEDI_RL_FICH_PRO.DT_REG_OCORRENCIA, RHMEDI_RL_FICH_PRO.CODIGO_EMPRESA, SUGESP_IMPORTACAO_ADM_PER.CODIGO_PROC_MED, SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA,
RHMEDI_PROC_MED.CODIGO_PROC_MED AS CAD_CONDUTA, SUGESP_IMPORTACAO_ADM_PER.ANALISE_DADOS, SUGESP_IMPORTACAO_ADM_PER.C_LIVRE_VALOR01, SUGESP_IMPORTACAO_ADM_PER.CODIGO_SEQUENCIAL, 
SUGESP_IMPORTACAO_ADM_PER.LOGIN_CARGA
FROM SUGESP_IMPORTACAO_ADM_PER
LEFT JOIN RHMEDI_RL_FICH_PRO
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA            = RHMEDI_RL_FICH_PRO.CODIGO_EMPRESA
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA        = TRUNC(RHMEDI_RL_FICH_PRO.DT_REG_OCORRENCIA)
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_PROC_MED          = RHMEDI_RL_FICH_PRO.CODIGO_PROC_MED
AND RHMEDI_RL_FICH_PRO.CODIGO_PESSOA                   = VCOD_PESS_CONDUTA
AND RHMEDI_RL_FICH_PRO.OCORRENCIA                      = VOCORRENCIA_FICHA
LEFT JOIN RHMEDI_PROC_MED
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_PROC_MED        = RHMEDI_PROC_MED.CODIGO_PROC_MED
WHERE SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA      = VCOD_EMPRESA_CONDUTA
AND SUGESP_IMPORTACAO_ADM_PER.CPF                   = VCPF_CONDUTA
AND SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA          = VNUMERO_L_CONDUTA
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA     = TRUNC(VDT_REG_CONDUTA) --TO_DATE(VDT_REG_CONDUTA,'DD/MM/YYYY')
AND SUGESP_IMPORTACAO_ADM_PER.DATA_CARGA            = TRUNC(VDATA_C_CONDUTA)
AND SUGESP_IMPORTACAO_ADM_PER.CODIGO_PROC_MED       = VCODIGO_PROC_MED
AND SUGESP_IMPORTACAO_ADM_PER.STATUS_PROCESSAMENTO IS NULL
AND SUGESP_IMPORTACAO_ADM_PER.DATA_PROCESSAMENTO   IS NULL
)LOOP

IF A2.CAD_CONDUTA IS NULL THEN

UPDATE SUGESP_IMPORTACAO_ADM_PER SET ANALISE_DADOS = A2.ANALISE_DADOS||'- CONDUTA NÃO ENCONTRADA'
WHERE CODIGO_EMPRESA = VCOD_EMPRESA_CONDUTA AND CPF = VCPF_CONDUTA AND NUMERO_LINHA = VNUMERO_L_CONDUTA AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_CONDUTA) AND DATA_CARGA = TRUNC(VDATA_C_CONDUTA); COMMIT WORK;

END IF;

IF A2.DT_REG_OCORRENCIA IS NULL AND A2.CAD_CONDUTA IS NOT NULL THEN

INSERT INTO RHMEDI_RL_FICH_PRO (C_LIVRE_VALOR01,CODIGO_EMPRESA,CODIGO_PESSOA,DT_REG_OCORRENCIA,CODIGO_PROC_MED,OCORRENCIA,OCOR_PROC_MED,LOGIN_USUARIO,DT_ULT_ALTER_USUA,C_LIVRE_OPCAO01,C_LIVRE_VALOR02,C_LIVRE_OPCAO02,C_LIVRE_OPCAO03) 
VALUES(A2.C_LIVRE_VALOR01, VCOD_EMPRESA_CONDUTA, VCOD_PESS_CONDUTA, TRUNC(VDT_REG_CONDUTA), A2.CODIGO_PROC_MED, VOCORRENCIA_FICHA,(SELECT NVL(MAX(OCOR_PROC_MED),0)+1  FROM RHMEDI_RL_FICH_PRO WHERE CODIGO_PESSOA = VCOD_PESS_CONDUTA AND CODIGO_EMPRESA = VCOD_EMPRESA_CONDUTA AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_CONDUTA) AND OCORRENCIA = VOCORRENCIA_FICHA AND CODIGO_PROC_MED = A2.CODIGO_PROC_MED), A2.LOGIN_CARGA, SYSDATE,'N', A2.CODIGO_SEQUENCIAL,'N','N');
COMMIT WORK;

END IF;

IF A2.DT_REG_OCORRENCIA IS NOT NULL AND A2.CODIGO_PROC_MED IS NOT NULL AND A2.CAD_CONDUTA IS NOT NULL THEN

UPDATE RHMEDI_RL_FICH_PRO SET C_LIVRE_VALOR01 = A2.C_LIVRE_VALOR01, LOGIN_USUARIO = A2.LOGIN_CARGA, DT_ULT_ALTER_USUA = SYSDATE, C_LIVRE_OPCAO01 = 'N', C_LIVRE_VALOR02 = A2.CODIGO_SEQUENCIAL, C_LIVRE_OPCAO02 = 'N', C_LIVRE_OPCAO03 = 'N'
WHERE CODIGO_PESSOA = VCOD_PESS_CONDUTA AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_CONDUTA) AND OCORRENCIA = VOCORRENCIA_FICHA AND CODIGO_PROC_MED = A2.CODIGO_PROC_MED AND CODIGO_EMPRESA = VCOD_EMPRESA_CONDUTA; COMMIT WORK;

END IF;

END LOOP;

END;

/*A PROCEDURE PR_IMPORTA_DOENCA ATUALIZA OU INSERE INFORMACOES NA TABELA RHMEDI_RL_FICH_DOE DE DOENCA NO MODULO DE MEDICINA*/
PROCEDURE PR_IMPORTA_DOENCA (VCOD_EMPRESA_DOENCA CHAR, VCPF_DOENCA VARCHAR, VNUMERO_L_DOENCA NUMBER, VDT_REG_DOENCA DATE, VDATA_C_DOENCA DATE, VCOD_PESS_DOENCA VARCHAR, VCOD_DOENCA VARCHAR,
VOCORRENCIA_DOENCA NUMBER) AS
CONT NUMBER;
BEGIN
FOR A3 IN (
SELECT SUGESP_IMPORTACAO_ADM_PER.CPF, RHMEDI_RL_FICH_DOE.DT_REG_OCORRENCIA, RHMEDI_RL_FICH_DOE.CODIGO_EMPRESA, SUGESP_IMPORTACAO_ADM_PER.COD_DOENCA AS DOENCA_IMP, SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA,
RHMEDI_DOENCA.CODIGO AS CAD_DOENCA, SUGESP_IMPORTACAO_ADM_PER.ANALISE_DADOS, SUGESP_IMPORTACAO_ADM_PER.LOGIN_CARGA, SUGESP_IMPORTACAO_ADM_PER.DOENCA_TRABALHO, RHMEDI_FICHA_MED.OCORRENCIA OCORRENCIA_FICHA,
RHMEDI_RL_FICH_DOE.COD_DOENCA AS DOENCA_FICHA
FROM SUGESP_IMPORTACAO_ADM_PER
LEFT JOIN RHMEDI_FICHA_MED ON 
RHMEDI_FICHA_MED.CODIGO_EMPRESA                        = SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA AND
RHMEDI_FICHA_MED.CODIGO_PESSOA                         = SUGESP_IMPORTACAO_ADM_PER.CODIGO_PESSOA_ENCONTRADO AND 
RHMEDI_FICHA_MED.DT_REG_OCORRENCIA                     = TRUNC(SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA) AND
RHMEDI_FICHA_MED.OCORRENCIA                            = VOCORRENCIA_DOENCA
LEFT JOIN RHMEDI_RL_FICH_DOE
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA            = RHMEDI_RL_FICH_DOE.CODIGO_EMPRESA
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA        = TRUNC(RHMEDI_RL_FICH_DOE.DT_REG_OCORRENCIA)
--AND SUGESP_IMPORTACAO_ADM_PER.COD_DOENCA               = RHMEDI_RL_FICH_DOE.COD_DOENCA
AND RHMEDI_RL_FICH_DOE.CODIGO_PESSOA                   = VCOD_PESS_DOENCA AND
RHMEDI_FICHA_MED.CODIGO_EMPRESA                        = RHMEDI_RL_FICH_DOE.CODIGO_EMPRESA AND
RHMEDI_FICHA_MED.CODIGO_PESSOA                         = RHMEDI_RL_FICH_DOE.CODIGO_PESSOA AND 
RHMEDI_FICHA_MED.DT_REG_OCORRENCIA                     = TRUNC(RHMEDI_RL_FICH_DOE.DT_REG_OCORRENCIA)AND 
RHMEDI_FICHA_MED.OCORRENCIA                            = RHMEDI_RL_FICH_DOE.OCORRENCIA
AND RHMEDI_RL_FICH_DOE.OCORRENCIA                      = VOCORRENCIA_DOENCA
LEFT JOIN RHMEDI_DOENCA
ON SUGESP_IMPORTACAO_ADM_PER.COD_DOENCA                = RHMEDI_DOENCA.CODIGO
WHERE SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA         = VCOD_EMPRESA_DOENCA
AND SUGESP_IMPORTACAO_ADM_PER.CPF                      = VCPF_DOENCA
AND SUGESP_IMPORTACAO_ADM_PER.NUMERO_LINHA             = VNUMERO_L_DOENCA
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA        = TRUNC(VDT_REG_DOENCA) --TO_DATE(VDT_REG_DOENCA,'DD/MM/YYYY')
AND TRUNC(SUGESP_IMPORTACAO_ADM_PER.DATA_CARGA)        = TRUNC(VDATA_C_DOENCA)
AND SUGESP_IMPORTACAO_ADM_PER.COD_DOENCA               = VCOD_DOENCA
AND SUGESP_IMPORTACAO_ADM_PER.STATUS_PROCESSAMENTO IS NULL
AND SUGESP_IMPORTACAO_ADM_PER.DATA_PROCESSAMENTO   IS NULL

)LOOP

IF A3.CAD_DOENCA IS NULL THEN 

UPDATE SUGESP_IMPORTACAO_ADM_PER SET ANALISE_DADOS = A3.ANALISE_DADOS||'- DOENÇA NÃO ENCONTRADA'
WHERE CODIGO_EMPRESA = VCOD_EMPRESA_DOENCA AND CPF = VCPF_DOENCA AND NUMERO_LINHA = VNUMERO_L_DOENCA AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_DOENCA) AND DATA_CARGA = TRUNC(VDATA_C_DOENCA);
COMMIT WORK;

END IF;

IF A3.CAD_DOENCA IS NOT NULL AND (A3.DOENCA_FICHA IS NULL OR (A3.DOENCA_FICHA IS NOT NULL AND A3.DOENCA_FICHA <> A3.DOENCA_IMP)) THEN

INSERT INTO RHMEDI_RL_FICH_DOE (CODIGO_EMPRESA,CODIGO_PESSOA,DT_REG_OCORRENCIA,OCORRENCIA,LOGIN_USUARIO,COD_DOENCA,DT_ULT_ALTER_USUA,OCOR_DOENCA,C_LIVRE_OPCAO01,C_LIVRE_OPCAO02,C_LIVRE_OPCAO03,DOENCA_TRABALHO)
VALUES (VCOD_EMPRESA_DOENCA, VCOD_PESS_DOENCA,TRUNC(VDT_REG_DOENCA),VOCORRENCIA_DOENCA, A3.LOGIN_CARGA, VCOD_DOENCA, SYSDATE, (SELECT NVL(MAX(OCOR_DOENCA),0)+1 FROM RHMEDI_RL_FICH_DOE WHERE CODIGO_EMPRESA = VCOD_EMPRESA_DOENCA AND CODIGO_PESSOA = VCOD_PESS_DOENCA AND DT_REG_OCORRENCIA = TRUNC(VDT_REG_DOENCA) AND OCORRENCIA = VOCORRENCIA_DOENCA /*AND COD_DOENCA = VCOD_DOENCA*/),'N','N','N',A3.DOENCA_TRABALHO);
COMMIT WORK;

END IF;

END LOOP;

END;

/*A PROCEDURE PR_IMPORTA_DEFICIENCIA ATUALIZA O CADASTRO DE PESSOA CASO O CANDIDATO TENHA DEFICIENCIA PRINCIPAL E INSERE INFORMACOES NA TABELA RHPESS_PESSOA_DEFICIENCIA DE 
DEFICIENCIA NO MODULO DE BANCO DE DADOS > PESSOA*/
PROCEDURE PR_IMPORTA_DEFICIENCIA (VCOD_EMPRESA_DEF CHAR, VCPF_DEF VARCHAR, VNUMERO_L_DEF NUMBER, VDT_REG_DEF DATE, VDATA_C_DEF DATE, VCOD_PESSOA VARCHAR) AS
CONT NUMBER;
BEGIN
FOR A4 IN (
SELECT SUGESP_IMPORTACAO_ADM_PER.CPF, SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA, SUGESP_IMPORTACAO_ADM_PER.COD_DEFICIENCIA_1,
SUGESP_IMPORTACAO_ADM_PER.COD_DEFICIENCIA_PRINCIPAL, RHPESS_PESSOA.CODIGO_EMPRESA, RHPESS_PESSOA.COD_DEFICIENCIA,  
RHPESS_PESSOA_DEFICIENCIA.COD_DEFICIENCIA AS DEFICIENCIA, SUGESP_IMPORTACAO_ADM_PER.LOGIN_CARGA, SUGESP_IMPORTACAO_ADM_PER.DATA_ASO
FROM SUGESP_IMPORTACAO_ADM_PER
LEFT JOIN RHPESS_PESSOA
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA  = RHPESS_PESSOA.CODIGO_EMPRESA
AND LPAD(SUGESP_IMPORTACAO_ADM_PER.CPF,11,0) = RHPESS_PESSOA.CPF
AND RHPESS_PESSOA.CODIGO                     = VCOD_PESSOA
LEFT JOIN RHPESS_PESSOA_DEFICIENCIA
ON SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA         = RHPESS_PESSOA_DEFICIENCIA.CODIGO_EMPRESA
AND RHPESS_PESSOA.CODIGO                            = RHPESS_PESSOA_DEFICIENCIA.CODIGO_PESSOA
WHERE SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA      = VCOD_EMPRESA_DEF
AND SUGESP_IMPORTACAO_ADM_PER.CPF                   = VCPF_DEF
AND SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA     = TRUNC(VDT_REG_DEF) --TO_DATE(VDT_REG_DEF,'DD/MM/YYYY')
AND TRUNC(SUGESP_IMPORTACAO_ADM_PER.DATA_CARGA)     = TRUNC(VDATA_C_DEF)
AND SUGESP_IMPORTACAO_ADM_PER.STATUS_PROCESSAMENTO IS NULL
AND SUGESP_IMPORTACAO_ADM_PER.DATA_PROCESSAMENTO   IS NULL
GROUP BY SUGESP_IMPORTACAO_ADM_PER.CPF, SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA, SUGESP_IMPORTACAO_ADM_PER.COD_DEFICIENCIA_1,
SUGESP_IMPORTACAO_ADM_PER.COD_DEFICIENCIA_PRINCIPAL,RHPESS_PESSOA.CODIGO_EMPRESA, RHPESS_PESSOA.COD_DEFICIENCIA, RHPESS_PESSOA_DEFICIENCIA.COD_DEFICIENCIA , SUGESP_IMPORTACAO_ADM_PER.LOGIN_CARGA, SUGESP_IMPORTACAO_ADM_PER.DATA_ASO

)LOOP

IF A4.COD_DEFICIENCIA_PRINCIPAL IS NOT NULL THEN

UPDATE RHPESS_PESSOA SET COD_DEFICIENCIA = A4.COD_DEFICIENCIA_PRINCIPAL, LOGIN_USUARIO = A4.LOGIN_CARGA, DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO = VCOD_PESSOA AND CODIGO_EMPRESA = VCOD_EMPRESA_DEF; COMMIT WORK;

END IF;

IF A4.COD_DEFICIENCIA_1 IS NOT NULL AND A4.DEFICIENCIA IS NULL THEN

INSERT INTO RHPESS_PESSOA_DEFICIENCIA (COD_DEFICIENCIA,CODIGO_EMPRESA,CODIGO_PESSOA,DATA_INICIO,DT_ULT_ALTER_USUA,ID,LOGIN_USUARIO) VALUES (A4.COD_DEFICIENCIA_1, VCOD_EMPRESA_DEF, VCOD_PESSOA, A4.DATA_ASO, SYSDATE, (SELECT NVL(MAX(ID),0)+1 AS ID FROM RHPESS_PESSOA_DEFICIENCIA ),A4.LOGIN_CARGA);
COMMIT WORK;

END IF;
END LOOP;
END;

BEGIN
DBMS_OUTPUT.ENABLE (buffer_size => NULL);
select MIN(NUMERO_LINHA) INTO LINHA from SUGESP_IMPORTACAO_ADM_PER 
WHERE CPF = aCPF AND DATA_CARGA = TRUNC(aDATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(aDT_REG_OCORRENCIA) AND CODIGO_EMPRESA = aCODIGO_EMPRESA AND NATUREZA_EXAME = aNATUREZA_EXAME AND STATUS_PROCESSAMENTO IS NULL AND DATA_PROCESSAMENTO IS NULL;
--dbms_output.put_line('NUMERO_LINHA - '||LINHA);

FOR C1 IN (
SELECT 
C_LIVRE_VALOR01,
CODIGO_EMPRESA,
TIPO_CONTRATO,
CODIGO_CONTRATO,
CPF,
DT_REG_OCORRENCIA,
NATUREZA_EXAME,
CODIGO_ATENDENTE,
PESO,
ALTURA,
TEMPERATURA,
PULSO,
PRESSAO,
INDICE_MASSA_CORP,
TEXTO02,
COD_DOENCA,
DOENCA_TRABALHO,
CODIGO_PROC_MED,
COD_EXAME,
DATA_REALIZACAO,
RESULT_REFERENCIA,
CTRL_APTIDAO,
COD_DEFICIENCIA_1,
COD_DEFICIENCIA_PRINCIPAL,
DATA_ASO,
TEXTO_ASSOCIADO,
CODIGO_CANDIDATO,
CODIGO_EVENTO_SEL,
CODIGO_SEQUENCIAL,
STATUS_PROCESSAMENTO,
DATA_PROCESSAMENTO,
DATA_CARGA,
LOGIN_CARGA,
ANALISE_DADOS,
VERIFICA_PESSOA,
VERIFICA_DT_OCORR,
VERIFICA_CANDIDATO,
NUMERO_LINHA,
VERIFICA_ATENDENTE,
VERIFICA_CONTRATO,
ANALISA_FICHA,
CODIGO_PESSOA_ENCONTRADO,
ANALISE_DEFICIENCIA,
TEXTO03,
TEXTO05
FROM SUGESP_IMPORTACAO_ADM_PER
WHERE STATUS_PROCESSAMENTO IS NULL AND DATA_PROCESSAMENTO IS NULL
                                   AND DATA_CARGA = (SELECT MAX (A.DATA_CARGA)
                                                     FROM SUGESP_IMPORTACAO_ADM_PER A
                                                     WHERE A.CPF = SUGESP_IMPORTACAO_ADM_PER.CPF AND
                                                           A.CODIGO_EMPRESA = SUGESP_IMPORTACAO_ADM_PER.CODIGO_EMPRESA AND
                                                           A.DT_REG_OCORRENCIA = SUGESP_IMPORTACAO_ADM_PER.DT_REG_OCORRENCIA )
AND NATUREZA_EXAME    = aNATUREZA_EXAME 
AND CODIGO_EMPRESA    = aCODIGO_EMPRESA 
AND CPF               = aCPF
AND DT_REG_OCORRENCIA = TRUNC(aDT_REG_OCORRENCIA) 
AND DATA_CARGA        = TRUNC(aDATA_CARGA)
ORDER BY NATUREZA_EXAME, CPF, DATA_CARGA, NUMERO_LINHA

)

LOOP
--dbms_output.put_line('C1.NUMERO_LINHA INICIO DO LOOP: '||C1.NUMERO_LINHA);
IF C1.CODIGO_CANDIDATO IS NULL OR C1.CODIGO_EVENTO_SEL IS NULL THEN

UPDATE SUGESP_IMPORTACAO_ADM_PER SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO = 'NÃO', ANALISE_DADOS = C1.ANALISE_DADOS||' - VERIFIQUE SE O CODIGO_CANDIDATO OU CODIGO_EVENTO_SEL ESTÃO PREENCHIDOS'
WHERE DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND CPF  = C1.CPF AND DATA_CARGA = TRUNC(C1.DATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(C1.DT_REG_OCORRENCIA); COMMIT WORK;

END IF;

IF C1.NUMERO_LINHA = LINHA THEN 
ANALISA_FICHA := ANALISA_FICHA_MEDICA (C1.CPF, C1.CODIGO_CANDIDATO, C1.DT_REG_OCORRENCIA, C1.CODIGO_EMPRESA, C1.CODIGO_EVENTO_SEL, C1.DATA_CARGA);
END IF;

IF ANALISA_FICHA.VERIFICA = 1 AND aCODIGO_ATENDENTE IS NOT NULL AND C1.DATA_PROCESSAMENTO IS NULL AND C1.STATUS_PROCESSAMENTO IS NULL THEN

/*SE O CONTROLE DE APTIDAO FOR IGUAL A APTO OU INAPTO IRÁ ATUALIZAR A DATA DO ASO*/
IF ANALISA_FICHA.APTIDAO IN ('1','2') AND ANALISA_FICHA.ACAO = 'ATUALIZA' AND C1.NUMERO_LINHA = LINHA THEN 

--dbms_output.put_line('1.1 UPDATE FICHA: '||C1.CODIGO_EMPRESA||'-'||C1.CPF||'-'||C1.NUMERO_LINHA||'-'||C1.DT_REG_OCORRENCIA);
UPDATE RHMEDI_FICHA_MED SET C_LIVRE_VALOR01 = C1.C_LIVRE_VALOR01, PESO = C1.PESO, EMPRESA_ATENDENTE = C1.CODIGO_EMPRESA, PULSO = C1.PULSO, ALTURA = C1.ALTURA, PRESSAO = C1.PRESSAO, INDICE_MASSA_CORP = C1.INDICE_MASSA_CORP, TEMPERATURA = C1.TEMPERATURA, TEXTO02 = C1.TEXTO02, PARECER_MEDICO = C1.CTRL_APTIDAO, DATA_ASO = C1.DATA_ASO, TEXTO_ASSOCIADO = C1.TEXTO_ASSOCIADO, LOCAL_ATENDIMENTO = C1.CODIGO_SEQUENCIAL, LOGIN_USUARIO = C1.LOGIN_CARGA, DT_ULT_ALTER_USUA = SYSDATE, ORIGEM_ASO ='E', COD_MUNICIPIO_ASO = '000000000000010'
WHERE CODIGO_PESSOA = ANALISA_FICHA.CODIGO_PESSOA AND CODIGO_CANDIDATO = C1.CODIGO_CANDIDATO AND DT_REG_OCORRENCIA = TRUNC(C1.DT_REG_OCORRENCIA) AND NATUREZA_EXAME = C1.NATUREZA_EXAME AND OCORRENCIA = ANALISA_FICHA.OCORRENCIA AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND CODIGO_EVENTO_SEL = C1.CODIGO_EVENTO_SEL;
COMMIT WORK;

END IF;

/*SE O CONTROLE DE APTIDAO FOR DIFERENTE DE APTO OU INAPTO NÃO IRÁ ATUALIZAR A DATA DO ASO*/
IF ANALISA_FICHA.APTIDAO NOT IN ('1','2') AND ANALISA_FICHA.ACAO = 'ATUALIZA' AND C1.NUMERO_LINHA = LINHA THEN 
--dbms_output.put_line('1.1 UPDATE FICHA: '||C1.CODIGO_EMPRESA||'-'||C1.CPF||'-'||C1.NUMERO_LINHA||'-'||C1.DT_REG_OCORRENCIA);
UPDATE RHMEDI_FICHA_MED SET C_LIVRE_VALOR01 = C1.C_LIVRE_VALOR01, PESO = C1.PESO, EMPRESA_ATENDENTE = C1.CODIGO_EMPRESA, PULSO = C1.PULSO, ALTURA = C1.ALTURA, PRESSAO = C1.PRESSAO, INDICE_MASSA_CORP = C1.INDICE_MASSA_CORP, TEMPERATURA = C1.TEMPERATURA, TEXTO02 = C1.TEXTO02, PARECER_MEDICO = C1.CTRL_APTIDAO,TEXTO_ASSOCIADO = C1.TEXTO_ASSOCIADO, LOCAL_ATENDIMENTO = C1.CODIGO_SEQUENCIAL, LOGIN_USUARIO = C1.LOGIN_CARGA, DT_ULT_ALTER_USUA = SYSDATE, TEXTO03 = C1.TEXTO03, TEXTO05 = C1.TEXTO05
WHERE CODIGO_PESSOA = ANALISA_FICHA.CODIGO_PESSOA AND CODIGO_CANDIDATO = C1.CODIGO_CANDIDATO AND DT_REG_OCORRENCIA = TRUNC(C1.DT_REG_OCORRENCIA) AND NATUREZA_EXAME = C1.NATUREZA_EXAME AND OCORRENCIA = ANALISA_FICHA.OCORRENCIA AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND CODIGO_EVENTO_SEL = C1.CODIGO_EVENTO_SEL;
COMMIT WORK;
END IF;

IF ANALISA_FICHA.APTIDAO IN ('1','2') AND ANALISA_FICHA.ACAO = 'INSERE FICHA' AND C1.NUMERO_LINHA = LINHA THEN  
--dbms_output.put_line('1.0 INSERE FICHA: '||C1.CODIGO_EMPRESA||'-'||C1.CPF||'-'||C1.NUMERO_LINHA||'-'||C1.DT_REG_OCORRENCIA||'-'||ANALISA_FICHA.OCORRENCIA||'- NUMERO LINHA:'||LINHA);
Insert into RHMEDI_FICHA_MED (CODIGO_PESSOA,DT_REG_OCORRENCIA,OCORRENCIA,CODIGO_EMPRESA,NATUREZA_EXAME,LOGIN_USUARIO,DT_ULT_ALTER_USUA,CODIGO_EVENTO_SEL,CODIGO_CANDIDATO,C_LIVRE_VALOR01, PESO, EMPRESA_ATENDENTE , PULSO, ALTURA, PRESSAO, INDICE_MASSA_CORP , TEMPERATURA , TEXTO02 , PARECER_MEDICO , DATA_ASO, TEXTO_ASSOCIADO ,LOCAL_ATENDIMENTO,ORIGEM_ASO, COD_MUNICIPIO_ASO )
                      values (ANALISA_FICHA.CODIGO_PESSOA,to_date(C1.DT_REG_OCORRENCIA,'DD/MM/YYYY'),ANALISA_FICHA.OCORRENCIA,C1.CODIGO_EMPRESA,C1.NATUREZA_EXAME,C1.LOGIN_CARGA,sysdate,C1.CODIGO_EVENTO_SEL,C1.CODIGO_CANDIDATO,C1.C_LIVRE_VALOR01, C1.PESO, C1.CODIGO_EMPRESA, C1.PULSO, C1.ALTURA, C1.PRESSAO, C1.INDICE_MASSA_CORP, C1.TEMPERATURA, C1.TEXTO02, C1.CTRL_APTIDAO, C1.DATA_ASO,C1.TEXTO_ASSOCIADO, C1.CODIGO_SEQUENCIAL, 'E', '000000000000010'); COMMIT WORK;
END IF;

/*SE O CONTROLE DE APTIDAO FOR DIFERENTE DE APTO OU INAPTO NÃO IRÁ ATUALIZAR A DATA DO ASO*/
IF ANALISA_FICHA.APTIDAO NOT IN ('1','2') AND ANALISA_FICHA.ACAO = 'INSERE FICHA' AND C1.NUMERO_LINHA = LINHA THEN 
--dbms_output.put_line('1.1 INSERE FICHA: '||C1.CODIGO_EMPRESA||'-'||C1.CPF||'-'||C1.NUMERO_LINHA||'-'||C1.DT_REG_OCORRENCIA||'-'||ANALISA_FICHA.OCORRENCIA||'- NUMERO LINHA:'||LINHA);
Insert into RHMEDI_FICHA_MED (CODIGO_PESSOA,DT_REG_OCORRENCIA,OCORRENCIA,CODIGO_EMPRESA,NATUREZA_EXAME,LOGIN_USUARIO,DT_ULT_ALTER_USUA,CODIGO_EVENTO_SEL,CODIGO_CANDIDATO,C_LIVRE_VALOR01, PESO, EMPRESA_ATENDENTE , PULSO, ALTURA, PRESSAO , INDICE_MASSA_CORP , TEMPERATURA , TEXTO02 , PARECER_MEDICO ,TEXTO_ASSOCIADO, LOCAL_ATENDIMENTO, TEXTO03 , TEXTO05) 
                      values (ANALISA_FICHA.CODIGO_PESSOA,to_date(C1.DT_REG_OCORRENCIA,'DD/MM/RRRR'),ANALISA_FICHA.OCORRENCIA,C1.CODIGO_EMPRESA,C1.NATUREZA_EXAME,C1.LOGIN_CARGA,sysdate,C1.CODIGO_EVENTO_SEL,C1.CODIGO_CANDIDATO,C1.C_LIVRE_VALOR01, C1.PESO, C1.CODIGO_EMPRESA, C1.PULSO, C1.ALTURA, C1.PRESSAO, C1.INDICE_MASSA_CORP, C1.TEMPERATURA, C1.TEXTO02, C1.CTRL_APTIDAO,C1.TEXTO_ASSOCIADO, C1.CODIGO_SEQUENCIAL, C1.TEXTO03, C1.TEXTO05); COMMIT WORK;
END IF;

PR_IMPORTA_EXAME (C1.CODIGO_EMPRESA, C1.CPF, C1.NUMERO_LINHA, C1.DT_REG_OCORRENCIA, C1.DATA_CARGA, ANALISA_FICHA.CODIGO_PESSOA, C1.COD_EXAME, ANALISA_FICHA.OCORRENCIA, aCODIGO_ATENDENTE, aNOME_ATENDENTE_ATENDENTE, aINSCRICAO_CONSELHO_ATENDENTE, aUF_CONSELHO_ATENDENTE, aCONSELHO_REGIONAL_ATENDENTE);
PR_IMPORTA_CONDUTA (C1.CODIGO_EMPRESA, C1.CPF, C1.NUMERO_LINHA , C1.DT_REG_OCORRENCIA, C1.DATA_CARGA, ANALISA_FICHA.CODIGO_PESSOA, C1.CODIGO_PROC_MED,  ANALISA_FICHA.OCORRENCIA);
PR_IMPORTA_DOENCA (C1.CODIGO_EMPRESA, C1.CPF, C1.NUMERO_LINHA, C1.DT_REG_OCORRENCIA, C1.DATA_CARGA, ANALISA_FICHA.CODIGO_PESSOA, C1.COD_DOENCA, ANALISA_FICHA.OCORRENCIA);
PR_IMPORTA_DEFICIENCIA (C1.CODIGO_EMPRESA, C1.CPF, C1.NUMERO_LINHA, C1.DT_REG_OCORRENCIA, C1.DATA_CARGA, ANALISA_FICHA.CODIGO_PESSOA);


UPDATE SUGESP_IMPORTACAO_ADM_PER SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO = 'SIM' WHERE DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND 
CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND CPF  = C1.CPF AND DATA_CARGA = TRUNC(C1.DATA_CARGA) AND NUMERO_LINHA = C1.NUMERO_LINHA AND DT_REG_OCORRENCIA = TRUNC(C1.DT_REG_OCORRENCIA);
END IF;


/*SE A FICHA MEDICA JUNTAMENTE COM A DE CANDIDATO E PESSOA ESTIVEREM INCORRETO E/OU O CODIGO DE ATENDENTE NÃO FOR ENCONTRADO, NÃO SERÁ IMPORTADO AS INFORMACOES */
IF (ANALISA_FICHA.VERIFICA = 0 OR aCODIGO_ATENDENTE IS NULL) AND C1.DATA_PROCESSAMENTO IS NULL AND C1.STATUS_PROCESSAMENTO IS NULL THEN

UPDATE SUGESP_IMPORTACAO_ADM_PER SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO = 'NÃO' WHERE DATA_PROCESSAMENTO IS NULL AND STATUS_PROCESSAMENTO IS NULL AND 
CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND CPF  = C1.CPF AND DATA_CARGA = TRUNC(C1.DATA_CARGA) AND DT_REG_OCORRENCIA = TRUNC(C1.DT_REG_OCORRENCIA);

END IF;


END LOOP;

END;
/*BEGIN 
   EXECUTE IMMEDIATE 'ALTER SESSION SET NLS_DATE_FORMAT = ''YYYY/MM/DD'''; 
END;*/

END IMPORTACAO_ADM_PER;