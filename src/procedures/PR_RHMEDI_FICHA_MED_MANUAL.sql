
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_RHMEDI_FICHA_MED_MANUAL" ( TABELA IN VARCHAR2, CODIGO_EMPRESA IN VARCHAR2, CODIGO_PESSOA IN VARCHAR2,  DATA_OCORRENCIA IN VARCHAR2, OCORRENCIA IN NUMBER , ORIGEM IN VARCHAR2, ID_EXTERNO IN NUMBER) AS 
--KELLYSSON 27/8/19

BEGIN-- 1Ã‚Âº BEGIN
DBMS_OUTPUT.ENABLE(NULL);



DECLARE
VTABELA VARCHAR2(30);
VCODIGO_EMPRESA VARCHAR2(4);
VCODIGO_PESSOA VARCHAR2(15);
VDATA_OCORRENCIA VARCHAR2(8);
VOCORRENCIA NUMBER;
VORIGEM VARCHAR2 (1);
VID_EXTERNO NUMBER;

VID NUMBER;
VTIPO_DML VARCHAR2(1);
VDT_REG_OCORRENCIA DATE;
VTIPO_CONTRATO VARCHAR2(4);
VCODIGO_CONTRATO VARCHAR2(15);
VNEW_COD_SIT_FUNCIONAL VARCHAR2(4);
VOLD_COD_SIT_FUNCIONAL VARCHAR2(4);
VNEW_NATUREZA_EXAME VARCHAR2(4);
VOLD_NATUREZA_EXAME VARCHAR2(4);
VNEW_DATA_INI_AFAST DATE;
VOLD_DATA_INI_AFAST DATE;
VNEW_DATA_FIM_AFAST DATE;
VOLD_DATA_FIM_AFAST DATE;
VNEW_DATA_INICIAL_INDEFERIMENT DATE;
VOLD_DATA_INICIAL_INDEFERIMENT DATE;
VNEW_DATA_FINAL_INDEFERIMENTO DATE;
VOLD_DATA_FINAL_INDEFERIMENTO DATE;
VNEW_OCOR_PROC_MED NUMBER;
VOLD_OCOR_PROC_MED NUMBER;
VNEW_CODIGO_PROC_MED VARCHAR2(15);
VOLD_CODIGO_PROC_MED VARCHAR2(15);
VNEW_OCOR_DOENCA NUMBER;
VOLD_OCOR_DOENCA NUMBER;
VNEW_COD_DOENCA VARCHAR2(15);
VOLD_COD_DOENCA VARCHAR2(15);
VDT_ULT_ALTER_USUA DATE;
VLOGIN_USUARIO VARCHAR2(40);
VLOGIN_OS VARCHAR2(40);
VDADO_ORIGEM_TC1 VARCHAR2(80);
VDADO_DESTINO_TC1 VARCHAR2(80);
VDADO_ORIGEM_TC2 VARCHAR2(80);
VDADO_DESTINO_TC2 VARCHAR2(80);
VDADO_ORIGEM_TC3 VARCHAR2(80);
VDADO_DESTINO_TC3 VARCHAR2(80);
VFAZER VARCHAR2(100);
VNEW_C_LIVRE_OPCAO01 VARCHAR2(40);
VOLD_C_LIVRE_OPCAO01 VARCHAR2(40 BYTE);
VNEW_C_LIVRE_DESCR02 VARCHAR2(1 BYTE);
VOLD_C_LIVRE_DESCR02 VARCHAR2(1 BYTE);
VNEW_QTD_DOENCA NUMBER;
VOLD_QTD_DOENCA NUMBER;
VLOG VARCHAR2(1000);
VTEM_CARGO_EFETIVO VARCHAR2(3 BYTE);
VPROCESSADO VARCHAR2(1 BYTE);

VNEW_EMPRESA_ATENDENTE VARCHAR2(4);
VOLD_EMPRESA_ATENDENTE VARCHAR2(4);
VNEW_CODIGO_ATENDENTE VARCHAR2(15);
VOLD_CODIGO_ATENDENTE VARCHAR2(15);
VNEW_NOME_ATENDENTE VARCHAR2(70);
VOLD_NOME_ATENDENTE VARCHAR2(70);
VNEW_INSCRICAO_CONSELHO VARCHAR2(30);
VOLD_INSCRICAO_CONSELHO VARCHAR2(30);
VNEW_UF_INSCRICAO VARCHAR2(4);
VOLD_UF_INSCRICAO VARCHAR2(4);
VNEW_CONSELHO_REGIONAL VARCHAR2(4);
VOLD_CONSELHO_REGIONAL VARCHAR2(4);
VNEW_INFO_MESMO_MOTIVO VARCHAR2(4);
VOLD_INFO_MESMO_MOTIVO VARCHAR2(4);

VNEW_DT_EFEITO_MESMO_MOTIVO DATE;
VOLD_DT_EFEITO_MESMO_MOTIVO DATE;

vULTIMO_REG_ATIVO_SEM_FIM VARCHAR2(1);--novo em 15/10/21
vDATA_INICIO_MAIS_RECENTE DATE;--novo em 15/10/21
vDATA_INICIO_MAIS_ANTIGO DATE;--novo em 15/10/21
vDATA_FIM_MAIS_RECENTE DATE;--novo em 25/10/21
vCONTADOR NUMBER;

VDADO_ORIGEM_FINAL VARCHAR2(80); --NOVO EM 30/5/22 
VDADO_DESTINO_FINAL VARCHAR2(80); --NOVO EM 30/5/22

--vULTIMO_REG_E_LICENCA VARCHAR2(1);--novo em 25/10/21
--vDATA_INICIO_MAIS_RECENTE_L DATE;--novo em 25/10/21
--vDATA_INICIO_MAIS_ANTIGO_L DATE;--novo em 25/10/21
--vDATA_FIM_MAIS_RECENTE_L DATE;--novo em 25/10/21
--vPROXIMA_SITUACAO VARCHAR2(4);--novo em 25/10/21
--vTEM_FICHA_PERIODO VARCHAR2(1);--novo em 25/10/21 

BEGIN -- 2Ã‚Âº BEGVARCHAR2(40);IN
VTABELA := TABELA;
VCODIGO_EMPRESA := CODIGO_EMPRESA;
VCODIGO_PESSOA := CODIGO_PESSOA;
VDATA_OCORRENCIA := DATA_OCORRENCIA;
VOCORRENCIA := OCORRENCIA;
VORIGEM := ORIGEM;
VID_EXTERNO := ID_EXTERNO;

VID := NULL;
VTIPO_DML := NULL;
VTIPO_CONTRATO := NULL;
VCODIGO_CONTRATO := NULL;
VNEW_COD_SIT_FUNCIONAL := NULL;
VOLD_COD_SIT_FUNCIONAL := NULL;
VNEW_NATUREZA_EXAME := NULL;
VOLD_NATUREZA_EXAME := NULL; 
VNEW_DATA_INI_AFAST := NULL;
VOLD_DATA_INI_AFAST := NULL;
VNEW_DATA_FIM_AFAST := NULL;
VOLD_DATA_FIM_AFAST := NULL;
VNEW_DATA_INICIAL_INDEFERIMENT := NULL;
VOLD_DATA_INICIAL_INDEFERIMENT := NULL;
VNEW_DATA_FINAL_INDEFERIMENTO := NULL;
VOLD_DATA_FINAL_INDEFERIMENTO := NULL;
VNEW_OCOR_PROC_MED := NULL;
VOLD_OCOR_PROC_MED := NULL;
VNEW_CODIGO_PROC_MED := NULL;
VOLD_CODIGO_PROC_MED := NULL;
VNEW_OCOR_DOENCA := NULL;
VOLD_OCOR_DOENCA := NULL;
VNEW_COD_DOENCA := NULL;
VOLD_COD_DOENCA := NULL;
VLOGIN_USUARIO := NULL;
VLOGIN_OS := NULL;
VDADO_ORIGEM_TC1 := NULL;
VDADO_DESTINO_TC1 := NULL;
VDADO_ORIGEM_TC2 := NULL;
VDADO_DESTINO_TC2 := NULL;
VDADO_ORIGEM_TC3 := NULL;
VDADO_DESTINO_TC3 := NULL;
VFAZER  := NULL;
VNEW_C_LIVRE_OPCAO01 := NULL;
VOLD_C_LIVRE_OPCAO01 := NULL;
VNEW_C_LIVRE_DESCR02 := NULL;
VOLD_C_LIVRE_DESCR02 := NULL;
VNEW_QTD_DOENCA := NULL;
VOLD_QTD_DOENCA := NULL;
VLOG := NULL;
VTEM_CARGO_EFETIVO := NULL;
VPROCESSADO := NULL;

VNEW_EMPRESA_ATENDENTE := NULL;
VOLD_EMPRESA_ATENDENTE := NULL;
VNEW_CODIGO_ATENDENTE := NULL;
VOLD_CODIGO_ATENDENTE := NULL;
VNEW_NOME_ATENDENTE := NULL;
VOLD_NOME_ATENDENTE := NULL;
VNEW_INSCRICAO_CONSELHO := NULL;
VOLD_INSCRICAO_CONSELHO := NULL;
VNEW_UF_INSCRICAO := NULL;
VOLD_UF_INSCRICAO := NULL;
VNEW_CONSELHO_REGIONAL := NULL;
VOLD_CONSELHO_REGIONAL := NULL;
VNEW_INFO_MESMO_MOTIVO := NULL;
VOLD_INFO_MESMO_MOTIVO := NULL;

VNEW_DT_EFEITO_MESMO_MOTIVO := NULL;
VOLD_DT_EFEITO_MESMO_MOTIVO := NULL;


vULTIMO_REG_ATIVO_SEM_FIM := NULL;--novo em 15/10/21
vDATA_INICIO_MAIS_RECENTE := NULL;--novo em 15/10/21
vDATA_INICIO_MAIS_ANTIGO := NULL;--novo em 15/10/21
vDATA_FIM_MAIS_RECENTE := NULL;
vCONTADOR := 0;

VDADO_ORIGEM_FINAL := NULL; --NOVO EM 30/5/22 
VDADO_DESTINO_FINAL := NULL; --NOVO EM 30/5/22

--vULTIMO_REG_E_LICENCA := NULL;---novo em 25/10/21
--vDATA_INICIO_MAIS_RECENTE_L := NULL;--novo em 25/10/21
--vDATA_INICIO_MAIS_ANTIGO_L := NULL;---novo em 25/10/21
--vDATA_FIM_MAIS_RECENTE_L := NULL;---novo em 25/10/21
--vPROXIMA_SITUACAO := NULL;--novo em 25/10/21
--vTEM_FICHA_PERIODO := NULL; --novo em 25/10/21

--PEGAR OS DADOS NA TABELA DE LOG
--ORIGEM MANUAL LANÃƒâ€¡ADA DIRETAMENTE NO ARTERH MODULO FICHA MEDICA
IF VORIGEM = 'M' THEN
SELECT 
X.ID, X.TIPO_DML, X.TABELA, X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, X.CODIGO_PESSOA, X.NEW_COD_SIT_FUNCIONAL, X.OLD_COD_SIT_FUNCIONAL, X.DT_REG_OCORRENCIA, X.OCORRENCIA, X.NEW_NATUREZA_EXAME, X.OLD_NATUREZA_EXAME, X.
NEW_DATA_INI_AFAST, X.OLD_DATA_INI_AFAST, X.NEW_DATA_FIM_AFAST, X.OLD_DATA_FIM_AFAST, X.NEW_OCOR_PROC_MED, X.OLD_OCOR_PROC_MED, X.NEW_CODIGO_PROC_MED, X.OLD_CODIGO_PROC_MED, X.NEW_OCOR_DOENCA, X.OLD_OCOR_DOENCA, X.NEW_COD_DOENCA, X.OLD_COD_DOENCA, X.DT_ULT_ALTER_USUA, X.LOGIN_USUARIO, X.LOGIN_OS
,X.PROCESSADO
,X.NEW_EMPRESA_ATENDENTE, X.OLD_EMPRESA_ATENDENTE, X.NEW_CODIGO_ATENDENTE, X.OLD_CODIGO_ATENDENTE, X.NEW_NOME_ATENDENTE, X.OLD_NOME_ATENDENTE, X.NEW_INSCRICAO_CONSELHO, X.OLD_INSCRICAO_CONSELHO, X.NEW_UF_INSCRICAO, X.OLD_UF_INSCRICAO, X.NEW_CONSELHO_REGIONAL, X.OLD_CONSELHO_REGIONAL, X.NEW_INFO_MESMO_MOTIVO, X.OLD_INFO_MESMO_MOTIVO, X.NEW_DT_EFEITO_MESMO_MOTIVO, X.OLD_DT_EFEITO_MESMO_MOTIVO
INTO VID, VTIPO_DML, VTABELA, VCODIGO_EMPRESA, VTIPO_CONTRATO, VCODIGO_CONTRATO, VCODIGO_PESSOA, VNEW_COD_SIT_FUNCIONAL, VOLD_COD_SIT_FUNCIONAL, VDT_REG_OCORRENCIA, VOCORRENCIA, VNEW_NATUREZA_EXAME, VOLD_NATUREZA_EXAME,
VNEW_DATA_INI_AFAST, VOLD_DATA_INI_AFAST, VNEW_DATA_FIM_AFAST, VOLD_DATA_FIM_AFAST, VNEW_OCOR_PROC_MED, VOLD_OCOR_PROC_MED, VNEW_CODIGO_PROC_MED, VOLD_CODIGO_PROC_MED, VNEW_OCOR_DOENCA, VOLD_OCOR_DOENCA, VNEW_COD_DOENCA, VOLD_COD_DOENCA, VDT_ULT_ALTER_USUA, VLOGIN_USUARIO, VLOGIN_OS
, VPROCESSADO
,VNEW_EMPRESA_ATENDENTE, VOLD_EMPRESA_ATENDENTE,VNEW_CODIGO_ATENDENTE, VOLD_CODIGO_ATENDENTE, VNEW_NOME_ATENDENTE, VOLD_NOME_ATENDENTE, VNEW_INSCRICAO_CONSELHO, VOLD_INSCRICAO_CONSELHO, VNEW_UF_INSCRICAO, VOLD_UF_INSCRICAO, VNEW_CONSELHO_REGIONAL, VOLD_CONSELHO_REGIONAL, VNEW_INFO_MESMO_MOTIVO, VOLD_INFO_MESMO_MOTIVO, VNEW_DT_EFEITO_MESMO_MOTIVO, VOLD_DT_EFEITO_MESMO_MOTIVO
FROM SUGESP_FICHAS_MEDICAS X WHERE 
X.CODIGO_EMPRESA = VCODIGO_EMPRESA AND X.CODIGO_PESSOA = VCODIGO_PESSOA  AND TRUNC(X.DT_REG_OCORRENCIA) = TO_DATE(VDATA_OCORRENCIA,'YYYYMMDD') AND X.OCORRENCIA = VOCORRENCIA
--COMENTADO POR ROBSON  10-111-23
--AND X.ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS F WHERE F.CODIGO_EMPRESA = VCODIGO_EMPRESA AND F.CODIGO_PESSOA = VCODIGO_PESSOA  AND TRUNC(F.DT_REG_OCORRENCIA) = TO_DATE(VDATA_OCORRENCIA,'YYYYMMDD') AND F.OCORRENCIA = VOCORRENCIA);
--NOVO POR ROBSON 10-11-23 -- BUSCANDO ID ATTRELADO A TABELA CHAMADA.
AND X.ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS F WHERE F.CODIGO_EMPRESA = VCODIGO_EMPRESA AND F.CODIGO_PESSOA = VCODIGO_PESSOA   
AND TRUNC(F.DT_REG_OCORRENCIA) = TO_DATE(VDATA_OCORRENCIA,'YYYYMMDD') AND F.OCORRENCIA = VOCORRENCIA
AND F.TABELA = VTABELA
);

--AND X.ID = VID_EXTERNO;

--ORIGEM IMPORTADO DO ARQUIVO TEG
ELSIF VORIGEM = 'T' THEN
SELECT 
X.ID, X.TIPO_DML, X.TABELA, X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, X.CODIGO_PESSOA, X.NEW_COD_SIT_FUNCIONAL, X.OLD_COD_SIT_FUNCIONAL, X.DT_REG_OCORRENCIA, X.OCORRENCIA, X.NEW_NATUREZA_EXAME, X.OLD_NATUREZA_EXAME, X.
NEW_DATA_INI_AFAST, X.OLD_DATA_INI_AFAST, X.NEW_DATA_FIM_AFAST, X.OLD_DATA_FIM_AFAST, X.NEW_OCOR_PROC_MED, X.OLD_OCOR_PROC_MED, X.NEW_CODIGO_PROC_MED, X.OLD_CODIGO_PROC_MED, X.NEW_OCOR_DOENCA, X.OLD_OCOR_DOENCA, X.NEW_COD_DOENCA, X.OLD_COD_DOENCA, X.DT_ULT_ALTER_USUA, X.LOGIN_USUARIO, X.LOGIN_OS
, X.PROCESSADO
,X.NEW_EMPRESA_ATENDENTE, X.OLD_EMPRESA_ATENDENTE, X.NEW_CODIGO_ATENDENTE, X.OLD_CODIGO_ATENDENTE, X.NEW_NOME_ATENDENTE, X.OLD_NOME_ATENDENTE, X.NEW_INSCRICAO_CONSELHO, X.OLD_INSCRICAO_CONSELHO, X.NEW_UF_INSCRICAO, X.OLD_UF_INSCRICAO, X.NEW_CONSELHO_REGIONAL, X.OLD_CONSELHO_REGIONAL, X.NEW_INFO_MESMO_MOTIVO, X.OLD_INFO_MESMO_MOTIVO, X.NEW_DT_EFEITO_MESMO_MOTIVO, X.OLD_DT_EFEITO_MESMO_MOTIVO
INTO VID, VTIPO_DML, VTABELA, VCODIGO_EMPRESA, VTIPO_CONTRATO, VCODIGO_CONTRATO, VCODIGO_PESSOA, VNEW_COD_SIT_FUNCIONAL, VOLD_COD_SIT_FUNCIONAL, VDT_REG_OCORRENCIA, VOCORRENCIA, VNEW_NATUREZA_EXAME, VOLD_NATUREZA_EXAME, 
VNEW_DATA_INI_AFAST, VOLD_DATA_INI_AFAST, VNEW_DATA_FIM_AFAST, VOLD_DATA_FIM_AFAST, VNEW_OCOR_PROC_MED, VOLD_OCOR_PROC_MED, VNEW_CODIGO_PROC_MED, VOLD_CODIGO_PROC_MED, VNEW_OCOR_DOENCA, VOLD_OCOR_DOENCA, VNEW_COD_DOENCA, VOLD_COD_DOENCA, VDT_ULT_ALTER_USUA, VLOGIN_USUARIO, VLOGIN_OS
, VPROCESSADO
,VNEW_EMPRESA_ATENDENTE, VOLD_EMPRESA_ATENDENTE,VNEW_CODIGO_ATENDENTE, VOLD_CODIGO_ATENDENTE, VNEW_NOME_ATENDENTE, VOLD_NOME_ATENDENTE, VNEW_INSCRICAO_CONSELHO, VOLD_INSCRICAO_CONSELHO, VNEW_UF_INSCRICAO, VOLD_UF_INSCRICAO, VNEW_CONSELHO_REGIONAL, VOLD_CONSELHO_REGIONAL, VNEW_INFO_MESMO_MOTIVO, VOLD_INFO_MESMO_MOTIVO, VNEW_DT_EFEITO_MESMO_MOTIVO, VOLD_DT_EFEITO_MESMO_MOTIVO
FROM SUGESP_FICHAS_MEDICAS X WHERE 
X.CODIGO_EMPRESA = VCODIGO_EMPRESA AND X.CODIGO_PESSOA = VCODIGO_PESSOA  AND TRUNC(X.DT_REG_OCORRENCIA) = TO_DATE(VDATA_OCORRENCIA,'YYYYMMDD') AND X.OCORRENCIA = VOCORRENCIA
AND X.ID = VID_EXTERNO;

END IF;


---INICIO-NOVO EM 20/07/21-----------PARTE 5-----------------------------------------------------------PARA TROCAR O CODIGO DA SIT FUNC DE AFASTAMENTO DE PESSOAS APOSENTADAS ONDE FICHA MEDICA TEVE CONDUTA 38 MAIOR QUE 15 AFASTADOS
--EM 20/7/21 MESMO NAO CHEGOU A SER USADA POIS O LOCAL CERTO QUE HA AJUSTES PARA A CONDUTA 38 ESTA NA PROCEDURE PR_FICHA_MEDICA_AJUSTE_FICHAS
/*
FOR C5 IN 
()
LOOP
END LOOP;
*/
/*
IF C1.CODIGO_PROC_MED = '000000000000038' AND (C1.DATA_APOSENTA_FGTS IS NOT NULL OR C1.DATA_APOSENTA IS NOT NULL) THEN

UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = '6121'
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO 
AND COD_SIT_FUNCIONAL = SUBSTR(C1.DADO_DESTINO_TC1,1,4) AND TRUNC(DATA_INIC_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST);  COMMIT;
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_6121');
DBMS_OUTPUT.PUT_LINE('2-ENTAO 2: CRIA REGISTRO DA SIT FUNC LANCADA COM DATA INICIO = DATA FIM FICHA +1 E DATA FIM QUE ESTAVA LANCADA');

SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,'INTEGRACAO_FICHA_PARTE2');

DBMS_OUTPUT.PUT_LINE('PARTE 5-ATUALIZA SIT FUNC DE ENCAMINHAMENTO PARA O INSS PARA  6121-LICENÃ‡A MÃ‰DICA P/ APOSENTADO PELO INSS');

END IF; --PARTE 5
*/
--FIM-NOVO EM 20/07/21----------PARTE 5-------------------------------------------------------------PARA TROCAR O CODIGO DA SIT FUNC DE AFASTAMENTO DE PESSOAS APOSENTADAS ONDE FICHA MEDICA TEVE CONDUTA 38 MAIOR QUE 15 AFASTADOS


--inicio----novo em 25/10/21>15/10/21 ----Kellysson em 15/10/21 para adicionar como ultima tarefa na procedure SUGESP_ALT_SIT_FUNC_ULT_CONTRA e nÃ£o deixar existir na sequencia situaÃ§Ãµes de ativo a partir de 01/10/2021 no historico de ALT SIT FUNC da pessoa devido a erros nas fichas medicas
--basedo no (erro_sequencia_ativos_alt_sit_func.sql)
--/*--comentado em 22/10/21
FOR C6 IN (


select  
x2.* from(
SELECT
X.*
 FROM (
SELECT 
S.* 
FROM (
select 
k.*
 from (
SELECT 
C.CODIGO_PESSOA,
COD_CATEG.CONTEUDO_INICIAL TIPO_TRABALHADOR, C.SITUACAO_FUNCIONAL SIT_FUNC_ULT_CONTR
--,TRUNC(Q.DATA_INICIO_COMPARAR) - TRUNC(Q.DATA_FIM_COMPARAR) -1 AS LACUNAS 
,Q.* 
FROM(
SELECT 
T.* 

FROM (
SELECT 
ROW_NUMBER() OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC) AS ORDEM_BM,
A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO, A.COD_SIT_FUNCIONAL, S.DESCRICAO SIT_FUNCIONAL, S.CONTROLE_FOLHA, 
S.E_AFASTAMENTO, S.SUSPENDE_REMUNERA, S.qtde_dias_proximo,
to_date(to_char(A.DATA_INIC_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') DATA_INICIO, to_date(to_char(A.DATA_FIM_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') DATA_FIM--, A.PROXIMA_SITUACAO 
,a.login_usuario, a.dt_ult_alter_usua, A.PROXIMA_SITUACAO
,LEAD(A.COD_SIT_FUNCIONAL, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMA_COD_SIT_FUNCIONAL
,LEAD(S.DESCRICAO, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMA_SIT_FUNCIONAL
,LEAD(S.CONTROLE_FOLHA, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMO_CONTROLE_FOLHA
,LEAD(S.E_AFASTAMENTO, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMO_E_AFASTAMENTO
,LEAD(S.SUSPENDE_REMUNERA, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMO_SUSPENDE_REMUNERA
,LEAD(to_date(to_char(A.DATA_INIC_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy'), 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO  ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMA_DATA_INICIO
,LEAD(to_date(to_char(A.DATA_FIM_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy'), 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO  ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMA_DATA_FIM
,LEAD(a.login_usuario, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMO_login_usuario
,LEAD( a.dt_ult_alter_usua, 1, NULL) OVER (PARTITION BY A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO ORDER BY A.DATA_INIC_SITUACAO DESC ) AS PROXIMa_dt_ult_alter_usua

FROM RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
WHERE 
--A.CODIGO IN ('000000000883291','00000000021005X','000000000239597', '00000000028777X', '000000000297562', '000000000302450') AND
A.CODIGO_EMPRESA IN ('0001','0098','0003','0013','0014', '0002','0007','0009','0010')-- '1' 
                                                                            -- and trunc(A.DT_ULT_ALTER_USUA) >= to_date('19/12/2019','dd/mm/yyyy')--1291
and 
(trunc(A.DATA_INIC_SITUACAO) >= to_date('30/09/2019','dd/mm/yyyy')
or A.DATA_FIM_SITUACAO IS NULL --NOVO EM 15/10/21
OR trunc(A.DATA_FIM_SITUACAO) >= to_date('30/09/2019','dd/mm/yyyy')--NOVO EM 15/10/21
)
)T
)Q
LEFT OUTER JOIN rhpess_contrato c ON C.CODIGO_EMPRESA = q.CODIGO_EMPRESA AND C.TIPO_CONTRATO = q.TIPO_CONTRATO AND C.CODIGO = q.CODIGO
left outer join RHTABS_VINCULO_EMP V ON V.CODIGO = c.VINCULO
LEFT OUTER JOIN (select * from rhtabs_itds_sist WHERE CODIGO_DOMINIO IN (select CODIGO_DOMINIO from RHTABS_COLS_SIST  where codigo_tabela = 'RHTABS_VINCULO_EMP' and codigo_coluna = 'TP_REGIME_TRAB_ESOCIAL'))RG_TRAB
ON RG_TRAB.CONTEUDO_INICIAL = V.TP_REGIME_TRAB_ESOCIAL
LEFT OUTER JOIN (select * from rhtabs_itds_sist WHERE CODIGO_DOMINIO IN (select CODIGO_DOMINIO from RHTABS_COLS_SIST  where codigo_tabela = 'RHTABS_VINCULO_EMP' and codigo_coluna = 'TP_REGIME_PREV_ESOCIAL'))RG_PREV
ON RG_PREV.CONTEUDO_INICIAL = V.TP_REGIME_PREV_ESOCIAL
LEFT OUTER JOIN (select * from rhtabs_itds_sist WHERE CODIGO_DOMINIO IN (select CODIGO_DOMINIO from RHTABS_COLS_SIST  where codigo_tabela = 'RHTABS_VINCULO_EMP' and codigo_coluna = 'COD_CATEG_ESOCIAL'))COD_CATEG
ON COD_CATEG.CONTEUDO_INICIAL = V.COD_CATEG_ESOCIAL
WHERE 
C.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA)FROM RHPESS_CONTRATO AUX WHERE C.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND C.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND C.CODIGO = AUX.CODIGO)
and c.data_rescisao is null and c.CODIGO_EMPRESA IN ('0001','0098','0003','0013','0014', '0002','0007','0009','0010')-----------------------para todos bm ativos em geral
)k
--WHERE k.lacunas <> 0 --teste urbel sequencia de ativos
order by  K.CODIGO_EMPRESA , K.TIPO_CONTRATO , K.CODIGO , K.data_inicIO
)S
--where trunc(s.data_fim) < trunc(sysdate) --COMENTADO EM 27/8/21

--comentado estes 15/10/21--where trunc(s.data_fim_COMPARAR) < trunc(sysdate) --NOVO EM 27/8/21

)X 

)x2 
--where trunc(x2.dt_ult_alter_usua) >= to_date('27/01/20','dd/mm/yy') or trunc(x2.proxima_dt_ult_alter_usua) >= to_date('27/01/20','dd/mm/yy')

--WHERE X2.CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND X2.TIPO_CONTRATO = C1.TIPO_CONTRATO AND X2.CODIGO = C1.CODIGO_CONTRATO---QUE LINKA O C2 COM O C6
WHERE X2.CODIGO_EMPRESA = VCODIGO_EMPRESA AND X2.CODIGO_PESSOA =  VCODIGO_PESSOA-- QUE LINKA AS VARUAVEUS COM O C6

order by  x2.CODIGO_EMPRESA , x2.TIPO_CONTRATO , x2.CODIGO , x2.data_inicIO desc


)
LOOP

vCONTADOR :=vCONTADOR+1; 
dbms_output.put_line('--'||vCONTADOR);
dbms_output.put_line('--ORDEM_BM: '||C6.ORDEM_BM||' CODIGO_EMPRESA: '||C6.CODIGO_EMPRESA	||' TIPO_CONTRATO: '||C6.TIPO_CONTRATO||' CODIGO: '||C6.CODIGO|| ' COD_SIT_FUNCIONAL: '||C6.COD_SIT_FUNCIONAL|| ' DATA_INICIO: '||C6.DATA_INICIO||' DATA_FIM: '||C6.DATA_FIM);

--INICIO -------------------------------------IF DE ATIVOS
IF 
C6.CONTROLE_FOLHA = 'N' AND C6.E_AFASTAMENTO = 'N' AND C6.SUSPENDE_REMUNERA = 'N' 
AND C6.PROXIMO_CONTROLE_FOLHA = 'N' AND C6.PROXIMO_E_AFASTAMENTO = 'N' AND C6.PROXIMO_SUSPENDE_REMUNERA = 'N'
AND C6.ORDEM_BM = 1 
AND C6.COD_SIT_FUNCIONAL = C6.PROXIMA_COD_SIT_FUNCIONAL--AJUSTE EM 21/7/22 EMAIL (Problema na importação 1017 - Servidora -Flavia Alves Monteiro -BM 1155715)
THEN
vULTIMO_REG_ATIVO_SEM_FIM := 'S';
vDATA_INICIO_MAIS_RECENTE := C6.DATA_INICIO;
vDATA_FIM_MAIS_RECENTE := C6.DATA_FIM;
dbms_output.put_line('--*********1-ULTIMO REG. ALT SIT FUNC ATIVO, SEQUENCIAL COM OUTRO ATIVO (PRIMEIRO SENDO O ULTIMO DO HISTORICO). vULTIMO_REG_ATIVO_SEM_FIM: '||vULTIMO_REG_ATIVO_SEM_FIM ||' vDATA_INICIO_MAIS_RECENTE: '||vDATA_INICIO_MAIS_RECENTE|| ' vDATA_FIM_MAIS_RECENTE: '||vDATA_FIM_MAIS_RECENTE);

ELSIF
C6.CONTROLE_FOLHA = 'N' AND C6.E_AFASTAMENTO = 'N' AND C6.SUSPENDE_REMUNERA = 'N' 
AND C6.PROXIMO_CONTROLE_FOLHA = 'N' AND C6.PROXIMO_E_AFASTAMENTO = 'N' AND C6.PROXIMO_SUSPENDE_REMUNERA = 'N'
AND C6.ORDEM_BM <> 1 AND vDATA_INICIO_MAIS_RECENTE IS NULL
AND C6.COD_SIT_FUNCIONAL = C6.PROXIMA_COD_SIT_FUNCIONAL--AJUSTE EM 21/7/22 EMAIL (Problema na importação 1017 - Servidora -Flavia Alves Monteiro -BM 1155715)
THEN
vULTIMO_REG_ATIVO_SEM_FIM := 'N';
vDATA_INICIO_MAIS_RECENTE := C6.DATA_INICIO;
vDATA_FIM_MAIS_RECENTE := C6.DATA_FIM;
dbms_output.put_line('--*********1-REG. ALT SIT FUNC ATIVO, SEQUENCIAL COM OUTRO ATIVO (PRIMEIRO NAO SENDO O ULTIMO DO HISTORICO). vULTIMO_REG_ATIVO_SEM_FIM: '||vULTIMO_REG_ATIVO_SEM_FIM ||' vDATA_INICIO_MAIS_RECENTE: '||vDATA_INICIO_MAIS_RECENTE|| ' vDATA_FIM_MAIS_RECENTE: '||vDATA_FIM_MAIS_RECENTE);

ELSIF
C6.CONTROLE_FOLHA = 'N' AND C6.E_AFASTAMENTO = 'N' AND C6.SUSPENDE_REMUNERA = 'N' 
AND C6.PROXIMO_CONTROLE_FOLHA = 'N' AND C6.PROXIMO_E_AFASTAMENTO = 'N' AND C6.PROXIMO_SUSPENDE_REMUNERA = 'N'
AND C6.ORDEM_BM <> 1 AND vDATA_INICIO_MAIS_RECENTE IS NOT NULL
AND C6.COD_SIT_FUNCIONAL = C6.PROXIMA_COD_SIT_FUNCIONAL--AJUSTE EM 21/7/22 EMAIL (Problema na importação 1017 - Servidora -Flavia Alves Monteiro -BM 1155715)
THEN
dbms_output.put_line('--*********2-REG. ALT SIT FUNC ATIVO SEQUENCIAL COM OUTRO ATIVO (NO MEIO). vULTIMO_REG_ATIVO_SEM_FIM: '||vULTIMO_REG_ATIVO_SEM_FIM ||' vDATA_INICIO_MAIS_RECENTE: '||vDATA_INICIO_MAIS_RECENTE|| ' vDATA_FIM_MAIS_RECENTE: '||vDATA_FIM_MAIS_RECENTE);

ELSIF
C6.CONTROLE_FOLHA = 'N' AND C6.E_AFASTAMENTO = 'N' AND C6.SUSPENDE_REMUNERA = 'N' 
AND 
  (
  (C6.PROXIMO_CONTROLE_FOLHA <> 'N' OR C6.PROXIMO_E_AFASTAMENTO <> 'N' OR C6.PROXIMO_SUSPENDE_REMUNERA <> 'N')
  OR C6.PROXIMO_CONTROLE_FOLHA IS NULL
  OR C6.COD_SIT_FUNCIONAL <> C6.PROXIMA_COD_SIT_FUNCIONAL--AJUSTE EM 21/7/22 EMAIL (Problema na importação 1017 - Servidora -Flavia Alves Monteiro -BM 1155715)
  )
AND C6.ORDEM_BM <> 1 AND vDATA_INICIO_MAIS_RECENTE IS NOT NULL
THEN
vDATA_INICIO_MAIS_ANTIGO := C6.DATA_INICIO;
dbms_output.put_line('--*********3-REG. ALT SIT FUNC ATIVO SEQUENCIAL COM OUTRO ATIVO (ULTIMO). vULTIMO_REG_ATIVO_SEM_FIM: '||vULTIMO_REG_ATIVO_SEM_FIM ||' vDATA_INICIO_MAIS_ANTIGO: '||vDATA_INICIO_MAIS_ANTIGO);

dbms_output.put_line('--****ATENCAO**** NESTE MOMENTO AJUSTAR O HISTORICO E LIMPAR AS VARIAVEIS,MAS DEVE AVALIAR SE A SEQUENCIA SER A ULTIMA NO HISTORICO OU NO MEIO DEVIDO A DATA FIM DA ATIVA');
dbms_output.put_line('--C6.COD_SIT_FUNCIONAL: '||C6.COD_SIT_FUNCIONAL|| ' vULTIMO_REG_ATIVO_SEM_FIM: '||vULTIMO_REG_ATIVO_SEM_FIM ||' vDATA_INICIO_MAIS_RECENTE: '||vDATA_INICIO_MAIS_RECENTE||' vDATA_INICIO_MAIS_ANTIGO: '||vDATA_INICIO_MAIS_ANTIGO || ' vDATA_FIM_MAIS_RECENTE: '||vDATA_FIM_MAIS_RECENTE);
dbms_output.put_line('');

IF vULTIMO_REG_ATIVO_SEM_FIM = 'S' THEN
--C1.COD_SIT_FUNCIONAL: 1000 vULTIMO_REG_ATIVO_SEM_FIM: S vDATA_INICIO_MAIS_RECENTE: 30/07/2021 vDATA_INICIO_MAIS_ANTIGO: 23/07/2021
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C6.CODIGO_EMPRESA AND  TIPO_CONTRATO = C6.TIPO_CONTRATO AND CODIGO = C6.CODIGO AND COD_SIT_FUNCIONAL = C6.COD_SIT_FUNCIONAL AND TRUNC(DATA_INIC_SITUACAO)BETWEEN TRUNC(vDATA_INICIO_MAIS_ANTIGO)+1 AND TRUNC(vDATA_INICIO_MAIS_RECENTE); COMMIT;
--SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C6.CODIGO_EMPRESA ,C6.TIPO_CONTRATO , C6.CODIGO ,'AJUSTE_ATIVO_SEQUENCIA');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = NULL, LOGIN_USUARIO = 'AJUSTE_ATIVO_SEQUENCIA',DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C6.CODIGO_EMPRESA AND  TIPO_CONTRATO = C6.TIPO_CONTRATO AND CODIGO = C6.CODIGO AND COD_SIT_FUNCIONAL = C6.COD_SIT_FUNCIONAL AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(vDATA_INICIO_MAIS_ANTIGO); COMMIT;
dbms_output.put_line('--APENAS DELETOU ALT SIT FUNC E UPDATE NA MAIS ANTIGA CODIGO SITUACAO: '||C6.COD_SIT_FUNCIONAL|| ' E DATA INICIO ENTRE TRUNC(vDATA_INICIO_MAIS_ANTIGO)+1: '|| TRUNC(vDATA_INICIO_MAIS_ANTIGO)|| ' TRUNC(vDATA_INICIO_MAIS_RECENTE): '||TRUNC(vDATA_INICIO_MAIS_RECENTE));

--LIMPAR VARIAVEIS PARA PROXIMO GRUPO DE ATIVAS
--vCONTADOR := 0;
vULTIMO_REG_ATIVO_SEM_FIM := 'N';
vDATA_INICIO_MAIS_RECENTE := NULL;
vDATA_INICIO_MAIS_ANTIGO:= NULL;
vDATA_FIM_MAIS_RECENTE := NULL;

ELSIF vULTIMO_REG_ATIVO_SEM_FIM = 'N' THEN
--C1.COD_SIT_FUNCIONAL: 1000 vULTIMO_REG_ATIVO_SEM_FIM: N vDATA_INICIO_MAIS_RECENTE: 19/07/2021 vDATA_INICIO_MAIS_ANTIGO: 17/07/2021
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C6.CODIGO_EMPRESA AND  TIPO_CONTRATO = C6.TIPO_CONTRATO AND  CODIGO = C6.CODIGO AND COD_SIT_FUNCIONAL = C6.COD_SIT_FUNCIONAL AND TRUNC(DATA_INIC_SITUACAO)BETWEEN TRUNC(vDATA_INICIO_MAIS_ANTIGO) AND TRUNC(vDATA_INICIO_MAIS_RECENTE); COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL,CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA)VALUES ('N', C6.CODIGO_EMPRESA, C6.TIPO_CONTRATO, C6.CODIGO, TRUNC(vDATA_INICIO_MAIS_ANTIGO), TRUNC(vDATA_FIM_MAIS_RECENTE), C6.COD_SIT_FUNCIONAL, 'AJUSTE_ATIVO_SEQUENCIA', SYSDATE);COMMIT;
dbms_output.put_line('--DELETA E CRIA ALT SIT FUNC CODIGO SITUACAO: '||C6.COD_SIT_FUNCIONAL|| ' E DATA INICIO ENTRE TRUNC(vDATA_INICIO_MAIS_ANTIGO): '|| TRUNC(vDATA_INICIO_MAIS_ANTIGO)|| ' TRUNC(vDATA_FIM_MAIS_RECENTE): '||TRUNC(vDATA_FIM_MAIS_RECENTE));

--LIMPAR VARIAVEIS PARA PROXIMO GRUPO DE ATIVAS
vULTIMO_REG_ATIVO_SEM_FIM := 'N';
vDATA_INICIO_MAIS_RECENTE := NULL;
vDATA_INICIO_MAIS_ANTIGO:= NULL;
vDATA_FIM_MAIS_RECENTE := NULL;

END IF; --FIM IF AJUSTAR AS ATIVAS



END IF;--GERAL
--FIM------------------------------------------IF ATIVOS


--INICIO -------------------------------------IF DE LICENCAS
/*
IF 
C6.CONTROLE_FOLHA = 'L' AND C6.E_AFASTAMENTO = 'S' 
AND C6.PROXIMO_CONTROLE_FOLHA = 'L' AND C6.PROXIMO_E_AFASTAMENTO = 'S' 
AND C6.ORDEM_BM = 1 
THEN
vULTIMO_REG_E_LICENCA := 'S';
vDATA_INICIO_MAIS_RECENTE_L := C6.DATA_INICIO;
vDATA_FIM_MAIS_RECENTE_L := C6.DATA_FIM;
vPROXIMA_SITUACAO := C6.PROXIMA_SITUACAO;
dbms_output.put_line('--*********1-ULTIMO REG. ALT SIT FUNC LICENCA, SEQUENCIAL COM OUTRO LICENCA (PRIMEIRO SENDO O ULTIMO DO HISTORICO). vULTIMO_REG_E_LICENCA: '||vULTIMO_REG_E_LICENCA ||' vDATA_INICIO_MAIS_RECENTE_L: '||vDATA_INICIO_MAIS_RECENTE_L|| ' vDATA_FIM_MAIS_RECENTE_L: '||vDATA_FIM_MAIS_RECENTE_L|| ' vPROXIMA_SITUACAO: '||vPROXIMA_SITUACAO);

ELSIF
C6.CONTROLE_FOLHA = 'L' AND C6.E_AFASTAMENTO = 'S' 
AND C6.PROXIMO_CONTROLE_FOLHA = 'L' AND C6.PROXIMO_E_AFASTAMENTO = 'S' 
AND C6.ORDEM_BM <> 1 AND vDATA_INICIO_MAIS_RECENTE_L IS NULL
THEN
vULTIMO_REG_E_LICENCA := 'N';
vDATA_INICIO_MAIS_RECENTE_L := C6.DATA_INICIO;
vDATA_FIM_MAIS_RECENTE_L := C6.DATA_FIM;
vPROXIMA_SITUACAO := C6.PROXIMA_SITUACAO;
dbms_output.put_line('--*********1-REG. ALT SIT FUNC LICENCA, SEQUENCIAL COM OUTRO LICENCA (PRIMEIRO NAO SENDO O ULTIMO DO HISTORICO). vULTIMO_REG_E_LICENCA: '||vULTIMO_REG_E_LICENCA ||' vDATA_INICIO_MAIS_RECENTE_L: '||vDATA_INICIO_MAIS_RECENTE_L|| ' vDATA_FIM_MAIS_RECENTE_L: '||vDATA_FIM_MAIS_RECENTE_L|| ' vPROXIMA_SITUACAO: '||vPROXIMA_SITUACAO);

ELSIF
C6.CONTROLE_FOLHA = 'L' AND C6.E_AFASTAMENTO = 'S' 
AND C6.PROXIMO_CONTROLE_FOLHA = 'L' AND C6.PROXIMO_E_AFASTAMENTO = 'S' 
AND C6.ORDEM_BM <> 1 AND vDATA_INICIO_MAIS_RECENTE_L IS NOT NULL
THEN
dbms_output.put_line('--*********2-REG. ALT SIT FUNC LICENCA SEQUENCIAL COM OUTRO LICENCA (NO MEIO). vULTIMO_REG_E_LICENCA: '||vULTIMO_REG_E_LICENCA ||' vDATA_INICIO_MAIS_RECENTE_L: '||vDATA_INICIO_MAIS_RECENTE_L|| ' vDATA_FIM_MAIS_RECENTE_L: '||vDATA_FIM_MAIS_RECENTE_L);

ELSIF
C6.CONTROLE_FOLHA = 'L' AND C6.E_AFASTAMENTO = 'S' 
AND 
  (
  (C6.PROXIMO_CONTROLE_FOLHA <> 'L' OR C6.PROXIMO_E_AFASTAMENTO <> 'S' )
  OR C6.PROXIMO_CONTROLE_FOLHA IS NULL
  )
AND C6.ORDEM_BM <> 1 AND vDATA_INICIO_MAIS_RECENTE_L IS NOT NULL
THEN
vDATA_INICIO_MAIS_ANTIGO_L := C6.DATA_INICIO;
dbms_output.put_line('--*********3-REG. ALT SIT FUNC LICENCA SEQUENCIAL COM OUTRO LICENCA (ULTIMO). vULTIMO_REG_E_LICENCA: '||vULTIMO_REG_E_LICENCA ||' vDATA_INICIO_MAIS_ANTIGO_L: '||vDATA_INICIO_MAIS_ANTIGO_L);

dbms_output.put_line('--****ATENCAO**** NESTE MOMENTO AJUSTAR O HISTORICO E LIMPAR AS VARIAVEIS,MAS DEVE AVALIAR SE A SEQUENCIA SER A ULTIMA NO HISTORICO OU NO MEIO DEVIDO A DATA FIM DA LICENCA');
dbms_output.put_line('--C6.COD_SIT_FUNCIONAL: '||C6.COD_SIT_FUNCIONAL|| ' vULTIMO_REG_E_LICENCA: '||vULTIMO_REG_E_LICENCA ||' vDATA_INICIO_MAIS_RECENTE_L: '||vDATA_INICIO_MAIS_RECENTE_L||' vDATA_INICIO_MAIS_ANTIGO_L: '||vDATA_INICIO_MAIS_ANTIGO_L || ' vDATA_FIM_MAIS_RECENTE_L: '||vDATA_FIM_MAIS_RECENTE_L);
dbms_output.put_line('');

--SABER SE A LICENCA ESTA NA TABELA TEG1
SELECT CASE WHEN COUNT(X2.CODIGO_EMPRESA)= 0 THEN 'N' ELSE 'S' END 
INTO vTEM_FICHA_PERIODO
FROM(
SELECT F.CODIGO_EMPRESA, F.CODIGO_PESSOA, F.DT_REG_OCORRENCIA, F.OCORRENCIA, F.NATUREZA_EXAME, F.DATA_INI_AFAST, F.DATA_FIM_AFAST
, P.CODIGO_PROC_MED, M.VINCULO
FROM RHMEDI_FICHA_MED F
LEFT OUTER JOIN RHMEDI_RL_FICH_PRO P ON F.CODIGO_EMPRESA = P.CODIGO_EMPRESA AND F.CODIGO_PESSOA = P.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = P.DT_REG_OCORRENCIA AND F.OCORRENCIA = P.OCORRENCIA
LEFT OUTER JOIN RHPESS_CONTRATO M ON M.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND M.TIPO_CONTRATO = F.TIPO_CONTRATO AND M.CODIGO = F.CODIGO_CONTRATO 
LEFT OUTER JOIN (
        SELECT SUBSTR(X.DADO_DESTINO,1,4)SF, COUNT(1)QTD ,
      S.DESCRICAO, S.CONTROLE_FOLHA, S.SUSPENDE_REMUNERA, S.E_AFASTAMENTO
      FROM RHINTE_ED_IT_CONV X 
    LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = SUBSTR(X.DADO_DESTINO,1,4)
    where X.codigo_CONVERSAO ='TEG1' GROUP BY SUBSTR(X.DADO_DESTINO,1,4)
    ,S.DESCRICAO, S.CONTROLE_FOLHA, S.SUSPENDE_REMUNERA, S.E_AFASTAMENTO
)T ON T.SF= C6.COD_SIT_FUNCIONAL--'1005'---TROCAR PELO C6.COD_SIT_FUNCIONAL
WHERE 
M.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX  WHERE AUX.CODIGO_EMPRESA = M.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = M.TIPO_CONTRATO AND AUX.CODIGO = M.CODIGO) 
AND F.CODIGO_EMPRESA = C6.CODIGO_EMPRESA--'0001' ---TROCAR PELO C6.CODIGO_EMPRESA
AND F.CODIGO_PESSOA = C6.CODIGO_PESSOA--'000000000883291' ---TROCAR PELO C6.CODIGO_PESSOA
AND 
(TRUNC(F.DATA_INI_AFAST) BETWEEN TRUNC(vDATA_INICIO_MAIS_ANTIGO_L) AND TRUNC(vDATA_FIM_MAIS_RECENTE_L)--TO_DATE('10/04/2021','DD/MM/YYYY') AND TO_DATE('13/04/2021','DD/MM/YYYY')
OR
TRUNC(F.DATA_FIM_AFAST) BETWEEN TRUNC(vDATA_INICIO_MAIS_ANTIGO_L) AND TRUNC(vDATA_FIM_MAIS_RECENTE_L)--TO_DATE('10/04/2021','DD/MM/YYYY') AND TO_DATE('13/04/2021','DD/MM/YYYY')
)
)X2;


--GRAVAR O AJUSTE FINAL
IF vTEM_FICHA_PERIODO = 'S' THEN
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C6.CODIGO_EMPRESA AND  TIPO_CONTRATO = C6.TIPO_CONTRATO AND  CODIGO = C6.CODIGO AND COD_SIT_FUNCIONAL = C6.COD_SIT_FUNCIONAL AND TRUNC(DATA_INIC_SITUACAO)BETWEEN TRUNC(vDATA_INICIO_MAIS_ANTIGO_L) AND TRUNC(vDATA_INICIO_MAIS_RECENTE_L); COMMIT;
INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL,CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, DATA_FIM_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA, PROXIMA_SITUACAO)VALUES ('N', C6.CODIGO_EMPRESA, C6.TIPO_CONTRATO, C6.CODIGO, TRUNC(vDATA_INICIO_MAIS_ANTIGO_L), TRUNC(vDATA_FIM_MAIS_RECENTE_L), C6.COD_SIT_FUNCIONAL, 'AJUSTE_ATIVO_SEQUENCIA', SYSDATE, vPROXIMA_SITUACAO);COMMIT;
dbms_output.put_line('--DELETA E CRIA ALT SIT FUNC CODIGO SITUACAO: '||C6.COD_SIT_FUNCIONAL|| ' E DATA INICIO ENTRE TRUNC(vDATA_INICIO_MAIS_ANTIGO_L): '|| TRUNC(vDATA_INICIO_MAIS_ANTIGO_L)|| ' TRUNC(vDATA_FIM_MAIS_RECENTE_L): '||TRUNC(vDATA_FIM_MAIS_RECENTE_L)|| ' vPROXIMA_SITUACAO: '||vPROXIMA_SITUACAO);

--LIMPAR VARIAVEIS PARA PROXIMO GRUPO DE ATIVAS
vULTIMO_REG_E_LICENCA := 'N';---novo em 25/10/21
vDATA_INICIO_MAIS_RECENTE_L := NULL;--novo em 25/10/21
vDATA_INICIO_MAIS_ANTIGO_L := NULL;---novo em 25/10/21
vDATA_FIM_MAIS_RECENTE_L := NULL;---novo em 25/10/21
vPROXIMA_SITUACAO := NULL;
vTEM_FICHA_PERIODO := NULL; 
END IF; --AJUSTAR AS LICENCAS


END IF;--GERAL
--FIM------------------------------------------IF LICENCAS
*/





END LOOP;---FIM C6
--fim----novo em 25/10/21>15/10/21 ----Kellysson em 15/10/21 para adicionar como ultima tarefa na procedure SUGESP_ALT_SIT_FUNC_ULT_CONTRA e nÃ£o deixar existir na sequencia situaÃ§Ãµes de ativo a partir de 01/10/2021 no historico de ALT SIT FUNC da pessoa devido a erros nas fichas medicas
--*/





--1Ã‚Âº IF
--IF VCODIGO_EMPRESA = 'RHMEDI_FICHA_MED' THEN
IF VTABELA =  'RHMEDI_FICHA_MED' THEN
--------------------------------------------------------------------------------------------------------------------------------------------------------RHMEDI_FICHA_MED
DBMS_OUTPUT.PUT_LINE('RHMEDI_FICHA_MED' ||'-'||VCODIGO_EMPRESA );

--PEGAR TODOS OS REGISTROS ENVOLVIDOS DA FICHA MEDICA DO REGISTRO DE LOG EM QUESTÃƒÆ’O
FOR C1 IN (
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OCOR_PROC_MED, X.CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
--TC2.DADO_ORIGEM DADO_ORIGEM_TC2, TC2.DADO_DESTINO DADO_DESTINO_TC2,
--TC3.DADO_ORIGEM DADO_ORIGEM_TC3, TC3.DADO_DESTINO DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED,
A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
--,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
--FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
--LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) =  F.NATUREZA_EXAME|| C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,19)||SUBSTR(TC2.DADO_ORIGEM,28,LENGTH(TC2.DADO_ORIGEM)) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED||DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,19) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED      AND TC3.DADO_DESTINO = DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--85--81--82
--comentado em 16/11/20 devido ao cenario de tirar data de deferimento --AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL--NOVO EM 30/5/22
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OCOR_PROC_MED, X.CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
)
LOOP
--INICIO-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
DBMS_OUTPUT.PUT_LINE(C1.DADO_ORIGEM_TC1||'-'|| C1.DADO_DESTINO_FINAL||'-'||C1.OCOR_PROC_MED ||'-'|| C1.CODIGO_PROC_MED ||'-'|| C1.ANO_MES_REFERENCIA ||'-'|| C1.VINCULO ||'-'|| C1.TP_REGIME_TRAB_ESOCIAL ||'-'|| C1.TP_REGIME_PREV_ESOCIAL ||'-'|| C1.COD_CATEG_ESOCIAL );
--INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, 
--C1.DADO_ORIGEM_TC1||'-'|| C1.DADO_DESTINO_TC1||'-'||C1.OCOR_PROC_MED ||'-'|| C1.CODIGO_PROC_MED ||'-'|| C1.ANO_MES_REFERENCIA ||'-'|| C1.VINCULO ||'-'|| C1.TP_REGIME_TRAB_ESOCIAL ||'-'|| C1.TP_REGIME_PREV_ESOCIAL ||'-'|| C1.COD_CATEG_ESOCIAL
--, SYSDATE );
--FIM-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO

--COMENTADO 30/5/22--IF VTIPO_DML = 'U' AND C1.DADO_ORIGEM_TC1 IS NOT NULL 
IF VTIPO_DML = 'U' AND C1.DADO_ORIGEM_FINAL IS NOT NULL --NOVO EM 30/5/22
AND 
(
(VNEW_NATUREZA_EXAME IS NOT NULL AND VOLD_NATUREZA_EXAME IS NOT NULL AND VNEW_NATUREZA_EXAME <> VOLD_NATUREZA_EXAME )OR
(VNEW_DATA_INI_AFAST IS NOT NULL AND VOLD_DATA_INI_AFAST IS NOT NULL AND VNEW_DATA_INI_AFAST <> VOLD_DATA_INI_AFAST) OR
(VNEW_DATA_FIM_AFAST IS NOT NULL AND VOLD_DATA_FIM_AFAST IS NOT NULL AND VNEW_DATA_FIM_AFAST <> VOLD_DATA_FIM_AFAST)OR
--INICIO NOVO EM 16/11/20
(VOLD_DATA_INI_AFAST IS     NULL AND VNEW_DATA_INI_AFAST IS NOT NULL )OR --NAO TINHA DATA AGORA TEM
(VOLD_DATA_FIM_AFAST IS     NULL AND VNEW_DATA_FIM_AFAST IS NOT NULL )OR--NAO TINHA DATA AGORA TEM
(VOLD_DATA_INI_AFAST IS NOT NULL AND VNEW_DATA_INI_AFAST IS     NULL )OR --TINHA DATA AGORA NAO TEM
(VOLD_DATA_FIM_AFAST IS NOT NULL AND VNEW_DATA_FIM_AFAST IS     NULL )--TINHA DATA AGORA NAO TEM
--FIM NOVO EM 16/11/20
--INICIO NOVO EM 23/11/20
OR
((VNEW_EMPRESA_ATENDENTE IS NOT NULL AND VOLD_EMPRESA_ATENDENTE IS NULL) OR (VNEW_EMPRESA_ATENDENTE IS NULL AND VOLD_EMPRESA_ATENDENTE IS NOT NULL)
OR (VNEW_EMPRESA_ATENDENTE IS NOT NULL AND VOLD_EMPRESA_ATENDENTE IS NOT NULL AND VNEW_EMPRESA_ATENDENTE <> VOLD_EMPRESA_ATENDENTE)
)
OR
((VNEW_CODIGO_ATENDENTE IS NOT NULL AND VOLD_CODIGO_ATENDENTE IS NULL) OR (VNEW_CODIGO_ATENDENTE IS NULL AND VOLD_CODIGO_ATENDENTE IS NOT NULL)
OR (VNEW_CODIGO_ATENDENTE IS NOT NULL AND VOLD_CODIGO_ATENDENTE IS NOT NULL AND VNEW_CODIGO_ATENDENTE <> VOLD_CODIGO_ATENDENTE)
)
OR
((VNEW_NOME_ATENDENTE IS NOT NULL AND VOLD_NOME_ATENDENTE IS NULL) OR (VNEW_NOME_ATENDENTE IS NULL AND VOLD_NOME_ATENDENTE IS NOT NULL)
OR (VNEW_NOME_ATENDENTE IS NOT NULL AND VOLD_NOME_ATENDENTE IS NOT NULL AND VNEW_NOME_ATENDENTE <> VOLD_NOME_ATENDENTE)
)
OR
((VNEW_INSCRICAO_CONSELHO IS NOT NULL AND VOLD_INSCRICAO_CONSELHO IS NULL) OR (VNEW_INSCRICAO_CONSELHO IS NULL AND VOLD_INSCRICAO_CONSELHO IS NOT NULL)
OR (VNEW_INSCRICAO_CONSELHO IS NOT NULL AND VOLD_INSCRICAO_CONSELHO IS NOT NULL AND VNEW_INSCRICAO_CONSELHO <> VOLD_INSCRICAO_CONSELHO)
)
OR
((VNEW_UF_INSCRICAO IS NOT NULL AND VOLD_UF_INSCRICAO IS NULL) OR (VNEW_UF_INSCRICAO IS NULL AND VOLD_UF_INSCRICAO IS NOT NULL)
OR (VNEW_UF_INSCRICAO IS NOT NULL AND VOLD_UF_INSCRICAO IS NOT NULL AND VNEW_UF_INSCRICAO <> VOLD_UF_INSCRICAO)
)
OR
((VNEW_CONSELHO_REGIONAL IS NOT NULL AND VOLD_CONSELHO_REGIONAL IS NULL) OR (VNEW_CONSELHO_REGIONAL IS NULL AND VOLD_CONSELHO_REGIONAL IS NOT NULL)
OR (VNEW_CONSELHO_REGIONAL IS NOT NULL AND VOLD_CONSELHO_REGIONAL IS NOT NULL AND VNEW_CONSELHO_REGIONAL <> VOLD_CONSELHO_REGIONAL)
)
OR
((VNEW_INFO_MESMO_MOTIVO IS NOT NULL AND VOLD_INFO_MESMO_MOTIVO IS NULL) OR (VNEW_INFO_MESMO_MOTIVO IS NULL AND VOLD_INFO_MESMO_MOTIVO IS NOT NULL)
OR (VNEW_INFO_MESMO_MOTIVO IS NOT NULL AND VOLD_INFO_MESMO_MOTIVO IS NOT NULL AND VNEW_INFO_MESMO_MOTIVO <> VOLD_INFO_MESMO_MOTIVO)
)
OR
((VNEW_DT_EFEITO_MESMO_MOTIVO IS NOT NULL AND VOLD_DT_EFEITO_MESMO_MOTIVO IS NULL) OR (VNEW_DT_EFEITO_MESMO_MOTIVO IS NULL AND VOLD_DT_EFEITO_MESMO_MOTIVO IS NOT NULL)
OR (VNEW_DT_EFEITO_MESMO_MOTIVO IS NOT NULL AND VOLD_DT_EFEITO_MESMO_MOTIVO IS NOT NULL AND VNEW_DT_EFEITO_MESMO_MOTIVO <> VOLD_DT_EFEITO_MESMO_MOTIVO)
)
--FIM NOVO EM 23/11/20
)THEN
--COMENTADO 30/5/22--INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, C1.DADO_ORIGEM_TC1 ||'-'|| C1.DADO_DESTINO_TC1 ||'-'||VNEW_DATA_INI_AFAST ||'-'|| VOLD_DATA_INI_AFAST ||'-'||VNEW_DATA_FIM_AFAST ||'-'|| VOLD_DATA_FIM_AFAST||'-UPDATE ALTERADO DATA DEFERIMENTO FICHA MEDICA - VERIFICAR SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO', SYSDATE );-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, C1.DADO_ORIGEM_FINAL ||'-'|| C1.DADO_DESTINO_FINAL ||'-'||VNEW_DATA_INI_AFAST ||'-'|| VOLD_DATA_INI_AFAST ||'-'||VNEW_DATA_FIM_AFAST ||'-'|| VOLD_DATA_FIM_AFAST||'-UPDATE ALTERADO DATA DEFERIMENTO FICHA MEDICA - VERIFICAR SITUACAO FUNCIONAL/PONTO', SYSDATE );-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO

--VLOG := C1.DADO_ORIGEM_TC1 ||'-'|| C1.DADO_DESTINO_TC1 ||'-'||VNEW_DATA_INI_AFAST ||'-'|| VOLD_DATA_INI_AFAST||'-UPDATE ALTERADO DATA DEFERIMENTO FICHA MEDICA - VERIFICAR SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO';

VFAZER := 'U-ALTER_DATA_DEFERIMENTO'; 
--COMENTADO 30/5/22--VDADO_ORIGEM_TC1 := C1.DADO_ORIGEM_TC1;
--COMENTADO 30/5/22--VDADO_DESTINO_TC1 := C1.DADO_DESTINO_TC1;
VDADO_ORIGEM_FINAL := C1.DADO_ORIGEM_FINAL;--NOVO EM 30/5/22
VDADO_DESTINO_FINAL := C1.DADO_DESTINO_FINAL;--NOVO EM 30/5/22
VTEM_CARGO_EFETIVO := C1.TEM_CARGO_EFETIVO;
--INICIO-- parte nova em 23/10/20 para chamar procedure que apaga SIT PONTO E TROCA SIT. FUNC PARA ATIVO
dbms_output.put_line('chama procedure PR_FICHA_MEDICA_AJUSTE_FICHAS alterando PROCEDIMENTO OU DATAS DEFERIMENTO FICHA, VID'||VID);
PR_FICHA_MEDICA_AJUSTE_FICHAS(VID);
--FIM-- parte nova em 23/10/20 para chamar procedure que apaga SIT PONTO E TROCA SIT. FUNC PARA ATIVO


END IF;--RHMEDI_FICHA_MED
END LOOP;--RHMEDI_FICHA_MED





ELSIF VTABELA = 'RHMEDI_RL_FICH_PRO' THEN
--------------------------------------------------------------------------------------------------------------------------------------------------------RHMEDI_RL_FICH_PRO
DBMS_OUTPUT.PUT_LINE('RHMEDI_RL_FICH_PRO' ||'-'||VCODIGO_EMPRESA);
--------------------------------------------------------------------------INSERT
IF VTIPO_DML = 'I' THEN
--PEGAR TODOS OS REGISTROS ENVOLVIDOS DA FICHA MEDICA DO REGISTRO DE LOG EM QUESTAO
DBMS_OUTPUT.PUT_LINE('VTIPO_DML:' ||VTIPO_DML||'--PEGAR TODOS OS REGISTROS ENVOLVIDOS DA FICHA MEDICA DO REGISTRO DE LOG EM QUESTAO');
FOR C1 IN (
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OCOR_PROC_MED, X.CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10
FROM (
SELECT 
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
--TC2.DADO_ORIGEM DADO_ORIGEM_TC2, TC2.DADO_DESTINO DADO_DESTINO_TC2,
--TC3.DADO_ORIGEM DADO_ORIGEM_TC3, TC3.DADO_DESTINO DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
--,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
--FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
--LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,19)||SUBSTR(TC2.DADO_ORIGEM,28,LENGTH(TC2.DADO_ORIGEM)) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED||DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,19) =  F.NATUREZA_EXAME||C.CODIGO_PROC_MED      AND TC3.DADO_DESTINO = DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--85--81--82
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL--NOVO EM 30/5/22
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OCOR_PROC_MED, X.CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

)
LOOP
--COMENTADO 30/5/22--IF C1.DADO_ORIGEM_TC1 IS NOT NULL THEN
IF C1.DADO_ORIGEM_FINAL IS NOT NULL THEN --NOVO 30/5/22

VFAZER := 'I-INCLUIU_CONDUTA'; 
DBMS_OUTPUT.PUT_LINE('VFAZER: '||VFAZER);
--COMENTADO 30/5/22--VDADO_ORIGEM_TC1 := C1.DADO_ORIGEM_TC1;
--COMENTADO 30/5/22--VDADO_DESTINO_TC1 := C1.DADO_DESTINO_TC1;
VDADO_ORIGEM_FINAL := C1.DADO_ORIGEM_FINAL;--NOVO 30/5/22
VDADO_DESTINO_FINAL := C1.DADO_DESTINO_FINAL;--NOVO 30/5/22
VTEM_CARGO_EFETIVO := C1.TEM_CARGO_EFETIVO;


INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, C1.DADO_ORIGEM_FINAL||'-'||  C1.DADO_DESTINO_FINAL||'-'|| '- INSERT CONDUTA - VERIFICAR SITUACAO FUNCIONAL/PONTO', SYSDATE );-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
--VLOG := C1.DADO_ORIGEM_TC1||'-'||  C1.DADO_DESTINO_TC1||'-'|| '- INSERT CONDUTA - VERIFICAR SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO';

--INICIO-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
DBMS_OUTPUT.PUT_LINE(C1.DADO_ORIGEM_FINAL||'-'|| C1.DADO_DESTINO_FINAL||'-'||C1.OCOR_PROC_MED ||'-'|| C1.CODIGO_PROC_MED ||'-'|| C1.ANO_MES_REFERENCIA ||'-'|| C1.VINCULO ||'-'|| C1.TP_REGIME_TRAB_ESOCIAL ||'-'|| C1.TP_REGIME_PREV_ESOCIAL ||'-'|| C1.COD_CATEG_ESOCIAL );
--INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, 
--C1.DADO_ORIGEM_TC1||'-'|| C1.DADO_DESTINO_TC1||'-'||C1.OCOR_PROC_MED ||'-'|| C1.CODIGO_PROC_MED ||'-'|| C1.ANO_MES_REFERENCIA ||'-'|| C1.VINCULO ||'-'|| C1.TP_REGIME_TRAB_ESOCIAL ||'-'|| C1.TP_REGIME_PREV_ESOCIAL ||'-'|| C1.COD_CATEG_ESOCIAL
--, SYSDATE );
--FIM-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
END IF;--RHMEDI_RL_FICH_PRO
END LOOP;--RHMEDI_RL_FICH_PRO

--------------------------------------------------------------------------DELETE
ELSIF VTIPO_DML = 'D' THEN
DBMS_OUTPUT.PUT_LINE('VTIPO_DML: '||VTIPO_DML);
FOR C2 IN(
SELECT
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OLD_OCOR_PROC_MED, X.OLD_CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
X.OLD_OCOR_PROC_MED, X.OLD_CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN RHMEDI_RL_FICH_PRO C ON X.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C.CODIGO_PESSOA AND X.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND X.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))
  A ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) =  F.NATUREZA_EXAME||X.OLD_CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||X.OLD_CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = X.OLD_CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22
WHERE X.ID = VID
--comentado em 25/7/20 A SER UMA EXCLUSAO-- AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL--NOVO EM 30/5/22

GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
,X.OLD_OCOR_PROC_MED, X.OLD_CODIGO_PROC_MED, X.ANO_MES_REFERENCIA, X.VINCULO, X.TP_REGIME_TRAB_ESOCIAL, X.TP_REGIME_PREV_ESOCIAL, X.COD_CATEG_ESOCIAL
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

)LOOP

--COMENTADO 30/5/22--IF C2.DADO_ORIGEM_TC1 IS NOT NULL THEN
IF C2.DADO_ORIGEM_FINAL IS NOT NULL THEN --NOVO 30/5/22
--AND C1.DADO_ORIGEM_TC1 IS NOT NULL THEN
DBMS_OUTPUT.PUT_LINE('C2.DADO_ORIGEM_FINAL: '||C2.DADO_ORIGEM_FINAL);

VFAZER := 'E-EXCLUIU_CONDUTA'; 
DBMS_OUTPUT.PUT_LINE('VTIPO_DML: '||VTIPO_DML);
--COMENTADO 30/5/22--VDADO_ORIGEM_TC1 := C2.DADO_ORIGEM_TC1;
--COMENTADO 30/5/22--VDADO_DESTINO_TC1 := C2.DADO_DESTINO_TC1;
VDADO_ORIGEM_FINAL := C2.DADO_ORIGEM_FINAL;--NOVO 30/5/22
VDADO_DESTINO_FINAL := C2.DADO_DESTINO_FINAL;--NOVO 30/5/22
VTEM_CARGO_EFETIVO := C2.TEM_CARGO_EFETIVO;

DBMS_OUTPUT.PUT_LINE('--C2.DADO_ORIGEM_TC1: '||C2.DADO_ORIGEM_TC1||' C2.DADO_DESTINO_TC1: '||C2.DADO_DESTINO_TC1||' C2.DADO_ORIGEM_TG10: '||C2.DADO_ORIGEM_TG10|| ' C2.DADO_DESTINO_TG10: '||C2.DADO_DESTINO_TG10||' C2.DADO_ORIGEM_FINAL: '||C2.DADO_ORIGEM_FINAL||' C2.DADO_DESTINO_FINAL: '||C2.DADO_DESTINO_FINAL|| ' VDADO_ORIGEM_FINAL: '||VDADO_ORIGEM_FINAL|| ' VDADO_DESTINO_FINAL: ' ||VDADO_DESTINO_FINAL);--NOVO EM 7/6/22

INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, C2.DADO_ORIGEM_FINAL||'-'||  C2.DADO_DESTINO_FINAL||'-'|| '-DELETE CONDUTA - VERIFICAR SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO', SYSDATE );-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
--VLOG := C2.DADO_ORIGEM_TC1||'-'||  C2.DADO_DESTINO_TC1||'-'|| '-DELETE CONDUTA - VERIFICAR SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO';

--INICIO-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO
DBMS_OUTPUT.PUT_LINE(C2.DADO_ORIGEM_FINAL||'-'|| C2.DADO_DESTINO_FINAL||'-'||C2.OLD_OCOR_PROC_MED ||'-'|| C2.OLD_CODIGO_PROC_MED ||'-'|| C2.ANO_MES_REFERENCIA ||'-'|| C2.VINCULO ||'-'|| C2.TP_REGIME_TRAB_ESOCIAL ||'-'|| C2.TP_REGIME_PREV_ESOCIAL ||'-'|| C2.COD_CATEG_ESOCIAL );
--INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, 
--C2.DADO_ORIGEM_TC1||'-'|| C2.DADO_DESTINO_TC1||'-'||C2.OLD_OCOR_PROC_MED ||'-'|| C2.OLD_CODIGO_PROC_MED ||'-'|| C2.ANO_MES_REFERENCIA ||'-'|| C2.VINCULO ||'-'|| C2.TP_REGIME_TRAB_ESOCIAL ||'-'|| C2.TP_REGIME_PREV_ESOCIAL ||'-'|| C2.COD_CATEG_ESOCIAL
--, SYSDATE );
--FIM-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO

--INICIO-- parte nova em 23/10/20 para chamar procedure que apaga SIT PONTO E TROCA SIT. FUNC PARA ATIVO
dbms_output.put_line('chama procedure PR_FICHA_MEDICA_AJUSTE_FICHAS excluindo CONDUTA, VID'||VID);
PR_FICHA_MEDICA_AJUSTE_FICHAS(VID);
--FIM-- parte nova em 23/10/20 para chamar procedure que apaga SIT PONTO E TROCA SIT. FUNC PARA ATIVO



END IF;

END LOOP;--DELETE
END IF;--RHMEDI_RL_FICH_PRO






ELSIF VTABELA= 'RHMEDI_RL_FICH_DOE' THEN
-----------------------------------------------------------------------------------------------------------------------------------------------------------RHMEDI_RL_FICH_DOE
DBMS_OUTPUT.PUT_LINE('RHMEDI_RL_FICH_DOE' ||'-'||VID);
INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, VTABELA||'-'||VLOG, SYSDATE );-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO


DECLARE
VQUANT NUMBER;
VTIPO  VARCHAR2(20);
VSIM_ANTES NUMBER;
VSIM_DEPOIS NUMBER;
VTEG2_ANTES NUMBER;
VTEG2_DEPOIS NUMBER;
VTEG3_ANTES NUMBER;
VTEG3_DEPOIS NUMBER;
VSIM_INCLUI NUMBER;
VSIM_EXCLUI NUMBER;
VTEG2_INCLUI NUMBER;
VTEG2_EXCLUI NUMBER;
VTEG3_INCLUI NUMBER;
VTEG3_EXCLUI NUMBER;
--VDADO_ORIGEM_TC1 VARCHAR2(80); 
--VDADO_DESTINO_TC1  VARCHAR2(80); 
--VDADO_ORIGEM_TC2  VARCHAR2(80); 
--VDADO_DESTINO_TC2  VARCHAR2(80); 
--VDADO_ORIGEM_TC3  VARCHAR2(80); 
--VDADO_DESTINO_TC3  VARCHAR2(80); 
--VFAZER_FICHA_MEDICA VARCHAR2(30); 

BEGIN-- 2Ã‚Âº BEGIN
DBMS_OUTPUT.ENABLE(NULL);

VQUANT := 0;
VTIPO := NULL;
VSIM_ANTES := 0;
VSIM_DEPOIS := 0; 
VTEG2_ANTES := 0; 
VTEG2_DEPOIS := 0; 
VTEG3_ANTES := 0; 
VTEG3_DEPOIS := 0; 
VSIM_INCLUI := 0;
VSIM_EXCLUI := 0;
VTEG2_INCLUI := 0;
VTEG2_EXCLUI := 0;
VTEG3_INCLUI := 0;
VTEG3_EXCLUI := 0;
--VDADO_ORIGEM_TC1 := NULL;
--VDADO_DESTINO_TC1 := NULL;
--VDADO_ORIGEM_TC2 := NULL;
--VDADO_DESTINO_TC2 := NULL; 
--VDADO_ORIGEM_TC3 := NULL;
--VDADO_DESTINO_TC3 := NULL;
--VFAZER_FICHA_MEDICA := NULL;

FOR C1 IN (
--SELECT SUM(QUANT) FROM (
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT_REG,-- SUM(PONTOS)SOMA_PONTOS,
--X.COD_DOENCA, X.DESCRICAO,
'SIM' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
1 PONTOS, TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
NULL DADO_ORIGEM_TC2, NULL DADO_DESTINO_TC2,
NULL DADO_ORIGEM_TC3, NULL DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,D.OCOR_DOENCA, D.COD_DOENCA,DOE.DESCRICAO, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--                                                                                AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--                                                                                AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22
WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE X.DOENCA_C_LIVRE_OPCAO01 = 'S'
AND (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL)--NOVO EM 30/5/22
AND (LENGTH(X.DADO_DESTINO_TC1) = 24 --NOVO EM 6/7/20
OR LENGTH(X.DADO_DESTINO_TG10) = 24 )--NOVO EM 30/5/22

GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1 , X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT,--SUM(PONTOS),
'TEG2' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
0.5 PONTOS, TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
TC2.DADO_ORIGEM DADO_ORIGEM_TC2, TC2.DADO_DESTINO DADO_DESTINO_TC2,
NULL DADO_ORIGEM_TC3, NULL DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--ATE 6/7/20--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--ATE 6/7/20--                      AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 
ON SUBSTR(TC2.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO AND SUBSTR(TC2.DADO_ORIGEM,24,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA  --NOVO EM 6/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--                                                                                AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22
WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL) --NOVO EM 30/5/22
AND X.DADO_ORIGEM_TC2 IS NOT NULL
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT,-- SUM(PONTOS),
'TEG3' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
0.5 PONTOS,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
NULL DADO_ORIGEM_TC2, NULL DADO_DESTINO_TC2,
TC3.DADO_ORIGEM DADO_ORIGEM_TC3, TC3.DADO_DESTINO DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--                                                                                AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
--ATE 6/7/20--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--ATE 6/7/20--            AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3
ON SUBSTR(TC3.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO AND SUBSTR(TC3.DADO_ORIGEM,24,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA --NOVO EM 6/7/20
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22
WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL) --NOVO EM 30/5/22
AND X.DADO_ORIGEM_TC3 IS NOT NULL
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1
, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

--NOVA DOENCA
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1) QUANT, --SUM(PONTOS),
'SIM_INCLUI' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
1 PONTOS,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
NULL DADO_ORIGEM_TC2, NULL DADO_DESTINO_TC2,
NULL DADO_ORIGEM_TC3, NULL DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
AND X.NEW_COD_DOENCA = D.COD_DOENCA
)X
WHERE X.DOENCA_C_LIVRE_OPCAO01 = 'S'
AND (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL) --NOVO EM 30/5/22
AND (LENGTH(X.DADO_DESTINO_TC1) = 24 --NOVO EM 6/7/20
OR LENGTH(X.DADO_DESTINO_TG10) = 24 ) --NOVO EM 30/5/22
GROUP BY X.PONTOS,X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1 , X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

--EXCLUIU DOENCA
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1) QUANT,-- SUM(PONTOS),
--X.COD_DOENCA, X.DESCRICAO, 
 'SIM_EXCLUI' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
 ,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
1 PONTOS,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
NULL DADO_ORIGEM_TC2, NULL DADO_DESTINO_TC2,
NULL DADO_ORIGEM_TC3, NULL DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
--,D.OCOR_DOENCA, D.COD_DOENCA
,DOE.CODIGO COD_DOENCA,DOE.DESCRICAO, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
--FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA AND X.OLD_COD_DOENCA = D.COD_DOENCA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = X.OLD_COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22
WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
--AND X.OLD_COD_DOENCA = DOE.CODIGO
)X
WHERE X.DOENCA_C_LIVRE_OPCAO01 = 'S'
AND (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL)--NOVO EM 30/5/22
AND (LENGTH(X.DADO_DESTINO_TC1) = 24 --NOVO EM 6/7/20
OR LENGTH(X.DADO_DESTINO_TG10) = 24 ) --NOVO EM 30/5/22
GROUP BY  X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1 , X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

--INCUIU TEG2
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT,--SUM(PONTOS),
'TEG2_INCLUI' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1--, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
0.5 PONTOS, TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
TC2.DADO_ORIGEM DADO_ORIGEM_TC2, TC2.DADO_DESTINO DADO_DESTINO_TC2,
NULL DADO_ORIGEM_TC3, NULL DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--ATE 6/7/20--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--ATE 6/7/20--                      AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 
ON SUBSTR(TC2.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO AND SUBSTR(TC2.DADO_ORIGEM,24,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA  --NOVO EM 6/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--  AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 

LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
AND X.NEW_COD_DOENCA = DOE.CODIGO
)X
WHERE (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL) -- NOVO EM 30/5/22
AND X.DADO_ORIGEM_TC2 IS NOT NULL
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

--EXLUI TEG2
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT,--SUM(PONTOS),
'TEG2_EXCLUI' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
0.5 PONTOS, TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
TC2.DADO_ORIGEM DADO_ORIGEM_TC2, TC2.DADO_DESTINO DADO_DESTINO_TC2,
NULL DADO_ORIGEM_TC3, NULL DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
--,D.OCOR_DOENCA, D.COD_DOENCA, 
,DOE.CODIGO COD_DOENCA,DOE.DESCRICAO, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
--FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = X.OLD_COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--ATE 6/7/20--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--ATE 6/7/20--                      AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 
ON SUBSTR(TC2.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO AND SUBSTR(TC2.DADO_ORIGEM,24,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA  --NOVO EM 6/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--    AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
AND X.OLD_COD_DOENCA = DOE.CODIGO
)X
WHERE (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL) -- NOVO EM 30/5/22
AND X.DADO_ORIGEM_TC2 IS NOT NULL
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

--INCLUIR TEG3
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT, --SUM(PONTOS),
'TEG3_INCLUI' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
0.5 PONTOS,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
NULL DADO_ORIGEM_TC2, NULL DADO_DESTINO_TC2,
TC3.DADO_ORIGEM DADO_ORIGEM_TC3, TC3.DADO_DESTINO DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,D.OCOR_DOENCA, D.COD_DOENCA, DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--                                                                                AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
--ATE 6/7/20--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--ATE 6/7/20--            AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3
ON SUBSTR(TC3.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO AND SUBSTR(TC3.DADO_ORIGEM,24,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA --NOVO EM 6/7/20
LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
AND X.NEW_COD_DOENCA = DOE.CODIGO
)X
WHERE (X.DADO_ORIGEM_TC1 IS NOT NULL
OR X.DADO_ORIGEM_TG10 IS NOT NULL)--NOVO EM 30/5/22
AND X.DADO_ORIGEM_TC3 IS NOT NULL
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1 , X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22

UNION ALL

--EXCLUI TEG3
SELECT 
CASE WHEN X.DADO_ORIGEM_TG10 IS NOT NULL THEN  X.DADO_ORIGEM_TG10 ELSE  X.DADO_ORIGEM_TC1 END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN X.DADO_DESTINO_TG10 IS NOT NULL THEN  X.DADO_DESTINO_TG10 ELSE  X.DADO_DESTINO_TC1 END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
COUNT(1)QUANT, --SUM(PONTOS),
'TEG3_EXCLUI' TIPO, X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1, X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
--INTO VQUANT, VTIPO, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
FROM (
SELECT 
0.5 PONTOS,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
NULL DADO_ORIGEM_TC2, NULL DADO_DESTINO_TC2,
TC3.DADO_ORIGEM DADO_ORIGEM_TC3, TC3.DADO_DESTINO DADO_DESTINO_TC3,
C.OCOR_PROC_MED, C.CODIGO_PROC_MED, A.ANO_MES_REFERENCIA, A.VINCULO, V.TP_REGIME_TRAB_ESOCIAL, V.TP_REGIME_PREV_ESOCIAL, V.COD_CATEG_ESOCIAL
,CASE WHEN A.COD_CARGO_EFETIVO IS NULL OR A.COD_CARGO_EFETIVO = '000000000000000' THEN 'NAO' ELSE 'SIM' END TEM_CARGO_EFETIVO
--,D.OCOR_DOENCA, D.COD_DOENCA, 
,X.CODIGO_EMPRESA, TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
,DOE.CODIGO COD_DOENCA,DOE.DESCRICAO,DOE.C_LIVRE_OPCAO01 DOENCA_C_LIVRE_OPCAO01, DOE.C_LIVRE_DESCR02 DOENCA_C_LIVRE_DESCR02
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN
RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
FULL OUTER JOIN RHMEDI_RL_FICH_PRO C ON F.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND F.CODIGO_PESSOA = C.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND F.OCORRENCIA = C.OCORRENCIA
--FULL OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND D.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = X.OLD_COD_DOENCA
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))A 
--ON C.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--ERRO ATE 14/10/21
ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO--NOVO EM 14/10/21
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO --novo em 2/7/20
--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG2')TC2 ON SUBSTR(TC2.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--                                                                                AND SUBSTR(TC2.DADO_ORIGEM,25,LENGTH(TC2.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --1Ã‚Âª DOENCA 
--ATE 6/7/20--LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3 ON SUBSTR(TC3.DADO_ORIGEM,1,24) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL 
--ATE 6/7/20--            AND SUBSTR(TC3.DADO_ORIGEM,25,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA 
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG3')TC3
ON SUBSTR(TC3.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||C.CODIGO_PROC_MED||V.CODIGO AND SUBSTR(TC3.DADO_ORIGEM,24,LENGTH(TC3.DADO_ORIGEM)) =  DOE.C_LIVRE_DESCR02 --2Ã‚Âª DOENCA --NOVO EM 6/7/20

LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = C.CODIGO_PROC_MED AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--422
AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
)X
WHERE (X.DADO_ORIGEM_TC1 IS NOT NULL
OR  X.DADO_ORIGEM_TG10 IS NOT NULL) --NOVO EM 30/5/22
AND X.DADO_ORIGEM_TC3 IS NOT NULL
GROUP BY X.DADO_ORIGEM_TC1, X.DADO_DESTINO_TC1 , X.DADO_ORIGEM_TC2, X.DADO_DESTINO_TC2, X.DADO_ORIGEM_TC3, X.DADO_DESTINO_TC3
,X.TEM_CARGO_EFETIVO
,X.CODIGO_EMPRESA, X.SF_GERAL, X.SF_ESPECIFICA, X.SP_GERAL, X.SP_ESPECIFICA, X.DADO_ORIGEM_TG10, X.DADO_DESTINO_TG10--NOVO EM 30/5/22
--)X2
)
LOOP
--DBMS_OUTPUT.PUT_LINE(VQUANT ||'-'||VTIPO);

--POPULAR VARIAVEIS COM O LOOP
--SALDOS ANTES
IF C1.TIPO = 'SIM' THEN
VSIM_ANTES := VSIM_ANTES + C1.QUANT_REG;
VSIM_DEPOIS := VSIM_ANTES ;
--DBMS_OUTPUT.PUT_LINE(VSIM_ANTES);

ELSIF C1.TIPO = 'TEG2' THEN
VTEG2_ANTES := VTEG2_ANTES + C1.QUANT_REG;
VTEG2_DEPOIS := VTEG2_ANTES ;
--DBMS_OUTPUT.PUT_LINE(VTEG2_ANTES);

ELSIF C1.TIPO = 'TEG3' THEN
VTEG3_ANTES :=  VTEG3_ANTES + C1.QUANT_REG;
VTEG3_DEPOIS :=  VTEG3_ANTES ;
--DBMS_OUTPUT.PUT_LINE(VTEG3_ANTES);
END IF;
--DBMS_OUTPUT.PUT_LINE('SALDOS ANTES DENTRO LOOP: VSIM_ANTES = '||VSIM_ANTES || ' - VTEG2_ANTES = '|| VTEG2_ANTES|| ' - VTEG3_ANTES = '|| VTEG3_ANTES);

--REG. USADO
IF C1.TIPO = 'SIM_INCLUI' THEN
VSIM_INCLUI := 1;
--DBMS_OUTPUT.PUT_LINE(VSIM_INCLUI);

ELSIF C1.TIPO = 'SIM_EXCLUI' THEN
VSIM_EXCLUI := 1;
--DBMS_OUTPUT.PUT_LINE(VSIM_EXCLUI);

ELSIF C1.TIPO = 'TEG2_INCLUI' THEN
VTEG2_INCLUI := 1;
VDADO_ORIGEM_TC2 := C1.DADO_ORIGEM_TC2; 
VDADO_DESTINO_TC2  := C1.DADO_DESTINO_TC2; 
--DBMS_OUTPUT.PUT_LINE(VTEG2_INCLUI);

ELSIF C1.TIPO = 'TEG2_EXCLUI' THEN
VTEG2_EXCLUI := 1;
VDADO_ORIGEM_TC2 := C1.DADO_ORIGEM_TC2; 
VDADO_DESTINO_TC2  := C1.DADO_DESTINO_TC2; 

--DBMS_OUTPUT.PUT_LINE(VTEG2_EXCLUI);

ELSIF C1.TIPO = 'TEG3_INCLUI' THEN
VTEG3_INCLUI := 1;
VDADO_ORIGEM_TC3 := C1.DADO_ORIGEM_TC3;
VDADO_DESTINO_TC3 := C1.DADO_DESTINO_TC3;

--DBMS_OUTPUT.PUT_LINE(VTEG3_INCLUI);

ELSIF C1.TIPO = 'TEG3_EXCLUI' THEN
VTEG3_EXCLUI := 1;
VDADO_ORIGEM_TC3 := C1.DADO_ORIGEM_TC3;
VDADO_DESTINO_TC3 := C1.DADO_DESTINO_TC3;

--DBMS_OUTPUT.PUT_LINE(VTEG3_EXCLUI);

END IF;
--DBMS_OUTPUT.PUT_LINE('REG. USADO DENTRO LOOP: VSIM_INCLUI = '||VSIM_INCLUI || '  VSIM_EXCLUI = '|| VSIM_EXCLUI || '  VTEG2_INCLUI = '|| VTEG2_INCLUI || '  VTEG2_EXCLUI = '|| VTEG2_EXCLUI);


--COMENTADO 30/5/22--VDADO_ORIGEM_TC1 := C1.DADO_ORIGEM_TC1; 
--COMENTADO 30/5/22--VDADO_DESTINO_TC1 := C1.DADO_DESTINO_TC1; 
VDADO_ORIGEM_FINAL := C1.DADO_ORIGEM_FINAL; --NOVO EM 30/5/22
VDADO_DESTINO_FINAL := C1.DADO_DESTINO_FINAL; --NOVO EM 30/5/22 
VTEM_CARGO_EFETIVO := C1.TEM_CARGO_EFETIVO;

END LOOP;----FIM DO LOOP

----SALDOS DEPOIS
IF  VSIM_INCLUI <> 0 THEN
VSIM_DEPOIS := VSIM_ANTES + 1;
VSIM_ANTES  := VSIM_ANTES - 1;
ELSE
VSIM_DEPOIS := VSIM_ANTES;
END IF;

IF VTEG2_INCLUI <> 0 THEN
VTEG2_DEPOIS := VTEG2_ANTES + 1;
VTEG2_ANTES := VTEG2_ANTES - 1;
ELSE
VTEG2_DEPOIS := VTEG2_ANTES;
END IF;

IF  VTEG3_INCLUI <> 0 THEN
VTEG3_DEPOIS := VTEG3_ANTES + 1;
VTEG3_ANTES  := VTEG3_ANTES - 1;
--ELSE
--VTEG3_DEPOIS := VTEG3_ANTES;
END IF;

IF  VSIM_EXCLUI <> 0 THEN
VSIM_DEPOIS := VSIM_ANTES ;
VSIM_ANTES  := VSIM_ANTES + 1;
END IF;

IF VTEG2_EXCLUI <> 0 THEN
VTEG2_DEPOIS := VTEG2_ANTES ;
VTEG2_ANTES := VTEG2_ANTES + 1;
END IF;

IF  VTEG3_EXCLUI <> 0 THEN
VTEG3_DEPOIS := VTEG3_ANTES ;
VTEG3_ANTES := VTEG3_ANTES + 1;
END IF;



---RESULTADO FINAL FORA DO LOOP
DBMS_OUTPUT.PUT_LINE('RESULTADO FINAL FORA LOOP:' 
|| ' VSIM_ANTES = '|| VSIM_ANTES 
|| ' VSIM_INCLUI = '|| VSIM_INCLUI
|| ' VSIM_EXCLUI = '|| VSIM_EXCLUI
|| ' VSIM_DEPOIS = '|| VSIM_DEPOIS 

|| ' VTEG2_ANTES = '|| VTEG2_ANTES 
|| ' VTEG2_INCLUI = '|| VTEG2_INCLUI 
|| ' VTEG2_EXCLUI = '|| VTEG2_EXCLUI 
|| ' VTEG2_DEPOIS = '|| VTEG2_DEPOIS

|| ' VTEG3_ANTES = '|| VTEG3_ANTES
|| ' VTEG3_INCLUI = '|| VTEG3_INCLUI 
|| ' VTEG3_EXCLUI = '|| VTEG3_EXCLUI
|| ' VTEG3_DEPOIS = '|| VTEG3_DEPOIS
);

--O QUE FAZER
IF VSIM_ANTES = 0 AND VSIM_DEPOIS >= 1 AND ((VTEG2_ANTES = 0 AND VTEG3_ANTES = 0)OR(VTEG2_ANTES >= 1 AND VTEG3_ANTES = 0)OR(VTEG2_ANTES = 0 AND VTEG3_ANTES >= 1))  THEN
DBMS_OUTPUT.PUT_LINE('5-CRIA_DOENCA_GRAVE');
VFAZER := 'I-5-CRIA_DOENCA_GRAVE';

ELSIF VSIM_ANTES >= 1 AND VSIM_DEPOIS = 0 AND ((VTEG2_ANTES = 0 AND VTEG3_ANTES = 0)OR(VTEG2_ANTES >= 1 AND VTEG3_ANTES = 0)OR(VTEG2_ANTES = 0 AND VTEG3_ANTES >= 1)) THEN
DBMS_OUTPUT.PUT_LINE('6-TIRA_DOENCA_GRAVE');
VFAZER := 'E-6-TIRA_DOENCA_GRAVE';

ELSIF VSIM_ANTES = 0 AND VSIM_DEPOIS = 0 AND VTEG2_ANTES = 0 AND VTEG2_DEPOIS >= 1 AND VTEG3_ANTES >= 1 AND VTEG3_DEPOIS >= 1 THEN
DBMS_OUTPUT.PUT_LINE('20-CRIA_DOENCA_GRAVE');
VFAZER := 'I-20-CRIA_DOENCA_GRAVE';

ELSIF VSIM_ANTES = 0 AND VSIM_DEPOIS = 0 AND VTEG2_ANTES >= 1 AND VTEG2_DEPOIS = 0 AND VTEG3_ANTES >= 1 AND VTEG3_DEPOIS >= 1 THEN
DBMS_OUTPUT.PUT_LINE('21-TIRA_DOENCA_GRAVE');
VFAZER := 'E-21-TIRA_DOENCA_GRAVE';

ELSIF VSIM_ANTES = 0 AND VSIM_DEPOIS = 0 AND VTEG2_ANTES >= 1 AND VTEG2_DEPOIS >= 1 AND VTEG3_ANTES = 0 AND VTEG3_DEPOIS >= 1 THEN
DBMS_OUTPUT.PUT_LINE('22-CRIA_DOENCA_GRAVE');
VFAZER := 'I-22-CRIA_DOENCA_GRAVE';

ELSIF VSIM_ANTES = 0 AND VSIM_DEPOIS = 0 AND VTEG2_ANTES >= 1 AND VTEG2_DEPOIS >= 1 AND VTEG3_ANTES >= 1 AND VTEG3_DEPOIS = 0 THEN
DBMS_OUTPUT.PUT_LINE('23-TIRA_DOENCA_GRAVE');
VFAZER:= 'E-23-TIRA_DOENCA_GRAVE';

END IF;

DBMS_OUTPUT.PUT_LINE('VTEM_CARGO_EFETIVO:' ||VTEM_CARGO_EFETIVO||'VDADO_ORIGEM_TC1: '|| VDADO_ORIGEM_TC1 ||' VDADO_DESTINO_TC1: '||VDADO_DESTINO_TC1 || ' VDADO_ORIGEM_TC2: '|| VDADO_ORIGEM_TC2 || 'VDADO_DESTINO_TC2: '||VDADO_DESTINO_TC2 ||' VDADO_ORIGEM_TC3: '||VDADO_ORIGEM_TC3 ||' VDADO_DESTINO_TC3: '||VDADO_DESTINO_TC3);
INSERT INTO SUGESP_FICHAS_MEDICAS_LOG_TEST VALUES (VID, 'VTEM_CARGO_EFETIVO:' ||VTEM_CARGO_EFETIVO||'VFAZER: '||VFAZER ||' VDADO_ORIGEM_FINAL: '|| VDADO_ORIGEM_FINAL ||' VDADO_DESTINO_FINAL: '||VDADO_DESTINO_FINAL || ' VDADO_ORIGEM_TC2: '|| VDADO_ORIGEM_TC2 || 'VDADO_DESTINO_TC2: '||VDADO_DESTINO_TC2 ||' VDADO_ORIGEM_TC3: '||VDADO_ORIGEM_TC3 ||' VDADO_DESTINO_TC3: '||VDADO_DESTINO_TC3  ||'- VERIFICAR SITUACAO FUNCIONAL/PONTO', SYSDATE );-- NÃƒÆ’O USAR APOS TESTE E NÃƒÆ’O LEVAR PARA PRODUCAO


END;-- 2Ã‚Âº BEGIN




END IF;--FIM IF GERAL


-------******CHAMAR NO FIM A PROCEDURE PARA PROCESSAR REGRAS DE SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO
--COMENTADO 30/5/22--IF VDADO_DESTINO_TC1 IS NOT NULL 
IF VDADO_DESTINO_FINAL IS NOT NULL 
AND 
(
(VTABELA = 'RHMEDI_FICHA_MED' AND --NOVO EM 17/11/20
VNEW_DATA_INI_AFAST IS NOT NULL AND VNEW_DATA_FIM_AFAST IS NOT NULL)--NOVO EM 16/11/20
or
(VTABELA <> 'RHMEDI_FICHA_MED') --NOVO EM 17/11/20
)

THEN
DBMS_OUTPUT.PUT_LINE('CHAMA PROCEDURE PR_FICHA_MEDICA_SIT_FUNC_PONT da PR_FICHA_MED_MANUAL');
--COMENTADO 30/5/22--PR_FICHA_MEDICA_SIT_FUNC_PONT( VCODIGO_EMPRESA, VCODIGO_PESSOA, VDATA_OCORRENCIA, VOCORRENCIA, VID, VTABELA, VFAZER, VDADO_ORIGEM_TC1, VDADO_DESTINO_TC1, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3, VTEM_CARGO_EFETIVO, VORIGEM, VID_EXTERNO );
PR_FICHA_MEDICA_SIT_FUNC_PONT( VCODIGO_EMPRESA, VCODIGO_PESSOA, VDATA_OCORRENCIA, VOCORRENCIA, VID, VTABELA, VFAZER, VDADO_ORIGEM_FINAL, VDADO_DESTINO_FINAL, VDADO_ORIGEM_TC2, VDADO_DESTINO_TC2, VDADO_ORIGEM_TC3, VDADO_DESTINO_TC3, VTEM_CARGO_EFETIVO, VORIGEM, VID_EXTERNO );--AJUSTADO 30/5/22

-------******CHAMAR NO FIM A PROCEDURE PARA PROCESSAR REGRAS DE SITUAÃƒâ€¡ÃƒÆ’O FUNCIONAL/PONTO
END IF;

UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = 'S' WHERE ID = VID; COMMIT;


END;-- END 2Ã‚Âº BEGIN
END;-- 1Ã‚Âº BEGIN