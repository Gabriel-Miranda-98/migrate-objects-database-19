
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_FICHA_MEDICA_AJUSTE_FICHAS" (ID IN NUMBER) AS 
--KELLYSSON CRIADO EM 26/10/20 PARA DESFAZER SITUAcaO FUNCIONAL E PONTO ORIGINADO DE FICHAS MEDICAS QUANDO ALTERA OU EXCLUI UMA FICHA.
--EM 4/7/23 HOMOLOGACAO AJUSTE PARA VOLTAR A PESSOA DO INSS NAO PARA A 1000 MAS SIM PARA A 5130 EMAIL (Solicitação - Implementação nova rotina Ficha Médica/Situação Funcional)
BEGIN

DECLARE
VCONTADOR NUMBER;
--VLOGIN_USUARIO VARCHAR2(40);
VID NUMBER;
V_ULT_SIT_FUNC0_ATIVA  VARCHAR2(4);
num_dias NUMBER;
vDATA_DIA DATE; 

VSIT_FUNC_DEFERIDA VARCHAR2(4); --NOVO EM 1/6/22
VSIT_PONT_DEFERIDA VARCHAR2(4); --NOVO EM 1/6/22
VSIT_FUNC_DOENCA_G VARCHAR2(4); --NOVO EM 1/6/22
VSIT_PONT_DOENCA_G VARCHAR2(4); --NOVO EM 1/6/22

--vPESSOA_APOSENTADA VARCHAR2 (1); --NOVO EM 28/7/21



BEGIN

DBMS_OUTPUT.ENABLE(NULL);
VCONTADOR :=0;
--VLOGIN_USUARIO :=NULL;
VID := ID;
V_ULT_SIT_FUNC0_ATIVA := NULL;

num_dias := 0;
vDATA_DIA := null; --zera variavel
--vPESSOA_APOSENTADA := null;

VSIT_FUNC_DEFERIDA := NULL;
VSIT_PONT_DEFERIDA := NULL;
VSIT_FUNC_DOENCA_G := NULL;
VSIT_PONT_DOENCA_G := NULL;


--inicio------------------------------------------------------PARA PEGAR DADOS DA FICHA PELA TABELA DE LOG
FOR C1 IN(

SELECT 
CASE WHEN TG10.DADO_ORIGEM IS NOT NULL THEN  TG10.DADO_ORIGEM ELSE TC1.DADO_ORIGEM END DADO_ORIGEM_FINAL,--NOVO EM 30/5/22
CASE WHEN TG10.DADO_DESTINO IS NOT NULL THEN  TG10.DADO_DESTINO ELSE TC1.DADO_DESTINO END DADO_DESTINO_FINAL,--NOVO EM 30/5/22
X.TIPO_DML, X.TABELA, F.NATUREZA_EXAME PROCEDIMENTO, CASE WHEN X.TIPO_DML <> 'D' THEN C.CODIGO_PROC_MED ELSE X.OLD_CODIGO_PROC_MED END CONDUTA, V.CODIGO VINCULO, V.c_livre_sel1 SIT_FUNC_ATIVA,
F.DATA_INI_AFAST, F.DATA_FIM_AFAST,
TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
F.CODIGO_EMPRESA, F.TIPO_CONTRATO, F.CODIGO_CONTRATO, X.LOGIN_USUARIO
,X.CODIGO_PESSOA, X.DT_REG_OCORRENCIA, X.OCORRENCIA
,X.NEW_NATUREZA_EXAME, X.OLD_NATUREZA_EXAME, X.NEW_DATA_INI_AFAST, X.OLD_DATA_INI_AFAST, X.NEW_DATA_FIM_AFAST, X.OLD_DATA_FIM_AFAST
,F.EMPRESA_ATENDENTE, F.CODIGO_ATENDENTE, F.NOME_ATENDENTE, F.INSCRICAO_CONSELHO, F.UF_INSCRICAO, F.CONSELHO_REGIONAL, D.COD_DOENCA, F.INFO_MESMO_MOTIVO, F.DT_EFEITO_MESMO_MOTIVO
,X.NEW_EMPRESA_ATENDENTE, X.OLD_EMPRESA_ATENDENTE, X.NEW_CODIGO_ATENDENTE, X.OLD_CODIGO_ATENDENTE, X.NEW_NOME_ATENDENTE, X.OLD_NOME_ATENDENTE, X.NEW_INSCRICAO_CONSELHO, X.OLD_INSCRICAO_CONSELHO, X.NEW_UF_INSCRICAO, X.OLD_UF_INSCRICAO,NEW_CONSELHO_REGIONAL, X.OLD_CONSELHO_REGIONAL, X.NEW_INFO_MESMO_MOTIVO, X.OLD_INFO_MESMO_MOTIVO, X.NEW_DT_EFEITO_MESMO_MOTIVO, X.OLD_DT_EFEITO_MESMO_MOTIVO
,A.DATA_APOSENTA_FGTS, P.DATA_APOSENTA--NOVO EM 20/7/21
,TG10.SF_GERAL, TG10.SF_ESPECIFICA, TG10.SP_GERAL, TG10.SP_ESPECIFICA, TG10.DADO_ORIGEM DADO_ORIGEM_TG10, TG10.DADO_DESTINO DADO_DESTINO_TG10 --NOVO EM 30/5/22
FROM 
SUGESP_FICHAS_MEDICAS X
LEFT OUTER JOIN RHMEDI_RL_FICH_PRO C ON X.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C.CODIGO_PESSOA AND X.DT_REG_OCORRENCIA = C.DT_REG_OCORRENCIA AND X.OCORRENCIA = C.OCORRENCIA
LEFT OUTER JOIN RHMEDI_FICHA_MED F ON F.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND F.CODIGO_PESSOA = X.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND F.OCORRENCIA = X.OCORRENCIA
LEFT OUTER JOIN
RHMEDI_RL_FICH_DOE D ON D.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND D.CODIGO_PESSOA = X.CODIGO_PESSOA AND D.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND D.OCORRENCIA = X.OCORRENCIA
AND D.OCOR_DOENCA = 1
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = A.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = A.TIPO_CONTRATO AND AUX.CODIGO = A.CODIGO))
  A ON A.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND A.TIPO_CONTRATO = F.TIPO_CONTRATO AND A.CODIGO = F.CODIGO_CONTRATO
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO ='TEG1')TC1 
--ATE 2/7/20--ON SUBSTR(TC1.DADO_ORIGEM,1,24) =  F.NATUREZA_EXAME||X.OLD_CODIGO_PROC_MED||V.TP_REGIME_TRAB_ESOCIAL|| V.TP_REGIME_PREV_ESOCIAL||V.COD_CATEG_ESOCIAL --PROCEDIMENTO
ON SUBSTR(TC1.DADO_ORIGEM,1,23) = F.NATUREZA_EXAME||CASE WHEN X.TIPO_DML <> 'D' THEN C.CODIGO_PROC_MED ELSE X.OLD_CODIGO_PROC_MED END||V.CODIGO --novo em 2/7/20
LEFT OUTER JOIN RHPESS_PESSOA P ON P.CODIGO_EMPRESA = X.CODIGO_EMPRESA  AND P.CODIGO = X.CODIGO_PESSOA--NOVO EM 20/7/21

LEFT OUTER JOIN (
SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,4)PROCEDIMENTO, SUBSTR(DADO_ORIGEM,5,15)CONDUTA, SUBSTR(DADO_ORIGEM,20,4)VINCULO, SUBSTR(DADO_ORIGEM,24,4)EMPRESA, 
DADO_DESTINO, SUBSTR(DADO_DESTINO,1,4)SF_GERAL ,SUBSTR(DADO_DESTINO,5,4)SF_ESPECIFICA , SUBSTR(DADO_DESTINO,9,4)SP_GERAL ,SUBSTR(DADO_DESTINO,13,4)SP_ESPECIFICA 
FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TG10')TG10
ON TG10.PROCEDIMENTO =  F.NATUREZA_EXAME AND TG10.CONDUTA = CASE WHEN X.TIPO_DML <> 'D' THEN C.CODIGO_PROC_MED ELSE X.OLD_CODIGO_PROC_MED END AND TG10.VINCULO = V.CODIGO AND TG10.EMPRESA = X.CODIGO_EMPRESA  --NOVO EM 30/5/22

WHERE X.ID = VID--201728
--comentado em 16/11/20 devido ao cenario de tirar data de deferimento --AND F.DATA_INI_AFAST IS NOT NULL AND F.DATA_FIM_AFAST IS NOT NULL
AND (TC1.DADO_ORIGEM IS NOT NULL
OR TG10.DADO_ORIGEM IS NOT NULL) --NOVO EM 31/5/22
--fim------------------------------------------------------PARA PEGAR DADOS DA FICHA PELA TABELA DE LOG


)
LOOP
VCONTADOR :=VCONTADOR+1;
DBMS_OUTPUT.PUT_LINE('--'||VCONTADOR);
DBMS_OUTPUT.PUT_LINE('--'||C1.CODIGO_EMPRESA ||'-'|| C1.TIPO_CONTRATO ||'-'|| C1.CODIGO_CONTRATO ||'-'|| C1.DATA_INI_AFAST ||'-'|| C1.DATA_FIM_AFAST ||'-'|| C1.DADO_ORIGEM_TC1 ||'-'|| C1.DADO_DESTINO_TC1 ||'-'|| C1.PROCEDIMENTO ||'-'||C1.CONDUTA ||'-'|| C1.VINCULO ||'-'|| C1.SIT_FUNC_ATIVA);

vDATA_DIA := C1.DATA_INI_AFAST;

--NOVO INICIO -- EM 1/6/22
DBMS_OUTPUT.PUT_LINE('--C1.DADO_ORIGEM_TC1: '||C1.DADO_ORIGEM_TC1||' C1.DADO_DESTINO_TC1: '||C1.DADO_DESTINO_TC1||' C1.DADO_ORIGEM_TG10: '||C1.DADO_ORIGEM_TG10|| ' C1.DADO_DESTINO_TG10: '||C1.DADO_DESTINO_TG10||' C1.DADO_ORIGEM_FINAL: '||C1.DADO_ORIGEM_FINAL||' C1.DADO_DESTINO_FINAL: '||C1.DADO_DESTINO_FINAL);

IF LENGTH(C1.DADO_ORIGEM_FINAL) = 23 THEN
VSIT_FUNC_DEFERIDA := SUBSTR(C1.DADO_DESTINO_FINAL,1,4);--O QUE DIFERE
VSIT_PONT_DEFERIDA := SUBSTR(C1.DADO_DESTINO_FINAL,9,4);--O QUE DIFERE
VSIT_FUNC_DOENCA_G := SUBSTR(C1.DADO_DESTINO_FINAL,17,4);
VSIT_PONT_DOENCA_G := SUBSTR(C1.DADO_DESTINO_FINAL,21,4);

ELSIF LENGTH(C1.DADO_ORIGEM_FINAL) = 27 THEN
VSIT_FUNC_DEFERIDA := SUBSTR(C1.DADO_DESTINO_FINAL,5,4);--O QUE DIFERE
VSIT_PONT_DEFERIDA := SUBSTR(C1.DADO_DESTINO_FINAL,13,4);--O QUE DIFERE
VSIT_FUNC_DOENCA_G := SUBSTR(C1.DADO_DESTINO_FINAL,17,4);
VSIT_PONT_DOENCA_G := SUBSTR(C1.DADO_DESTINO_FINAL,21,4);

END IF;
DBMS_OUTPUT.PUT_LINE('--VSIT_FUNC_DEFERIDA: '|| VSIT_FUNC_DEFERIDA);
DBMS_OUTPUT.PUT_LINE('--VSIT_PONT_DEFERIDA: '|| VSIT_PONT_DEFERIDA);
DBMS_OUTPUT.PUT_LINE('--VSIT_FUNC_DOENCA_G: '|| VSIT_FUNC_DOENCA_G);
DBMS_OUTPUT.PUT_LINE('--VSIT_PONT_DOENCA_G: '|| VSIT_PONT_DOENCA_G);
--NOVO FIM -- EM 1/6/22

----INICIO ------------------------------------------------------------------------------------IF PARA SABER SE ESTA SENDO EXCLUSAO DE CONDUTA OU ALTERACAO DE PROCEDIMENTO/DATAS DEFERIMENTO DA FICHA

--INICIO--------------------------------------------------------------------------------EXCLUSAO DE CONDUTA
IF C1.TIPO_DML = 'D' AND C1.TABELA = 'RHMEDI_RL_FICH_PRO' THEN
DBMS_OUTPUT.PUT_LINE('--EXCLUSAO DE CONDUTA') ;
-- inicio ---------------------BUSCAR ULTIMA SITUAcaO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO
select A.COD_SIT_FUNCIONAL
into V_ULT_SIT_FUNC0_ATIVA
--, A.DATA_FIM_SITUACAO, A.DATA_INIC_SITUACAO, S.DESCRICAO SITUACAO_FUNCIONAL, S.CONTROLE_FOLHA, S.E_AFASTAMENTO,s.suspende_remunera, s.c_livre_selec02 SO_GERA_SIT_PONTO,S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO, p.tipo_situacao
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA --'0001'
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO--'0001'
AND A.CODIGO = C1.CODIGO_CONTRATO--'000000001109306'
AND
A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX
                                WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO
                                AND trunc(AUX.DATA_INIC_SITUACAO) < TRUNC(C1.DATA_INI_AFAST))
AND S.CONTROLE_FOLHA = 'N' and S.E_AFASTAMENTO = 'N' and S.suspende_remunera = 'N' AND S.C_LIVRE_SELEC02 = '2';
-- inicio ---------------------BUSCAR ULTIMA SITUAcao FUNCIONAL TIPO ATIVA ANTES DO ATESTADO


IF (C1.DATA_APOSENTA_FGTS IS NOT NULL OR C1.DATA_APOSENTA IS NOT NULL) AND C1.CONDUTA = '000000000000038' 
AND C1.SF_ESPECIFICA IS NULL --NOVO EM 25/7/22
THEN--IF NOVO EM 15/10/21
--INICIO----------------------------------------------------1 PARTE para TROCAR A SITUACAO FUNCIONAL DA FICHA EM ATIVO
FOR C2 IN(
SELECT   A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO,
A.COD_SIT_FUNCIONAL COD_SIT_FUNC, S.DESCRICAO SITUACAO_FUNCIONAL, S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO,  A.DATA_INIC_SITUACAO , A.DATA_FIM_SITUACAO 
FROM RHCGED_ALT_SIT_FUN A 
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA  
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO 
AND A.CODIGO = C1.CODIGO_CONTRATO
AND 
((TRUNC(A.DATA_INIC_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST)) OR (TRUNC(A.DATA_FIM_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST))OR (TRUNC(A.DATA_INIC_SITUACAO) <= TRUNC(C1.DATA_INI_AFAST) AND TRUNC(A.DATA_FIM_SITUACAO) >= TRUNC(C1.DATA_FIM_AFAST)) )
AND A.COD_SIT_FUNCIONAL = '6121'
)
LOOP
DBMS_OUTPUT.PUT_LINE('--'||C2.COD_SIT_FUNC ||'-'|| C2.SITUACAO_FUNCIONAL||'-'|| C2.COD_SIT_PONTO||'-'|| C2.SITUACAO_PONTO||'-'|| C2.DATA_INIC_SITUACAO||'-'|| C2.DATA_FIM_SITUACAO );
--INICIO--IF PARA O QUE FAZER
DBMS_OUTPUT.PUT_LINE('TROCA A SITUACAO FUNCIONAL DA FICHA PARA ATIVA DO VINCULO');
DBMS_OUTPUT.PUT_LINE('ENTAO TROCA A SIT FUNC LANCADA PELA A DA FICHA MEDICA');

UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = V_ULT_SIT_FUNC0_ATIVA,  LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE   WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INIC_SITUACAO);  COMMIT;
--DBMS_OUTPUT.PUT_LINE('UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = '''|| V_ULT_SIT_FUNC0_ATIVA || ''', LOGIN_USUARIO = '''|| C1.LOGIN_USUARIO ||''', DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = '''|| C1.CODIGO_EMPRESA ||''' AND TIPO_CONTRATO = '''|| C1.TIPO_CONTRATO ||''' AND CODIGO = '''|| C1.CODIGO_CONTRATO || ''' AND TRUNC(DATA_INIC_SITUACAO) = TO_DATE('''||C2.DATA_INIC_SITUACAO||''',''DD/MM/YYYY''); COMMIT;');
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,C1.LOGIN_USUARIO);
--DBMS_OUTPUT.PUT_LINE('SUGESP_ALT_SIT_FUNC_ULT_CONTRA('''||C1.CODIGO_EMPRESA ||''','''|| C1.TIPO_CONTRATO ||''','''|| C1.CODIGO_CONTRATO ||''','''|| C1.LOGIN_USUARIO||''');');
END LOOP; ---FIM C2
--FIM----------------------------------------------------1 PARTE para TROCAR A SITUACAO FUNCIONAL DA FICHA EM ATIVO
--INICIO-------------------------------------------------2 PARTE para apagar SITUACAO DE PONTO quando nÃ£o se altera a SITUACAO FUNCIONAL
DELETE RHPONT_RES_SIT_DIA WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO_CONTRATO = C1.CODIGO_CONTRATO 
AND trunc(DATA) BETWEEN trunc(C1.DATA_INI_AFAST) AND trunc(C1.DATA_FIM_AFAST) AND CODIGO_SITUACAO = (SELECT situacao_ponto FROM RHPARM_SIT_FUNC WHERE CODIGO = '6121');COMMIT;
--FIM-------------------------------------------------2 PARTE para apagar SITUACAO DE PONTO quando nÃ£o se altera a SITUACAO FUNCIONAL



ELSE -- SIT FUNC <> 6121 E CONDUTA <> 38
--INICIO----------------------------------------------------1 PARTE para TROCAR A SITUACAO FUNCIONAL DA FICHA EM ATIVO
FOR C2 IN(
SELECT   A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO,
A.COD_SIT_FUNCIONAL COD_SIT_FUNC, S.DESCRICAO SITUACAO_FUNCIONAL, S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO,  A.DATA_INIC_SITUACAO , A.DATA_FIM_SITUACAO 
FROM RHCGED_ALT_SIT_FUN A 
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA  
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO 
AND A.CODIGO = C1.CODIGO_CONTRATO
AND 
((TRUNC(A.DATA_INIC_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST)) OR (TRUNC(A.DATA_FIM_SITUACAO) BETWEEN TRUNC(C1.DATA_INI_AFAST) AND TRUNC(C1.DATA_FIM_AFAST))OR (TRUNC(A.DATA_INIC_SITUACAO) <= TRUNC(C1.DATA_INI_AFAST) AND TRUNC(A.DATA_FIM_SITUACAO) >= TRUNC(C1.DATA_FIM_AFAST)) )
AND A.COD_SIT_FUNCIONAL IN ( VSIT_FUNC_DEFERIDA, VSIT_FUNC_DOENCA_G --NOVO EM 1/6/22
--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4), SUBSTR(C1.DADO_DESTINO_TC1,17,4)
)
)
LOOP
DBMS_OUTPUT.PUT_LINE('--'||C2.COD_SIT_FUNC ||'-'|| C2.SITUACAO_FUNCIONAL||'-'|| C2.COD_SIT_PONTO||'-'|| C2.SITUACAO_PONTO||'-'|| C2.DATA_INIC_SITUACAO||'-'|| C2.DATA_FIM_SITUACAO );
--INICIO--IF PARA O QUE FAZER
DBMS_OUTPUT.PUT_LINE('TROCA A SITUACAO FUNCIONAL DA FICHA PARA ATIVA DO VINCULO');
DBMS_OUTPUT.PUT_LINE('ENTAO TROCA A SIT FUNC LANCADA PELA A DA FICHA MEDICA');

UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = V_ULT_SIT_FUNC0_ATIVA,  LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE   WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INIC_SITUACAO);  COMMIT;
--DBMS_OUTPUT.PUT_LINE('UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = '''|| V_ULT_SIT_FUNC0_ATIVA || ''', LOGIN_USUARIO = '''|| C1.LOGIN_USUARIO ||''', DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = '''|| C1.CODIGO_EMPRESA ||''' AND TIPO_CONTRATO = '''|| C1.TIPO_CONTRATO ||''' AND CODIGO = '''|| C1.CODIGO_CONTRATO || ''' AND TRUNC(DATA_INIC_SITUACAO) = TO_DATE('''||C2.DATA_INIC_SITUACAO||''',''DD/MM/YYYY''); COMMIT;');
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,C1.LOGIN_USUARIO);
--DBMS_OUTPUT.PUT_LINE('SUGESP_ALT_SIT_FUNC_ULT_CONTRA('''||C1.CODIGO_EMPRESA ||''','''|| C1.TIPO_CONTRATO ||''','''|| C1.CODIGO_CONTRATO ||''','''|| C1.LOGIN_USUARIO||''');');
END LOOP; ---FIM C2
--FIM----------------------------------------------------1 PARTE para TROCAR A SITUACAO FUNCIONAL DA FICHA EM ATIVO
--INICIO-------------------------------------------------2 PARTE para apagar SITUACAO DE PONTO quando nÃ£o se altera a SITUACAO FUNCIONAL
DELETE RHPONT_RES_SIT_DIA WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO_CONTRATO = C1.CODIGO_CONTRATO 
AND trunc(DATA) BETWEEN trunc(C1.DATA_INI_AFAST) AND trunc(C1.DATA_FIM_AFAST) AND CODIGO_SITUACAO IN ( VSIT_PONT_DEFERIDA, VSIT_PONT_DOENCA_G --NOVO EM 1/6/22
--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,9,4), SUBSTR(C1.DADO_DESTINO_TC1,21,4)
);COMMIT;
--FIM-------------------------------------------------2 PARTE para apagar SITUACAO DE PONTO quando nÃ£o se altera a SITUACAO FUNCIONAL



END IF; --IF NOVO EM 15/10/21

--FIM -----------------------------------------------------------------------------------------------EXCLUSAO DE CONDUTA


----------------------------------------------------------------------------------****************************************************************-------------------------------


--INICIO  ------------------------------------------------------------------------------ALTERACAO DE PROCEDIMENTO OU DATA DEFERIMENTO OU TIROU DATAS DEFERIMENTO
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND 
(
(C1.NEW_NATUREZA_EXAME IS NOT NULL AND C1.OLD_NATUREZA_EXAME IS NOT NULL AND C1.NEW_NATUREZA_EXAME <> C1.OLD_NATUREZA_EXAME) OR
(C1.NEW_DATA_INI_AFAST IS NOT NULL AND C1.OLD_DATA_INI_AFAST IS NOT NULL AND C1.NEW_DATA_INI_AFAST <> C1.OLD_DATA_INI_AFAST) OR
(C1.NEW_DATA_FIM_AFAST IS NOT NULL AND C1.OLD_DATA_FIM_AFAST IS NOT NULL AND C1.NEW_DATA_FIM_AFAST <> C1.OLD_DATA_FIM_AFAST)
--inicio--NOVO 16/11/20
OR
(
(C1.OLD_DATA_INI_AFAST IS NOT NULL AND C1.NEW_DATA_INI_AFAST IS NULL )AND --MUDEI DE OR PARA AND EM 17/11/20 --TINHA DATA AGORA NAO TEM
(C1.OLD_DATA_FIM_AFAST IS NOT NULL AND C1.NEW_DATA_FIM_AFAST IS NULL )--TINHA DATA AGORA NAO TEM
)
--FIM--NOVO 16/11/20
)
THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DE PROCEDIMENTO OU DATA DEFERIMENTO OU TIROU DATAS');

--INICIO --PARTE OLD
-- inicio ---------------------BUSCAR ULTIMA SITUAÃ‡ÃƒO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO
select A.COD_SIT_FUNCIONAL
into V_ULT_SIT_FUNC0_ATIVA
--, A.DATA_FIM_SITUACAO, A.DATA_INIC_SITUACAO, S.DESCRICAO SITUACAO_FUNCIONAL, S.CONTROLE_FOLHA, S.E_AFASTAMENTO,s.suspende_remunera, s.c_livre_selec02 SO_GERA_SIT_PONTO,S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO, p.tipo_situacao
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA --'0001'
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO--'0001'
AND A.CODIGO = C1.CODIGO_CONTRATO--'000000001109306'
AND
A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX
                                 LEFT OUTER JOIN RHPARM_SIT_FUNC SX ON SX.CODIGO = AUX.COD_SIT_FUNCIONAL
                                WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO
                                AND trunc(AUX.DATA_INIC_SITUACAO) < TRUNC(C1.OLD_DATA_INI_AFAST)
                                AND SX.CONTROLE_FOLHA = 'N' and SX.E_AFASTAMENTO = 'N' and SX.suspende_remunera = 'N' AND SX.C_LIVRE_SELEC02 = '2')
AND S.CONTROLE_FOLHA = 'N' and S.E_AFASTAMENTO = 'N' and S.suspende_remunera = 'N' AND S.C_LIVRE_SELEC02 = '2';
-- FIM ---------------------BUSCAR ULTIMA SITUAÃ‡ÃƒO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO


--INICIO----------------------------------------------------1 PARTE para TROCAR A SITUACAO FUNCIONAL DA FICHA EM ATIVO

FOR C2 IN(

SELECT   A.CODIGO_EMPRESA, A.TIPO_CONTRATO, A.CODIGO,
A.COD_SIT_FUNCIONAL COD_SIT_FUNC, S.DESCRICAO SITUACAO_FUNCIONAL, S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO,  A.DATA_INIC_SITUACAO , A.DATA_FIM_SITUACAO 
FROM RHCGED_ALT_SIT_FUN A 
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA  
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO 
AND A.CODIGO = C1.CODIGO_CONTRATO
AND 
((TRUNC(A.DATA_INIC_SITUACAO) BETWEEN TRUNC(C1.OLD_DATA_INI_AFAST) AND TRUNC(C1.OLD_DATA_FIM_AFAST)) 
OR (TRUNC(A.DATA_FIM_SITUACAO) BETWEEN TRUNC(C1.OLD_DATA_INI_AFAST) AND TRUNC(C1.OLD_DATA_FIM_AFAST))
OR (TRUNC(A.DATA_INIC_SITUACAO) <= TRUNC(C1.OLD_DATA_INI_AFAST) AND TRUNC(A.DATA_FIM_SITUACAO) >= TRUNC(C1.OLD_DATA_FIM_AFAST)) )
AND A.COD_SIT_FUNCIONAL IN (VSIT_FUNC_DEFERIDA, VSIT_FUNC_DOENCA_G --NOVO EM 1/6/22
--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4), SUBSTR(C1.DADO_DESTINO_TC1,17,4)
)
ORDER BY A.DATA_INIC_SITUACAO
)
LOOP
DBMS_OUTPUT.PUT_LINE('--'||C2.COD_SIT_FUNC ||'-'|| C2.SITUACAO_FUNCIONAL||'-'|| C2.COD_SIT_PONTO||'-'|| C2.SITUACAO_PONTO||'-'|| C2.DATA_INIC_SITUACAO||'-'|| C2.DATA_FIM_SITUACAO );

--INICIO--IF PARA O QUE FAZER
DBMS_OUTPUT.PUT_LINE('PARTE OLD- TROCA A SITUACAO FUNCIONAL DA FICHA PARA ATIVA DO VINCULO. ENTAO TROCA A SIT FUNC LANCADA PELA A DA FICHA MEDICA');

UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = V_ULT_SIT_FUNC0_ATIVA,  LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE   WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INIC_SITUACAO);  COMMIT;
--DBMS_OUTPUT.PUT_LINE('UPDATE RHCGED_ALT_SIT_FUN SET COD_SIT_FUNCIONAL = '''|| V_ULT_SIT_FUNC0_ATIVA || ''', LOGIN_USUARIO = '''|| C1.LOGIN_USUARIO ||''', DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = '''|| C1.CODIGO_EMPRESA ||''' AND TIPO_CONTRATO = '''|| C1.TIPO_CONTRATO ||''' AND CODIGO = '''|| C1.CODIGO_CONTRATO || ''' AND TRUNC(DATA_INIC_SITUACAO) = TO_DATE('''||C2.DATA_INIC_SITUACAO||''',''DD/MM/YYYY''); COMMIT;');
SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO ,C1.LOGIN_USUARIO);
--DBMS_OUTPUT.PUT_LINE('SUGESP_ALT_SIT_FUNC_ULT_CONTRA('''||C1.CODIGO_EMPRESA ||''','''|| C1.TIPO_CONTRATO ||''','''|| C1.CODIGO_CONTRATO ||''','''|| C1.LOGIN_USUARIO||''');');

END LOOP; ---FIM C2
--FIM----------------------------------------------------1 PARTE para TROCAR A SITUACAO FUNCIONAL DA FICHA EM ATIVO

--INICIO-------------------------------------------------2 PARTE para apagar SITUACAO DE PONTO quando nÃ£o se altera a SITUACAO FUNCIONAL
DELETE RHPONT_RES_SIT_DIA WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO_CONTRATO = C1.CODIGO_CONTRATO 
AND trunc(DATA) BETWEEN trunc(C1.OLD_DATA_INI_AFAST) AND trunc(C1.OLD_DATA_FIM_AFAST) AND CODIGO_SITUACAO IN (VSIT_PONT_DEFERIDA, VSIT_PONT_DOENCA_G --NOVO EM 1/6/22
--COMENTADO EM 1/6/22-SUBSTR(C1.DADO_DESTINO_TC1,9,4), SUBSTR(C1.DADO_DESTINO_TC1,21,4)
);COMMIT;
--FIM-------------------------------------------------2 PARTE para apagar SITUACAO DE PONTO quando nÃ£o se altera a SITUACAO FUNCIONAL

--FIM--PARTE OLD

--INICIO --PARTE NEW
 --INICIO IF NOVO EM 16/11/20
IF (C1.NEW_NATUREZA_EXAME IS NOT NULL AND C1.OLD_NATUREZA_EXAME IS NOT NULL AND C1.NEW_NATUREZA_EXAME <> C1.OLD_NATUREZA_EXAME) OR
(C1.NEW_DATA_INI_AFAST IS NOT NULL AND C1.OLD_DATA_INI_AFAST IS NOT NULL AND C1.NEW_DATA_INI_AFAST <> C1.OLD_DATA_INI_AFAST) OR
(C1.NEW_DATA_FIM_AFAST IS NOT NULL AND C1.OLD_DATA_FIM_AFAST IS NOT NULL AND C1.NEW_DATA_FIM_AFAST <> C1.OLD_DATA_FIM_AFAST)
THEN
--inicio--reprocessar conduta da ficha
FOR C3 IN

(

SELECT * FROM SUGESP_FICHAS_MEDICAS WHERE TABELA = 'RHMEDI_RL_FICH_PRO' 
AND ID = (
      SELECT MAX(X.ID) FROM SUGESP_FICHAS_MEDICAS X WHERE X.TABELA = 'RHMEDI_RL_FICH_PRO' AND X.TIPO_DML IN ('I','U') AND
            EXISTS (SELECT A.CODIGO_EMPRESA, A.CODIGO_PESSOA, A.DT_REG_OCORRENCIA, A.OCORRENCIA FROM SUGESP_FICHAS_MEDICAS A WHERE A.ID = VID--201758
                        AND A.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND A.CODIGO_PESSOA = X.CODIGO_PESSOA
                        AND A.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND A.OCORRENCIA = X.OCORRENCIA)
                        )

)                        
LOOP
DBMS_OUTPUT.PUT_LINE('PARTE NEW-CHAMA PROCEDURE PR_FICHA_MEDICA_SIT_FUNC_PONT (I-INCLUIU_CONDUTA) da PR_FICHA_MEDICA_AJUSTE_FICHAS: C3.ID = '||C3.ID||' ALTERACAO DE PROCEDIMENTO OU DATA DEFERIMENTO OU TIROU DATAS DEFERIMENTO');
PR_FICHA_MEDICA_SIT_FUNC_PONT( C3.CODIGO_EMPRESA, C3.CODIGO_PESSOA, TO_CHAR(C3.DT_REG_OCORRENCIA,'YYYYMMDD'), C3.OCORRENCIA, C3.ID, C3.TABELA, 'I-INCLUIU_CONDUTA', C1.DADO_ORIGEM_FINAL, C1.DADO_DESTINO_FINAL, --COMENTADO E TROCADO 25/7/22--C1.DADO_ORIGEM_TC1, C1.DADO_DESTINO_TC1,
NULL, NULL, NULL, NULL, NULL, 'M', C3.ID);


END LOOP; --FIM C3
END IF; --FIM IF NOVO EM 16/11/20
--fim--reprocessar conduta da ficha
--FIM--PARTE NEW
--FIM----------------------------------------------------------------------------ALTERACAO DE PROCEDIMENTO OU DATA DEFERIMENTO OU TIROU DATAS DEFERIMENTO


--INICIO-------------------------------------------------------------------------------ALTERACAO DATA DEFERIMENTO NAO TINHA E COLOCOU DATAS
--inicio ELSEIF NOVO EM 16/11/20
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND (
 (C1.OLD_DATA_INI_AFAST IS NULL AND C1.NEW_DATA_INI_AFAST IS NOT NULL )AND --MUDEI DE OR PARA AND EM 17/11/20 --NAO TINHA DATA AGORA TEM
(C1.OLD_DATA_FIM_AFAST IS NULL AND C1.NEW_DATA_FIM_AFAST IS NOT NULL )--NAO TINHA DATA AGORA TEM
) THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DATA DEFERIMENTO NAO TINHA E COLOCOU DATAS');
--INICIO --PARTE NEW
--inicio--reprocessar conduta da ficha
FOR C3 IN
(

SELECT * FROM SUGESP_FICHAS_MEDICAS WHERE TABELA = 'RHMEDI_RL_FICH_PRO' 
AND ID = (
      SELECT MAX(X.ID) FROM SUGESP_FICHAS_MEDICAS X WHERE X.TABELA = 'RHMEDI_RL_FICH_PRO' AND X.TIPO_DML IN ('I','U') AND
            EXISTS (SELECT A.CODIGO_EMPRESA, A.CODIGO_PESSOA, A.DT_REG_OCORRENCIA, A.OCORRENCIA FROM SUGESP_FICHAS_MEDICAS A WHERE A.ID = VID--201758
                        AND A.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND A.CODIGO_PESSOA = X.CODIGO_PESSOA
                        AND A.DT_REG_OCORRENCIA = X.DT_REG_OCORRENCIA AND A.OCORRENCIA = X.OCORRENCIA)
                        )

)                        
LOOP
DBMS_OUTPUT.PUT_LINE('PARTE NEW-CHAMA PROCEDURE PR_FICHA_MEDICA_SIT_FUNC_PONT (I-INCLUIU_CONDUTA) da PR_FICHA_MEDICA_AJUSTE_FICHAS: C3.ID = '||C3.ID||' ALTERACAO DATA DEFERIMENTO NAO TINHA E COLOCOU DATAS');
PR_FICHA_MEDICA_SIT_FUNC_PONT( C3.CODIGO_EMPRESA, C3.CODIGO_PESSOA, TO_CHAR(C3.DT_REG_OCORRENCIA,'YYYYMMDD'), C3.OCORRENCIA, C3.ID, C3.TABELA, 'I-INCLUIU_CONDUTA', C1.DADO_ORIGEM_FINAL, C1.DADO_DESTINO_FINAL, --COMENTADO E TROCADO 25/7/22--C1.DADO_ORIGEM_TC1, C1.DADO_DESTINO_TC1,
NULL, NULL, NULL, NULL, NULL, 'M', C3.ID);

END LOOP; --FIM C3
--FIM ELSEIF NOVO EM 16/11/20
--FIM-------------------------------------------------------------------------------ALTERACAO DATA DEFERIMENTO NAO TINHA E COLOCOU DATAS

---inicio------------------------------------------------**************************************CENARIOS CONDUTA 38/37 **************************----------------------------------------

--INICIO--------------------------------------------------INSERINDO DATA INICIO CONDUTA 38/37--INICIO EM 19/11/20
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND C1.CONDUTA in ('000000000000038','000000000000037') --ajustado em 19/07/21 para conduta 37 
AND (
 (C1.OLD_DATA_INI_AFAST IS NULL AND C1.NEW_DATA_INI_AFAST IS NOT NULL )AND --MUDEI DE OR PARA AND EM 17/11/20 --NAO TINHA DATA AGORA TEM
(C1.OLD_DATA_FIM_AFAST IS NULL AND C1.NEW_DATA_FIM_AFAST IS NULL )--NAO TINHA E CONTINUA SEM DATA FIM
) THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DATA DEFERIMENTO INSERINDO DATA INICIO CONDUTA 38/37');
FOR C2 IN
(
--ultima situacao funcional da pessoa antes do periodo de deferimento da ficha medica
select
A.COD_SIT_FUNCIONAL, S.DESCRICAO SITUACAO_FUNCIONAL,A.DATA_INIC_SITUACAO,A.DATA_FIM_SITUACAO, S.CONTROLE_FOLHA, S.E_AFASTAMENTO, S.SUSPENDE_REMUNERA
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND A.CODIGO = C1.CODIGO_CONTRATO 
AND((A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX
        WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO) ) )
)
LOOP

IF TRUNC(C2.DATA_INIC_SITUACAO) <= TRUNC(C1.NEW_DATA_INI_AFAST) AND C2.DATA_FIM_SITUACAO IS NULL 
AND C2.CONTROLE_FOLHA = 'N' AND  C2.E_AFASTAMENTO = 'N' AND C2.SUSPENDE_REMUNERA = 'N' THEN
DBMS_OUTPUT.PUT_LINE('--GRAVA DATA FIM SIT FUNC ATIVA');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = TRUNC(C1.NEW_DATA_INI_AFAST)-1 , LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C2.DATA_INIC_SITUACAO);
COMMIT;
END IF;

IF (TRUNC(C2.DATA_INIC_SITUACAO) <= TRUNC(C1.NEW_DATA_INI_AFAST) AND C2.DATA_FIM_SITUACAO IS NULL 
AND C2.CONTROLE_FOLHA = 'N' AND  C2.E_AFASTAMENTO = 'N' AND C2.SUSPENDE_REMUNERA = 'N')
OR
(TRUNC(C2.DATA_INIC_SITUACAO) <= TRUNC(C1.NEW_DATA_INI_AFAST) AND (C2.DATA_FIM_SITUACAO IS NOT NULL AND TRUNC(C2.DATA_FIM_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST)-1)
AND C2.CONTROLE_FOLHA = 'L')
THEN
DBMS_OUTPUT.PUT_LINE('--CRIA REGISTRO DE AFASTAMENTO PELO INSS');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO
AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST)/*--comentado em 17/12/20--AND COD_SIT_FUNCIONAL = SUBSTR(C1.DADO_DESTINO_TC1,1,4)*/;COMMIT;

      IF (C1.DATA_APOSENTA_FGTS IS NOT NULL OR C1.DATA_APOSENTA IS NOT NULL) 
      AND C1.SF_ESPECIFICA IS NULL --NOVO EM 25/7/22
      THEN--NOVO EM 20/07/21
      INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA
      ,EMPRESA_ATENDENTE, CODIGO_ATENDENTE, NOME_ATENDENTE, INSCRICAO_CONSELHO, UF_CONSELHO, CONSELHO_REGIONAL, CODIGO_DOENCA, INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO)
      VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.NEW_DATA_INI_AFAST), '6121', C1.LOGIN_USUARIO, SYSDATE
      ,C1.EMPRESA_ATENDENTE, C1.CODIGO_ATENDENTE, C1.NOME_ATENDENTE, C1.INSCRICAO_CONSELHO, C1.UF_INSCRICAO, C1.CONSELHO_REGIONAL, C1.COD_DOENCA, C1.INFO_MESMO_MOTIVO, C1.DT_EFEITO_MESMO_MOTIVO);
      COMMIT;
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);
      ELSE
      INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA
      ,EMPRESA_ATENDENTE, CODIGO_ATENDENTE, NOME_ATENDENTE, INSCRICAO_CONSELHO, UF_CONSELHO, CONSELHO_REGIONAL, CODIGO_DOENCA, INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO)
      VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.NEW_DATA_INI_AFAST), VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22
      --COMENTADO EM 1/6/22- SUBSTR(C1.DADO_DESTINO_TC1,1,4)
      , C1.LOGIN_USUARIO, SYSDATE
      ,C1.EMPRESA_ATENDENTE, C1.CODIGO_ATENDENTE, C1.NOME_ATENDENTE, C1.INSCRICAO_CONSELHO, C1.UF_INSCRICAO, C1.CONSELHO_REGIONAL, C1.COD_DOENCA, C1.INFO_MESMO_MOTIVO, C1.DT_EFEITO_MESMO_MOTIVO);
      COMMIT;
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);
      END IF; --NOVO EM 20/07/21

END IF;

--inicio --novo em 22/2/20
/*
IF (TRUNC(C2.DATA_INIC_SITUACAO) > TRUNC(C1.NEW_DATA_INI_AFAST)-- AND C2.DATA_FIM_SITUACAO IS NULL 
AND C2.CONTROLE_FOLHA = 'N' AND  C2.E_AFASTAMENTO = 'N' AND C2.SUSPENDE_REMUNERA = 'N')
THEN
DBMS_OUTPUT.PUT_LINE('--CRIA REGISTRO DE AFASTAMENTO PELO INSS');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO
AND TRUNC(DATA_INIC_SITUACAO) > TRUNC(C1.NEW_DATA_INI_AFAST) 
and COD_SIT_FUNCIONAL IN (SELECT S.CODIGO FROM RHPARM_SIT_FUNC S WHERE S.CONTROLE_FOLHA = 'N' AND  S.E_AFASTAMENTO = 'N' AND S.SUSPENDE_REMUNERA = 'N');COMMIT;
      INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA
      ,EMPRESA_ATENDENTE, CODIGO_ATENDENTE, NOME_ATENDENTE, INSCRICAO_CONSELHO, UF_CONSELHO, CONSELHO_REGIONAL, CODIGO_DOENCA)
      VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.NEW_DATA_INI_AFAST), SUBSTR(C1.DADO_DESTINO_TC1,1,4), C1.LOGIN_USUARIO, SYSDATE
      ,C1.EMPRESA_ATENDENTE, C1.CODIGO_ATENDENTE, C1.NOME_ATENDENTE, C1.INSCRICAO_CONSELHO, C1.UF_INSCRICAO, C1.CONSELHO_REGIONAL, C1.COD_DOENCA);
      COMMIT;
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);
END IF;
*/
--fim --novo em 22/2/20

END LOOP; ---FIM C2
--FIM--------------------------------------------------INSERINDO DATA INICIO CONDUTA 38/37 --INICIO EM 19/11/20


--INICIO--------------------------------------------------EXCLUINDO DATA INICIO CONDUTA 38/37--INICIO EM 20/11/20
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND C1.CONDUTA in ('000000000000038','000000000000037') --ajustado em 19/07/21 para conduta 37 
AND (
 (C1.OLD_DATA_INI_AFAST IS NOT NULL AND C1.NEW_DATA_INI_AFAST IS NULL )AND --MUDEI DE OR PARA AND EM 17/11/20 --TINHA DATA AGORA NAO TEM
(C1.OLD_DATA_FIM_AFAST IS NULL AND C1.NEW_DATA_FIM_AFAST IS NULL )--NAO TINHA E CONTINUA SEM DATA FIM
) THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DATA DEFERIMENTO EXCLUINDO DATA INICIO CONDUTA 38/37');
FOR C2 IN
(
--ultima situacao funcional da pessoa antes do periodo de deferimento da ficha medica
select
A.COD_SIT_FUNCIONAL, S.DESCRICAO SITUACAO_FUNCIONAL, A.DATA_INIC_SITUACAO ,A.DATA_FIM_SITUACAO, S.CONTROLE_FOLHA, S.E_AFASTAMENTO, S.SUSPENDE_REMUNERA
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND A.CODIGO = C1.CODIGO_CONTRATO
AND ((A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX WHERE
    A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO) ) )
)
LOOP
IF TRUNC(C2.DATA_INIC_SITUACAO) = TRUNC(C1.OLD_DATA_INI_AFAST) AND C2.DATA_FIM_SITUACAO IS NULL 
AND C2.COD_SIT_FUNCIONAL IN ( VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22-- SUBSTR(C1.DADO_DESTINO_TC1,1,4)
, '6121')--AJUSTADO EM 20/07/21
THEN
DBMS_OUTPUT.PUT_LINE('--EXCLUI REGISTRO DE AFASTAMENTO INSS NA SIT FUNC E EXECUTA PROCEDURE SIT FUNC PARA ATUALIZAR CONTRATO');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.OLD_DATA_INI_AFAST) 
AND COD_SIT_FUNCIONAL IN (VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4)
, '6121');COMMIT;--AJUSTADO EM 20/07/21
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);
--inicio -- novo em 22/12/20
-- inicio ---------------------BUSCAR ULTIMA SITUAÃ‡ÃƒO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO
select A.COD_SIT_FUNCIONAL
into V_ULT_SIT_FUNC0_ATIVA
--, A.DATA_FIM_SITUACAO, A.DATA_INIC_SITUACAO, S.DESCRICAO SITUACAO_FUNCIONAL, S.CONTROLE_FOLHA, S.E_AFASTAMENTO,s.suspende_remunera, s.c_livre_selec02 SO_GERA_SIT_PONTO,S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO, p.tipo_situacao
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA --'0001'
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO--'0001'
AND A.CODIGO = C1.CODIGO_CONTRATO--'000000001109306'
AND
A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX
                                 LEFT OUTER JOIN RHPARM_SIT_FUNC SX ON SX.CODIGO = AUX.COD_SIT_FUNCIONAL
                                WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO
                                AND trunc(AUX.DATA_INIC_SITUACAO) < TRUNC(C1.OLD_DATA_INI_AFAST)
                                AND SX.CONTROLE_FOLHA = 'N' and SX.E_AFASTAMENTO = 'N' and SX.suspende_remunera = 'N' AND SX.C_LIVRE_SELEC02 = '2')
AND S.CONTROLE_FOLHA = 'N' and S.E_AFASTAMENTO = 'N' and S.suspende_remunera = 'N' AND S.C_LIVRE_SELEC02 = '2';
-- FIM ---------------------BUSCAR ULTIMA SITUAÃ‡ÃƒO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO

      INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA )
      VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.OLD_DATA_INI_AFAST), V_ULT_SIT_FUNC0_ATIVA, C1.LOGIN_USUARIO, SYSDATE);
      COMMIT;
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);
--fim-- novo em 22/12/20

END IF;
END LOOP; ---FIM C2
--FIM--------------------------------------------------EXCLUINDO DATA INICIO CONDUTA 38/37 --INICIO EM 20/11/20


--INICIO--------------------------------------------------INSERINDO DATA FIM CONDUTA 38/37-INICIO EM 20/11/20
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND C1.CONDUTA in ('000000000000038','000000000000037') --ajustado em 19/07/21 para conduta 37 
AND (
 (C1.OLD_DATA_INI_AFAST IS NOT NULL AND C1.NEW_DATA_INI_AFAST IS NOT NULL )AND -- TINHA E CONTINUA DATA INICIO 
(C1.OLD_DATA_FIM_AFAST IS NULL AND C1.NEW_DATA_FIM_AFAST IS NOT NULL )--NAO TINHA E TEM DATA FIM
) THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DATA DEFERIMENTO INSERINDO DATA FIM CONDUTA 38/37');
FOR C2 IN
(
--ultima situacao funcional da pessoa antes do periodo de deferimento da ficha medica
select
A.COD_SIT_FUNCIONAL, S.DESCRICAO SITUACAO_FUNCIONAL,A.DATA_INIC_SITUACAO,A.DATA_FIM_SITUACAO, S.CONTROLE_FOLHA, S.E_AFASTAMENTO, S.SUSPENDE_REMUNERA
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND A.CODIGO = C1.CODIGO_CONTRATO 
AND((A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO) ) )
)
LOOP
IF TRUNC(C2.DATA_INIC_SITUACAO) = TRUNC(C1.OLD_DATA_INI_AFAST) AND C2.DATA_FIM_SITUACAO IS NULL 
AND C2.COD_SIT_FUNCIONAL IN (VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22-- SUBSTR(C1.DADO_DESTINO_TC1,1,4)
, '6121')--AJUSTADO EM 20/7/21
THEN
DBMS_OUTPUT.PUT_LINE('--GRAVA DATA FIM SIT FUNC DE AFASTAMENTO PELO INSS E COLOCA PESSOA ATIVA SE DATA FIM PASSOU OU COM PROXIMA SITUACAO ATIVA SE NAO PASSOU');
-- inicio ---------------------BUSCAR ULTIMA SITUAÃ‡ÃƒO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO
select A.COD_SIT_FUNCIONAL
into V_ULT_SIT_FUNC0_ATIVA
--, A.DATA_FIM_SITUACAO, A.DATA_INIC_SITUACAO, S.DESCRICAO SITUACAO_FUNCIONAL, S.CONTROLE_FOLHA, S.E_AFASTAMENTO,s.suspende_remunera, s.c_livre_selec02 SO_GERA_SIT_PONTO,S.SITUACAO_PONTO COD_SIT_PONTO, P.DESCRICAO SITUACAO_PONTO, p.tipo_situacao
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA --'0001'
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO--
AND A.CODIGO = C1.CODIGO_CONTRATO--
AND
A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX
                                 LEFT OUTER JOIN RHPARM_SIT_FUNC SX ON SX.CODIGO = AUX.COD_SIT_FUNCIONAL
                                WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO
                                AND trunc(AUX.DATA_INIC_SITUACAO) < TRUNC(C1.OLD_DATA_INI_AFAST)
                                AND SX.CONTROLE_FOLHA = 'N' and SX.E_AFASTAMENTO = 'N' and SX.suspende_remunera = 'N' AND SX.C_LIVRE_SELEC02 = '2')
AND S.CONTROLE_FOLHA = 'N' and S.E_AFASTAMENTO = 'N' and S.suspende_remunera = 'N' AND S.C_LIVRE_SELEC02 = '2';
-- FIM ---------------------BUSCAR ULTIMA SITUAÃ‡ÃƒO FUNCIONAL TIPO ATIVA ANTES DO ATESTADO

IF TRUNC(C1.NEW_DATA_FIM_AFAST) >= TRUNC(SYSDATE)THEN
DBMS_OUTPUT.PUT_LINE('--GRAVA DATA FIM SIT FUNC DE AFASTAMENTO PELO INSS COM PROXIMA SITUACAO ATIVA');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = TRUNC(C1.NEW_DATA_FIM_AFAST), PROXIMA_SITUACAO = '5130', --COMENTADO EM 4/7/23--V_ULT_SIT_FUNC0_ATIVA,
LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE 
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST)
AND C2.COD_SIT_FUNCIONAL IN (VSIT_FUNC_DEFERIDA --COMENTADO EM 25/7/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4)
, '6121')--AJUSTADO EM 20/7/21
;
COMMIT;
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);

ELSIF TRUNC(C1.NEW_DATA_FIM_AFAST) < TRUNC(SYSDATE)THEN
DBMS_OUTPUT.PUT_LINE('--GRAVA DATA FIM SIT FUNC DE AFASTAMENTO PELO INSS E COLOCA PESSOA ATIVA');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = TRUNC(C1.NEW_DATA_FIM_AFAST),  LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST)
AND C2.COD_SIT_FUNCIONAL IN (VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4)
, '6121')--AJUSTADO EM 20/7/21
;
COMMIT;
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_FIM_AFAST)+1 AND COD_SIT_FUNCIONAL = '5130' --COMENTADO EM 4/7/23--V_ULT_SIT_FUNC0_ATIVA
;COMMIT;
      INSERT INTO RHCGED_ALT_SIT_FUN (IND_EF_RETRO_ESOCIAL, CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DATA_INIC_SITUACAO, COD_SIT_FUNCIONAL, LOGIN_USUARIO, DT_ULT_ALTER_USUA )
      VALUES ('N', C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, TRUNC(C1.NEW_DATA_FIM_AFAST)+1, '5130', --COMENTADO EM 4/7/23-- V_ULT_SIT_FUNC0_ATIVA
      C1.LOGIN_USUARIO, SYSDATE);
      COMMIT;
      SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.LOGIN_USUARIO);
END IF;

END IF;
END LOOP; ---FIM C2
--FIM--------------------------------------------------INSERINDO DATA FIM CONDUTA 38/37 --INICIO EM 20/11/20



--INICIO--------------------------------------------------EXCLUINDO DATA FIM CONDUTA 38--INICIO EM 20/11/20
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND C1.CONDUTA in ('000000000000038','000000000000037') --ajustado em 19/07/21 para conduta 37 
AND (
 (C1.OLD_DATA_INI_AFAST IS NOT NULL AND C1.NEW_DATA_INI_AFAST IS NOT NULL )AND -- TINHA E CONTINUA DATA INICIO 
(C1.OLD_DATA_FIM_AFAST IS NOT NULL AND C1.NEW_DATA_FIM_AFAST IS  NULL )-- TINHA E NAO TEM DATA FIM
) THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DATA DEFERIMENTO EXCLUINDO DATA FIM CONDUTA 38/37');
FOR C2 IN
(
--ultima situacao funcional da pessoa antes do periodo de deferimento da ficha medica
select
A.COD_SIT_FUNCIONAL, S.DESCRICAO SITUACAO_FUNCIONAL,A.DATA_INIC_SITUACAO,A.DATA_FIM_SITUACAO, S.CONTROLE_FOLHA, S.E_AFASTAMENTO, S.SUSPENDE_REMUNERA
from RHCGED_ALT_SIT_FUN A
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = A.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPONT_SITUACAO P ON P.CODIGO = S.SITUACAO_PONTO
WHERE A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
AND A.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND A.CODIGO = C1.CODIGO_CONTRATO 
AND((A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO) ) )
)
LOOP
IF 
(TRUNC(C2.DATA_INIC_SITUACAO) = TRUNC(C1.OLD_DATA_FIM_AFAST)+1 AND C2.DATA_FIM_SITUACAO IS NULL 
AND C2.CONTROLE_FOLHA = 'N' AND  C2.E_AFASTAMENTO = 'N' AND C2.SUSPENDE_REMUNERA = 'N') THEN
DBMS_OUTPUT.PUT_LINE('--EXCLUI REGISTRO DE ATIVO APOS AFASTAMENTO INSS E APAGA DATA FIM SIT FUNC DE AFASTAMENTO PELO INSS ');
DELETE RHCGED_ALT_SIT_FUN WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.OLD_DATA_FIM_AFAST)+1 AND COD_SIT_FUNCIONAL = c2.COD_SIT_FUNCIONAL; 
COMMIT;
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = NULL,  LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST) 
AND COD_SIT_FUNCIONAL = VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4)
;
COMMIT;
END IF;

IF TRUNC(C2.DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST) AND (C2.DATA_FIM_SITUACAO IS NOT NULL AND TRUNC(C2.DATA_FIM_SITUACAO) = TRUNC(C1.OLD_DATA_FIM_AFAST))
AND C2.COD_SIT_FUNCIONAL = VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4)
THEN
DBMS_OUTPUT.PUT_LINE('--APAGA DATA FIM SIT FUNC DE AFASTAMENTO PELO INSS ');
UPDATE RHCGED_ALT_SIT_FUN SET DATA_FIM_SITUACAO = NULL,  PROXIMA_SITUACAO = NULL, LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO AND TRUNC(DATA_INIC_SITUACAO) = TRUNC(C1.NEW_DATA_INI_AFAST)
AND COD_SIT_FUNCIONAL IN (VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22-- SUBSTR(C1.DADO_DESTINO_TC1,1,4)
, '6121')--AJUSTADO EM 20/7/21
;
COMMIT;

END IF;

END LOOP; ---FIM C2
--FIM--------------------------------------------------EXCLUINDO DATA FIM CONDUTA 38/37 --INICIO EM 20/11/20

---FIM------------------------------------------------**************************************CENARIOS CONDUTA 38/37 **************************----------------------------------------

--INICIO---23/11/20---------------------------------***********************************ALTERACAO DE CAMPOS ATENDENTE NA FICHA MEDICA-----------------------------------------------------
ELSIF C1.TIPO_DML = 'U' AND C1.TABELA = 'RHMEDI_FICHA_MED' AND 
(
((C1.NEW_EMPRESA_ATENDENTE IS NOT NULL AND C1.OLD_EMPRESA_ATENDENTE IS NULL) OR (C1.NEW_EMPRESA_ATENDENTE IS NULL AND C1.OLD_EMPRESA_ATENDENTE IS NOT NULL)
OR (C1.NEW_EMPRESA_ATENDENTE IS NOT NULL AND C1.OLD_EMPRESA_ATENDENTE IS NOT NULL AND C1.NEW_EMPRESA_ATENDENTE <> C1.OLD_EMPRESA_ATENDENTE)
)
OR
((C1.NEW_CODIGO_ATENDENTE IS NOT NULL AND C1.OLD_CODIGO_ATENDENTE IS NULL) OR (C1.NEW_CODIGO_ATENDENTE IS NULL AND C1.OLD_CODIGO_ATENDENTE IS NOT NULL)
OR (C1.NEW_CODIGO_ATENDENTE IS NOT NULL AND C1.OLD_CODIGO_ATENDENTE IS NOT NULL AND C1.NEW_CODIGO_ATENDENTE <> C1.OLD_CODIGO_ATENDENTE)
)
OR
((C1.NEW_NOME_ATENDENTE IS NOT NULL AND C1.OLD_NOME_ATENDENTE IS NULL) OR (C1.NEW_NOME_ATENDENTE IS NULL AND C1.OLD_NOME_ATENDENTE IS NOT NULL)
OR (C1.NEW_NOME_ATENDENTE IS NOT NULL AND C1.OLD_NOME_ATENDENTE IS NOT NULL AND C1.NEW_NOME_ATENDENTE <> C1.OLD_NOME_ATENDENTE)
)
OR
((C1.NEW_INSCRICAO_CONSELHO IS NOT NULL AND C1.OLD_INSCRICAO_CONSELHO IS NULL) OR (C1.NEW_INSCRICAO_CONSELHO IS NULL AND C1.OLD_INSCRICAO_CONSELHO IS NOT NULL)
OR (C1.NEW_INSCRICAO_CONSELHO IS NOT NULL AND C1.OLD_INSCRICAO_CONSELHO IS NOT NULL AND C1.NEW_INSCRICAO_CONSELHO <> C1.OLD_INSCRICAO_CONSELHO)
)
OR
((C1.NEW_UF_INSCRICAO IS NOT NULL AND C1.OLD_UF_INSCRICAO IS NULL) OR (C1.NEW_UF_INSCRICAO IS NULL AND C1.OLD_UF_INSCRICAO IS NOT NULL)
OR (C1.NEW_UF_INSCRICAO IS NOT NULL AND C1.OLD_UF_INSCRICAO IS NOT NULL AND C1.NEW_UF_INSCRICAO <> C1.OLD_UF_INSCRICAO)
)
OR
((C1.NEW_CONSELHO_REGIONAL IS NOT NULL AND C1.OLD_CONSELHO_REGIONAL IS NULL) OR (C1.NEW_CONSELHO_REGIONAL IS NULL AND C1.OLD_CONSELHO_REGIONAL IS NOT NULL)
OR (C1.NEW_CONSELHO_REGIONAL IS NOT NULL AND C1.OLD_CONSELHO_REGIONAL IS NOT NULL AND C1.NEW_CONSELHO_REGIONAL <> C1.OLD_CONSELHO_REGIONAL)
)
OR
((C1.NEW_INFO_MESMO_MOTIVO IS NOT NULL AND C1.OLD_INFO_MESMO_MOTIVO IS NULL) OR (C1.NEW_INFO_MESMO_MOTIVO IS NULL AND C1.OLD_INFO_MESMO_MOTIVO IS NOT NULL)
OR (C1.NEW_INFO_MESMO_MOTIVO IS NOT NULL AND C1.OLD_INFO_MESMO_MOTIVO IS NOT NULL AND C1.NEW_INFO_MESMO_MOTIVO <> C1.OLD_INFO_MESMO_MOTIVO)
)
OR
((C1.NEW_DT_EFEITO_MESMO_MOTIVO IS NOT NULL AND C1.OLD_DT_EFEITO_MESMO_MOTIVO IS NULL) OR (C1.NEW_DT_EFEITO_MESMO_MOTIVO IS NULL AND C1.OLD_DT_EFEITO_MESMO_MOTIVO IS NOT NULL)
OR (C1.NEW_DT_EFEITO_MESMO_MOTIVO IS NOT NULL AND C1.OLD_DT_EFEITO_MESMO_MOTIVO IS NOT NULL AND C1.NEW_DT_EFEITO_MESMO_MOTIVO <> C1.OLD_DT_EFEITO_MESMO_MOTIVO)
)

)THEN
DBMS_OUTPUT.PUT_LINE('--ALTERACAO DE CAMPOS ATENDENTE NA FICHA MEDICA, ATUALIZA REGISTRO DE ALT SIT FUNC DA FICHA');
UPDATE RHCGED_ALT_SIT_FUN SET EMPRESA_ATENDENTE = C1.EMPRESA_ATENDENTE, CODIGO_ATENDENTE = C1.CODIGO_ATENDENTE, NOME_ATENDENTE = C1.NOME_ATENDENTE, INSCRICAO_CONSELHO = C1.INSCRICAO_CONSELHO, UF_CONSELHO = C1.UF_INSCRICAO, CONSELHO_REGIONAL = C1.CONSELHO_REGIONAL, CODIGO_DOENCA = C1.COD_DOENCA, INFO_MESMO_MOTIVO = C1.INFO_MESMO_MOTIVO, DT_EFEITO_MESMO_MOTIVO = C1.DT_EFEITO_MESMO_MOTIVO
, LOGIN_USUARIO = C1.LOGIN_USUARIO , DT_ULT_ALTER_USUA = SYSDATE 
WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND TIPO_CONTRATO = C1.TIPO_CONTRATO AND CODIGO = C1.CODIGO_CONTRATO 
AND COD_SIT_FUNCIONAL = VSIT_FUNC_DEFERIDA--NOVO EM 1/6/22--COMENTADO EM 1/6/22--SUBSTR(C1.DADO_DESTINO_TC1,1,4)
AND(
TRUNC(DATA_INIC_SITUACAO) BETWEEN TO_DATE(C1.DATA_INI_AFAST,'DD/MM/YYYY') AND TO_DATE(C1.DATA_FIM_AFAST,'DD/MM/YYYY') 
OR
TRUNC(DATA_FIM_SITUACAO) BETWEEN TO_DATE(C1.DATA_INI_AFAST,'DD/MM/YYYY') AND TO_DATE(C1.DATA_FIM_AFAST,'DD/MM/YYYY') 
);
COMMIT;

--FIM---23/11/20---------------------------------***********************************ALTERACAO DE CAMPOS ATENDENTE NA FICHA MEDICA-----------------------------------------------------



END IF;
----FIM------------------------------------------------------------------------------------IF PARA SABER SE ESTA SENDO EXCLUSAO DE CONDUTA OU ALTERACAO DE PROCEDIMENTO/DATAS DEFERIMENTO DA FICHA

END LOOP; --FIM C1
END;

END;