
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."SUGESP_ALT_SIT_FUNC_ULT_CONTRA" (CODIGO_EMPRESA IN VARCHAR2, TIPO_CONTRATO IN VARCHAR2, CODIGO IN VARCHAR2 , LOGIN_USUARIO IN VARCHAR2/*, DATA_INIC_SITUACAO IN DATE LOGIN_USUARIO IN VARCHAR2, LOGIN_OS IN VARCHAR2 , */) AS
--KELLYSSON 23/04/19 ate 26/4/19

--EM 29/11/21 ajustes feitos no codigo devido email ([UNIFICAÇÃO DE BASES - TODAS AS EMPRESAS] _ SIT. FUNCIONAIS - RESCISÃO) linhas com os dizeres COMENTADO EM 29/11/21
--em 30/11/21 ajustes colocando DATA INICIO AFASTAMENTO no processo de aposentado atual devido email (Situações funcionais - Parametrização eSocial)
--em 6/12/21 reunião com Sabrina e Stephanie solicitaram colocar uma regra com data de corte na DATA INICIO SITUACAO PARA O CONTROLE FOLHA = D, S EM QUE A ESTA DATA ANTES DE 1/12/21 TRABALHE NO CENARIO ANTERIOR E DEPOIS NO NOVO CENARIO
--PRAGMA AUTONOMOUS_TRANSACTION;
--dbms_output.put_line('');

BEGIN-- 1 BEGIN

  DECLARE
    vCONTADOR NUMBER;
    vCODIGO_EMPRESA VARCHAR2(4);
    vTIPO_CONTRATO VARCHAR2(4);
    vCODIGO VARCHAR2(15);
  --  vDATA_INIC_SITUACAO DATE;
    vDATA_SISTEMA DATE;
    vANO_MES_REF_ULT_CONTRATO DATE;
    vLOGIN_USUARIO VARCHAR2(40);
  --  vLOGIN_OS VARCHAR2(40);
  --  vLOGIN VARCHAR2(40);
    vQTD_ALT_SIT_FUNC NUMBER;
    vDATA_INIC_SITUACAO_ULT DATE;

    vPENUL_NEW_COD_SIT_FUNCIONAL VARCHAR2(4);
    vPENUL_OLD_COD_SIT_FUNCIONAL VARCHAR2(4);
    vPENUL_NEW_DATA_FIM_SITUACAO  DATE;
    vPENUL_OLD_DATA_FIM_SITUACAO  DATE;
    vPENUL_OLD_SF_CONTROLE_FOLHA VARCHAR2(4);
    vPENUL_OLD_SF_SITUACAO_PONTO VARCHAR2(4);

    vDT_INI_VIG_ESTAGIO DATE;
    vDT_FIM_VIG_ESTAGIO DATE;
    vQTD_MESES_ESTAGIO NUMBER;
    vQTD_RECESSO_ESTAGIO NUMBER;
    vDT_INI_AQUIS_RECESSO DATE;
    vDT_FIM_AQUIS_RECESSO DATE;
    vPER_AQUI_QTDE NUMBER;
    vMAX_DIAS_GOZO NUMBER;
    vQTD_ALT_SIT_FUNC_GERAL NUMBER;
    vDT_INI_PRIMEIRA_SITFUNC_EXER DATE;--NOVA EM 17/2/21
    vDATA_INICIO_ULTIMA_MOVIMENTACAO DATE;--NOVA EM 08/08/2023 (LETICIA)

BEGIN -- 2 BEGIN
    dbms_output.enable(NULL);
    execute immediate 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/YYYY''';

    vCONTADOR :=0;
    vCODIGO_EMPRESA:= CODIGO_EMPRESA;
    vTIPO_CONTRATO := TIPO_CONTRATO;
    vCODIGO := CODIGO;
    --vDATA_INIC_SITUACAO := DATA_INIC_SITUACAO;
    vLOGIN_USUARIO :=  LOGIN_USUARIO;
  --  vLOGIN_OS :=  LOGIN_OS;
 --   vLOGIN := null;
    vQTD_ALT_SIT_FUNC := 0;
    --definir login a usar
 --   IF vLOGIN_USUARIO = 'ARTERH_UPBH' then
 --   vLOGIN := vLOGIN_OS;
 --   ELSE
--    vLOGIN := vLOGIN_USUARIO;
--    END IF;

    vPENUL_NEW_COD_SIT_FUNCIONAL := NULL;
    vPENUL_OLD_COD_SIT_FUNCIONAL := NULL;
    vPENUL_NEW_DATA_FIM_SITUACAO := NULL;
    vPENUL_OLD_DATA_FIM_SITUACAO := NULL;
    vPENUL_OLD_SF_CONTROLE_FOLHA := NULL;
    vPENUL_OLD_SF_SITUACAO_PONTO := NULL;
    vDT_INI_VIG_ESTAGIO := NULL;
    vDT_FIM_VIG_ESTAGIO := NULL;
    vQTD_MESES_ESTAGIO := 0;
    vQTD_RECESSO_ESTAGIO := 0;
    vDT_INI_AQUIS_RECESSO := NULL;
    vDT_FIM_AQUIS_RECESSO := NULL;
    vPER_AQUI_QTDE := 0;
    vMAX_DIAS_GOZO :=0;
    vQTD_ALT_SIT_FUNC_GERAL := 0;
    vDT_INI_PRIMEIRA_SITFUNC_EXER := NULL;
    vDATA_INICIO_ULTIMA_MOVIMENTACAO := NULL; --(LETICIA)

   --PEGAR DATA DO SISTEMA ARTERH
    SELECT DATA_DO_SISTEMA INTO vDATA_SISTEMA from rhparm_p_sist;

    --PEGAR ULTIMO CONTRATO DA PESSOA
    SELECT C.ANO_MES_REFERENCIA INTO vANO_MES_REF_ULT_CONTRATO from RHPESS_CONTRATO C WHERE C.CODIGO_EMPRESA = vCODIGO_EMPRESA AND C.TIPO_CONTRATO = vTIPO_CONTRATO AND C.CODIGO = vCODIGO AND
    C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX
    where AUX.codigo_empresa = c.codigo_empresa
    and AUX.tipo_contrato = c.tipo_contrato
    and AUX.codigo = c.codigo
    --and AUX.ano_mes_referencia <= vDATA_SISTEMA
    );

    --VERIFICAR SE ser A PRIMEIRA SITUAcaO FUNCIONAL NA HISTORIA DA PESSOA COM CONTROLE_FOLHA IN ('N', 'L', 'M') para gravar DATA_EFETIVO_EXERC e DATA_BASE_FERIAS
    SELECT COUNT (1) INTO vQTD_ALT_SIT_FUNC FROM RHCGED_ALT_SIT_FUN A
    LEFT OUTER JOIN RHPARM_SIT_FUNC S  ON S.CODIGO = A.cod_sit_funcional
    WHERE  A.CODIGO_EMPRESA = vCODIGO_EMPRESA AND A.TIPO_CONTRATO = vTIPO_CONTRATO AND A.CODIGO = vCODIGO
    AND S.CONTROLE_FOLHA IN ('N', 'L', 'M' );


    --NOVO EM 17/2/21--PEGA A DATA INICIO DA PRIMEIRA SITUACAO FUNCIONAL QUE SIGNIFICA QUE A PESSOA ENTROU EM EFETIVO EXERCICIO
    IF vQTD_ALT_SIT_FUNC = 1 THEN
    SELECT DATA_INIC_SITUACAO INTO vDT_INI_PRIMEIRA_SITFUNC_EXER FROM  RHCGED_ALT_SIT_FUN A
    LEFT OUTER JOIN RHPARM_SIT_FUNC S  ON S.CODIGO = A.cod_sit_funcional
    WHERE  A.CODIGO_EMPRESA = vCODIGO_EMPRESA AND A.TIPO_CONTRATO = vTIPO_CONTRATO AND A.CODIGO = vCODIGO
    AND S.CONTROLE_FOLHA IN ('N', 'L', 'M' );
    END IF;

    --VERIFICAR A QUANTIDADE ATUAL DE SITUAcaO FUNCIONAL NA HISTORIA DA PESSOA 
    SELECT CASE WHEN COUNT (1) IS NULL THEN 0 ELSE  COUNT (1) END INTO vQTD_ALT_SIT_FUNC_GERAL FROM RHCGED_ALT_SIT_FUN A
    LEFT OUTER JOIN RHPARM_SIT_FUNC S  ON S.CODIGO = A.cod_sit_funcional
    WHERE  A.CODIGO_EMPRESA = vCODIGO_EMPRESA AND A.TIPO_CONTRATO = vTIPO_CONTRATO AND A.CODIGO = vCODIGO;

FOR C2 IN
(

--INICIO SELECT-------------------------------------------------------------------------------C2
SELECT
CASE WHEN X2.tp_regime_trab_esocial = '1' THEN vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 X2.DATA_INIC_SITUACAO
     WHEN X2.tp_regime_trab_esocial <> '1' AND X2.DIA_ADMISSAO = 1 AND X2.MES_ADMISSAO = 1 THEN TO_DATE('01/01/'||X2.ANO_ADMISSAO,'DD/MM/YYYY')
     WHEN X2.tp_regime_trab_esocial <> '1' AND X2.DIA_ADMISSAO <> 1 AND X2.MES_ADMISSAO <> 1 THEN TO_DATE('01/01/'||X2.ANO_SEGUINTE,'DD/MM/YYYY')
     END data_base_ferias,
--CASE WHEN X2.SIT_FUNC_ANALISE = X2.ULT_ASF_COD_SIT_FUNCIONAL AND X2.DATA_INIC_SITUACAO = X2.ULT_ASF_DATA_INIC_SITUACAO THEN 'ULTIMO' ELSE 'ANTERIOR' END TIPO_REGISTRO,
X2.*
FROM (
SELECT
EXTRACT(DAY FROM X.DATA_ADMISSAO) DIA_ADMISSAO,--comentado 12/2/21--EXTRACT(DAY FROM X.DATA_INIC_SITUACAO) DIA_ADMISSAO,
EXTRACT(MONTH FROM X.DATA_ADMISSAO) MES_ADMISSAO,--comentado 12/2/21--EXTRACT(MONTH FROM X.DATA_INIC_SITUACAO) MES_ADMISSAO,
EXTRACT(YEAR FROM X.DATA_ADMISSAO) ANO_ADMISSAO,--comentado 12/2/21--EXTRACT(YEAR FROM X.DATA_INIC_SITUACAO) ANO_ADMISSAO,
EXTRACT(YEAR FROM X.DATA_ADMISSAO)+1 ANO_SEGUINTE,--comentado 12/2/21--EXTRACT(YEAR FROM X.DATA_INIC_SITUACAO)+1 ANO_SEGUINTE,
CASE WHEN X.TIPO_DML IN ('I','U') THEN X.NEW_COD_SIT_FUNCIONAL WHEN  X.TIPO_DML IN ('D') THEN X.OLD_COD_SIT_FUNCIONAL END AS SIT_FUNC_ANALISE,
CASE WHEN X.TIPO_DML IN ('I','U') THEN X.NEW_DATA_FIM_SITUACAO WHEN  X.TIPO_DML IN ('D') THEN X.OLD_DATA_FIM_SITUACAO END AS DATA_FIM_ANALISE,
X.*
FROM(
SELECT
log.id id, LOG.TIPO_DML TIPO_DML, LOG.CODIGO_EMPRESA CODIGO_EMPRESA, LOG.TIPO_CONTRATO TIPO_CONTRATO, LOG.CODIGO CODIGO, to_date(to_char(LOG.DATA_INIC_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') DATA_INIC_SITUACAO, LOG.NEW_COD_SIT_FUNCIONAL NEW_COD_SIT_FUNCIONAL
,LOG.OLD_COD_SIT_FUNCIONAL OLD_COD_SIT_FUNCIONAL, to_date(to_char(LOG.NEW_DATA_FIM_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') NEW_DATA_FIM_SITUACAO, to_date(to_char(LOG.OLD_DATA_FIM_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') OLD_DATA_FIM_SITUACAO, LOG.NEW_MOTIVO_AFAST NEW_MOTIVO_AFAST,
LOG.OLD_MOTIVO_AFAST OLD_MOTIVO_AFAST, LOG.DT_ULT_ALTER_USUA DT_ULT_ALTER_USUA, LOG.LOGIN_USUARIO LOGIN_USUARIO, LOG.LOGIN_OS LOGIN_OS

,to_char(lpad(LOG_TC.DADO_DESTINO,4,0)) LOG_TC_MOTIVO_DEMISSAO, to_char(lpad(ULT_ASF_TC.DADO_DESTINO,4,0)) ULT_ASF_TC_MOTIVO_DEMISSAO
,NEW_SF.CONTROLE_FOLHA NEW_SF_CONTROLE_FOLHA, NEW_SF.e_afastamento NEW_SF_e_afastamento, to_char(lpad(NEW_SF.c_livre_valor03,4,0)) NEW_SF_CAUSA_RESCISAO, to_char(lpad(NEW_SF.c_livre_valor04,4,0)) NEW_COD_MOVIMENTACAO
,OLD_SF.CONTROLE_FOLHA OLD_SF_CONTROLE_FOLHA, OLD_SF.e_afastamento OLD_SF_e_afastamento, to_char(lpad(OLD_SF.c_livre_valor03,4,0)) OLD_SF_CAUSA_RESCISAO, to_char(lpad(OLD_SF.c_livre_valor04,4,0)) OLD_COD_MOVIMENTACAO

/*
,LOG_PENULT.id LOGP_id, LOG_PENULT.TIPO_DML LOGP_TIPO_DML, LOG_PENULT.CODIGO_EMPRESA LOGP_CODIGO_EMPRESA, LOG_PENULT.TIPO_CONTRATO LOGP_TIPO_CONTRATO, LOG_PENULT.CODIGO LOGP_CODIGO, LOG_PENULT.DATA_INIC_SITUACAO LOGP_DATA_INIC_SITUACAO, LOG_PENULT.NEW_COD_SIT_FUNCIONAL LOGP_NEW_COD_SIT_FUNCIONAL
,LOG_PENULT.OLD_COD_SIT_FUNCIONAL LOGP_OLD_COD_SIT_FUNCIONAL, LOG_PENULT.NEW_DATA_FIM_SITUACAO LOGP_NEW_DATA_FIM_SITUACAO, LOG_PENULT.OLD_DATA_FIM_SITUACAO LOGP_OLD_DATA_FIM_SITUACAO, LOG_PENULT.NEW_MOTIVO_AFAST LOGP_NEW_MOTIVO_AFAST,
LOG_PENULT.OLD_MOTIVO_AFAST LOGP_OLD_MOTIVO_AFAST, LOG_PENULT.DT_ULT_ALTER_USUA LOGP_DT_ULT_ALTER_USUA, LOG_PENULT.LOGIN_USUARIO LOGP_LOGIN_USUARIO, LOG_PENULT.LOGIN_OS LOGP_LOGIN_OS

,NEW_SF_P.CONTROLE_FOLHA NEW_SF_P_CONTROLE_FOLHA, NEW_SF_P.e_afastamento NEW_SF_P_e_afastamento, to_char(lpad(NEW_SF_P.c_livre_valor03,4,0)) NEW_SF_P_CAUSA_RESCISAO, to_char(lpad(NEW_SF_P.c_livre_valor04,4,0)) NEW_P_COD_MOVIMENTACAO
,OLD_SF_P.CONTROLE_FOLHA OLD_SF_P_CONTROLE_FOLHA, OLD_SF_P.e_afastamento OLD_SF_P_e_afastamento, to_char(lpad(OLD_SF_P.c_livre_valor03,4,0)) OLD_SF_P_CAUSA_RESCISAO, to_char(lpad(OLD_SF_P.c_livre_valor04,4,0)) OLD_P_COD_MOVIMENTACAO
*/

--/*

,to_date(to_char(ULT_ASF.data_inic_situacao,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_ASF_data_inic_situacao, ULT_ASF.cod_sit_funcional ULT_ASF_cod_sit_funcional, to_date(to_char(ULT_ASF.data_fim_situacao,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_ASF_data_fim_situacao, ULT_ASF.MOTIVO_AFAST ULT_ASF_MOTIVO_AFAST, ULT_ASF.DATA_PUBLIC ULT_ASF_DATA_DOM --alterado 23/2/21--ULT_ASF.c_livre_data01 ULT_ASF_DATA_DOM
,ULT_ASF_SF.CONTROLE_FOLHA ULT_ASF_SF_CONTROLE_FOLHA, ULT_ASF_SF.e_afastamento ULT_ASF_SF_e_afastamento, to_char(lpad(ULT_ASF_SF.c_livre_valor03,4,0)) ULT_ASF_SF_CAUSA_RESCISAO, to_char(lpad(ULT_ASF_SF.c_livre_valor04,4,0)) ULT_ASF_SF_COD_MOVIMENTACAO
,ULT_ASF_SF.SITUACAO_PONTO ULT_ASF_SF_SITUACAO_PONTO --NOVO EM 8/10/20
,to_date(to_char(PENULT_ASF.data_inic_situacao,'dd/mm/yyyy'),'dd/mm/yyyy') PENULT_ASF_data_inic_situacao, PENULT_ASF.cod_sit_funcional PENULT_ASF_cod_sit_funcional, to_date(to_char(PENULT_ASF.data_fim_situacao,'dd/mm/yyyy'),'dd/mm/yyyy') PENULT_ASF_data_fim_situacao, PENULT_ASF.MOTIVO_AFAST PENULT_ASF_MOTIVO_AFAST, PENULT_ASF.DATA_PUBLIC PENULT_ASF_DATA_DOM--alterado 23/2/21--PENULT_ASF.c_livre_data01 PENULT_ASF_DATA_DOM
,PENULT_ASF_SF.CONTROLE_FOLHA PENULT_ASF_SF_CONTROLE_FOLHA, PENULT_ASF_SF.e_afastamento PENULT_ASF_SF_e_afastamento, to_char(lpad(PENULT_ASF_SF.c_livre_valor03,4,0)) PENULT_ASF_SF_CAUSA_RESCISAO, to_char(lpad(PENULT_ASF_SF.c_livre_valor04,4,0)) PENULT_ASF_SF_COD_MOVIMENTACAO

,to_date(to_char(ULT_MOV.DT_ALT_UNID_CUSTO,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_MOV_DT_INICIO, ULT_MOV.COD_MOVIMENTACAO ULT_MOV_COD_MOVIMENTACAO, to_date(to_char(ULT_MOV.dt_fim_temp,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_MOV_dt_fim_temp

,PENULT_MOV.CODIGO_EMPRESA PENULT_MOV_CODIGO_EMPRESA, PENULT_MOV.TIPO_CONTRATO PENULT_MOV_TIPO_CONTRATO, PENULT_MOV.CODIGO PENULT_MOV_CODIGO
,to_date(to_char(PENULT_MOV.DT_ALT_UNID_CUSTO,'dd/mm/yyyy'),'dd/mm/yyyy') PENULT_MOV_DT_ALT_UNID_CUSTO, PENULT_MOV.COD_MOVIMENTACAO PENULT_MOV_COD_MOVIMENTACAO, to_date(to_char(PENULT_MOV.DT_FIM_TEMP,'dd/mm/yyyy'),'dd/mm/yyyy') PENULT_MOV_DT_FIM_TEMP
,PENULT_MOV.COD_LOTACAO_ATUAL1 , PENULT_MOV.COD_LOTACAO_ATUAL2, PENULT_MOV.COD_LOTACAO_ATUAL3, PENULT_MOV.COD_LOTACAO_ATUAL4, PENULT_MOV.COD_LOTACAO_ATUAL5, PENULT_MOV.COD_LOTACAO_ATUAL6
,PENULT_MOV.COD_UNIDADE_ATUAL1, PENULT_MOV.COD_UNIDADE_ATUAL2, PENULT_MOV.COD_UNIDADE_ATUAL3, PENULT_MOV.COD_UNIDADE_ATUAL4, PENULT_MOV.COD_UNIDADE_ATUAL5, PENULT_MOV.COD_UNIDADE_ATUAL6
,PENULT_MOV.COD_CCONTAB_ATUAL1, PENULT_MOV.COD_CCONTAB_ATUAL2, PENULT_MOV.COD_CCONTAB_ATUAL3, PENULT_MOV.COD_CCONTAB_ATUAL4, PENULT_MOV.COD_CCONTAB_ATUAL5, PENULT_MOV.COD_CCONTAB_ATUAL6
,PENULT_MOV.COD_CGERENC_ATUAL1, PENULT_MOV.COD_CGERENC_ATUAL2, PENULT_MOV.COD_CGERENC_ATUAL3, PENULT_MOV.COD_CGERENC_ATUAL4, PENULT_MOV.COD_CGERENC_ATUAL5, PENULT_MOV.COD_CGERENC_ATUAL6

,to_date(to_char(ULT_ALT_CARG.DT_ALTER_CARGO,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_ALT_CARG_DT_INI, ULT_ALT_CARG.OCORRENCIA ULT_ALT_CARG_OCORRENCIA, ULT_ALT_CARG.motivo_alteracao ULT_ALT_CARG_motivo_alteracao, to_date(to_char(ULT_ALT_CARG.dt_fim_temp,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_ALT_CARG_dt_fim, ULT_ALT_CARG.cod_cargo_comis_at ULT_ALT_CARG_cod_cargo_com

,PENULT_ALT_CARG.CODIGO_EMPRESA PEN_ALT_CARG_CODIGO_EMPRESA, PENULT_ALT_CARG.TIPO_CONTRATO P_CARG_TIPO_CONTRATO, PENULT_ALT_CARG.CODIGO_CONTRATO P_CARG_CODIGO_CONTRATO,
to_date(to_char(PENULT_ALT_CARG.DT_ALTER_CARGO,'dd/mm/yyyy'),'dd/mm/yyyy') PEN_ALT_CARG_DT_ALTER_CARGO, PENULT_ALT_CARG.MOTIVO_ALTERACAO PEN_ALT_CARG_MOTIVO_ALTERACAO, to_date(to_char(PENULT_ALT_CARG.DT_FIM_TEMP,'dd/mm/yyyy'),'dd/mm/yyyy') PEN_ALT_CARG_DT_FIM_TEMP,
PENULT_ALT_CARG.SALARIO_PAGTO PEN_ALT_CARG_SALARIO_PAGTO, PENULT_ALT_CARG.COD_CARGO_COMIS_AT P_CARG_COD_CARGO_COMIS_AT, PENULT_ALT_CARG.NIV_CARGO_COMIS_AT P_CARG_NIV_CARGO_COMIS_AT

,to_date(to_char(ULT_ALT_FUNCAO.DATA_INICIO_FUNCAO,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_ALT_FUNCAO_DT_INI, ULT_ALT_FUNCAO.codigo_hist_funcao ULT_ALT_FUNCAO_MOTIVO_ENTRADA, to_date(to_char(ULT_ALT_FUNCAO.dt_fim_temp,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_ALT_FUNCAO_dt_fim, ULT_ALT_FUNCAO.CODIGO_FUNCAO ULT_ALT_FUNCAO_CODIGO_FUNCAO

--,PENULT_ALT_FUNC.CODIGO_EMPRESA P_ALT_FUNC_CODIGO_EMPRESA, PENULT_ALT_FUNC.TIPO_CONTRATO P_ALT_FUNC_TIPO_CONTRATO, PENULT_ALT_FUNC.CODIGO_CONTRATO P_ALT_FUNC_CODIGO_CONTRATO
--,PENULT_ALT_FUNC.DATA_INICIO_FUNCAO P_ALT_FUNC_DATA_INICIO_FUNCAO, PENULT_ALT_FUNC.DT_FIM_TEMP P_ALT_FUNC_DT_FIM_TEMP, PENULT_ALT_FUNC.CODIGO_HIST_FUNCAO P_ALT_FUNC_CODIGO_HIST_FUNCAO, PENULT_ALT_FUNC.CODIGO_FUNCAO P_ALT_FUNC_CODIGO_FUNCAO

,C.ANO_MES_REFERENCIA C_ANO_MES_REFERENCIA, C.CODIGO_PESSOA, C.NOME, C.SITUACAO_FUNCIONAL, C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, to_date(to_char(C.DT_ULT_ALT_LOC,'dd/mm/yyyy'),'dd/mm/yyyy') DT_ULT_ALT_LOC,
C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4, C.COD_UNIDADE5, C.COD_UNIDADE6, to_date(to_char(C.DT_ULT_ALT_UNID,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_ALT_UNID, C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3,
C.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6, to_date(to_char(C.DT_ULT_ALT_CONT,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_ALT_CONT, C.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5,
C.COD_CUSTO_GERENC6, to_date(to_char(C.DT_ULT_ALT_GER,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_ALT_GER, C.SALARIO_PAGTO, C.COD_CARGO_PAGTO, C.NIVEL_CARGO_PAGTO, C.COD_CARGO_EFETIVO, C.NIVEL_CARGO_EFETIV, to_date(to_char(C.DT_ULT_CARGO_EFET,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_CARGO_EFET, C.COD_CARGO_COMISS,
C.NIVEL_CARGO_COMISS,to_date(to_char( C.DT_ULT_CARGO_COM,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_CARGO_COM, C.COD_CARGO_AMPAR, C.NIVEL_CARGO_AMPAR, to_date(to_char(C.DT_ULT_CARGO_AMPAR,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_CARGO_AMPAR, C.CODIGO_FUNCAO, to_date(to_char(C.DT_ULT_FUNCAO,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_FUNCAO, C.COD_ESPECIALIDADE, to_date(to_char(C.DT_ULT_ESPEC,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_ESPEC, C.CODIGO_VAGA,
to_date(to_char(C.DT_ULT_VAGA,'dd/mm/yyyy'),'dd/mm/yyyy')DT_ULT_VAGA, C.CODIGO_ESCALA, C.REGISTRO_PONTO, to_date(to_char(C.DT_ULT_ESCALA,'dd/mm/yyyy'),'dd/mm/yyyy') DT_ULT_ESCALA, C.COD_PROCURADOR, C.cod_movimentacao
,to_date(to_char(c.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy')data_admissao

,M.c_livre_descr1 M_AGRUPADOR
, case when V.tp_regime_trab_esocial is null or  V.tp_regime_trab_esocial = ' ' then '1' else V.tp_regime_trab_esocial end tp_regime_trab_esocial,
v.cod_categ_esocial, --Letícia incluiu em 28/07/2023
ULT_ASF_SF.suspende_remunera ULT_ASF_SF_suspende_remunera --Kellysson incluiu em 10/9/19

,NEW_CAUSA_RESC.codigo_esocial NEW_CAUSA_RESC_codigo_esocial, OLD_CAUSA_RESC.codigo_esocial OLD_CAUSA_RESC_codigo_esocial
,NEW_SF.SITUACAO_PONTO NEW_SF_SITUACAO_PONTO, OLD_SF.SITUACAO_PONTO OLD_SF_SITUACAO_PONTO

FROM SMARH_INT_PE_ALTSITFUN_AUDITO LOG
LEFT OUTER JOIN RHPARM_SIT_FUNC NEW_SF ON NEW_SF.CODIGO = LOG.new_cod_sit_funcional --S >LOG_SF
LEFT OUTER JOIN RHPARM_SIT_FUNC OLD_SF ON OLD_SF.CODIGO = LOG.OLD_cod_sit_funcional
LEFT OUTER JOIN (SELECT ULT_ASF.* FROM RHCGED_ALT_SIT_FUN ULT_ASF WHERE ULT_ASF.DATA_INIC_SITUACAO = (SELECT MAX(AUX.data_inic_situacao) FROM RHCGED_ALT_SIT_FUN AUX WHERE AUX.CODIGO_EMPRESA =  ULT_ASF.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = ULT_ASF.TIPO_CONTRATO AND AUX.CODIGO = ULT_ASF.CODIGO))ULT_ASF ON LOG.CODIGO_EMPRESA = ULT_ASF.CODIGO_EMPRESA AND LOG.TIPO_CONTRATO = ULT_ASF.TIPO_CONTRATO AND LOG.CODIGO = ULT_ASF.CODIGO --AND A.new_COD_SIT_FUNCIONAL = X.COD_SIT_FUNCIONAL
LEFT OUTER JOIN RHPARM_SIT_FUNC ULT_ASF_SF ON ULT_ASF_SF.CODIGO = ULT_ASF.cod_sit_funcional
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV where codigo_CONVERSAO ='SF01')LOG_TC ON lpad(LOG_TC.DADO_ORIGEM,4,0) = to_char(lpad(LOG.NEW_MOTIVO_AFAST,4,0))
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV where codigo_CONVERSAO ='SF01')ULT_ASF_TC ON lpad(ULT_ASF_TC.DADO_ORIGEM,4,0) = to_char(lpad(ULT_ASF.MOTIVO_AFAST,4,0))
LEFT OUTER JOIN (SELECT C.* FROM RHPESS_CONTRATO C WHERE C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo))C ON C.CODIGO_EMPRESA = LOG.CODIGO_EMPRESA AND C.TIPO_CONTRATO = LOG.TIPO_CONTRATO AND C.CODIGO = LOG.CODIGO

LEFT OUTER JOIN (select ULT_MOV.* from RHCGED_TRANSFERENC ULT_MOV where ULT_MOV.DT_ALT_UNID_CUSTO = (SELECT MAX(AUX.DT_ALT_UNID_CUSTO) FROM RHCGED_TRANSFERENC AUX WHERE AUX.CODIGO_EMPRESA = ULT_MOV.codigo_empresa and AUX.tipo_contrato = ULT_MOV.tipo_contrato and AUX.codigo = ULT_MOV.codigo))
ULT_MOV ON ULT_MOV.CODIGO_EMPRESA = LOG.CODIGO_EMPRESA AND ULT_MOV.TIPO_CONTRATO = LOG.TIPO_CONTRATO AND ULT_MOV.CODIGO = LOG.CODIGO --AND TRUNC(M.DT_ALT_UNID_CUSTO) = TRUNC(LOG.data_inic_situacao)

LEFT OUTER JOIN (SELECT X.* FROM (SELECT ROW_NUMBER() OVER   (PARTITION BY  ULT_MOV.CODIGO ORDER BY ULT_MOV.DT_ALT_UNID_CUSTO  DESC)  AS SEQ_NUM , ULT_MOV.* FROM RHCGED_TRANSFERENC ULT_MOV WHERE  ULT_MOV.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_MOV.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_MOV.CODIGO = (select codigo from SMARH_INT_PE_ALTSITFUN_AUDITO WHERE ID = (select Max(ID) from SMARH_INT_PE_ALTSITFUN_AUDITO))-- '000000000883291' --vCODIGO_EMPRESA --vTIPO_CONTRATO --vCODIGO
AND ULT_MOV.DT_ALT_UNID_CUSTO <= (SELECT MAX(AUX.DT_ALT_UNID_CUSTO) FROM RHCGED_TRANSFERENC AUX WHERE  ULT_MOV.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND ULT_MOV.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND ULT_MOV.CODIGO = AUX.CODIGO))X
WHERE X.SEQ_NUM = 2 )
PENULT_MOV ON LOG.CODIGO_EMPRESA = PENULT_MOV.CODIGO_EMPRESA AND LOG.TIPO_CONTRATO = PENULT_MOV.TIPO_CONTRATO AND LOG.CODIGO = PENULT_MOV.CODIGO

LEFT OUTER JOIN (SELECT X.* FROM (SELECT ROW_NUMBER() OVER   (PARTITION BY  ULT_ALT_CARG.CODIGO_CONTRATO ORDER BY ULT_ALT_CARG.DT_ALTER_CARGO DESC, ULT_ALT_CARG.OCORRENCIA DESC)  AS SEQ_NUM , ULT_ALT_CARG.* FROM  RHPLCS_ALT_CARGO ULT_ALT_CARG WHERE ULT_ALT_CARG.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_ALT_CARG.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_ALT_CARG.CODIGO_CONTRATO = (select codigo from SMARH_INT_PE_ALTSITFUN_AUDITO WHERE ID = (select Max(ID) from SMARH_INT_PE_ALTSITFUN_AUDITO))--'000000000883291' --vCODIGO_EMPRESA --vTIPO_CONTRATO --vCODIGO
AND ULT_ALT_CARG.DT_ALTER_CARGO <= (SELECT MAX(AUX.DT_ALTER_CARGO) FROM  RHPLCS_ALT_CARGO AUX WHERE ULT_ALT_CARG.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND ULT_ALT_CARG.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND ULT_ALT_CARG.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO
AND AUX.OCORRENCIA = (SELECT MAX (AUX2.OCORRENCIA)  FROM RHPLCS_ALT_CARGO AUX2 WHERE AUX2.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND AUX2.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND AUX2.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO AND AUX2.DT_ALTER_CARGO = AUX.DT_ALTER_CARGO
)))X WHERE X.SEQ_NUM = 1)
ULT_ALT_CARG ON LOG.CODIGO_EMPRESA = ULT_ALT_CARG.CODIGO_EMPRESA AND LOG.TIPO_CONTRATO = ULT_ALT_CARG.TIPO_CONTRATO AND LOG.CODIGO = ULT_ALT_CARG.CODIGO_CONTRATO

LEFT OUTER JOIN (SELECT X.* FROM (SELECT ROW_NUMBER() OVER   (PARTITION BY  ULT_ALT_CARG.CODIGO_CONTRATO ORDER BY ULT_ALT_CARG.DT_ALTER_CARGO DESC, ULT_ALT_CARG.OCORRENCIA DESC) AS SEQ_NUM , ULT_ALT_CARG.* FROM  RHPLCS_ALT_CARGO ULT_ALT_CARG WHERE ULT_ALT_CARG.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_ALT_CARG.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_ALT_CARG.CODIGO_CONTRATO = (select codigo from SMARH_INT_PE_ALTSITFUN_AUDITO WHERE ID = (select Max(ID) from SMARH_INT_PE_ALTSITFUN_AUDITO))--'000000000883291' --vCODIGO_EMPRESA --vTIPO_CONTRATO --vCODIGO
AND ULT_ALT_CARG.DT_ALTER_CARGO <= (SELECT MAX(AUX.DT_ALTER_CARGO) FROM  RHPLCS_ALT_CARGO AUX WHERE ULT_ALT_CARG.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND ULT_ALT_CARG.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND ULT_ALT_CARG.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO
AND AUX.OCORRENCIA = (SELECT MAX (AUX2.OCORRENCIA)  FROM RHPLCS_ALT_CARGO AUX2 WHERE AUX2.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND AUX2.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND AUX2.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO AND AUX2.DT_ALTER_CARGO = AUX.DT_ALTER_CARGO
)))X WHERE X.SEQ_NUM = 2)
PENULT_ALT_CARG ON LOG.CODIGO_EMPRESA = PENULT_ALT_CARG.CODIGO_EMPRESA AND LOG.TIPO_CONTRATO = PENULT_ALT_CARG.TIPO_CONTRATO AND LOG.CODIGO = PENULT_ALT_CARG.CODIGO_CONTRATO

LEFT OUTER JOIN (SELECT X.* FROM (SELECT ROW_NUMBER() OVER   (PARTITION BY ULT_ALT_FUNCAO.CODIGO_CONTRATO ORDER BY ULT_ALT_FUNCAO.DATA_INICIO_FUNCAO DESC)  AS SEQ_NUM , ULT_ALT_FUNCAO.* from RHPLCS_ALT_FUNCAO ULT_ALT_FUNCAO where ULT_ALT_FUNCAO.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_ALT_FUNCAO.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_ALT_FUNCAO.CODIGO_CONTRATO = (select codigo from SMARH_INT_PE_ALTSITFUN_AUDITO WHERE ID = (select Max(ID) from SMARH_INT_PE_ALTSITFUN_AUDITO))--'000000000883291' --vCODIGO_EMPRESA --vTIPO_CONTRATO --vCODIGO
AND ULT_ALT_FUNCAO.DATA_INICIO_FUNCAO <= (select max(aux.DATA_INICIO_FUNCAO) from RHPLCS_ALT_FUNCAO aux where ULT_ALT_FUNCAO.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND ULT_ALT_FUNCAO.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND ULT_ALT_FUNCAO.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO))X
WHERE X.SEQ_NUM = 1)
ULT_ALT_FUNCAO  ON ULT_ALT_FUNCAO.CODIGO_EMPRESA = LOG.CODIGO_EMPRESA AND ULT_ALT_FUNCAO.TIPO_CONTRATO = LOG.TIPO_CONTRATO AND ULT_ALT_FUNCAO.CODIGO_CONTRATO = LOG.CODIGO --AND TRUNC(AF.DATA_INICIO_FUNCAO) = TRUNC(LOG.data_inic_situacao)

/*LEFT OUTER JOIN (SELECT X.* FROM (SELECT ROW_NUMBER() OVER   (PARTITION BY ULT_ALT_FUNCAO.CODIGO_CONTRATO ORDER BY ULT_ALT_FUNCAO.DATA_INICIO_FUNCAO DESC)  AS SEQ_NUM , ULT_ALT_FUNCAO.* from RHPLCS_ALT_FUNCAO ULT_ALT_FUNCAO where ULT_ALT_FUNCAO.CODIGO_EMPRESA = '0001' AND ULT_ALT_FUNCAO.TIPO_CONTRATO = '0001' AND ULT_ALT_FUNCAO.CODIGO_CONTRATO = (select codigo from SMARH_INT_PE_ALTSITFUN_AUDITO WHERE ID = (select Max(ID) from SMARH_INT_PE_ALTSITFUN_AUDITO))--'000000000883291' --vCODIGO_EMPRESA --vTIPO_CONTRATO --vCODIGO
AND ULT_ALT_FUNCAO.DATA_INICIO_FUNCAO <= (select max(aux.DATA_INICIO_FUNCAO) from RHPLCS_ALT_FUNCAO aux where ULT_ALT_FUNCAO.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND ULT_ALT_FUNCAO.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND ULT_ALT_FUNCAO.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO))X
WHERE X.SEQ_NUM = 2)
PENULT_ALT_FUNC ON LOG.CODIGO_EMPRESA = PENULT_ALT_FUNC.CODIGO_EMPRESA AND LOG.TIPO_CONTRATO = PENULT_ALT_FUNC.TIPO_CONTRATO AND LOG.CODIGO = PENULT_ALT_FUNC.CODIGO_CONTRATO
*/
LEFT OUTER JOIN RHTABS_MOVIMENT M ON M.CODIGO = to_char(lpad(NEW_SF.c_livre_valor04,4,0))
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = C.VINCULO

LEFT OUTER JOIN(SELECT X.* FROM(SELECT ROW_NUMBER() OVER (PARTITION BY ULT_ASF.CODIGO ORDER BY ULT_ASF.DATA_INIC_SITUACAO DESC) AS SEQ_NUM, ULT_ASF.* FROM RHCGED_ALT_SIT_FUN ULT_ASF WHERE ULT_ASF.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_ASF.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_ASF.CODIGO = (select codigo from SMARH_INT_PE_ALTSITFUN_AUDITO WHERE ID = (select Max(ID) from SMARH_INT_PE_ALTSITFUN_AUDITO))
AND ULT_ASF.DATA_INIC_SITUACAO <= (SELECT MAX(AUX.data_inic_situacao) FROM RHCGED_ALT_SIT_FUN AUX WHERE AUX.CODIGO_EMPRESA = ULT_ASF.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = ULT_ASF.TIPO_CONTRATO AND AUX.CODIGO = ULT_ASF.CODIGO)
)X WHERE X.SEQ_NUM = 2)
PENULT_ASF ON LOG.CODIGO_EMPRESA = PENULT_ASF.CODIGO_EMPRESA AND LOG.TIPO_CONTRATO = PENULT_ASF.TIPO_CONTRATO AND LOG.CODIGO = PENULT_ASF.CODIGO

LEFT OUTER JOIN RHPARM_SIT_FUNC PENULT_ASF_SF ON PENULT_ASF_SF.CODIGO = PENULT_ASF.cod_sit_funcional
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV where codigo_CONVERSAO ='SF01')PENULT_ASF_TC ON lpad(PENULT_ASF_TC.DADO_ORIGEM,4,0) = to_char(lpad(PENULT_ASF.MOTIVO_AFAST,4,0))


--LEFT OUTER JOIN RHPARM_CAUSA_RESC NEW_CAUSA_RESC ON NEW_CAUSA_RESC.CODIGO =  to_char(lpad(NEW_SF.PENULT_ASF_SF.c_livre_valor03,4,0)) --ajustado em 31-10-19
--LEFT OUTER JOIN RHPARM_CAUSA_RESC OLD_CAUSA_RESC ON OLD_CAUSA_RESC.CODIGO =  to_char(lpad(OLD_SF.PENULT_ASF_SF.c_livre_valor03,4,0)) --ajustado em 31-10-19
LEFT OUTER JOIN RHPARM_CAUSA_RESC NEW_CAUSA_RESC ON NEW_CAUSA_RESC.CODIGO =  to_char(lpad(NEW_SF.c_livre_valor03,4,0)) --ajustado em 31-10-19
LEFT OUTER JOIN RHPARM_CAUSA_RESC OLD_CAUSA_RESC ON OLD_CAUSA_RESC.CODIGO =  to_char(lpad(OLD_SF.c_livre_valor03,4,0))--ajustado em 31-10-19

WHERE LOG.ID =
(--INICIO-- achar o ID CERTO
select
CASE
WHEN LOG_PENULT.TIPO_DML = 'I' AND LOG.TIPO_DML = 'U' AND LOG.NEW_COD_SIT_FUNCIONAL = LOG.OLD_COD_SIT_FUNCIONAL
AND LOG.OLD_DATA_FIM_SITUACAO IS NULL AND LOG.NEW_DATA_FIM_SITUACAO IS NOT NULL AND TRUNC(LOG.NEW_DATA_FIM_SITUACAO)+1 = TRUNC(LOG_PENULT.DATA_INIC_SITUACAO)
THEN LOG_PENULT.ID ---INSERT COM UPDATE
WHEN LOG_PENULT.TIPO_DML = 'D' AND LOG.TIPO_DML = 'U' AND LOG.NEW_COD_SIT_FUNCIONAL = LOG.OLD_COD_SIT_FUNCIONAL
AND LOG.OLD_DATA_FIM_SITUACAO IS NOT NULL AND LOG.NEW_DATA_FIM_SITUACAO IS NULL AND TRUNC(LOG.OLD_DATA_FIM_SITUACAO)+1 = TRUNC(LOG_PENULT.DATA_INIC_SITUACAO)
THEN LOG_PENULT.ID -- DELETE COM UPDATE --NOVO EM 13/5/20
ELSE LOG.ID
END ID_TRABALHAR
FROM
SMARH_INT_PE_ALTSITFUN_AUDITO LOG
LEFT OUTER JOIN
(
SELECT LOG_PENULT.* FROM SMARH_INT_PE_ALTSITFUN_AUDITO LOG_PENULT WHERE LOG_PENULT.id  =
    (select max(AUX.id)-1 from SMARH_INT_PE_ALTSITFUN_AUDITO AUX
        where AUX.codigo_empresa = LOG_PENULT.codigo_empresa and AUX.tipo_contrato = LOG_PENULT.tipo_contrato and AUX.codigo = LOG_PENULT.codigo )
)LOG_PENULT ON LOG.ID = LOG_PENULT.ID+1
WHERE
LOG.CODIGO_EMPRESA = vCODIGO_EMPRESA
AND LOG.TIPO_CONTRATO = vTIPO_CONTRATO
AND LOG.CODIGO = vCODIGO
AND LOG.id  = (select max(AUX.id) from SMARH_INT_PE_ALTSITFUN_AUDITO AUX  where AUX.codigo_empresa = LOG.codigo_empresa and AUX.tipo_contrato = LOG.tipo_contrato and AUX.codigo = LOG.codigo)--pegar ultimo registro na tabela de log do bm na tela
)--fim-- achar o ID CERTO
)X
--PARTE NOVA inicio 14/10/19
WHERE X.CODIGO_EMPRESA = vCODIGO_EMPRESA
AND X.TIPO_CONTRATO = vTIPO_CONTRATO
AND X.CODIGO = vCODIGO
--PARTE NOVA fim 14/10/19

)X2
--FIM SELECT-------------------------------------------------------------------------------C2


)--FIM DO FOR
--------------------------------------------------------------------------------------------------------------INICIO V2-----------------------------------------------------------------------------------------

--****INICIO************************************************************************** 1PARTE ---------------- CRIA / ALTERA ULTIMO CONTRATO

LOOP



dbms_output.put_line('entrou' );
dbms_output.put_line(C2.ID||'--'||C2.TIPO_DML||'-'||vCODIGO_EMPRESA ||'-'|| vTIPO_CONTRATO ||'-'|| vCODIGO );

     --trocar de lugar em 18/12/20 devido ao recesso de estagio, COLOCANDO aqui e TIRANDO ANTES do select do FOR C2
    --VERIFICAR SE O REGISTRO TRATADO NO LOG ser O ULTIMO NA ALTERAcao DE SITUAcaO FUNCIONAL DA PESSOA
    IF vQTD_ALT_SIT_FUNC_GERAL = 0 THEN
    vDATA_INIC_SITUACAO_ULT := to_date(to_char(C2.DATA_INIC_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy');
    ELSE
    SELECT CASE WHEN A.DATA_INIC_SITUACAO IS NULL THEN to_date(to_char(C2.DATA_INIC_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') ELSE to_date(to_char(A.DATA_INIC_SITUACAO,'dd/mm/yyyy'),'dd/mm/yyyy') END
    INTO vDATA_INIC_SITUACAO_ULT FROM RHCGED_ALT_SIT_FUN A
    WHERE  A.CODIGO_EMPRESA = vCODIGO_EMPRESA AND A.TIPO_CONTRATO = vTIPO_CONTRATO AND A.CODIGO = vCODIGO
    AND A.DATA_INIC_SITUACAO = (SELECT MAX(AUX.DATA_INIC_SITUACAO)FROM RHCGED_ALT_SIT_FUN AUX
                                WHERE  A.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND A.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND A.CODIGO = AUX.CODIGO);
    END IF;

IF vQTD_ALT_SIT_FUNC_GERAL <> 0 THEN --NOVO EM 18/12/20 - QUANDO A PESSOA NAO TEM MAIS NENHUM REGISTRO NA SIT FUNC

--1TAREFA --
---INICIO--EM 1/7/19 Antes de tudo criar o contato se ja nao existir no MeS DE LAcAMENTO DO REGISTRO---

/*INICIO LETICIA fez melhorias aqui*/
IF TO_DATE('01'||SUBSTR(vANO_MES_REF_ULT_CONTRATO,3,8),'DD/MM/YY') < TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY') THEN

-------------------------------------*******************************INSERE CONTRATO MES SISTEMA E CONTRATO AUX
PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,vDATA_SISTEMA ); /*AJUSTADO POR LETICIA EM 29/03/2023*/
PR_INSERE_CONTRATO_AUX(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,vDATA_SISTEMA,vLOGIN_USUARIO ); /*AJUSTADO POR LETICIA EM 12/06/2023*/


END IF;

delete rhpess_contrato_aux c where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia > TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY');COMMIT;
delete rhpess_contrato c where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia > TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'); commit; 


/*INCLUIDO POR LETICIA EM 02/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
    IF ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
        OR
        ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) THEN   /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */

        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

        FOR CNT IN
        (
          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.SITUACAO_FUNCIONAL , C.SITUACAO_CONTRATO
          FROM rhpess_contrato C 
          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
        )
        LOOP                                      
                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('SITUACAO_FUNCIONAL','SITUACAO_CONTRATO'),LISTA(CNT.SITUACAO_FUNCIONAL,CNT.SITUACAO_CONTRATO),LISTA(C2.ULT_ASF_COD_SIT_FUNCIONAL,C2.ULT_ASF_SF_CONTROLE_FOLHA)) ;   

                UPDATE rhpess_contrato C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.SITUACAO_FUNCIONAL = C2.ULT_ASF_COD_SIT_FUNCIONAL, C.SITUACAO_CONTRATO = C2.ULT_ASF_SF_CONTROLE_FOLHA
                where C.codigo_empresa = CNT.CODIGO_EMPRESA and C.tipo_contrato = CNT.TIPO_CONTRATO And C.CODIGO = CNT.CODIGO AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                COMMIT;

        END LOOP;   
/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
    ELSE 

        -------------------------------------*******************************ATUALIZA CONTRATO MES SISTEMA E FUTUROS
        UPDATE rhpess_contrato C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.SITUACAO_FUNCIONAL = C2.ULT_ASF_COD_SIT_FUNCIONAL, C.SITUACAO_CONTRATO = C2.ULT_ASF_SF_CONTROLE_FOLHA
        where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND trunc(C.ano_mes_referencia) = to_date(trunc(vDATA_SISTEMA,'MM'),'dd/mm/yyyy');
        COMMIT;

    END IF;


/*FIM LETICIA fez melhorias aqui*/


--*****INICIO************************************************************************* 2 PARTE ---------------- INTERVENcOES SE O REIGSTRO DA ALT DE SIT FUNC FOR O ULTIMO NA VIDA DA PESSOA
--------------------------------------------------------------------------------INICIO 1 IF - VERIFICAR SE O ULTIMO REGISTRO DO LOG ser O ULTIMO NA VIDA DA PESSOA DE altercao de situacao funcional
--------------------------------------------------------------------------------INICIO IF - TIPO_DML -********************ULTIMO REGISTRO****************************************-----------------------------------------
--if  C2.TIPO_REGISTRO = 'ULTIMO'  then
IF C2.DATA_INIC_SITUACAO >= vDATA_INIC_SITUACAO_ULT  THEN
dbms_output.put_line('ULTIMO REGISTRO' );


IF C2.TIPO_DML = 'I' THEN-------------------------------------------------------INSERT
dbms_output.put_line('TIPO_DML igual a Insert ULTIMO REGISTRO' );

--15 TAREFA
--INICIO --Situaco 5800-FALECIMENTO?

/*LETICIA AJUSTOU AQUI EM 26/05/2023*/
IF C2.NEW_CAUSA_RESC_codigo_esocial = '10' THEN
dbms_output.put_line('15I-GRAVA DATA DE FALECIMENTO NA PESSOA'); 
    PR_INSERE_PESSOA_H(C2.CODIGO_EMPRESA,C2.CODIGO_PESSOA,C2.DATA_INIC_SITUACAO );
    UPDATE RHPESS_PESSOA SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DATA_FALECIMENTO = trunc(C2.DATA_INIC_SITUACAO) WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CODIGO = C2.CODIGO_PESSOA;    
    UPDATE RHPESS_PESSOA_H SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DATA_FALECIMENTO = trunc(C2.DATA_INIC_SITUACAO) WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CODIGO = C2.CODIGO_PESSOA AND ANO_MES_REFERENCIA >= trunc(C2.DATA_INIC_SITUACAO);
    COMMIT;

END IF;
--FIM --Situcao 5800-FALECIMENTO?


--inicio --novo em 02/12/20 --limpar situação de ponto quando situação funcional não tinha data fim e tem no update e criou sit ponto via simulador_ifpontov4.sql ou simulador_ifpontov5.sql
SELECT X.NEW_COD_SIT_FUNCIONAL, X.OLD_COD_SIT_FUNCIONAL, X.NEW_DATA_FIM_SITUACAO, X.OLD_DATA_FIM_SITUACAO, S.CONTROLE_FOLHA OLD_SF_CONTROLE_FOLHA, S.SITUACAO_PONTO OLD_SF_SITUACAO_PONTO
INTO vPENUL_NEW_COD_SIT_FUNCIONAL, vPENUL_OLD_COD_SIT_FUNCIONAL, vPENUL_NEW_DATA_FIM_SITUACAO, vPENUL_OLD_DATA_FIM_SITUACAO, vPENUL_OLD_SF_CONTROLE_FOLHA, vPENUL_OLD_SF_SITUACAO_PONTO
FROM SMARH_INT_PE_ALTSITFUN_AUDITO X 
LEFT OUTER JOIN RHPARM_SIT_FUNC S ON S.CODIGO = X.OLD_COD_SIT_FUNCIONAL
WHERE X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO = C2.CODIGO
AND X.ID =(SELECT MAX(U.ID)FROM SMARH_INT_PE_ALTSITFUN_AUDITO U WHERE U.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND U.TIPO_CONTRATO = C2.TIPO_CONTRATO AND U.CODIGO = C2.CODIGO );

IF vPENUL_NEW_COD_SIT_FUNCIONAL IS NOT NULL AND vPENUL_OLD_COD_SIT_FUNCIONAL IS NOT NULL AND vPENUL_NEW_COD_SIT_FUNCIONAL = vPENUL_OLD_COD_SIT_FUNCIONAL 
AND vPENUL_NEW_DATA_FIM_SITUACAO IS NOT NULL AND vPENUL_OLD_DATA_FIM_SITUACAO IS NULL 
AND vPENUL_OLD_SF_CONTROLE_FOLHA IN ('N','O') AND vPENUL_OLD_SF_SITUACAO_PONTO IS NOT NULL THEN
    dbms_output.put_line('EXCLUIR SITUACAO PONTO CRIADAS COM DATA FIM FICTICIA A PARTIR DO DIA SEGUINTE A DA DATA - '|| vPENUL_NEW_DATA_FIM_SITUACAO);
    DELETE RHPONT_RES_SIT_DIA WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO 
    AND trunc(DATA) > trunc(vPENUL_NEW_DATA_FIM_SITUACAO) AND CODIGO_SITUACAO = vPENUL_OLD_SF_SITUACAO_PONTO; COMMIT;
END IF;
--fim--novo em 02/12/20 --limpar situação de ponto quando situação funcional não tinha data fim e tem no update e criou sit ponto via simulador_ifpontov4.sql ou simulador_ifpontov5.sql


--INICIO --NOVO EM 1/3/22 EMAIL (Re: Configuração situação funcional 6200)
IF  C2.NEW_COD_SIT_FUNCIONAL	= '6201' AND 
    (
    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
    OR
    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
    )

THEN
    dbms_output.put_line('--INCLUIR DATA RESCISAO PARA RPA SIT FUNC 6201');

/*INCLUIDO POR LETICIA EM 02/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

    FOR CNT IN
        (
          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_RESCISAO
          FROM rhpess_contrato C 
          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
        )
        LOOP                                      
                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('DATA_RESCISAO'),LISTA(CNT.DATA_RESCISAO),LISTA(C2.DATA_INIC_SITUACAO)) ;   

                UPDATE rhpess_contrato C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_RESCISAO = C2.DATA_INIC_SITUACAO
                where C.codigo_empresa = CNT.CODIGO_EMPRESA and C.tipo_contrato = CNT.TIPO_CONTRATO And C.CODIGO = CNT.CODIGO AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                COMMIT;

    END LOOP;   
/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/


    UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = C2.DATA_INIC_SITUACAO , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
    WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
    COMMIT;

    UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = C2.DATA_INIC_SITUACAO
    WHERE 
    X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
    X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
    ;

    UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = C2.DATA_INIC_SITUACAO
    WHERE 
    X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
     X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
    ;

END IF;

IF C2.NEW_COD_SIT_FUNCIONAL	= '6200' THEN
    dbms_output.put_line('--INCLUIR DT EFETIVO EXERCICIO PARA RPA SIT FUNC 6200');
    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = C2.DATA_INIC_SITUACAO
    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
    --AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
    ;COMMIT;
END IF;
--FIM--NOVO EM 1/3/22 EMAIL (Re: Configuração situação funcional 6200)


--INICIO--NOVO EM 17/12/20 - GRAVAR RECESSO DOS ESTAGIOS
IF C2.NEW_COD_SIT_FUNCIONAL	= '1800' THEN
dbms_output.put_line('--INCLUIR RECESSOS DO ESTAGIO');
    PR_INSERE_RECESSO_ESTAGIO ( vCODIGO_EMPRESA,vTIPO_CONTRATO,vCODIGO );
END IF;    
--FIM--NOVO EM 17/12/20 - GRAVAR RECESSO DOS ESTAGIOS


ELSIF C2.TIPO_DML = 'U' THEN----------------------------------------------------UPDATE
dbms_output.put_line('TIPO_DML igual a Update ULTIMO REGISTRO' );


--INICIO--------------------------------------------------------------------*******DADOS ANTES DE ALTERAR*********-----------------------------------
--2 TAREFA
 --INICIO   --VERIFICAR SEr A PRIMEIRA SITUAcaO FUNCIONAL NA HISTORIA DA PESSOA COM CONTROLE_FOLHA IN ('N', 'L', 'M') para gravar DATA_EFETIVO_EXERC ----------------------------
IF vQTD_ALT_SIT_FUNC = 0 AND C2.OLD_SF_CONTROLE_FOLHA IN ('N', 'L', 'M') and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy') THEN
    dbms_output.put_line('2U-APAGA ulitmo contrato DATA EFETIVO EXERCICIO');
    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = NULL--, C.data_base_ferias = NULL
    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
    --AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
    --)
    ;COMMIT;
END IF;
 --FIM      --VERIFICAR Ser A PRIMEIRA SITUAcaO FUNCIONAL NA HISTORIA DA PESSOA COM CONTROLE_FOLHA IN ('N', 'L', 'M') para gravar DATA_EFETIVO_EXERC-----------------------------

--3 TAREFA
--INICIO --EXISTIA Cargo Efetivo com Cargo Comissionado ou Fucao?
--cargo comissionado
IF C2.NEW_SF_CONTROLE_FOLHA IN ('D','S') AND -- NOVO EM 22-9-20 DEVIDO EMAIL PATRICIA COM ERRO NESSA DATA RESPONDIDO
TRUNC(C2.ULT_ALT_CARG_DT_INI) = TRUNC(C2.DATA_INIC_SITUACAO) AND C2.ULT_ALT_CARG_motivo_alteracao = '0005' AND C2.ULT_ALT_CARG_dt_fim IS NULL
AND C2.PEN_ALT_CARG_DT_FIM_TEMP IS NOT NULL AND (C2.P_CARG_COD_CARGO_COMIS_AT IS NOT NULL OR C2.P_CARG_COD_CARGO_COMIS_AT  <> '000000000000000') THEN
    --3.1 TAREFA
    dbms_output.put_line('3.1U-VOLTA dados ultimo contrato: aba CARGOS');
        IF C2.PEN_ALT_CARG_SALARIO_PAGTO = 'E' THEN
       /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
             (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            )
            THEN   
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.COD_CARGO_COMISS, C.nivel_cargo_comiss, C.DT_ULT_CARGO_COM, C.COD_CARGO_PAGTO, C.nivel_cargo_pagto
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      

                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('COD_CARGO_COMISS', 'NIVEL_CARGO_COMISS', 'DT_ULT_CARGO_COM', 'COD_CARGO_PAGTO', 'NIVEL_CARGO_PAGTO'),LISTA(CNT.COD_CARGO_COMISS, CNT.nivel_cargo_comiss, CNT.DT_ULT_CARGO_COM, CNT.COD_CARGO_PAGTO, CNT.nivel_cargo_pagto),LISTA(C2.P_CARG_COD_CARGO_COMIS_AT, '00000', C2.PEN_ALT_CARG_DT_ALTER_CARGO, C2.cod_cargo_efetivo, C2.nivel_cargo_efetiv)) ;   

                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, 
                C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.nivel_cargo_comiss = '00000', 
                C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, C.COD_CARGO_PAGTO = C2.cod_cargo_efetivo, 
                C.nivel_cargo_pagto = C2.nivel_cargo_efetiv
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP; 
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, 
                C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.nivel_cargo_comiss = '00000', 
                C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, C.COD_CARGO_PAGTO = C2.cod_cargo_efetivo, 
                C.nivel_cargo_pagto = C2.nivel_cargo_efetiv
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                ); 
            END IF;
       /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        ELSIF C2.PEN_ALT_CARG_SALARIO_PAGTO = 'C'  THEN            
           /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
             (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            ) THEN   
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.COD_CARGO_COMISS, C.DT_ULT_CARGO_COM, C.COD_CARGO_PAGTO, C.NIVEL_CARGO_PAGTO
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      

                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('COD_CARGO_COMISS', 'DT_ULT_CARGO_COM', 'COD_CARGO_PAGTO', 'NIVEL_CARGO_PAGTO'),LISTA(CNT.COD_CARGO_COMISS, CNT.DT_ULT_CARGO_COM, CNT.COD_CARGO_PAGTO, CNT.nivel_cargo_pagto),LISTA(C2.P_CARG_COD_CARGO_COMIS_AT, C2.PEN_ALT_CARG_DT_ALTER_CARGO, C2.PEN_ALT_CARG_SALARIO_PAGTO, '000000000000000')) ;   

                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, 
                C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, 
                C.COD_CARGO_PAGTO = C2.PEN_ALT_CARG_SALARIO_PAGTO, C.nivel_cargo_pagto = '000000000000000'
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP; 
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, 
                C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, 
                C.COD_CARGO_PAGTO = C2.PEN_ALT_CARG_SALARIO_PAGTO, C.nivel_cargo_pagto = '000000000000000'
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                ); 
            END IF;
       /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        END IF;
    --3.2 TAREFA
    dbms_output.put_line('3.2U-EXCLUI ALT. CARGO que limpou os campos COMISSIONADO');
    DELETE RHPLCS_ALT_CARGO
    WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
    AND TRUNC(DT_ALTER_CARGO) = TRUNC(C2.ULT_ALT_CARG_DT_INI) AND OCORRENCIA = C2.ULT_ALT_CARG_OCORRENCIA AND motivo_alteracao = C2.ULT_ALT_CARG_motivo_alteracao AND cod_cargo_comis_at = C2.ULT_ALT_CARG_cod_cargo_com;
    COMMIT;
    --3.3 TAREFA
    dbms_output.put_line('3.3U-APAGA DATA FIM registro anterior ALT CARGO');
    UPDATE RHPLCS_ALT_CARGO SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
    WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
    AND TRUNC(DT_ALTER_CARGO) = TRUNC(C2.PEN_ALT_CARG_DT_ALTER_CARGO) AND MOTIVO_ALTERACAO = C2.PEN_ALT_CARG_MOTIVO_ALTERACAO;
    COMMIT;
END IF;

--inicio------------------comentado em 17/6/20 devido a erro originado email (Fwd: Função Gratificada Retornando ao Contrato - Ilmara 32.109-9)
/*--funcao
--IF /*TRUNC(C2.ULT_ALT_FUNCAO_DT_INI) = TRUNC(C2.DATA_INIC_SITUACAO) AND*/
/*
C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA = '0002' AND C2.ULT_ALT_FUNCAO_dt_fim IS not NULL
--AND C2.P_ALT_FUNC_DT_FIM_TEMP IS NOT NULL
THEN
--3.1 TAREFA
dbms_output.put_line('3.1U-VOLTA dados ultimo contrato: aba FUNcoES');
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.CODIGO_FUNCAO = C2.ULT_ALT_FUNCAO_CODIGO_FUNCAO, C.DT_ULT_FUNCAO = C2.ULT_ALT_FUNCAO_DT_INI
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
); COMMIT;
--3.2 TAREFA
/*dbms_output.put_line('3.2U-EXCLUI ALT. FUNcoO que limpou os campos COMISSIONADO');
DELETE RHPLCS_ALT_FUNCAO
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND DATA_INICIO_FUNCAO = C2.ULT_ALT_FUNCAO_DT_INI AND codigo_hist_funcao = C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA
; COMMIT;
*/
/*
--3.3TAREFA
dbms_output.put_line('3.3U-APAGA DATA FIM registro anterior ALT FUNCAO');
UPDATE RHPLCS_ALT_FUNCAO SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND TRUNC(DATA_INICIO_FUNCAO) = TRUNC(C2.ULT_ALT_FUNCAO_DT_INI) AND codigo_hist_funcao = C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA
; COMMIT;
END IF;
--FIM --EXISTIA Cargo Efetivo com Cargo Comissionado ou Funcao?
*/
--fim------------------comentado em 17/6/20 devido a erro originado email (Fwd: Função Gratificada Retornando ao Contrato - Ilmara 32.109-9)


--4 TAREFA
--para desligamentos diferentes de FALECIMENTO

--INICIO --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
--INICIO --CODIGO JÁ EXISTIA ATE 7/5/21

/* INICIO --- LETÍCIA EM 13/04/2023 FEZ MELHORIAS AQUI */
dbms_output.put_line(C2.OLD_COD_MOVIMENTACAO);
dbms_output.put_line(C2.PENULT_MOV_DT_FIM_TEMP);
dbms_output.put_line(C2.NEW_SF_CONTROLE_FOLHA);
dbms_output.put_line(C2.OLD_SF_CONTROLE_FOLHA);
dbms_output.put_line(c2.NEW_CAUSA_RESC_codigo_esocial);
dbms_output.put_line(C2.OLD_CAUSA_RESC_codigo_esocial);
dbms_output.put_line(C2.NEW_COD_SIT_FUNCIONAL);
dbms_output.put_line(C2.OLD_COD_SIT_FUNCIONAL);
IF C2.OLD_COD_MOVIMENTACAO IS NOT NULL
AND C2.PENULT_MOV_DT_FIM_TEMP IS NOT NULL
AND (( C2.NEW_SF_CONTROLE_FOLHA IN ('D','S') or C2.OLD_SF_CONTROLE_FOLHA IN ('D','S') )
and (C2.NEW_CAUSA_RESC_codigo_esocial IS NULL OR C2.NEW_CAUSA_RESC_codigo_esocial <> '10' or C2.OLD_CAUSA_RESC_codigo_esocial IS NULL OR C2.OLD_CAUSA_RESC_codigo_esocial <> '10'))--novo em 5/11/19 Kellysson
AND (C2.NEW_COD_SIT_FUNCIONAL <> C2.OLD_COD_SIT_FUNCIONAL OR (C2.NEW_DATA_FIM_SITUACAO <> C2.OLD_DATA_FIM_SITUACAO))  THEN --parte diferente da tarefas entre o UPDATE e DELETE

    IF TRUNC(C2.DATA_INIC_SITUACAO) >= TO_DATE('01/12/2021','DD/MM/YYYY') THEN --IF NOVO EM 6/12/21 

        IF TRUNC(C2.ULT_MOV_DT_INICIO) = TRUNC(C2.DATA_INIC_SITUACAO) THEN -- COMENTADO EM 29/11/21 -1 
        --4.1 TAREFA
        dbms_output.put_line('4.1UA-VOLTA dados ultimo contrato: aba LOCALIZAcaO');

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF  (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            ) THEN   
            
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      
                        PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('COD_MOVIMENTACAO','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_LOC','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_UNID','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_CONT','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6','DT_ULT_ALT_GER'),LISTA(CNT.cod_movimentacao,CNT.COD_LOCAL1, CNT.COD_LOCAL2, CNT.COD_LOCAL3, CNT.COD_LOCAL4, CNT.COD_LOCAL5, CNT.COD_LOCAL6, CNT.DT_ULT_ALT_LOC,CNT.COD_UNIDADE1, CNT.COD_UNIDADE2, CNT.COD_UNIDADE3, CNT.COD_UNIDADE4 , CNT.COD_UNIDADE5 , CNT.COD_UNIDADE6 , CNT.DT_ULT_ALT_UNID , CNT.COD_CUSTO_CONTAB1, CNT.COD_CUSTO_CONTAB2 , CNT.COD_CUSTO_CONTAB3 , CNT.COD_CUSTO_CONTAB4 ,CNT.COD_CUSTO_CONTAB5 , CNT.COD_CUSTO_CONTAB6 , CNT.DT_ULT_ALT_CONT , CNT.COD_CUSTO_GERENC1 , CNT.COD_CUSTO_GERENC2 , CNT.COD_CUSTO_GERENC3 , CNT.COD_CUSTO_GERENC4 , CNT.COD_CUSTO_GERENC5 , CNT.COD_CUSTO_GERENC6 , CNT.DT_ULT_ALT_GER ),LISTA(C2.PENULT_MOV_COD_MOVIMENTACAO,C2.COD_LOTACAO_ATUAL1,C2.COD_LOTACAO_ATUAL2,C2.COD_LOTACAO_ATUAL3,C2.COD_LOTACAO_ATUAL4,C2.COD_LOTACAO_ATUAL5,C2.COD_LOTACAO_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_UNIDADE_ATUAL1,C2.COD_UNIDADE_ATUAL2,C2.COD_UNIDADE_ATUAL3,C2.COD_UNIDADE_ATUAL4,C2.COD_UNIDADE_ATUAL5,C2.COD_UNIDADE_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CCONTAB_ATUAL1,C2.COD_CCONTAB_ATUAL2, C2.COD_CCONTAB_ATUAL3, C2.COD_CCONTAB_ATUAL4, C2.COD_CCONTAB_ATUAL5,C2.COD_CCONTAB_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CGERENC_ATUAL1,C2.COD_CGERENC_ATUAL2, C2.COD_CGERENC_ATUAL3, C2.COD_CGERENC_ATUAL4, C2.COD_CGERENC_ATUAL5, C2.COD_CGERENC_ATUAL6, C2.PENULT_MOV_DT_ALT_UNID_CUSTO)) ;   

                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                        C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP;
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS 
                );
            END IF;
        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

         COMMIT;
        --4.2 TAREFA
        dbms_output.put_line('4.2UA-EXCLUI  Movimentaca que foi criada');
        DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) -- COMENTADO EM 29/11/21  -1 
        AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        --4.3 TAREFA
        dbms_output.put_line('4.3UA-APAGA DATA FIM registro anterior HIST. MOVIMENTAcaO');
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO = C2.PENULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        END IF;

    ELSE --IF NOVO EM 6/12/21 
        IF TRUNC(C2.ULT_MOV_DT_INICIO) = TRUNC(C2.DATA_INIC_SITUACAO)-1 THEN-- COMENTADO EM 29/11/21  VOLTEI NO IF NOVO EM 6/12/21 
        --4.1 TAREFA
        dbms_output.put_line('4.1UA-VOLTA dados ultimo contrato: aba LOCALIZAcaO');

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF (
                ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                OR
                ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                ) THEN   
            
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      
                        PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('COD_MOVIMENTACAO','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_LOC','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_UNID','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_CONT','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6','DT_ULT_ALT_GER'),LISTA(CNT.cod_movimentacao,CNT.COD_LOCAL1, CNT.COD_LOCAL2, CNT.COD_LOCAL3, CNT.COD_LOCAL4, CNT.COD_LOCAL5, CNT.COD_LOCAL6, CNT.DT_ULT_ALT_LOC,CNT.COD_UNIDADE1, CNT.COD_UNIDADE2, CNT.COD_UNIDADE3, CNT.COD_UNIDADE4 , CNT.COD_UNIDADE5 , CNT.COD_UNIDADE6 , CNT.DT_ULT_ALT_UNID , CNT.COD_CUSTO_CONTAB1, CNT.COD_CUSTO_CONTAB2 , CNT.COD_CUSTO_CONTAB3 , CNT.COD_CUSTO_CONTAB4 ,CNT.COD_CUSTO_CONTAB5 , CNT.COD_CUSTO_CONTAB6 , CNT.DT_ULT_ALT_CONT , CNT.COD_CUSTO_GERENC1 , CNT.COD_CUSTO_GERENC2 , CNT.COD_CUSTO_GERENC3 , CNT.COD_CUSTO_GERENC4 , CNT.COD_CUSTO_GERENC5 , CNT.COD_CUSTO_GERENC6 , CNT.DT_ULT_ALT_GER ),LISTA(C2.PENULT_MOV_COD_MOVIMENTACAO,C2.COD_LOTACAO_ATUAL1,C2.COD_LOTACAO_ATUAL2,C2.COD_LOTACAO_ATUAL3,C2.COD_LOTACAO_ATUAL4,C2.COD_LOTACAO_ATUAL5,C2.COD_LOTACAO_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_UNIDADE_ATUAL1,C2.COD_UNIDADE_ATUAL2,C2.COD_UNIDADE_ATUAL3,C2.COD_UNIDADE_ATUAL4,C2.COD_UNIDADE_ATUAL5,C2.COD_UNIDADE_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CCONTAB_ATUAL1,C2.COD_CCONTAB_ATUAL2, C2.COD_CCONTAB_ATUAL3, C2.COD_CCONTAB_ATUAL4, C2.COD_CCONTAB_ATUAL5,C2.COD_CCONTAB_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CGERENC_ATUAL1,C2.COD_CGERENC_ATUAL2, C2.COD_CGERENC_ATUAL3, C2.COD_CGERENC_ATUAL4, C2.COD_CGERENC_ATUAL5, C2.COD_CGERENC_ATUAL6, C2.PENULT_MOV_DT_ALT_UNID_CUSTO)) ;   

                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                        C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP; 
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                ); 
            END IF;
        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        COMMIT;
        --4.2 TAREFA
        dbms_output.put_line('4.2UA-EXCLUI  Movimentaca que foi criada');
        DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO)-1 -- COMENTADO EM 29/11/21   VOLTEI NO IF NOVO EM 6/12/21 
        AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        IF (C2.OLD_SF_CONTROLE_FOLHA IN ('D','S')) then
            DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
            AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO --em 7/5/21 tirei o -1 da TRUNC(C2.ULT_MOV_DT_INICIO)-1 
        ; COMMIT;
        end if;
        --4.3 TAREFA
        dbms_output.put_line('4.3UA-APAGA DATA FIM registro anterior HIST. MOVIMENTAcaO');
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO = C2.PENULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        END IF;
    END IF;--IF NOVO EM 6/12/21 
END IF;
--FIM--CODIGO JÁ EXISTIA ATE 7/5/21

/* FIM --- LETÍCIA EM 13/04/2023 FEZ MELHORIAS AQUI */

--FIM --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?


--4 TAREFA
--PARA LICENCAS QUE GERAM MOVIMENTAcoES e FALECIMENTOS
--INICIO --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
IF TRUNC(C2.ULT_MOV_DT_INICIO) = TRUNC(C2.DATA_INIC_SITUACAO) 
AND C2.OLD_COD_MOVIMENTACAO IS NOT NULL
AND C2.PENULT_MOV_DT_FIM_TEMP IS NOT NULL
AND (C2.NEW_SF_CONTROLE_FOLHA IN ('L','M') OR C2.NEW_CAUSA_RESC_codigo_esocial = '10') --NOVO EM 31-10-19--novo em 5/11/19 Kellysson
AND (C2.NEW_COD_SIT_FUNCIONAL <> C2.OLD_COD_SIT_FUNCIONAL OR (C2.NEW_DATA_FIM_SITUACAO <> C2.OLD_DATA_FIM_SITUACAO))              THEN --parte diferente da tarefas entre o UPDATE e DELETE
--4.1 TAREFA
dbms_output.put_line('4.1UB-VOLTA dados ultimo contrato: aba LOCALIZAcaO');


/*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) and C2.NEW_CAUSA_RESC_codigo_esocial = '10' AND
             (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            ) THEN   
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      
                        PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('COD_MOVIMENTACAO','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_LOC','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_UNID','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_CONT','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6','DT_ULT_ALT_GER'),LISTA(CNT.cod_movimentacao,CNT.COD_LOCAL1, CNT.COD_LOCAL2, CNT.COD_LOCAL3, CNT.COD_LOCAL4, CNT.COD_LOCAL5, CNT.COD_LOCAL6, CNT.DT_ULT_ALT_LOC,CNT.COD_UNIDADE1, CNT.COD_UNIDADE2, CNT.COD_UNIDADE3, CNT.COD_UNIDADE4 , CNT.COD_UNIDADE5 , CNT.COD_UNIDADE6 , CNT.DT_ULT_ALT_UNID , CNT.COD_CUSTO_CONTAB1, CNT.COD_CUSTO_CONTAB2 , CNT.COD_CUSTO_CONTAB3 , CNT.COD_CUSTO_CONTAB4 ,CNT.COD_CUSTO_CONTAB5 , CNT.COD_CUSTO_CONTAB6 , CNT.DT_ULT_ALT_CONT , CNT.COD_CUSTO_GERENC1 , CNT.COD_CUSTO_GERENC2 , CNT.COD_CUSTO_GERENC3 , CNT.COD_CUSTO_GERENC4 , CNT.COD_CUSTO_GERENC5 , CNT.COD_CUSTO_GERENC6 , CNT.DT_ULT_ALT_GER ),LISTA(C2.PENULT_MOV_COD_MOVIMENTACAO,C2.COD_LOTACAO_ATUAL1,C2.COD_LOTACAO_ATUAL2,C2.COD_LOTACAO_ATUAL3,C2.COD_LOTACAO_ATUAL4,C2.COD_LOTACAO_ATUAL5,C2.COD_LOTACAO_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_UNIDADE_ATUAL1,C2.COD_UNIDADE_ATUAL2,C2.COD_UNIDADE_ATUAL3,C2.COD_UNIDADE_ATUAL4,C2.COD_UNIDADE_ATUAL5,C2.COD_UNIDADE_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CCONTAB_ATUAL1,C2.COD_CCONTAB_ATUAL2, C2.COD_CCONTAB_ATUAL3, C2.COD_CCONTAB_ATUAL4, C2.COD_CCONTAB_ATUAL5,C2.COD_CCONTAB_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CGERENC_ATUAL1,C2.COD_CGERENC_ATUAL2, C2.COD_CGERENC_ATUAL3, C2.COD_CGERENC_ATUAL4, C2.COD_CGERENC_ATUAL5, C2.COD_CGERENC_ATUAL6, C2.PENULT_MOV_DT_ALT_UNID_CUSTO)) ;   

                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                        C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP; 
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                ); 
            END IF;
        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

COMMIT;
--4.2 TAREFA
dbms_output.put_line('4.2UB-EXCLUI  MovimentaCAo que foi criada');
DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
; COMMIT;
--4.3 TAREFA
dbms_output.put_line('4.3UB-APAGA DATA FIM registro anterior HIST. MOVIMENTACAO');
UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO = C2.PENULT_MOV_COD_MOVIMENTACAO
; COMMIT;
END IF;
--FIM --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?


--14 TAREFA
--INICIO --SituACAo 5800-FALECIMENTO?

/*LETICIA AJUSTOU AQUI EM 26/05/2023*/
IF C2.OLD_CAUSA_RESC_codigo_esocial = '10' AND (C2.NEW_CAUSA_RESC_codigo_esocial <> '10' or C2.NEW_CAUSA_RESC_codigo_esocial is null) THEN
dbms_output.put_line('14U-APAGA DATA DE FALECIMENTO NA PESSOA');
    PR_INSERE_PESSOA_H(C2.CODIGO_EMPRESA,C2.CODIGO_PESSOA,C2.DATA_INIC_SITUACAO );
    UPDATE RHPESS_PESSOA SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DATA_FALECIMENTO = NULL WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CODIGO = C2.CODIGO_PESSOA;
    UPDATE RHPESS_PESSOA_H SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DATA_FALECIMENTO = NULL WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CODIGO = C2.CODIGO_PESSOA AND ANO_MES_REFERENCIA >= trunc(C2.DATA_INIC_SITUACAO);

    COMMIT;
END IF;
--FIM --SituACAo 5800-FALECIMENTO?



--FIM--------------------------------------------------------*******DADOS ANTES DE ALTERAR*********---------------------------------------------------------------

ELSIF C2.TIPO_DML = 'D' THEN----------------------------------------------------DELETE
dbms_output.put_line('TIPO_DML igual a Delete ULTIMO REGISTRO' );


--INICIO------------------------------------------------------------*******DADOS ANTES DE ALTERAR*********-------------------------
--2 TAREFA
 --INICIO   --VERIFICAR SER A PRIMEIRA SITUACAO FUNCIONAL NA HISTORIA DA PESSOA COM CONTROLE_FOLHA IN ('N', 'L', 'M') para gravar DATA_EFETIVO_EXERC----------------------------
IF vQTD_ALT_SIT_FUNC = 0 AND C2.OLD_SF_CONTROLE_FOLHA IN ('N', 'L', 'M') and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy') THEN
dbms_output.put_line('2D-APAGA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS');
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = NULL
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
--AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
--)
;COMMIT;
END IF;
 --FIM      --VERIFICAR SER A PRIMEIRA SITUACAO FUNCIONAL NA HISTORIA DA PESSOA COM CONTROLE_FOLHA IN ('N', 'L', 'M',) para gravar DATA_EFETIVO_EXERC-----------------------------

--3 TAREFA
--INICIO --EXISTIA Cargo Efetivo com Cargo Comissionado ou FunCAo?
--cargo comissionado
/*LETICIA DUVIDA*/
IF C2.OLD_SF_CONTROLE_FOLHA IN ('D','S') AND -- NOVO EM 22-9-20 DEVIDO EMAIL PATRICIA COM ERRO NESSA DATA RESPONDIDO
TRUNC(C2.ULT_ALT_CARG_DT_INI) = TRUNC(C2.DATA_INIC_SITUACAO) AND C2.ULT_ALT_CARG_motivo_alteracao = '0005' AND C2.ULT_ALT_CARG_dt_fim IS NULL
AND C2.PEN_ALT_CARG_DT_FIM_TEMP IS NOT NULL AND (C2.P_CARG_COD_CARGO_COMIS_AT IS NOT NULL OR C2.P_CARG_COD_CARGO_COMIS_AT  <> '000000000000000') THEN
--3.1 TAREFA
dbms_output.put_line('3.1DA-VOLTA dados ultimo contrato: aba CARGOS');
IF C2.PEN_ALT_CARG_SALARIO_PAGTO = 'E' THEN

/*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
    IF C2.OLD_SF_CONTROLE_FOLHA IN ('D' ) AND 
     (
    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
    OR
    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
    ) THEN   
        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

        FOR CNT IN
        (
          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.COD_CARGO_COMISS, C.nivel_cargo_comiss, C.DT_ULT_CARGO_COM, C.COD_CARGO_PAGTO, C.nivel_cargo_pagto
          FROM rhpess_contrato C 
          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
        )
        LOOP                                      
                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('COD_CARGO_COMISS', 'NIVEL_CARGO_COMISS', 'DT_ULT_CARGO_COM', 'COD_CARGO_PAGTO', 'NIVEL_CARGO_PAGTO'),LISTA(CNT.COD_CARGO_COMISS, CNT.nivel_cargo_comiss, CNT.DT_ULT_CARGO_COM, CNT.COD_CARGO_PAGTO, CNT.nivel_cargo_pagto),LISTA(C2.P_CARG_COD_CARGO_COMIS_AT, '00000', C2.PEN_ALT_CARG_DT_ALTER_CARGO, C2.cod_cargo_efetivo, C2.nivel_cargo_efetiv)) ;   

                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.nivel_cargo_comiss = '00000', C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, C.COD_CARGO_PAGTO = C2.cod_cargo_efetivo, C.nivel_cargo_pagto = C2.nivel_cargo_efetiv
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

        END LOOP; 
    ELSE
        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.nivel_cargo_comiss = '00000', C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, C.COD_CARGO_PAGTO = C2.cod_cargo_efetivo, C.nivel_cargo_pagto = C2.nivel_cargo_efetiv
        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
        ); 
    END IF;
/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

COMMIT;
ELSIF C2.PEN_ALT_CARG_SALARIO_PAGTO = 'C'  THEN

/*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
    IF C2.OLD_SF_CONTROLE_FOLHA IN ('D' ) AND 
     (
    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
    OR
    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
    ) THEN   
        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

        FOR CNT IN
        (
          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.COD_CARGO_COMISS, C.DT_ULT_CARGO_COM, C.COD_CARGO_PAGTO, C.nivel_cargo_pagto
          FROM rhpess_contrato C 
          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
        )
        LOOP                                      
                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('COD_CARGO_COMISS', 'DT_ULT_CARGO_COM', 'COD_CARGO_PAGTO', 'NIVEL_CARGO_PAGTO'),LISTA(CNT.COD_CARGO_COMISS, CNT.DT_ULT_CARGO_COM, CNT.COD_CARGO_PAGTO, CNT.nivel_cargo_pagto),LISTA(C2.P_CARG_COD_CARGO_COMIS_AT,C2.PEN_ALT_CARG_DT_ALTER_CARGO,C2.PEN_ALT_CARG_SALARIO_PAGTO, '00000000')) ;   

                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, C.COD_CARGO_PAGTO = C2.PEN_ALT_CARG_SALARIO_PAGTO, C.nivel_cargo_pagto = '00000000'
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

        END LOOP;
    ELSE
        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_CARGO_COMISS = C2.P_CARG_COD_CARGO_COMIS_AT, C.DT_ULT_CARGO_COM = C2.PEN_ALT_CARG_DT_ALTER_CARGO, C.COD_CARGO_PAGTO = C2.PEN_ALT_CARG_SALARIO_PAGTO, C.nivel_cargo_pagto = '00000000'
        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
        );
    END IF;
/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

COMMIT;
END IF;
--3.2 TAREFA
dbms_output.put_line('3.2D1-EXCLUI ALT. CARGO que limpou os campos COMISSIONADO');
DELETE RHPLCS_ALT_CARGO
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND TRUNC(DT_ALTER_CARGO) = TRUNC(C2.ULT_ALT_CARG_DT_INI) AND MOTIVO_ALTERACAO = C2.ULT_ALT_CARG_MOTIVO_ALTERACAO
; 
COMMIT;
--3.3 TAREFA
dbms_output.put_line('3.3D-APAGA DATA FIM registro anterior ALT CARGO');
UPDATE RHPLCS_ALT_CARGO SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL, cod_cargo_comis_at = C2.P_CARG_COD_CARGO_COMIS_AT, niv_cargo_comis_at = C2.P_CARG_NIV_CARGO_COMIS_AT, salario_pagto = C2.PEN_ALT_CARG_SALARIO_PAGTO
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND TRUNC(DT_ALTER_CARGO) = TRUNC(C2.PEN_ALT_CARG_DT_ALTER_CARGO) AND MOTIVO_ALTERACAO = C2.PEN_ALT_CARG_MOTIVO_ALTERACAO
; COMMIT;
END IF;

--inicio------------------comentado em 17/6/20 devido a erro originado email (Fwd: Função Gratificada Retornando ao Contrato - Ilmara 32.109-9)
--funcao
--IF /*TRUNC(C2.ULT_ALT_FUNCAO_DT_INI) = TRUNC(C2.DATA_INIC_SITUACAO) AND*/ C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA = '0002' AND C2.ULT_ALT_FUNCAO_dt_fim IS NOT NULL
--AND C2.P_ALT_FUNC_DT_FIM_TEMP IS NOT NULL
/*THEN
--3.1 TAREFA
dbms_output.put_line('3.1DB-VOLTA dados ultimo contrato: aba FUNCOES');
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.CODIGO_FUNCAO = C2.ULT_ALT_FUNCAO_CODIGO_FUNCAO, C.DT_ULT_FUNCAO = C2.ULT_ALT_FUNCAO_DT_INI
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
); COMMIT;
--3.2 TAREFA
/*dbms_output.put_line('3.2D2-EXCLUI ALT. FUNCAO que limpou os campos COMISSIONADO');
DELETE RHPLCS_ALT_FUNCAO
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND DATA_INICIO_FUNCAO = C2.ULT_ALT_FUNCAO_DT_INI AND codigo_hist_funcao = C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA
; COMMIT;
*/
--3.3 TAREFA
/*
dbms_output.put_line('3.3D-APAGA DATA FIM registro anterior ALT FUNCAO');
UPDATE RHPLCS_ALT_FUNCAO SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND TRUNC(DATA_INICIO_FUNCAO) = TRUNC(C2.ULT_ALT_FUNCAO_DT_INI) AND codigo_hist_funcao = C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA
; COMMIT;
END IF;
--FIM --EXISTIA Cargo Efetivo com Cargo Comissionado ou FunCAo?
*/
--fim------------------comentado em 17/6/20 devido a erro originado email (Fwd: Função Gratificada Retornando ao Contrato - Ilmara 32.109-9)



--4 TAREFA
--para desligamentos diferentes de FALECIMENTO
--INICIO --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
--AJUSTES FEITOS EM 13/5/20 KELLYSSON pois não estava excluindo registro de movimentação
IF  C2.OLD_COD_MOVIMENTACAO IS NOT NULL
AND C2.PENULT_MOV_DT_FIM_TEMP IS NOT NULL
AND (C2.OLD_SF_CONTROLE_FOLHA IN ('D','S') and (C2.OLD_CAUSA_RESC_codigo_esocial IS NULL OR C2.OLD_CAUSA_RESC_codigo_esocial <> '10'))--novo em 5/11/19 Kellysson
THEN
    IF TRUNC(C2.DATA_INIC_SITUACAO) >= TO_DATE('01/12/2021','DD/MM/YYYY') THEN --IF NOVO EM 6/12/21
        IF TRUNC(C2.ULT_MOV_DT_INICIO) = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
        THEN --parte diferente da tarefas entre o UPDATE e DELETE
        --4.1 TAREFA
        dbms_output.put_line('4.1UC-VOLTA dados ultimo contrato: aba LOCALIZAcaO');

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF C2.OLD_SF_CONTROLE_FOLHA IN ('D' ) AND 
             (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            )THEN   
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      
                        PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('COD_MOVIMENTACAO','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_LOC','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_UNID','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_CONT','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6','DT_ULT_ALT_GER'),LISTA(CNT.cod_movimentacao,CNT.COD_LOCAL1, CNT.COD_LOCAL2, CNT.COD_LOCAL3, CNT.COD_LOCAL4, CNT.COD_LOCAL5, CNT.COD_LOCAL6, CNT.DT_ULT_ALT_LOC,CNT.COD_UNIDADE1, CNT.COD_UNIDADE2, CNT.COD_UNIDADE3, CNT.COD_UNIDADE4 , CNT.COD_UNIDADE5 , CNT.COD_UNIDADE6 , CNT.DT_ULT_ALT_UNID , CNT.COD_CUSTO_CONTAB1, CNT.COD_CUSTO_CONTAB2 , CNT.COD_CUSTO_CONTAB3 , CNT.COD_CUSTO_CONTAB4 ,CNT.COD_CUSTO_CONTAB5 , CNT.COD_CUSTO_CONTAB6 , CNT.DT_ULT_ALT_CONT , CNT.COD_CUSTO_GERENC1 , CNT.COD_CUSTO_GERENC2 , CNT.COD_CUSTO_GERENC3 , CNT.COD_CUSTO_GERENC4 , CNT.COD_CUSTO_GERENC5 , CNT.COD_CUSTO_GERENC6 , CNT.DT_ULT_ALT_GER ),LISTA(C2.PENULT_MOV_COD_MOVIMENTACAO,C2.COD_LOTACAO_ATUAL1,C2.COD_LOTACAO_ATUAL2,C2.COD_LOTACAO_ATUAL3,C2.COD_LOTACAO_ATUAL4,C2.COD_LOTACAO_ATUAL5,C2.COD_LOTACAO_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_UNIDADE_ATUAL1,C2.COD_UNIDADE_ATUAL2,C2.COD_UNIDADE_ATUAL3,C2.COD_UNIDADE_ATUAL4,C2.COD_UNIDADE_ATUAL5,C2.COD_UNIDADE_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CCONTAB_ATUAL1,C2.COD_CCONTAB_ATUAL2, C2.COD_CCONTAB_ATUAL3, C2.COD_CCONTAB_ATUAL4, C2.COD_CCONTAB_ATUAL5,C2.COD_CCONTAB_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CGERENC_ATUAL1,C2.COD_CGERENC_ATUAL2, C2.COD_CGERENC_ATUAL3, C2.COD_CGERENC_ATUAL4, C2.COD_CGERENC_ATUAL5, C2.COD_CGERENC_ATUAL6, C2.PENULT_MOV_DT_ALT_UNID_CUSTO)) ;   

                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                        C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP; 
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                );
            END IF;
        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        COMMIT;
        --4.2 TAREFA
        dbms_output.put_line('4.2UC-EXCLUI  MovimentaCAo que foi criada');
        DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        --4.3 TAREFA
        dbms_output.put_line('4.3UC-APAGA DATA FIM registro anterior HIST. MOVIMENTACAO');
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO = C2.PENULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        END IF;

    ELSE --IF NOVO EM 6/12/21 

        IF TRUNC(C2.ULT_MOV_DT_INICIO) = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1  VOLTEI NO IF NOVO EM 6/12/21         
        THEN --parte diferente da tarefas entre o UPDATE e DELETE
        --4.1 TAREFA
        dbms_output.put_line('4.1UC-VOLTA dados ultimo contrato: aba LOCALIZAcaO');

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
            IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
             (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            )THEN   
                PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                FOR CNT IN
                (
                  SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                  FROM rhpess_contrato C 
                  where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                  ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                )
                LOOP                                      
                        PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('COD_MOVIMENTACAO','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_LOC','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_UNID','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_CONT','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6','DT_ULT_ALT_GER'),LISTA(CNT.cod_movimentacao,CNT.COD_LOCAL1, CNT.COD_LOCAL2, CNT.COD_LOCAL3, CNT.COD_LOCAL4, CNT.COD_LOCAL5, CNT.COD_LOCAL6, CNT.DT_ULT_ALT_LOC,CNT.COD_UNIDADE1, CNT.COD_UNIDADE2, CNT.COD_UNIDADE3, CNT.COD_UNIDADE4 , CNT.COD_UNIDADE5 , CNT.COD_UNIDADE6 , CNT.DT_ULT_ALT_UNID , CNT.COD_CUSTO_CONTAB1, CNT.COD_CUSTO_CONTAB2 , CNT.COD_CUSTO_CONTAB3 , CNT.COD_CUSTO_CONTAB4 ,CNT.COD_CUSTO_CONTAB5 , CNT.COD_CUSTO_CONTAB6 , CNT.DT_ULT_ALT_CONT , CNT.COD_CUSTO_GERENC1 , CNT.COD_CUSTO_GERENC2 , CNT.COD_CUSTO_GERENC3 , CNT.COD_CUSTO_GERENC4 , CNT.COD_CUSTO_GERENC5 , CNT.COD_CUSTO_GERENC6 , CNT.DT_ULT_ALT_GER ),LISTA(C2.PENULT_MOV_COD_MOVIMENTACAO,C2.COD_LOTACAO_ATUAL1,C2.COD_LOTACAO_ATUAL2,C2.COD_LOTACAO_ATUAL3,C2.COD_LOTACAO_ATUAL4,C2.COD_LOTACAO_ATUAL5,C2.COD_LOTACAO_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_UNIDADE_ATUAL1,C2.COD_UNIDADE_ATUAL2,C2.COD_UNIDADE_ATUAL3,C2.COD_UNIDADE_ATUAL4,C2.COD_UNIDADE_ATUAL5,C2.COD_UNIDADE_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CCONTAB_ATUAL1,C2.COD_CCONTAB_ATUAL2, C2.COD_CCONTAB_ATUAL3, C2.COD_CCONTAB_ATUAL4, C2.COD_CCONTAB_ATUAL5,C2.COD_CCONTAB_ATUAL6,C2.PENULT_MOV_DT_ALT_UNID_CUSTO,C2.COD_CGERENC_ATUAL1,C2.COD_CGERENC_ATUAL2, C2.COD_CGERENC_ATUAL3, C2.COD_CGERENC_ATUAL4, C2.COD_CGERENC_ATUAL5, C2.COD_CGERENC_ATUAL6, C2.PENULT_MOV_DT_ALT_UNID_CUSTO)) ;   

                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                        C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                        C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

                END LOOP; 
            ELSE
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
                C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
                C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                ); 
            END IF;
        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
        COMMIT;
        --4.2 TAREFA
        dbms_output.put_line('4.2UC-EXCLUI  MovimentaCAo que foi criada');
        DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO /*LETICIA POR QUE NESSE CASO O DELETE NAO FOI FEITO COM O -1 ?*/
        ; COMMIT;
        --4.3 TAREFA
        dbms_output.put_line('4.3UC-APAGA DATA FIM registro anterior HIST. MOVIMENTACAO');
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO = C2.PENULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        END IF;
    END IF;--IF NOVO EM 6/12/21 
END IF;


--FIM --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?


--4 TAREFA
--PARA LICENCAS QUE GERAM MOVIMENTACOES e FALECIMENTOS
--INICIO --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
--AJUSTES FEITOS EM 13/5/20 KELLYSSON pois não estava excluindo registro de movimentação
IF TRUNC(C2.ULT_MOV_DT_INICIO) = TRUNC(C2.DATA_INIC_SITUACAO) 
AND C2.OLD_COD_MOVIMENTACAO IS NOT NULL
AND C2.PENULT_MOV_DT_FIM_TEMP IS NOT NULL
AND (C2.OLD_SF_CONTROLE_FOLHA IN ('L','M') OR C2.OLD_CAUSA_RESC_codigo_esocial = '10') --NOVO EM 31-10-19--novo em 5/11/19 Kellysson
--AND (C2.NEW_COD_SIT_FUNCIONAL <> C2.OLD_COD_SIT_FUNCIONAL OR (C2.NEW_DATA_FIM_SITUACAO <> C2.OLD_DATA_FIM_SITUACAO))
THEN --parte diferente da tarefas entre o UPDATE e DELETE
--4.1 TAREFA
dbms_output.put_line('4.1UD-VOLTA dados ultimo contrato: aba LOCALIZAcaO');
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.cod_movimentacao =  C2.PENULT_MOV_COD_MOVIMENTACAO,
C.COD_LOCAL1 = C2.COD_LOTACAO_ATUAL1, C.COD_LOCAL2 = C2.COD_LOTACAO_ATUAL2, C.COD_LOCAL3 = C2.COD_LOTACAO_ATUAL3, C.COD_LOCAL4 = C2.COD_LOTACAO_ATUAL4, C.COD_LOCAL5 = C2.COD_LOTACAO_ATUAL5, C.COD_LOCAL6 = C2.COD_LOTACAO_ATUAL6, C.DT_ULT_ALT_LOC = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
C.COD_UNIDADE1 = C2.COD_UNIDADE_ATUAL1, C.COD_UNIDADE2 = C2.COD_UNIDADE_ATUAL2, C.COD_UNIDADE3 = C2.COD_UNIDADE_ATUAL3, C.COD_UNIDADE4 = C2.COD_UNIDADE_ATUAL4, C.COD_UNIDADE5 = C2.COD_UNIDADE_ATUAL5, C.COD_UNIDADE6 = C2.COD_UNIDADE_ATUAL6, C.DT_ULT_ALT_UNID = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
C.COD_CUSTO_CONTAB1 = C2.COD_CCONTAB_ATUAL1, C.COD_CUSTO_CONTAB2 = C2.COD_CCONTAB_ATUAL2, C.COD_CUSTO_CONTAB3 = C2.COD_CCONTAB_ATUAL3, C.COD_CUSTO_CONTAB4 = C2.COD_CCONTAB_ATUAL4, C.COD_CUSTO_CONTAB5 = C2.COD_CCONTAB_ATUAL5, C.COD_CUSTO_CONTAB6 = C2.COD_CCONTAB_ATUAL6, C.DT_ULT_ALT_CONT = C2.PENULT_MOV_DT_ALT_UNID_CUSTO,
C.COD_CUSTO_GERENC1 = C2.COD_CGERENC_ATUAL1, C.COD_CUSTO_GERENC2 = C2.COD_CGERENC_ATUAL2, C.COD_CUSTO_GERENC3 = C2.COD_CGERENC_ATUAL3, C.COD_CUSTO_GERENC4 = C2.COD_CGERENC_ATUAL4, C.COD_CUSTO_GERENC5 = C2.COD_CGERENC_ATUAL5, C.COD_CUSTO_GERENC6 = C2.COD_CGERENC_ATUAL6, C.DT_ULT_ALT_GER = C2.PENULT_MOV_DT_ALT_UNID_CUSTO
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY')--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
); COMMIT;
--4.2 TAREFA
dbms_output.put_line('4.2UD-EXCLUI  MovimentaCAo que foi criada');
DELETE RHCGED_TRANSFERENC WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
; COMMIT;
--4.3 TAREFA
dbms_output.put_line('4.3UD-APAGA DATA FIM registro anterior HIST. MOVIMENTACAO');
UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = NULL
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO = C2.PENULT_MOV_COD_MOVIMENTACAO
; COMMIT;
END IF;
--FIM --TINHA valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?

--14 TAREFA
--INICIO --SituACAo 5800-FALECIMENTO?

/*LETICIA AJUSTOU AQUI EM 26/05/2023*/
IF C2.OLD_CAUSA_RESC_codigo_esocial= '10'  THEN
dbms_output.put_line('14D-APAGA DATA DE FALECIMENTO NA PESSOA');
    PR_INSERE_PESSOA_H(C2.CODIGO_EMPRESA,C2.CODIGO_PESSOA,C2.DATA_INIC_SITUACAO );
    UPDATE RHPESS_PESSOA SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DATA_FALECIMENTO = NULL WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CODIGO = C2.CODIGO_PESSOA;
    UPDATE RHPESS_PESSOA_H SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DATA_FALECIMENTO = NULL WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND CODIGO = C2.CODIGO_PESSOA AND ANO_MES_REFERENCIA >= trunc(C2.DATA_INIC_SITUACAO);
    COMMIT;
END IF;

--FIM --SituACAo 5800-FALECIMENTO?


--FIM----------------------------------------------------------------------------------------------*******DADOS ANTES DE ALTERAR*********----------------------------------------------------------------------------------------------

END IF;--FIM IF INSERT, UPDATE, DELETE DO ULTIMO REGISTRO


--INICIO-------------------------------------------------------------------------------------------*******DADOS DEPOIS DE ALTERAR*********--------------------------------------------------------------------------------------------------
--5 TAREFA
--INICIO --Cargo Efetivo com Cargo Comissionado ou FunCAo?
--cargo comissionado
IF C2.NEW_SF_CONTROLE_FOLHA IN ('D','S') AND (C2.COD_CARGO_COMISS IS NOT NULL AND C2.COD_CARGO_COMISS <> '000000000000000') AND (C2.cod_cargo_efetivo IS NOT NULL AND C2.cod_cargo_efetivo <> '000000000000000')
AND TRUNC(C2.ULT_ALT_CARG_DT_INI) < TRUNC(C2.DATA_INIC_SITUACAO)
AND (TRUNC(C2.ULT_ALT_CARG_DT_INI) <> TRUNC(C2.DATA_INIC_SITUACAO)AND C2.ULT_ALT_CARG_motivo_alteracao <> '0005')
THEN
--5.1 TAREFA
dbms_output.put_line('5.1A-FINALIZA registro anterior ALT CARGO' );
UPDATE RHPLCS_ALT_CARGO SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-1
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND TRUNC(DT_ALTER_CARGO) = TRUNC(C2.ULT_ALT_CARG_DT_INI) AND OCORRENCIA = C2.ULT_ALT_CARG_OCORRENCIA AND motivo_alteracao = C2.ULT_ALT_CARG_motivo_alteracao
; COMMIT;
--5.2 TAREFA
dbms_output.put_line('5.2A-CRIA ALT. CARGO limpando os campos COMISSIONADO ' );
INSERT INTO RHPLCS_ALT_CARGO
(CODIGO_EMPRESA, TIPO_CONTRATO, DT_ALTER_CARGO, MOTIVO_ALTERACAO, COD_CARGO_EFET_AT, NIV_CARGO_EFET_AT, COD_CARGO_COMIS_AT, NIV_CARGO_COMIS_AT, COD_CARGO_AMPAR_AT, NIV_CARGO_AMPAR_AT, OBSERVACAO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DT_FIM_TEMP, DOCUMENTO_PUBLIC, OCORRENCIA, SALARIO_PAGTO, CODIGO_CONTRATO)
VALUES (C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.DATA_INIC_SITUACAO, '0005', C2.COD_CARGO_EFETIVO, C2.NIVEL_CARGO_EFETIV, '000000000000000', NULL, C2.COD_CARGO_AMPAR, C2.NIVEL_CARGO_AMPAR, 'GERADA PELA ALTERACAO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, SYSDATE, NULL, 'DOM '||C2.DATA_INIC_SITUACAO, (SELECT CASE WHEN max1 IS NULL THEN 1 ELSE max1 END ocorrencia FROM (SELECT MAX(a.ocorrencia)+1 max1 FROM rhplcs_alt_cargo a WHERE a.codigo_empresa = C2.CODIGO_EMPRESA AND a.tipo_contrato = C2.TIPO_CONTRATO AND TRUNC(a.dt_alter_cargo) >= TRUNC(C2.DATA_INIC_SITUACAO) AND a.codigo_contrato = C2.CODIGO)), 'E', C2.CODIGO)
;COMMIT;
--11 TAREFA --Cargo Efetivo com Cargo Comissionado ou FunCAo? E EXISTE registro nesta mesma data?
dbms_output.put_line('11.1-GRAVA ultimo contrato: aba CARGOS --PARTE CARGO COMISSIONADO ZERADO' );

/*INCLUIDO POR LETICIA EM 13/04/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
    IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
     (
    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
    OR
    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
    ) THEN   
        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

        FOR CNT IN
        (
          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.COD_CARGO_COMISS, C.NIVEL_CARGO_COMISS, C.DT_ULT_CARGO_COM, C.salario_pagto
          FROM rhpess_contrato C 
          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
        )
        LOOP                                      
                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('COD_CARGO_COMISS', 'NIVEL_CARGO_COMISS', 'DT_ULT_CARGO_COM', 'salario_pagto'),LISTA(CNT.COD_CARGO_COMISS, CNT.NIVEL_CARGO_COMISS, CNT.DT_ULT_CARGO_COM, CNT.salario_pagto),LISTA('000000000000000',NULL,NULL,'E')) ;   

                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_CARGO_COMISS = '000000000000000', C.NIVEL_CARGO_COMISS = NULL, C.DT_ULT_CARGO_COM = NULL, C.salario_pagto = 'E'--, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

        END LOOP;
    ELSE
        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_CARGO_COMISS = '000000000000000', C.NIVEL_CARGO_COMISS = NULL, C.DT_ULT_CARGO_COM = NULL, C.salario_pagto = 'E'--, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS

    END IF;
/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

COMMIT;


END IF;

--funCAo
IF C2.NEW_SF_CONTROLE_FOLHA IN ('D','S') AND (C2.CODIGO_FUNCAO IS NOT NULL AND C2.CODIGO_FUNCAO <> '000000000000000') AND (C2.cod_cargo_efetivo IS NOT NULL AND C2.cod_cargo_efetivo <> '000000000000000')
AND TRUNC(C2.ULT_ALT_FUNCAO_DT_INI) < TRUNC(C2.DATA_INIC_SITUACAO)
THEN
--5.1 TAREFA
dbms_output.put_line('5.1B-FINALIZA registro anterior ALT FUNCAO' );
UPDATE RHPLCS_ALT_FUNCAO SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-1
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO
AND TRUNC(DATA_INICIO_FUNCAO) = TRUNC(C2.ULT_ALT_FUNCAO_DT_INI) AND codigo_hist_funcao = C2.ULT_ALT_FUNCAO_MOTIVO_ENTRADA
; COMMIT;
--5.2 TAREFA
/*dbms_output.put_line('5.2B-CRIA ALT. FUNCAO limpando os campos FUNCAO ' );
INSERT INTO RHPLCS_ALT_FUNCAO (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA_INICIO_FUNCAO, CODIGO_FUNCAO, CODIGO_HIST_FUNCAO, DT_FIM_TEMP, DOCUMENTO_PUBLIC, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, C_LIVRE_SELEC01,C_LIVRE_SELEC02,C_LIVRE_SELEC03,C_LIVRE_VALOR01,C_LIVRE_VALOR02,C_LIVRE_VALOR03,C_LIVRE_OPCAO01,C_LIVRE_OPCAO02,C_LIVRE_OPCAO03)
VALUES (C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, C2.DATA_INIC_SITUACAO, NULL, '0003', NULL, 'DOM '||C2.DATA_INIC_SITUACAO, 'GERADA PELA ALTERAÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¡ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢O DE SITUAÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¡ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢O FUNCIONAL', vLOGIN_USUARIO, SYSDATE,0,0,0,0,0,0,'N','N','N');
COMMIT;
*/
--11 TAREFA --Cargo Efetivo com Cargo Comissionado ou FunCAO E EXISTE registro nesta mesma data?
dbms_output.put_line('11.2-GRAVA ultimo contrato: aba FUNCOES ZERADO--' );

/*INCLUIDO POR LETICIA EM 13/04/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
    IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
     (
    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
    OR
    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
    ) THEN   
        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

        FOR CNT IN
        (
          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.CODIGO_FUNCAO, C.DT_ULT_FUNCAO
          FROM rhpess_contrato C 
          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
        )
        LOOP                                      
                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,lista('CODIGO_FUNCAO', 'DT_ULT_FUNCAO'),LISTA(CNT.CODIGO_FUNCAO, CNT.DT_ULT_FUNCAO),LISTA(NULL,NULL)) ;   

                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.CODIGO_FUNCAO = NULL, C.DT_ULT_FUNCAO = NULL--, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');

        END LOOP;
    ELSE
        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.CODIGO_FUNCAO = NULL, C.DT_ULT_FUNCAO = NULL--, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS

    END IF;
/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

COMMIT;
END IF;
--FIM --Cargo Efetivo com Cargo Comissionado ou FuNCAo?

--6 TAREFA
----------------------------------------------INICIO--MOVIMENTACAO PARA DESLIGAMENTO E APOSENTADO
--INICIO --EXISTE valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?

select to_date(to_char(ULT_MOV.DT_ALT_UNID_CUSTO,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_MOV_DT_INICIO INTO vDATA_INICIO_ULTIMA_MOVIMENTACAO
from RHCGED_TRANSFERENC ULT_MOV 
where ULT_MOV.DT_ALT_UNID_CUSTO = (SELECT MAX(AUX.DT_ALT_UNID_CUSTO) FROM RHCGED_TRANSFERENC AUX WHERE AUX.CODIGO_EMPRESA = ULT_MOV.codigo_empresa and AUX.tipo_contrato = ULT_MOV.tipo_contrato and AUX.codigo = ULT_MOV.codigo)
AND ULT_MOV.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_MOV.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_MOV.CODIGO = vCODIGO and rownum = 1;


IF (C2.NEW_COD_MOVIMENTACAO IS NOT NULL and C2.NEW_COD_MOVIMENTACAO <> '0000') AND  TRUNC(vDATA_INICIO_ULTIMA_MOVIMENTACAO) < TRUNC(C2.DATA_INIC_SITUACAO) AND C2.ULT_MOV_DT_FIM_TEMP IS NULL
AND (TRUNC(vDATA_INICIO_ULTIMA_MOVIMENTACAO) <> TRUNC(C2.DATA_INIC_SITUACAO) --AND C2.ULT_MOV_COD_MOVIMENTACAO <> C2.NEW_COD_MOVIMENTACAO --comentado em 7/11/19 Kellysson
)AND (C2.NEW_SF_CONTROLE_FOLHA IN ('D','S') and (C2.NEW_CAUSA_RESC_codigo_esocial IS NULL OR C2.NEW_CAUSA_RESC_codigo_esocial <> '10'))--NOVO EM 31-10-19
THEN

    IF TRUNC(C2.DATA_INIC_SITUACAO) >= TO_DATE('01/12/2021','DD/MM/YYYY') THEN --IF NOVO EM 6/12/21 
    --6.1TAREFA
    dbms_output.put_line('6.1A-FINALIZA registro anterior  HIST. MOVIMENTACAO' );
    UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21  -2
    WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
    AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
    ; COMMIT;
    IF (C2.OLD_SF_CONTROLE_FOLHA IN ('S','D','L','M') AND C2.TIPO_DML = 'U' ) THEN
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-1
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO =  C2.PENULT_MOV_COD_MOVIMENTACAO
        ;COMMIT;
    END IF;
    --6.2 TAREFA
    dbms_output.put_line('6.2B-CRIA MovimentaCAO se nAO existir' );
    --6.3 TAREFA
    --INICIO --Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        IF C2.M_AGRUPADOR IS NOT NULL THEN
        dbms_output.put_line('6.3.1A-ALTERA os 3 agrupadores' );
        INSERT INTO RHCGED_TRANSFERENC (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DT_ALT_UNID_CUSTO, COD_MOVIMENTACAO, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DATA_PUBLIC,--alterado 23/2/21--C_LIVRE_DATA01,
        COD_LOTACAO_ATUAL1, COD_LOTACAO_ATUAL2, COD_LOTACAO_ATUAL3, COD_LOTACAO_ATUAL4, COD_LOTACAO_ATUAL5, COD_LOTACAO_ATUAL6,
        COD_UNIDADE_ATUAL1, COD_UNIDADE_ATUAL2, COD_UNIDADE_ATUAL3, COD_UNIDADE_ATUAL4, COD_UNIDADE_ATUAL5, COD_UNIDADE_ATUAL6,
        COD_CCONTAB_ATUAL1, COD_CCONTAB_ATUAL2, COD_CCONTAB_ATUAL3, COD_CCONTAB_ATUAL4, COD_CCONTAB_ATUAL5, COD_CCONTAB_ATUAL6,
        COD_CGERENC_ATUAL1, COD_CGERENC_ATUAL2, COD_CGERENC_ATUAL3, COD_CGERENC_ATUAL4, COD_CGERENC_ATUAL5, COD_CGERENC_ATUAL6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,DT_PREV_RETORNO--alterado 23/2/21--, C_LIVRE_DATA02
        )
        VALUES(C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1, 
        ,C2.NEW_COD_MOVIMENTACAO,'GERADA PELA ALTERACO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, sysdate, C2.ULT_ASF_DATA_DOM,
        --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
        C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
        LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
        C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,
        LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,TRUNC(C2.DATA_FIM_ANALISE)--NOVO EM 8/10/20 E DEMAIS INSERTS NESSA TABELA
        );COMMIT;
        --12 tarefa--Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        dbms_output.put_line('12.1A-ALTERA os 3 agrupadores' );

        /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
             IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND  (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            ) THEN   
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                            Lista('COD_MOVIMENTACAO','DT_ULT_ALT_LOC','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_UNID','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_CONT','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_GER','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6'),
                            LISTA(CNT.COD_MOVIMENTACAO,CNT.DT_ULT_ALT_LOC,CNT.COD_LOCAL1,CNT.COD_LOCAL2,CNT.COD_LOCAL3,CNT.COD_LOCAL4,CNT.COD_LOCAL5,CNT.COD_LOCAL6,CNT.DT_ULT_ALT_UNID,CNT.COD_UNIDADE1,CNT.COD_UNIDADE2,CNT.COD_UNIDADE3,CNT.COD_UNIDADE4,CNT.COD_UNIDADE5,CNT.COD_UNIDADE6,CNT.DT_ULT_ALT_CONT,CNT.COD_CUSTO_CONTAB1,CNT.COD_CUSTO_CONTAB2,CNT.COD_CUSTO_CONTAB3,CNT.COD_CUSTO_CONTAB4,CNT.COD_CUSTO_CONTAB5,CNT.COD_CUSTO_CONTAB6,CNT.DT_ULT_ALT_GER,CNT.COD_CUSTO_GERENC1,CNT.COD_CUSTO_GERENC2,CNT.COD_CUSTO_GERENC3,CNT.COD_CUSTO_GERENC4,CNT.COD_CUSTO_GERENC5,CNT.COD_CUSTO_GERENC6),
                            LISTA(C2.NEW_COD_MOVIMENTACAO, TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6, TRUNC(C2.DATA_INIC_SITUACAO), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0), TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6, TRUNC(C2.DATA_INIC_SITUACAO), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0))) ;  

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                            C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1 
                            ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
                            C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                            ,C.COD_UNIDADE1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_UNIDADE2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_UNIDADE3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                            C.COD_UNIDADE4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_UNIDADE5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_UNIDADE6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                            C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1
                            , C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3,
                            C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                            C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                            ,C.COD_CUSTO_GERENC1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_CUSTO_GERENC2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_CUSTO_GERENC3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                            C.COD_CUSTO_GERENC4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_CUSTO_GERENC5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_CUSTO_GERENC6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                            COMMIT;
                    END LOOP; 
                ELSE
                    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                    C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1 
                    --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_LOCAL2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_LOCAL3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                    --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_LOCAL5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_LOCAL6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                    ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
                    C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                    ,C.COD_UNIDADE1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_UNIDADE2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_UNIDADE3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                    C.COD_UNIDADE4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_UNIDADE5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_UNIDADE6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                    C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1
                    , C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3,
                    C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                    C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                    ,C.COD_CUSTO_GERENC1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_CUSTO_GERENC2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_CUSTO_GERENC3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                    C.COD_CUSTO_GERENC4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_CUSTO_GERENC5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_CUSTO_GERENC6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
                    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                    AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                    COMMIT;
                END IF;
        /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        ELSE
        dbms_output.put_line('6.3.2A-GRAVA com os 4 agrupadores iguais' );
        INSERT INTO RHCGED_TRANSFERENC (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DT_ALT_UNID_CUSTO, COD_MOVIMENTACAO, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DATA_PUBLIC,--alterado 23/2/21--C_LIVRE_DATA01,
        COD_LOTACAO_ATUAL1, COD_LOTACAO_ATUAL2, COD_LOTACAO_ATUAL3, COD_LOTACAO_ATUAL4, COD_LOTACAO_ATUAL5, COD_LOTACAO_ATUAL6,
        COD_UNIDADE_ATUAL1, COD_UNIDADE_ATUAL2, COD_UNIDADE_ATUAL3, COD_UNIDADE_ATUAL4, COD_UNIDADE_ATUAL5, COD_UNIDADE_ATUAL6,
        COD_CCONTAB_ATUAL1, COD_CCONTAB_ATUAL2, COD_CCONTAB_ATUAL3, COD_CCONTAB_ATUAL4, COD_CCONTAB_ATUAL5, COD_CCONTAB_ATUAL6,
        COD_CGERENC_ATUAL1, COD_CGERENC_ATUAL2, COD_CGERENC_ATUAL3, COD_CGERENC_ATUAL4, COD_CGERENC_ATUAL5, COD_CGERENC_ATUAL6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,DT_PREV_RETORNO--alterado 23/2/21--,C_LIVRE_DATA02
        )
        VALUES(C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1
        , C2.NEW_COD_MOVIMENTACAO,'GERADA PELA ALTERACAO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, sysdate, C2.ULT_ASF_DATA_DOM,
        C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6,
        C2.COD_UNIDADE1, C2.COD_UNIDADE2, C2.COD_UNIDADE3, C2.COD_UNIDADE4, C2.COD_UNIDADE5, C2.COD_UNIDADE6,
        C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,
        C2.COD_CUSTO_GERENC1, C2.COD_CUSTO_GERENC2, C2.COD_CUSTO_GERENC3, C2.COD_CUSTO_GERENC4, C2.COD_CUSTO_GERENC5, C2.COD_CUSTO_GERENC6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,TRUNC(C2.DATA_FIM_ANALISE)
        );COMMIT;
        --12 tarefa--Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        dbms_output.put_line('12.2A-GRAVA com os 4 agrupadores iguais' );

        /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
             IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
              (
                ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                OR
                ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                ) THEN   
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                            Lista('COD_MOVIMENTACAO', 'DT_ULT_ALT_LOC', 'COD_LOCAL1', 'COD_LOCAL2', 'COD_LOCAL3', 'COD_LOCAL4', 'COD_LOCAL5', 'COD_LOCAL6', 'DT_ULT_ALT_UNID', 'COD_UNIDADE1', 'COD_UNIDADE2', 'COD_UNIDADE3', 'COD_UNIDADE4', 'COD_UNIDADE5', 'COD_UNIDADE6', 'DT_ULT_ALT_CONT', 'COD_CUSTO_CONTAB1', 'COD_CUSTO_CONTAB2', 'COD_CUSTO_CONTAB3', 'COD_CUSTO_CONTAB4', 'COD_CUSTO_CONTAB5', 'COD_CUSTO_CONTAB6', 'DT_ULT_ALT_GER', 'COD_CUSTO_GERENC1', 'COD_CUSTO_GERENC2', 'COD_CUSTO_GERENC3', 'COD_CUSTO_GERENC4', 'COD_CUSTO_GERENC5', 'COD_CUSTO_GERENC6'),
                            LISTA(CNT.COD_MOVIMENTACAO, CNT.DT_ULT_ALT_LOC, CNT.COD_LOCAL1, CNT.COD_LOCAL2, CNT.COD_LOCAL3, CNT.COD_LOCAL4, CNT.COD_LOCAL5, CNT.COD_LOCAL6, CNT.DT_ULT_ALT_UNID, CNT.COD_UNIDADE1, CNT.COD_UNIDADE2, CNT.COD_UNIDADE3, CNT.COD_UNIDADE4, CNT.COD_UNIDADE5, CNT.COD_UNIDADE6, CNT.DT_ULT_ALT_CONT, CNT.COD_CUSTO_CONTAB1, CNT.COD_CUSTO_CONTAB2, CNT.COD_CUSTO_CONTAB3, CNT.COD_CUSTO_CONTAB4, CNT.COD_CUSTO_CONTAB5, CNT.COD_CUSTO_CONTAB6, CNT.DT_ULT_ALT_GER, CNT.COD_CUSTO_GERENC1, CNT.COD_CUSTO_GERENC2, CNT.COD_CUSTO_GERENC3, CNT.COD_CUSTO_GERENC4, CNT.COD_CUSTO_GERENC5, CNT.COD_CUSTO_GERENC6),
                            LISTA(C2.NEW_COD_MOVIMENTACAO, TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_LOCAL1,  C2.COD_LOCAL2,  C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5 , C2.COD_LOCAL6, TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_UNIDADE1, C2.COD_UNIDADE2, C2.COD_UNIDADE3, C2.COD_UNIDADE4, C2.COD_UNIDADE5, C2.COD_UNIDADE6, TRUNC(C2.DATA_INIC_SITUACAO) , C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6, TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_CUSTO_GERENC1, C2.COD_CUSTO_GERENC2, C2.COD_CUSTO_GERENC3, C2.COD_CUSTO_GERENC4, C2.COD_CUSTO_GERENC5, C2.COD_CUSTO_GERENC6)) ; 

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                            C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1 
                            ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,
                            C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  - 1 
                            ,C.COD_UNIDADE1 = C2.COD_UNIDADE1, C.COD_UNIDADE2 = C2.COD_UNIDADE2, C.COD_UNIDADE3 = C2.COD_UNIDADE3, C.COD_UNIDADE4 = C2.COD_UNIDADE4, C.COD_UNIDADE5 =  C2.COD_UNIDADE5, C.COD_UNIDADE6 =  C2.COD_UNIDADE6,
                            C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO)-- COMENTADO EM 29/11/21 -1
                            ,C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3, C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                            C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                            ,C.COD_CUSTO_GERENC1 = C2.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2 = C2.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3 = C2.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4 = C2.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5 =  C2.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6 = C2.COD_CUSTO_GERENC6
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                            COMMIT;
                    END LOOP; 
                ELSE
                    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                    C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1 
                    ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,
                    C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  - 1 
                    ,C.COD_UNIDADE1 = C2.COD_UNIDADE1, C.COD_UNIDADE2 = C2.COD_UNIDADE2, C.COD_UNIDADE3 = C2.COD_UNIDADE3, C.COD_UNIDADE4 = C2.COD_UNIDADE4, C.COD_UNIDADE5 =  C2.COD_UNIDADE5, C.COD_UNIDADE6 =  C2.COD_UNIDADE6,
                    C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO)-- COMENTADO EM 29/11/21 -1
                    ,C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3, C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                    C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                    ,C.COD_CUSTO_GERENC1 = C2.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2 = C2.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3 = C2.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4 = C2.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5 =  C2.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6 = C2.COD_CUSTO_GERENC6
                    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                    AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                    COMMIT;
                END IF;
        /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/


        END IF;
    --FIM --Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
    ELSE --IF NOVO EM 6/12/21 
        --6.1TAREFA
        dbms_output.put_line('6.1A-FINALIZA registro anterior  HIST. MOVIMENTACAO' );
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-2 ---1 -- COMENTADO EM 29/11/21  -2 VOLTEI NO IF NOVO EM 6/12/21 -2
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO = C2.ULT_MOV_COD_MOVIMENTACAO
        ; COMMIT;
        IF (C2.OLD_SF_CONTROLE_FOLHA IN ('S','D','L','M') AND C2.TIPO_DML = 'U') THEN
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-2
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO =  C2.PENULT_MOV_COD_MOVIMENTACAO
        ;COMMIT;
    END IF;
        --6.2 TAREFA
        dbms_output.put_line('6.2B-CRIA MovimentaCAO se nAO existir' );
        --6.3 TAREFA
        --INICIO --Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        IF C2.M_AGRUPADOR IS NOT NULL THEN
        dbms_output.put_line('6.3.1A-ALTERA os 3 agrupadores' );
        INSERT INTO RHCGED_TRANSFERENC (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DT_ALT_UNID_CUSTO, COD_MOVIMENTACAO, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DATA_PUBLIC,--alterado 23/2/21--C_LIVRE_DATA01,
        COD_LOTACAO_ATUAL1, COD_LOTACAO_ATUAL2, COD_LOTACAO_ATUAL3, COD_LOTACAO_ATUAL4, COD_LOTACAO_ATUAL5, COD_LOTACAO_ATUAL6,
        COD_UNIDADE_ATUAL1, COD_UNIDADE_ATUAL2, COD_UNIDADE_ATUAL3, COD_UNIDADE_ATUAL4, COD_UNIDADE_ATUAL5, COD_UNIDADE_ATUAL6,
        COD_CCONTAB_ATUAL1, COD_CCONTAB_ATUAL2, COD_CCONTAB_ATUAL3, COD_CCONTAB_ATUAL4, COD_CCONTAB_ATUAL5, COD_CCONTAB_ATUAL6,
        COD_CGERENC_ATUAL1, COD_CGERENC_ATUAL2, COD_CGERENC_ATUAL3, COD_CGERENC_ATUAL4, COD_CGERENC_ATUAL5, COD_CGERENC_ATUAL6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,DT_PREV_RETORNO--alterado 23/2/21--, C_LIVRE_DATA02
        )
        VALUES(C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1, 
        ,C2.NEW_COD_MOVIMENTACAO,'GERADA PELA ALTERACO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, sysdate, C2.ULT_ASF_DATA_DOM,
        --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
        C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
        LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
        C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,
        LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,TRUNC(C2.DATA_FIM_ANALISE)--NOVO EM 8/10/20 E DEMAIS INSERTS NESSA TABELA
        );COMMIT;
        --12 tarefa--Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        dbms_output.put_line('12.1A-ALTERA os 3 agrupadores' );

            /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
                 IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND  (
                    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                    OR
                    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                    ) THEN   
                        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                        FOR CNT IN
                        (
                          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                          FROM rhpess_contrato C 
                          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                        )
                        LOOP                                      
                                 PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                                Lista('COD_MOVIMENTACAO','DT_ULT_ALT_LOC','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_UNID','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_CONT','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_GER','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6'),
                                LISTA(CNT.COD_MOVIMENTACAO,CNT.DT_ULT_ALT_LOC,CNT.COD_LOCAL1,CNT.COD_LOCAL2,CNT.COD_LOCAL3,CNT.COD_LOCAL4,CNT.COD_LOCAL5,CNT.COD_LOCAL6,CNT.DT_ULT_ALT_UNID,CNT.COD_UNIDADE1,CNT.COD_UNIDADE2,CNT.COD_UNIDADE3,CNT.COD_UNIDADE4,CNT.COD_UNIDADE5,CNT.COD_UNIDADE6,CNT.DT_ULT_ALT_CONT,CNT.COD_CUSTO_CONTAB1,CNT.COD_CUSTO_CONTAB2,CNT.COD_CUSTO_CONTAB3,CNT.COD_CUSTO_CONTAB4,CNT.COD_CUSTO_CONTAB5,CNT.COD_CUSTO_CONTAB6,CNT.DT_ULT_ALT_GER,CNT.COD_CUSTO_GERENC1,CNT.COD_CUSTO_GERENC2,CNT.COD_CUSTO_GERENC3,CNT.COD_CUSTO_GERENC4,CNT.COD_CUSTO_GERENC5,CNT.COD_CUSTO_GERENC6),
                                LISTA(C2.NEW_COD_MOVIMENTACAO,TRUNC(C2.DATA_INIC_SITUACAO)-1 ,C2.COD_LOCAL1, C2.COD_LOCAL2,C2.COD_LOCAL3,C2.COD_LOCAL4, C2.COD_LOCAL5 ,  C2.COD_LOCAL6,TRUNC(C2.DATA_INIC_SITUACAO)-1 ,LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0),  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0),  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0),  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),TRUNC(C2.DATA_INIC_SITUACAO)-1 , C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3,C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,TRUNC(C2.DATA_INIC_SITUACAO)-1,LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0),  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0),  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0),  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0))) ; 

                                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                                C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21  -1 VOLTEI NO IF NOVO EM 6/12/21 
                                --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_LOCAL2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_LOCAL3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                                --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_LOCAL5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_LOCAL6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                                ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
                                C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                                ,C.COD_UNIDADE1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_UNIDADE2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_UNIDADE3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                                C.COD_UNIDADE4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_UNIDADE5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_UNIDADE6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                                C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                                , C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3,
                                C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                                C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1  VOLTEI NO IF NOVO EM 6/12/21 
                                ,C.COD_CUSTO_GERENC1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_CUSTO_GERENC2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_CUSTO_GERENC3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                                C.COD_CUSTO_GERENC4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_CUSTO_GERENC5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_CUSTO_GERENC6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
                                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                                COMMIT;

                        END LOOP; 
                    ELSE
                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                        C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21  -1 VOLTEI NO IF NOVO EM 6/12/21 
                        --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_LOCAL2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_LOCAL3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                        --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_LOCAL5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_LOCAL6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                        ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
                        C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                        ,C.COD_UNIDADE1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_UNIDADE2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_UNIDADE3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                        C.COD_UNIDADE4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_UNIDADE5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_UNIDADE6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                        C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                        , C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3,
                        C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                        C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1  VOLTEI NO IF NOVO EM 6/12/21 
                        ,C.COD_CUSTO_GERENC1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_CUSTO_GERENC2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_CUSTO_GERENC3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                        C.COD_CUSTO_GERENC4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_CUSTO_GERENC5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_CUSTO_GERENC6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                        COMMIT;

                    END IF;
            /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        ELSE
        dbms_output.put_line('6.3.2A-GRAVA com os 4 agrupadores iguais' );
        INSERT INTO RHCGED_TRANSFERENC (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DT_ALT_UNID_CUSTO, COD_MOVIMENTACAO, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DATA_PUBLIC,--alterado 23/2/21--C_LIVRE_DATA01,
        COD_LOTACAO_ATUAL1, COD_LOTACAO_ATUAL2, COD_LOTACAO_ATUAL3, COD_LOTACAO_ATUAL4, COD_LOTACAO_ATUAL5, COD_LOTACAO_ATUAL6,
        COD_UNIDADE_ATUAL1, COD_UNIDADE_ATUAL2, COD_UNIDADE_ATUAL3, COD_UNIDADE_ATUAL4, COD_UNIDADE_ATUAL5, COD_UNIDADE_ATUAL6,
        COD_CCONTAB_ATUAL1, COD_CCONTAB_ATUAL2, COD_CCONTAB_ATUAL3, COD_CCONTAB_ATUAL4, COD_CCONTAB_ATUAL5, COD_CCONTAB_ATUAL6,
        COD_CGERENC_ATUAL1, COD_CGERENC_ATUAL2, COD_CGERENC_ATUAL3, COD_CGERENC_ATUAL4, COD_CGERENC_ATUAL5, COD_CGERENC_ATUAL6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,DT_PREV_RETORNO--alterado 23/2/21--,C_LIVRE_DATA02
        )
        VALUES(C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21  -1 VOLTEI NO IF NOVO EM 6/12/21 
        , C2.NEW_COD_MOVIMENTACAO,'GERADA PELA ALTERACAO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, sysdate, C2.ULT_ASF_DATA_DOM,
        C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6,
        C2.COD_UNIDADE1, C2.COD_UNIDADE2, C2.COD_UNIDADE3, C2.COD_UNIDADE4, C2.COD_UNIDADE5, C2.COD_UNIDADE6,
        C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,
        C2.COD_CUSTO_GERENC1, C2.COD_CUSTO_GERENC2, C2.COD_CUSTO_GERENC3, C2.COD_CUSTO_GERENC4, C2.COD_CUSTO_GERENC5, C2.COD_CUSTO_GERENC6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,TRUNC(C2.DATA_FIM_ANALISE)
        );COMMIT;
        --12 tarefa--Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        dbms_output.put_line('12.2A-GRAVA com os 4 agrupadores iguais' );

            /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
                 IF C2.NEW_SF_CONTROLE_FOLHA IN ('D' ) AND 
                  (
                    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                    OR
                    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                    ) THEN   
                        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                        FOR CNT IN
                        (
                          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                          FROM rhpess_contrato C 
                          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                        )
                        LOOP                                      
                                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                                Lista('COD_MOVIMENTACAO', 'DT_ULT_ALT_LOC', 'COD_LOCAL1', 'COD_LOCAL2', 'COD_LOCAL3', 'COD_LOCAL4', 'COD_LOCAL5', 'COD_LOCAL6', 'DT_ULT_ALT_UNID', 'COD_UNIDADE1', 'COD_UNIDADE2', 'COD_UNIDADE3', 'COD_UNIDADE4', 'COD_UNIDADE5', 'COD_UNIDADE6', 'DT_ULT_ALT_CONT', 'COD_CUSTO_CONTAB1', 'COD_CUSTO_CONTAB2', 'COD_CUSTO_CONTAB3', 'COD_CUSTO_CONTAB4', 'COD_CUSTO_CONTAB5', 'COD_CUSTO_CONTAB6', 'DT_ULT_ALT_GER', 'COD_CUSTO_GERENC1', 'COD_CUSTO_GERENC2', 'COD_CUSTO_GERENC3', 'COD_CUSTO_GERENC4', 'COD_CUSTO_GERENC5', 'COD_CUSTO_GERENC6'),
                                LISTA(CNT.COD_MOVIMENTACAO,CNT.DT_ULT_ALT_LOC,CNT.COD_LOCAL1,CNT.COD_LOCAL2,CNT.COD_LOCAL3,CNT.COD_LOCAL4,CNT.COD_LOCAL5,CNT.COD_LOCAL6,CNT.DT_ULT_ALT_UNID,CNT.COD_UNIDADE1,CNT.COD_UNIDADE2,CNT.COD_UNIDADE3,CNT.COD_UNIDADE4,CNT.COD_UNIDADE5,CNT.COD_UNIDADE6,CNT.DT_ULT_ALT_CONT,CNT.COD_CUSTO_CONTAB1,CNT.COD_CUSTO_CONTAB2,CNT.COD_CUSTO_CONTAB3,CNT.COD_CUSTO_CONTAB4,CNT.COD_CUSTO_CONTAB5,CNT.COD_CUSTO_CONTAB6,CNT.DT_ULT_ALT_GER,CNT.COD_CUSTO_GERENC1,CNT.COD_CUSTO_GERENC2,CNT.COD_CUSTO_GERENC3,CNT.COD_CUSTO_GERENC4,CNT.COD_CUSTO_GERENC5,CNT.COD_CUSTO_GERENC6),
                                LISTA(C2.NEW_COD_MOVIMENTACAO,TRUNC(C2.DATA_INIC_SITUACAO)-1,C2.COD_LOCAL1,  C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4,  C2.COD_LOCAL5 ,  C2.COD_LOCAL6,TRUNC(C2.DATA_INIC_SITUACAO)-1 ,C2.COD_UNIDADE1, C2.COD_UNIDADE2, C2.COD_UNIDADE3, C2.COD_UNIDADE4,  C2.COD_UNIDADE5,  C2.COD_UNIDADE6,TRUNC(C2.DATA_INIC_SITUACAO)-1 ,C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,TRUNC(C2.DATA_INIC_SITUACAO)-1 ,C2.COD_CUSTO_GERENC1, C2.COD_CUSTO_GERENC2, C2.COD_CUSTO_GERENC3, C2.COD_CUSTO_GERENC4,  C2.COD_CUSTO_GERENC5, C2.COD_CUSTO_GERENC6)) ; 

                                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                                C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO)-1  -- COMENTADO EM 29/11/21  -1 VOLTEI NO IF NOVO EM 6/12/21 
                                ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,
                                C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21  - 1  VOLTEI NO IF NOVO EM 6/12/21 
                                ,C.COD_UNIDADE1 = C2.COD_UNIDADE1, C.COD_UNIDADE2 = C2.COD_UNIDADE2, C.COD_UNIDADE3 = C2.COD_UNIDADE3, C.COD_UNIDADE4 = C2.COD_UNIDADE4, C.COD_UNIDADE5 =  C2.COD_UNIDADE5, C.COD_UNIDADE6 =  C2.COD_UNIDADE6,
                                C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                                ,C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3, C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                                C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                                ,C.COD_CUSTO_GERENC1 = C2.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2 = C2.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3 = C2.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4 = C2.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5 =  C2.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6 = C2.COD_CUSTO_GERENC6
                                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                                COMMIT;
                        END LOOP; 
                    ELSE
                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                        C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO)-1  -- COMENTADO EM 29/11/21  -1 VOLTEI NO IF NOVO EM 6/12/21 
                        ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,
                        C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21  - 1  VOLTEI NO IF NOVO EM 6/12/21 
                        ,C.COD_UNIDADE1 = C2.COD_UNIDADE1, C.COD_UNIDADE2 = C2.COD_UNIDADE2, C.COD_UNIDADE3 = C2.COD_UNIDADE3, C.COD_UNIDADE4 = C2.COD_UNIDADE4, C.COD_UNIDADE5 =  C2.COD_UNIDADE5, C.COD_UNIDADE6 =  C2.COD_UNIDADE6,
                        C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                        ,C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3, C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                        C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
                        ,C.COD_CUSTO_GERENC1 = C2.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2 = C2.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3 = C2.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4 = C2.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5 =  C2.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6 = C2.COD_CUSTO_GERENC6
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                        COMMIT;
                    END IF;
            /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/


        END IF;
        --FIM --Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
    END IF;
END IF;--IF NOVO EM 6/12/21 

--FIM --EXISTE valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
----------------------------------------------FIM--MOVIMENTACAO PARA DESLIGAMENTO E APOSENTADO

--6 TAREFA
----------------------------------------------INICIO--MOVIMENTACAO PARA LICENCAS
--INICIO --EXISTE valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
select to_date(to_char(ULT_MOV.DT_ALT_UNID_CUSTO,'dd/mm/yyyy'),'dd/mm/yyyy') ULT_MOV_DT_INICIO INTO vDATA_INICIO_ULTIMA_MOVIMENTACAO
from RHCGED_TRANSFERENC ULT_MOV 
where ULT_MOV.DT_ALT_UNID_CUSTO = (SELECT MAX(AUX.DT_ALT_UNID_CUSTO) FROM RHCGED_TRANSFERENC AUX WHERE AUX.CODIGO_EMPRESA = ULT_MOV.codigo_empresa and AUX.tipo_contrato = ULT_MOV.tipo_contrato and AUX.codigo = ULT_MOV.codigo)
AND ULT_MOV.CODIGO_EMPRESA = vCODIGO_EMPRESA AND ULT_MOV.TIPO_CONTRATO = vTIPO_CONTRATO AND ULT_MOV.CODIGO = vCODIGO and rownum = 1;

IF (C2.NEW_COD_MOVIMENTACAO IS NOT NULL and C2.NEW_COD_MOVIMENTACAO <> '0000') AND  TRUNC(vDATA_INICIO_ULTIMA_MOVIMENTACAO) < TRUNC(C2.DATA_INIC_SITUACAO) AND C2.ULT_MOV_DT_FIM_TEMP IS NULL
AND (TRUNC(vDATA_INICIO_ULTIMA_MOVIMENTACAO) <> TRUNC(C2.DATA_INIC_SITUACAO) --AND C2.ULT_MOV_COD_MOVIMENTACAO <> C2.NEW_COD_MOVIMENTACAO--comentado em 7/11/19 Kellysson
)
AND (C2.NEW_SF_CONTROLE_FOLHA IN ('L','M') OR C2.NEW_CAUSA_RESC_codigo_esocial = '10') --NOVO EM 31-10-19
THEN
--6.1 TAREFA
dbms_output.put_line('6.1B-FINALIZA registro anterior  HIST. MOVIMENTACAO' );
UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-1
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.ULT_MOV_DT_INICIO) AND COD_MOVIMENTACAO =  C2.ULT_MOV_COD_MOVIMENTACAO
; COMMIT;
    IF ( C2.OLD_SF_CONTROLE_FOLHA IN ('S','D','L','M') AND C2.TIPO_DML = 'U' ) THEN
        UPDATE RHCGED_TRANSFERENC SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, DT_FIM_TEMP = TRUNC(C2.DATA_INIC_SITUACAO)-1
        WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO
        AND TRUNC(DT_ALT_UNID_CUSTO) = TRUNC(C2.PENULT_MOV_DT_ALT_UNID_CUSTO) AND COD_MOVIMENTACAO =  C2.PENULT_MOV_COD_MOVIMENTACAO
        ;COMMIT;
    END IF;

--6.2 TAREFA
dbms_output.put_line('6.2A-CRIA MovimentaCAO se nAO existir' );
--6.3 TAREFA
    --INICIO --Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
    IF C2.M_AGRUPADOR IS NOT NULL THEN
        dbms_output.put_line('6.3.1B-ALTERA os 3 agrupadores' );
        INSERT INTO RHCGED_TRANSFERENC (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DT_ALT_UNID_CUSTO, COD_MOVIMENTACAO, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DATA_PUBLIC,--alterado 23/2/21--C_LIVRE_DATA01,
        COD_LOTACAO_ATUAL1, COD_LOTACAO_ATUAL2, COD_LOTACAO_ATUAL3, COD_LOTACAO_ATUAL4, COD_LOTACAO_ATUAL5, COD_LOTACAO_ATUAL6,
        COD_UNIDADE_ATUAL1, COD_UNIDADE_ATUAL2, COD_UNIDADE_ATUAL3, COD_UNIDADE_ATUAL4, COD_UNIDADE_ATUAL5, COD_UNIDADE_ATUAL6,
        COD_CCONTAB_ATUAL1, COD_CCONTAB_ATUAL2, COD_CCONTAB_ATUAL3, COD_CCONTAB_ATUAL4, COD_CCONTAB_ATUAL5, COD_CCONTAB_ATUAL6,
        COD_CGERENC_ATUAL1, COD_CGERENC_ATUAL2, COD_CGERENC_ATUAL3, COD_CGERENC_ATUAL4, COD_CGERENC_ATUAL5, COD_CGERENC_ATUAL6
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,DT_PREV_RETORNO--alterado 23/2/21--,C_LIVRE_DATA02
        ,DT_PREV_RETORNO--voltei DT_PREV_RETORNO EM 6/10/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--alterado 23/2/21--,C_LIVRE_DATA02
        )
        VALUES(C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, TRUNC(C2.DATA_INIC_SITUACAO), C2.NEW_COD_MOVIMENTACAO,'GERADA PELA ALTERACO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, sysdate, C2.ULT_ASF_DATA_DOM,
        --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
        C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
        LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
        C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,
        LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
        --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,TRUNC(C2.DATA_FIM_ANALISE)
        ,TRUNC(C2.DATA_FIM_ANALISE)----voltei DT_PREV_RETORNO EM 6/10/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,
        );COMMIT;
        --12 tarefa--Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
        dbms_output.put_line('12.1B-ALTERA os 3 agrupadores' );

        /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
             IF C2.OLD_SF_CONTROLE_FOLHA IN ('D' ) AND  (
            ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
            OR
            ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
            ) THEN   
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                            Lista('COD_MOVIMENTACAO','DT_ULT_ALT_LOC','COD_LOCAL1','COD_LOCAL2','COD_LOCAL3','COD_LOCAL4','COD_LOCAL5','COD_LOCAL6','DT_ULT_ALT_UNID','COD_UNIDADE1','COD_UNIDADE2','COD_UNIDADE3','COD_UNIDADE4','COD_UNIDADE5','COD_UNIDADE6','DT_ULT_ALT_CONT','COD_CUSTO_CONTAB1','COD_CUSTO_CONTAB2','COD_CUSTO_CONTAB3','COD_CUSTO_CONTAB4','COD_CUSTO_CONTAB5','COD_CUSTO_CONTAB6','DT_ULT_ALT_GER','COD_CUSTO_GERENC1','COD_CUSTO_GERENC2','COD_CUSTO_GERENC3','COD_CUSTO_GERENC4','COD_CUSTO_GERENC5','COD_CUSTO_GERENC6'),
                            LISTA(CNT.COD_MOVIMENTACAO,CNT.DT_ULT_ALT_LOC,CNT.COD_LOCAL1,CNT.COD_LOCAL2,CNT.COD_LOCAL3,CNT.COD_LOCAL4,CNT.COD_LOCAL5,CNT.COD_LOCAL6,CNT.DT_ULT_ALT_UNID,CNT.COD_UNIDADE1,CNT.COD_UNIDADE2,CNT.COD_UNIDADE3,CNT.COD_UNIDADE4,CNT.COD_UNIDADE5,CNT.COD_UNIDADE6,CNT.DT_ULT_ALT_CONT,CNT.COD_CUSTO_CONTAB1,CNT.COD_CUSTO_CONTAB2,CNT.COD_CUSTO_CONTAB3,CNT.COD_CUSTO_CONTAB4,CNT.COD_CUSTO_CONTAB5,CNT.COD_CUSTO_CONTAB6,CNT.DT_ULT_ALT_GER,CNT.COD_CUSTO_GERENC1,CNT.COD_CUSTO_GERENC2,CNT.COD_CUSTO_GERENC3,CNT.COD_CUSTO_GERENC4,CNT.COD_CUSTO_GERENC5,CNT.COD_CUSTO_GERENC6),
                            LISTA(C2.NEW_COD_MOVIMENTACAO, TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6, TRUNC(C2.DATA_INIC_SITUACAO), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0), TRUNC(C2.DATA_INIC_SITUACAO), C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6, TRUNC(C2.DATA_INIC_SITUACAO), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0))) ;  

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                            C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21  -1 
                            ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
                            C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                            ,C.COD_UNIDADE1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_UNIDADE2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_UNIDADE3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                            C.COD_UNIDADE4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_UNIDADE5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_UNIDADE6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                            C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1
                            , C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3,
                            C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                            C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) -- COMENTADO EM 29/11/21 -1 
                            ,C.COD_CUSTO_GERENC1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_CUSTO_GERENC2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_CUSTO_GERENC3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                            C.COD_CUSTO_GERENC4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_CUSTO_GERENC5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_CUSTO_GERENC6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                            COMMIT;
                    END LOOP; 
                ELSE
                    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                    C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) ,
                    --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_LOCAL2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_LOCAL3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                    --comentado em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--C.COD_LOCAL4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_LOCAL5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_LOCAL6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                    C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,--novo em 7/10/21  EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))
                    C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) ,C.COD_UNIDADE1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_UNIDADE2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_UNIDADE3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                    C.COD_UNIDADE4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_UNIDADE5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_UNIDADE6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0),
                    C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO), C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3,
                    C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                    C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) ,C.COD_CUSTO_GERENC1 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,1,2)),6,0), C.COD_CUSTO_GERENC2 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,4,2)),6,0), C.COD_CUSTO_GERENC3 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,7,2)),6,0),
                    C.COD_CUSTO_GERENC4 = LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,10,2)),6,0), C.COD_CUSTO_GERENC5 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,13,2)),6,0), C.COD_CUSTO_GERENC6 =  LPAD(RTRIM(SUBSTR(C2.M_AGRUPADOR,16,3)),6,0)
                    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                    AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                    COMMIT;
                END IF;
        /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        ELSE
            dbms_output.put_line('6.3.2B-GRAVA com os 4 agrupadores iguais' );
            INSERT INTO RHCGED_TRANSFERENC (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO, DT_ALT_UNID_CUSTO, COD_MOVIMENTACAO, TEXTO_ASSOCIADO, LOGIN_USUARIO, DT_ULT_ALTER_USUA, DATA_PUBLIC,--alterado 23/2/21--C_LIVRE_DATA01,
            COD_LOTACAO_ATUAL1, COD_LOTACAO_ATUAL2, COD_LOTACAO_ATUAL3, COD_LOTACAO_ATUAL4, COD_LOTACAO_ATUAL5, COD_LOTACAO_ATUAL6,
            COD_UNIDADE_ATUAL1, COD_UNIDADE_ATUAL2, COD_UNIDADE_ATUAL3, COD_UNIDADE_ATUAL4, COD_UNIDADE_ATUAL5, COD_UNIDADE_ATUAL6,
            COD_CCONTAB_ATUAL1, COD_CCONTAB_ATUAL2, COD_CCONTAB_ATUAL3, COD_CCONTAB_ATUAL4, COD_CCONTAB_ATUAL5, COD_CCONTAB_ATUAL6,
            COD_CGERENC_ATUAL1, COD_CGERENC_ATUAL2, COD_CGERENC_ATUAL3, COD_CGERENC_ATUAL4, COD_CGERENC_ATUAL5, COD_CGERENC_ATUAL6
            --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,DT_PREV_RETORNO--alterado 23/2/21--, C_LIVRE_DATA02
            ,DT_PREV_RETORNO--voltei DT_PREV_RETORNO EM 6/10/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,--alterado 23/2/21--, C_LIVRE_DATA02
            )
            VALUES(C2.CODIGO_EMPRESA, C2.TIPO_CONTRATO, C2.CODIGO, TRUNC(C2.DATA_INIC_SITUACAO), C2.NEW_COD_MOVIMENTACAO,'GERADA PELA ALTERACAO DE SITUACAO FUNCIONAL', vLOGIN_USUARIO, sysdate, C2.ULT_ASF_DATA_DOM,
            C2.COD_LOCAL1, C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4, C2.COD_LOCAL5, C2.COD_LOCAL6,
            C2.COD_UNIDADE1, C2.COD_UNIDADE2, C2.COD_UNIDADE3, C2.COD_UNIDADE4, C2.COD_UNIDADE5, C2.COD_UNIDADE6,
            C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,
            C2.COD_CUSTO_GERENC1, C2.COD_CUSTO_GERENC2, C2.COD_CUSTO_GERENC3, C2.COD_CUSTO_GERENC4, C2.COD_CUSTO_GERENC5, C2.COD_CUSTO_GERENC6
            --COMENTADO DT_PREV_RETORNO EM 6/9/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,,TRUNC(C2.DATA_FIM_ANALISE)
            ,TRUNC(C2.DATA_FIM_ANALISE)--voltei DT_PREV_RETORNO EM 6/10/21 EMAIL(Desligamentos preenchendo campo Dt prev retorno (concedido até))--,
            );COMMIT;
            --12 tarefa--Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)
            dbms_output.put_line('12.2B-GRAVA com os 4 agrupadores iguais' );



            /*INCLUIDO POR LETICIA EM 19/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/
                 IF C2.OLD_SF_CONTROLE_FOLHA IN ('D' ) AND 
                  (
                    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                    OR
                    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                    )  THEN   
                        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                        FOR CNT IN
                        (
                          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.cod_movimentacao,C.COD_LOCAL1, C.COD_LOCAL2, C.COD_LOCAL3, C.COD_LOCAL4, C.COD_LOCAL5, C.COD_LOCAL6, C.DT_ULT_ALT_LOC,C.COD_UNIDADE1, C.COD_UNIDADE2, C.COD_UNIDADE3, C.COD_UNIDADE4 , C.COD_UNIDADE5 , C.COD_UNIDADE6 , C.DT_ULT_ALT_UNID , C.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 , C.COD_CUSTO_CONTAB3 , C.COD_CUSTO_CONTAB4 ,C.COD_CUSTO_CONTAB5 , C.COD_CUSTO_CONTAB6 , C.DT_ULT_ALT_CONT , C.COD_CUSTO_GERENC1 , C.COD_CUSTO_GERENC2 , C.COD_CUSTO_GERENC3 , C.COD_CUSTO_GERENC4 , C.COD_CUSTO_GERENC5 , C.COD_CUSTO_GERENC6 , C.DT_ULT_ALT_GER 
                          FROM rhpess_contrato C 
                          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                        )
                        LOOP                                      
                                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                                Lista('COD_MOVIMENTACAO', 'DT_ULT_ALT_LOC', 'COD_LOCAL1', 'COD_LOCAL2', 'COD_LOCAL3', 'COD_LOCAL4', 'COD_LOCAL5', 'COD_LOCAL6', 'DT_ULT_ALT_UNID', 'COD_UNIDADE1', 'COD_UNIDADE2', 'COD_UNIDADE3', 'COD_UNIDADE4', 'COD_UNIDADE5', 'COD_UNIDADE6', 'DT_ULT_ALT_CONT', 'COD_CUSTO_CONTAB1', 'COD_CUSTO_CONTAB2', 'COD_CUSTO_CONTAB3', 'COD_CUSTO_CONTAB4', 'COD_CUSTO_CONTAB5', 'COD_CUSTO_CONTAB6', 'DT_ULT_ALT_GER', 'COD_CUSTO_GERENC1', 'COD_CUSTO_GERENC2', 'COD_CUSTO_GERENC3', 'COD_CUSTO_GERENC4', 'COD_CUSTO_GERENC5', 'COD_CUSTO_GERENC6'),
                                LISTA(CNT.COD_MOVIMENTACAO,CNT.DT_ULT_ALT_LOC,CNT.COD_LOCAL1,CNT.COD_LOCAL2,CNT.COD_LOCAL3,CNT.COD_LOCAL4,CNT.COD_LOCAL5,CNT.COD_LOCAL6,CNT.DT_ULT_ALT_UNID,CNT.COD_UNIDADE1,CNT.COD_UNIDADE2,CNT.COD_UNIDADE3,CNT.COD_UNIDADE4,CNT.COD_UNIDADE5,CNT.COD_UNIDADE6,CNT.DT_ULT_ALT_CONT,CNT.COD_CUSTO_CONTAB1,CNT.COD_CUSTO_CONTAB2,CNT.COD_CUSTO_CONTAB3,CNT.COD_CUSTO_CONTAB4,CNT.COD_CUSTO_CONTAB5,CNT.COD_CUSTO_CONTAB6,CNT.DT_ULT_ALT_GER,CNT.COD_CUSTO_GERENC1,CNT.COD_CUSTO_GERENC2,CNT.COD_CUSTO_GERENC3,CNT.COD_CUSTO_GERENC4,CNT.COD_CUSTO_GERENC5,CNT.COD_CUSTO_GERENC6),
                                LISTA(C2.NEW_COD_MOVIMENTACAO,TRUNC(C2.DATA_INIC_SITUACAO),C2.COD_LOCAL1,  C2.COD_LOCAL2, C2.COD_LOCAL3, C2.COD_LOCAL4,  C2.COD_LOCAL5 ,  C2.COD_LOCAL6,TRUNC(C2.DATA_INIC_SITUACAO),C2.COD_UNIDADE1, C2.COD_UNIDADE2, C2.COD_UNIDADE3, C2.COD_UNIDADE4,  C2.COD_UNIDADE5,  C2.COD_UNIDADE6,TRUNC(C2.DATA_INIC_SITUACAO),C2.COD_CUSTO_CONTAB1, C2.COD_CUSTO_CONTAB2, C2.COD_CUSTO_CONTAB3, C2.COD_CUSTO_CONTAB4, C2.COD_CUSTO_CONTAB5, C2.COD_CUSTO_CONTAB6,TRUNC(C2.DATA_INIC_SITUACAO),C2.COD_CUSTO_GERENC1, C2.COD_CUSTO_GERENC2, C2.COD_CUSTO_GERENC3, C2.COD_CUSTO_GERENC4,  C2.COD_CUSTO_GERENC5, C2.COD_CUSTO_GERENC6)) ; 

                                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                                C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO)  
                                ,C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,
                                C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) 
                                ,C.COD_UNIDADE1 = C2.COD_UNIDADE1, C.COD_UNIDADE2 = C2.COD_UNIDADE2, C.COD_UNIDADE3 = C2.COD_UNIDADE3, C.COD_UNIDADE4 = C2.COD_UNIDADE4, C.COD_UNIDADE5 =  C2.COD_UNIDADE5, C.COD_UNIDADE6 =  C2.COD_UNIDADE6,
                                C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO) 
                                ,C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3, C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                                C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO)
                                ,C.COD_CUSTO_GERENC1 = C2.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2 = C2.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3 = C2.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4 = C2.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5 =  C2.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6 = C2.COD_CUSTO_GERENC6
                                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');
                                COMMIT;
                        END LOOP; 
                    ELSE
                        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.COD_MOVIMENTACAO = C2.NEW_COD_MOVIMENTACAO,
                        C.DT_ULT_ALT_LOC = TRUNC(C2.DATA_INIC_SITUACAO) ,
                        C.COD_LOCAL1 = C2.COD_LOCAL1, C.COD_LOCAL2 =  C2.COD_LOCAL2, C.COD_LOCAL3 = C2.COD_LOCAL3, C.COD_LOCAL4 = C2.COD_LOCAL4, C.COD_LOCAL5 =  C2.COD_LOCAL5 , C.COD_LOCAL6 =  C2.COD_LOCAL6,
                        C.DT_ULT_ALT_UNID = TRUNC(C2.DATA_INIC_SITUACAO) ,
                        C.COD_UNIDADE1 = C2.COD_UNIDADE1, C.COD_UNIDADE2 = C2.COD_UNIDADE2, C.COD_UNIDADE3 = C2.COD_UNIDADE3, C.COD_UNIDADE4 = C2.COD_UNIDADE4, C.COD_UNIDADE5 =  C2.COD_UNIDADE5, C.COD_UNIDADE6 =  C2.COD_UNIDADE6,
                        C.DT_ULT_ALT_CONT = TRUNC(C2.DATA_INIC_SITUACAO),
                        C.COD_CUSTO_CONTAB1 = C2.COD_CUSTO_CONTAB1, C.COD_CUSTO_CONTAB2 = C2.COD_CUSTO_CONTAB2, C.COD_CUSTO_CONTAB3 = C2.COD_CUSTO_CONTAB3, C.COD_CUSTO_CONTAB4 = C2.COD_CUSTO_CONTAB4, C.COD_CUSTO_CONTAB5 = C2.COD_CUSTO_CONTAB5, C.COD_CUSTO_CONTAB6 = C2.COD_CUSTO_CONTAB6,
                        C.DT_ULT_ALT_GER = TRUNC(C2.DATA_INIC_SITUACAO) ,
                        C.COD_CUSTO_GERENC1 = C2.COD_CUSTO_GERENC1, C.COD_CUSTO_GERENC2 = C2.COD_CUSTO_GERENC2, C.COD_CUSTO_GERENC3 = C2.COD_CUSTO_GERENC3, C.COD_CUSTO_GERENC4 = C2.COD_CUSTO_GERENC4, C.COD_CUSTO_GERENC5 =  C2.COD_CUSTO_GERENC5, C.COD_CUSTO_GERENC6 = C2.COD_CUSTO_GERENC6
                        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                        COMMIT;
                    END IF;
            /*FIM 19/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

    END IF;
    --FIM --Cadastro COD. MOVIMENTACAO tem c_livre_descr1(Codigo agrupador)

END IF;
--FIM --EXISTE valor no cadastro SIT. FUNC. campo livre: c_livre_valor04 (COD. MOVIMENTACAO)?
----------------------------------------------FIM--MOVIMENTACAO PARA LICENCAS



----------------------------------------------FIM IF - TIPO_DML -ULTIMO REGISTRO

--FIM--------------------------------------------------------------------------------------*******DADOS DEPOIS DE ALTERAR*********---------------------------------------------------------------------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------






--------------------------------------------------------------------------------INICIO IF - TIPO_DML -********************DIFERENTE DO ULTIMO REGISTRO****************************************-----------------------------------------
ELSE
      dbms_output.put_line('diferente ULTIMO REGISTRO' );

IF C2.TIPO_DML = 'I' THEN-------------------------------------------------------INSERT
dbms_output.put_line('TIPO_DML igual a Insert diferente ULTIMO REGISTRO' );

ELSIF C2.TIPO_DML = 'U' THEN----------------------------------------------------UPDATE
dbms_output.put_line('TIPO_DML igual a Update diferente ULTIMO REGISTRO' );

ELSIF C2.TIPO_DML = 'D' THEN----------------------------------------------------DELETE
dbms_output.put_line('TIPO_DML igual a Delete diferente ULTIMO REGISTRO' );

ELSE
dbms_output.put_line('ERRO TIPO_DML diferente ULTIMO REGISTRO' );

END IF;
------------------------------------FIM IF - TIPO_DML -diferente ULTIMO REGISTRO

end if;
--------------------------------------------------------------------------------FIM PRIMEIRO  IF - VERIFICAR SE O ULTIMO REGISTRO DO LOG SER O ULTIMO NA VIDA DA PESSOA DE alteraCAO de situaCAo funcional




--******INICIO************************************************************************ 3 PARTE ---------------- FORCA DADOS DA ULTIMA ALT. SIT FUNC. DA VIDA DA PESSOA NO ULTIMO CONTRATO DA PESSOA

--7 TAREFA
--INICIO --PRIMEIRO registro CONTROLE FOLHA  diferente OUTROS na  vida da pessoa?
IF C2.TIPO_DML IN ('I','U')
AND C2.NEW_COD_SIT_FUNCIONAL	<> '6201' --novo 1/3/22
THEN --novo em 12/2/21 IF PARA O TIPO_DML
IF vQTD_ALT_SIT_FUNC = 1 AND C2.tp_regime_trab_esocial = '1' and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy')--CLT
THEN
dbms_output.put_line('7.1A-CLT-GRAVA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.DATA_INIC_SITUACAO
, C.data_base_ferias = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.DATA_INIC_SITUACAO
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
ELSIF vQTD_ALT_SIT_FUNC = 1 AND C2.tp_regime_trab_esocial = '2' and c2.MES_ADMISSAO <> 1 and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy')--ESTATUTARIO
THEN
dbms_output.put_line('7.2A-ESTATURARIO-GRAVA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.DATA_INIC_SITUACAO
,C.data_base_ferias = TO_DATE('01/01/'||C2.ANO_SEGUINTE,'DD/MM/YYYY')
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
ELSIF vQTD_ALT_SIT_FUNC = 1 AND C2.tp_regime_trab_esocial = '2' and c2.MES_ADMISSAO = 1 and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy')--ESTATUTARIO
THEN
dbms_output.put_line('7.2B-ESTATURARIO-GRAVA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.DATA_INIC_SITUACAO
, C.data_base_ferias = TO_DATE('01/01/'||C2.ANO_ADMISSAO,'DD/MM/YYYY')
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
END IF;

ELSIF C2.TIPO_DML = 'D' THEN --novo em 12/2/21 IF PARA O TIPO_DML
IF vQTD_ALT_SIT_FUNC = 1 AND ( C2.tp_regime_trab_esocial = '1' or c2.cod_categ_esocial= '306' ) and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy')--CLT
THEN
dbms_output.put_line('7.1B-CLT-GRAVA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.ULT_ASF_DATA_INIC_SITUACAO
, C.data_base_ferias = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.DATA_INIC_SITUACAO
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
ELSIF vQTD_ALT_SIT_FUNC = 1 AND C2.tp_regime_trab_esocial = '2' and c2.MES_ADMISSAO <> 1 and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy')--ESTATUTARIO
THEN
dbms_output.put_line('7.2C-ESTATURARIO-GRAVA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.ULT_ASF_DATA_INIC_SITUACAO
, C.data_base_ferias = TO_DATE('01/01/'||C2.ANO_SEGUINTE,'DD/MM/YYYY')
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
ELSIF vQTD_ALT_SIT_FUNC = 1 AND C2.tp_regime_trab_esocial = '2' and c2.MES_ADMISSAO = 1 and to_date(to_char(c2.data_admissao,'dd/mm/yyyy'),'dd/mm/yyyy') >= to_date('01/10/2019','dd/mm/yyyy')--ESTATUTARIO
THEN
dbms_output.put_line('7.2D-ESTATURARIO-GRAVA ulitmo contrato DATA EFETIVO EXERCICIO, DATA BASE FERIAS' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.data_efetivo_exerc = vDT_INI_PRIMEIRA_SITFUNC_EXER --ALTERADO EM 17/2/21 --C2.ULT_ASF_DATA_INIC_SITUACAO
, C.data_base_ferias = TO_DATE('01/01/'||C2.ANO_ADMISSAO,'DD/MM/YYYY')
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
END IF;

END IF;--novo em 12/2/21 IF PARA O TIPO_DML
--FIM --PRIMEIRO registro CONTROLE FOLHA  diferente OUTROS na  vida da pessoa?




--1 TAREFA
--INICIO --ADMITIDO, NORMAL, OUTROS
IF C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('A','N','O' ) 
AND C2.ULT_ASF_DATA_FIM_SITUACAO IS NULL AND C2.ULT_ASF_SF_SITUACAO_PONTO IS NULL--NOVO EM 8/10/20
AND ( C2.NEW_COD_SIT_FUNCIONAL	<> '6201' or C2.NEW_COD_SIT_FUNCIONAL is null ) -- NOVO EM 1/3/22
THEN
    dbms_output.put_line('1.1-LIMPA CAMPOS 5 CAMPOS ultimo contrato: DATA_INIC_AFAST, DATA_FIM_AFAST, DATA_RESCISAO, CAUSA_RESCISAO, MOTIVO_DEMISSAO' );


    IF ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) THEN   /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
    /*INCLUIDO POR LETICIA EM 21/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/              
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );
                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_INIC_AFAST ,C.DATA_FIM_AFAST ,C.DATA_RESCISAO ,C.CAUSA_RESCISAO ,C.MOTIVO_DEMISSAO,C.DATA_AV_PREVIO ,C.DT_PROJ_AFAST_ESOCIAL ,C.CNPJ_EMPRESA_SUCESSORA ,C.TP_AVISO_PREVIO_ESOCIAL ,C.IND_CUMPR_PARC_AV ,C.OBS_RESCISAO
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_INIC_AFAST','DATA_FIM_AFAST','DATA_RESCISAO','CAUSA_RESCISAO','MOTIVO_DEMISSAO','DATA_AV_PREVIO','DT_PROJ_AFAST_ESOCIAL','CNPJ_EMPRESA_SUCESSORA','TP_AVISO_PREVIO_ESOCIAL','IND_CUMPR_PARC_AV','OBS_RESCISAO'),
                            LISTA(CNT.DATA_INIC_AFAST ,CNT.DATA_FIM_AFAST ,CNT.DATA_RESCISAO ,CNT.CAUSA_RESCISAO ,CNT.MOTIVO_DEMISSAO,CNT.DATA_AV_PREVIO ,CNT.DT_PROJ_AFAST_ESOCIAL ,CNT.CNPJ_EMPRESA_SUCESSORA ,CNT.TP_AVISO_PREVIO_ESOCIAL ,CNT.IND_CUMPR_PARC_AV ,CNT.OBS_RESCISAO), 
                            lista(null,null,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)) ;   

                             UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = null, C.DATA_FIM_AFAST = null, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                            , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                    END LOOP; 

            /*FIM 21/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/ 
            ELSE    
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = NULL, C.DATA_FIM_AFAST = NULL, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                COMMIT;

        END IF;

    UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL
    , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
    WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
    COMMIT;
END IF;

--/*
--INICIO--NOVO EM 8/10/20
IF C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('A','N','O' ) THEN
  dbms_output.put_line('ENTROU AQUI ------------------------' );
 dbms_output.put_line(C2.ULT_ASF_DATA_FIM_SITUACAO);
  dbms_output.put_line('ULT_ASF_SF_SITUACAO_PONTO-'||C2.ULT_ASF_SF_SITUACAO_PONTO|| '-');
    IF C2.ULT_ASF_DATA_FIM_SITUACAO IS NOT NULL AND C2.ULT_ASF_SF_SITUACAO_PONTO IS NOT NULL
    THEN
        dbms_output.put_line('8.3-GRAVA ultimo contrato: DATA_INIC_AFAST, DATA_FIM_AFAST' );


        IF ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) THEN   /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
     
             /*INCLUIDO POR LETICIA EM 21/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/              
                        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );
                        FOR CNT IN
                        (
                          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_INIC_AFAST ,C.DATA_FIM_AFAST ,C.DATA_RESCISAO ,C.CAUSA_RESCISAO ,C.MOTIVO_DEMISSAO,C.DATA_AV_PREVIO ,C.DT_PROJ_AFAST_ESOCIAL ,C.CNPJ_EMPRESA_SUCESSORA ,C.TP_AVISO_PREVIO_ESOCIAL ,C.IND_CUMPR_PARC_AV ,C.OBS_RESCISAO
                          FROM rhpess_contrato C 
                          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                        )
                        LOOP                                      
                                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_INIC_AFAST','DATA_FIM_AFAST','DATA_RESCISAO','CAUSA_RESCISAO','MOTIVO_DEMISSAO','DATA_AV_PREVIO','DT_PROJ_AFAST_ESOCIAL','CNPJ_EMPRESA_SUCESSORA','TP_AVISO_PREVIO_ESOCIAL','IND_CUMPR_PARC_AV','OBS_RESCISAO'),
                                LISTA(CNT.DATA_INIC_AFAST ,CNT.DATA_FIM_AFAST ,CNT.DATA_RESCISAO ,CNT.CAUSA_RESCISAO ,CNT.MOTIVO_DEMISSAO,CNT.DATA_AV_PREVIO ,CNT.DT_PROJ_AFAST_ESOCIAL ,CNT.CNPJ_EMPRESA_SUCESSORA ,CNT.TP_AVISO_PREVIO_ESOCIAL ,CNT.IND_CUMPR_PARC_AV ,CNT.OBS_RESCISAO), 
                                lista(C2.ULT_ASF_DATA_INIC_SITUACAO,C2.ULT_ASF_DATA_FIM_SITUACAO,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)) ;   

                                 UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = C2.ULT_ASF_DATA_INIC_SITUACAO, C.DATA_FIM_AFAST = C2.ULT_ASF_DATA_FIM_SITUACAO, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                                , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                        END LOOP; 

                /*FIM 21/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/ 
                ELSE    
                    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = C2.ULT_ASF_DATA_INIC_SITUACAO, C.DATA_FIM_AFAST = C2.ULT_ASF_DATA_FIM_SITUACAO, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                    , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                    AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                    COMMIT;

            END IF;

        UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL
        , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
        WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
        COMMIT;

     ELSE
     dbms_output.put_line('8.3-LIMPA DATA DESLIGAMENTO' );


        IF ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) THEN   /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
             /*INCLUIDO POR LETICIA EM 21/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/              
                        PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );
                        FOR CNT IN
                        (
                          SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_RESCISAO ,C.CAUSA_RESCISAO ,C.MOTIVO_DEMISSAO,C.OBS_RESCISAO
                          FROM rhpess_contrato C 
                          where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                          ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                        )
                        LOOP                                      
                                PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_RESCISAO','CAUSA_RESCISAO','MOTIVO_DEMISSAO','OBS_RESCISAO'),
                                LISTA(CNT.DATA_RESCISAO ,CNT.CAUSA_RESCISAO,CNT.MOTIVO_DEMISSAO,CNT.OBS_RESCISAO), 
                                lista(NULL,NULL,NULL,NULL)) ;   

                                 UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL, C.OBS_RESCISAO = NULL 
                                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                                AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                        END LOOP; 

                /*FIM 21/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/ 
                ELSE    
                    UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL, C.OBS_RESCISAO = NULL
                    WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                    AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                    AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                    COMMIT;

            END IF;

        UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL
        , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
        WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
        COMMIT;

    END IF;   
END IF;
--FIM--NOVO EM 8/10/20
--*/
--FIM --ADMITIDO, NORMAL, OUTROS

--8Ã‚Âª TAREFA
--INICIO --LICENCA ou MATERNIDADE
    IF C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('L','M' ) AND C2.TIPO_DML <> 'D' THEN 
        dbms_output.put_line('8.1-GRAVA ultimo contrato: DATA_INIC_AFAST, DATA_FIM_AFAST' );
        
        IF ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) THEN   /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
         /*INCLUIDO POR LETICIA EM 21/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/              
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );
                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_INIC_AFAST ,C.DATA_FIM_AFAST ,C.DATA_RESCISAO ,C.CAUSA_RESCISAO ,C.MOTIVO_DEMISSAO,C.DATA_AV_PREVIO ,C.DT_PROJ_AFAST_ESOCIAL ,C.CNPJ_EMPRESA_SUCESSORA ,C.TP_AVISO_PREVIO_ESOCIAL ,C.IND_CUMPR_PARC_AV ,C.OBS_RESCISAO
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_INIC_AFAST','DATA_FIM_AFAST','DATA_RESCISAO','CAUSA_RESCISAO','MOTIVO_DEMISSAO','DATA_AV_PREVIO','DT_PROJ_AFAST_ESOCIAL','CNPJ_EMPRESA_SUCESSORA','TP_AVISO_PREVIO_ESOCIAL','IND_CUMPR_PARC_AV','OBS_RESCISAO'),
                            LISTA(CNT.DATA_INIC_AFAST ,CNT.DATA_FIM_AFAST ,CNT.DATA_RESCISAO ,CNT.CAUSA_RESCISAO ,CNT.MOTIVO_DEMISSAO,CNT.DATA_AV_PREVIO ,CNT.DT_PROJ_AFAST_ESOCIAL ,CNT.CNPJ_EMPRESA_SUCESSORA ,CNT.TP_AVISO_PREVIO_ESOCIAL ,CNT.IND_CUMPR_PARC_AV ,CNT.OBS_RESCISAO), 
                            lista(C2.DATA_INIC_SITUACAO,C2.DATA_FIM_ANALISE,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)) ;   

                             UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = C2.DATA_INIC_SITUACAO, C.DATA_FIM_AFAST = C2.DATA_FIM_ANALISE, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                            , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                    END LOOP; 

            /*FIM 21/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/ 
            ELSE    
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = C2.DATA_INIC_SITUACAO, C.DATA_FIM_AFAST = C2.DATA_FIM_ANALISE, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS

                COMMIT;

        END IF;


        COMMIT;

        UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL 
        , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
        WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;COMMIT; --NOVO EM 27/8/21
        --KELLYSSON ADICIONOU EM 4/10/19 PARTE
    ELSIF C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('L','M' ) AND C2.TIPO_DML = 'D' THEN
            dbms_output.put_line('8.2-GRAVA ultimo contrato: DATA_INIC_AFAST, DATA_FIM_AFAST' );

            IF ( C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) AND 
                  (
                    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                    OR
                    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                    )  THEN
         /*INCLUIDO POR LETICIA EM 21/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/              
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );
                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_INIC_AFAST ,C.DATA_FIM_AFAST ,C.DATA_RESCISAO ,C.CAUSA_RESCISAO ,C.MOTIVO_DEMISSAO,C.DATA_AV_PREVIO ,C.DT_PROJ_AFAST_ESOCIAL ,C.CNPJ_EMPRESA_SUCESSORA ,C.TP_AVISO_PREVIO_ESOCIAL ,C.IND_CUMPR_PARC_AV ,C.OBS_RESCISAO
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_INIC_AFAST','DATA_FIM_AFAST','DATA_RESCISAO','CAUSA_RESCISAO','MOTIVO_DEMISSAO','DATA_AV_PREVIO','DT_PROJ_AFAST_ESOCIAL','CNPJ_EMPRESA_SUCESSORA','TP_AVISO_PREVIO_ESOCIAL','IND_CUMPR_PARC_AV','OBS_RESCISAO'),
                            LISTA(CNT.DATA_INIC_AFAST ,CNT.DATA_FIM_AFAST ,CNT.DATA_RESCISAO ,CNT.CAUSA_RESCISAO ,CNT.MOTIVO_DEMISSAO,CNT.DATA_AV_PREVIO ,CNT.DT_PROJ_AFAST_ESOCIAL ,CNT.CNPJ_EMPRESA_SUCESSORA ,CNT.TP_AVISO_PREVIO_ESOCIAL ,CNT.IND_CUMPR_PARC_AV ,CNT.OBS_RESCISAO), 
                            lista(C2.ULT_ASF_DATA_INIC_SITUACAO,C2.ULT_ASF_DATA_FIM_SITUACAO,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)) ;   

                             UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = C2.ULT_ASF_DATA_INIC_SITUACAO, C.DATA_FIM_AFAST = C2.ULT_ASF_DATA_FIM_SITUACAO, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                            , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                    END LOOP; 

            /*FIM 21/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/ 
            ELSE    
                UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = C2.ULT_ASF_DATA_INIC_SITUACAO, C.DATA_FIM_AFAST = C2.ULT_ASF_DATA_FIM_SITUACAO, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
                AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
                COMMIT;

        END IF;


            UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL
            , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
            WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
            COMMIT;
    END IF;
--FIM --LICENCA ou MATERNIDADE

--INICIO --DESLIGADO

IF (( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
    OR
   ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
   )  and  /*Kellysson nova em 05/02/20*/( C2.NEW_CAUSA_RESC_codigo_esocial <> '10' /*Kellysson nova em 13/5/20*/ OR C2.NEW_CAUSA_RESC_codigo_esocial IS NULL) THEN
    IF TRUNC(C2.DATA_INIC_SITUACAO) >= TO_DATE('01/12/2021','DD/MM/YYYY') THEN --IF NOVO EM 6/12/21 
    --9 TAREFA
        dbms_output.put_line('9.1.1-GRAVA DESLIGADO ultimo contrato: DATA_RESCISAO, CAUSA_RESCISAO' );

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_RESCISAO, C.CAUSA_RESCISAO, C.DATA_INIC_AFAST, C.DATA_FIM_AFAST
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                            Lista('DATA_RESCISAO', 'CAUSA_RESCISAO','DATA_INIC_AFAST' ,'DATA_FIM_AFAST'),
                            LISTA(CNT.DATA_RESCISAO, CNT.CAUSA_RESCISAO, CNT.DATA_INIC_AFAST, CNT.DATA_FIM_AFAST ),
                            lista(trunc(C2.ULT_ASF_DATA_INIC_SITUACAO), C2.ULT_ASF_SF_CAUSA_RESCISAO,NULL,NULL)) ;    

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_RESCISAO = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-- COMENTADO EM 29/11/21  -1 /* ALTERADO EM 22/12/20 trunc(C2.DATA_INIC_SITUACAO)-1*/
                            , C.CAUSA_RESCISAO = C2.ULT_ASF_SF_CAUSA_RESCISAO--, C.MOTIVO_DEMISSAO = C2.MOTIVO_DEMISSAO
                             ,C.DATA_INIC_AFAST = NULL, C.DATA_FIM_AFAST = NULL
                            --, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;



                    END LOOP; 

        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-- COMENTADO EM 29/11/21  -1 /* ALTERADO EM 22/12/20trunc(C2.DATA_INIC_SITUACAO)-1*/
        , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
        WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
        COMMIT;

        UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

        UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
         X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

    ELSE --IF NOVO EM 6/12/21 
    --9 TAREFA
        dbms_output.put_line('9.1.1-GRAVA DESLIGADO ultimo contrato: DATA_RESCISAO, CAUSA_RESCISAO' );

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_RESCISAO, C.CAUSA_RESCISAO, C.DATA_INIC_AFAST, C.DATA_FIM_AFAST
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_RESCISAO','CAUSA_RESCISAO','DATA_INIC_AFAST' ,'DATA_FIM_AFAST'),
                            LISTA(CNT.DATA_RESCISAO, CNT.CAUSA_RESCISAO,CNT.DATA_INIC_AFAST, CNT.DATA_FIM_AFAST), 
                            lista(trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-1,C2.ULT_ASF_SF_CAUSA_RESCISAO, NULL, NULL)) ;   

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_RESCISAO = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-1-- COMENTADO EM 29/11/21  -1 /* ALTERADO EM 22/12/20 trunc(C2.DATA_INIC_SITUACAO)-1*/
                            , C.CAUSA_RESCISAO = C2.ULT_ASF_SF_CAUSA_RESCISAO--, C.MOTIVO_DEMISSAO = C2.MOTIVO_DEMISSAO
                            ,C.DATA_INIC_AFAST = NULL, C.DATA_FIM_AFAST = NULL
                            --, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                    END LOOP; 

        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-1 -- COMENTADO EM 29/11/21 VOLTEI NO IF NOVO EM 6/12/21  -1 /* ALTERADO EM 22/12/20trunc(C2.DATA_INIC_SITUACAO)-1*/
        , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
        WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
        COMMIT;

        UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-1
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

        UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)-1
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
         X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;
    END IF;
END IF;--IF NOVO EM 6/12/21 




/* inicio -- Kellysson nova em 05/02/20*/
IF C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D' ) and  C2.NEW_CAUSA_RESC_codigo_esocial = '10' AND 
                  (
                    ( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
                    OR
                    ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
                    ) THEN
--9 TAREFA
dbms_output.put_line('9.1.2-GRAVA DESLIGADO ultimo contrato: DATA_RESCISAO, CAUSA_RESCISAO' );

/*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_RESCISAO, c.CAUSA_RESCISAO, C.DATA_INIC_AFAST, C.DATA_FIM_AFAST
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,
                            Lista('DATA_RESCISAO', 'CAUSA_RESCISAO','DATA_INIC_AFAST' ,'DATA_FIM_AFAST'),
                            LISTA(CNT.DATA_RESCISAO, CNT.CAUSA_RESCISAO, CNT.DATA_INIC_AFAST, CNT.DATA_FIM_AFAST ),
                            lista(trunc(C2.ULT_ASF_DATA_INIC_SITUACAO), C2.ULT_ASF_SF_CAUSA_RESCISAO,NULL,NULL)) ;   

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_RESCISAO = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)/* tirado o -1 em 19/7/21 devido email (Certidão de óbito)-- ALTERADO EM 22/12/20 trunc(C2.DATA_INIC_SITUACAO)*/, C.CAUSA_RESCISAO = C2.ULT_ASF_SF_CAUSA_RESCISAO/*, C.MOTIVO_DEMISSAO = C2.MOTIVO_DEMISSAO*/
                            ,C.DATA_INIC_AFAST = NULL, C.DATA_FIM_AFAST = NULL
                            --, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                              AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;

                    END LOOP; 

/*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

        UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)/*tirado o -1 em 19/7/21 devido email (Certidão de óbito)--  ALTERADO EM 22/12/20 trunc(C2.DATA_INIC_SITUACAO)*/
        , ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
        WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
        COMMIT;

        UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

        UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.ULT_ASF_DATA_INIC_SITUACAO)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
         X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

END IF;

/* fim -- Kellysson nova em 05/02/20*/


--INICIO --DESLIGADO

--INICIO --APOSENTADO
--aposentado mas nAo transferido ainda para a SUPREV SEM SF 1715
IF-- C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('S') AND (C2.NEW_SF_CAUSA_RESCISAO IS NULL or C2.NEW_SF_CAUSA_RESCISAO = '0000') AND C2.TIPO_DML = 'D'
(C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('S') --AND C2.ULT_ASF_data_fim_situacao IS NULL
AND (C2.ULT_ASF_SF_CAUSA_RESCISAO IS NOT NULL AND C2.ULT_ASF_SF_CAUSA_RESCISAO <> '0000')
AND (C2.ULT_ASF_SF_COD_MOVIMENTACAO IS NOT NULL AND C2.ULT_ASF_SF_COD_MOVIMENTACAO <>'0000')
)AND
C2.PENULT_ASF_SF_CONTROLE_FOLHA NOT IN ('S')
THEN
--9TAREFA
dbms_output.put_line('9.3-GRAVA APOSENTADO ultimo contrato: DADOS DA ultima ALT. SIT FUNC' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = trunc(C2.ULT_ASF_data_inic_situacao)--alterado em 30/11/21 -- C.DATA_INIC_AFAST = NULL
, C.DATA_FIM_AFAST = NULL, C.DATA_RESCISAO = NULL/*trunc(C2.ULT_ASF_data_inic_situacao)-1*/, C.CAUSA_RESCISAO = C2.ULT_ASF_SF_CAUSA_RESCISAO, C.MOTIVO_DEMISSAO = C2.ULT_ASF_MOTIVO_AFAST
--, C.codigo_vaga = NULL , C.dt_ult_vaga = NULL
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL /*trunc(C2.ULT_ASF_data_inic_situacao)-1*/
, ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
COMMIT;
END IF;

--jA fez o processo de transferir a pessoa aposentada para a SUPREV
IF TRUNC(C2.DATA_INIC_SITUACAO) >= TO_DATE('01/12/2021','DD/MM/YYYY') THEN --IF NOVO EM 6/12/21 
IF --C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('S') AND (C2.NEW_SF_CAUSA_RESCISAO IS NOT NULL AND C2.NEW_SF_CAUSA_RESCISAO <> '0000')
(C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('S') AND C2.ULT_ASF_data_fim_situacao IS NULL
AND (C2.ULT_ASF_SF_CAUSA_RESCISAO IS NULL OR C2.ULT_ASF_SF_CAUSA_RESCISAO = '0000')
AND (C2.ULT_ASF_SF_COD_MOVIMENTACAO IS NULL OR C2.ULT_ASF_SF_COD_MOVIMENTACAO = '0000')--1715
)AND
(C2.PENULT_ASF_SF_CONTROLE_FOLHA IN ('S') --AND C2.PENULT_ASF_data_fim_situacao IS NOT NULL
AND (C2.PENULT_ASF_SF_CAUSA_RESCISAO IS NOT NULL AND C2.PENULT_ASF_SF_CAUSA_RESCISAO <> '0000')
AND (C2.PENULT_ASF_SF_COD_MOVIMENTACAO IS NOT NULL AND C2.PENULT_ASF_SF_COD_MOVIMENTACAO <> '0000')--1002, 1700, ALGUMA OUTRA
)THEN
--9ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Âª TAREFA
dbms_output.put_line('9.2-GRAVA APOSENTADO ultimo contrato: DADOS DA penultima ALT. SIT FUNC' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = trunc(C2.PENULT_ASF_data_inic_situacao) --alterado em 30/11/21 > 03/12/21 12h50 -- C.DATA_INIC_AFAST = NULL
, C.DATA_FIM_AFAST = NULL
, C.DATA_RESCISAO = trunc(C2.PENULT_ASF_data_inic_situacao) -- COMENTADO EM 29/11/21 -1
, C.CAUSA_RESCISAO = C2.PENULT_ASF_SF_CAUSA_RESCISAO, C.MOTIVO_DEMISSAO = C2.PENULT_ASF_MOTIVO_AFAST
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = trunc(C2.PENULT_ASF_data_inic_situacao) -- COMENTADO EM 29/11/21 -1
, ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
        UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.PENULT_ASF_data_inic_situacao)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

        UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.PENULT_ASF_data_inic_situacao)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
         X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;
COMMIT;
END IF;

ELSE --IF NOVO EM 6/12/21 
IF --C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('S') AND (C2.NEW_SF_CAUSA_RESCISAO IS NOT NULL AND C2.NEW_SF_CAUSA_RESCISAO <> '0000')
(C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('S') AND C2.ULT_ASF_data_fim_situacao IS NULL
AND (C2.ULT_ASF_SF_CAUSA_RESCISAO IS NULL OR C2.ULT_ASF_SF_CAUSA_RESCISAO = '0000')
AND (C2.ULT_ASF_SF_COD_MOVIMENTACAO IS NULL OR C2.ULT_ASF_SF_COD_MOVIMENTACAO = '0000')--1715
)AND
(C2.PENULT_ASF_SF_CONTROLE_FOLHA IN ('S') --AND C2.PENULT_ASF_data_fim_situacao IS NOT NULL
AND (C2.PENULT_ASF_SF_CAUSA_RESCISAO IS NOT NULL AND C2.PENULT_ASF_SF_CAUSA_RESCISAO <> '0000')
AND (C2.PENULT_ASF_SF_COD_MOVIMENTACAO IS NOT NULL AND C2.PENULT_ASF_SF_COD_MOVIMENTACAO <> '0000')--1002, 1700, ALGUMA OUTRA
)THEN
--9ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Âª TAREFA
dbms_output.put_line('9.2-GRAVA APOSENTADO ultimo contrato: DADOS DA penultima ALT. SIT FUNC' );
UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = trunc(C2.PENULT_ASF_data_inic_situacao)-1 --alterado em 30/11/21 > 03/12/21 12h50 VOLTEI NO IF NOVO EM 6/12/21  -1-- C.DATA_INIC_AFAST = NULL
, C.DATA_FIM_AFAST = NULL
, C.DATA_RESCISAO = trunc(C2.PENULT_ASF_data_inic_situacao) -- COMENTADO EM 29/11/21 -1
, C.CAUSA_RESCISAO = C2.PENULT_ASF_SF_CAUSA_RESCISAO, C.MOTIVO_DEMISSAO = C2.PENULT_ASF_MOTIVO_AFAST
WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
COMMIT;
UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = trunc(C2.PENULT_ASF_data_inic_situacao) -- COMENTADO O MENOS 1 EM 11/8/22 -1 -- COMENTADO EM 29/11/21 -1 VOLTEI NO IF NOVO EM 6/12/21 
, ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;

        UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.PENULT_ASF_data_inic_situacao)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;

        UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = trunc(C2.PENULT_ASF_data_inic_situacao)
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
         X.DATA_INI_VIGENCIA = (SELECT MAX(AUX.DATA_INI_VIGENCIA) FROM ARTERH.RHSEGU_CONT_AT AUX WHERE X.CODIGO_EMPRESA = AUX.CODIGO_EMPRESA AND X.TIPO_CONTRATO = AUX.TIPO_CONTRATO AND X.CODIGO_CONTRATO = AUX.CODIGO_CONTRATO)--15729
        ;
COMMIT;
END IF;
END IF;--IF NOVO EM 6/12/21 



--FIM --APOSENTADO


--10 TAREFA --Preenchido MOTIVO AFASTAMENTO e na TABELA DE CONVERSAO?
IF C2.ULT_ASF_SF_CAUSA_RESCISAO IS NOT NULL AND C2.ULT_ASF_SF_CAUSA_RESCISAO  <> '0000' AND 
(
( C2.TIPO_DML IN ('I') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') )
OR
( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
)                     THEN
dbms_output.put_line('10-GRAVA ultimo contrato: MOTIVO_DEMISSAO' );

        /*INCLUIDO POR LETICIA EM 18/03/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );

                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.MOTIVO_DEMISSAO
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('MOTIVO_DEMISSAO'),LISTA(CNT.MOTIVO_DEMISSAO), lista(C2.LOG_TC_MOTIVO_DEMISSAO)) ;   

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.MOTIVO_DEMISSAO = C2.LOG_TC_MOTIVO_DEMISSAO--C2.ULT_ASF_SF_CAUSA_RESCISAO
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                    END LOOP; 

        /*FIM 02/03/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/


COMMIT;
END IF;

--mudei de local para ser o ultimo em 8/10/20
--INICIO --ADMITIDO ou NORMAL
--13 TAREFA
--INICIO --Ultima Alt. Sit. Func. que ficou tinha DATA FIM?
IF
(C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('A') AND C2.ULT_ASF_DATA_FIM_SITUACAO IS NOT NULL AND C2.ULT_ASF_SF_e_afastamento = 'N')--Letícia ajustou
OR
(C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('N') AND C2.ULT_ASF_DATA_FIM_SITUACAO IS NOT NULL AND C2.ULT_ASF_SF_e_afastamento = 'N' AND C2.ULT_ASF_SF_SUSPENDE_REMUNERA = 'N' )--Kellysson adicionou em 10/9/19 campos E_AFASTAMETNO e SUSPENDE_REMUNERA
OR 
(C2.OLD_SF_CONTROLE_FOLHA = 'S' AND C2.ULT_ASF_SF_CONTROLE_FOLHA = 'S' AND C2.ULT_ASF_SF_CAUSA_RESCISAO IS NOT NULL AND C2.ULT_ASF_SF_CAUSA_RESCISAO <> '0000') THEN
dbms_output.put_line('13-LIMPA campo DATA FIM' );
UPDATE RHCGED_ALT_SIT_FUN SET login_usuario = vLOGIN_USUARIO, dt_ult_alter_usua = sysdate, data_fim_situacao = NULL
WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO = C2.CODIGO AND TRUNC(data_inic_situacao) = TRUNC(C2.ULT_ASF_data_inic_situacao);
COMMIT;

dbms_output.put_line('1.2-LIMPA CAMPOS 5 CAMPOS ultimo contrato: DATA_INIC_AFAST, DATA_FIM_AFAST, DATA_RESCISAO, CAUSA_RESCISAO, MOTIVO_DEMISSAO' );
    IF ( C2.TIPO_DML IN ('U') AND C2.ULT_ASF_SF_CONTROLE_FOLHA IN ('D') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') ) /*AJUSTADO POR LETICIA PARA ATENDER O E-MAIL: "ERROS RESCINDIDOS [Nova Funcionalidade - eSocial] - DCAP" */
         THEN
         /*INCLUIDO POR LETICIA EM 21/06/2023 PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/              
                    PR_INSERE_CONTRATO(C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO,C2.DATA_INIC_SITUACAO );
                    FOR CNT IN
                    (
                      SELECT C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia, C.DATA_INIC_AFAST ,C.DATA_FIM_AFAST ,C.DATA_RESCISAO ,C.CAUSA_RESCISAO ,C.MOTIVO_DEMISSAO,C.DATA_AV_PREVIO ,C.DT_PROJ_AFAST_ESOCIAL ,C.CNPJ_EMPRESA_SUCESSORA ,C.TP_AVISO_PREVIO_ESOCIAL ,C.IND_CUMPR_PARC_AV ,C.OBS_RESCISAO
                      FROM rhpess_contrato C 
                      where C.codigo_empresa = C2.CODIGO_EMPRESA and C.tipo_contrato = C2.TIPO_CONTRATO And C.CODIGO = C2.CODIGO AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(C2.DATA_INIC_SITUACAO,3,8),'DD/MM/YY')
                      ORDER BY C.codigo_empresa, C.tipo_contrato, C.CODIGO, C.ano_mes_referencia
                    )
                    LOOP                                      
                            PR_INSERE_RHPESS_ALT_CONTRAT (CNT.CODIGO_EMPRESA,CNT.TIPO_CONTRATO,CNT.CODIGO,vLOGIN_USUARIO,CNT.ano_mes_referencia,Lista('DATA_INIC_AFAST','DATA_FIM_AFAST','DATA_RESCISAO','CAUSA_RESCISAO','MOTIVO_DEMISSAO','DATA_AV_PREVIO','DT_PROJ_AFAST_ESOCIAL','CNPJ_EMPRESA_SUCESSORA','TP_AVISO_PREVIO_ESOCIAL','IND_CUMPR_PARC_AV','OBS_RESCISAO'),
                            LISTA(CNT.DATA_INIC_AFAST ,CNT.DATA_FIM_AFAST ,CNT.DATA_RESCISAO ,CNT.CAUSA_RESCISAO ,CNT.MOTIVO_DEMISSAO,CNT.DATA_AV_PREVIO ,CNT.DT_PROJ_AFAST_ESOCIAL ,CNT.CNPJ_EMPRESA_SUCESSORA ,CNT.TP_AVISO_PREVIO_ESOCIAL ,CNT.IND_CUMPR_PARC_AV ,CNT.OBS_RESCISAO), 
                            lista(NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL)) ;   

                            UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = NULL, C.DATA_FIM_AFAST = NULL, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
                            , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
                            WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
                            AND C.ano_mes_referencia = TO_DATE(CNT.ano_mes_referencia,'DD/MM/YY');COMMIT;


                    END LOOP; 

        /*FIM 21/06/2023 - PARA PERMITIR QUE O SISTEMA FAÇA A ATUALIZAÇÃO DE CONTRATOS DESLIGADOS*/

    ELSE    
        UPDATE RHPESS_CONTRATO C SET C.login_usuario = vLOGIN_USUARIO, C.dt_ult_alter_usua = sysdate, C.DATA_INIC_AFAST = NULL, C.DATA_FIM_AFAST = NULL, C.DATA_RESCISAO = NULL, C.CAUSA_RESCISAO = NULL, C.MOTIVO_DEMISSAO = NULL
        , C.DATA_AV_PREVIO = NULL, C.DT_PROJ_AFAST_ESOCIAL = NULL, C.CNPJ_EMPRESA_SUCESSORA = NULL, C.TP_AVISO_PREVIO_ESOCIAL = NULL, C.IND_CUMPR_PARC_AV = NULL, C.OBS_RESCISAO = NULL --NOVO EM 4/9/20 PARA NOVA TELA DE DESLIAGAMENTO
        WHERE C.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND C.TIPO_CONTRATO = C2.TIPO_CONTRATO AND C.CODIGO = C2.CODIGO
        AND C.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX where AUX.codigo_empresa = c.codigo_empresa and AUX.tipo_contrato = c.tipo_contrato and AUX.codigo = c.codigo
        AND C.ano_mes_referencia >= TO_DATE('01'||SUBSTR(vDATA_SISTEMA,3,8),'DD/MM/YY'));--ATUALIZO CONTRATO MES SISTEMA E FUTUROS
        COMMIT;

    END IF;

UPDATE RHPESS_CONTR_MEST M SET M.login_usuario = vLOGIN_USUARIO, M.dt_ult_alter_usua = sysdate, M.DATA_RESCISAO = NULL
, ULTIMA_DATA = vANO_MES_REF_ULT_CONTRATO --NOVO EM 7/6/22
WHERE M.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND M.TIPO_CONTRATO = C2.TIPO_CONTRATO AND M.CODIGO_CONTRATO = C2.CODIGO;
COMMIT;


END IF;
--FIM -- Ultima Alt. Sit. Func. que ficou tinha DATA FIM?
--FIM --ADMITIDO ou NORMAL



     IF C2.TIPO_DML IN ('D','U') AND C2.OLD_SF_CONTROLE_FOLHA IN ('D') AND (C2.NEW_SF_CONTROLE_FOLHA NOT IN ('D') OR C2.NEW_SF_CONTROLE_FOLHA IS NULL ) THEN   
        UPDATE RHSEGU_CONT_AT X SET X.LOGIN_USUARIO = vLOGIN_USUARIO, X.DT_ULT_ALTER_USUA = sysdate, X.DATA_FIM_VIGENCIA = NULL
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_FIM_VIGENCIA = C2.DATA_INIC_SITUACAO --15729
        ;

        UPDATE RHSEGU_RES_AREA_CONTR X SET X.UPDATEDBY = vLOGIN_USUARIO, X.UPDATED = sysdate, X.DATA_FIM_VIGENCIA = NULL
        WHERE 
        X.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.TIPO_CONTRATO = C2.TIPO_CONTRATO AND X.CODIGO_CONTRATO = C2.CODIGO AND
        X.DATA_FIM_VIGENCIA = C2.DATA_INIC_SITUACAO --15729
        ;


    END IF;


ELSE
--INICIO--NOVO EM 18/12/20 - APAGA RECESSO DOS ESTAGIOS
IF C2.TIPO_DML = 'D' AND C2.OLD_COD_SIT_FUNCIONAL	= '1800' THEN
dbms_output.put_line('--APAGA RECESSOS DO ESTAGIO');
DELETE RHFERI_FERIAS WHERE CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND TIPO_CONTRATO = C2.TIPO_CONTRATO AND CODIGO_CONTRATO = C2.CODIGO AND TIPO_FERIAS = '0013'; COMMIT;
END IF;
--FIM--NOVO EM 18/12/20 - APAGA RECESSO DOS ESTAGIOS




END IF;--NOVO EM 18/12/20 - QUANDO A PESSOA NAO TEM MAIS NENHUM REGISTRO NA SIT FUNC

END LOOP;

--------------------------------------------------------------------------------------------------------------FIM V2-----------------------------------------------------------------------------------------

END; --2 BEGIN
 /*
 CONFORME ALINHAMOS EM REUNIAO O COMANDO ABAIXO FOI REMOVIDO PARA QUE POSSAMOS TESTAR O FUNCIONAMENTO DA PROCEDURE NO AMBIENTE 
 DE HOMOLOGAÇÃO ORA19 E NO ARTERH, EM CONJUNTO COM A IMPORTAÇÃO DAS FICHAS MÉDICAS

 execute immediate 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD-MON-RR''';

*/
END; --1 BEGIN