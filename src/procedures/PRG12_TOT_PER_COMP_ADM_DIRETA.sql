
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PRG12_TOT_PER_COMP_ADM_DIRETA" (DATA_INICIO IN DATE, DATA_FIM IN DATE)AS
BEGIN


--EM 9/12/21 v10.1 ajuste referentes fechamento out/21
--em 5/11/21 v10  para ajustes novos como duplicidades e relatados no fechamento set/21
--KELLYSSON EM 22/7/20 
--novos ajustes em 31/8/20 justifica v6 para respeitar a regra do Ifponto onde prevalece FALTAS se o saldo de HORAS DIFERENCIADAS tiver a maior independente da ordem cronologica.
-- em 10/11/20 justificando v7 devido a erro no loop das situação de ponto no Arterh, usar um SUM/GROUP BY
--em 11/11/20 indo para v8 para trabalhar apenas com DESCONTO e FALTAS nos cenarios para ajustar as FALTAS e TOTAL DE HORAS EXCEDIDAS
--em 29/12/20 --nova revisao devido erros nov/2020 

      --**************TROCAR DATAS
DECLARE   
vEMPRESA VARCHAR2(4 BYTE);
vTIPO_CONTRATO VARCHAR2(4 BYTE);
vMATRICULA VARCHAR2(15 BYTE);
vFOLHA_ESPECIAL VARCHAR2(3 BYTE);
vREGISTRO_PONTO VARCHAR2(4 BYTE);
vCOD_VINCULO VARCHAR2(4 BYTE);
vTIPO_FECHAMENTO VARCHAR2(30 BYTE);
vCONTADORDIA NUMBER;-- (10,6);
vACUMULADO_H_NORMAIS NUMBER;-- (10,6);
vACUMULADO_H_DIFERENCIAS NUMBER ;--(10,6);
vACUMULADO_H_EXCEDIDAS NUMBER;-- (10,6);
vACUMULADO_PREVISTO NUMBER ;--(10,6);
vRESULTADO_MES NUMBER ;--(10,6);
vACUMULADO_FALTAS NUMBER ;--(10,6);
vPREVISTO NUMBER;-- (10,6);
vSALDO_HORAS_FALTA_COMP NUMBER ;--(10,6);
vDESCONTO NUMBER;-- (10,6);
vCONTADORGERAL NUMBER ;--(10);
vCONTADORBM NUMBER ;--(10);
vDATA date;
vBH_DEBITO NUMBER;
vDATA_INICIO DATE;
vDATA_FIM DATE;
vUSOU_TODO_SALDO_HD VARCHAR2(1 BYTE);
vRESULTADO_NEGATIVO VARCHAR2 (1 BYTE);
vSOBRA_RESULTADO_MES NUMBER;
vSOBRA_RESULTADO_MES_SEM_SALD NUMBER;
vNUMERO NUMBER ;
vSTRING VARCHAR2 (10 BYTE);
vMEDIA_CARGA_DIA NUMBER;
--vTIPO_ESCALA VARCHAR2 (20 BYTE);
vCARGA_HORARIA VARCHAR2 (20 BYTE);

vACUMULADO_HORAS_DE_FALTA NUMBER;

err_msg varchar2 (4000);

BEGIN 
dbms_output.enable(null);

vDATA_INICIO := TO_DATE(DATA_INICIO,'DD/MM/YYYY');--**************TROCAR DATAS
vDATA_FIM := TO_DATE(DATA_FIM,'DD/MM/YYYY');--**************TROCAR DATAS

vEMPRESA := NULL;
vTIPO_CONTRATO := NULL;
vMATRICULA := NULL;
vFOLHA_ESPECIAL := NULL;
vREGISTRO_PONTO := NULL;
vCOD_VINCULO := NULL;
vTIPO_FECHAMENTO := null;
vCONTADORDIA :=0;
vACUMULADO_H_NORMAIS :=0;
vACUMULADO_H_DIFERENCIAS :=0;
vACUMULADO_H_EXCEDIDAS :=0;
vACUMULADO_PREVISTO :=0;
vPREVISTO := 0;
vRESULTADO_MES :=0;
vACUMULADO_FALTAS :=0;
vSALDO_HORAS_FALTA_COMP := 0;
vDESCONTO := 0;
vCONTADORBM := 0;
vCONTADORGERAL := 0;
vDATA := null;
vBH_DEBITO := 0;
vUSOU_TODO_SALDO_HD := 'N';
vRESULTADO_NEGATIVO := 'N';
vSOBRA_RESULTADO_MES := 0;
vSOBRA_RESULTADO_MES_SEM_SALD := 0;
vNUMERO := 0;
vSTRING := NULL;
vMEDIA_CARGA_DIA := 0;
--vTIPO_ESCALA := NULL;
vCARGA_HORARIA := NULL;

vACUMULADO_HORAS_DE_FALTA :=0;

err_msg := NULL;

dbms_output.put_line('--TIPO_FECHAMENTO|EMPRESA|TIPO_CONTRATO|MATRICULA|QUANT_DIAS|PREVISTO|BH_DEBITO|DESCONTO|TIPO_ESCALA|QUANT|CARGA_HORARIA|vFOLHA_ESPECIAL|vREGISTRO_PONTO|vCOD_VINCULO|vPREVISTO|vACUMULADO_FALTAS|vACUMULADO_PREVISTO|vDESCONTO|vBH_DEBITO|vACUMULADO_H_NORMAIS|vACUMULADO_H_DIFERENCIAS|vACUMULADO_H_EXCEDIDAS');



--INICIO---C0---------------TODOS BMS
FOR C0 IN (

SELECT X5.* FROM(
-----------------------------------------------------PARTE BMS QUE NAO ENTRAM NA COMPENSACAO PBH
--TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, PRIMEIRA_DATA, ULTIMA_DATA, CARGA_HORARIA, QTD_MESMA_CARGA_HORARIA
SELECT
ROW_NUMBER() OVER(PARTITION BY X2.EMPRESA, X2.TIPO_CONTRATO, X2.MATRICULA ORDER BY X2.MATRICULA ) ORDEM_BM,
'COMPENSACAO_DIARIA' TIPO_FECHAMENTO, 
 X2.EMPRESA, X2.TIPO_CONTRATO, X2.MATRICULA, X2.QUANT_DIAS, X2.PREVISTO, X2.BH_DEBITO, X2.DESCONTO, 
 --X2.TIPO_ESCALA,
 X2.QUANT,
-- vDATA_INICIO 
 TO_DATE(vDATA_INICIO,'DD/MM/YYYY') PRIMEIRA_DATA, 
-- vDATA_FIM 
 TO_DATE(vDATA_FIM,'DD/MM/YYYY')ULTIMA_DATA,
'Diária' CARGA_HORARIA ,--CM.CARGA_HORARIA 
1 QTD_MESMA_CARGA_HORARIA
FROM (
SELECT X.EMPRESA, X.TIPO_CONTRATO, X.MATRICULA, X.QUANT_DIAS,
X.PREVISTO, X.BH_DEBITO, X.DESCONTO, 
--X.TIPO_ESCALA,
COUNT(1)QUANT FROM(
SELECT EMPRESA, TIPO_CONTRATO, MATRICULA, CARGA_HORARIA 
--, TIPO_ESCALA
, COUNT(1)QUANT_DIAS
,ROUND(AVG(PREVISTO),2) PREVISTO , SUM(BH_DEBITO) BH_DEBITO, SUM(DESCONTO) DESCONTO --NOVO 10/11/20
FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA
WHERE MATRICULA IS NOT NULL
AND DATA_PROCESSAMENTO IS NULL
AND LPAD(EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
GROUP BY EMPRESA, TIPO_CONTRATO, MATRICULA ,CARGA_HORARIA-- , TIPO_ESCALA
)X
GROUP BY X.EMPRESA, X.TIPO_CONTRATO, X.MATRICULA , X.PREVISTO, X.BH_DEBITO, X.DESCONTO, --X.TIPO_ESCALA,
X.QUANT_DIAS HAVING COUNT(1) = 1
)X2
LEFT OUTER JOIN (
--INICIO--NOVO 5/11/21
select X.EMPRESA, x.TIPO_CONTRATO, x.MATRICULA, count(1)qtd_hor_escala from (
select row_number() over (partition by EMPRESA, TIPO_CONTRATO, MATRICULA order by COD_HORARIO, COD_ESCALA_PADRAO )ORDEM_BM, EMPRESA, TIPO_CONTRATO, MATRICULA, COD_HORARIO, COD_ESCALA_PADRAO, CARGA_HORARIA, TIPO_ESCALA, count(1)quant
from PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA  where trunc(data) between to_date(vDATA_INICIO,'dd/mm/yyyy')and to_date(vDATA_FIM,'dd/mm/yyyy') and DATA_PROCESSAMENTO is null AND CARGA_HORARIA <> 'Diária'
AND LPAD(EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
group by EMPRESA, TIPO_CONTRATO, MATRICULA,COD_HORARIO, COD_ESCALA_PADRAO, CARGA_HORARIA, TIPO_ESCALA order by EMPRESA, TIPO_CONTRATO, MATRICULA, COD_HORARIO, COD_ESCALA_PADRAO
)x group by X.EMPRESA, x.TIPO_CONTRATO, x.MATRICULA --having count(1)> 1 
order by X.EMPRESA, x.TIPO_CONTRATO, x.MATRICULA
--FIM--NOVO 5/11/21
/*ANTIGO
      SELECT EMPRESA, TIPO_CONTRATO, MATRICULA, CARGA_HORARIA
      FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA
      WHERE MATRICULA IS NOT NULL
      AND DATA_PROCESSAMENTO IS NULL
      GROUP BY EMPRESA, TIPO_CONTRATO, MATRICULA ,CARGA_HORARIA 
*/      
      )
CM ON CM.EMPRESA = X2.EMPRESA AND CM.TIPO_CONTRATO = X2.TIPO_CONTRATO AND CM.MATRICULA = X2.MATRICULA
--COMENTADO 5/11/21--WHERE CM.CARGA_HORARIA NOT IN ('Semanal','Mensal')
WHERE CM.EMPRESA IS NULL--NOVO 5/11/21

UNION ALL-------------------------------------------------------------UNION ALL

------------------------------------------------------PARTE DOS BMS QUE ENTRAM NA COMPENSACAO PBH
SELECT 
ROW_NUMBER() OVER(PARTITION BY X4.EMPRESA, X4.TIPO_CONTRATO, X4.MATRICULA ORDER BY X4.CARGA_HORARIA ) ORDEM_BM,
X4.TIPO_FECHAMENTO, X4.EMPRESA, X4.TIPO_CONTRATO, X4.MATRICULA, X4.QUANT_DIAS, X4.PREVISTO/X4.QTD_MESMA_CARGA_HORARIA PREVISTO, 
X4.BH_DEBITO, X4.DESCONTO, 
--X4.TIPO_ESCALA, 
X4.QUANT, TO_DATE(TO_CHAR(X4.PRIMEIRA_DATA,'DD/MM/YYYY'),'DD/MM/YYYY')PRIMEIRA_DATA, TO_DATE(TO_CHAR(X4.ULTIMA_DATA,'DD/MM/YYYY'),'DD/MM/YYYY')ULTIMA_DATA, X4.CARGA_HORARIA, X4.QTD_MESMA_CARGA_HORARIA
FROM(
SELECT X3.TIPO_FECHAMENTO, X3.EMPRESA, X3.TIPO_CONTRATO, X3.MATRICULA, SUM(X3.QUANT_DIAS)QUANT_DIAS, SUM(X3.PREVISTO)PREVISTO, SUM(X3.BH_DEBITO)BH_DEBITO, SUM(X3.DESCONTO)DESCONTO,
--X3.TIPO_ESCALA,
SUM(X3.QUANT)QUANT, MIN(X3.PRIMEIRA_DATA)PRIMEIRA_DATA, MAX(X3.ULTIMA_DATA)ULTIMA_DATA, X3.CARGA_HORARIA, COUNT(1)QTD_MESMA_CARGA_HORARIA
FROM(

SELECT 'COMPENSACAO_CARGA_HORARIA' TIPO_FECHAMENTO, X2.*, CM.CARGA_HORARIA FROM (
SELECT X.EMPRESA, X.TIPO_CONTRATO, X.MATRICULA, X.QUANT_DIAS,
X.PREVISTO, /*X.ACUMULADO_PREVISTO,*/ X.BH_DEBITO ,X.DESCONTO DESCONTO,
--X.TIPO_ESCALA,
COUNT(1)QUANT 
, X.PRIMEIRA_DATA, X.ULTIMA_DATA
FROM(
SELECT EMPRESA, TIPO_CONTRATO, MATRICULA, CARGA_HORARIA 
--, TIPO_ESCALA
, COUNT(1)QUANT_DIAS
,ROUND(AVG(PREVISTO),2)PREVISTO  , /*SUM(PREVISTO)ACUMULADO_PREVISTO,*/ SUM(BH_DEBITO) BH_DEBITO, SUM(DESCONTO) DESCONTO --NOVO 10/11/20
, MIN(DATA) PRIMEIRA_DATA, MAX(DATA)ULTIMA_DATA
FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA
WHERE MATRICULA IS NOT NULL
AND DATA_PROCESSAMENTO IS NULL
AND LPAD(EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
GROUP BY EMPRESA, TIPO_CONTRATO, MATRICULA ,CARGA_HORARIA , TIPO_ESCALA
)X
GROUP BY X.EMPRESA, X.TIPO_CONTRATO, X.MATRICULA , X.PREVISTO, /*X.ACUMULADO_PREVISTO,*/ X.BH_DEBITO, X.DESCONTO,
--X.TIPO_ESCALA, 
X.QUANT_DIAS
, X.PRIMEIRA_DATA, X.ULTIMA_DATA
HAVING COUNT(1) = 1

)X2
LEFT OUTER JOIN (
      SELECT EMPRESA, TIPO_CONTRATO, MATRICULA, CARGA_HORARIA, MIN(DATA)PRIMEIRA_DATA, MAX(DATA)ULTIMA_DATA
      FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA
      WHERE MATRICULA IS NOT NULL
      AND DATA_PROCESSAMENTO IS NULL
      AND LPAD(EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
      GROUP BY EMPRESA, TIPO_CONTRATO, MATRICULA ,CARGA_HORARIA 
      )CM ON CM.EMPRESA = X2.EMPRESA AND CM.TIPO_CONTRATO = X2.TIPO_CONTRATO AND CM.MATRICULA = X2.MATRICULA
WHERE CM.CARGA_HORARIA IN ('Semanal','Mensal')--de 295 para 168

)X3

GROUP BY X3.TIPO_FECHAMENTO, X3.EMPRESA, X3.TIPO_CONTRATO, X3.MATRICULA, -- X3.TIPO_ESCALA,
X3.QUANT,  X3.CARGA_HORARIA
ORDER BY X3.EMPRESA, X3.TIPO_CONTRATO, X3.MATRICULA
)X4

)X5

--WHERE X5.MATRICULA = '000000000416235'--TESTES

)
LOOP -- INICIO C0
dbms_output.put_line('-----------------------------------------------------------------------NOVO BM --------------------------------------------------------------------------------------------');



vTIPO_FECHAMENTO := c0.TIPO_FECHAMENTO;
vPREVISTO := C0.PREVISTO;--NOVO 10/11/20
--vACUMULADO_PREVISTO := C0.ACUMULADO_PREVISTO ;--NOVO 10/11/20
vBH_DEBITO := ROUND(C0.BH_DEBITO,2);--TO_NUMBER(C0.BH_DEBITO);--NOVO 10/11/20
vDESCONTO := ROUND(C0.DESCONTO,2);--TO_NUMBER(C0.DESCONTO);--NOVO 10/11/20
--vTIPO_ESCALA := C0.TIPO_ESCALA;--NOVO 10/11/20
vCARGA_HORARIA := C0.CARGA_HORARIA;--NOVO 10/11/20

vCONTADORBM :=vCONTADORBM+1;
dbms_output.put_line('--vCONTADORBM: '||vCONTADORBM|| ' C0.MATRICULA: '||C0.MATRICULA);


----INICIO-----------------------------------------POR BM
FOR C1 IN (

SELECT 
X4.* FROM(
SELECT 
V.CODIGO COD_VINCULO, V.DESCRICAO VINCULO,
RG_TRAB.CONTEUDO_INICIAL COD_RG_TRAB, RG_TRAB.DESCR_IT_DOMINIO RG_TRAB,
RG_PREV.CONTEUDO_INICIAL COD_RG_PREV, RG_PREV.DESCR_IT_DOMINIO RG_PREV,
COD_CATEG.CONTEUDO_INICIAL COD_TIPO_TRAB, COD_CATEG.DESCR_IT_DOMINIO TIPO_TRAB,
CASE WHEN CC.c_livre_selec01 = 0 THEN 'NAO' ELSE 'SIM' END FOLHA_ESPECIAL, C.registro_ponto, 
X3.* 
FROM(---INICIO X3
SELECT X2.*
FROM(---INICIO X2

SELECT D.* FROM
--INICIO-----------------------------------------------------------NUCLEO NOVO EM 10/11/20
(SELECT --COUNT(1)
D.CODIGO_EMPRESA, D.TIPO_CONTRATO, D.CODIGO_CONTRATO, 
D.CODIGO_SITUACAO, SP.DESCRICAO SITUACAO_PONTO, SP.TIPO_REFERENCIA, SP.TIPO_SITUACAO, 
SUM(D.REF_HORAS) REFERENCIA, 
D.LOGIN_USUARIO, D.DT_ULT_ALTER_USUA
FROM ARTERH.RHPONT_RES_SIT_DIA D
LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO SP ON SP.CODIGO = D.CODIGO_SITUACAO
--comentado em 5/11/21--WHERE TRUNC(D.DATA) BETWEEN TO_DATE(vDATA_INICIO,'DD/MM/YYYY') AND TO_DATE(vDATA_FIM,'DD/MM/YYYY') 
WHERE TRUNC(D.DATA) BETWEEN TO_DATE(C0.PRIMEIRA_DATA,'DD/MM/YY') AND TO_DATE(C0.ULTIMA_DATA,'DD/MM/YY') --novo em 5/11/21
GROUP BY 
D.CODIGO_EMPRESA, D.TIPO_CONTRATO, D.CODIGO_CONTRATO, 
D.CODIGO_SITUACAO, SP.DESCRICAO, SP.TIPO_REFERENCIA, SP.TIPO_SITUACAO, 
D.LOGIN_USUARIO, D.DT_ULT_ALTER_USUA
ORDER BY D.CODIGO_EMPRESA, D.TIPO_CONTRATO, D.CODIGO_CONTRATO, D.CODIGO_SITUACAO
--FIM ------------------------------------------------------------------------------NUCLEO NOVO EM 10/11/20
)D
LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO SP ON SP.CODIGO = D.CODIGO_SITUACAO
WHERE 
--TRUNC(D.DATA) BETWEEN TO_DATE(vDATA_INICIO,'DD/MM/YYYY') AND TO_DATE(vDATA_FIM,'DD/MM/YYYY') AND
--/* --INICIO------------O QUE FOI PROCESSADO DO IFPONTO
exists
  (
    SELECT X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, COUNT(1)QUANT  FROM ARTERH.RHPONT_RES_SIT_DIA X whEre X.login_usuario = 'IFPONTO' 
    --COMENTADO EM 5/11/21--AND TRUNC(X.DATA) BETWEEN TO_DATE(vDATA_INICIO,'DD/MM/YY') AND TO_DATE(vDATA_FIM,'DD/MM/YY')--AND TRUNC(X.DT_ULT_ALTER_USUA) = TRUNC(SYSDATE)
    AND TRUNC(X.DATA) BETWEEN TO_DATE(C0.PRIMEIRA_DATA,'DD/MM/YY') AND TO_DATE(C0.ULTIMA_DATA,'DD/MM/YY') --novo em 5/11/21
    AND X.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND X.TIPO_CONTRATO = D.TIPO_CONTRATO AND X.CODIGO_CONTRATO = D.CODIGO_CONTRATO
    group BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO
  )
--*/--FIM------------O QUE FOI PROCESSADO DO IFPONTO

ORDER BY D.CODIGO_EMPRESA, D.TIPO_CONTRATO, D.CODIGO_CONTRATO, D.CODIGO_SITUACAO
)X2
)X3
LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO c on X3.CODIGO_EMPRESA = c.codigo_empresa and X3.TIPO_CONTRATO = C.TIPO_CONTRATO AND X3.CODIGO_CONTRATO = C.CODIGO
LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO SP ON X3.CODIGO_SITUACAO = SP.CODIGO  
LEFT OUTER JOIN ARTERH.RHPLCS_CARGO CC ON CC.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND CC.CODIGO = C.cod_cargo_comiss
--INICIO NOVO 28/3/20
left outer join ARTERH.RHTABS_VINCULO_EMP V ON V.CODIGO = c.VINCULO
LEFT OUTER JOIN (select * from ARTERH.RHTABS_ITDS_SIST WHERE CODIGO_DOMINIO IN (select CODIGO_DOMINIO from ARTERH.RHTABS_COLS_SIST  where codigo_tabela = 'ARTERH.RHTABS_VINCULO_EMP' and codigo_coluna = 'TP_REGIME_TRAB_ESOCIAL'))RG_TRAB
ON RG_TRAB.CONTEUDO_INICIAL = V.TP_REGIME_TRAB_ESOCIAL
LEFT OUTER JOIN (select * from ARTERH.RHTABS_ITDS_SIST WHERE CODIGO_DOMINIO IN (select CODIGO_DOMINIO from ARTERH.RHTABS_COLS_SIST  where codigo_tabela = 'ARTERH.RHTABS_VINCULO_EMP' and codigo_coluna = 'TP_REGIME_PREV_ESOCIAL'))RG_PREV
ON RG_PREV.CONTEUDO_INICIAL = V.TP_REGIME_PREV_ESOCIAL
LEFT OUTER JOIN (select * from ARTERH.RHTABS_ITDS_SIST WHERE CODIGO_DOMINIO IN (select CODIGO_DOMINIO from ARTERH.RHTABS_COLS_SIST  where codigo_tabela = 'ARTERH.RHTABS_VINCULO_EMP' and codigo_coluna = 'COD_CATEG_ESOCIAL'))COD_CATEG
ON COD_CATEG.CONTEUDO_INICIAL = V.COD_CATEG_ESOCIAL
--FIM NOVO 28/3/20
LEFT OUTER JOIN (SELECT * FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP1')IFP1 ON IFP1.DADO_ORIGEM = SP.CODIGO--novo em 26/6/20
WHERE
C.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM ARTERH.RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = C.TIPO_CONTRATO AND AUX.CODIGO = C.CODIGO)

/*COMENTADO EM 11/12/21
and c.cod_cargo_efetivo not in ('000000000001730','000000000001761',
'000000000001763','000000000001765','000000000001766','000000000001767'
,'000000000003339','000000000003340','000000000009730','000000000009731')--tira os guardas municipais
*/

)X4 

WHERE X4.CODIGO_EMPRESA = C0.EMPRESA AND X4.TIPO_CONTRATO = C0.TIPO_CONTRATO AND  X4.CODIGO_CONTRATO = C0.MATRICULA

ORDER BY  X4.CODIGO_EMPRESA, X4.TIPO_CONTRATO, X4.CODIGO_CONTRATO, X4.CODIGO_SITUACAO


)
--INICIO-----C1-------------------------------------------------------------------------------- LOOP QUE ACUMULAR OS SALDOS DO BM DURANTE OS DIAS DO PERIODO-----------------------------------------
LOOP --INICIO C1

--dbms_output.put_line('--C1.MATRICULA: '||C1.MATRICULA);

vCONTADORDIA :=vCONTADORDIA+1;
vCONTADORGERAL :=vCONTADORGERAL+1;
--dbms_output.put_line('--LINHA_NUMERADA: ' ||vCONTADORGERAL ||' vCONTADORDIA: '||vCONTADORDIA);

vEMPRESA := C1.CODIGO_EMPRESA;
vTIPO_CONTRATO := C1.TIPO_CONTRATO;
vMATRICULA := C1.CODIGO_CONTRATO;
vFOLHA_ESPECIAL := c1.FOLHA_ESPECIAL;
vREGISTRO_PONTO := c1.REGISTRO_PONTO;
vCOD_VINCULO := c1.COD_VINCULO;
--vDATA := c1.DATA; --COMENTADO EM 10/11/20

--dbms_output.put_line(C1.SITUACAO||'-'||C1.TIPO_FOLGA||'-'||C1.PREVISTO||'-'||C1.ORIGEM||'-'||C1.ORDEM_SIT_PONTO_NO_DIA||'-'||C1.TIPO_REFERENCIA ||'-'|| C1.TIPO_SITUACAO ||'-'|| C1.CODIGO_EMPRESA ||'-'|| C1.TIPO_CONTRATO ||'-'|| C1.CODIGO_CONTRATO ||'-'||C1.DATA ||'-'|| C1.CODIGO_SITUACAO||'-'|| C1.SITUACAO_PONTO ||'-'|| C1.REFERENCIA ||'-'|| C1.LOGIN_USUARIO ||'-'|| C1.DT_ULT_ALTER_USUA);

-----------------------------------INICIO--ACUMULADO DE HORAS NORMAIS
IF C1.TIPO_REFERENCIA = 'H' AND C1.TIPO_SITUACAO = 'N' AND C1.CODIGO_SITUACAO <> '1002' THEN
vACUMULADO_H_NORMAIS := vACUMULADO_H_NORMAIS + C1.REFERENCIA;
--dbms_output.put_line('--vACUMULADO_H_NORMAIS: '||vACUMULADO_H_NORMAIS|| '+ C1.REFERENCIA: '||C1.REFERENCIA);
END IF;
-------------------------------------FIM--ACUMULADO DE HORAS NORMAIS


-----------------------------------------INICIO--ACUMULADO DE HORAS EXCEDIDAS
IF C1.TIPO_REFERENCIA = 'H' AND C1.TIPO_SITUACAO = 'N' AND C1.CODIGO_SITUACAO = '1002' THEN
vACUMULADO_H_EXCEDIDAS := vACUMULADO_H_EXCEDIDAS + C1.REFERENCIA;
--dbms_output.put_line('--vACUMULADO_H_EXCEDIDAS: '||vACUMULADO_H_EXCEDIDAS|| '+ C1.REFERENCIA: '||C1.REFERENCIA);
END IF;
-----------------------------------------------------FIM--ACUMULADO DE HORAS EXCEDIDAS


---------------------------------------INICIO--ACUMULADO DE HORAS DIFERENCIADAS 
IF C1.TIPO_REFERENCIA = 'H' AND C1.TIPO_SITUACAO = 'F' AND C1.CODIGO_SITUACAO = '1001' THEN
vACUMULADO_H_DIFERENCIAS := vACUMULADO_H_DIFERENCIAS + C1.REFERENCIA;
--dbms_output.put_line('--vACUMULADO_H_DIFERENCIAS: '||vACUMULADO_H_DIFERENCIAS|| '+ C1.REFERENCIA: '||C1.REFERENCIA);
END IF;
-------------------------------------FIM--ACUMULADO DE HORAS DIFERENCIADAS 


-----------------------------------------------------------------INICIO--ACUMULADO DE HORAS PREVISTAS
---------------------------------------------------------------FIM--ACUMULADO DE HORAS PREVISTAS


--------------------------------------------------------INICIO--ACUMULADO DE FALTAS
IF C1.TIPO_REFERENCIA = 'D' AND C1.TIPO_SITUACAO = 'F' AND C1.CODIGO_SITUACAO = '0020' THEN
vACUMULADO_FALTAS := vACUMULADO_FALTAS + C1.REFERENCIA;
--dbms_output.put_line('--vACUMULADO_FALTAS: '||vACUMULADO_FALTAS|| '+ C1.REFERENCIA: '||C1.REFERENCIA);
END IF;
----------------------------------------------------------FIM--ACUMULADO DE FALTAS

------------------------------------------ACUMULADO DE USO DO BANCO DE HORAS --NOVO EM 25/6/20
--vBH_DEBITO := C1.BH_DEBITO ;--COMENTADO 10/11/20 JÁ DEFINIDO NO C0

---------------------------------------------ACUMULO DE DESCONTO 
--vDESCONTO := C1.DESCONTO ; --NOVO EM 24/6  --COMENTADO 10/11/20 JÁ DEFINIDO NO C0



--/*
END LOOP; --C1
--FIM----C1---------------------------------------------------------------------------------------FIM LOOP QUE ACUMULAR OS SALDOS DO BM-----------------------------------------


dbms_output.put_line('--********************************TOTAIS DO MES******************************');
dbms_output.put_line('--MATRICULA: '||vMATRICULA ||' vFOLHA_ESPECIAL: ' || vFOLHA_ESPECIAL || ' vREGISTRO_PONTO:' ||vREGISTRO_PONTO || ' vCOD_VINCULO:' ||vCOD_VINCULO );
dbms_output.put_line('--vPREVISTO: '|| vPREVISTO||
--' vMEDIA_CARGA_DIA:' ||vMEDIA_CARGA_DIA||
' vACUMULADO_FALTAS: '|| vACUMULADO_FALTAS || ' vACUMULADO_PREVISTO: ' || vACUMULADO_PREVISTO || ' vDESCONTO: ' || vDESCONTO || ' vBH_DEBITO: '||vBH_DEBITO);
dbms_output.put_line('--vACUMULADO_H_NORMAIS: '||vACUMULADO_H_NORMAIS||' vACUMULADO_H_DIFERENCIAS: '|| vACUMULADO_H_DIFERENCIAS||' vACUMULADO_H_EXCEDIDAS: ' ||vACUMULADO_H_EXCEDIDAS ||' vRESULTADO_MES:' ||vRESULTADO_MES);
dbms_output.put_line('--********************************TOTAIS DO MES******************************');

----FIM-----------------------------------------POR BM

--INICIO-------*********************************************************PARTE NOVA DE 11/11/20****************************************************------------------------------
IF vFOLHA_ESPECIAL = 'NAO' AND vREGISTRO_PONTO NOT IN ('0110','0120','0150','0160','0200') AND vCOD_VINCULO <>'0009' --novo em 30/3/20--TIRAR ESTAGIARIOS, PESSOAS FOLHA ESPECIAL E NÂO USAR IFPONTO
AND vTIPO_FECHAMENTO = 'COMPENSACAO_CARGA_HORARIA' 
AND vDESCONTO = 0 
and vACUMULADO_FALTAS = 0
THEN
--INICIO-------------------------CENARIO 1
dbms_output.put_line('--CENARIO 1 FAZER NADA DESCONTO = '||vDESCONTO ||' FALTAS = '||vACUMULADO_FALTAS * vPREVISTO);
dbms_output.put_line('--XCENARIO 1 FAZER NADA DESCONTO SEM DESCONTO E SEM FALTAS '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 1 FAZER NADA DESCONTO SEM DESCONTO E SEM FALTAS',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
--FIM-------------------------CENARIO 1

--INICIO-------------------------CENARIO 2
ELSIF vFOLHA_ESPECIAL = 'NAO' AND vREGISTRO_PONTO NOT IN ('0110','0120','0150','0160','0200') AND vCOD_VINCULO <>'0009' --novo em 30/3/20--TIRAR ESTAGIARIOS, PESSOAS FOLHA ESPECIAL E NÂO USAR IFPONTO
AND vTIPO_FECHAMENTO = 'COMPENSACAO_CARGA_HORARIA' 
AND vDESCONTO > 0 
and vACUMULADO_FALTAS = 0
THEN
--dbms_output.put_line('--CENARIO 2 SEM FALTAS GRAVAR O DESCONTO TODO =  '||vDESCONTO ||'COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO');
dbms_output.put_line('--XCENARIO 2 SEM FALTAS GRAVAR O DESCONTO TODO =  vDESCONTO COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 2 SEM FALTAS GRAVAR O DESCONTO TODO =  vDESCONTO COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
--vNUMERO := TO_NUMBER(vDESCONTO) ;
vNUMERO := ROUND(vDESCONTO,2) ;
vSTRING := CASE WHEN INSTR(vNUMERO,',',1,1) = 0 THEN TO_CHAR(vNUMERO) WHEN INSTR(vNUMERO,',',1,1) <> 0 THEN TO_CHAR(SUBSTR(vNUMERO,1,INSTR(vNUMERO,',',1,1)-1) ||'.'||SUBSTR(vNUMERO,INSTR(vNUMERO,',' ,1,1)+1, LENGTH(vNUMERO))) end ;
dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(vEMPRESA,4,0) ||''','''|| LPAD(vTIPO_CONTRATO,4,0) ||''','''|| LPAD(vMATRICULA,15,0) ||''', TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY''),''1013'',ROUND('|| vSTRING||',2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(vEMPRESA,4,0), LPAD(vTIPO_CONTRATO,4,0), LPAD(vMATRICULA,15,0), vDATA_FIM, '1013',ROUND(vNUMERO,2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;  
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION
--FIM   -------------------------CENARIO 2
--/*
--INICIO-------------------------CENARIOS 3
ELSIF vFOLHA_ESPECIAL = 'NAO' AND vREGISTRO_PONTO NOT IN ('0110','0120','0150','0160','0200') AND vCOD_VINCULO <>'0009' --novo em 30/3/20--TIRAR ESTAGIARIOS, PESSOAS FOLHA ESPECIAL E NÂO USAR IFPONTO
AND vTIPO_FECHAMENTO = 'COMPENSACAO_CARGA_HORARIA' 
AND vDESCONTO > 0 
and vACUMULADO_FALTAS > 0
THEN
--dbms_output.put_line('--CENARIO 2 SEM FALTAS GRAVAR O DESCONTO TODO =  '||vDESCONTO ||'COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO');
--dbms_output.put_line('--XCENARIO 2 SEM FALTAS GRAVAR O DESCONTO TODO = vDESCONTO COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
    -----------------------------------INICIO IF DOS CENARIOS 3
-- /* 
    IF ROUND(vDESCONTO,2) > (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN
    --IF TRUNC(vDESCONTO) > (TRUNC(vACUMULADO_FALTAS) * TRUNC(vPREVISTO)) THEN
    --dbms_output.put_line('--CENARIO 3.1 DESCONTO MAIOR QUE HORAS DE FALTAS, DEIXA TODAS AS FALTAS E GRAVAR A DIF DESCONTO - HORAS DE FALTAS =  '|| '/*vDESCONTO - (vACUMULADO_FALTAS * vPREVISTO)*/' ||'COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO');
    dbms_output.put_line('--XCENARIO 3.1 DESCONTO MAIOR QUE HORAS DE FALTAS, DEIXA TODAS AS FALTAS E GRAVAR A DIF DESCONTO - HORAS DE FALTAS COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 3.1 DESCONTO MAIOR QUE HORAS DE FALTAS, DEIXA TODAS AS FALTAS E GRAVAR A DIF DESCONTO - HORAS DE FALTAS COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

  --vNUMERO := TO_NUMBER(vDESCONTO) - (TO_NUMBER(vACUMULADO_FALTAS) * TO_NUMBER(vPREVISTO)) ;
    vNUMERO := ROUND(vDESCONTO,2) - (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) ;
    vSTRING := CASE WHEN INSTR(vNUMERO,',',1,1) = 0 THEN TO_CHAR(vNUMERO) WHEN INSTR(vNUMERO,',',1,1) <> 0 THEN TO_CHAR(SUBSTR(vNUMERO,1,INSTR(vNUMERO,',',1,1)-1) ||'.'||SUBSTR(vNUMERO,INSTR(vNUMERO,',' ,1,1)+1, LENGTH(vNUMERO))) end ;
    dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(vEMPRESA,4,0) ||''','''|| LPAD(vTIPO_CONTRATO,4,0) ||''','''|| LPAD(vMATRICULA,15,0) ||''', TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY''),''1013'',ROUND('|| vSTRING||',2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(vEMPRESA,4,0), LPAD(vTIPO_CONTRATO,4,0), LPAD(vMATRICULA,15,0), vDATA_FIM, '1013',ROUND(vNUMERO,2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;  
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION

    ELSIF ROUND(vDESCONTO,2) = (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN
    --ELSIF TRUNC(vDESCONTO) = (TRUNC(vACUMULADO_FALTAS) * TRUNC(vPREVISTO)) THEN
    --dbms_output.put_line('--CENARIO 3.2 TEVE DESCONTO IGUAL AO TOTAL DE HORAS DE FALTAS NAO FAZER NADA');
    dbms_output.put_line('--XCENARIO 3.2 TEVE DESCONTO IGUAL AO TOTAL DE HORAS DE FALTAS NAO FAZER NADA '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 3.2 TEVE DESCONTO IGUAL AO TOTAL DE HORAS DE FALTAS NAO FAZER NADA',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

    --dbms_output.put_line('UPDATE ARTERH.RHPONT_RES_SIT_DIA  SET CODIGO_SITUACAO = ''1004'' WHERE CODIGO_EMPRESA  = '''||LPAD(vEMPRESA,4,0) ||''' AND TIPO_CONTRATO = '''|| LPAD(vTIPO_CONTRATO,4,0)||''' AND CODIGO_CONTRATO = '''||LPAD(vMATRICULA,15,0) ||''' AND TRUNC(DATA) BETWEEN TO_DATE('''|| trunc(vDATA_INICIO) ||''',''DD/MM/YYYY'') AND TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''0020''; COMMIT;' );  

    ELSIF ROUND(vDESCONTO,2) < (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN
    --ELSIF TRUNC(vDESCONTO) < (TRUNC(vACUMULADO_FALTAS) * TRUNC(vPREVISTO)) THEN
    --dbms_output.put_line('--CENARIO 3.3 1-COMPENSAR AS FALTAS PAGAS, 2-SE HAVER SALDO FRACIONADO DE DIA ESTORNAR FALTA DO DIA, GRAVAR DIFERENCIADA E PAGA NO DIA, 3-O RESTANTE DO SALDO DO DESCONTO GRAVAR NO ULTIMO DIA 1013');
    dbms_output.put_line('--XCENARIO 3.3 1-COMPENSAR AS FALTAS PAGAS, 2-SE HAVER SALDO FRACIONADO DE DIA ESTORNAR FALTA DO DIA, GRAVAR DIFERENCIADA E PAGA NO DIA, 3-O RESTANTE DO SALDO DO DESCONTO GRAVAR NO ULTIMO DIA 1013 '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 3.3 1-COMPENSAR AS FALTAS PAGAS, 2-SE HAVER SALDO FRACIONADO DE DIA ESTORNAR FALTA DO DIA, GRAVAR DIFERENCIADA E PAGA NO DIA, 3-O RESTANTE DO SALDO DO DESCONTO GRAVAR NO ULTIMO DIA 1013',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

    vACUMULADO_HORAS_DE_FALTA := vACUMULADO_FALTAS * vPREVISTO; -- testes 29/12/20
---- testes 29/12/20    vACUMULADO_HORAS_DE_FALTA := ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2) ;
    dbms_output.put_line('--vACUMULADO_HORAS_DE_FALTA: '||vACUMULADO_HORAS_DE_FALTA ||' := vACUMULADO_FALTAS * vPREVISTO'||vACUMULADO_FALTAS||'*'||vPREVISTO) ;

      -------------------INICIO WHILE CENARIO 3.3
      --WHILE vACUMULADO_HORAS_DE_FALTA >= vPREVISTO 
      --LOOP
FOR C2 IN (
SELECT 
E.turno_fer_g_trab,--novo 9/12/21
CASE WHEN OC.CODIGO IS NOT NULL AND X.SITUACAO IN ('TRABALHANDO','FOLGA') AND X.COD_JUSTIFICATIVA_PONTO IS NULL  THEN 'SIM' ELSE 'NAO' END ERRO_IFPONTO_OCORREN_ESPELHO,--NOVO EM 25/6/20
X.* FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA X LEFT OUTER JOIN (select OC.* from PONTO_ELETRONICO.IFPONTO_OCORRENCIAS OC WHERE OC.DATA_PROCESSAMENTO IS NULL
AND LPAD(OC.EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
)OC
ON X.EMPRESA = OC.EMPRESA AND X.TIPO_CONTRATO = OC.TIPO_CONTRATO AND X.MATRICULA = OC.MATRICULA AND TRUNC(X.DATA) BETWEEN TRUNC(OC.DTINICIO) AND TRUNC(DTFIM)
LEFT OUTER JOIN PONTO_ELETRONICO.IFPONTO_ESCALA_PADRAO EP ON EP.CODIGO = X.COD_ESCALA_PADRAO--novo 9/12/21
LEFT OUTER JOIN ARTERH.RHPONT_ESCALA E ON E.CODIGO_EMPRESA = LPAD(SUBSTR(EP.CODIGO_LEGADO,1,2),4,0) AND E.CODIGO = SUBSTR(EP.CODIGO_LEGADO,3,4)--novo 9/12/21
where x.data_processamento is null--novo em 14/8/20
AND LPAD(X.EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
and X.EMPRESA = vEMPRESA AND X.TIPO_CONTRATO = vTIPO_CONTRATO AND  x.matricula = vMATRICULA ORDER BY DATA
)
LOOP --INICIO C2
    ---INICIO--------------------------------------FALTA SEM MARCACAO INCLUINDO COM 1 MARCACAO APENAS---------------------------------------------
IF
--inicio--novo 9/12/21
(
  (C2.SITUACAO = 'TRABALHANDO' AND C2.TIPO_FOLGA in ('TRABALHANDO') AND C2.ACEITO  in('NAO AVALIADO','NAO ABONADO') AND C2.ENTRADA = 0 AND C2.turno_fer_g_trab = 'N')
  OR
  (C2.SITUACAO = 'TRABALHANDO' AND C2.TIPO_FOLGA in ('TRABALHANDO','FERIADO','PONTO_FACULTATIVO') AND C2.ACEITO  in('NAO AVALIADO','NAO ABONADO') AND C2.ENTRADA = 0  AND C2.turno_fer_g_trab = 'S')
)
--fim--novo 9/12/21

/*--inicio--comentado em 9/12/21
C2.situacao = 'TRABALHANDO' AND C2.TIPO_FOLGA in ('TRABALHANDO','FERIADO') --incluido o 'FERIADO' EM 16/2/21 
AND C2.ACEITO  in('NAO AVALIADO','NAO ABONADO') --incluido o 'NAO ABONADO' EM 16/2/21
AND (C2.H_NORMAIS IS NULL OR C2.H_NORMAIS = 0) --NOVO EM 16/8/20 20H54
--COMENTADO EM 16/8/20 20H53--AND C2.ENTRADA = 0 
AND C2.ENTRADA = 0 --NOVO EM 31/8/20 SO PEGAR FALTA MESMO SEM MARCACOES
*/--fim-comentado em 9/12/21
AND C2.ERRO_IFPONTO_OCORREN_ESPELHO = 'NAO' --NOVO EM 25/6/20
THEN 
dbms_output.put_line('--dia da falta: '|| C2.DATA);


  --IF    vACUMULADO_HORAS_DE_FALTA > vDESCONTO AND vACUMULADO_HORAS_DE_FALTA - vDESCONTO >= vPREVISTO THEN 
  IF    ROUND(vACUMULADO_HORAS_DE_FALTA,2) > ROUND(vDESCONTO,2) AND ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vDESCONTO,2) >= ROUND(vPREVISTO,2) THEN 
--  IF    TRUNC(vACUMULADO_HORAS_DE_FALTA) > TRUNC(vDESCONTO) AND TRUNC(vACUMULADO_HORAS_DE_FALTA) - TRUNC(vDESCONTO) >= TRUNC(vPREVISTO) THEN 
  dbms_output.put_line('--EXCLUI: 0020-FALTA e CRIAR 1004-FALTA COMPENSADA: '|| c2.DATA);
  dbms_output.put_line('DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = ''F'' AND CODIGO_EMPRESA = ''' ||LPAD(C2.EMPRESA,4,0) ||''' AND TIPO_CONTRATO = ''' || LPAD(C2.TIPO_CONTRATO,4,0) ||''' AND CODIGO_CONTRATO = '''|| LPAD(C2.MATRICULA,15,0) ||'''AND TRUNC(DATA) = TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''0020''; COMMIT;' );  
  DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = 'F' AND CODIGO_EMPRESA = LPAD(C2.EMPRESA,4,0) AND TIPO_CONTRATO = LPAD(C2.TIPO_CONTRATO,4,0) AND CODIGO_CONTRATO = LPAD(C2.MATRICULA,15,0) AND TRUNC(DATA) = C2.DATA AND CODIGO_SITUACAO = '0020'; COMMIT;    
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(C2.EMPRESA,4,0) ||''','''|| LPAD(C2.TIPO_CONTRATO,4,0) ||''','''|| LPAD(C2.MATRICULA,15,0) ||''', TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY''),''1004'', 1, ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(C2.EMPRESA,4,0), LPAD(C2.TIPO_CONTRATO,4,0), LPAD(C2.MATRICULA,15,0), C2.DATA, '1004', 1, 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;  
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION

  vACUMULADO_HORAS_DE_FALTA := vACUMULADO_HORAS_DE_FALTA - vPREVISTO;----******************DIMINUINDO O SALDO DA FALTAS -- testes 29/12/20
-- testes 29/12/20  vACUMULADO_HORAS_DE_FALTA := ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vPREVISTO,2);----******************DIMINUINDO O SALDO DA FALTAS

  dbms_output.put_line('--RESTANTES vACUMULADO_HORAS_DE_FALTA: '|| vACUMULADO_HORAS_DE_FALTA);

--  ELSIF vACUMULADO_HORAS_DE_FALTA > vDESCONTO AND (vACUMULADO_HORAS_DE_FALTA - vDESCONTO) < vPREVISTO THEN  
  ELSIF ROUND(vACUMULADO_HORAS_DE_FALTA,2) > ROUND(vDESCONTO,2) AND (ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vDESCONTO,2)) < ROUND(vPREVISTO,2) THEN 
BEGIN --EXCEPTION
--  ELSIF TRUNC(vACUMULADO_HORAS_DE_FALTA) > TRUNC(vDESCONTO) AND (TRUNC(vACUMULADO_HORAS_DE_FALTA) - TRUNC(vDESCONTO)) < TRUNC(vPREVISTO) THEN 
  dbms_output.put_line('--ESTORNO 0020-FALTA CRIANDO 1015 ESTORNO FALTA, 1001 HORAS DIFERENCIADAS NO DIA COM O SALDO RESTANTE: '|| c2.DATA||' E NO ULTIMO DIA DO PERIODO A 1013 TOTAL H DIFE COM SALDO: '||vSALDO_HORAS_FALTA_COMP);
  dbms_output.put_line('DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = ''F'' AND CODIGO_EMPRESA = ''' ||LPAD(C2.EMPRESA,4,0) ||''' AND TIPO_CONTRATO = ''' || LPAD(C2.TIPO_CONTRATO,4,0) ||''' AND CODIGO_CONTRATO = '''|| LPAD(C2.MATRICULA,15,0) ||'''AND TRUNC(DATA) = TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''1015''; COMMIT;' );  
  DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = 'F' AND CODIGO_EMPRESA = LPAD(C2.EMPRESA,4,0) AND TIPO_CONTRATO = LPAD(C2.TIPO_CONTRATO,4,0) AND CODIGO_CONTRATO = LPAD(C2.MATRICULA,15,0) AND TRUNC(DATA) = C2.DATA AND CODIGO_SITUACAO = '1015'; COMMIT;  
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(C2.EMPRESA,4,0) ||''','''|| LPAD(C2.TIPO_CONTRATO,4,0) ||''','''|| LPAD(C2.MATRICULA,15,0) ||''', TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY''),''1015'', 1, ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(C2.EMPRESA,4,0), LPAD(C2.TIPO_CONTRATO,4,0), LPAD(C2.MATRICULA,15,0), C2.DATA, '1015', 1, 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;   
  vNUMERO := TO_NUMBER(vPREVISTO)- (TO_NUMBER(vACUMULADO_HORAS_DE_FALTA)-TO_NUMBER(vDESCONTO)) ;-- testes 29/12/20
-- testes 29/12/20  vNUMERO := ROUND(vPREVISTO)- (ROUND(vACUMULADO_HORAS_DE_FALTA)-ROUND(vDESCONTO)) ;
  vSTRING := CASE WHEN INSTR(vNUMERO,',',1,1) = 0 THEN TO_CHAR(vNUMERO) WHEN INSTR(vNUMERO,',',1,1) <> 0 THEN TO_CHAR(SUBSTR(vNUMERO,1,INSTR(vNUMERO,',',1,1)-1) ||'.'||SUBSTR(vNUMERO,INSTR(vNUMERO,',' ,1,1)+1, LENGTH(vNUMERO))) end ;
  dbms_output.put_line('DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = ''F'' AND CODIGO_EMPRESA = ''' ||LPAD(C2.EMPRESA,4,0) ||''' AND TIPO_CONTRATO = ''' || LPAD(C2.TIPO_CONTRATO,4,0) ||''' AND CODIGO_CONTRATO = '''|| LPAD(C2.MATRICULA,15,0) ||'''AND TRUNC(DATA) = TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''1001''; COMMIT;' );  
  DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = 'F' AND CODIGO_EMPRESA =  LPAD(C2.EMPRESA,4,0)  AND TIPO_CONTRATO =   LPAD(C2.TIPO_CONTRATO,4,0)  AND CODIGO_CONTRATO =  LPAD(C2.MATRICULA,15,0) AND TRUNC(DATA) = C2.DATA AND CODIGO_SITUACAO = '1001'; COMMIT;
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(C2.EMPRESA,4,0) ||''','''|| LPAD(C2.TIPO_CONTRATO,4,0) ||''','''|| LPAD(C2.MATRICULA,15,0) ||''', TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY''),''1001'',ROUND('||vSTRING ||', 2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' ); 
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(C2.EMPRESA,4,0) , LPAD(C2.TIPO_CONTRATO,4,0) , LPAD(C2.MATRICULA,15,0), C2.DATA, '1001',ROUND(vNUMERO, 2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
  --inicio novo nesse local tambem em 10/11/20
  dbms_output.put_line('----GRAVA vSALDO_HORAS_FALTA_COMP: '||vNUMERO||' 1013-TOTAL HORAS DIFERENCIADAS PERIODO: '||vSTRING);
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(vEMPRESA,4,0) ||''','''|| LPAD(vTIPO_CONTRATO,4,0) ||''','''|| LPAD(vMATRICULA,15,0) ||''', TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY''),''1013'',ROUND('|| vSTRING||',2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(vEMPRESA,4,0) , LPAD(vTIPO_CONTRATO,4,0) , LPAD(vMATRICULA,15,0), vDATA_FIM, '1013',ROUND(vNUMERO,2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
 --fim novo nesse local tambem em 10/11/20  
vACUMULADO_HORAS_DE_FALTA := vACUMULADO_HORAS_DE_FALTA - vPREVISTO;----******************DIMINUINDO O SALDO DA FALTAS-- testes 29/12/20
-- testes 29/12/20  vACUMULADO_HORAS_DE_FALTA := ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vPREVISTO,2);----******************DIMINUINDO O SALDO DA FALTAS
  dbms_output.put_line('--RESTANTES vACUMULADO_HORAS_DE_FALTA: '|| vACUMULADO_HORAS_DE_FALTA);
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION
  END IF;

END IF;
END LOOP; --FIM DO C2
    END IF; ----------------------------------FIM IF DOS CENARIOS 3
--*/
--FIM   -------------------------CENARIOS 3

--INICIO---NOVO EM 24/11/20----------------------CENARIOS 4
ELSIF vFOLHA_ESPECIAL = 'NAO' AND vREGISTRO_PONTO NOT IN ('0110','0120','0150','0160','0200') AND vCOD_VINCULO <>'0009' --novo em 30/3/20--TIRAR ESTAGIARIOS, PESSOAS FOLHA ESPECIAL E NÂO USAR IFPONTO
AND vTIPO_FECHAMENTO = 'COMPENSACAO_CARGA_HORARIA' 
AND vDESCONTO = 0 
and vACUMULADO_FALTAS > 0
THEN
--dbms_output.put_line('----CENARIO 4 COM FALTAS SEM DESCONTO COMPENSAR TODAS AS FALTAS DO PERIODO');
dbms_output.put_line('--XCENARIO 4 COM FALTAS SEM DESCONTO COMPENSAR TODAS AS FALTAS DO PERIODO'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 4 COM FALTAS SEM DESCONTO COMPENSAR TODAS AS FALTAS DO PERIODO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
dbms_output.put_line('UPDATE ARTERH.RHPONT_RES_SIT_DIA  SET CODIGO_SITUACAO = ''1004'' WHERE CODIGO_EMPRESA  = '''||LPAD(vEMPRESA,4,0) ||''' AND TIPO_CONTRATO = '''|| LPAD(vTIPO_CONTRATO,4,0)||''' AND CODIGO_CONTRATO = '''||LPAD(vMATRICULA,15,0) ||''' AND TRUNC(DATA) BETWEEN TO_DATE('''|| trunc(vDATA_INICIO) ||''',''DD/MM/YYYY'') AND TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''0020''; COMMIT;' );  
UPDATE ARTERH.RHPONT_RES_SIT_DIA  SET CODIGO_SITUACAO = '1004' WHERE CODIGO_EMPRESA  = LPAD(vEMPRESA,4,0) AND TIPO_CONTRATO = LPAD(vTIPO_CONTRATO,4,0) AND CODIGO_CONTRATO = LPAD(vMATRICULA,15,0) AND TRUNC(DATA) BETWEEN vDATA_INICIO AND vDATA_FIM AND CODIGO_SITUACAO = '0020'; COMMIT;--ERRO NO DIA 12/1/23 NAO HAVIA HABILITADO O COMANDO  

--FIM---NOVO EM 24/11/20----------------------CENARIOS 4

--INICIO---------------------------------------------AJUSTES EM 9/12/21

--vCONTADORBM: 41 C0.MATRICULA: 000000000416235
--********************************TOTAIS DO MES******************************
--MATRICULA: 000000000416235 vFOLHA_ESPECIAL: NAO vREGISTRO_PONTO:0100 vCOD_VINCULO:0002
--vPREVISTO: 6 vACUMULADO_FALTAS: 4 vACUMULADO_PREVISTO: 0 vDESCONTO: ,62 vBH_DEBITO: 24
--vACUMULADO_H_NORMAIS: 101,39 vACUMULADO_H_DIFERENCIAS: ,61 vACUMULADO_H_EXCEDIDAS: 0 vRESULTADO_MES:0
--********************************TOTAIS DO MES******************************
--XCENARIO 0 - NAO FAZ PARTE DA COMPENSACAO DA PBH COMPENSACAO_DIARIA|0001|0001|000000000416235|31|6|24|,616666|1|Diária|NAO|0100|0002|6|4|0|,62|24|101,39|,61|0

ELSIF vFOLHA_ESPECIAL = 'NAO' AND vREGISTRO_PONTO NOT IN ('0110','0120','0150','0160','0200') AND vCOD_VINCULO <>'0009' --novo em 30/3/20--TIRAR ESTAGIARIOS, PESSOAS FOLHA ESPECIAL E NÂO USAR IFPONTO
AND vTIPO_FECHAMENTO = 'COMPENSACAO_DIARIA' AND vBH_DEBITO > 0 THEN


    -----------------------------------INICIO IF DOS CENARIOS 5
-- /* 
    IF ROUND(vDESCONTO,2) > 0 AND ROUND(vACUMULADO_FALTAS,2)= 0 THEN ---USOU BANCO, TEM DESCONTO AINDA MAS NAO TEVE FALTAS

    dbms_output.put_line('--XCENARIO 5.1 SEM FALTAS GRAVAR O DESCONTO TODO =  vDESCONTO COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 5.1 SEM FALTAS GRAVAR O DESCONTO TODO =  vDESCONTO COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
--vNUMERO := TO_NUMBER(vDESCONTO) ;
vNUMERO := ROUND(vDESCONTO,2) ;
vSTRING := CASE WHEN INSTR(vNUMERO,',',1,1) = 0 THEN TO_CHAR(vNUMERO) WHEN INSTR(vNUMERO,',',1,1) <> 0 THEN TO_CHAR(SUBSTR(vNUMERO,1,INSTR(vNUMERO,',',1,1)-1) ||'.'||SUBSTR(vNUMERO,INSTR(vNUMERO,',' ,1,1)+1, LENGTH(vNUMERO))) end ;
dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(vEMPRESA,4,0) ||''','''|| LPAD(vTIPO_CONTRATO,4,0) ||''','''|| LPAD(vMATRICULA,15,0) ||''', TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY''),''1013'',ROUND('|| vSTRING||',2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(vEMPRESA,4,0) , LPAD(vTIPO_CONTRATO,4,0) , LPAD(vMATRICULA,15,0), vDATA_FIM ,'1013',ROUND(vNUMERO,2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION

    ELSIF ROUND(vDESCONTO,2) = 0 AND ROUND(vACUMULADO_FALTAS,2) > 0 THEN --USOU BANCO, ZEROU OS DESCONTOS MAS HAVIA FALTAS
    dbms_output.put_line('--XCENARIO 5.2 COM FALTAS E BH_DEBITO SEM DESCONTO COMPENSAR TODAS AS FALTAS DO PERIODO'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 5.2 COM FALTAS E BH_DEBITO SEM DESCONTO COMPENSAR TODAS AS FALTAS DO PERIODO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
dbms_output.put_line('UPDATE ARTERH.RHPONT_RES_SIT_DIA  SET CODIGO_SITUACAO = ''1004'' WHERE CODIGO_EMPRESA  = '''||LPAD(vEMPRESA,4,0) ||''' AND TIPO_CONTRATO = '''|| LPAD(vTIPO_CONTRATO,4,0)||''' AND CODIGO_CONTRATO = '''||LPAD(vMATRICULA,15,0) ||''' AND TRUNC(DATA) BETWEEN TO_DATE('''|| trunc(vDATA_INICIO) ||''',''DD/MM/YYYY'') AND TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''0020''; COMMIT;' );  
UPDATE ARTERH.RHPONT_RES_SIT_DIA  SET CODIGO_SITUACAO = '1004' WHERE CODIGO_EMPRESA  = LPAD(vEMPRESA,4,0) AND TIPO_CONTRATO = LPAD(vTIPO_CONTRATO,4,0) AND CODIGO_CONTRATO = LPAD(vMATRICULA,15,0) AND TRUNC(DATA) BETWEEN vDATA_INICIO AND vDATA_FIM AND CODIGO_SITUACAO = '0020'; COMMIT;--ERRO NO DIA 12/1/23 NAO HAVIA HABILITADO O COMANDO  

    ELSIF ROUND(vDESCONTO,2) > 0 AND ROUND(vDESCONTO,2) > (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN --USOU BANCO, TEM DESCONTO AINDA E SER MAIOR QUE TODAS AS FALTAS
--  ELSIF ROUND(vDESCONTO,2) > (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN
    dbms_output.put_line('--XCENARIO 5.3.1 DESCONTO MAIOR QUE HORAS DE FALTAS, DEIXA TODAS AS FALTAS E GRAVAR A DIF DESCONTO - HORAS DE FALTAS COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 5.3.1 DESCONTO MAIOR QUE HORAS DE FALTAS, DEIXA TODAS AS FALTAS E GRAVAR A DIF DESCONTO - HORAS DE FALTAS COMO 1013-TOTAL HORAS DIFERENCIADAS PERÍODO NO ULTIMO DIA DO PERIODO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
    vNUMERO := ROUND(vDESCONTO,2) - (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) ;
    vSTRING := CASE WHEN INSTR(vNUMERO,',',1,1) = 0 THEN TO_CHAR(vNUMERO) WHEN INSTR(vNUMERO,',',1,1) <> 0 THEN TO_CHAR(SUBSTR(vNUMERO,1,INSTR(vNUMERO,',',1,1)-1) ||'.'||SUBSTR(vNUMERO,INSTR(vNUMERO,',' ,1,1)+1, LENGTH(vNUMERO))) end ;
    dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(vEMPRESA,4,0) ||''','''|| LPAD(vTIPO_CONTRATO,4,0) ||''','''|| LPAD(vMATRICULA,15,0) ||''', TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY''),''1013'',ROUND('|| vSTRING||',2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
    INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(vEMPRESA,4,0) , LPAD(vTIPO_CONTRATO,4,0) , LPAD(vMATRICULA,15,0), vDATA_FIM ,'1013', ROUND(vNUMERO,2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION

    ELSIF ROUND(vDESCONTO,2) > 0 AND ROUND(vDESCONTO,2) = (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN --USOU BANCO, TEM DESCONTO AINDA E SER IGUAL A TODAS AS FALTAS
--  ELSIF ROUND(vDESCONTO,2) = (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN
    dbms_output.put_line('--XCENARIO 5.3.2 TEVE DESCONTO IGUAL AO TOTAL DE HORAS DE FALTAS NAO FAZER NADA '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 5.3.2 TEVE DESCONTO IGUAL AO TOTAL DE HORAS DE FALTAS NAO FAZER NADA',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

    ELSIF ROUND(vDESCONTO,2) > 0 AND ROUND(vDESCONTO,2) < (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN --USOU BANCO, TEM DESCONTO AINDA E SER MENOR A TODAS AS FALTAS
--    ELSIF ROUND(vDESCONTO,2) < (ROUND(vACUMULADO_FALTAS,2) * ROUND(vPREVISTO,2)) THEN
    dbms_output.put_line('--XCENARIO 5.3.3 1-COMPENSAR AS FALTAS PAGAS, 2-SE HAVER SALDO FRACIONADO DE DIA ESTORNAR FALTA DO DIA, GRAVAR DIFERENCIADA E PAGA NO DIA, 3-O RESTANTE DO SALDO DO DESCONTO GRAVAR NO ULTIMO DIA 1013 '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 5.3.3 1-COMPENSAR AS FALTAS PAGAS, 2-SE HAVER SALDO FRACIONADO DE DIA ESTORNAR FALTA DO DIA, GRAVAR DIFERENCIADA E PAGA NO DIA, 3-O RESTANTE DO SALDO DO DESCONTO GRAVAR NO ULTIMO DIA 1013',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

    vACUMULADO_HORAS_DE_FALTA := vACUMULADO_FALTAS * vPREVISTO; -- testes 29/12/20
    dbms_output.put_line('--vACUMULADO_HORAS_DE_FALTA: '||vACUMULADO_HORAS_DE_FALTA ||' := vACUMULADO_FALTAS * vPREVISTO'||vACUMULADO_FALTAS||'*'||vPREVISTO) ;


      -------------------INICIO WHILE CENARIO 5.3.3
      --WHILE vACUMULADO_HORAS_DE_FALTA >= vPREVISTO 
      --LOOP
FOR C2 IN (
SELECT 
E.turno_fer_g_trab,--novo 9/12/21
CASE WHEN OC.CODIGO IS NOT NULL AND X.SITUACAO IN ('TRABALHANDO','FOLGA') AND X.COD_JUSTIFICATIVA_PONTO IS NULL  THEN 'SIM' ELSE 'NAO' END ERRO_IFPONTO_OCORREN_ESPELHO,--NOVO EM 25/6/20
X.* FROM PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA X LEFT OUTER JOIN (select OC.* from PONTO_ELETRONICO.IFPONTO_OCORRENCIAS OC WHERE OC.DATA_PROCESSAMENTO IS NULL
AND LPAD(OC.EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
)OC
ON X.EMPRESA = OC.EMPRESA AND X.TIPO_CONTRATO = OC.TIPO_CONTRATO AND X.MATRICULA = OC.MATRICULA AND TRUNC(X.DATA) BETWEEN TRUNC(OC.DTINICIO) AND TRUNC(DTFIM)
LEFT OUTER JOIN PONTO_ELETRONICO.IFPONTO_ESCALA_PADRAO EP ON EP.CODIGO = X.COD_ESCALA_PADRAO--novo 9/12/21
LEFT OUTER JOIN ARTERH.RHPONT_ESCALA E ON E.CODIGO_EMPRESA = LPAD(SUBSTR(EP.CODIGO_LEGADO,1,2),4,0) AND E.CODIGO = SUBSTR(EP.CODIGO_LEGADO,3,4)--novo 9/12/21
where x.data_processamento is null--novo em 14/8/20
AND LPAD(X.EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
and X.EMPRESA = vEMPRESA AND X.TIPO_CONTRATO = vTIPO_CONTRATO AND  x.matricula = vMATRICULA ORDER BY DATA
)
LOOP --INICIO C2
    ---INICIO--------------------------------------FALTA SEM MARCACAO INCLUINDO COM 1 MARCACAO APENAS---------------------------------------------
IF
--inicio--novo 9/12/21
(
  (C2.SITUACAO = 'TRABALHANDO' AND C2.TIPO_FOLGA in ('TRABALHANDO') AND C2.ACEITO  in('NAO AVALIADO','NAO ABONADO') AND C2.ENTRADA = 0 AND C2.turno_fer_g_trab = 'N')
  OR
  (C2.SITUACAO = 'TRABALHANDO' AND C2.TIPO_FOLGA in ('TRABALHANDO','FERIADO','PONTO_FACULTATIVO') AND C2.ACEITO  in('NAO AVALIADO','NAO ABONADO') AND C2.ENTRADA = 0  AND C2.turno_fer_g_trab = 'S')
)
--fim--novo 9/12/21

/*--inicio--comentado em 9/12/21
C2.situacao = 'TRABALHANDO' AND C2.TIPO_FOLGA in ('TRABALHANDO','FERIADO') --incluido o 'FERIADO' EM 16/2/21 
AND C2.ACEITO  in('NAO AVALIADO','NAO ABONADO') --incluido o 'NAO ABONADO' EM 16/2/21
AND (C2.H_NORMAIS IS NULL OR C2.H_NORMAIS = 0) --NOVO EM 16/8/20 20H54
--COMENTADO EM 16/8/20 20H53--AND C2.ENTRADA = 0 
AND C2.ENTRADA = 0 --NOVO EM 31/8/20 SO PEGAR FALTA MESMO SEM MARCACOES
*/--fim-comentado em 9/12/21
AND C2.ERRO_IFPONTO_OCORREN_ESPELHO = 'NAO' --NOVO EM 25/6/20
THEN 
dbms_output.put_line('--dia da falta: '|| C2.DATA);


  --IF    vACUMULADO_HORAS_DE_FALTA > vDESCONTO AND vACUMULADO_HORAS_DE_FALTA - vDESCONTO >= vPREVISTO THEN 
  IF    ROUND(vACUMULADO_HORAS_DE_FALTA,2) > ROUND(vDESCONTO,2) AND ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vDESCONTO,2) >= ROUND(vPREVISTO,2) THEN 
--  IF    TRUNC(vACUMULADO_HORAS_DE_FALTA) > TRUNC(vDESCONTO) AND TRUNC(vACUMULADO_HORAS_DE_FALTA) - TRUNC(vDESCONTO) >= TRUNC(vPREVISTO) THEN 
  dbms_output.put_line('--EXCLUI: 0020-FALTA e CRIAR 1004-FALTA COMPENSADA: '|| c2.DATA);
  dbms_output.put_line('DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = ''F'' AND CODIGO_EMPRESA = ''' ||LPAD(C2.EMPRESA,4,0) ||''' AND TIPO_CONTRATO = ''' || LPAD(C2.TIPO_CONTRATO,4,0) ||''' AND CODIGO_CONTRATO = '''|| LPAD(C2.MATRICULA,15,0) ||'''AND TRUNC(DATA) = TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''0020''; COMMIT;' );  
  DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = 'F' AND CODIGO_EMPRESA =  LPAD(C2.EMPRESA,4,0)  AND TIPO_CONTRATO =   LPAD(C2.TIPO_CONTRATO,4,0)  AND CODIGO_CONTRATO =  LPAD(C2.MATRICULA,15,0) AND TRUNC(DATA) = C2.DATA AND CODIGO_SITUACAO = '0020'; COMMIT;
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(C2.EMPRESA,4,0) ||''','''|| LPAD(C2.TIPO_CONTRATO,4,0) ||''','''|| LPAD(C2.MATRICULA,15,0) ||''', TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY''),''1004'', 1, ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(C2.EMPRESA,4,0) , LPAD(C2.TIPO_CONTRATO,4,0) , LPAD(C2.MATRICULA,15,0), C2.DATA, '1004', 1, 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION
  vACUMULADO_HORAS_DE_FALTA := vACUMULADO_HORAS_DE_FALTA - vPREVISTO;----******************DIMINUINDO O SALDO DA FALTAS -- testes 29/12/20
-- testes 29/12/20  vACUMULADO_HORAS_DE_FALTA := ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vPREVISTO,2);----******************DIMINUINDO O SALDO DA FALTAS

  dbms_output.put_line('--RESTANTES vACUMULADO_HORAS_DE_FALTA: '|| vACUMULADO_HORAS_DE_FALTA);

--  ELSIF vACUMULADO_HORAS_DE_FALTA > vDESCONTO AND (vACUMULADO_HORAS_DE_FALTA - vDESCONTO) < vPREVISTO THEN  
  ELSIF ROUND(vACUMULADO_HORAS_DE_FALTA,2) > ROUND(vDESCONTO,2) AND (ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vDESCONTO,2)) < ROUND(vPREVISTO,2) THEN 
--  ELSIF TRUNC(vACUMULADO_HORAS_DE_FALTA) > TRUNC(vDESCONTO) AND (TRUNC(vACUMULADO_HORAS_DE_FALTA) - TRUNC(vDESCONTO)) < TRUNC(vPREVISTO) THEN 
  dbms_output.put_line('--ESTORNO 0020-FALTA CRIANDO 1015 ESTORNO FALTA, 1001 HORAS DIFERENCIADAS NO DIA COM O SALDO RESTANTE: '|| c2.DATA||' E NO ULTIMO DIA DO PERIODO A 1013 TOTAL H DIFE COM SALDO: '||vSALDO_HORAS_FALTA_COMP);
  dbms_output.put_line('DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = ''F'' AND CODIGO_EMPRESA = ''' ||LPAD(C2.EMPRESA,4,0) ||''' AND TIPO_CONTRATO = ''' || LPAD(C2.TIPO_CONTRATO,4,0) ||''' AND CODIGO_CONTRATO = '''|| LPAD(C2.MATRICULA,15,0) ||'''AND TRUNC(DATA) = TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''1015''; COMMIT;' );  
  DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = 'F' AND CODIGO_EMPRESA =  LPAD(C2.EMPRESA,4,0)  AND TIPO_CONTRATO =   LPAD(C2.TIPO_CONTRATO,4,0)  AND CODIGO_CONTRATO =  LPAD(C2.MATRICULA,15,0) AND TRUNC(DATA) = C2.DATA AND CODIGO_SITUACAO = '1015'; COMMIT;  
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(C2.EMPRESA,4,0) ||''','''|| LPAD(C2.TIPO_CONTRATO,4,0) ||''','''|| LPAD(C2.MATRICULA,15,0) ||''', TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY''),''1015'', 1, ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
BEGIN --EXCEPTION
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(C2.EMPRESA,4,0) , LPAD(C2.TIPO_CONTRATO,4,0) , LPAD(C2.MATRICULA,15,0), C2.DATA, '1015', 1, 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
  vNUMERO := TO_NUMBER(vPREVISTO)- (TO_NUMBER(vACUMULADO_HORAS_DE_FALTA)-TO_NUMBER(vDESCONTO)) ;-- testes 29/12/20
-- testes 29/12/20  vNUMERO := ROUND(vPREVISTO)- (ROUND(vACUMULADO_HORAS_DE_FALTA)-ROUND(vDESCONTO)) ;
  vSTRING := CASE WHEN INSTR(vNUMERO,',',1,1) = 0 THEN TO_CHAR(vNUMERO) WHEN INSTR(vNUMERO,',',1,1) <> 0 THEN TO_CHAR(SUBSTR(vNUMERO,1,INSTR(vNUMERO,',',1,1)-1) ||'.'||SUBSTR(vNUMERO,INSTR(vNUMERO,',' ,1,1)+1, LENGTH(vNUMERO))) end ;
  dbms_output.put_line('DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = ''F'' AND CODIGO_EMPRESA = ''' ||LPAD(C2.EMPRESA,4,0) ||''' AND TIPO_CONTRATO = ''' || LPAD(C2.TIPO_CONTRATO,4,0) ||''' AND CODIGO_CONTRATO = '''|| LPAD(C2.MATRICULA,15,0) ||'''AND TRUNC(DATA) = TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY'') AND CODIGO_SITUACAO = ''1001''; COMMIT;' );  
  DELETE ARTERH.RHPONT_RES_SIT_DIA WHERE TIPO_APURACAO = 'F' AND CODIGO_EMPRESA =  LPAD(C2.EMPRESA,4,0)  AND TIPO_CONTRATO =   LPAD(C2.TIPO_CONTRATO,4,0)  AND CODIGO_CONTRATO =  LPAD(C2.MATRICULA,15,0) AND TRUNC(DATA) = C2.DATA AND CODIGO_SITUACAO = '1001'; COMMIT;
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(C2.EMPRESA,4,0) ||''','''|| LPAD(C2.TIPO_CONTRATO,4,0) ||''','''|| LPAD(C2.MATRICULA,15,0) ||''', TO_DATE('''|| trunc(C2.DATA) ||''',''DD/MM/YYYY''),''1001'',ROUND('||vSTRING ||', 2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' ); 
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(C2.EMPRESA,4,0) , LPAD(C2.TIPO_CONTRATO,4,0), LPAD(C2.MATRICULA,15,0), C2.DATA, '1001', ROUND(vNUMERO, 2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
  --inicio novo nesse local tambem em 10/11/20
  dbms_output.put_line('----GRAVA vSALDO_HORAS_FALTA_COMP: '||vNUMERO||' 1013-TOTAL HORAS DIFERENCIADAS PERIODO: '||vSTRING);
  dbms_output.put_line('INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES ('''||LPAD(vEMPRESA,4,0) ||''','''|| LPAD(vTIPO_CONTRATO,4,0) ||''','''|| LPAD(vMATRICULA,15,0) ||''', TO_DATE('''|| trunc(vDATA_FIM) ||''',''DD/MM/YYYY''),''1013'',ROUND('|| vSTRING||',2), ''F'', SYSDATE, ''IFPONTO'',''N'',''PRG12_TOT_PER_COMP_ADM_DIRETA''); COMMIT;' );  
  INSERT INTO ARTERH.RHPONT_RES_SIT_DIA (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA, CODIGO_SITUACAO, REF_HORAS, TIPO_APURACAO, DT_ULT_ALTER_USUA, LOGIN_USUARIO, FORCA_SITUACAO, TEXTO_ASSOCIADO) VALUES (LPAD(vEMPRESA,4,0) , LPAD(vTIPO_CONTRATO,4,0) , LPAD(vMATRICULA,15,0), vDATA_FIM, '1013', ROUND(vNUMERO,2), 'F', SYSDATE, 'IFPONTO','N','PRG12_TOT_PER_COMP_ADM_DIRETA'); COMMIT;
EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);
INSERT INTO PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT(CAMPO_1, DATA_DADOS, CONSIDERACOES)VALUES('FECHAMENTO_MES ERRO_EXCEPTION: PRG12_TOT_PER_COMP_ADM_DIRETA', SYSDATE, err_msg);COMMIT;
END;--BEGIN EXCEPTION
  --fim novo nesse local tambem em 10/11/20  
vACUMULADO_HORAS_DE_FALTA := vACUMULADO_HORAS_DE_FALTA - vPREVISTO;----******************DIMINUINDO O SALDO DA FALTAS-- testes 29/12/20
-- testes 29/12/20  vACUMULADO_HORAS_DE_FALTA := ROUND(vACUMULADO_HORAS_DE_FALTA,2) - ROUND(vPREVISTO,2);----******************DIMINUINDO O SALDO DA FALTAS
  dbms_output.put_line('--RESTANTES vACUMULADO_HORAS_DE_FALTA: '|| vACUMULADO_HORAS_DE_FALTA);
  END IF;

END IF;
END LOOP; --FIM DO C2
    END IF; ----------------------------------FIM IF DOS CENARIOS 3
--*/
--FIM   -------------------------CENARIOS 5


ELSIF vFOLHA_ESPECIAL = 'NAO' AND vREGISTRO_PONTO NOT IN ('0110','0120','0150','0160','0200') AND vCOD_VINCULO <>'0009' --novo em 30/3/20--TIRAR ESTAGIARIOS, PESSOAS FOLHA ESPECIAL E NÂO USAR IFPONTO
AND vTIPO_FECHAMENTO = 'COMPENSACAO_DIARIA' AND vBH_DEBITO = 0 THEN
dbms_output.put_line('--XCENARIO 0 - NAO FAZ PARTE DA COMPENSACAO DA PBH '||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 0 - NAO FAZ PARTE DA COMPENSACAO DA PBH',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

ELSIF  vCOD_VINCULO = '0009' THEN
dbms_output.put_line('--XCENARIO 0009 ESTAGIARIO NAO ENTRA NA COMPENSACAO'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO 0009 ESTAGIARIO NAO ENTRA NA COMPENSACAO',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21

ELSE
dbms_output.put_line('--XCENARIO NAO MAPEADO - VERIFICAR'||C0.TIPO_FECHAMENTO ||'|'|| C0.EMPRESA  ||'|'|| C0.TIPO_CONTRATO ||'|'|| C0.MATRICULA ||'|'|| C0.QUANT_DIAS ||'|'|| C0.PREVISTO ||'|'|| C0.BH_DEBITO ||'|'|| C0.DESCONTO  ||'|'|| C0.QUANT ||'|'|| C0.CARGA_HORARIA  ||'|'|| vFOLHA_ESPECIAL  ||'|'|| vREGISTRO_PONTO ||'|'||  vCOD_VINCULO ||'|'|| vPREVISTO ||'|'|| vACUMULADO_FALTAS ||'|'|| vACUMULADO_PREVISTO ||'|'|| vDESCONTO ||'|'|| vBH_DEBITO ||'|'|| vACUMULADO_H_NORMAIS ||'|'|| vACUMULADO_H_DIFERENCIAS ||'|'||vACUMULADO_H_EXCEDIDAS);
INSERT INTO PONTO_ELETRONICO.TOTAIS_PERIODO_COMP_PBH (CENARIO, TIPO_FECHAMENTO, EMPRESA, TIPO_CONTRATO, MATRICULA, QUANT_DIAS, PREVISTO, BH_DEBITO, DESCONTO, TIPO_ESCALA, QUANT, CARGA_HORARIA, FOLHA_ESPECIAL, REGISTRO_PONTO, COD_VINCULO, ACUMULADO_FALTAS, ACUMULADO_PREVISTO, ACUMULADO_H_NORMAIS, ACUMULADO_H_DIFERENCIAS, ACUMULADO_H_EXCEDIDAS, DATA_PROCESSAMENTO)
VALUES('XCENARIO NAO MAPEADO - VERIFICAR',C0.TIPO_FECHAMENTO, C0.EMPRESA, C0.TIPO_CONTRATO, C0.MATRICULA, C0.QUANT_DIAS, C0.PREVISTO, C0.BH_DEBITO, C0.DESCONTO, NULL, C0.QUANT, C0.CARGA_HORARIA, vFOLHA_ESPECIAL, vREGISTRO_PONTO,  vCOD_VINCULO, vACUMULADO_FALTAS, vACUMULADO_PREVISTO, vACUMULADO_H_NORMAIS, vACUMULADO_H_DIFERENCIAS, vACUMULADO_H_EXCEDIDAS, SYSDATE);COMMIT;--NOVO EM 13/5/21
--FIM------------------------------------------------ AJUSTES EM 9/12/21

--*/
END IF; --IF GERAL DE TODOS OS CENARIOS
--FIM-------*********************************************************PARTE NOVA DE 11/11/20****************************************************------------------------------





--INICIO--NOVO LOCAL EM 10/11/20
vEMPRESA :=  NULL;
vTIPO_CONTRATO := NULL;
vMATRICULA := NULL;
vACUMULADO_H_NORMAIS :=0;
vACUMULADO_H_DIFERENCIAS :=0;
vACUMULADO_H_EXCEDIDAS :=0;
vACUMULADO_PREVISTO :=0;
vRESULTADO_MES :=0;
vACUMULADO_FALTAS :=0;
vSALDO_HORAS_FALTA_COMP := 0;
vDATA := null;
vDESCONTO := 0;
vBH_DEBITO := 0;
vSOBRA_RESULTADO_MES := 0;
vSOBRA_RESULTADO_MES_SEM_SALD := 0;
vNUMERO := 0;
vSTRING := NULL;
vMEDIA_CARGA_DIA := 0;
--vTIPO_ESCALA := NULL;
vCARGA_HORARIA := NULL;

vACUMULADO_HORAS_DE_FALTA :=0;
--*/--FIM-- NOVO LOCAL EM 10/11/20




END LOOP;--C0
--FIM----C0--------------TODOS BMS




END;

END;

