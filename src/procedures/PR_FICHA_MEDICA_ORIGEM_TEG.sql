
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_FICHA_MEDICA_ORIGEM_TEG" AS
--KELLYSSON 13/9/19


begin
dbms_output.enable(null);

--inicio --------------------------------parte com data e serÃ¡ processado a principio normal
for c1 in (
SELECT 
ROWNUM RN, ROW_NUMBER() OVER   (PARTITION BY X2.CODIGO_EMPRESA, X2.CODIGO_PESSOA, X2.DT_REG_OCORRENCIA, X2.OCORRENCIA ORDER BY X2.ORDEM_PROCESSO, X2.CODIGO_EMPRESA, X2.CODIGO_PESSOA, X2.DT_REG_OCORRENCIA, X2.OCORRENCIA ) AS ORDEM_FICHA,
X2.* 
FROM(
select 
X.ID,X.TABELA, X.CODIGO_EMPRESA, X.CODIGO_PESSOA, X.DT_REG_OCORRENCIA, X.OCORRENCIA,  X.NEW_DATA_INI_AFAST, X.NEW_DATA_FIM_AFAST
,CASE WHEN X.TABELA = 'RHMEDI_FICHA_MED' THEN 1 WHEN X.TABELA = 'RHMEDI_RL_FICH_PRO' THEN 2 WHEN X.TABELA = 'RHMEDI_RL_FICH_DOE' THEN 3 END ORDEM_PROCESSO
,X.LOGIN_USUARIO, X.LOGIN_OS
FROM SUGESP_FICHAS_MEDICAS X 
WHERE x.processado is null
--AND X.NEW_DATA_INI_AFAST IS NOT NULL 
--AND X.NEW_DATA_FIM_AFAST IS NOT NULL
and exists (SELECT AUX.* FROM SUGESP_FICHAS_MEDICAS AUX WHERE AUX.processado is null AND AUX.TABELA ='RHMEDI_FICHA_MED' AND AUX.NEW_DATA_INI_AFAST IS NOT NULL AND AUX.NEW_DATA_FIM_AFAST IS NOT NULL
            AND X.CODIGO_EMPRESA =  AUX.CODIGO_EMPRESA AND X.CODIGO_PESSOA = AUX.CODIGO_PESSOA AND X.DT_REG_OCORRENCIA = AUX.DT_REG_OCORRENCIA AND X.OCORRENCIA = AUX.OCORRENCIA)
order by 
X.CODIGO_EMPRESA, X.CODIGO_PESSOA, X.DT_REG_OCORRENCIA, X.OCORRENCIA--1409
)X2
WHERE 
(X2.TABELA = 'RHMEDI_RL_FICH_PRO' AND X2.ORDEM_PROCESSO = 2 )
OR 
(X2.TABELA = 'RHMEDI_RL_FICH_DOE' AND X2.ORDEM_PROCESSO = 3)
ORDER BY X2.CODIGO_EMPRESA, X2.CODIGO_PESSOA, X2.DT_REG_OCORRENCIA, X2.OCORRENCIA,  X2.ORDEM_PROCESSO
)
loop

dbms_output.put_line('PROCEDURE TEG EXECUTE PR_RHMEDI_FICHA_MED_MANUAL');

INSERT INTO  SUGESP_SIT_FUNC_PONTO_FICHAS (ID, ID_LOG_FICHA, TABELA, CODIGO_EMPRESA, CODIGO_PESSOA,  DT_REG_OCORRENCIA, OCORRENCIA, DT_ULT_ALTER_USUA, LOGIN_USUARIO, LOGIN_OS
,LOG)
VALUES ((SELECT MAX(ID)+1 FROM SUGESP_SIT_FUNC_PONTO_FICHAS), C1.ID, C1.TABELA, C1.CODIGO_EMPRESA,  C1.CODIGO_PESSOA,  C1.DT_REG_OCORRENCIA, C1.OCORRENCIA, sysdate, C1.LOGIN_USUARIO, C1.LOGIN_OS 
,'PROCEDURE TEG EXECUTE PR_RHMEDI_FICHA_MED_MANUAL');

PR_RHMEDI_FICHA_MED_MANUAL(C1.TABELA, C1.CODIGO_EMPRESA,  C1.CODIGO_PESSOA, 
--C1.DT_REG_OCORRENCIA
to_CHAR(C1.DT_REG_OCORRENCIA,'YYYYMMDD')
, C1.OCORRENCIA, 'T', C1.ID);

end loop;


--fim --------------------------------parte com data e serÃ¡ processado a principio normal



--inicio --------------------------------parte com data e ***NÃƒO*** serÃ¡ processado 

FOR C1 IN (

--PARTE DAS DATAS NULAS NO DEFERIMENTO DA FICHA MEDICA
SELECT 
--ROWNUM RN, ROW_NUMBER() OVER   (PARTITION BY X2.CODIGO_EMPRESA, X2.CODIGO_PESSOA, X2.DT_REG_OCORRENCIA, X2.OCORRENCIA ORDER BY X2.ORDEM_PROCESSO, X2.CODIGO_EMPRESA, X2.CODIGO_PESSOA, X2.DT_REG_OCORRENCIA, X2.OCORRENCIA ) AS ORDEM_FICHA,
X2.* 
FROM(
select 
X.ID, X.TABELA, X.CODIGO_EMPRESA, X.CODIGO_PESSOA, X.DT_REG_OCORRENCIA, X.OCORRENCIA,  X.NEW_DATA_INI_AFAST, X.NEW_DATA_FIM_AFAST
,CASE WHEN X.TABELA = 'RHMEDI_FICHA_MED' THEN 1 WHEN X.TABELA = 'RHMEDI_RL_FICH_PRO' THEN 2 WHEN X.TABELA = 'RHMEDI_RL_FICH_DOE' THEN 3 END ORDEM_PROCESSO
,X.LOGIN_USUARIO, X.LOGIN_OS
FROM SUGESP_FICHAS_MEDICAS X 
WHERE x.processado is null
and exists (SELECT AUX.* FROM SUGESP_FICHAS_MEDICAS AUX WHERE AUX.processado is null AND AUX.TABELA ='RHMEDI_FICHA_MED' AND (AUX.NEW_DATA_INI_AFAST IS  NULL or AUX.NEW_DATA_FIM_AFAST IS NULL)
            AND X.CODIGO_EMPRESA =  AUX.CODIGO_EMPRESA AND X.CODIGO_PESSOA = AUX.CODIGO_PESSOA AND X.DT_REG_OCORRENCIA = AUX.DT_REG_OCORRENCIA AND X.OCORRENCIA = AUX.OCORRENCIA)
order by 
X.CODIGO_EMPRESA, X.CODIGO_PESSOA, X.DT_REG_OCORRENCIA, X.OCORRENCIA--1409
)X2
--ORDER BY X2.CODIGO_EMPRESA, X2.CODIGO_PESSOA, X2.DT_REG_OCORRENCIA, X2.OCORRENCIA,  X2.ORDEM_PROCESSO

UNION ALL

--PARTE APENAS TABELA FICHA MEDICA COM DATAS DE DEFERIMENTO PARA MARCAR COMO PROCESSADAS
SELECT  
X.ID, X.TABELA, X.CODIGO_EMPRESA, X.CODIGO_PESSOA, X.DT_REG_OCORRENCIA, X.OCORRENCIA,  X.NEW_DATA_INI_AFAST, X.NEW_DATA_FIM_AFAST
,NULL ORDEM_PROCESSO
,X.LOGIN_USUARIO, X.LOGIN_OS
FROM SUGESP_FICHAS_MEDICAS X 
WHERE X.processado is null AND X.TABELA ='RHMEDI_FICHA_MED' AND X.NEW_DATA_INI_AFAST IS NOT NULL AND X.NEW_DATA_FIM_AFAST IS NOT NULL

)

LOOP

dbms_output.put_line('PROCEDURE TEG APENAS MARCA COMO PROCESSADO');

INSERT INTO  SUGESP_SIT_FUNC_PONTO_FICHAS (ID, ID_LOG_FICHA, TABELA, CODIGO_EMPRESA, CODIGO_PESSOA,  DT_REG_OCORRENCIA, OCORRENCIA, DT_ULT_ALTER_USUA, LOGIN_USUARIO, LOGIN_OS
,LOG)
VALUES ((SELECT MAX(ID)+1 FROM SUGESP_SIT_FUNC_PONTO_FICHAS), C1.ID, C1.TABELA, C1.CODIGO_EMPRESA,  C1.CODIGO_PESSOA,  C1.DT_REG_OCORRENCIA, C1.OCORRENCIA, sysdate, C1.LOGIN_USUARIO, C1.LOGIN_OS 
,'PROCEDURE TEG APENAS MARCA COMO PROCESSADO');

update SUGESP_FICHAS_MEDICAS set PROCESSADO = 'S' where ID = C1.ID; commit;

END LOOP;

--FIM --------------------------------parte com data e ***NÃƒO*** serÃ¡ processado 



end;--1Âº end