
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PRG2_CONVERT_OCOR_EM_JUST" --PRG_28_CONVERT_OCOR_EM_JUST
AS
BEGIN
--Kellysson em 8/4/22 baseado (converte_OCORRENCIA_em_JUSTIFICATIVA_v1.sql)
--KELLYSSON EM 7/7/21 para converter OCORRENCIA(PERIODO) EM JUSTIFICATIVA (DIA)e tirar os dias que tiveram marcacao
--*/
DECLARE 
vCONTADOR NUMBER (10);
vDATA_INICIO DATE;
vDATA_FIM DATE;
vDATA_DIA DATE;
vQTD_DIAS NUMBER;

BEGIN
dbms_output.enable(null);
vCONTADOR :=0;
vDATA_INICIO := NULL;
vDATA_FIM := NULL;
vDATA_DIA := NULL;
vQTD_DIAS := NULL;

FOR C1 IN(
--*/

SELECT 
X.*
--,TRUNC(X.PROXIMA_DTINICIO)-TRUNC(X.DTINICIO) DIF_DIA_DTINICIO
--,LEAD(X.ORDEM_DIA_MESMO_LANC, 1, NULL) OVER (PARTITION BY X.TIPO, X.PERIODO, X.SIT_FUNC, X.EMPRESA, X.TIPO_CONTRATO, X.MATRICULA, X.SIT_PONTO ORDER BY X.DTINICIO) AS PROXIMA_ORDEM_DIA_MESMO_LANC
FROM(
SELECT 
TC.TIPO, R.*
/*ROW_NUMBER() OVER (PARTITION BY TC.TIPO, TC.PERIODO, TC.SIT_FUNC, R.EMPRESA, R.TIPO_CONTRATO, R.MATRICULA, R.SIT_PONTO ORDER BY R.DTINICIO) AS ORDEM_DIA_MESMO_LANC,
TC.TIPO, TC.PERIODO, TC.SIT_FUNC, 
R.EMPRESA, R.TIPO_CONTRATO, 
LAG(R.MATRICULA, 1, NULL) OVER (PARTITION BY TC.TIPO, TC.PERIODO, TC.SIT_FUNC, R.EMPRESA, R.TIPO_CONTRATO, R.MATRICULA, R.SIT_PONTO ORDER BY R.DTINICIO) AS MATRICULA_ANTERIOR,
R.MATRICULA,
LEAD(R.MATRICULA, 1, NULL) OVER (PARTITION BY TC.TIPO, TC.PERIODO, TC.SIT_FUNC, R.EMPRESA, R.TIPO_CONTRATO, R.MATRICULA, R.SIT_PONTO ORDER BY R.DTINICIO) AS PROXIMA_MATRICULA,
R.SIT_PONTO, R.DTINICIO, R.DTFIM
,LEAD(R.DTINICIO, 1, TRUNC(R.DTINICIO)+1) OVER (PARTITION BY TC.TIPO, TC.PERIODO, TC.SIT_FUNC, R.EMPRESA, R.TIPO_CONTRATO, R.MATRICULA, R.SIT_PONTO ORDER BY R.DTINICIO) AS PROXIMA_DTINICIO
,R.COD_EMPRESA, R.CODIGO, R.COD_JUSTIFICATIVA_PONTO, R.COD_PESSOA, R.DTCADASTRO, R.LOGIN_CADASTRO, R.SITUACAO, R.OBS, R.CODIGO_LEGADO, R.DTAPAGOU, R.LOGIN_APAGOU, R.COMPROVANTE, R.LOGIN_APROVACAO, R.DTAPROVACAO, R.QTD_HORAS
*/
FROM PONTO_ELETRONICO.IFPONTO_OCOR_JUST_SIT_FUNC R
LEFT OUTER JOIN (SELECT DADO_ORIGEM, SUBSTR(DADO_ORIGEM,1,10) TIPO, SUBSTR(DADO_ORIGEM,11,4) SIT_PONTO, DADO_DESTINO, SUBSTR(DADO_DESTINO,18,3)PERIODO,  SUBSTR(DADO_DESTINO,21,4) SIT_FUNC FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP2')TC
ON R.SIT_PONTO = TC.SIT_PONTO
WHERE R.DATA_PROCESSAMENTO IS NULL
AND LPAD(R.EMPRESA,4,'0') IN (SELECT DADO_ORIGEM FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'IFP4')--NOVO EM 7/11/23
AND TC.TIPO = 'OCORRENCIA'
ORDER BY R.EMPRESA, R.TIPO_CONTRATO, R.MATRICULA, R.DTINICIO, R.DTFIM
)X

--/*
)

LOOP
vCONTADOR :=vCONTADOR+1;
dbms_output.put_line('vCONTADOR: '|| vCONTADOR || '-'|| C1.MATRICULA||'-'||TRUNC(C1.DTINICIO) ||'-'||TRUNC(C1.DTFIM));

--POPULAR VARIAVEIS
vDATA_INICIO := c1.DTINICIO;
vDATA_FIM := c1.DTFIM;
vQTD_DIAS := (vDATA_FIM - vDATA_INICIO )+1;
dbms_output.put_line( '--TOTAL DE DIAS: ' || vQTD_DIAS);


for i in 1..vQTD_DIAS loop
   vDATA_DIA :=  to_date(to_char((vDATA_INICIO-1)+i,'DD/MM/YYYY'),'DD/MM/YYYY');
dbms_output.put_line('--vDATA_DIA: '||vDATA_DIA); 

INSERT INTO PONTO_ELETRONICO.IFPONTO_OCOR_JUST_SIT_FUNC_TR (COD_EMPRESA, TIPO_CONTRATO, MATRICULA, SIT_PONTO, CODIGO, COD_JUSTIFICATIVA_PONTO, COD_PESSOA, DTCADASTRO, LOGIN_CADASTRO, DTINICIO, DTFIM, SITUACAO, OBS, CODIGO_LEGADO, DTAPAGOU, LOGIN_APAGOU, COMPROVANTE, LOGIN_APROVACAO, DTAPROVACAO, QTD_HORAS,  EMPRESA)
VALUES (C1.COD_EMPRESA, C1.TIPO_CONTRATO, C1.MATRICULA, C1.SIT_PONTO, C1.CODIGO, C1.COD_JUSTIFICATIVA_PONTO, C1.COD_PESSOA, C1.DTCADASTRO, C1.LOGIN_CADASTRO, vDATA_DIA, vDATA_DIA, C1.SITUACAO, C1.OBS, C1.CODIGO_LEGADO, C1.DTAPAGOU, C1.LOGIN_APAGOU, C1.COMPROVANTE, C1.LOGIN_APROVACAO, C1.DTAPROVACAO, C1.QTD_HORAS,  C1.EMPRESA);
COMMIT;



END LOOP; --DATAS

END LOOP; --C1

END;

END;
