
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_ANALISE_POS_FICHAS_TEG" (DATA_INICIO IN VARCHAR2, DATA_FIM IN VARCHAR2)
AS
BEGIN

BEGIN

DECLARE    
vDATA_INICIO Varchar2(10);
vDATA_FIM Varchar2(10);
vCONTADOR NUMBER;
vERROS VARCHAR2 (2000 BYTE);
vALERTAS VARCHAR2 (2000 BYTE);
vQTD_BMS_MESMO_CODIGO NUMBER;
vTEM_MAIS_BM_ATIVO VARCHAR2 (3 BYTE);
vCONCOMITA_DT_DEFERIDO  NUMBER;

vPUBLICO_ATUAL VARCHAR2 (3 BYTE);
vSTATUS_SITUACAO_FUNCIONAL VARCHAR2 (30 BYTE);
vPROCXCOND_ABONO VARCHAR2(3 BYTE);
vPROCXCOND_DATADEFERIDO VARCHAR2(3 BYTE);
vPROCXCOND_DATAINDEFERIDO VARCHAR2(3 BYTE);
vPROCXCOND_ESPECIALIDADETRATA VARCHAR2(3 BYTE);
vPROCXCOND_FIMLAUDO VARCHAR2(3 BYTE);
vPROCXCOND_FIMTRATAMENTO VARCHAR2(3 BYTE);
vPROCXCOND_FREQUENCIA VARCHAR2(3 BYTE);
vPROCXCOND_INICIOLAUDO VARCHAR2(3 BYTE);
vPROCXCOND_INICIOTRATAMENTO VARCHAR2(3 BYTE);
vPROCXCOND_LIMITEDIAS VARCHAR2(3 BYTE);
vPROCXCOND_MINIMODIAS VARCHAR2(3 BYTE);
vPROCXCOND_PERIODOLAUDO VARCHAR2(3 BYTE);
vPROCXCOND_PERMITIDA VARCHAR2(3 BYTE);
vPROCXCOND_QTDE_SESSOES VARCHAR2(3 BYTE);
vPROCXCOND_REAVALIACAO VARCHAR2(3 BYTE);
vPROCXCOND_SEMDATAS VARCHAR2(3 BYTE);
vDIAS VARCHAR2(3 BYTE);
vLIMITEDIAS VARCHAR2(3 BYTE);
vMINIMODIAS VARCHAR2(3 BYTE);
vCONDUTA_CONCOMITASEMDATA VARCHAR2(3 BYTE);
vPROCXCOND_APENASDATAINICIO VARCHAR2(3 BYTE);
vPROCEDIMENTO_CADASTRADO VARCHAR2(3 BYTE);
vCONDUTA_CADASTRADA VARCHAR2(3 BYTE);
vDOENCA_CADASTRADA VARCHAR2(3 BYTE);


BEGIN
dbms_output.enable(null);
vDATA_INICIO := DATA_INICIO;
vDATA_FIM := DATA_FIM;

vCONTADOR := 0;
vERROS := NULL;
vALERTAS := NULL;
vQTD_BMS_MESMO_CODIGO :=0;
vTEM_MAIS_BM_ATIVO := NULL;
vCONCOMITA_DT_DEFERIDO :=0;

vPUBLICO_ATUAL := NULL;
vSTATUS_SITUACAO_FUNCIONAL := NULL;
vPROCXCOND_ABONO := NULL;
vPROCXCOND_DATADEFERIDO := NULL;
vPROCXCOND_DATAINDEFERIDO := NULL; 
vPROCXCOND_ESPECIALIDADETRATA := NULL;
vPROCXCOND_FIMLAUDO := NULL;
vPROCXCOND_FIMTRATAMENTO := NULL;
vPROCXCOND_FREQUENCIA := NULL;
vPROCXCOND_INICIOLAUDO := NULL;
vPROCXCOND_INICIOTRATAMENTO := NULL;
vPROCXCOND_LIMITEDIAS := NULL; 
vPROCXCOND_MINIMODIAS := NULL;
vPROCXCOND_PERIODOLAUDO := NULL;
vPROCXCOND_PERMITIDA := NULL;
vPROCXCOND_QTDE_SESSOES := NULL;
vPROCXCOND_REAVALIACAO := NULL;
vPROCXCOND_SEMDATAS := NULL;
vLIMITEDIAS := NULL;
vMINIMODIAS := NULL;
vCONDUTA_CONCOMITASEMDATA := NULL;
vPROCXCOND_APENASDATAINICIO := NULL;
vPROCEDIMENTO_CADASTRADO := NULL;
vCONDUTA_CADASTRADA := NULL;
vDOENCA_CADASTRADA := NULL;

--CABECALHO RELATORIO
--dbms_output.put_line('vCONTADOR|QTD_DEFERIMENTO_CONCOMITANTES|QTD_DOENCA_DIF_ATENDIMENTO|QTD_CONDUTA_DIF_ATENDIMENTO|QTD_PROCED_DIF_ATENDIMENTO|VEZES_REG_REPETIDO|LOTE|DATA_PROCESSAMENTO|STATUS_PROCESSAMENTO|ID|EXISTE_REGISTRO_ARTERH|VALIDANDO_STATUS_PROCESSAMENTO|ERROS|ALERTAS|AUTOIDFICHAATENDIMENTO|SEQUENCIAL_TEG|CODIGOEMPRESA|CODIGOTIPOCONTRATO|CODIGOCONTRATO|NOME|DATAOCORRENCIA|ATENDENTE|DATAEFETIVA|HORARIOEFETIVO|TIPOPROCEDIMENTO|MODALIDADE|DATAINICIOAFAST|DATAFIMAFAST|DATAINICIALINDEFERIMENTO|DATAFINALINDEFERIMENTO|DATARETORNOREAVALIACAO|DATACIENCIADECISAO|CODIGOCONDUTA|PERIODOLAUDO|INICIOLAUDO|FINALLAUDO|DOENCA|ESPECIALIDADETRATAMENTO|FREQUENCIA_SESSOES|PERIODOINICIALTRATAMENTO|PERIODOFINALTRATAMENTO|QTDE_SESSOES|ABONO|MOTIVO|EXAMECLINICO');
dbms_output.put_line('LOTE|DATA_PROCESSAMENTO|STATUS_PROCESSAMENTO|ID|ERROS|ALERTAS|AUTOIDFICHAATENDIMENTO|SEQUENCIAL_TEG|CODIGOEMPRESA|CODIGOTIPOCONTRATO|CODIGOCONTRATO|NOME|DATAOCORRENCIA|ATENDENTE|DATAEFETIVA|HORARIOEFETIVO|TIPOPROCEDIMENTO|MODALIDADE|DATAINICIOAFAST|DATAFIMAFAST|DATAINICIALINDEFERIMENTO|DATAFINALINDEFERIMENTO|DATARETORNOREAVALIACAO|DATACIENCIADECISAO|CODIGOCONDUTA|PERIODOLAUDO|INICIOLAUDO|FINALLAUDO|DOENCA|ESPECIALIDADETRATAMENTO|FREQUENCIA_SESSOES|PERIODOINICIALTRATAMENTO|PERIODOFINALTRATAMENTO|QTDE_SESSOES|ABONO|POSITIVOEXAME|RECONSIDERACAO|MOTIVO|EXAMECLINICO');
INSERT INTO SUGESP_AJUSTE_LOTE_CAMPO_HIST( CAMPO_VALOR_1,  DATA_DADOS, CONSIDERACOES)
VALUES('PR_ANALISE_POS_FICHAS_TEG', SYSDATE, 
'|LOTE|DATA_PROCESSAMENTO|STATUS_PROCESSAMENTO|ID|ERROS|ALERTAS|AUTOIDFICHAATENDIMENTO|SEQUENCIAL_TEG|CODIGOEMPRESA|CODIGOTIPOCONTRATO|CODIGOCONTRATO|NOME|DATAOCORRENCIA|ATENDENTE|DATAEFETIVA|HORARIOEFETIVO|TIPOPROCEDIMENTO|MODALIDADE|DATAINICIOAFAST|DATAFIMAFAST|DATAINICIALINDEFERIMENTO|DATAFINALINDEFERIMENTO|DATARETORNOREAVALIACAO|DATACIENCIADECISAO|CODIGOCONDUTA|PERIODOLAUDO|INICIOLAUDO|FINALLAUDO|DOENCA|ESPECIALIDADETRATAMENTO|FREQUENCIA_SESSOES|PERIODOINICIALTRATAMENTO|PERIODOFINALTRATAMENTO|QTDE_SESSOES|ABONO|POSITIVOEXAME|RECONSIDERACAO|MOTIVO|EXAMECLINICO'
);COMMIT;



FOR
C1 IN 
(
--INICIO ----------------------------------------------------------------------------LOOP----------------------------------------------------------

select CASE WHEN ER.ERR_MSG IS NOT NULL THEN '-ERRO ORACLE: '||ER.ERR_MSG ELSE NULL END ERR_MSG, C.DATA_RESCISAO, SF.CONTROLE_FOLHA, x4.* from(
--SELECT X3.VALIDANDO_STATUS_PROCESSAMENTO, COUNT(1)QUANT FROM (
SELECT 
CASE 
WHEN X2.ORDEM_NA_FICHA IS NULL THEN 'NAO' ELSE 'SIM' END EXISTE_REGISTRO_ARTERH,
CASE 
WHEN X2.ORDEM_NA_FICHA IS NULL     AND X2.STATUS_PROCESSAMENTO = 'NAO' THEN 'OK, NAO PROCESSADO'
WHEN X2.ORDEM_NA_FICHA IS NOT NULL AND X2.STATUS_PROCESSAMENTO = 'SIM' THEN 'OK, PROCESSADO'
WHEN X2.ORDEM_NA_FICHA IS NULL     AND X2.STATUS_PROCESSAMENTO = 'SIM' THEN 'ERRO, NAO PROCESSADO AINDA'
WHEN X2.ORDEM_NA_FICHA IS NOT NULL AND X2.STATUS_PROCESSAMENTO = 'NAO' THEN 'DUPLICIDADE, JA PROCESSADO' ---PODE SER DUPLICIDADE NO ENVIO DO REGISTRO DAI NÃƒO CHEGA A SER ERRO AO MARCAR O CAMPO STATUS_PROCESSAMENTO COMO NÃƒO
END VALIDANDO_STATUS_PROCESSAMENTO,
X2.* FROM(
--INICIO----------------------------------------------------BASE UNINDO A TABELA HISTORICA DE IMPORTACAO COM AS 3 TABELAS OFICIAIS DO ARTERH
SELECT 
CASE WHEN DC.QUANT IS NULL THEN 0 ELSE DC.QUANT END QTD_DEFERIMENTO_CONCOMITANTES,
DD.QUANT QTD_DOENCA_DIF_ATENDIMENTO,
CD.QUANT QTD_CONDUTA_DIF_ATENDIMENTO, 
PD.QUANT QTD_PROCED_DIF_ATENDIMENTO, 
RR.QUANT VEZES_REG_REPETIDO, 
CASE WHEN X.AUTOIDFICHAATENDIMENTO = 1 THEN 'PBH' ELSE 'TEG' END ORIGEM,
ROW_NUMBER()OVER(PARTITION BY  x.sequencial_teg ORDER BY X.DATA_PROCESSAMENTO)AS REPETICAO_DO_SEQUENCIAL,
ROW_NUMBER()OVER(PARTITION BY X.CODIGOEMPRESA ,X.CODIGOTIPOCONTRATO, X.CODIGOCONTRATO, X.DATAOCORRENCIA, X.AUTOIDFICHAATENDIMENTO, x.sequencial_teg, X.TIPOPROCEDIMENTO, X.CODIGOCONDUTA
ORDER BY X.DOENCA)AS ORDEM_NO_SEQUENCIAL,
--C.DATA_RESCISAO, SF.CONTROLE_FOLHA,
A.*, 
CASE WHEN X.PERIODOLAUDO < 0 OR X.PERIODOLAUDO > 9999 THEN 'VALOR_ERRADO' ELSE 'OK' END VALOR_PERIODOLAUDO,
CASE WHEN LENGTH(X.ESPECIALIDADETRATAMENTO) >40 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_ESPEC_TRATAM,
CASE WHEN LENGTH(X.FREQUENCIA_SESSOES) > 40 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_FREQ_SESSOES,
CASE WHEN LENGTH(X.MOTIVO) > 2000 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_MOTIVO,
CASE WHEN LENGTH(X.EXAMECLINICO) > 2000 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_EXAMECLINICO,
LENGTH(X.ESPECIALIDADETRATAMENTO) TAMANHO_ESPEC_TRATAM,
LENGTH(X.FREQUENCIA_SESSOES) TAMANHO_FREQ_SESSOES,
LENGTH(X.MOTIVO) TAMANHO_MOTIVO,
LENGTH(X.EXAMECLINICO) TAMANHO_EXAMECLINICO,
X.* 
FROM SUGESP_ARQUIVOS_FICHA x
--inicio---------------------------------------------------------------------------------nova parte em 17/6/20-----------------------------------------------------------
LEFT OUTER JOIN
--registros repetidos -- atendimento,sequencial, procedimento, conduta, doenÃ§a iguais--885 REGISTRO ENVIADOS MAIS DE UMA VEZ.
(SELECT F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG, F.TIPOPROCEDIMENTO, F.CODIGOCONDUTA, F.DOENCA, COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA F where F.AUTOIDFICHAATENDIMENTO <> 1 
GROUP BY F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG, F.TIPOPROCEDIMENTO, F.CODIGOCONDUTA, F.DOENCA
)RR ON X.AUTOIDFICHAATENDIMENTO = RR.AUTOIDFICHAATENDIMENTO AND X.SEQUENCIAL_TEG = RR.SEQUENCIAL_TEG AND X.TIPOPROCEDIMENTO = RR.TIPOPROCEDIMENTO AND X.CODIGOCONDUTA = RR.CODIGOCONDUTA AND X.DOENCA = RR.DOENCA
LEFT OUTER JOIN
--PROCEDIMENTO DIFERENTES NO ATENDIMENTO-- atendimento,sequencial, procedimento iguais ***************NÃƒO HOUVE*********************
(SELECT X.AUTOIDFICHAATENDIMENTO, X.SEQUENCIAL_TEG, COUNT(1)QUANT FROM (
SELECT F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG, F.TIPOPROCEDIMENTO, COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA F where F.AUTOIDFICHAATENDIMENTO <> 1 
GROUP BY F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG, F.TIPOPROCEDIMENTO
)X
GROUP BY X.AUTOIDFICHAATENDIMENTO, X.SEQUENCIAL_TEG
)PD ON X.AUTOIDFICHAATENDIMENTO = PD.AUTOIDFICHAATENDIMENTO AND X.SEQUENCIAL_TEG = PD.SEQUENCIAL_TEG
LEFT OUTER JOIN
--cenario novo mas que iria parar de vir mais de 1 CONDUTA POR FICHA-- atendimento,sequencial, procedimento, IGUAIS E CONDUTA DIFERENTE --57 atendimentos com ais de 1 conduta
(SELECT X.AUTOIDFICHAATENDIMENTO, X.SEQUENCIAL_TEG, COUNT(1)QUANT FROM (
SELECT F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG, F.CODIGOCONDUTA, COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA F where F.AUTOIDFICHAATENDIMENTO <> 1 
GROUP BY F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG,  F.CODIGOCONDUTA
)X
GROUP BY X.AUTOIDFICHAATENDIMENTO, X.SEQUENCIAL_TEG
)CD ON X.AUTOIDFICHAATENDIMENTO = CD.AUTOIDFICHAATENDIMENTO AND X.SEQUENCIAL_TEG = CD.SEQUENCIAL_TEG
LEFT OUTER JOIN
--cenario novo de vir mais de 1 DOENCA POR FICHA-- atendimento,sequencial, procedimento, IGUAIS E DOENCA DIFERENTE -- 232 atendimentos com ais de 1 doenca
(SELECT X.AUTOIDFICHAATENDIMENTO, X.SEQUENCIAL_TEG, COUNT(1)QUANT FROM (
SELECT F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG, F.DOENCA, COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA F where F.AUTOIDFICHAATENDIMENTO <> 1 
GROUP BY F.AUTOIDFICHAATENDIMENTO, F.SEQUENCIAL_TEG,  F.DOENCA
)X
GROUP BY X.AUTOIDFICHAATENDIMENTO, X.SEQUENCIAL_TEG
)DD ON X.AUTOIDFICHAATENDIMENTO = DD.AUTOIDFICHAATENDIMENTO AND X.SEQUENCIAL_TEG = DD.SEQUENCIAL_TEG
LEFT OUTER JOIN
(--deferimentos concomitantes
--se pesquisar pelos registros duplicados sÃ£o os mesmos jÃ¡ apresentados, 885 registros
SELECT X2.CODIGOEMPRESA, X2.CODIGOTIPOCONTRATO, X2.CODIGOCONTRATO, X2.DATAINICIOAFAST, X2.DATAFIMAFAST, COUNT(1)QUANT  FROM(
SELECT F.AUTOIDFICHAATENDIMENTO, F.CODIGOEMPRESA, F.CODIGOTIPOCONTRATO, F.CODIGOCONTRATO, F.DATAINICIOAFAST, F.DATAFIMAFAST, 
F.TIPOPROCEDIMENTO, F.CODIGOCONDUTA--, F.DOENCA
, COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA F 
--INICIO---EM 5/2/24--PARTE AJUSTADA TIRANDO EXISTS PARA MELHORAR O DESEMPENHO
left outer join 
(
SELECT A.AUTOIDFICHAATENDIMENTO, A.SEQUENCIAL_TEG, A.TIPOPROCEDIMENTO, A.CODIGOCONDUTA, A.DOENCA, A.CODIGOEMPRESA, A.CODIGOTIPOCONTRATO, A.CODIGOCONTRATO,
A.DATAINICIOAFAST, A.DATAFIMAFAST,
COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA A where A.AUTOIDFICHAATENDIMENTO <> 1 and A.DATAINICIOAFAST is not null and A.DATAFIMAFAST is not null 
GROUP BY A.AUTOIDFICHAATENDIMENTO, A.SEQUENCIAL_TEG, A.TIPOPROCEDIMENTO, A.CODIGOCONDUTA, A.DOENCA,  A.CODIGOEMPRESA, A.CODIGOTIPOCONTRATO, A.CODIGOCONTRATO
,A.DATAINICIOAFAST, A.DATAFIMAFAST
HAVING COUNT(1)>1
)A on F.AUTOIDFICHAATENDIMENTO = A.AUTOIDFICHAATENDIMENTO AND F.CODIGOEMPRESA = A.CODIGOEMPRESA AND F.CODIGOTIPOCONTRATO = A.CODIGOTIPOCONTRATO
AND F.CODIGOCONTRATO = A.CODIGOCONTRATO AND F.DATAINICIOAFAST = A.DATAINICIOAFAST AND F.DATAFIMAFAST = A.DATAFIMAFAST

where F.AUTOIDFICHAATENDIMENTO <> 1 and F.DATAINICIOAFAST is not null and F.DATAFIMAFAST is not null 
/*AND NOT EXISTS
(
SELECT A.AUTOIDFICHAATENDIMENTO, A.SEQUENCIAL_TEG, A.TIPOPROCEDIMENTO, A.CODIGOCONDUTA, A.DOENCA, A.CODIGOEMPRESA, A.CODIGOTIPOCONTRATO, A.CODIGOCONTRATO, COUNT(1)QUANT
FROM SUGESP_ARQUIVOS_FICHA A where A.AUTOIDFICHAATENDIMENTO <> 1 and A.DATAINICIOAFAST is not null and A.DATAFIMAFAST is not null 
AND F.AUTOIDFICHAATENDIMENTO = A.AUTOIDFICHAATENDIMENTO AND F.CODIGOEMPRESA = A.CODIGOEMPRESA AND F.CODIGOTIPOCONTRATO = A.CODIGOTIPOCONTRATO
AND F.CODIGOCONTRATO = A.CODIGOCONTRATO AND F.DATAINICIOAFAST = A.DATAINICIOAFAST AND F.DATAFIMAFAST = A.DATAFIMAFAST
GROUP BY A.AUTOIDFICHAATENDIMENTO, A.SEQUENCIAL_TEG, A.TIPOPROCEDIMENTO, A.CODIGOCONDUTA, A.DOENCA,  A.CODIGOEMPRESA, A.CODIGOTIPOCONTRATO, A.CODIGOCONTRATO HAVING COUNT(1)>1
)*/
AND  A.AUTOIDFICHAATENDIMENTO IS NULL
--FIM---EM 5/2/24--PARTE AJUSTADA TIRANDO EXISTS PARA MELHORAR O DESEMPENHO
GROUP BY F.AUTOIDFICHAATENDIMENTO, F.CODIGOEMPRESA, F.CODIGOTIPOCONTRATO, F.CODIGOCONTRATO, F.DATAINICIOAFAST, F.DATAFIMAFAST, 
F.TIPOPROCEDIMENTO, F.CODIGOCONDUTA--, F.DOENCA-- 
HAVING COUNT(1)>1
)X2
GROUP BY X2.CODIGOEMPRESA, X2.CODIGOTIPOCONTRATO, X2.CODIGOCONTRATO, X2.DATAINICIOAFAST, X2.DATAFIMAFAST
)DC ON X.CODIGOEMPRESA = DC.CODIGOEMPRESA AND X.CODIGOTIPOCONTRATO = DC.CODIGOTIPOCONTRATO AND X.CODIGOCONTRATO = DC.CODIGOCONTRATO AND X.DATAINICIOAFAST = DC.DATAINICIOAFAST AND X.DATAFIMAFAST = DC.DATAFIMAFAST
--fim---------------------------------------------------------------------------------nova parte em 17/6/20-----------------------------------------------------------
LEFT OUTER JOIN
(--juntando, ficha, conduta e doenca
select 
ROW_NUMBER()OVER(PARTITION BY F.CODIGO_EMPRESA ,F.CODIGO_PESSOA ,F.DT_REG_OCORRENCIA ,F.OCORRENCIA ORDER BY F.OCORRENCIA)AS ORDEM_NA_FICHA,
F.C_LIVRE_VALOR01 ID_ATENDIMENTO, F.LOCAL_ATENDIMENTO SEQUENCIAL, 
F.CODIGO_EMPRESA, F.CODIGO_PESSOA, F.DT_REG_OCORRENCIA, F.OCORRENCIA, F.TIPO_CONTRATO, F.CODIGO_CONTRATO, F.NATUREZA_EXAME, E.DESCRICAO PROCEDIMENTO,
P.OCOR_PROC_MED OCOR_CONDUTA, P.CODIGO_PROC_MED CODIGO_CONDUTA, C.DESCRICAO CONDUTA, 
D.OCOR_DOENCA OCOR_DOENCA, D.COD_DOENCA, DOE.DESCRICAO DOENCA_, 
F.DATA_INI_AFAST, F.DATA_FIM_AFAST, F.c_livre_data01 DATA_INI_INDEF, F.c_livre_data02 DATA_FIM_INDEF, F.DATA_CONCLUSAO DATA_CIENCIA, F.DT_ULT_ALTER_USUA
from RHMEDI_FICHA_MED F 
LEFT OUTER JOIN RHMEDI_NATUREZA_EX E ON E.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND E.CODIGO = F.NATUREZA_EXAME
LEFT OUTER JOIN RHMEDI_RL_FICH_PRO P ON F.CODIGO_EMPRESA = P.CODIGO_EMPRESA AND F.CODIGO_PESSOA = P.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = P.DT_REG_OCORRENCIA AND F.OCORRENCIA = P.OCORRENCIA
LEFT OUTER JOIN RHMEDI_PROC_MED C ON C.CODIGO_PROC_MED = P.CODIGO_PROC_MED
LEFT OUTER JOIN RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND F.OCORRENCIA = D.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN RHPESS_PESSOA PS ON F.CODIGO_EMPRESA = PS.CODIGO_EMPRESA and F.CODIGO_PESSOA = PS.CODIGO
order by F.CODIGO_EMPRESA ,F.CODIGO_PESSOA ,F.DT_REG_OCORRENCIA ,F.OCORRENCIA, P.OCORRENCIA, D.OCOR_DOENCA
)A ON A.ID_ATENDIMENTO = X.AUTOIDFICHAATENDIMENTO AND A.SEQUENCIAL = x.sequencial_teg                        -----------------------------------------parte que une a ficha com o registrro do arquivo-------------------------------------------------------------------------------------
AND A.NATUREZA_EXAME = X.TIPOPROCEDIMENTO AND A.CODIGO_CONDUTA = X.CODIGOCONDUTA AND A.COD_DOENCA = X.DOENCA -----------------------------------------parte que une a ficha com o registrro do arquivo-------------------------------------------------------------------------------------
order by X.CODIGOEMPRESA ,X.CODIGOTIPOCONTRATO, X.CODIGOCONTRATO, X.DATAOCORRENCIA,X.AUTOIDFICHAATENDIMENTO, x.sequencial_teg, X.TIPOPROCEDIMENTO, X.CODIGOCONDUTA, X.DOENCA
--FIM----------------------------------------------------BASE UNINDO A TABELA HISTORICA DE IMPORTACAO COM AS 3 TABELAS OFICIAIS DO ARTERH
)X2 
--WHERE (trunc(x2.data_processamento) >= to_date('13/10/2021','dd/mm/yyyy'))---------------------------**************CAMPO QUE PEGA OS REGISTROS DO DIA
--WHERE (trunc(x2.data_processamento) >= trunc(sysdate))
WHERE trunc(x2.data_processamento) BETWEEN vDATA_INICIO AND vDATA_FIM --trunc(sysdate)-7 and trunc(sysdate)-1) 
                                                  --and X2.AUTOIDFICHAATENDIMENTO = 1 --so PBH
                         --                          and 
                 --        X2.AUTOIDFICHAATENDIMENTO <> 1 --so TEG
  --                       and trunc(x2.DATAOCORRENCIA) = to_date('04/06/2020','dd/mm/yyyy') and trunc(x2.data_processamento) = to_date('10/06/2020','dd/mm/yyyy') 

--X2.ID_ATENDIMENTO IS NULL OR X2.STATUS_PROCESSAMENTO = 'NAO'--TODOS QUE NÃƒO GERARAM FICHA
--X2.ID_ATENDIMENTO IS NULL OR X2.AUTOIDFICHAATENDIMENTO = 1 --TODOS QUE NÃƒO GERARAM FICHA
--(X2.ID_ATENDIMENTO IS NULL OR X2.AUTOIDFICHAATENDIMENTO = 1) and 
--or x2.data_processamento is null
 --movimento do dia

--)X3 GROUP BY X3.VALIDANDO_STATUS_PROCESSAMENTO
)X4
left outer join (SELECT C.* FROM RHPESS_CONTRATO C WHERE C.ano_mes_referencia = (select max(aux.ano_mes_referencia) 
  from rhpess_contrato aux
where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
  ) C ON X4.CODIGOEMPRESA = C.CODIGO_EMPRESA AND C.TIPO_CONTRATO = X4.CODIGOTIPOCONTRATO AND C.CODIGO = X4.CODIGOCONTRATO
left outer join rhparm_sit_func SF on SF.codigo = C.situacao_funcional

--INICIO---NOVO EM 7/2/24----ADICIONAR ERRO DE EXCEPTION DA PROCEUDRE PR_GRAVA_FICHA_MEDICA_TEG EMAIL (Importação)
LEFT OUTER JOIN (
SELECT X.CAMPO_VALOR_2 ID, X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, X.DATA_DADOS, X.CONSIDERACOES ERR_MSG FROM SUGESP_AJUSTE_LOTE_CAMPO_HIST X
WHERE X.CAMPO_VALOR_1 = 'LOG EXECUCAO PROCEDURE PR_GRAVA_FICHA_MEDICA_TEG'
AND X.ROWID = (SELECT MAX(A.ROWID) FROM SUGESP_AJUSTE_LOTE_CAMPO_HIST A
            WHERE A.CAMPO_VALOR_1 = 'LOG EXECUCAO PROCEDURE PR_GRAVA_FICHA_MEDICA_TEG'
            AND A.CAMPO_VALOR_2 = X.CAMPO_VALOR_2 AND A.CODIGO_EMPRESA = X.CODIGO_EMPRESA AND A.TIPO_CONTRATO = X.TIPO_CONTRATO AND A.CODIGO_CONTRATO = X.CODIGO_CONTRATO AND TRUNC(A.DATA_DADOS) = TRUNC(X.DATA_DADOS)
            )
)ER ON 
X4.ID = ER.ID AND ER.CODIGO_EMPRESA = X4.CODIGOEMPRESA AND ER.TIPO_CONTRATO = X4.CODIGOTIPOCONTRATO AND ER.CODIGO_CONTRATO = X4.CODIGOCONTRATO AND TRUNC(ER.DATA_DADOS) = TRUNC(X4.DATA_PROCESSAMENTO)
--FIM---NOVO EM 7/2/24----ADICIONAR ERRO DE EXCEPTION DA PROCEUDRE PR_GRAVA_FICHA_MEDICA_TEG EMAIL (Importação)


--WHERE X4.codigocontrato = '000000000476319'--'000000000977237'--'000000000365606'--'000000001072119'
--FIM  ----------------------------------------------------------------------------LOOP----------------------------------------------------------

)
LOOP
vERROS := NULL;
vALERTAS := NULL;
vCONTADOR := vCONTADOR+1 ;

--inicio --novo em 26/5/20
vQTD_BMS_MESMO_CODIGO :=0;
vTEM_MAIS_BM_ATIVO := NULL;
vCONCOMITA_DT_DEFERIDO :=0;
vPUBLICO_ATUAL := NULL;
vSTATUS_SITUACAO_FUNCIONAL := NULL;
vPROCXCOND_ABONO := NULL; 
vPROCXCOND_DATADEFERIDO := NULL;
vPROCXCOND_DATAINDEFERIDO := NULL;
vPROCXCOND_ESPECIALIDADETRATA := NULL;
vPROCXCOND_FIMLAUDO := NULL;
vPROCXCOND_FIMTRATAMENTO := NULL;
vPROCXCOND_FREQUENCIA := NULL;
vPROCXCOND_INICIOLAUDO := NULL;
vPROCXCOND_INICIOTRATAMENTO := NULL;
vPROCXCOND_LIMITEDIAS := NULL;
vPROCXCOND_MINIMODIAS := NULL;
vPROCXCOND_PERIODOLAUDO := NULL;
vPROCXCOND_PERMITIDA := NULL;
vPROCXCOND_QTDE_SESSOES := NULL;
vPROCXCOND_REAVALIACAO := NULL;
vPROCXCOND_SEMDATAS := NULL;
vLIMITEDIAS := NULL;
vMINIMODIAS := NULL;
vCONDUTA_CONCOMITASEMDATA := NULL;
vPROCXCOND_APENASDATAINICIO := NULL;
vPROCEDIMENTO_CADASTRADO := NULL;
vCONDUTA_CADASTRADA := NULL;
vDOENCA_CADASTRADA := NULL;
--fim --novo em 26/5/20

--dbms_output.put_line('--CONTADOR: '|| vCONTADOR || ' ORIGEM: ' || C1.ORIGEM || ' SEQUENCIAL: ' || C1.SEQUENCIAL_TEG || ' EMPRESA: ' || C1.CODIGOEMPRESA || ' TIPO CONTRATO: ' || C1.CODIGOTIPOCONTRATO || ' CONTRATO: ' ||C1.CODIGOCONTRATO);


--IF DUPLICIDADE, JA PROCESSADO
IF C1.VALIDANDO_STATUS_PROCESSAMENTO = 'DUPLICIDADE, JA PROCESSADO' THEN
vALERTAS := vALERTAS || 'REGISTRO JÃ? PROCESSADO EM '|| C1.DT_ULT_ALTER_USUA || ', ';
END IF;



--INICIO-------------------------------------vQTD_BMS_MESMO_CODIGO
--IF C1.ORIGEM = 'PBH' THEN
SELECT COUNT(1)SOMA INTO vQTD_BMS_MESMO_CODIGO FROM(
select c2.codigo_empresa, c2.tipo_contrato, c2.codigo, c2.codigo_pessoa, sf2.codigo cod_sit_func, sf2.descricao situacao_funcional, c2.data_rescisao from(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where c.codigo = C1.CODIGOCONTRATO--'000000009301381'
AND c.TIPO_CONTRATO = C1.CODIGOTIPOCONTRATO
AND C.CODIGO_EMPRESA = C1.CODIGOEMPRESA
--and c.codigo_empresa in (SELECT SUBSTR(DADO_ORIGEM,27,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,27,4) )
and c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)x
left outer join rhpess_contrato c2 ON x.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2 where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
--AND C2.DATA_RESCISAO IS NULL--comentado 11/5/20 21H
AND c2.codigo = C1.CODIGOCONTRATO
AND c2.TIPO_CONTRATO = C1.CODIGOTIPOCONTRATO
AND C2.CODIGO_EMPRESA = C1.CODIGOEMPRESA
--and c2.codigo_empresa in (SELECT SUBSTR(DADO_ORIGEM,27,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,27,4) )
)X2;
--dbms_output.put_line('--vQTD_BMS_MESMO_CODIGO:' || vQTD_BMS_MESMO_CODIGO);
IF vQTD_BMS_MESMO_CODIGO = 0 THEN
vERROS := vERROS || 'BM NAO LOCALIZADO, ';
elsif vQTD_BMS_MESMO_CODIGO = 1 AND C1.DATA_RESCISAO IS NULL THEN
vALERTAS := vALERTAS || '1 BM ATIVO, ';
elsif vQTD_BMS_MESMO_CODIGO = 1 AND C1.DATA_RESCISAO IS NOT NULL THEN
vALERTAS := vALERTAS || '1 BM INATIVO, ';
elsif vQTD_BMS_MESMO_CODIGO > 1 THEN
vERROS := vERROS || 'QTD BM COM MESMO CODIGO MAIOR QUE 1, ';
END IF;
--FIM-------------------------------------vQTD_BMS_MESMO_CODIGO




--inicio-----------------------------------------------------------------------MAIS BMS ATIVOS?
SELECT CASE WHEN X3.SOMA = 0 THEN 'NAO' ELSE 'SIM' END MAIS_BMS_ATIVOS INTO vTEM_MAIS_BM_ATIVO FROM(
SELECT COUNT(1)SOMA FROM(
select c2.codigo_empresa, c2.tipo_contrato, c2.codigo, c2.codigo_pessoa, sf2.codigo cod_sit_func, sf2.descricao situacao_funcional, c2.data_rescisao from(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where c.codigo = C1.CODIGO_CONTRATO--'000000000912674'
and c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)x
left outer join rhpess_contrato c2 ON x.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2 where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
AND C2.DATA_RESCISAO IS NULL
AND c2.codigo <> C1.CODIGO_CONTRATO--'000000000912674'
)X2
)X3;

IF vTEM_MAIS_BM_ATIVO = 'SIM' THEN
vALERTAS := vALERTAS || 'MAIS DE UM BM ATIVO PARA ESTA PESSOA, ';
END IF;
--FIM-----------------------------------------------------------------------MAIS BMS ATIVOS?

--INICIO-------------------------------TEM FICHA NO BM NO PERIODO DEFERIDO DA NOVA FICHA?
SELECT SUM(RETORNO) INTO vCONCOMITA_DT_DEFERIDO FROM
(SELECT CASE WHEN SUM(X.RETORNO)=0 THEN 0 ELSE X.RETORNO END AS RETORNO FROM
(SELECT COUNT(1) RETORNO FROM RHMEDI_FICHA_MED
WHERE TRUNC(TO_DATE(C1.DATAINICIOAFAST,'DD/MM/YYYY')) BETWEEN TRUNC(TO_DATE(DATA_INI_AFAST,'DD/MM/YYYY')) AND TRUNC(TO_DATE(DATA_FIM_AFAST,'DD/MM/YYYY'))
AND CODIGO_EMPRESA = C1.CODIGOEMPRESA
AND TIPO_CONTRATO = C1.CODIGOTIPOCONTRATO
AND CODIGO_CONTRATO = C1.CODIGOCONTRATO
UNION ALL
SELECT COUNT(1) RETORNO FROM RHMEDI_FICHA_MED
WHERE TRUNC(TO_DATE(C1.DATAFIMAFAST,'DD/MM/YYYY')) BETWEEN TRUNC(TO_DATE(DATA_INI_AFAST,'DD/MM/YYYY')) AND TRUNC(TO_DATE(DATA_FIM_AFAST,'DD/MM/YYYY'))
AND CODIGO_EMPRESA = C1.CODIGOEMPRESA
AND TIPO_CONTRATO = C1.CODIGOTIPOCONTRATO
AND CODIGO_CONTRATO = C1.CODIGOCONTRATO
)X GROUP BY X.RETORNO);

IF vCONCOMITA_DT_DEFERIDO > 0  AND C1.VALIDANDO_STATUS_PROCESSAMENTO <> 'DUPLICIDADE, JA PROCESSADO' THEN
vERROS := vERROS || 'PERIODO DE DEFERIMENTO CONCOMITANTE, ';
END IF;
--FIM----------------------------------TEM FICHA NO BM NO PERIODO DEFERIDO DA NOVA FICHA?


--PROCEDIMENTO cadastrasda
SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_PROCEDIMENTO_CADASTRADO INTO vPROCEDIMENTO_CADASTRADO FROM( SELECT COUNT(1)QUANT FROM RHMEDI_NATUREZA_EX WHERE CODIGO_EMPRESA = C1.CODIGOEMPRESA AND CODIGO = C1.TIPOPROCEDIMENTO);
IF vPROCEDIMENTO_CADASTRADO = 'NAO' AND C1.CODIGOEMPRESA IS NOT NULL THEN --ADICIONADO EM 12/6/20  C1.CODIGOEMPRESA IS NOT NULL 
vERROS := vERROS || 'PROCEDIMENTO NAO CADASTRADO, ';
END IF;

--CONDUTA cadastrasda
SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_CONDUTA_CADASTRADA INTO vCONDUTA_CADASTRADA FROM( SELECT COUNT(1)QUANT FROM RHMEDI_PROC_MED WHERE CODIGO_PROC_MED = C1.CODIGOCONDUTA);
IF vCONDUTA_CADASTRADA = 'NAO' THEN
vERROS := vERROS || 'CONDUTA NAO CADASTRADA, ';
END IF;

--DOENCA cadastrasda
SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_DOENCA_CADASTRADA INTO vDOENCA_CADASTRADA FROM( SELECT COUNT(1)QUANT FROM RHMEDI_DOENCA WHERE CODIGO = C1.DOENCA);
IF vDOENCA_CADASTRADA = 'NAO' THEN
vERROS := vERROS || 'DOENCA NAO CADASTRADA, ';
END IF;

--------------------------------------------------IF PARA PROCESSAR APENAS SE O CODIGO DO BM TIVER 1 ATIVO
IF vQTD_BMS_MESMO_CODIGO = 1 
THEN
-----------------------------------------------------localizar contratos da pessoa apenas pelo bm
--INICIO----------------------------------TEG6 -- VALIDAR SE ESTA NO PUBLICO DA TABELA DE CONVERSAO TEG6----------------------------------
--INICIO----------------------------------TEG7 -- VALIDAR SE ESTA NAS REGRAS ATUAIS MAEPADAS PELA GESER PARA PREENCHIMENTO DE FICHAS MEDICAS DA TABELA DE CONVERSAO TEG7----------------------------------
select --c2.codigo_empresa, c2.tipo_contrato, c2.codigo_pessoa, C2.VINCULO, C2.SITUACAO_FUNCIONAL, X.CONTROLE_FOLHA, X.E_AFASTAMENTO, X.SUSPENDE_REMUNERA ,
CASE WHEN TEG6.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PUBLICO_ATUAL
,CASE WHEN TEG6SF.DADO_ORIGEM IS NOT NULL THEN 'PODE_USAR' ELSE 'NAO_PODE_USAR' END STATUS_SITUACAO_FUNCIONAL
,CASE WHEN TEG7A.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_PERMITIDA
,CASE WHEN TEG7B.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_DATADEFERIDO
,CASE WHEN TEG7C.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_DATAINDEFERIDO
,CASE WHEN TEG7D.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_SEMDATAS
,CASE WHEN TEG7E.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_LIMITEDIAS
,CASE WHEN TEG7F.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_MINIMODIAS
,CASE WHEN TEG7G.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_REAVALIACAO
,CASE WHEN TEG7H.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_PERIODOLAUDO
,CASE WHEN TEG7I.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_INICIOLAUDO
,CASE WHEN TEG7J.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FIMLAUDO
,CASE WHEN TEG7K.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_ESPECIALIDADETRATA
,CASE WHEN TEG7L.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FREQUENCIA
,CASE WHEN TEG7M.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_INICIOTRATAMENTO
,CASE WHEN TEG7N.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FIMTRATAMENTO
,CASE WHEN TEG7O.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_QTDE_SESSOES
,CASE WHEN TEG7P.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_ABONO
,CASE WHEN TEG7E.DADO_ORIGEM IS NOT NULL THEN SUBSTR(TEG7E.DADO_ORIGEM,52,3) ELSE '0' END LIMITEDIAS
,CASE WHEN TEG7F.DADO_ORIGEM IS NOT NULL THEN SUBSTR(TEG7F.DADO_ORIGEM,53,3) ELSE '0' END MINIMODIAS
,CASE WHEN TEG7Q.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END CONDUTA_CONCOMITASEMDATA
,CASE WHEN TEG7R.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_APENASDATAINICIO
INTO --vCODIGO_EMPRESA, vTIPO_CONTRATO, vCODIGO_PESSOA, vVINCULO, vSITUACAO_FUNCIONAL, vCONTROLE_FOLHA, vE_AFASTAMENTO, vSUSPENDE_REMUNERA,
vPUBLICO_ATUAL, vSTATUS_SITUACAO_FUNCIONAL
,vPROCXCOND_PERMITIDA, vPROCXCOND_DATADEFERIDO, vPROCXCOND_DATAINDEFERIDO, vPROCXCOND_SEMDATAS, vPROCXCOND_LIMITEDIAS, vPROCXCOND_MINIMODIAS
,vPROCXCOND_REAVALIACAO, vPROCXCOND_PERIODOLAUDO, vPROCXCOND_INICIOLAUDO, vPROCXCOND_FIMLAUDO, vPROCXCOND_ESPECIALIDADETRATA, vPROCXCOND_FREQUENCIA
,vPROCXCOND_INICIOTRATAMENTO, vPROCXCOND_FIMTRATAMENTO, vPROCXCOND_QTDE_SESSOES, vPROCXCOND_ABONO, vLIMITEDIAS, vMINIMODIAS
,vCONDUTA_CONCOMITASEMDATA ,vPROCXCOND_APENASDATAINICIO
from(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, C.VINCULO, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
, SF.CONTROLE_FOLHA, SF.E_AFASTAMENTO, SF.SUSPENDE_REMUNERA 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where c.codigo = C1.CODIGOCONTRATO-- '000000000912674'
AND c.TIPO_CONTRATO = C1.CODIGOTIPOCONTRATO
AND C.CODIGO_EMPRESA = C1.CODIGOEMPRESA
and c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)x
left outer join rhpess_contrato c2 ON x.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO' )TEG6 
ON X.CODIGO_EMPRESA = SUBSTR(TEG6.DADO_ORIGEM,27,4) AND X.TIPO_CONTRATO = SUBSTR(TEG6.DADO_ORIGEM,31,4) AND X.VINCULO = SUBSTR(TEG6.DADO_ORIGEM,35,4) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='CONTROLE_FOLHAE_AFASTAMENTOSUSPENDE_REMUNERA' )TEG6SF 
ON X.CONTROLE_FOLHA = SUBSTR(TEG6SF.DADO_ORIGEM,1,1) AND X.E_AFASTAMENTO = SUBSTR(TEG6SF.DADO_ORIGEM,2,1) AND X.SUSPENDE_REMUNERA = SUBSTR(TEG6SF.DADO_ORIGEM,3,1) 

LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_PERMITIDA' )TEG7A 
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7A.DADO_ORIGEM,31,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7A.DADO_ORIGEM,35,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_DATADEFERIDO' )TEG7B
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7B.DADO_ORIGEM,34,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7B.DADO_ORIGEM,38,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_DATAINDEFERIDO' )TEG7C
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7C.DADO_ORIGEM,36,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7C.DADO_ORIGEM,40,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_SEMDATAS' )TEG7D
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7D.DADO_ORIGEM,30,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7D.DADO_ORIGEM,34,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_LIMITEDIAS' )TEG7E
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7E.DADO_ORIGEM,32,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7E.DADO_ORIGEM,36,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_MINIMODIAS' )TEG7F
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7F.DADO_ORIGEM,33,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7F.DADO_ORIGEM,37,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_REAVALIACAO' )TEG7G
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7G.DADO_ORIGEM,33,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7G.DADO_ORIGEM,37,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_PERIODOLAUDO' )TEG7H
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7H.DADO_ORIGEM,34,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7H.DADO_ORIGEM,38,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_INICIOLAUDO' )TEG7I
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7I.DADO_ORIGEM,33,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7I.DADO_ORIGEM,37,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FIMLAUDO' )TEG7J
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7J.DADO_ORIGEM,30,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7J.DADO_ORIGEM,34,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_ESPECIALIDADETRATAM' )TEG7K
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7K.DADO_ORIGEM,45,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7K.DADO_ORIGEM,49,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FREQUENCIA' )TEG7L
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7L.DADO_ORIGEM,32,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7L.DADO_ORIGEM,36,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_INICIOTRATAMENTO' )TEG7M
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7M.DADO_ORIGEM,38,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7M.DADO_ORIGEM,42,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FIMTRATAMENTO' )TEG7N
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7N.DADO_ORIGEM,35,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7N.DADO_ORIGEM,39,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_QTDE_SESSOES' )TEG7O
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7O.DADO_ORIGEM,34,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7O.DADO_ORIGEM,38,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_ABONO' )TEG7P 
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7P.DADO_ORIGEM,27,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7P.DADO_ORIGEM,31,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='CONDUTA_CONCOMITASEMDATA' )TEG7Q 
ON C1.CODIGOCONDUTA = SUBSTR(TEG7Q.DADO_ORIGEM,25,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_APENASDATAINICIO' )TEG7R 
ON C1.TIPOPROCEDIMENTO = SUBSTR(TEG7R.DADO_ORIGEM,38,4) AND C1.CODIGOCONDUTA = SUBSTR(TEG7R.DADO_ORIGEM,42,15)

where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2 where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
--AND C2.DATA_RESCISAO IS NULL --COMENTADO EM 11/5/20 21H56
AND c2.codigo = C1.CODIGOCONTRATO --'000000000912674';
AND c2.TIPO_CONTRATO = C1.CODIGOTIPOCONTRATO
AND C2.CODIGO_EMPRESA = C1.CODIGOEMPRESA
;

--dbms_output.put_line('--vVINCULO: ' || vVINCULO || ' vSITUACAO_FUNCIONAL: ' || vSITUACAO_FUNCIONAL ||' vCONTROLE_FOLHA: '|| vCONTROLE_FOLHA ||' vE_AFASTAMENTO: '|| vE_AFASTAMENTO|| ' vSUSPENDE_REMUNERA: ' || vSUSPENDE_REMUNERA);
/*
dbms_output.put_line('--EMPRESATIPOCONTRATOVINCULO: '|| vPUBLICO_ATUAL || ' CONTROLE_FOLHAE_AFASTAMENTOSUSPENDE_REMUNERA: ' ||vSTATUS_SITUACAO_FUNCIONAL);
dbms_output.put_line('--vPROCXCOND_PERMITIDA: '|| vPROCXCOND_PERMITIDA || ' vPROCXCOND_DATADEFERIDO: '||vPROCXCOND_DATADEFERIDO || ' vPROCXCOND_DATAINDEFERIDO: ' || vPROCXCOND_DATAINDEFERIDO);
dbms_output.put_line('--vPROCXCOND_SEMDATAS: ' || vPROCXCOND_SEMDATAS || ' vPROCXCOND_LIMITEDIAS: ' || vPROCXCOND_LIMITEDIAS || ' vLIMITEDIAS: ' || vLIMITEDIAS || ' vMINIMODIAS: ' ||vMINIMODIAS);
dbms_output.put_line('--vPROCXCOND_MINIMODIAS: ' || vPROCXCOND_MINIMODIAS || ' vPROCXCOND_REAVALIACAO: '|| vPROCXCOND_REAVALIACAO || ' vPROCXCOND_PERIODOLAUDO: ' || vPROCXCOND_PERIODOLAUDO);
dbms_output.put_line('--vPROCXCOND_INICIOLAUDO: ' || vPROCXCOND_INICIOLAUDO ||' vPROCXCOND_FIMLAUDO: ' || vPROCXCOND_FIMLAUDO || ' vPROCXCOND_ESPECIALIDADETRATA: ' || vPROCXCOND_ESPECIALIDADETRATA);
dbms_output.put_line('--vPROCXCOND_FREQUENCIA: ' || vPROCXCOND_FREQUENCIA || ' vPROCXCOND_INICIOTRATAMENTO: ' || vPROCXCOND_INICIOTRATAMENTO || ' vPROCXCOND_FIMTRATAMENTO: ' || vPROCXCOND_FIMTRATAMENTO || ' vPROCXCOND_QTDE_SESSOES: ' || vPROCXCOND_QTDE_SESSOES || ' vPROCXCOND_ABONO: ' || vPROCXCOND_ABONO);
dbms_output.put_line('--vCONDUTA_CONCOMITASEMDATA: '|| vCONDUTA_CONCOMITASEMDATA || ' vPROCXCOND_APENASDATAINICIO: '|| vPROCXCOND_APENASDATAINICIO);
*/
--END IF; --tirando este END IF daqui em 12/6/20 e levando para o fim dos IFs individuais abaixo 
--FIM---------------------------------- TEG7 -- VALIDAR SE ESTA NAS REGRAS ATUAIS MAEPADAS PELA GESER PARA PREENCHIMENTO DE FICHAS MEDICAS DA TABELA DE CONVERSAO TEG7----------------------------------
--FIM----------------------------------TEG6 -- VALIDAR SE ESTA NO PUBLICO DA TABELA DE CONVERSAO TEG6----------------------------------

--DTINICIO_MAIOR_DTATUAL
IF(TRUNC(C1.DATAOCORRENCIA)> TRUNC(SYSDATE)) 
OR (C1.DATAINICIOAFAST IS NOT NULL AND TRUNC(C1.DATAINICIOAFAST)> TRUNC(SYSDATE)+120)--COMENTADO em 27/7/20--Toffalini nesta data via hangouts pediu para tirar a regra de lanÃ§amento de deferimento futuro e reprocessar o que foi rejeitado
--comentado em 26/5/20--OR (C1.DATAINICIALINDEFERIMENTO IS NOT NULL AND TRUNC(C1.DATAINICIALINDEFERIMENTO)> TRUNC(SYSDATE)) 
THEN --'SIM' ELSE 'NAO' END DTINICIO_MAIOR_DTATUAL,
vERROS := vERROS || 'PERIODO DE DEFERIMENTO POSTERIOR A DATA ATUAL, ';
END IF;


--DTFIM_MAIOR_DTINICIO
IF (C1.DATAINICIOAFAST IS NOT NULL AND TRUNC(C1.DATAFIMAFAST) < TRUNC(C1.DATAINICIOAFAST)) 
OR (C1.DATAINICIALINDEFERIMENTO IS NOT NULL AND TRUNC(C1.DATAFINALINDEFERIMENTO) < TRUNC(C1.DATAINICIALINDEFERIMENTO)) 
THEN --'SIM' ELSE 'NAO' END DTFIM_MAIOR_DTINICIO,
vERROS := vERROS || 'DATA INICIO DE DEFERIMENTO E/OU INDEFEREMINTO MAIOR QUE DATA FIM, ';
END IF;


IF vPUBLICO_ATUAL = 'NAO' THEN
vERROS := vERROS || 'EMPRESA/TIPO CONTRATO/VINCULO NAO FAZ PARTE PUBLICO ATENDIMENTO, ';
END IF;

IF (vSTATUS_SITUACAO_FUNCIONAL = 'NAO_PODE_USAR'
and C1.DATA_RESCISAO IS NULL)--novo em 12/6/20
THEN vERROS := vERROS || 'SITUACAO FUNCIONAL NAO FAZ PARTE PUBLICO ATENDIMENTO, ';
END IF;

IF --(C1.DATA_RESCISAO IS NULL AND C1.CONTROLE_FOLHA <> 'S')OR
(C1.DATA_RESCISAO IS NOT NULL AND C1.CONTROLE_FOLHA <> 'S' AND (TRUNC(C1.DATAINICIOAFAST) > TRUNC(C1.DATA_RESCISAO) OR TRUNC(C1.DATAINICIALINDEFERIMENTO) > TRUNC(C1.DATA_RESCISAO)) )--trocado em 24/9/20 DATAOCORRENCIA POR DATAINICIOAFA
THEN vERROS := vERROS || 'PESSOA JA DESLIGADA E ATENDIMENTO POSTERIOR A RESCISAO, ';
END IF;

--novo em 12/6/20
IF (vSTATUS_SITUACAO_FUNCIONAL = 'NAO_PODE_USAR' and C1.DATA_RESCISAO IS NULL)
and (C1.DATA_RESCISAO IS NOT NULL AND C1.CONTROLE_FOLHA <> 'S' AND (TRUNC(C1.DATAINICIOAFAST) > TRUNC(C1.DATA_RESCISAO) OR TRUNC(C1.DATAINICIALINDEFERIMENTO) > TRUNC(C1.DATA_RESCISAO)) ) --trocado em 24/9/20 DATAOCORRENCIA POR DATAINICIOAFAST
THEN vERROS := vERROS || 'SITUACAO FUNCIONAL NAO FAZ PARTE PUBLICO ATENDIMENTO e PESSOA JA DESLIGADA E ATENDIMENTO POSTERIOR A RESCISAO, ';
END IF;

IF vPROCXCOND_PERMITIDA = 'NAO'
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA NAO MAPEADA, ';
END IF;

IF vPROCXCOND_DATADEFERIDO = 'SIM' AND (C1.DATAINICIOAFAST IS NULL OR C1.DATAFIMAFAST IS NULL) 
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE DATAS DE DEFERIMENTO, ';
END IF;

IF vPROCXCOND_DATAINDEFERIDO = 'SIM' AND (C1.DATAINICIALINDEFERIMENTO IS NULL OR C1.DATAFINALINDEFERIMENTO IS NULL) 
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE DATAS DE INDEFERIMENTO, ';
END IF;

IF vPROCXCOND_REAVALIACAO = 'SIM' AND C1.DataRetornoReavaliacao IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE DATAS DE RETORNO DE REAVALIACAO, ';
END IF;

IF vPROCXCOND_PERIODOLAUDO = 'SIM' AND C1.PERIODOLAUDO IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE PERIODO DO LAUDO, ';
END IF;--CONDUTA

IF vPROCXCOND_INICIOLAUDO = 'SIM' AND C1.INICIOLAUDO IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE INCIO DO LAUDO, ';
END IF; --CONDUTA

IF vPROCXCOND_FIMLAUDO = 'SIM' AND C1.FINALLAUDO IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE FIM DO LAUDO, ';
END IF; --CONDUTA

IF vPROCXCOND_ESPECIALIDADETRATA = 'SIM' AND C1.EspecialidadeTratamento IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE ESPECIALIDADE DE TRATAMENTO, ';
END IF; --DOENCA PROBLEMA TAMANHO

IF vPROCXCOND_FREQUENCIA = 'SIM' AND C1.Frequencia_Sessoes IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE FREQUENCIA DE SESSOES, ';
END IF; --DOENCA PROBLEMA TAMANHO

IF vPROCXCOND_INICIOTRATAMENTO = 'SIM' AND C1.PeriodoInicialTratamento IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE DATA INICIAL DE TRATAMENTO, ';
END IF; --DOENCA PROBLEMA DATA JÃ? COM TEG

IF vPROCXCOND_FIMTRATAMENTO = 'SIM' AND C1.PeriodoFinalTratamento IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE DATA FINAL DE TRATAMENTO, ';
END IF; --DOENCA PROBLEMA DATA JÃ? COM TEG

IF vPROCXCOND_QTDE_SESSOES = 'SIM' AND C1.QTDE_SESSOES IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE QUANTIDADE DE SESSOES, ';
END IF; --DOENCA CRIAR AINDA NA TEG

IF vPROCXCOND_ABONO = 'SIM' AND C1.ABONO IS NULL
THEN vERROS := vERROS || 'PROCEDIMENTO X CONDUTA EXIGE CAMPO ABONO, ';
END IF; --DOENCA CRIAR AINDA NA TEG

/*--INICIO-------------------AVALIAR AINDA POIS NAO FECHOU CONCEITO
CASE WHEN X5.PROCXCOND_LIMITEDIAS = 'SIM' AND ( TO_DATE(X5.DATA_FIM_AFAST,'DD/MM/YYYY') - TO_DATE(X5.DATA_INICIO_AFAST,'DD/MM/YYYY') > TO_NUMBER(X5.LIMITEDIAS))THEN 'LIMITE_DIAS_ERRADO'
ELSE 'OK' END STATUS_LIMITEDIAS,
CASE WHEN X5.PROCXCOND_MINIMODIAS = 'SIM' AND ( TO_DATE(X5.DATA_FIM_AFAST,'DD/MM/YYYY') - TO_DATE(X5.DATA_INICIO_AFAST,'DD/MM/YYYY') < TO_NUMBER(X5.MINIMODIAS))THEN 'LIMITE_DIAS_ERRADO'
ELSE 'OK' END STATUS_MINIMODIAS,
*/--FIM-------------------AVALIAR AINDA POIS NAO FECHOU CONCEITO

IF vCONDUTA_CONCOMITASEMDATA = 'SIM' 
THEN vALERTAS := vALERTAS || 'PROCEDIMENTO X CONDUTA PERMITE CONCOMITANCIA POIS NAO GRAVA DATAS, ';
END IF; 

IF vPROCXCOND_APENASDATAINICIO = 'SIM' 
THEN vALERTAS := vALERTAS || 'PROCEDIMENTO X CONDUTA APENAS COM DATA INICIO, ';
END IF; 

IF C1.VALOR_PERIODOLAUDO <> 'OK' 
THEN vALERTAS := vALERTAS || 'VALOR DO CAMPO: PERIODO DO LAUDO ULTRAPASSOU LIMITE, ';
END IF; 

IF C1.STATUS_TAMANHO_ESPEC_TRATAM <> 'OK' 
THEN vALERTAS := vALERTAS || 'VALOR DO CAMPO: ESPECIALIDADE DE TRATAMENTO ULTRAPASSOU LIMITE, ';
END IF; 

IF C1.STATUS_TAMANHO_FREQ_SESSOES<> 'OK' 
THEN vALERTAS := vALERTAS || 'VALOR DO CAMPO: FREQUENCIA DE SESSOES ULTRAPASSOU LIMITE, ';
END IF; 

IF C1.STATUS_TAMANHO_MOTIVO <> 'OK' 
THEN vALERTAS := vALERTAS || 'VALOR DO CAMPO: MOTIVO ULTRAPASSOU LIMITE, ';
END IF; 

IF C1.STATUS_TAMANHO_EXAMECLINICO <> 'OK' 
THEN vALERTAS := vALERTAS || 'VALOR DO CAMPO: EXAME CLINICO ULTRAPASSOU LIMITE, ';
END IF; 


END IF; --colocando END IF aqui em 12/6/20 e estava na linha 417

--dbms_output.put_line('--vERROS: ' || vERROS);
--dbms_output.put_line('--vALERTAS: ' || vALERTAS);


dbms_output.put_line(C1.LOTE||'|'||C1.DATA_PROCESSAMENTO||'|'||C1.STATUS_PROCESSAMENTO||'|'||C1.ID||'|'||vERROS||C1.ERR_MSG||'|'||vALERTAS||'|'||C1.AUTOIDFICHAATENDIMENTO||'|'||C1.SEQUENCIAL_TEG||'|'||C1.CODIGOEMPRESA
||'|'||C1.CODIGOTIPOCONTRATO||'|'||C1.CODIGOCONTRATO||'|'||C1.NOME||'|'||C1.DATAOCORRENCIA||'|'||C1.ATENDENTE||'|'||C1.DATAEFETIVA||'|'||C1.HORARIOEFETIVO||'|'||C1.TIPOPROCEDIMENTO
||'|'||C1.MODALIDADE||'|'||C1.DATAINICIOAFAST||'|'||C1.DATAFIMAFAST||'|'||C1.DATAINICIALINDEFERIMENTO||'|'||C1.DATAFINALINDEFERIMENTO||'|'||C1.DATARETORNOREAVALIACAO||'|'||
C1.DATACIENCIADECISAO||'|'||C1.CODIGOCONDUTA||'|'||C1.PERIODOLAUDO||'|'||C1.INICIOLAUDO||'|'||C1.FINALLAUDO||'|'||C1.DOENCA||'|'||C1.ESPECIALIDADETRATAMENTO
||'|'||C1.FREQUENCIA_SESSOES||'|'||C1.PERIODOINICIALTRATAMENTO||'|'||C1.PERIODOFINALTRATAMENTO||'|'||C1.QTDE_SESSOES||'|'||C1.ABONO
||'|'||c1.POSITIVOEXAME||'|'||C1.RECONSIDERACAO 
||'|'||C1.MOTIVO||'|'||C1.EXAMECLINICO);


INSERT INTO SUGESP_AJUSTE_LOTE_CAMPO_HIST(CAMPO_VALOR_1, DATA_DADOS, CONSIDERACOES)
VALUES('PR_ANALISE_POS_FICHAS_TEG', SYSDATE, 
'|'||C1.LOTE||'|'||C1.DATA_PROCESSAMENTO||'|'||C1.STATUS_PROCESSAMENTO||'|'||C1.ID||'|'||vERROS||C1.ERR_MSG||'|'||vALERTAS||'|'||C1.AUTOIDFICHAATENDIMENTO||'|'||C1.SEQUENCIAL_TEG||'|'||C1.CODIGOEMPRESA
||'|'||C1.CODIGOTIPOCONTRATO||'|'||C1.CODIGOCONTRATO||'|'||C1.NOME||'|'||C1.DATAOCORRENCIA||'|'||C1.ATENDENTE||'|'||C1.DATAEFETIVA||'|'||C1.HORARIOEFETIVO||'|'||C1.TIPOPROCEDIMENTO
||'|'||C1.MODALIDADE||'|'||C1.DATAINICIOAFAST||'|'||C1.DATAFIMAFAST||'|'||C1.DATAINICIALINDEFERIMENTO||'|'||C1.DATAFINALINDEFERIMENTO||'|'||C1.DATARETORNOREAVALIACAO||'|'||
C1.DATACIENCIADECISAO||'|'||C1.CODIGOCONDUTA||'|'||C1.PERIODOLAUDO||'|'||C1.INICIOLAUDO||'|'||C1.FINALLAUDO||'|'||C1.DOENCA||'|'||C1.ESPECIALIDADETRATAMENTO
||'|'||C1.FREQUENCIA_SESSOES||'|'||C1.PERIODOINICIALTRATAMENTO||'|'||C1.PERIODOFINALTRATAMENTO||'|'||C1.QTDE_SESSOES||'|'||C1.ABONO
||'|'||c1.POSITIVOEXAME||'|'||C1.RECONSIDERACAO 
||'|'||SUBSTR(C1.MOTIVO,1,1500)||'|'||SUBSTR(C1.EXAMECLINICO,1,1500)
);COMMIT;


vERROS := NULL;--NOVO EM 12/6/20
vALERTAS := NULL;--NOVO EM 12/6/20


--dbms_output.put_line('------------------------------------------------------------------------------------------------------------------------------------------------------');
END LOOP;

END;


END;
END; --BEGIN GERAL

--