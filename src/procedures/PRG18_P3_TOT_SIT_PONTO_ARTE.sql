
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."PRG18_P3_TOT_SIT_PONTO_ARTE" (DATA_INICIO IN DATE, DATA_FIM IN DATE) AS
BEGIN
--Kellysson novo em 21/5/21
----------------------*****************************************mudar datas
--novo em 21/5/21--- gravar dados da SIT PONTO do Arterh para comparar com o fechamento do Ifponto

DECLARE   
vCONTADOR NUMBER;
vDATA_INICIO DATE;
vDATA_FIM DATE;

BEGIN 
dbms_output.enable(null);

vCONTADOR := 0;
vDATA_INICIO := DATA_INICIO;
vDATA_FIM := DATA_FIM;


FOR C1 IN (

SELECT X4.* FROM (
SELECT X2.* 
,b.nome,SF.CODIGO COD_SIT_FUNC, SF.DESCRICAO SITUACAO_FUNCIONAL
,E.CODIGO COD_CARGO_EFETIVO, E.DESCRICAO CARGO_EFETIVO, C.CODIGO COD_CARGO_COMISSAO, C.DESCRICAO CARGO_COMISSAO, F.CODIGO COD_FUCNCAO, F.DESCRICAO FUNCAO
, GN.COD_CGERENC1, GN.COD_CGERENC2, GN.COD_CGERENC3, GN.COD_CGERENC4, GN.COD_CGERENC5, GN.COD_CGERENC6, GN.DESCRICAO LOCAL
,B.CODIGO_ESCALA, TJ.c_livre_selec01 Qtd_Total_Minutos, TJ.c_livre_descr02 TOTAL_Carga_HorAria
FROM(
SELECT X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO, X.ORDEM_BM, X.CODIGO_SITUACAO, X.TOTAL_REFERENCIA, X.QUANT_DIAS,
LEAD(X.ORDEM_BM, 1,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS PROXIMA_ORDEM_BM,
LEAD(X.CODIGO_SITUACAO, 1,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS PROXIMO_CODIGO_SITUACAO,
LEAD(X.TOTAL_REFERENCIA, 1,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS PROXIMO_TOTAL_REFERENCIA,
LEAD(X.QUANT_DIAS, 1,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS PROXIMO_QUANT_DIAS
/*,LEAD(X.ORDEM_BM, 2,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS ORDEM_BM_1015,
LEAD(X.CODIGO_SITUACAO, 2,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS CODIGO_SITUACAO_1015,
LEAD(X.TOTAL_REFERENCIA, 2,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS TOTAL_REFERENCIA_1015,
LEAD(X.QUANT_DIAS, 2,NULL) OVER (PARTITION BY X.CODIGO_EMPRESA, X.TIPO_CONTRATO, X.CODIGO_CONTRATO ORDER BY X.ORDEM_BM ) AS QUANT_DIAS_1015*/
from(
select ROW_NUMBER() OVER (PARTITION BY codigo_empresa, tipo_contrato, codigo_contrato ORDER BY codigo_empresa, tipo_contrato, codigo_contrato, codigo_situacao) AS ORDEM_BM,
codigo_empresa, tipo_contrato, codigo_contrato, codigo_situacao, sum(ref_horas)total_referencia, count(1)quant_dias 
from ARTERH.RHPONT_RES_SIT_DIA where trunc(data)between to_date(vDATA_INICIO,'dd/mm/yyyy')and to_date(vDATA_FIM,'dd/mm/yyyy')----------------------*****************************************mudar datas
-- and codigo_situacao in('0020','1013') 
group by codigo_empresa, tipo_contrato, codigo_contrato, codigo_situacao
order by codigo_empresa, tipo_contrato, codigo_contrato, codigo_situacao
)X 
)X2 
LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO B ON B.CODIGO_EMPRESA = X2.CODIGO_EMPRESA AND B.TIPO_CONTRATO = X2.TIPO_CONTRATO AND B.CODIGO = X2.CODIGO_CONTRATO
LEFT OUTER JOIN RHORGA_CUSTO_GEREN GN ON B.CODIGO_EMPRESA = GN.CODIGO_EMPRESA AND b.COD_CUSTO_GERENC1 = GN.cod_cgerenc1 AND b.COD_CUSTO_GERENC2 = GN.cod_cgerenc2 AND b.COD_CUSTO_GERENC3 = GN.cod_cgerenc3
AND b.COD_CUSTO_GERENC4 = GN.cod_cgerenc4 AND b.COD_CUSTO_GERENC5 = GN.cod_cgerenc5 AND b.COD_CUSTO_GERENC6 = GN.cod_cgerenc6
LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF ON SF.CODIGO =  B.SITUACAO_FUNCIONAL 
left outer join ARTERH.RHPLCS_FUNCAO F ON F.CODIGO_EMPRESA = B.CODIGO_EMPRESA AND F.CODIGO = b.codigo_funcao
left outer join ARTERH.RHPLCS_CARGO C ON c.CODIGO_EMPRESA = B.CODIGO_EMPRESA AND c.CODIGO = b.cod_cargo_comiss
left outer join ARTERH.RHPLCS_CARGO E ON e.CODIGO_EMPRESA = B.CODIGO_EMPRESA AND e.CODIGO = b.cod_cargo_efetivo
LEFT OUTER JOIN ARTERH.RHPONT_ESCALA ES ON ES.CODIGO_EMPRESA = B.CODIGO_EMPRESA  AND ES.CODIGO = B.CODIGO_ESCALA
LEFT OUTER JOIN ARTERH.RHPONT_TP_JORNADA TJ ON TJ. CODIGO = ES.TIPO_JORNADA
WHERE
X2.ORDEM_BM = 1
AND b.ANO_MES_REFERENCIA = (SELECT MAX(AUX.ANO_MES_REFERENCIA) FROM ARTERH.RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = b.CODIGO_EMPRESA AND AUX.TIPO_CONTRATO = b.TIPO_CONTRATO AND AUX.CODIGO = b.CODIGO)

--NOVO X4. DEVIDO AO FECHAMENTO COMPLEMENTAR PARA PEGAR APENAS O QUE AINDA ESTA NA select COUNT(1) from PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA WHERE DATA_PROCESSAMENTO IS NULL
)X4
LEFT OUTER JOIN (select EMPRESA, TIPO_CONTRATO, MATRICULA, COUNT(1)QTD_DIAS from PONTO_ELETRONICO.IFPONTO_ESPELHO_HISTORICA WHERE DATA_PROCESSAMENTO IS NULL GROUP BY EMPRESA, TIPO_CONTRATO, MATRICULA)H
ON H.EMPRESA = X4.CODIGO_EMPRESA AND H.TIPO_CONTRATO = X4.TIPO_CONTRATO AND H.MATRICULA = X4.CODIGO_CONTRATO
--INICIO --NOVO EM 11/3/22
LEFT OUTER JOIN
(select CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, DATA_DADOS, CAMPO_1, CONSIDERACOES from PONTO_ELETRONICO.IFPONTO_FECHAMENTO_LOG_RELAT WHERE TRUNC(DATA_DADOS) = TRUNC(SYSDATE) AND CONSIDERACOES = 'PRG17_DESCONTO_ESTAGIO_MES'
)DES ON DES.CODIGO_EMPRESA = X4.CODIGO_EMPRESA AND DES.TIPO_CONTRATO = X4.TIPO_CONTRATO AND DES.CODIGO_CONTRATO = X4.CODIGO_CONTRATO
--FIM --NOVO EM 11/3/22
WHERE H.EMPRESA IS NOT NULL--APENAS O QUE ESTA NA HISTORICA
AND DES.CODIGO_EMPRESA IS NOT NULL--NOVO EM 11/3/22

)
LOOP
vCONTADOR :=vCONTADOR+1;
dbms_output.put_line('--vCONTADOR: '||vCONTADOR);

INSERT INTO ARTERH.TOTAIS_PERIODO_SIT_PONTO_ARTE
      (CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, NOME, COD_SIT_FUNC, SITUACAO_FUNCIONAL, COD_CARGO_EFETIVO, CARGO_EFETIVO, COD_CARGO_COMISSAO, CARGO_COMISSAO, COD_FUCNCAO, FUNCAO, COD_CGERENC1, COD_CGERENC2, COD_CGERENC3, COD_CGERENC4, COD_CGERENC5, COD_CGERENC6, CUSTO_GERENCIAL, DATA_PROCESSAMENTO, CODIGO_ESCALA, QTD_TOTAL_MINUTOS_TIPO_JORNAD, CARGA_HORARIA_TIPO_JORNADA)
VALUES(C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO, C1.NOME, C1.COD_SIT_FUNC, C1.SITUACAO_FUNCIONAL, C1.COD_CARGO_EFETIVO, C1.CARGO_EFETIVO, C1.COD_CARGO_COMISSAO, C1.CARGO_COMISSAO, C1.COD_FUCNCAO, C1.FUNCAO, C1.COD_CGERENC1, C1.COD_CGERENC2, C1.COD_CGERENC3, C1.COD_CGERENC4, C1.COD_CGERENC5, C1.COD_CGERENC6, C1.LOCAL ,SYSDATE, C1.CODIGO_ESCALA, C1.QTD_TOTAL_MINUTOS, C1.TOTAL_CARGA_HORARIA);COMMIT;

END LOOP;

END;

END;