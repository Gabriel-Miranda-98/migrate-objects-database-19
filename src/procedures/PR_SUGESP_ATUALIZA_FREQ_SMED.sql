
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_SUGESP_ATUALIZA_FREQ_SMED" (DATA_INICIO IN VARCHAR2, DATA_FIM IN VARCHAR2)
AS
BEGIN  

  --Kellysson em 23/8/22 emcapsulando em procedure
  --Kellysson novo em 27/7/21 vai haver um SEGUNDO MOMENTO em que a GETED vai pedir para gravar campo livre (Freq. atualizada até:)
DECLARE   
vCONTADOR NUMBER (10);

vDATA_INICIO VARCHAR2(10);
vDATA_FIM VARCHAR2(10);


begin
dbms_output.enable(null);
vCONTADOR :=0;

vDATA_INICIO :=  DATA_INICIO;  --TO_DATE('01/05/2022','DD/MM/YYYY'); -------------------------------------------------------------------------------ALTERAR DATAS
vDATA_FIM := DATA_FIM;  --    TO_DATE('31/05/2022','DD/MM/YYYY');-------------------------------------------------------------------------------ALTERAR DATAS


for C1 in(

select 
CODIGO_EMPRESA, TIPO_AGRUP,COD_AGRUP1, COD_AGRUP2, COD_AGRUP3, COD_AGRUP4, COD_AGRUP5, COD_AGRUP6, DESCRICAO, ABREVIACAO, DATA_EXTINCAO, c_livre_data15 data_frequencia
from RHORGA_AGRUPADOR 
WHERE 
TIPO_AGRUP = 'U' AND CODIGO_EMPRESA = '0001' AND (DATA_EXTINCAO IS NULL OR TRUNC(DATA_EXTINCAO) BETWEEN vDATA_INICIO --TO_DATE('01/05/2022','DD/MM/YYYY')--TRUNC(vDATA_INICIO) 
AND vDATA_FIM -- TO_DATE('31/05/2022','DD/MM/YYYY')--TRUNC(vDATA_FIM) 
)
AND COD_AGRUP1 = '000094'
AND (DESCRICAO LIKE 'ESCOLA MUNICIPAL%' OR DESCRICAO LIKE 'EMEI%' )
ORDER BY DESCRICAO, COD_AGRUP1, COD_AGRUP2, COD_AGRUP3, COD_AGRUP4, COD_AGRUP5, COD_AGRUP6

)

LOOP
vCONTADOR :=vCONTADOR+1;
dbms_output.put_line('--vCONTADOR:'|| vCONTADOR);
dbms_output.put_line('UPDATE RHORGA_UNIDADE SET LOGIN_USUARIO = ''IMP_AMPS_SMED'', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE('''||vDATA_FIM||''',''DD/MM/YYYY'')WHERE CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND COD_UNIDADE1 = '''|| C1.COD_AGRUP1 ||''' AND COD_UNIDADE2 = '''|| C1.COD_AGRUP2 ||''' AND COD_UNIDADE3 = '''|| C1.COD_AGRUP3 ||''' AND COD_UNIDADE4 = '''|| C1.COD_AGRUP4 ||''' AND COD_UNIDADE5 = '''|| C1.COD_AGRUP5 ||''' AND COD_UNIDADE6 = '''|| C1.COD_AGRUP6||''';COMMIT;');	
UPDATE RHORGA_UNIDADE SET LOGIN_USUARIO = 'IMP_AMPS_SMED', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE(vDATA_FIM,'DD/MM/YYYY')WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND COD_UNIDADE1 = C1.COD_AGRUP1 AND COD_UNIDADE2 = C1.COD_AGRUP2 AND COD_UNIDADE3 = C1.COD_AGRUP3 AND COD_UNIDADE4 = C1.COD_AGRUP4 AND COD_UNIDADE5 = C1.COD_AGRUP5 AND COD_UNIDADE6 = C1.COD_AGRUP6;COMMIT;	
dbms_output.put_line('UPDATE RHORGA_AGRUPADOR SET LOGIN_USUARIO = ''IMP_AMPS_SMED'', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE('''||vDATA_FIM||''',''DD/MM/YYYY'')WHERE TIPO_AGRUP = ''U'' AND CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND COD_AGRUP1 = '''|| C1.COD_AGRUP1 ||''' AND COD_AGRUP2 = '''|| C1.COD_AGRUP2 ||''' AND COD_AGRUP3 = '''|| C1.COD_AGRUP3 ||''' AND COD_AGRUP4 = '''|| C1.COD_AGRUP4 ||''' AND COD_AGRUP5 = '''|| C1.COD_AGRUP5 ||''' AND COD_AGRUP6 = '''|| C1.COD_AGRUP6||''';COMMIT;');	
UPDATE RHORGA_AGRUPADOR SET LOGIN_USUARIO = 'IMP_AMPS_SMED', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE(vDATA_FIM,'DD/MM/YYYY')WHERE TIPO_AGRUP = 'U' AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND COD_AGRUP1 = C1.COD_AGRUP1 AND COD_AGRUP2 =  C1.COD_AGRUP2 AND COD_AGRUP3 = C1.COD_AGRUP3 AND COD_AGRUP4 = C1.COD_AGRUP4  AND COD_AGRUP5 = C1.COD_AGRUP5 AND COD_AGRUP6 = C1.COD_AGRUP6;COMMIT;	
dbms_output.put_line('UPDATE RHORGA_AGRUPADOR_H SET LOGIN_USUARIO = ''IMP_AMPS_SMED'', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE('''||vDATA_FIM||''',''DD/MM/YYYY'')WHERE ANO_MES_REFERENCIA = (SELECT MAX(A.ANO_MES_REFERENCIA) FROM RHORGA_AGRUPADOR_H A WHERE A.TIPO_AGRUP = ''U'' AND A.CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND A.COD_AGRUP1 = '''|| C1.COD_AGRUP1 ||''' AND A.COD_AGRUP2 = '''|| C1.COD_AGRUP2 ||''' AND A.COD_AGRUP3 = '''|| C1.COD_AGRUP3 ||''' AND A.COD_AGRUP4 = '''|| C1.COD_AGRUP4 ||''' AND A.COD_AGRUP5 = '''|| C1.COD_AGRUP5 ||''' AND A.COD_AGRUP6 = '''|| C1.COD_AGRUP6||''') AND TIPO_AGRUP = ''U'' AND CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND COD_AGRUP1 = '''|| C1.COD_AGRUP1 ||''' AND COD_AGRUP2 = '''|| C1.COD_AGRUP2 ||''' AND COD_AGRUP3 = '''|| C1.COD_AGRUP3 ||''' AND COD_AGRUP4 = '''|| C1.COD_AGRUP4 ||''' AND COD_AGRUP5 = '''|| C1.COD_AGRUP5 ||''' AND COD_AGRUP6 = '''|| C1.COD_AGRUP6||''';COMMIT;');	
UPDATE RHORGA_AGRUPADOR_H SET LOGIN_USUARIO = 'IMP_AMPS_SMED', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE(vDATA_FIM,'DD/MM/YYYY')WHERE ANO_MES_REFERENCIA = (SELECT MAX(A.ANO_MES_REFERENCIA) FROM RHORGA_AGRUPADOR_H A WHERE A.TIPO_AGRUP = 'U' AND A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA AND A.COD_AGRUP1 = C1.COD_AGRUP1 AND A.COD_AGRUP2 = C1.COD_AGRUP2 AND A.COD_AGRUP3 =  C1.COD_AGRUP3  AND A.COD_AGRUP4 =  C1.COD_AGRUP4  AND A.COD_AGRUP5 =  C1.COD_AGRUP5 AND A.COD_AGRUP6 =  C1.COD_AGRUP6) AND TIPO_AGRUP = 'U' AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA  AND COD_AGRUP1 = C1.COD_AGRUP1  AND COD_AGRUP2 =  C1.COD_AGRUP2 AND COD_AGRUP3 = C1.COD_AGRUP3 AND COD_AGRUP4 = C1.COD_AGRUP4 AND COD_AGRUP5 = C1.COD_AGRUP5 AND COD_AGRUP6 = C1.COD_AGRUP6;COMMIT;	

END LOOP; --FIM LOOP C1



--inicio--novo em 12/4/22 email (URGENTE: Atualização campo "Frequência atualizada até")
for C1 in(

select 
CODIGO_EMPRESA, TIPO_AGRUP,COD_AGRUP1, COD_AGRUP2, COD_AGRUP3, COD_AGRUP4, COD_AGRUP5, COD_AGRUP6, DESCRICAO, ABREVIACAO, DATA_EXTINCAO, c_livre_data15 data_frequencia
from RHORGA_AGRUPADOR 
WHERE 
TIPO_AGRUP = 'G' AND CODIGO_EMPRESA = '0001' AND (DATA_EXTINCAO IS NULL OR TRUNC(DATA_EXTINCAO) BETWEEN vDATA_INICIO --TO_DATE('01/05/2022','DD/MM/YYYY')--TRUNC(vDATA_INICIO) 
AND vDATA_INICIO --TO_DATE('31/05/2022','DD/MM/YYYY')--TRUNC(vDATA_FIM) 
)
AND COD_AGRUP1 = '000094'
AND (DESCRICAO LIKE 'ESCOLA MUNICIPAL%' OR DESCRICAO LIKE 'EMEI%' )
ORDER BY DESCRICAO, COD_AGRUP1, COD_AGRUP2, COD_AGRUP3, COD_AGRUP4, COD_AGRUP5, COD_AGRUP6

)

LOOP
vCONTADOR :=vCONTADOR+1;
dbms_output.put_line('--vCONTADOR:'|| vCONTADOR);

dbms_output.put_line('UPDATE RHORGA_CUSTO_GEREN SET LOGIN_USUARIO = ''IMP_AMPS_SMED'', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE('''||vDATA_FIM||''',''DD/MM/YYYY'')WHERE CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND COD_CGERENC1 = '''|| C1.COD_AGRUP1 ||''' AND COD_CGERENC2 = '''|| C1.COD_AGRUP2 ||''' AND COD_CGERENC3 = '''|| C1.COD_AGRUP3 ||''' AND COD_CGERENC4 = '''|| C1.COD_AGRUP4 ||''' AND COD_CGERENC5 = '''|| C1.COD_AGRUP5 ||''' AND COD_CGERENC6 = '''|| C1.COD_AGRUP6||''';COMMIT;');	
UPDATE RHORGA_CUSTO_GEREN SET LOGIN_USUARIO = 'IMP_AMPS_SMED', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE(vDATA_FIM,'DD/MM/YYYY')WHERE CODIGO_EMPRESA = C1.CODIGO_EMPRESA  AND COD_CGERENC1 =  C1.COD_AGRUP1  AND COD_CGERENC2 =  C1.COD_AGRUP2  AND COD_CGERENC3 =  C1.COD_AGRUP3  AND COD_CGERENC4 =  C1.COD_AGRUP4  AND COD_CGERENC5 =  C1.COD_AGRUP5  AND COD_CGERENC6 =  C1.COD_AGRUP6; COMMIT;	
dbms_output.put_line('UPDATE RHORGA_AGRUPADOR SET LOGIN_USUARIO = ''IMP_AMPS_SMED'', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE('''||vDATA_FIM||''',''DD/MM/YYYY'')WHERE TIPO_AGRUP = ''G'' AND CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND COD_AGRUP1 = '''|| C1.COD_AGRUP1 ||''' AND COD_AGRUP2 = '''|| C1.COD_AGRUP2 ||''' AND COD_AGRUP3 = '''|| C1.COD_AGRUP3 ||''' AND COD_AGRUP4 = '''|| C1.COD_AGRUP4 ||''' AND COD_AGRUP5 = '''|| C1.COD_AGRUP5 ||''' AND COD_AGRUP6 = '''|| C1.COD_AGRUP6||''';COMMIT;');	
UPDATE RHORGA_AGRUPADOR SET LOGIN_USUARIO = 'IMP_AMPS_SME', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE(vDATA_FIM,'DD/MM/YYYY')WHERE TIPO_AGRUP = 'G' AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA  AND COD_AGRUP1 =  C1.COD_AGRUP1  AND COD_AGRUP2 =  C1.COD_AGRUP2  AND COD_AGRUP3 =  C1.COD_AGRUP3  AND COD_AGRUP4 =  C1.COD_AGRUP4  AND COD_AGRUP5 =  C1.COD_AGRUP5  AND COD_AGRUP6 =  C1.COD_AGRUP6;COMMIT;	
dbms_output.put_line('UPDATE RHORGA_AGRUPADOR_H SET LOGIN_USUARIO = ''IMP_AMPS_SMED'', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE('''||vDATA_FIM||''',''DD/MM/YYYY'')WHERE ANO_MES_REFERENCIA = (SELECT MAX(A.ANO_MES_REFERENCIA) FROM RHORGA_AGRUPADOR_H A WHERE A.TIPO_AGRUP = ''G'' AND A.CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND A.COD_AGRUP1 = '''|| C1.COD_AGRUP1 ||''' AND A.COD_AGRUP2 = '''|| C1.COD_AGRUP2 ||''' AND A.COD_AGRUP3 = '''|| C1.COD_AGRUP3 ||''' AND A.COD_AGRUP4 = '''|| C1.COD_AGRUP4 ||''' AND A.COD_AGRUP5 = '''|| C1.COD_AGRUP5 ||''' AND A.COD_AGRUP6 = '''|| C1.COD_AGRUP6||''') AND TIPO_AGRUP = ''G'' AND CODIGO_EMPRESA = '''||C1.CODIGO_EMPRESA ||''' AND COD_AGRUP1 = '''|| C1.COD_AGRUP1 ||''' AND COD_AGRUP2 = '''|| C1.COD_AGRUP2 ||''' AND COD_AGRUP3 = '''|| C1.COD_AGRUP3 ||''' AND COD_AGRUP4 = '''|| C1.COD_AGRUP4 ||''' AND COD_AGRUP5 = '''|| C1.COD_AGRUP5 ||''' AND COD_AGRUP6 = '''|| C1.COD_AGRUP6||''';COMMIT;');	
UPDATE RHORGA_AGRUPADOR_H SET LOGIN_USUARIO = 'IMP_AMPS_SMED', DT_ULT_ALTER_USUA = SYSDATE, c_livre_data15 = TO_DATE(vDATA_FIM,'DD/MM/YYYY')WHERE ANO_MES_REFERENCIA = (SELECT MAX(A.ANO_MES_REFERENCIA) FROM RHORGA_AGRUPADOR_H A WHERE A.TIPO_AGRUP = 'G' AND A.CODIGO_EMPRESA = C1.CODIGO_EMPRESA  AND A.COD_AGRUP1 =  C1.COD_AGRUP1  AND A.COD_AGRUP2 =  C1.COD_AGRUP2  AND A.COD_AGRUP3 =  C1.COD_AGRUP3  AND A.COD_AGRUP4 =  C1.COD_AGRUP4  AND A.COD_AGRUP5 =  C1.COD_AGRUP5  AND A.COD_AGRUP6 =  C1.COD_AGRUP6) AND TIPO_AGRUP = 'G' AND CODIGO_EMPRESA = C1.CODIGO_EMPRESA  AND COD_AGRUP1 =  C1.COD_AGRUP1  AND COD_AGRUP2 =  C1.COD_AGRUP2  AND COD_AGRUP3 =  C1.COD_AGRUP3  AND COD_AGRUP4 =  C1.COD_AGRUP4  AND COD_AGRUP5 =  C1.COD_AGRUP5  AND COD_AGRUP6 =  C1.COD_AGRUP6;COMMIT;	

END LOOP; --FIM LOOP C1

--FIM--novo em 12/4/22 email (URGENTE: Atualização campo "Frequência atualizada até")

END;

END PR_SUGESP_ATUALIZA_FREQ_SMED;