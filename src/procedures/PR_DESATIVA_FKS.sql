
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_DESATIVA_FKS" (
    ACAO IN VARCHAR2,
    ID_PK LISTA,
    TABELA LISTA)
AS
BEGIN
  DECLARE
    vACAO VARCHAR2(10 BYTE);
    vID LISTA;
    CONT NUMBER;
    vTABELA LISTA;
  BEGIN
    vTABELA:=TABELA;
    vACAO:=ACAO;
    vID  :=ID_PK;
    CONT :=0;
    dbms_output.enable(NULL);
    FOR C1 IN
    (

      select x.*,ROW_NUMBER() OVER (Partition BY x.tabela_fk ORDER BY x.tabela_fk,chave_fk_tabela)as id from (SELECT PK.OWNER  AS OWNER_FK ,PK.TABLE_NAME AS TABELA_PK,PK.CONSTRAINT_NAME AS CHAVE_PK_TAELA_VERBA,FK.CONSTRAINT_TYPE ,FK.TABLE_NAME AS TABELA_FK,FK.CONSTRAINT_NAME AS CHAVE_FK_TABELA , LISTAGG(REPLACE(CL.COLUMN_NAME,' ',''),',') WITHIN GROUP(
      ORDER BY CL.POSITION)AS ORDERM_COLUNAS_FK FROM ALL_constraints PK
      LEFT OUTER JOIN ALL_constraints FK
      ON PK.OWNER=FK.R_OWNER
      AND PK.CONSTRAINT_NAME=FK.R_CONSTRAINT_NAME
      LEFT OUTER JOIN ALL_cons_columns CL
      ON CL.OWNER=FK.OWNER
      AND CL.CONSTRAINT_NAME=FK.CONSTRAINT_NAME
      WHERE PK.TABLE_NAME='RHPARM_VERBA' AND PK.CONSTRAINT_TYPE='P' AND PK.OWNER='ARTERH'
      GROUP BY PK.TABLE_NAME ,PK.CONSTRAINT_NAME,FK.CONSTRAINT_TYPE ,FK.TABLE_NAME ,FK.CONSTRAINT_NAME,PK.OWNER
      ORDER BY FK.TABLE_NAME ,FK.CONSTRAINT_NAME)x
      )
       LOOP

      IF vID IS NULL AND vTABELA IS NULL THEN
        DBMS_OUTPUT.PUT_LINE('---ENTROU NA OPÇÃO DE DESATIVAR OU ATIVAR TODAS');
        DBMS_OUTPUT.PUT_LINE('ALTER TABLE '||C1.OWNER_FK||'.'||C1.TABELA_FK||' MODIFY CONSTRAINT '||C1.CHAVE_FK_TABELA||' '||vACAO||';' );
   --     execute immediate 'ALTER TABLE '||C1.OWNER_FK||'.'||C1.NOME_TABELA||' MODIFY CONSTRAINT '||C1.NOME_FK||' '||vACAO||'';
        END IF;
     END LOOP;

     IF ID_PK IS NOT NULL AND vTABELA IS NOT NULL THEN 
      DBMS_OUTPUT.PUT_LINE('---ENTROU NA OPÇÃO DE DESATIVAR OU ATIVAR  UM GRUPO BASEADO NA TABELA E NO ID');
FOR C2 IN
        (select xx.* from (select x.*,TO_CHAR(ROW_NUMBER() OVER (Partition BY x.tabela_fk ORDER BY x.tabela_fk,chave_fk_tabela))as id from (SELECT PK.OWNER  AS OWNER_FK ,PK.TABLE_NAME AS TABELA_PK,PK.CONSTRAINT_NAME AS CHAVE_PK_TAELA_VERBA,FK.CONSTRAINT_TYPE ,FK.TABLE_NAME AS TABELA_FK,FK.CONSTRAINT_NAME AS CHAVE_FK_TABELA , LISTAGG(REPLACE(CL.COLUMN_NAME,' ',''),',') WITHIN GROUP(
      ORDER BY CL.POSITION)AS ORDERM_COLUNAS_FK FROM ALL_constraints PK
      LEFT OUTER JOIN ALL_constraints FK
      ON PK.OWNER=FK.R_OWNER
      AND PK.CONSTRAINT_NAME=FK.R_CONSTRAINT_NAME
      LEFT OUTER JOIN ALL_cons_columns CL
      ON CL.OWNER=FK.OWNER
      AND CL.CONSTRAINT_NAME=FK.CONSTRAINT_NAME
      WHERE PK.TABLE_NAME='RHPARM_VERBA' AND PK.CONSTRAINT_TYPE='P' AND PK.OWNER='ARTERH_PBH'
      GROUP BY PK.TABLE_NAME ,PK.CONSTRAINT_NAME,FK.CONSTRAINT_TYPE ,FK.TABLE_NAME ,FK.CONSTRAINT_NAME,PK.OWNER
      ORDER BY FK.TABLE_NAME ,FK.CONSTRAINT_NAME)x
      )xx
        WHERE TO_CHAR(xx.ID) MEMBER (vID) AND xx.TABELA_FK MEMBER (vTABELA)

        )
        LOOP

     --     execute immediate 'ALTER TABLE '||C2.OWNER_FK||'.'||C2.NOME_TABELA||' MODIFY CONSTRAINT '||C2.NOME_FK||' '||vACAO||'';
          DBMS_OUTPUT.PUT_LINE('ALTER TABLE '||C2.OWNER_FK||'.'||C2.TABELA_FK||' MODIFY CONSTRAINT '||C2.CHAVE_FK_TABELA||' '||vACAO||';' );

        END LOOP;
        ELSIF ID_PK IS NULL AND vTABELA IS NOT NULL THEN 
        DBMS_OUTPUT.PUT_LINE('---ENTROU NA OPÇÃO DE DESATIVAR OU ATIVAR POR  TABELA ');
        FOR C2 IN
        (select xx.* from (select x.*,ROW_NUMBER() OVER (Partition BY x.tabela_fk ORDER BY x.tabela_fk,chave_fk_tabela)as id from (SELECT PK.OWNER  AS OWNER_FK ,PK.TABLE_NAME AS TABELA_PK,PK.CONSTRAINT_NAME AS CHAVE_PK_TAELA_VERBA,FK.CONSTRAINT_TYPE ,FK.TABLE_NAME AS TABELA_FK,FK.CONSTRAINT_NAME AS CHAVE_FK_TABELA , LISTAGG(REPLACE(CL.COLUMN_NAME,' ',''),',') WITHIN GROUP(
      ORDER BY CL.POSITION)AS ORDERM_COLUNAS_FK FROM ALL_constraints PK
      LEFT OUTER JOIN ALL_constraints FK
      ON PK.OWNER=FK.R_OWNER
      AND PK.CONSTRAINT_NAME=FK.R_CONSTRAINT_NAME
      LEFT OUTER JOIN ALL_cons_columns CL
      ON CL.OWNER=FK.OWNER
      AND CL.CONSTRAINT_NAME=FK.CONSTRAINT_NAME
      WHERE PK.TABLE_NAME='RHPARM_VERBA' AND PK.CONSTRAINT_TYPE='P' AND PK.OWNER='ARTERH'
      GROUP BY PK.TABLE_NAME ,PK.CONSTRAINT_NAME,FK.CONSTRAINT_TYPE ,FK.TABLE_NAME ,FK.CONSTRAINT_NAME,PK.OWNER
      ORDER BY FK.TABLE_NAME ,FK.CONSTRAINT_NAME)x
      )xx
        WHERE   xx.TABELA_FK MEMBER (vTABELA)

        )
        LOOP

     --     execute immediate 'ALTER TABLE '||C2.OWNER_FK||'.'||C2.NOME_TABELA||' MODIFY CONSTRAINT '||C2.NOME_FK||' '||vACAO||'';
          DBMS_OUTPUT.PUT_LINE('ALTER TABLE '||C2.OWNER_FK||'.'||C2.TABELA_FK||' MODIFY CONSTRAINT '||C2.CHAVE_FK_TABELA||' '||vACAO||';' );

        END LOOP;
        END IF;
  END;
END;