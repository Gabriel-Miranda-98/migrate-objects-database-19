
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."SMARH_INT_AFASTAMENTOS_INC" (DATA_INICIO IN VARCHAR2, DATA_FIM IN VARCHAR2)
AS
BEGIN
DECLARE
vCONTADOR NUMBER;
vDATA_INICIO Varchar2(10);
vDATA_FIM Varchar2(10);
BEGIN
dbms_output.enable(null);
vCONTADOR :=0;
vDATA_INICIO := DATA_INICIO;
vDATA_FIM := DATA_FIM;
FOR C1 IN
(SELECT X3.*
FROM
  (SELECT
    CASE
      WHEN Xx.CODIGO_EMPRESA = '0001'
      THEN 'PREF.MUN.BELO HORIZONTE'
      WHEN xx.CODIGO_EMPRESA = '0098'
      THEN 'PREF.MUN.BH CONTRATOS'
    END AS EMPRESA,
    CASE
      WHEN Xx.CODIGO_EMPRESA IN ('0001','0098','0015','0021','0032')
      THEN 'ADM DIRETA'
      ELSE 'ADM INDIRETA'
    END AS AGRUPAMENTO_EMPRESA,
    XX.CODIGO_EMPRESA
    ||XX.TIPO_CONTRATO
    ||LTRIM(XX.CODIGO_CONTRATO,0)
    || XX.CODIGO_JUSTIFICATIVA
    ||TO_CHAR(to_date(XX.DATA_INICIO,'dd/mm/yyyy'),'yyyy-MM-dd hh24:mi:ss') AS CODIGO_LEGADO,
    XX.*
  FROM
    (SELECT FIM.TIPO,
      FIM.CODIGO_EMPRESA,
      FIM.TIPO_CONTRATO,
      FIM.CODIGO_CONTRATO,
      FIM.CODIGO_JUSTIFICATIVA,
      FIM.DESCRICAO,
      SYSDATE AS DT_SAIU_ARTE,
      NULL    AS DT_ENVIADO_IFPONTO_SURICATO,
       CASE
        WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')<= TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')  and FIM.FECHAMENTO_SISTEMA IS NOT NULL
        THEN TO_CHAR(TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')+1,'DD/MM/YYYY')
        WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')>TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') AND FIM.FECHAMENTO_SISTEMA IS NOT  NULL
        THEN DATA_INICIO
        ELSE FIM.DATA_INICIO
      END AS DATA_INICIO,
      FIM.DATA_FIM
,FIM.PK_ARTE
    FROM
      (SELECT X.*
      FROM
        (SELECT 'INCLUIR' AS TIPO,
          LC.ID,
          LC.CODIGO_EMPRESA,
          LC.TIPO_CONTRATO,
          LC.CODIGO                AS CODIGO_CONTRATO,
          LC.NEW_COD_SIT_FUNCIONAL AS SITUACAO_FUNCIONAL,
          PN.CODIGO                AS CODIGO_JUSTIFICATIVA,
          PN.DESCRICAO,
          TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')    AS DATA_INICIO,
          TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') AS DATA_FIM,
          C.cod_custo_gerenc1
          || '.'
          || C.cod_custo_gerenc2
          || '.'
          || C.cod_custo_gerenc3
          || '.'
          || C.cod_custo_gerenc4
          || '.'
          || C.cod_custo_gerenc5
          || '.'
          || C.cod_custo_gerenc6                                   AS CODIGO_UNIDADE,
          (SELECT    dado_origem FROM     ARTERH.rhinte_ed_it_conv cv WHERE codigo_conversao = 'FCPT' AND TO_DATE(dado_origem,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.dado_origem,'DD/MM/YYYY')) FROM arterh.rhinte_ed_it_conv aux WHERE cv.codigo_conversao = aux.codigo_conversao))          FECHAMENTO_SISTEMA
, LC.CODIGO_EMPRESA||LC.TIPO_CONTRATO||LC.CODIGO||LC.DATA_INIC_SITUACAO AS PK_ARTE
        FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDITO LC
        LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF
        ON LC.NEW_COD_SIT_FUNCIONAL=SF.CODIGO
        LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO PN
        ON SF.SITUACAO_PONTO=PN.CODIGO
        LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO C
        ON C.CODIGO_EMPRESA=LC.CODIGO_EMPRESA
        AND C.CODIGO       =LC.CODIGO
        AND C.TIPO_CONTRATO=LC.TIPO_CONTRATO

        LEFT OUTER JOIN
          (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT'
          )PONTR
        ON SUBSTR(PONTR.DADO_ORIGEM,20,4)     =LC.CODIGO_EMPRESA
        AND SUBSTR(PONTR.DADO_ORIGEM,24,4)    =LC.TIPO_CONTRATO

        WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4) IS NOT NULL
        AND TIPO_DML                         IN ('I')
        AND LC.ID                             =
          (SELECT MAX(AUX.ID)
          FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDITO AUX
          WHERE AUX.CODIGO                 =LC.CODIGO
          AND AUX.TIPO_CONTRATO            =LC.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA           =LC.CODIGO_EMPRESA
          AND TRUNC(aux.DATA_INIC_SITUACAO)=TRUNC(LC.DATA_INIC_SITUACAO)
        --  AND AUX.TIPO_DML                 =LC.TIPO_DML
          )
        AND C.ANO_MES_REFERENCIA=
          (SELECT MAX(AUX.ANO_MES_REFERENCIA)
          FROM ARTERH.RHPESS_CONTRATO AUX
          WHERE AUX.CODIGO           =C.CODIGO
          AND AUX.TIPO_CONTRATO      =C.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA     =C.CODIGO_EMPRESA
          AND AUX.ANO_MES_REFERENCIA<=
            (SELECT data_do_sistema FROM ARTERH.rhparm_p_sist
            )
          )
        AND PN.TIPO_SITUACAO      IN ('P','I','F')
        AND SF.CONTROLE_FOLHA NOT IN('D','S')
        AND pn.c_livre_valor01='1'
        --PN.usa_apuracao        ='S'
        ---GABRIEL DEIXEI DE USAR EM 27/08/2020 PARA COLOCAR NO LEFT POIS AS NOVAS EMPRESAS NAO TEM FECHAMENTO
       /* AND AP.data_fim_folha      =
          (SELECT MAX(AUX.data_fim_folha)
          FROM ARTERH.RHPONT_APUR_AGRUP AUX
          WHERE AUX.codigo_empresa = AP.CODIGO_EMPRESA
          AND AP.tipo_apur         = AUX.TIPO_APUR
          AND AP.c_livre_selec01   = AUX.c_livre_selec01
          AND AP.id_agrup          = AUX.id_agrup
          )*/
      AND trunc(LC.DT_ULT_ALTER_USUA) BETWEEN vDATA_INICIO AND vDATA_FIM
        )X
      WHERE EXISTS
        (SELECT F.*
        FROM ARTERH.RHCGED_ALT_SIT_FUN F
        WHERE F.CODIGO                 =X.CODIGO_CONTRATO
        AND F.CODIGO_EMPRESA           =X.CODIGO_EMPRESA
        AND F.TIPO_CONTRATO            =X.TIPO_CONTRATO
        AND F.COD_SIT_FUNCIONAL        =X.SITUACAO_FUNCIONAL
        AND TRUNC(F.DATA_INIC_SITUACAO)=TRUNC(TO_DATE(X.DATA_INICIO,'DD/MM/YYYY'))
        )
      UNION ALL
      SELECT X.*
      FROM
        (SELECT 'INCLUIR' AS TIPO,
          LC.ID,
          LC.CODIGO_EMPRESA,
          LC.TIPO_CONTRATO,
          LC.CODIGO                AS CODIGO_CONTRATO,
          LC.NEW_COD_SIT_FUNCIONAL AS SITUACAO_FUNCIONAL,
          PN.CODIGO                AS CODIGO_JUSTIFICATIVA,
          PN.DESCRICAO,
          TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')    AS DATA_INICIO,
          TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') AS DATA_FIM,
          C.cod_custo_gerenc1
          || '.'
          || C.cod_custo_gerenc2
          || '.'
          || C.cod_custo_gerenc3
          || '.'
          || C.cod_custo_gerenc4
          || '.'
          || C.cod_custo_gerenc5
          || '.'
          || C.cod_custo_gerenc6                                   AS CODIGO_UNIDADE,
          (SELECT    dado_origem FROM     ARTERH.rhinte_ed_it_conv cv WHERE codigo_conversao = 'FCPT' AND TO_DATE(dado_origem,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.dado_origem,'DD/MM/YYYY')) FROM arterh.rhinte_ed_it_conv aux WHERE cv.codigo_conversao = aux.codigo_conversao))          FECHAMENTO_SISTEMA
, LC.CODIGO_EMPRESA||LC.TIPO_CONTRATO||LC.CODIGO||LC.DATA_INIC_SITUACAO AS PK_ARTE
        FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDITO LC
        LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF
        ON LC.NEW_COD_SIT_FUNCIONAL=SF.CODIGO
        LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO PN
        ON SF.SITUACAO_PONTO=PN.CODIGO
        LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO C
        ON C.CODIGO_EMPRESA=LC.CODIGO_EMPRESA
        AND C.CODIGO       =LC.CODIGO
        AND C.TIPO_CONTRATO=LC.TIPO_CONTRATO

        LEFT OUTER JOIN
          (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT'
          )PONTR
        ON SUBSTR(PONTR.DADO_ORIGEM,20,4)     =LC.CODIGO_EMPRESA
        AND SUBSTR(PONTR.DADO_ORIGEM,24,4)    =LC.TIPO_CONTRATO



        WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4) IS NOT NULL
        AND TIPO_DML                         IN ('U')
        AND LC.ID                             =
          (SELECT MAX(AUX.ID)
          FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDITO AUX
          WHERE AUX.CODIGO                 =LC.CODIGO
          AND AUX.TIPO_CONTRATO            =LC.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA           =LC.CODIGO_EMPRESA
          AND TRUNC(aux.DATA_INIC_SITUACAO)=TRUNC(LC.DATA_INIC_SITUACAO)
          ---AND AUX.TIPO_DML                 =LC.TIPO_DML
          )
        AND C.ANO_MES_REFERENCIA=
          (SELECT MAX(AUX.ANO_MES_REFERENCIA)
          FROM ARTERH.RHPESS_CONTRATO AUX
          WHERE AUX.CODIGO           =C.CODIGO
          AND AUX.TIPO_CONTRATO      =C.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA     =C.CODIGO_EMPRESA
          AND AUX.ANO_MES_REFERENCIA<=
            (SELECT data_do_sistema FROM ARTERH.rhparm_p_sist
            )
          )
        AND PN.TIPO_SITUACAO      IN ('P','I','F')
        AND SF.CONTROLE_FOLHA NOT IN('D','S')
        AND pn.c_livre_valor01='1'
        --PN.usa_apuracao        ='S'
        ---GABRIEL DEIXEI DE USAR AQUI EM 27/08/2020 E FOI COLOCADO NO LEFT  POIS AS NOVAS EMPRESAS NAO TEM FECHAMENTO
  /*      AND AP.data_fim_folha      =
          (SELECT MAX(AUX.data_fim_folha)
          FROM ARTERH.RHPONT_APUR_AGRUP AUX
          WHERE AUX.codigo_empresa = AP.CODIGO_EMPRESA
          AND AP.tipo_apur         = AUX.TIPO_APUR
          AND AP.c_livre_selec01   = AUX.c_livre_selec01
          AND AP.id_agrup          = AUX.id_agrup
          )*/
          --  AND (LC.NEW_COD_SIT_FUNCIONAL!=LC.OLD_COD_SIT_FUNCIONAL)
    AND trunc(LC.DT_ULT_ALTER_USUA) BETWEEN vDATA_INICIO AND vDATA_FIM
        )X
      WHERE EXISTS
        (SELECT F.*
        FROM ARTERH.RHCGED_ALT_SIT_FUN F
        WHERE F.CODIGO                 =X.CODIGO_CONTRATO
        AND F.CODIGO_EMPRESA           =X.CODIGO_EMPRESA
        AND F.TIPO_CONTRATO            =X.TIPO_CONTRATO
        AND F.COD_SIT_FUNCIONAL        =X.SITUACAO_FUNCIONAL
        AND TRUNC(F.DATA_INIC_SITUACAO)=TRUNC(TO_DATE(X.DATA_INICIO,'DD/MM/YYYY'))
        )
      )FIM
    WHERE TO_DATE(FIM.DATA_FIM,'DD/MM/YYYY')>CASE WHEN TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020','DD/MM/YYYY') ELSE TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') END
    )XX
  )X3
GROUP BY X3.EMPRESA,
  X3.AGRUPAMENTO_EMPRESA,
  X3.CODIGO_LEGADO,
  X3.TIPO,
  X3.CODIGO_EMPRESA,
  X3.TIPO_CONTRATO,
  X3.CODIGO_CONTRATO,
  X3.CODIGO_JUSTIFICATIVA,
  X3.DESCRICAO,
  X3.DT_SAIU_ARTE,
  X3.DT_ENVIADO_IFPONTO_SURICATO,
  X3.DATA_INICIO,
  X3.DATA_FIM
  ,X3.PK_ARTE
    )LOOP
  vCONTADOR :=vCONTADOR+1;
  INSERT INTO PONTO_ELETRONICO.SMARH_INT_PE_AFASTAMENTOS_V1
  (EMPRESA, AGRUPAMENTO_EMPRESA,CODIGO_LEGADO,CODIGO_EMPRESA,TIPO_CONTRATO,CODIGO_CONTRATO,CODIGO_JUSTIFICATIVA,DESCRICAO,DATA_INICIO,DATA_FIM,TIPO,DT_SAIU_ARTE,DT_ENVIADO_IFPONTO_SURICATO,CODIGO_INTEGRA_ARTE, PK_ARTE )
  VALUES
  (C1.EMPRESA,C1.AGRUPAMENTO_EMPRESA,C1.CODIGO_LEGADO,C1.CODIGO_EMPRESA,C1.TIPO_CONTRATO,C1.CODIGO_CONTRATO,C1.CODIGO_JUSTIFICATIVA,C1.DESCRICAO,C1.DATA_INICIO,C1.DATA_FIM,C1.TIPO,C1.DT_SAIU_ARTE,C1.DT_ENVIADO_IFPONTO_SURICATO,PONTO_ELETRONICO.SEQUENCE_INTEGRA_ARTE.NEXTVAL, C1.PK_ARTE);
  COMMIT;
  END LOOP;
  END;


BEGIN
DECLARE
CONT NUMBER;
vDATA_INICIO Varchar2(10);
vDATA_FIM Varchar2(10);
begin
CONT:=0;

dbms_output.enable(null);

vDATA_INICIO := DATA_INICIO;
vDATA_FIM := DATA_FIM;
for c2 in (
 SELECT X3.*
FROM
  (SELECT
    CASE
      WHEN Xx.CODIGO_EMPRESA = '0001'
      THEN 'PREF.MUN.BELO HORIZONTE'
      WHEN xx.CODIGO_EMPRESA = '0098'
      THEN 'PREF.MUN.BH CONTRATOS'
    END AS EMPRESA,
    CASE
      WHEN Xx.CODIGO_EMPRESA IN ('0001','0098','0015','0021','0032')
      THEN 'ADM DIRETA'
      ELSE 'ADM INDIRETA'
    END AS AGRUPAMENTO_EMPRESA,
    XX.CODIGO_EMPRESA
    ||XX.TIPO_CONTRATO
    ||LTRIM(XX.CODIGO_CONTRATO,0)
    || XX.CODIGO_JUSTIFICATIVA
    ||TO_CHAR(to_date(XX.DATA_INICIO,'dd/mm/yyyy'),'yyyy-MM-dd hh24:mi:ss') AS CODIGO_LEGADO,
    XX.*
  FROM
    (SELECT FIM.TIPO,
      FIM.CODIGO_EMPRESA,
      FIM.TIPO_CONTRATO,
      FIM.CODIGO_CONTRATO,
      FIM.CODIGO_JUSTIFICATIVA,
      FIM.DESCRICAO,
      SYSDATE AS DT_SAIU_ARTE,
      NULL    AS DT_ENVIADO_IFPONTO_SURICATO,
      CASE
        WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')<= TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')  and FIM.FECHAMENTO_SISTEMA IS NOT NULL
        THEN TO_CHAR(TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY')+1,'DD/MM/YYYY')
        WHEN TO_DATE(FIM.DATA_INICIO,'DD/MM/YYYY')>TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') AND FIM.FECHAMENTO_SISTEMA IS NOT  NULL
        THEN DATA_INICIO
        ELSE FIM.DATA_INICIO
      END AS DATA_INICIO,
      FIM.DATA_INICIO_REAL,
      FIM.DATA_FIM,
      FIM.SIMULA_DATA,
      FIM.DATA_SIMULADA
      ,FIM.PK_ARTE
    FROM
      (
    SELECT X.*  FROM
        (SELECT 'INCLUIR' AS TIPO,
          LC.ID,
          LC.CODIGO_EMPRESA,
          LC.TIPO_CONTRATO,
          LC.CODIGO                AS CODIGO_CONTRATO,
          LC.NEW_COD_SIT_FUNCIONAL AS SITUACAO_FUNCIONAL,
          PN.CODIGO                AS CODIGO_JUSTIFICATIVA,
          PN.DESCRICAO,
          TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')    AS DATA_INICIO,
          TO_CHAR(LC.DATA_INIC_SITUACAO,'DD/MM/YYYY')   AS DATA_INICIO_REAL,
          CASE WHEN TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') IS NULL THEN TO_CHAR(LAST_DAY(SYSDATE),'DD/MM/YYYY') ELSE TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') END AS DATA_FIM,
          CASE WHEN TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') IS NULL THEN'SIM' ELSE 'NAO' END AS SIMULA_DATA,
          CASE WHEN TO_CHAR(LC.NEW_DATA_FIM_SITUACAO,'DD/MM/YYYY') IS NULL THEN TO_CHAR(LAST_DAY(SYSDATE),'DD/MM/YYYY') ELSE NULL END AS DATA_SIMULADA,
          C.cod_custo_gerenc1
          || '.'
          || C.cod_custo_gerenc2
          || '.'
          || C.cod_custo_gerenc3
          || '.'
          || C.cod_custo_gerenc4
          || '.'
          || C.cod_custo_gerenc5
          || '.'
          || C.cod_custo_gerenc6                                   AS CODIGO_UNIDADE,
                 (SELECT    dado_origem FROM     ARTERH.rhinte_ed_it_conv cv WHERE codigo_conversao = 'FCPT' AND TO_DATE(dado_origem,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.dado_origem,'DD/MM/YYYY')) FROM arterh.rhinte_ed_it_conv aux WHERE cv.codigo_conversao = aux.codigo_conversao))          FECHAMENTO_SISTEMA
, LC.CODIGO_EMPRESA||LC.TIPO_CONTRATO||LC.CODIGO||LC.DATA_INIC_SITUACAO AS PK_ARTE
        FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDITO LC
        LEFT OUTER JOIN ARTERH.RHPARM_SIT_FUNC SF
        ON LC.NEW_COD_SIT_FUNCIONAL=SF.CODIGO
        LEFT OUTER JOIN ARTERH.RHPONT_SITUACAO PN
        ON SF.SITUACAO_PONTO=PN.CODIGO
        LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO C
        ON C.CODIGO_EMPRESA=LC.CODIGO_EMPRESA
        AND C.CODIGO       =LC.CODIGO
        AND C.TIPO_CONTRATO=LC.TIPO_CONTRATO

        LEFT OUTER JOIN
          (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT'
          )PONTR
        ON SUBSTR(PONTR.DADO_ORIGEM,20,4)     =LC.CODIGO_EMPRESA
        AND SUBSTR(PONTR.DADO_ORIGEM,24,4)    =LC.TIPO_CONTRATO

        WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4) IS NOT NULL
        AND TIPO_DML                         IN ('U','I')
        AND LC.ID                             =
          (SELECT MAX(AUX.ID)
          FROM ARTERH.SMARH_INT_PE_ALTSITFUN_AUDITO AUX
          WHERE AUX.CODIGO                 =LC.CODIGO
          AND AUX.TIPO_CONTRATO            =LC.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA           =LC.CODIGO_EMPRESA
          AND TRUNC(aux.DATA_INIC_SITUACAO)=TRUNC(LC.DATA_INIC_SITUACAO)
       --   AND AUX.TIPO_DML                 =LC.TIPO_DML
          )
        AND C.ANO_MES_REFERENCIA=
          (SELECT MAX(AUX.ANO_MES_REFERENCIA)
          FROM ARTERH.RHPESS_CONTRATO AUX
          WHERE AUX.CODIGO           =C.CODIGO
          AND AUX.TIPO_CONTRATO      =C.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA     =C.CODIGO_EMPRESA
          AND AUX.ANO_MES_REFERENCIA<=
            (SELECT data_do_sistema FROM ARTERH.rhparm_p_sist
            )
          )
        AND PN.TIPO_SITUACAO      IN ('P','I','F')
        AND SF.CONTROLE_FOLHA NOT IN('D','S')
        AND pn.c_livre_valor01='1'
        --PN.usa_apuracao        ='S'
       /* AND AP.data_fim_folha      =
          (SELECT MAX(AUX.data_fim_folha)
          FROM ARTERH.RHPONT_APUR_AGRUP AUX
          WHERE AUX.codigo_empresa = AP.CODIGO_EMPRESA
          AND AP.tipo_apur         = AUX.TIPO_APUR
          AND AP.c_livre_selec01   = AUX.c_livre_selec01
          AND AP.id_agrup          = AUX.id_agrup
          )*/
     --      AND trunc(LC.DT_ULT_ALTER_USUA) BETWEEN vDATA_INICIO AND vDATA_FIM
     AND trunc(LC.DT_ULT_ALTER_USUA) BETWEEN vDATA_INICIO AND vDATA_FIM
        )X
      WHERE EXISTS
        (SELECT F.*
        FROM ARTERH.RHCGED_ALT_SIT_FUN F
        WHERE F.CODIGO                 =X.CODIGO_CONTRATO
        AND F.CODIGO_EMPRESA           =X.CODIGO_EMPRESA
        AND F.TIPO_CONTRATO            =X.TIPO_CONTRATO
        AND F.COD_SIT_FUNCIONAL        =X.SITUACAO_FUNCIONAL
        AND TRUNC(F.DATA_INIC_SITUACAO)=TRUNC(TO_DATE(X.DATA_INICIO,'DD/MM/YYYY'))
        ) and x.SIMULA_DATA='SIM'
         )FIM
    WHERE TO_DATE(FIM.DATA_FIM,'DD/MM/YYYY')>CASE WHEN TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020','DD/MM/YYYY') ELSE TO_DATE(FIM.FECHAMENTO_SISTEMA,'DD/MM/YYYY') END
    )XX
    )X3
GROUP BY X3.EMPRESA,
  X3.AGRUPAMENTO_EMPRESA,
  X3.CODIGO_LEGADO,
  X3.TIPO,
  X3.CODIGO_EMPRESA,
  X3.TIPO_CONTRATO,
  X3.CODIGO_CONTRATO,
  X3.CODIGO_JUSTIFICATIVA,
  X3.DESCRICAO,
  X3.DT_SAIU_ARTE,
  X3.DT_ENVIADO_IFPONTO_SURICATO,
  X3.DATA_INICIO,
  X3.DATA_INICIO_REAL,
  X3.DATA_FIM,
  X3.SIMULA_DATA,
  X3.DATA_SIMULADA
  ,X3.PK_ARTE
        )loop
        CONT:=CONT+1;
        INSERT INTO PONTO_ELETRONICO.SMARH_INT_PE_AFASTAMENTOS_V1
  (EMPRESA, AGRUPAMENTO_EMPRESA,CODIGO_LEGADO,CODIGO_EMPRESA,TIPO_CONTRATO,CODIGO_CONTRATO,CODIGO_JUSTIFICATIVA,DESCRICAO,DATA_INICIO,DATA_FIM,SIMULA_DATA,DATA_SIMULADA,TIPO,DT_SAIU_ARTE,DT_ENVIADO_IFPONTO_SURICATO,DATA_INICIO_REAL,CODIGO_INTEGRA_ARTE, PK_ARTE)
  VALUES
  (C2.EMPRESA,C2.AGRUPAMENTO_EMPRESA,C2.CODIGO_LEGADO,C2.CODIGO_EMPRESA,C2.TIPO_CONTRATO,C2.CODIGO_CONTRATO,C2.CODIGO_JUSTIFICATIVA,C2.DESCRICAO,C2.DATA_INICIO,C2.DATA_FIM,C2.SIMULA_DATA,C2.DATA_SIMULADA,C2.TIPO,C2.DT_SAIU_ARTE,C2.DT_ENVIADO_IFPONTO_SURICATO,C2.DATA_INICIO_REAL,PONTO_ELETRONICO.SEQUENCE_INTEGRA_ARTE.NEXTVAL, C2.PK_ARTE);
  COMMIT;
     END LOOP;
        END;

        END;

  END;
