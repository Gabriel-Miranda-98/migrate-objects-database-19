
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_GRAVA_FICHA_MEDICA_TEG" AS BEGIN
--Kellysson 4/10/21- Para gravar atendimentos nas tabelas oficiaias do Arterh referente a FICHA MEDICA

--justificando v4 para em 1/12/20 nova parte de aposentados, inss e ajuste nos campos atendente e doenca na ALT SIT FUNC PARA O ESOCIAL
DECLARE 
err_msg VARCHAR2(4000 BYTE);
vCONTADOR NUMBER;   
--vCONTADOR1 NUMBER;
vCONTADOR2 NUMBER;  
vOCORRENCIA NUMBER;
vOCORRENCIA_ATUAL NUMBER;
vATENDENTE VARCHAR2 (15 BYTE);
vID NUMBER;

vCODIGO_EMPRESA VARCHAR2 (15 BYTE);
vTIPO_CONTRATO VARCHAR2 (4 BYTE);
vCODIGO_PESSOA VARCHAR2 (15 BYTE);
vTEM_MAIS_BM_ATIVO VARCHAR2 (3 BYTE);
vQTD_BMS_MESMO_CODIGO NUMBER;
vPROCEDIMENTO VARCHAR2 (4 BYTE);
vCONDUTA VARCHAR2 (15 BYTE);
vDOENCA VARCHAR2 (15 BYTE);
vCONCOMITA_DT_DEFERIDO VARCHAR2 (3 BYTE);
vVINCULO VARCHAR2 (4 BYTE);
vSITUACAO_FUNCIONAL VARCHAR2 (4 BYTE);
vCONTROLE_FOLHA VARCHAR2 (1 BYTE);
vE_AFASTAMENTO VARCHAR2 (1 BYTE);
vSUSPENDE_REMUNERA VARCHAR2 (1 BYTE);

vPUBLICO_ATUAL VARCHAR2 (3 BYTE);
vSTATUS_SITUACAO_FUNCIONAL VARCHAR2 (30 BYTE);
vPROCXCOND_ABONO VARCHAR2(3 BYTE);
vPROCXCOND_DATADEFERIDO VARCHAR2(3 BYTE); 
vPROCXCOND_DATAINDEFERIDO VARCHAR2(3 BYTE);
vPROCXCOND_ESPECIALIDADETRATA VARCHAR2(3 BYTE);
vPROCXCOND_FIMLAUDO VARCHAR2(3 BYTE);
vPROCXCOND_FIMTRATAMENTO VARCHAR2(3 BYTE);
vPROCXCOND_FREQUENCIA VARCHAR2(3 BYTE);
vPROCXCOND_INICIOLAUDO VARCHAR2(3 BYTE);
vPROCXCOND_INICIOTRATAMENTO VARCHAR2(3 BYTE);
vPROCXCOND_LIMITEDIAS VARCHAR2(3 BYTE);
vPROCXCOND_MINIMODIAS VARCHAR2(3 BYTE);
vPROCXCOND_PERIODOLAUDO VARCHAR2(3 BYTE);
vPROCXCOND_PERMITIDA VARCHAR2(3 BYTE);
vPROCXCOND_QTDE_SESSOES VARCHAR2(3 BYTE);
vPROCXCOND_REAVALIACAO VARCHAR2(3 BYTE);
vPROCXCOND_SEMDATAS VARCHAR2(3 BYTE);
vDIAS VARCHAR2(3 BYTE);
vLIMITEDIAS VARCHAR2(3 BYTE);
vMINIMODIAS VARCHAR2(3 BYTE);
vCONDUTA_CONCOMITASEMDATA VARCHAR2(3 BYTE);
vPROCXCOND_APENASDATAINICIO VARCHAR2(3 BYTE);
vDOENCA_CADASTRADA VARCHAR2(3 BYTE);
vDATA_RESCISAO DATE;
vPODE_PROXIMAS_DOENCAS VARCHAR2(3 BYTE);
vOCOR_DOENCA number;
vLOTES NUMBER;
--vMESMA_DOENCA_FICHA VARCHAR2 (3 BYTE);
vDATA_INI_AFAST DATE;
vDATA_FIM_AFAST DATE;

vDATA_SISTEMA DATE;
vSTATUS_SISTEMA NUMBER;
vDT_FIM_AFAST_PREL_APOSENTA DATE;

BEGIN
dbms_output.enable(null);
err_msg := NULL ;
vID := 0;
vCONTADOR := 0;
--vCONTADOR1 := 0;
vCONTADOR2 := 1;
vOCORRENCIA := 0;
vOCORRENCIA_ATUAL :=0;
vATENDENTE := NULL ;
vCODIGO_EMPRESA := NULL ;
vTIPO_CONTRATO := NULL ;
vCODIGO_PESSOA := NULL ;
vTEM_MAIS_BM_ATIVO := NULL ;
vQTD_BMS_MESMO_CODIGO := 0;
vPROCEDIMENTO := NULL;
vCONDUTA := NULL;
vDOENCA := NULL;
vCONCOMITA_DT_DEFERIDO := NULL;
vVINCULO := NULL;
vSITUACAO_FUNCIONAL := NULL;
vCONTROLE_FOLHA := NULL;
vE_AFASTAMENTO := NULL;
vSUSPENDE_REMUNERA := NULL;

vPUBLICO_ATUAL := NULL;
vSTATUS_SITUACAO_FUNCIONAL := NULL;
vPROCXCOND_ABONO := NULL;
vPROCXCOND_DATADEFERIDO := NULL;
vPROCXCOND_DATAINDEFERIDO := NULL;
vPROCXCOND_ESPECIALIDADETRATA := NULL;
vPROCXCOND_FIMLAUDO := NULL;
vPROCXCOND_FIMTRATAMENTO := NULL;
vPROCXCOND_FREQUENCIA := NULL;
vPROCXCOND_INICIOLAUDO := NULL;
vPROCXCOND_INICIOTRATAMENTO := NULL;
vPROCXCOND_LIMITEDIAS := NULL;
vPROCXCOND_MINIMODIAS := NULL;
vPROCXCOND_PERIODOLAUDO := NULL;
vPROCXCOND_PERMITIDA := NULL;
vPROCXCOND_QTDE_SESSOES := NULL;
vPROCXCOND_REAVALIACAO := NULL;
vPROCXCOND_SEMDATAS := NULL;
vLIMITEDIAS := NULL;
vMINIMODIAS := NULL;
vCONDUTA_CONCOMITASEMDATA := NULL;
vPROCXCOND_APENASDATAINICIO := NULL;
vDOENCA_CADASTRADA := NULL;
vDATA_RESCISAO := NULL;
vPODE_PROXIMAS_DOENCAS := NULL;
vLOTES := 0;
--vMESMA_DOENCA_FICHA := NULL;
vDATA_INI_AFAST := NULL;
vDATA_FIM_AFAST := NULL;
vSTATUS_SISTEMA := 0;
vDT_FIM_AFAST_PREL_APOSENTA := null;


--PEGAR DATA DO SISTEMA ARTERH   
SELECT DATA_DO_SISTEMA INTO vDATA_SISTEMA from rhparm_p_sist;

--STATUS LANCAMENTO SISTEMA ARTERH
SELECT 
CASE 
WHEN (X.F2 > X.FIM_FOLHA AND X.REF_CONTRATO > X.FIM_FOLHA) AND X.FIM_FECHAMENTO IS NULL THEN 1 /*'1-SISTEMA_FECHADO_DATAS_OK'*/
WHEN (X.F2 <= X.FIM_FOLHA OR X.REF_CONTRATO <= X.FIM_FOLHA) AND X.FIM_FECHAMENTO IS NULL THEN 2/*'2-SISTEMA_FECHADO_DATAS_ERRADAS'*/
WHEN (X.F2 > X.FIM_FOLHA AND X.REF_CONTRATO > X.FIM_FOLHA) AND X.FIM_FECHAMENTO IS NOT NULL THEN 3/*'3-SISTEMA_ABERTO_DATAS_OK'*/
WHEN (X.F2 <= X.FIM_FOLHA OR X.REF_CONTRATO <= X.FIM_FOLHA) AND X.FIM_FECHAMENTO IS NOT NULL THEN 4/*'4-SISTEMA_ABERTO_DATAS_ERRADAS'*/
ELSE 0 /*'FALTA MAPEAR'*/
END CENARIOS 
INTO vSTATUS_SISTEMA
 FROM(
select (SELECT DATA_DO_SISTEMA FROM rhparm_p_sist) AS F2, (SELECT DT_REFER_CADASTRO FROM rhparm_p_sist) AS REF_CONTRATO, u.data_ini_vigencia INICIO_FECHAMENTO, u.data_fim_vigencia FIM_FECHAMENTO, u.data_ini_folha INICIO_FOLHA, data_fim_folha FIM_FOLHA from RHPONT_APUR_AGRUP u 
where u.ocorrencia = (seLECT MAX(x.ocorrencia) from RHPONT_APUR_AGRUP x where x.codigo_empresa = '0001' and x.tipo_apur = 'F' AND c_livre_selec01 = 3 AND id_agrup = 152123)
and u.c_livre_selec01 = 3 --em 22/3/21
)X;

--AJUSTAR DATA DOS SISTEMA PARA DATA FIM DO AFAST_PRELIMINAR_APOSENTA
SELECT CASE 
WHEN vSTATUS_SISTEMA IN (1,2) THEN ADD_MONTHS(vDATA_SISTEMA,1)-1 
WHEN vSTATUS_SISTEMA IN (3,4) AND TRUNC(LAST_DAY(vDATA_SISTEMA)) <  TRUNC(LAST_DAY(SYSDATE)) THEN TO_DATE(vDATA_SISTEMA,'DD/MM/YYYY')-1 
WHEN vSTATUS_SISTEMA IN (3,4) AND TRUNC(LAST_DAY(vDATA_SISTEMA)) >= TRUNC(LAST_DAY(SYSDATE)) THEN ADD_MONTHS(vDATA_SISTEMA,1)-1 

END 
INTO vDT_FIM_AFAST_PREL_APOSENTA from rhparm_p_sist;



--PR_FICHA_MEDICA_ORIGEM_TEG;  ---------------PARA JÁ GERAR SIT FUNC/PONTO
/*
FOR
C0 IN 
(
SELECT CASE WHEN SEQUENCIAL_TEG IS NULL THEN 'PBH' ELSE 'TEG' END ORIGEM, X.* FROM(
SELECT SEQUENCIAL_TEG, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, ATENDENTE, COUNT(1)QUANT FROM SUGESP_ARQUIVOS_FICHA WHERE DATA_PROCESSAMENTO IS NULL
GROUP BY SEQUENCIAL_TEG, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, ATENDENTE  ORDER BY CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, ATENDENTE
)X
) 
LOOP
*/

PR_FICHA_MEDICA_ORIGEM_TEG;--NOVO EM 7/5/20 PARA OS ERROS:  restrição exclusiva (ARTERH.RHCGED_ALT_S_FU_P) violada

--QUANTIDADE LOTES
SELECT MAX(LOTE)INTO vLOTES FROM SUGESP_ARQUIVOS_FICHA WHERE DATA_PROCESSAMENTO IS NULL ; 

for i in 1.. vLOTES 
loop

dbms_output.put_line('--i: '||i);
dbms_output.put_line('------------------------------------------------------------INICIO-------------------------------------------------------------');
FOR
C1 IN 
(

--INICIO ----------------------------------------------------------------------------LOOP----------------------------------------------------------
/*
SELECT
X7.DATA_RESCISAO, X7.DADO_ORIGEM_TC1, X7.DADO_DESTINO_TC1, X7.DTINICIO_MAIOR_DTATUAL, X7.DTFIM_MAIOR_DTINICIO, X7.STATUS_PUBLICO_ATUAL, X7.STATUS_CONTRATO,
X7.STATUS_ID_ATENDIMENTO, X7.STATUS_SEQUENCIAL, X7.STATUS_DT_REG_OCORRENCIA, X7.STATUS_PROCED_CONDUTA, X7.STATUS_CODIGO_ATENDENTE, X7.STATUS_DATAS_DEFERIMENTO,
X7.STATUS_DATAS_INDEFERIMENTO, X7.STATUS_DATAS_DEFER_INDEFER, X7.STATUS_DATA_PREV_RETORNO, X7.STATUS_PERIODOLAUDO, X7.STATUS_INICIOLAUDO, X7.STATUS_FIMLAUDO, 
X7.STATUS_ESPECIALIDADETRATAMENTO, X7.STATUS_FREQUENCIA_SESSOES, X7.STATUS_PERIODOINICIALTRAT, X7.STATUS_PERIODOFINALTRAT, X7.STATUS_QTDE_SESSOES, X7.STATUS_ABONO, 
X7.STATUS_LIMITEDIAS, X7.STATUS_MINIMODIAS, X7.VINCULO, X7.SITUACAO_FUNCIONAL, X7.CONTROLE_FOLHA, X7.E_AFASTAMENTO, X7.SUSPENDE_REMUNERA, X7.PUBLICO_ATUAL, 
X7.STATUS_SITUACAO_FUNCIONAL, X7.PROCXCOND_PERMITIDA, X7.PROCXCOND_DATADEFERIDO, X7.PROCXCOND_DATAINDEFERIDO, X7.PROCXCOND_SEMDATAS, X7.PROCXCOND_LIMITEDIAS, 
X7.LIMITEDIAS, X7.PROCXCOND_MINIMODIAS, X7.MINIMODIAS, X7.PROCXCOND_REAVALIACAO, X7.PROCXCOND_PERIODOLAUDO, X7.PROCXCOND_INICIOLAUDO, X7.PROCXCOND_FIMLAUDO, 
X7.PROCXCOND_ESPECIALIDADETRATA, X7.PROCXCOND_FREQUENCIA, X7.PROCXCOND_INICIOTRATAMENTO, X7.PROCXCOND_FIMTRATAMENTO, X7.PROCXCOND_QTDE_SESSOES, X7.PROCXCOND_ABONO, 
X7.CONDUTA_CONCOMITASEMDATA, X7.PROCXCOND_APENASDATAINICIO, X7.EXISTE_ARQUIVO_IMP, X7.EXISTE_FICHA_ARTE, X7.DATA_INI_AFAST_DIFERE, X7.DATA_FIM_AFAST_DIFERE, 
X7.DATA_INI_INDEFERIDO_DIFERE, X7.DATA_FIM_INDEFERIDO_DIFERE, X7.ORDEM_ID_ATENDIMENTO_CONTRATO, X7.TIPO, X7.PROXIMO_TIPO, X7.ORIGEM, X7.TIPO_DATA, X7.ID_ATENDIMENTO, 
X7.PROXIMO_ID_ATENDIMENTO, X7.SEQUENCIAL, X7.PROXIMO_SEQUENCIAL, X7.CODIGO_EMPRESA, X7.TIPO_CONTRATO, X7.CODIGO_CONTRATO, X7.CODIGO_PESSOA, X7.DT_REG_OCORRENCIA, 
X7.OCORRENCIA, X7.TIPO_PROCEDIMENTO, X7.CODIGO_CONDUTA, X7.DATA_INICIO_AFAST, X7.PROXIMA_DATA_INICIO_AFAST, X7.DATA_FIM_AFAST, X7.PROXIMA_DATA_FIM_AFAST, 
X7.DATA_INICIO_INDEFERIMENTO, X7.PROXIMA_DATA_INICIO_INDEFER, X7.DATA_FIM_INDEFERIMENTO, X7.PROXIMA_DATA_FIM_INDEFER, X7.DT_ULT_ALTER_USUA, X7.LOGIN_USUARIO,
X7.STATUS_PESSOA, X7.VALOR_PERIODOLAUDO, X7.STATUS_TAMANHO_ESPEC_TRATAM, X7.STATUS_TAMANHO_FREQ_SESSOES, X7.QTDE_SESSOES, X7.ABONO, X7.STATUS_TAMANHO_MOTIVO, 
X7.STATUS_TAMANHO_EXAMECLINICO, X7.CODIGO_ATENDENTE, X7.DATARETORNOREAVALIACAO, X7.PERIODOLAUDO, X7.INICIOLAUDO, X7.FINALLAUDO, X7.TAMANHO_ESPEC_TRATAM, 
X7.ESPECIALIDADETRATAMENTO, X7.TAMANHO_FREQ_SESSOES, X7.FREQUENCIA_SESSOES, X7.PERIODOINICIALTRATAMENTO, X7.PERIODOFINALTRATAMENTO, X7.TAMANHO_MOTIVO, X7.MOTIVO, 
X7.TAMANHO_EXAMECLINICO, X7.EXAMECLINICO, X7.ID, COUNT(1)QUANT FROM (
*/

select
A.DATA_RESCISAO, TC1.DADO_ORIGEM DADO_ORIGEM_TC1, TC1.DADO_DESTINO DADO_DESTINO_TC1,
X6.* 
from (
--INICIO X5 substituindo X----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
select 
CASE WHEN 
(TRUNC(X5.DT_REG_OCORRENCIA)> TRUNC(SYSDATE)) 
OR (X5.DATA_INICIO_AFAST IS NOT NULL AND TRUNC(X5.DATA_INICIO_AFAST)> TRUNC(SYSDATE)+120)--COMENTADO em 27/7/20--Toffalini nesta data via hangouts pediu para tirar a regra de lançamento de deferimento futuro e reprocessar o que foi rejeitado
--comentado em 26/5/20--OR (X5.DATA_INICIO_INDEFERIMENTO IS NOT NULL AND TRUNC(X5.DATA_INICIO_INDEFERIMENTO)> TRUNC(SYSDATE)) 
THEN 'SIM' ELSE 'NAO' END DTINICIO_MAIOR_DTATUAL,

CASE 
WHEN (X5.DATA_INICIO_AFAST IS NOT NULL AND TRUNC(X5.DATA_FIM_AFAST) < TRUNC(X5.DATA_INICIO_AFAST)) 
OR (X5.DATA_INICIO_INDEFERIMENTO IS NOT NULL AND TRUNC(X5.DATA_FIM_INDEFERIMENTO) < TRUNC(X5.DATA_INICIO_INDEFERIMENTO)) 
THEN 'SIM' ELSE 'NAO' END DTFIM_MAIOR_DTINICIO,

CASE WHEN X5.CODIGO_EMPRESA IS NULL THEN 'CAMPO_EMPRESA_VAZIO'
WHEN LPAD(X5.CODIGO_EMPRESA,4,0) IN (SELECT CODIGO FROM RHORGA_EMPRESA) AND X5.PUBLICO_ATUAL = 'SIM' THEN 'INTEGRA_FICHAS_EMPRESA_TIPO_CONTRATO_VINCULO' 
WHEN LPAD(X5.CODIGO_EMPRESA,4,0) IN (SELECT CODIGO FROM RHORGA_EMPRESA) AND X5.PUBLICO_ATUAL = 'NAO' THEN 'NAO_INTEGRA_FICHAS_EMPRESA_TIPO_CONTRATO_VINCULO' 
ELSE 'EMPRESA_INEXISTENTE' END STATUS_PUBLICO_ATUAL,

CASE WHEN X5.CODIGO_CONTRATO IS NULL THEN 'COD_CONTRATO_VAZIO'
WHEN (SELECT COUNT(1) FROM RHPESS_CONTR_MEST M WHERE M.CODIGO_CONTRATO = X5.CODIGO_CONTRATO AND M.CODIGO_EMPRESA = LPAD(X5.CODIGO_EMPRESA,4,0) AND M.TIPO_CONTRATO = LPAD(X5.TIPO_CONTRATO,4,0)) = 0 THEN 'COD_CONTRATO_NAO_LOCALIZADO'
ELSE 'COD_CONTRATO_OK' END STATUS_CONTRATO,

CASE WHEN X5.ID_ATENDIMENTO IS NULL THEN 'ID_ATENDIMENTO_VAZIO' ELSE 'ID_ATENDIMENTO_OK' END STATUS_ID_ATENDIMENTO,
CASE WHEN X5.SEQUENCIAL IS NULL THEN 'SEQUENCIAL_VAZIO' ELSE 'SEQUENCIAL_OK' END STATUS_SEQUENCIAL,

CASE WHEN X5.DT_REG_OCORRENCIA IS NULL THEN 'DT_REG_OCORRENCIA_VAZIA' ELSE 'DATA_PREENCHIDA' END STATUS_DT_REG_OCORRENCIA,

CASE when X5.PROCXCOND_PERMITIDA = 'SIM' THEN 'PROCEDIMENTO_CONDUTA_INTEGRA'
when X5.PROCXCOND_PERMITIDA = 'NAO' THEN 'PROCEDIMENTO_CONDUTA_NAO_INTEGRA'
 END STATUS_PROCED_CONDUTA,

CASE WHEN X5.CODIGO_ATENDENTE IS NULL THEN 'CODIGO_ATENDENTE_VAZIO' 
WHEN X5.CODIGO_ATENDENTE IS NOT NULL AND X5.CODIGO_PESSOA IS NULL THEN 'ATENDENTE_NAO_CADASTRADO'
WHEN X5.CODIGO_ATENDENTE IS NOT NULL AND X5.CODIGO_PESSOA IS NOT NULL THEN 'ATENDENTE_CADASTRADO'
ELSE 'VERIFICAR INDIVUDALMENTE' END STATUS_CODIGO_ATENDENTE,

--CASE WHEN X5.DATAEFETIVA IS NULL THEN 'DATA_EFETIVA_VAZIA' ELSE 'DATA_EFETIVA_OK' END STATUS_DATA_EFETIVA,
--CASE WHEN X5.HORARIOEFETIVO IS NULL THEN 'HORARIO_EFETIVO_VAZIO' ELSE 'HORARIO_EFETIVO_OK' END STATUS_HORARIO_EFETIVO,

CASE WHEN X5.PROCXCOND_DATADEFERIDO = 'SIM' AND (X5.DATA_INICIO_AFAST IS NULL OR X5.DATA_FIM_AFAST IS NULL) THEN 'FALTA_DATA' ELSE 'OK'
END STATUS_DATAS_DEFERIMENTO,

CASE WHEN X5.PROCXCOND_DATAINDEFERIDO = 'SIM' AND (X5.DATA_INICIO_INDEFERIMENTO IS NULL OR X5.DATA_FIM_INDEFERIMENTO IS NULL) THEN 'FALTA_DATA' ELSE 'OK' 
END STATUS_DATAS_INDEFERIMENTO,

CASE WHEN X5.PROCXCOND_SEMDATAS = 'SIM' AND (X5.DATA_INICIO_AFAST IS NOT NULL OR X5.DATA_FIM_AFAST IS NOT NULL OR X5.DATA_INICIO_INDEFERIMENTO IS NOT NULL OR X5.DATA_FIM_INDEFERIMENTO IS NOT NULL) 
THEN 'DATA_PODE_HAVER_DATAS' ELSE 'OK' END STATUS_DATAS_DEFER_INDEFER,

CASE WHEN X5.PROCXCOND_REAVALIACAO = 'SIM' AND X5.DataRetornoReavaliacao IS NULL THEN 'FALTA_DATA' ELSE 'OK' END STATUS_DATA_PREV_RETORNO,

CASE WHEN X5.PERIODOLAUDO IS NULL AND X5.PROCXCOND_PERIODOLAUDO = 'SIM'
THEN 'FALTA_PERIODO_LAUDO'
ELSE 'OK' END STATUS_PERIODOLAUDO, --CONDUTA

CASE WHEN X5.INICIOLAUDO IS NULL AND X5.PROCXCOND_INICIOLAUDO = 'SIM' THEN 'FALTA_DATA_INICIO_LAUDO'
ELSE 'OK' END STATUS_INICIOLAUDO, --CONDUTA

CASE WHEN X5.FINALLAUDO IS NULL AND X5.PROCXCOND_FIMLAUDO = 'SIM' THEN 'FALTA_DATA_FIM_LAUDO'
ELSE 'OK' END STATUS_FIMLAUDO, --CONDUTA

CASE WHEN X5.EspecialidadeTratamento IS NULL AND X5.PROCXCOND_ESPECIALIDADETRATA = 'SIM'  THEN 'FALTA_ESPECIALIDADE_TRATAMENTO'
ELSE 'OK' END STATUS_ESPECIALIDADETRATAMENTO, --DOENCA PROBLEMA TAMANHO

CASE WHEN X5.Frequencia_Sessoes IS NULL AND X5.PROCXCOND_FREQUENCIA = 'SIM' THEN 'FALTA_FREQUENCIA_SESSOES'
ELSE 'OK' END STATUS_FREQUENCIA_SESSOES, --DOENCA PROBLEMA TAMANHO

CASE WHEN X5.PeriodoInicialTratamento IS NULL AND X5.PROCXCOND_INICIOTRATAMENTO = 'SIM' THEN 'FALTA_DATA_INICIO_TRATAMENTO'
ELSE 'OK' END STATUS_PERIODOINICIALTRAT, --DOENCA PROBLEMA DATA JÁ COM TEG

CASE WHEN X5.PeriodoFinalTratamento IS NULL AND  X5.PROCXCOND_FIMTRATAMENTO = 'SIM' THEN 'FALTA_DATA_FIM_TRATAMENTO'
ELSE 'OK' END STATUS_PERIODOFINALTRAT, --DOENCA PROBLEMA DATA JÁ COM TEG

CASE WHEN X5.QTDE_SESSOES IS NULL AND  X5.PROCXCOND_QTDE_SESSOES = 'SIM' THEN 'FALTA_QTDE_SESSOES'
ELSE 'OK' END STATUS_QTDE_SESSOES, --DOENCA CRIAR AINDA NA TEG

CASE WHEN X5.ABONO IS NULL AND  X5.PROCXCOND_ABONO = 'SIM' THEN 'FALTA_ABONO'
ELSE 'OK' END STATUS_ABONO, --DOENCA CRIAR AINDA NA TEG

CASE WHEN X5.PROCXCOND_LIMITEDIAS = 'SIM' AND ( TO_DATE(X5.DATA_FIM_AFAST,'DD/MM/YYYY') - TO_DATE(X5.DATA_INICIO_AFAST,'DD/MM/YYYY') > TO_NUMBER(X5.LIMITEDIAS))THEN 'LIMITE_DIAS_ERRADO'
ELSE 'OK' END STATUS_LIMITEDIAS,

CASE WHEN X5.PROCXCOND_MINIMODIAS = 'SIM' AND ( TO_DATE(X5.DATA_FIM_AFAST,'DD/MM/YYYY') - TO_DATE(X5.DATA_INICIO_AFAST,'DD/MM/YYYY') < TO_NUMBER(X5.MINIMODIAS))THEN 'LIMITE_DIAS_ERRADO'
ELSE 'OK' END STATUS_MINIMODIAS,

x5.* from (
--INICIO----------------------------------TEG6 -- VALIDAR SE ESTA NO PUBLICO DA TABELA DE CONVERSAO TEG6----------------------------------
--INICIO----------------------------------TEG7 -- VALIDAR SE ESTA NAS REGRAS ATUAIS MAEPADAS PELA GESER PARA PREENCHIMENTO DE FICHAS MEDICAS DA TABELA DE CONVERSAO TEG7----------------------------------
select --c2.codigo_empresa, c2.tipo_contrato, c2.codigo_pessoa, 
C2.VINCULO, C2.SITUACAO_FUNCIONAL, ZX.CONTROLE_FOLHA, ZX.E_AFASTAMENTO, ZX.SUSPENDE_REMUNERA 
,CASE WHEN TEG6.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PUBLICO_ATUAL
,CASE WHEN TEG6SF.DADO_ORIGEM IS NOT NULL THEN 'PODE_USAR' ELSE 'NAO_PODE_USAR' END STATUS_SITUACAO_FUNCIONAL
,CASE WHEN TEG7A.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_PERMITIDA
,CASE WHEN TEG7B.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_DATADEFERIDO
,CASE WHEN TEG7C.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_DATAINDEFERIDO
,CASE WHEN TEG7D.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_SEMDATAS
,CASE WHEN TEG7E.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_LIMITEDIAS
,CASE WHEN TEG7E.DADO_ORIGEM IS NOT NULL THEN SUBSTR(TEG7E.DADO_ORIGEM,52,3) ELSE '0' END LIMITEDIAS
,CASE WHEN TEG7F.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_MINIMODIAS
,CASE WHEN TEG7F.DADO_ORIGEM IS NOT NULL THEN SUBSTR(TEG7F.DADO_ORIGEM,53,3) ELSE '0' END MINIMODIAS
,CASE WHEN TEG7G.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_REAVALIACAO
,CASE WHEN TEG7H.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_PERIODOLAUDO
,CASE WHEN TEG7I.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_INICIOLAUDO
,CASE WHEN TEG7J.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FIMLAUDO
,CASE WHEN TEG7K.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_ESPECIALIDADETRATA
,CASE WHEN TEG7L.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FREQUENCIA
,CASE WHEN TEG7M.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_INICIOTRATAMENTO
,CASE WHEN TEG7N.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FIMTRATAMENTO
,CASE WHEN TEG7O.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_QTDE_SESSOES
,CASE WHEN TEG7P.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_ABONO
,CASE WHEN TEG7Q.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END CONDUTA_CONCOMITASEMDATA
,CASE WHEN TEG7R.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_APENASDATAINICIO 
,X4.* FROM(

select 
case WHEN Z3.ORDEM_ID_ATENDIMENTO_CONTRATO = 1  and z3.tipo = 'FICHA_ARTERH' THEN 'NAO' ELSE 'SIM' END EXISTE_ARQUIVO_IMP,
z3.* from(

SELECT 
--case WHEN Z2.PROXIMO_ID_ATENDIMENTO IS NULL and z2.tipo = 'ARQUIVO_IMP' THEN 'NAO' ELSE 'SIM' END EXISTE_FICHA_ARTE,
case WHEN Z2.PROXIMO_TIPO IS NOT NULL AND Z2.PROXIMO_TIPO = 'FICHA_ARTERH' and Z2.SEQUENCIAL = Z2.PROXIMO_SEQUENCIAL THEN 'SIM' ELSE 'NAO' END EXISTE_FICHA_ARTE,
case WHEN Z2.DATA_INICIO_AFAST IS NOT NULL AND Z2.PROXIMA_DATA_INICIO_AFAST IS NOT NULL AND Z2.DATA_INICIO_AFAST <> Z2.PROXIMA_DATA_INICIO_AFAST THEN 'SIM' ELSE 'NAO' END DATA_INI_AFAST_DIFERE,
case WHEN Z2.DATA_FIM_AFAST IS NOT NULL AND Z2.PROXIMA_DATA_FIM_AFAST IS NOT NULL AND Z2.DATA_FIM_AFAST <> Z2.PROXIMA_DATA_FIM_AFAST THEN 'SIM' ELSE 'NAO' END DATA_FIM_AFAST_DIFERE,
case WHEN Z2.DATA_INICIO_INDEFERIMENTO IS NOT NULL AND Z2.PROXIMA_DATA_INICIO_INDEFER IS NOT NULL AND Z2.DATA_INICIO_INDEFERIMENTO <> Z2.PROXIMA_DATA_INICIO_INDEFER THEN 'SIM' ELSE 'NAO' END DATA_INI_INDEFERIDO_DIFERE,
case WHEN Z2.DATA_FIM_INDEFERIMENTO IS NOT NULL AND Z2.PROXIMA_DATA_FIM_INDEFER IS NOT NULL AND Z2.DATA_FIM_INDEFERIMENTO <> Z2.PROXIMA_DATA_FIM_INDEFER THEN 'SIM' ELSE 'NAO' END DATA_FIM_INDEFERIDO_DIFERE,
Z2.* FROM(

SELECT 
ROW_NUMBER() OVER (PARTITION BY Z.SEQUENCIAL ORDER BY  Z.TIPO,Z.ID) AS ORDEM_ID_ATENDIMENTO_CONTRATO,
Z.TIPO,
LEAD(Z.TIPO, 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO) AS PROXIMO_TIPO,
Z.ORIGEM,
Z.TIPO_DATA, Z.ID_ATENDIMENTO, 
LEAD(Z.ID_ATENDIMENTO, 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO,Z.ID) AS PROXIMO_ID_ATENDIMENTO,
Z.SEQUENCIAL, 
LEAD(Z.SEQUENCIAL, 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO,Z.ID) AS PROXIMO_SEQUENCIAL,
Z.CODIGO_EMPRESA, Z.TIPO_CONTRATO, Z.CODIGO_CONTRATO, Z.CODIGO_PESSOA, Z.DT_REG_OCORRENCIA, Z.OCORRENCIA, Z.TIPO_PROCEDIMENTO, Z.CODIGO_CONDUTA --, Z.DOENCA, 
,Z.DATA_INICIO_AFAST,
LEAD(TRUNC(Z.DATA_INICIO_AFAST), 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO,Z.ID) AS PROXIMA_DATA_INICIO_AFAST,
Z.DATA_FIM_AFAST,
LEAD(TRUNC(Z.DATA_FIM_AFAST), 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO,Z.ID) AS PROXIMA_DATA_FIM_AFAST,
Z.DATA_INICIO_INDEFERIMENTO,
LEAD(TRUNC(Z.DATA_INICIO_INDEFERIMENTO), 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO,Z.ID) AS PROXIMA_DATA_INICIO_INDEFER,
Z.DATA_FIM_INDEFERIMENTO,
LEAD(TRUNC(Z.DATA_FIM_INDEFERIMENTO), 1, NULL) OVER (PARTITION BY Z.SEQUENCIAL ORDER BY Z.TIPO,Z.ID) AS PROXIMA_DATA_FIM_INDEFER
,Z.DT_ULT_ALTER_USUA,Z.LOGIN_USUARIO
,Z.STATUS_PESSOA, Z.VALOR_PERIODOLAUDO,-- Z.STATUS_CODIGO_EMPRESA, Z.STATUS_INICIO_TRATAMENTO, Z.STATUS_FIM_TRATAMENTO, 
Z.STATUS_TAMANHO_ESPEC_TRATAM, Z.STATUS_TAMANHO_FREQ_SESSOES,
Z.QTDE_SESSOES, Z.ABONO,
Z.STATUS_TAMANHO_MOTIVO, Z.STATUS_TAMANHO_EXAMECLINICO
, Z.codigo_atendente, Z.DATARETORNOREAVALIACAO,--  Z.DATAEFETIVA, Z.HORARIOEFETIVO, 
Z.PERIODOLAUDO, Z.INICIOLAUDO, Z.FINALLAUDO, Z.TAMANHO_ESPEC_TRATAM, Z.ESPECIALIDADETRATAMENTO,
Z.TAMANHO_FREQ_SESSOES, Z.FREQUENCIA_SESSOES, Z.PERIODOINICIALTRATAMENTO, Z.PERIODOFINALTRATAMENTO, Z.TAMANHO_MOTIVO, Z.MOTIVO, Z.TAMANHO_EXAMECLINICO, Z.EXAMECLINICO
--,Z.QUANT
--,Z.DATA_PROCESSAMENTO
,Z.ID, Z.LOTE
,  Z.POSITIVOEXAME, Z.RECONSIDERACAO
FROM(
---------------------------------------------------------------------------------INICIO-----------------CONTEUDO TABELAS--UNION -------------------------------------------------------------------------------------
select
'ARQUIVO_IMP' TIPO, X.ORIGEM , 'NULL' TIPO_DATA,
CASE WHEN M.CODIGO_PESSOA IS NULL THEN 'PESSOA_NAO_LOCALIZADA' ELSE 'OK' END STATUS_PESSOA,
CASE WHEN X.PERIODOLAUDO < 0 OR X.PERIODOLAUDO > 9999 THEN 'VALOR_ERRADO' ELSE 'OK' END VALOR_PERIODOLAUDO,
--CASE WHEN lpad(X.CODIGOEMPRESA,4,'0')  not in ('0001','1700') THEN 'EMPRESA_NAO_RECONHECIDA' ELSE 'OK' END STATUS_CODIGO_EMPRESA,
--CASE WHEN X.PERIODOINICIALTRATAMENTO IS NOT NULL THEN 'IGNORADO' END STATUS_INICIO_TRATAMENTO,
--CASE WHEN X.PERIODOFINALTRATAMENTO IS NOT NULL THEN 'IGNORADO' END STATUS_FIM_TRATAMENTO,
CASE WHEN LENGTH(X.ESPECIALIDADETRATAMENTO) >40 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_ESPEC_TRATAM,
CASE WHEN LENGTH(X.FREQUENCIA_SESSOES) > 40 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_FREQ_SESSOES,
CASE WHEN LENGTH(X.MOTIVO) > 2000 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_MOTIVO,
CASE WHEN LENGTH(X.EXAMECLINICO) > 2000 THEN 'ULTRAPASSOU' ELSE 'OK' END STATUS_TAMANHO_EXAMECLINICO,
M.CODIGO_PESSOA,
X.CODIGOEMPRESA CODIGO_EMPRESA,
UPPER(LPAD(REPLACE(X.CODIGOCONTRATO, '-', ''),15,'0')) CODIGO_CONTRATO,
X.AUTOIDFICHAATENDIMENTO ID_ATENDIMENTO, TO_DATE(X.DATAOCORRENCIA,'DD/MM/YY') DT_REG_OCORRENCIA, NULL OCORRENCIA, 
LPAD(X.TIPOPROCEDIMENTO,4,0) TIPO_PROCEDIMENTO, X.ATENDENTE codigo_atendente, 
TO_DATE(X.DATAINICIOAFAST,'DD/MM/YY') DATA_INICIO_AFAST, 
TO_DATE(X.DATAFIMAFAST,'DD/MM/YY') DATA_FIM_AFAST, 
X.DATARETORNOREAVALIACAO, -- X.DATAEFETIVA, X.HORARIOEFETIVO, 
X.DATAINICIALINDEFERIMENTO DATA_INICIO_INDEFERIMENTO, 
X.DATAFINALINDEFERIMENTO DATA_FIM_INDEFERIMENTO ,
--X.DOENCA, 
X.CODIGOCONDUTA CODIGO_CONDUTA, X.PERIODOLAUDO, X.INICIOLAUDO, X.FINALLAUDO, LENGTH(X.ESPECIALIDADETRATAMENTO) TAMANHO_ESPEC_TRATAM, X.ESPECIALIDADETRATAMENTO,
LENGTH(X.FREQUENCIA_SESSOES) TAMANHO_FREQ_SESSOES, X.FREQUENCIA_SESSOES, X.PERIODOINICIALTRATAMENTO, X.PERIODOFINALTRATAMENTO, TO_CHAR(X.SEQUENCIAL_TEG)SEQUENCIAL
,LENGTH(X.MOTIVO) TAMANHO_MOTIVO, X.MOTIVO, LENGTH(X.EXAMECLINICO) TAMANHO_EXAMECLINICO, X.EXAMECLINICO
,NULL dt_ult_alter_usua, NULL LOGIN_USUARIO --, X.DATA_PROCESSAMENTO
,X.CODIGOTIPOCONTRATO TIPO_CONTRATO , X.QTDE_SESSOES, X.ABONO
--,X.QUANT
,X.ID, X.LOTE
, X.POSITIVOEXAME, X.RECONSIDERACAO
from 
(
--inicio------------------------------------------------------------------------------------1º nivel, nucleo do select
/*select R3.ORIGEM, R3.FICHA_DIA,
R3.AUTOIDFICHAATENDIMENTO, R3.SEQUENCIAL_TEG, R3.CODIGOEMPRESA, R3.CODIGOTIPOCONTRATO, R3.CODIGOCONTRATO, R3.DATAOCORRENCIA, R3.ATENDENTE, R3.TIPOPROCEDIMENTO, R3.DATAINICIOAFAST, 
R3.DATAFIMAFAST, R3.DATAINICIALINDEFERIMENTO, R3.DATAFINALINDEFERIMENTO, R3.DATARETORNOREAVALIACAO, R3.DATACIENCIADECISAO, R3.CODIGOCONDUTA, R3.PERIODOLAUDO, R3.INICIOLAUDO, 
R3.FINALLAUDO, R3.ESPECIALIDADETRATAMENTO, R3.FREQUENCIA_SESSOES, R3.PERIODOINICIALTRATAMENTO, R3.PERIODOFINALTRATAMENTO, R3.QTDE_SESSOES, R3.ABONO, R3.MOTIVO, R3.EXAMECLINICO
--,R3.QUANT
,R3.ID, R3.LOTE
, R3.POSITIVOEXAME, R3.RECONSIDERACAO
FROM(
*/
SELECT R2.* 
--R2.ORIGEM, R2.FICHA_DIA , X.*
FROM(
SELECT CASE WHEN AUTOIDFICHAATENDIMENTO = 1 THEN 'PBH' ELSE 'TEG' END ORIGEM, 
ROW_NUMBER() OVER (PARTITION BY CODIGOEMPRESA, CODIGOTIPOCONTRATO, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO ORDER BY ID ) AS FICHA_DIA,
R.* 
FROM(
SELECT *
/*AUTOIDFICHAATENDIMENTO, SEQUENCIAL_TEG, CODIGOEMPRESA, CODIGOTIPOCONTRATO, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, ATENDENTE, CODIGOCONDUTA, DATAINICIOAFAST, DATAFIMAFAST
, DOENCA, ID, LOTE--novo em 13/6/20
, POSITIVOEXAME, RECONSIDERACAO --NOVO EM 15/9/20
,COUNT(1)QUANT 
*/
FROM SUGESP_ARQUIVOS_FICHA WHERE 
DATA_PROCESSAMENTO IS NULL 
--TRUNC(DATA_PROCESSAMENTO) = TO_DATE('15/09/2020','DD/MM/YYYY')--TESTES EM 16/9/20
and codigoempresa is not null
and codigoempresa in (SELECT SUBSTR(DADO_ORIGEM,27,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,27,4) )
and codigotipocontrato in (SELECT SUBSTR(DADO_ORIGEM,31,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,31,4) )
/*GROUP BY AUTOIDFICHAATENDIMENTO, SEQUENCIAL_TEG, CODIGOEMPRESA, CODIGOTIPOCONTRATO, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, ATENDENTE, CODIGOCONDUTA, DATAINICIOAFAST, DATAFIMAFAST
, DOENCA, ID, LOTE --novo em 13/6/20
, POSITIVOEXAME,  RECONSIDERACAO --NOVO EM 15/9/20
*/
ORDER BY ID-- AUTOIDFICHAATENDIMENTO, SEQUENCIAL_TEG , CODIGOEMPRESA, CODIGOTIPOCONTRATO, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, CODIGOCONDUTA ,DATAINICIOAFAST, DATAFIMAFAST
--,DOENCA--novo em 13/6/20
)R
)R2
/*LEFT OUTER JOIN SUGESP_ARQUIVOS_FICHA X ON 
R2.CODIGOEMPRESA = X.CODIGOEMPRESA AND R2.CODIGOTIPOCONTRATO = X.CODIGOTIPOCONTRATO AND R2.CODIGOCONTRATO = X.CODIGOCONTRATO 
AND R2.DATAOCORRENCIA = X.DATAOCORRENCIA AND R2.TIPOPROCEDIMENTO = X.TIPOPROCEDIMENTO AND R2.CODIGOCONDUTA = X.CODIGOCONDUTA 
AND R2.DOENCA = X.DOENCA --novo em 13/6/20
AND R2.AUTOIDFICHAATENDIMENTO = X.AUTOIDFICHAATENDIMENTO --NOVO EM 23/9/20
WHERE 
--X.DATA_PROCESSAMENTO IS NULL --OFICIAL REGISTROS A SEREM FILTRADOS
TRUNC(X.DATA_PROCESSAMENTO) = TO_DATE('15/09/2020','DD/MM/YYYY')--TESTES EM 16/9/20
)R3
GROUP BY 
R3.ORIGEM, R3.FICHA_DIA,
R3.AUTOIDFICHAATENDIMENTO, R3.SEQUENCIAL_TEG, R3.CODIGOEMPRESA, R3.CODIGOTIPOCONTRATO, R3.CODIGOCONTRATO, R3.DATAOCORRENCIA, R3.ATENDENTE, R3.TIPOPROCEDIMENTO, R3.DATAINICIOAFAST, 
R3.DATAFIMAFAST, R3.DATAINICIALINDEFERIMENTO, R3.DATAFINALINDEFERIMENTO, R3.DATARETORNOREAVALIACAO, R3.DATACIENCIADECISAO, R3.CODIGOCONDUTA, R3.PERIODOLAUDO, R3.INICIOLAUDO, 
R3.FINALLAUDO, R3.ESPECIALIDADETRATAMENTO, R3.FREQUENCIA_SESSOES, R3.PERIODOINICIALTRATAMENTO, R3.PERIODOFINALTRATAMENTO, R3.QTDE_SESSOES, R3.ABONO, R3.MOTIVO, R3.EXAMECLINICO
--,R3.QUANT
,R3.ID, R3.LOTE , R3.POSITIVOEXAME, R3.RECONSIDERACAO
ORDER BY R3.ID
*/
)X
--fim------------------------------------------------------------------------------------1º nivel, nucleo do select
LEFT OUTER JOIN RHPESS_CONTR_MEST M ON M.CODIGO_EMPRESA = lpad(X.CODIGOEMPRESA,4,'0') AND M.TIPO_CONTRATO = lpad(X.CODIGOTIPOCONTRATO,4,'0') AND M.CODIGO_CONTRATO = UPPER(LPAD(REPLACE(x.CODIGOCONTRATO, '-', ''),15,'0')) 

UNION ALL

select 'FICHA_ARTERH' TIPO, 'TEG' ORIGEM,
CASE WHEN x.data_ini_afast IS NOT NULL AND x.data_fim_afast IS NOT NULL AND x.DATA_INI_INDEF IS NULL AND x.DATA_FIM_INDEF IS NULL THEN 'DEFERIDA' 
     WHEN x.data_ini_afast IS NULL AND x.data_fim_afast IS NULL AND x.DATA_INI_INDEF IS NOT NULL AND x.DATA_FIM_INDEF IS NOT NULL THEN 'INDEFERIDA'
     WHEN x.data_ini_afast IS NOT NULL AND x.data_fim_afast IS NOT NULL AND x.DATA_INI_INDEF IS NOT NULL AND x.DATA_FIM_INDEF IS NOT NULL THEN 'DEFERIDA E INDEFERIDA'
     WHEN (x.data_ini_afast IS NOT NULL AND x.data_fim_afast IS NULL)OR (x.data_ini_afast IS NULL AND x.data_fim_afast IS NOT NULL) OR (x.DATA_INI_INDEF IS NOT NULL AND x.DATA_FIM_INDEF IS NULL) OR (x.DATA_INI_INDEF IS NULL AND x.DATA_FIM_INDEF IS NOT NULL)
     OR (x.data_ini_afast IS NULL AND x.data_fim_afast IS NOT NULL AND x.DATA_INI_INDEF IS NOT NULL AND x.DATA_FIM_INDEF IS NULL)or 
    (X.data_ini_afast is null and X.data_fim_afast is null AND X.DATA_INI_INDEF is null and X.DATA_FIM_INDEF is null) OR (X.data_ini_afast is NOT null and X.data_fim_afast is null AND X.DATA_INI_INDEF is null and X.DATA_FIM_INDEF is null)OR
    (X.data_ini_afast is null and X.data_fim_afast is NOT null AND X.DATA_INI_INDEF is null and X.DATA_FIM_INDEF is null)OR (X.data_ini_afast is null and X.data_fim_afast is null AND X.DATA_INI_INDEF is NOT null and X.DATA_FIM_INDEF is null) OR
    (X.data_ini_afast is null and X.data_fim_afast is null AND X.DATA_INI_INDEF is null and X.DATA_FIM_INDEF is NOT null) THEN 'ERRO NAS DATAS'
END TIPO_DATA,
NULL STATUS_PESSOA, NULL VALOR_PERIODOLAUDO, 
--NULL STATUS_CODIGO_EMPRESA, NULL STATUS_INICIO_TRATAMENTO, NULL STATUS_FIM_TRATAMENTO, 
NULL STATUS_TAMANHO_ESPEC_TRATAM, NULL STATUS_TAMANHO_FREQ_SESSOES, NULL STATUS_TAMANHO_MOTIVO, NULL STATUS_TAMANHO_EXAMECLINICO, 
X.CODIGO_PESSOA, x.CODIGO_EMPRESA, X.CODIGO_CONTRATO, X.ID_ATENDIMENTO, TO_DATE(X.DT_REG_OCORRENCIA,'DD/MM/YY') DT_REG_OCORRENCIA, 
X.OCORRENCIA, X.natureza_exame TIPO_PROCEDIMENTO, NULL codigo_atendente,
TO_DATE(x.data_ini_afast,'DD/MM/YY') DATA_INICIO_AFAST, 
TO_DATE(x.data_fim_afast,'DD/MM/YY') DATA_FIM_AFAST,
NULL DATARETORNOREAVALIACAO,
--,  NULL DATAEFETIVA, NULL HORARIOEFETIVO, 
TO_DATE(x.DATA_INI_INDEF,'DD/MM/YY') DATA_INICIO_INDEFERIMENTO, 
TO_DATE(x.DATA_FIM_INDEF,'DD/MM/YY') DATA_FIM_INDEFERIMENTO,
--NULL DOENCA, 
NULL CODIGO_CONDUTA,
NULL PERIODOLAUDO, NULL INICIOLAUDO, NULL FINALLAUDO, NULL TAMANHO_ESPEC_TRATAM, NULL ESPECIALIDADETRATAMENTO,
NULL TAMANHO_FREQ_SESSOES, NULL FREQUENCIA_SESSOES, NULL PERIODOINICIALTRATAMENTO, NULL PERIODOFINALTRATAMENTO, 
X.NOVO_SEQUENCIAL SEQUENCIAL--TO_CHAR(x.LOCAL_ATENDIMENTO) SEQUENCIAL
,NULL TAMANHO_MOTIVO, NULL MOTIVO, NULL TAMANHO_EXAMECLINICO, NULL EXAMECLINICO,
--TO_CHAR(X.dt_ult_alter_usua, 'DD/MM/YYYY HH24:MI:SS')dt_ult_alter_usua, X.LOGIN_USUARIO, --NULL DATA_PROCESSAMENTO
NULL dt_ult_alter_usua, NULL LOGIN_USUARIO,
X.TIPO_CONTRATO , NULL QTDE_SESSOES, NULL ABONO
--,1 QUANT
,NULL ID, NULL LOTE , NULL POSITIVOEXAME, NULL RECONSIDERACAO
from --RHMEDI_FICHA_MED 
(
--INICIO --juntando, ficha, conduta e doenca
select 
ROW_NUMBER()OVER(PARTITION BY F.CODIGO_EMPRESA ,F.CODIGO_PESSOA ,F.DT_REG_OCORRENCIA ,F.OCORRENCIA ORDER BY F.OCORRENCIA)AS ORDEM_NA_FICHA,
F.C_LIVRE_VALOR01 ID_ATENDIMENTO, F.C_LIVRE_VALOR02 ANTIGO_SEQUENCIAL, F.LOCAL_ATENDIMENTO NOVO_SEQUENCIAL, 
F.CODIGO_EMPRESA, F.CODIGO_PESSOA, F.DT_REG_OCORRENCIA, F.OCORRENCIA, F.TIPO_CONTRATO, F.CODIGO_CONTRATO, F.NATUREZA_EXAME, E.DESCRICAO PROCEDIMENTO,
P.OCOR_PROC_MED OCOR_CONDUTA, P.CODIGO_PROC_MED CODIGO_CONDUTA, C.DESCRICAO CONDUTA, 
D.OCOR_DOENCA OCOR_DOENCA, D.COD_DOENCA, DOE.DESCRICAO DOENCA_, 
CASE WHEN F.DATA_INI_AFAST IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE F.DATA_INI_AFAST END DATA_INI_AFAST,
CASE WHEN F.DATA_FIM_AFAST IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE F.DATA_FIM_AFAST END DATA_FIM_AFAST,
CASE WHEN F.c_livre_data01 IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE F.c_livre_data01 END DATA_INI_INDEF, 
CASE WHEN F.c_livre_data02 IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE F.c_livre_data02 END DATA_FIM_INDEF, 
F.DATA_CONCLUSAO DATA_CIENCIA, 
f.login_usuario login_ficha , F.DT_ULT_ALTER_USUA dt_ficha
,d.login_usuario login_doe ,d.DT_ULT_ALTER_USUA dt_doe
from RHMEDI_FICHA_MED F
LEFT OUTER JOIN  RHMEDI_RL_FICH_DOE D ON F.CODIGO_EMPRESA = D.CODIGO_EMPRESA AND F.CODIGO_PESSOA = D.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = D.DT_REG_OCORRENCIA AND F.OCORRENCIA = D.OCORRENCIA
LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = D.COD_DOENCA
LEFT OUTER JOIN RHMEDI_NATUREZA_EX E ON E.CODIGO_EMPRESA = F.CODIGO_EMPRESA AND E.CODIGO = F.NATUREZA_EXAME
LEFT OUTER JOIN RHMEDI_RL_FICH_PRO P ON F.CODIGO_EMPRESA = P.CODIGO_EMPRESA AND F.CODIGO_PESSOA = P.CODIGO_PESSOA AND F.DT_REG_OCORRENCIA = P.DT_REG_OCORRENCIA AND F.OCORRENCIA = P.OCORRENCIA
LEFT OUTER JOIN RHMEDI_PROC_MED C ON C.CODIGO_PROC_MED = P.CODIGO_PROC_MED
LEFT OUTER JOIN RHPESS_PESSOA PS ON F.CODIGO_EMPRESA = PS.CODIGO_EMPRESA and F.CODIGO_PESSOA = PS.CODIGO
order by F.CODIGO_EMPRESA ,F.CODIGO_PESSOA ,F.DT_REG_OCORRENCIA ,F.OCORRENCIA, P.OCORRENCIA
, D.OCOR_DOENCA
)
X 
WHERE 
--ATE 23/9/20-- X.LOCAL_ATENDIMENTO IN (SELECT SEQUENCIAL_TEG FROM SUGESP_ARQUIVOS_FICHA WHERE DATA_PROCESSAMENTO IS NULL AND AUTOIDFICHAATENDIMENTO <> 1 )
EXISTS
(
SELECT A.* FROM(
SELECT
ABONO, ATENDENTE, AUTOIDFICHAATENDIMENTO, CODIGOCONDUTA, CODIGOCONTRATO, CODIGOEMPRESA, CODIGOTIPOCONTRATO, DATA_PROCESSAMENTO, DATA_RECEBIMENTO, DATACIENCIADECISAO, DATAEFETIVA,
CASE WHEN DATAINICIOAFAST IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE DATAINICIOAFAST END DATAINICIOAFAST,
CASE WHEN DATAFIMAFAST IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE DATAFIMAFAST END DATAFIMAFAST,
CASE WHEN DATAINICIALINDEFERIMENTO IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE DATAINICIALINDEFERIMENTO END DATAINICIALINDEFERIMENTO,
CASE WHEN DATAFINALINDEFERIMENTO IS NULL THEN TO_DATE('01/01/1900','DD/MM/YYYY') ELSE DATAFINALINDEFERIMENTO END DATAFINALINDEFERIMENTO,
DATAOCORRENCIA, DATARETORNOREAVALIACAO, DOENCA, ESPECIALIDADETRATAMENTO, EXAMECLINICO, FINALLAUDO, FREQUENCIA_SESSOES, HORARIOEFETIVO, ID, INICIOLAUDO, LOTE, MODALIDADE, MOTIVO, NOME, PERIODOFINALTRATAMENTO, PERIODOINICIALTRATAMENTO, PERIODOLAUDO, POSITIVOEXAME, QTDE_SESSOES, RECONSIDERACAO, SEQUENCIAL_TEG, STATUS_PROCESSAMENTO, TIPOPROCEDIMENTO
FROM SUGESP_ARQUIVOS_FICHA WHERE DATA_PROCESSAMENTO IS NULL AND AUTOIDFICHAATENDIMENTO <> 1
)A
WHERE 
X.CODIGO_EMPRESA = A.CODIGOEMPRESA AND X.TIPO_CONTRATO = A.CODIGOTIPOCONTRATO AND X.CODIGO_CONTRATO = A.CODIGOCONTRATO
AND TRUNC(X.DT_REG_OCORRENCIA) = TRUNC(A.DATAOCORRENCIA) AND X.ID_ATENDIMENTO = A.AUTOIDFICHAATENDIMENTO
AND X.NATUREZA_EXAME = A.TIPOPROCEDIMENTO 
AND X.CODIGO_CONDUTA = A.CODIGOCONDUTA AND X.COD_DOENCA = A.DOENCA --para desconsiderar duplicidades devido ao erro do sequencial
AND TRUNC(A.DATAINICIOAFAST) = TRUNC(X.DATA_INI_AFAST) AND TRUNC(A.DATAFIMAFAST) = TRUNC(X.DATA_FIM_AFAST) 
AND TRUNC(A.DATAINICIALINDEFERIMENTO) = TRUNC(X.DATA_INI_INDEF) AND TRUNC(A.DATAFINALINDEFERIMENTO) = TRUNC(X.DATA_FIM_INDEF)--DATAS

)

UNION ALL

select 'FICHA_ARTERH' TIPO, 'PBH' ORIGEM,
CASE WHEN x.data_ini_afast IS NOT NULL AND x.data_fim_afast IS NOT NULL AND x.c_livre_data01 IS NULL AND x.c_livre_data02 IS NULL THEN 'DEFERIDA' 
     WHEN x.data_ini_afast IS NULL AND x.data_fim_afast IS NULL AND x.c_livre_data01 IS NOT NULL AND x.c_livre_data02 IS NOT NULL THEN 'INDEFERIDA'
     WHEN x.data_ini_afast IS NOT NULL AND x.data_fim_afast IS NOT NULL AND x.c_livre_data01 IS NOT NULL AND x.c_livre_data02 IS NOT NULL THEN 'DEFERIDA E INDEFERIDA'
     WHEN (x.data_ini_afast IS NOT NULL AND x.data_fim_afast IS NULL)OR (x.data_ini_afast IS NULL AND x.data_fim_afast IS NOT NULL) OR (x.c_livre_data01 IS NOT NULL AND x.c_livre_data02 IS NULL) OR (x.c_livre_data01 IS NULL AND x.c_livre_data02 IS NOT NULL)
     OR (x.data_ini_afast IS NULL AND x.data_fim_afast IS NOT NULL AND x.c_livre_data01 IS NOT NULL AND x.c_livre_data02 IS NULL)or 
    (X.data_ini_afast is null and X.data_fim_afast is null AND X.c_livre_data01 is null and X.c_livre_data02 is null) OR (X.data_ini_afast is NOT null and X.data_fim_afast is null AND X.c_livre_data01 is null and X.c_livre_data02 is null)OR
    (X.data_ini_afast is null and X.data_fim_afast is NOT null AND X.c_livre_data01 is null and X.c_livre_data02 is null)OR (X.data_ini_afast is null and X.data_fim_afast is null AND X.c_livre_data01 is NOT null and X.c_livre_data02 is null) OR
    (X.data_ini_afast is null and X.data_fim_afast is null AND X.c_livre_data01 is null and X.c_livre_data02 is NOT null) THEN 'ERRO NAS DATAS'
END TIPO_DATA,
NULL STATUS_PESSOA, NULL VALOR_PERIODOLAUDO, --NULL STATUS_CODIGO_EMPRESA, NULL STATUS_INICIO_TRATAMENTO, NULL STATUS_FIM_TRATAMENTO, 
NULL STATUS_TAMANHO_ESPEC_TRATAM, NULL STATUS_TAMANHO_FREQ_SESSOES, NULL STATUS_TAMANHO_MOTIVO, NULL STATUS_TAMANHO_EXAMECLINICO, 
X.CODIGO_PESSOA, x.CODIGO_EMPRESA, X.CODIGO_CONTRATO, x.C_LIVRE_VALOR01 ID_ATENDIMENTO, TO_DATE(X.DT_REG_OCORRENCIA,'DD/MM/YY') DT_REG_OCORRENCIA, X.OCORRENCIA, X.natureza_exame TIPO_PROCEDIMENTO, X.codigo_atendente,
TO_DATE(x.data_ini_afast,'DD/MM/YY') DATA_INICIO_AFAST, 
TO_DATE(x.data_fim_afast,'DD/MM/YY') DATA_FIM_AFAST,
NULL DATARETORNOREAVALIACAO,
--,  NULL DATAEFETIVA, NULL HORARIOEFETIVO, 
TO_DATE(x.c_livre_data01,'DD/MM/YY') DATA_INICIO_INDEFERIMENTO, 
TO_DATE(x.c_livre_data02,'DD/MM/YY') DATA_FIM_INDEFERIMENTO,
--NULL DOENCA, 
NULL CODIGO_CONDUTA,
NULL PERIODOLAUDO, NULL INICIOLAUDO, NULL FINALLAUDO, NULL TAMANHO_ESPEC_TRATAM, NULL ESPECIALIDADETRATAMENTO,
NULL TAMANHO_FREQ_SESSOES, NULL FREQUENCIA_SESSOES, NULL PERIODOINICIALTRATAMENTO, NULL PERIODOFINALTRATAMENTO, 
TO_CHAR(x.LOCAL_ATENDIMENTO) SEQUENCIAL
,NULL TAMANHO_MOTIVO, NULL MOTIVO, NULL TAMANHO_EXAMECLINICO, NULL EXAMECLINICO,
TO_CHAR(X.dt_ult_alter_usua, 'DD/MM/YYYY HH24:MI:SS')dt_ult_alter_usua, X.LOGIN_USUARIO --, NULL DATA_PROCESSAMENTO
,X.TIPO_CONTRATO , NULL QTDE_SESSOES, NULL ABONO
--,1 QUANT 
,NULL ID, NULL LOTE, NULL POSITIVOEXAME, NULL RECONSIDERACAO
from RHMEDI_FICHA_MED x 
WHERE x.LOCAL_ATENDIMENTO IN (SELECT SEQUENCIAL_TEG FROM SUGESP_ARQUIVOS_FICHA WHERE DATA_PROCESSAMENTO IS NULL AND AUTOIDFICHAATENDIMENTO = 1 AND LENGTH(SEQUENCIAL_TEG)=43 )
---------------------------------------------------------------------------------FIM-----------------CONTEUDO TABELAS--UNION-------------------------------------------------------------------------------------
)Z ORDER BY Z.ID
)Z2 
)Z3
WHERE Z3.TIPO ='ARQUIVO_IMP' or (Z3.TIPO ='FICHA_ARTERH' 
--comentei em 24/9/20--and Z3.ORDEM_ID_ATENDIMENTO_CONTRATO = 1 
)

)X4
LEFT OUTER JOIN(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, C.VINCULO, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
, SF.CONTROLE_FOLHA, SF.E_AFASTAMENTO, SF.SUSPENDE_REMUNERA 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where 
--c.codigo = X4.CODIGO_CONTRATO-- '000000000912674'
--AND c.TIPO_CONTRATO = X4.TIPO_CONTRATO
--AND C.CODIGO_EMPRESA = X4.CODIGO_EMPRESA
--and 
c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux 
                  where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)Zx ON ZX.codigo_empresa = X4.codigo_empresa AND ZX.tipo_contrato = X4.tipo_contrato AND ZX.codigo = X4.CODIGO_CONTRATO
left outer join rhpess_contrato c2 ON Zx.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND ZX.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO' )TEG6 
ON ZX.CODIGO_EMPRESA = SUBSTR(TEG6.DADO_ORIGEM,27,4) AND ZX.TIPO_CONTRATO = SUBSTR(TEG6.DADO_ORIGEM,31,4) AND ZX.VINCULO = SUBSTR(TEG6.DADO_ORIGEM,35,4) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='CONTROLE_FOLHAE_AFASTAMENTOSUSPENDE_REMUNERA' )TEG6SF 
ON ZX.CONTROLE_FOLHA = SUBSTR(TEG6SF.DADO_ORIGEM,1,1) AND ZX.E_AFASTAMENTO = SUBSTR(TEG6SF.DADO_ORIGEM,2,1) AND ZX.SUSPENDE_REMUNERA = SUBSTR(TEG6SF.DADO_ORIGEM,3,1) 

LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_PERMITIDA' )TEG7A 
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7A.DADO_ORIGEM,31,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7A.DADO_ORIGEM,35,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_DATADEFERIDO' )TEG7B
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7B.DADO_ORIGEM,34,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7B.DADO_ORIGEM,38,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_DATAINDEFERIDO' )TEG7C
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7C.DADO_ORIGEM,36,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7C.DADO_ORIGEM,40,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_SEMDATAS' )TEG7D
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7D.DADO_ORIGEM,30,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7D.DADO_ORIGEM,34,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_LIMITEDIAS' )TEG7E
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7E.DADO_ORIGEM,32,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7E.DADO_ORIGEM,36,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_MINIMODIAS' )TEG7F
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7F.DADO_ORIGEM,33,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7F.DADO_ORIGEM,37,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_REAVALIACAO' )TEG7G
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7G.DADO_ORIGEM,33,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7G.DADO_ORIGEM,37,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_PERIODOLAUDO' )TEG7H
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7H.DADO_ORIGEM,34,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7H.DADO_ORIGEM,38,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_INICIOLAUDO' )TEG7I
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7I.DADO_ORIGEM,33,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7I.DADO_ORIGEM,37,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FIMLAUDO' )TEG7J
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7J.DADO_ORIGEM,30,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7J.DADO_ORIGEM,34,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_ESPECIALIDADETRATAM' )TEG7K
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7K.DADO_ORIGEM,45,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7K.DADO_ORIGEM,49,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FREQUENCIA' )TEG7L
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7L.DADO_ORIGEM,32,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7L.DADO_ORIGEM,36,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_INICIOTRATAMENTO' )TEG7M
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7M.DADO_ORIGEM,38,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7M.DADO_ORIGEM,42,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FIMTRATAMENTO' )TEG7N
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7N.DADO_ORIGEM,35,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7N.DADO_ORIGEM,39,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_QTDE_SESSOES' )TEG7O
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7O.DADO_ORIGEM,34,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7O.DADO_ORIGEM,38,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_ABONO' )TEG7P 
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7P.DADO_ORIGEM,27,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7P.DADO_ORIGEM,31,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='CONDUTA_CONCOMITASEMDATA' )TEG7Q 
ON X4.CODIGO_CONDUTA = SUBSTR(TEG7Q.DADO_ORIGEM,25,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_APENASDATAINICIO' )TEG7R 
ON X4.TIPO_PROCEDIMENTO = SUBSTR(TEG7R.DADO_ORIGEM,38,4) AND X4.CODIGO_CONDUTA = SUBSTR(TEG7R.DADO_ORIGEM,42,15)

where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2
        where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
--AND C2.DATA_RESCISAO IS NULL comentado em 9/5/20
AND c2.codigo = X4.CODIGO_CONTRATO --'000000000912674';
AND c2.TIPO_CONTRATO = X4.TIPO_CONTRATO
AND C2.CODIGO_EMPRESA = X4.CODIGO_EMPRESA

)x5 -- para validaç~eos da GESER
--FIM X5 substituindo X----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
)X6

LEFT OUTER JOIN RHPESS_CONTR_MEST M ON M.CODIGO_EMPRESA = X6.CODIGO_EMPRESA AND M.CODIGO_CONTRATO = X6.CODIGO_CONTRATO AND M.TIPO_CONTRATO = X6.TIPO_CONTRATO
LEFT OUTER JOIN RHMEDI_FICHA_MED F ON F.C_LIVRE_VALOR01 = X6.ID_ATENDIMENTO AND F.LOCAL_ATENDIMENTO = X6.SEQUENCIAL
--LEFT OUTER JOIN RHMEDI_RL_FICH_PRO P ON P.C_LIVRE_VALOR01 = X6.ID_ATENDIMENTO AND P.C_LIVRE_VALOR02 = X6.SEQUENCIAL
--LEFT OUTER JOIN RHMEDI_RL_FICH_DOE D ON D.C_LIVRE_VALOR01 = X6.ID_ATENDIMENTO AND D.C_LIVRE_VALOR02 = X6.SEQUENCIAL
--LEFT OUTER JOIN (SELECT RHPESS_PESSOA WHERE dt_termino IS NOT NULL) P ON P.CODIGO_EMPRESA = X.CODIGOEMPRESA AND X.ATENDENTE = P.CPF
LEFT OUTER JOIN (SELECT A.* FROM RHPESS_CONTRATO A WHERE A.ANO_MES_REFERENCIA = (select max(AUX.ano_mes_referencia) from rhpess_contrato AUX 
        where AUX.codigo_empresa = A.codigo_empresa and AUX.tipo_contrato = A.tipo_contrato and AUX.codigo = A.codigo))A 
        ON A.CODIGO_EMPRESA = LPAD(X6.CODIGO_EMPRESA,4,0) AND A.TIPO_CONTRATO = X6.TIPO_CONTRATO AND A.CODIGO = X6.CODIGO_CONTRATO
LEFT OUTER JOIN RHTABS_VINCULO_EMP V ON V.CODIGO = A.VINCULO
LEFT OUTER JOIN(SELECT * FROM RHINTE_ED_IT_CONV where codigo_CONVERSAO ='TEG1')TC1 
  ON SUBSTR(TC1.DADO_ORIGEM,1,23) = X6.TIPO_PROCEDIMENTO||LPAD(X6.CODIGO_CONDUTA,15,0)||V.CODIGO--NOVO EM 2/7/20
--LEFT OUTER JOIN RHMEDI_DOENCA DOE ON DOE.CODIGO = X6.DOENCA

WHERE 
--F.C_LIVRE_VALOR01 IS NULL AND F.LOCAL_ATENDIMENTO IS NULL AND --------comentando em 2/6/20 para avaliar se há erro ou não
--X6.DATA_PROCESSAMENTO IS NULL
--AND TRUNC(X.DATAOCORRENCIA) BETWEEN TO_DATE('09/09/19','DD/MM/YY') AND TO_DATE('17/11/19','DD/MM/YY')--269>267 --AND CODIGOCONTRATO IN ('00000000026317X', '000000000283375')
--/*
--AND
--AND P.C_LIVRE_VALOR01 IS NULL AND P.C_LIVRE_VALOR02 IS NULL
--AND D.C_LIVRE_VALOR01 IS NULL AND D.C_LIVRE_VALOR02 IS NULL

--inicio--em 10/4/20----------------------------parte processada
--/*
(
X6.DTINICIO_MAIOR_DTATUAL = 'NAO' AND
X6.DTFIM_MAIOR_DTINICIO = 'NAO' AND
X6.STATUS_PUBLICO_ATUAL = 'INTEGRA_FICHAS_EMPRESA_TIPO_CONTRATO_VINCULO' AND
X6.STATUS_CONTRATO = 'COD_CONTRATO_OK' AND
X6.STATUS_ID_ATENDIMENTO = 'ID_ATENDIMENTO_OK' AND 
X6.STATUS_SEQUENCIAL = 'SEQUENCIAL_OK' AND
X6.STATUS_DT_REG_OCORRENCIA = 'DATA_PREENCHIDA' AND
X6.STATUS_PROCED_CONDUTA = 'PROCEDIMENTO_CONDUTA_INTEGRA' AND
X6.STATUS_DATAS_DEFERIMENTO = 'OK' AND
X6.STATUS_DATAS_INDEFERIMENTO = 'OK' AND
X6.STATUS_DATAS_DEFER_INDEFER = 'OK' AND
X6.STATUS_DATA_PREV_RETORNO = 'OK' 

AND
(
(X6.ORIGEM = 'TEG' AND X6.STATUS_PERIODOLAUDO = 'OK' AND X6.STATUS_INICIOLAUDO = 'OK' AND X6.STATUS_FIMLAUDO = 'OK' AND X6.STATUS_ESPECIALIDADETRATAMENTO = 'OK' AND X6.STATUS_FREQUENCIA_SESSOES = 'OK' AND
X6.STATUS_PERIODOINICIALTRAT = 'OK' AND X6.STATUS_PERIODOFINALTRAT = 'OK' --AND X6.STATUS_QTDE_SESSOES = 'OK' AND X6.STATUS_ABONO = 'OK' 
)OR (X6.ORIGEM = 'PBH')
)

AND
--X6.STATUS_LIMITEDIAS = 'OK' AND
--X6.STATUS_MINIMODIAS = 'OK' AND
(--inicio NOVO 11/5/20
(X6.STATUS_SITUACAO_FUNCIONAL = 'PODE_USAR')--PESSOAS ATIVAS
  or (
  (A.DATA_RESCISAO IS NULL AND x6.CONTROLE_FOLHA <> 'S')
        OR(A.DATA_RESCISAO IS NOT NULL AND x6.CONTROLE_FOLHA = 'S'  --APOSENTADOS
             --COMENTADO EM 24/9/20--AND TRUNC(x6.DT_REG_OCORRENCIA) <= TRUNC(A.DATA_RESCISAO) 
          )
        --INICIO- NOVO EM 24/9/20
        OR(A.DATA_RESCISAO IS NOT NULL AND x6.CONTROLE_FOLHA = 'D' AND --DESLIGADOS MAS ATENDIDOS PARA DEFERIMENTOS INICIADOS ANTES DA RESCISAO
             (TRUNC(x6.DATA_INICIO_AFAST) <= TRUNC(A.DATA_RESCISAO)or TRUNC(x6.DATA_INICIO_INDEFERIMENTO) <= TRUNC(A.DATA_RESCISAO))--novo em 24/9/20
          )--FIM- NOVO EM 24/9/20  
     )--fim NOVO 11/5/20

 ) 
AND
X6.EXISTE_ARQUIVO_IMP = 'SIM' AND 
X6.EXISTE_FICHA_ARTE = 'NAO' AND
X6.STATUS_PESSOA = 'OK' 
)
--FIM--em 10/4/20----------------------------parte processada

--AND X6.LOTE = i --vLOTES --NOVO EM 3/7/20
--AND X6.ORDEM_ID_ATENDIMENTO_CONTRATO = 1--NOVO EM 3/7/20
order by X6.CODIGO_EMPRESA, X6.TIPO_CONTRATO, X6.CODIGO_CONTRATO, X6.DATA_INICIO_AFAST, X6.DATA_INICIO_INDEFERIMENTO

--ORDER BY X6.ID
/*
)X7
GROUP BY
X7.DATA_RESCISAO, X7.DADO_ORIGEM_TC1, X7.DADO_DESTINO_TC1, X7.DTINICIO_MAIOR_DTATUAL, X7.DTFIM_MAIOR_DTINICIO, X7.STATUS_PUBLICO_ATUAL, X7.STATUS_CONTRATO,
X7.STATUS_ID_ATENDIMENTO, X7.STATUS_SEQUENCIAL, X7.STATUS_DT_REG_OCORRENCIA, X7.STATUS_PROCED_CONDUTA, X7.STATUS_CODIGO_ATENDENTE, X7.STATUS_DATAS_DEFERIMENTO,
X7.STATUS_DATAS_INDEFERIMENTO, X7.STATUS_DATAS_DEFER_INDEFER, X7.STATUS_DATA_PREV_RETORNO, X7.STATUS_PERIODOLAUDO, X7.STATUS_INICIOLAUDO, X7.STATUS_FIMLAUDO, 
X7.STATUS_ESPECIALIDADETRATAMENTO, X7.STATUS_FREQUENCIA_SESSOES, X7.STATUS_PERIODOINICIALTRAT, X7.STATUS_PERIODOFINALTRAT, X7.STATUS_QTDE_SESSOES, X7.STATUS_ABONO, 
X7.STATUS_LIMITEDIAS, X7.STATUS_MINIMODIAS, X7.VINCULO, X7.SITUACAO_FUNCIONAL, X7.CONTROLE_FOLHA, X7.E_AFASTAMENTO, X7.SUSPENDE_REMUNERA, X7.PUBLICO_ATUAL, 
X7.STATUS_SITUACAO_FUNCIONAL, X7.PROCXCOND_PERMITIDA, X7.PROCXCOND_DATADEFERIDO, X7.PROCXCOND_DATAINDEFERIDO, X7.PROCXCOND_SEMDATAS, X7.PROCXCOND_LIMITEDIAS, 
X7.LIMITEDIAS, X7.PROCXCOND_MINIMODIAS, X7.MINIMODIAS, X7.PROCXCOND_REAVALIACAO, X7.PROCXCOND_PERIODOLAUDO, X7.PROCXCOND_INICIOLAUDO, X7.PROCXCOND_FIMLAUDO, 
X7.PROCXCOND_ESPECIALIDADETRATA, X7.PROCXCOND_FREQUENCIA, X7.PROCXCOND_INICIOTRATAMENTO, X7.PROCXCOND_FIMTRATAMENTO, X7.PROCXCOND_QTDE_SESSOES, X7.PROCXCOND_ABONO, 
X7.CONDUTA_CONCOMITASEMDATA, X7.PROCXCOND_APENASDATAINICIO, X7.EXISTE_ARQUIVO_IMP, X7.EXISTE_FICHA_ARTE, X7.DATA_INI_AFAST_DIFERE, X7.DATA_FIM_AFAST_DIFERE, 
X7.DATA_INI_INDEFERIDO_DIFERE, X7.DATA_FIM_INDEFERIDO_DIFERE, X7.ORDEM_ID_ATENDIMENTO_CONTRATO, X7.TIPO, X7.PROXIMO_TIPO, X7.ORIGEM, X7.TIPO_DATA, X7.ID_ATENDIMENTO, 
X7.PROXIMO_ID_ATENDIMENTO, X7.SEQUENCIAL, X7.PROXIMO_SEQUENCIAL, X7.CODIGO_EMPRESA, X7.TIPO_CONTRATO, X7.CODIGO_CONTRATO, X7.CODIGO_PESSOA, X7.DT_REG_OCORRENCIA, 
X7.OCORRENCIA, X7.TIPO_PROCEDIMENTO, X7.CODIGO_CONDUTA, X7.DATA_INICIO_AFAST, X7.PROXIMA_DATA_INICIO_AFAST, X7.DATA_FIM_AFAST, X7.PROXIMA_DATA_FIM_AFAST, 
X7.DATA_INICIO_INDEFERIMENTO, X7.PROXIMA_DATA_INICIO_INDEFER, X7.DATA_FIM_INDEFERIMENTO, X7.PROXIMA_DATA_FIM_INDEFER, X7.DT_ULT_ALTER_USUA, X7.LOGIN_USUARIO,
X7.STATUS_PESSOA, X7.VALOR_PERIODOLAUDO, X7.STATUS_TAMANHO_ESPEC_TRATAM, X7.STATUS_TAMANHO_FREQ_SESSOES, X7.QTDE_SESSOES, X7.ABONO, X7.STATUS_TAMANHO_MOTIVO, 
X7.STATUS_TAMANHO_EXAMECLINICO, X7.CODIGO_ATENDENTE, X7.DATARETORNOREAVALIACAO, X7.PERIODOLAUDO, X7.INICIOLAUDO, X7.FINALLAUDO, X7.TAMANHO_ESPEC_TRATAM, 
X7.ESPECIALIDADETRATAMENTO, X7.TAMANHO_FREQ_SESSOES, X7.FREQUENCIA_SESSOES, X7.PERIODOINICIALTRATAMENTO, X7.PERIODOFINALTRATAMENTO, X7.TAMANHO_MOTIVO, X7.MOTIVO, 
X7.TAMANHO_EXAMECLINICO, X7.EXAMECLINICO, X7.ID
ORDER BY
X7.DATA_RESCISAO, X7.DADO_ORIGEM_TC1, X7.DADO_DESTINO_TC1, X7.DTINICIO_MAIOR_DTATUAL, X7.DTFIM_MAIOR_DTINICIO, X7.STATUS_PUBLICO_ATUAL, X7.STATUS_CONTRATO,
X7.STATUS_ID_ATENDIMENTO, X7.STATUS_SEQUENCIAL, X7.STATUS_DT_REG_OCORRENCIA, X7.STATUS_PROCED_CONDUTA, X7.STATUS_CODIGO_ATENDENTE, X7.STATUS_DATAS_DEFERIMENTO,
X7.STATUS_DATAS_INDEFERIMENTO, X7.STATUS_DATAS_DEFER_INDEFER, X7.STATUS_DATA_PREV_RETORNO, X7.STATUS_PERIODOLAUDO, X7.STATUS_INICIOLAUDO, X7.STATUS_FIMLAUDO, 
X7.STATUS_ESPECIALIDADETRATAMENTO, X7.STATUS_FREQUENCIA_SESSOES, X7.STATUS_PERIODOINICIALTRAT, X7.STATUS_PERIODOFINALTRAT, X7.STATUS_QTDE_SESSOES, X7.STATUS_ABONO, 
X7.STATUS_LIMITEDIAS, X7.STATUS_MINIMODIAS, X7.VINCULO, X7.SITUACAO_FUNCIONAL, X7.CONTROLE_FOLHA, X7.E_AFASTAMENTO, X7.SUSPENDE_REMUNERA, X7.PUBLICO_ATUAL, 
X7.STATUS_SITUACAO_FUNCIONAL, X7.PROCXCOND_PERMITIDA, X7.PROCXCOND_DATADEFERIDO, X7.PROCXCOND_DATAINDEFERIDO, X7.PROCXCOND_SEMDATAS, X7.PROCXCOND_LIMITEDIAS, 
X7.LIMITEDIAS, X7.PROCXCOND_MINIMODIAS, X7.MINIMODIAS, X7.PROCXCOND_REAVALIACAO, X7.PROCXCOND_PERIODOLAUDO, X7.PROCXCOND_INICIOLAUDO, X7.PROCXCOND_FIMLAUDO, 
X7.PROCXCOND_ESPECIALIDADETRATA, X7.PROCXCOND_FREQUENCIA, X7.PROCXCOND_INICIOTRATAMENTO, X7.PROCXCOND_FIMTRATAMENTO, X7.PROCXCOND_QTDE_SESSOES, X7.PROCXCOND_ABONO, 
X7.CONDUTA_CONCOMITASEMDATA, X7.PROCXCOND_APENASDATAINICIO, X7.EXISTE_ARQUIVO_IMP, X7.EXISTE_FICHA_ARTE, X7.DATA_INI_AFAST_DIFERE, X7.DATA_FIM_AFAST_DIFERE, 
X7.DATA_INI_INDEFERIDO_DIFERE, X7.DATA_FIM_INDEFERIDO_DIFERE, X7.ORDEM_ID_ATENDIMENTO_CONTRATO, X7.TIPO, X7.PROXIMO_TIPO, X7.ORIGEM, X7.TIPO_DATA, X7.ID_ATENDIMENTO, 
X7.PROXIMO_ID_ATENDIMENTO, X7.SEQUENCIAL, X7.PROXIMO_SEQUENCIAL, X7.CODIGO_EMPRESA, X7.TIPO_CONTRATO, X7.CODIGO_CONTRATO, X7.CODIGO_PESSOA, X7.DT_REG_OCORRENCIA, 
X7.OCORRENCIA, X7.TIPO_PROCEDIMENTO, X7.CODIGO_CONDUTA, X7.DATA_INICIO_AFAST, X7.PROXIMA_DATA_INICIO_AFAST, X7.DATA_FIM_AFAST, X7.PROXIMA_DATA_FIM_AFAST, 
X7.DATA_INICIO_INDEFERIMENTO, X7.PROXIMA_DATA_INICIO_INDEFER, X7.DATA_FIM_INDEFERIMENTO, X7.PROXIMA_DATA_FIM_INDEFER, X7.DT_ULT_ALTER_USUA, X7.LOGIN_USUARIO,
X7.STATUS_PESSOA, X7.VALOR_PERIODOLAUDO, X7.STATUS_TAMANHO_ESPEC_TRATAM, X7.STATUS_TAMANHO_FREQ_SESSOES, X7.QTDE_SESSOES, X7.ABONO, X7.STATUS_TAMANHO_MOTIVO, 
X7.STATUS_TAMANHO_EXAMECLINICO, X7.CODIGO_ATENDENTE, X7.DATARETORNOREAVALIACAO, X7.PERIODOLAUDO, X7.INICIOLAUDO, X7.FINALLAUDO, X7.TAMANHO_ESPEC_TRATAM, 
X7.ESPECIALIDADETRATAMENTO, X7.TAMANHO_FREQ_SESSOES, X7.FREQUENCIA_SESSOES, X7.PERIODOINICIALTRATAMENTO, X7.PERIODOFINALTRATAMENTO, X7.TAMANHO_MOTIVO, X7.MOTIVO, 
X7.TAMANHO_EXAMECLINICO, X7.EXAMECLINICO, X7.ID
*/
--  */
--fim--em 10/4/20----------------------------parte processada
--FIM  ----------------------------------------------------------------------------LOOP----------------------------------------------------------




) 
LOOP
--dbms_output.put_line('--vLOTE: '||vLOTES);
vPODE_PROXIMAS_DOENCAS := NULL;
vCONTADOR := vCONTADOR+1 ;
dbms_output.put_line('--CONTADOR: '|| vCONTADOR ||' ORIGEM: ' || C1.ORIGEM || /*' QTD_LINHAS DA FICHA: '|| C1.QUANT ||*/ ' SEQUENCIAL: ' || C1.SEQUENCIAL);

--/*

--INICIO-------------------------------------vQTD_BMS_MESMO_CODIGO
--IF C1.ORIGEM = 'PBH' THEN
SELECT COUNT(1)SOMA INTO vQTD_BMS_MESMO_CODIGO FROM(
select c2.codigo_empresa, c2.tipo_contrato, c2.codigo, c2.codigo_pessoa, sf2.codigo cod_sit_func, sf2.descricao situacao_funcional, c2.data_rescisao from(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where c.codigo = C1.CODIGO_CONTRATO--'000000009301381'
AND c.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND C.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
--and c.codigo_empresa in (SELECT SUBSTR(DADO_ORIGEM,27,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,27,4) )
and c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)x 
left outer join rhpess_contrato c2 ON x.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2 where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
--AND C2.DATA_RESCISAO IS NULL--comentado em 9/5/20
AND c2.codigo = C1.CODIGO_CONTRATO--'000000009301381'
AND c2.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND C2.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
--and c2.codigo_empresa in (SELECT SUBSTR(DADO_ORIGEM,27,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,27,4) )
)X2
;
--ELSE vQTD_BMS_MESMO_CODIGO := 1;
--END IF;
--FIM-------------------------------------vQTD_BMS_MESMO_CODIGO

dbms_output.put_line('--vQTD_BMS_MESMO_CODIGO:' || vQTD_BMS_MESMO_CODIGO);

--------------------------------------------------IF PARA PROCESSAR APENAS SE O CODIGO DO BM TIVER 1 ATIVO
IF vQTD_BMS_MESMO_CODIGO = 1 ----MAIS DE UM BM NO MESMO CODIGO ATIVO NAO FAZ NADA
--(vQTD_BMS_MESMO_CODIGO = 1 AND C1.ORIGEM = 'PBH')OR  C1.ORIGEM = 'TEG'
THEN
-----------------------------------------------------localizar contratos da pessoa apenas pelo bm
--INICIO----------------------------------TEG6 -- VALIDAR SE ESTA NO PUBLICO DA TABELA DE CONVERSAO TEG6----------------------------------
--INICIO----------------------------------TEG7 -- VALIDAR SE ESTA NAS REGRAS ATUAIS MAEPADAS PELA GESER PARA PREENCHIMENTO DE FICHAS MEDICAS DA TABELA DE CONVERSAO TEG7----------------------------------
select C2.DATA_RESCISAO, c2.codigo_empresa, c2.tipo_contrato, c2.codigo_pessoa, C2.VINCULO, C2.SITUACAO_FUNCIONAL, X.CONTROLE_FOLHA, X.E_AFASTAMENTO, X.SUSPENDE_REMUNERA 
,CASE WHEN TEG6.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PUBLICO_ATUAL
,CASE WHEN TEG6SF.DADO_ORIGEM IS NOT NULL THEN 'PODE_USAR' ELSE 'NAO_PODE_USAR' END STATUS_SITUACAO_FUNCIONAL
,CASE WHEN TEG7A.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_PERMITIDA
,CASE WHEN TEG7B.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_DATADEFERIDO
,CASE WHEN TEG7C.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_DATAINDEFERIDO
,CASE WHEN TEG7D.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_SEMDATAS
,CASE WHEN TEG7E.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_LIMITEDIAS
,CASE WHEN TEG7F.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_MINIMODIAS
,CASE WHEN TEG7G.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_REAVALIACAO
,CASE WHEN TEG7H.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_PERIODOLAUDO
,CASE WHEN TEG7I.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_INICIOLAUDO
,CASE WHEN TEG7J.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FIMLAUDO
,CASE WHEN TEG7K.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_ESPECIALIDADETRATA
,CASE WHEN TEG7L.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FREQUENCIA
,CASE WHEN TEG7M.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_INICIOTRATAMENTO
,CASE WHEN TEG7N.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_FIMTRATAMENTO
,CASE WHEN TEG7O.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_QTDE_SESSOES
,CASE WHEN TEG7P.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_ABONO
,CASE WHEN TEG7E.DADO_ORIGEM IS NOT NULL THEN SUBSTR(TEG7E.DADO_ORIGEM,52,3) ELSE '0' END LIMITEDIAS
,CASE WHEN TEG7F.DADO_ORIGEM IS NOT NULL THEN SUBSTR(TEG7F.DADO_ORIGEM,53,3) ELSE '0' END MINIMODIAS
,CASE WHEN TEG7Q.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END CONDUTA_CONCOMITASEMDATA
,CASE WHEN TEG7R.DADO_ORIGEM IS NOT NULL THEN 'SIM' ELSE 'NAO' END PROCXCOND_APENASDATAINICIO
INTO
vDATA_RESCISAO, vCODIGO_EMPRESA, vTIPO_CONTRATO, vCODIGO_PESSOA, vVINCULO, vSITUACAO_FUNCIONAL, vCONTROLE_FOLHA, vE_AFASTAMENTO, vSUSPENDE_REMUNERA
,vPUBLICO_ATUAL, vSTATUS_SITUACAO_FUNCIONAL
,vPROCXCOND_PERMITIDA, vPROCXCOND_DATADEFERIDO, vPROCXCOND_DATAINDEFERIDO, vPROCXCOND_SEMDATAS, vPROCXCOND_LIMITEDIAS, vPROCXCOND_MINIMODIAS
,vPROCXCOND_REAVALIACAO, vPROCXCOND_PERIODOLAUDO, vPROCXCOND_INICIOLAUDO, vPROCXCOND_FIMLAUDO, vPROCXCOND_ESPECIALIDADETRATA, vPROCXCOND_FREQUENCIA
,vPROCXCOND_INICIOTRATAMENTO, vPROCXCOND_FIMTRATAMENTO, vPROCXCOND_QTDE_SESSOES, vPROCXCOND_ABONO, vLIMITEDIAS, vMINIMODIAS
,vCONDUTA_CONCOMITASEMDATA ,vPROCXCOND_APENASDATAINICIO
from(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, C.VINCULO, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
, SF.CONTROLE_FOLHA, SF.E_AFASTAMENTO, SF.SUSPENDE_REMUNERA 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where c.codigo = C1.CODIGO_CONTRATO-- '000000000912674'
AND c.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND C.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
and c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)x
left outer join rhpess_contrato c2 ON x.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO' )TEG6 
ON X.CODIGO_EMPRESA = SUBSTR(TEG6.DADO_ORIGEM,27,4) AND X.TIPO_CONTRATO = SUBSTR(TEG6.DADO_ORIGEM,31,4) AND X.VINCULO = SUBSTR(TEG6.DADO_ORIGEM,35,4) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='CONTROLE_FOLHAE_AFASTAMENTOSUSPENDE_REMUNERA' )TEG6SF 
ON X.CONTROLE_FOLHA = SUBSTR(TEG6SF.DADO_ORIGEM,1,1) AND X.E_AFASTAMENTO = SUBSTR(TEG6SF.DADO_ORIGEM,2,1) AND X.SUSPENDE_REMUNERA = SUBSTR(TEG6SF.DADO_ORIGEM,3,1) 

LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_PERMITIDA' )TEG7A 
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7A.DADO_ORIGEM,31,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7A.DADO_ORIGEM,35,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_DATADEFERIDO' )TEG7B
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7B.DADO_ORIGEM,34,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7B.DADO_ORIGEM,38,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_DATAINDEFERIDO' )TEG7C
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7C.DADO_ORIGEM,36,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7C.DADO_ORIGEM,40,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_SEMDATAS' )TEG7D
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7D.DADO_ORIGEM,30,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7D.DADO_ORIGEM,34,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_LIMITEDIAS' )TEG7E
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7E.DADO_ORIGEM,32,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7E.DADO_ORIGEM,36,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_MINIMODIAS' )TEG7F
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7F.DADO_ORIGEM,33,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7F.DADO_ORIGEM,37,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_REAVALIACAO' )TEG7G
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7G.DADO_ORIGEM,33,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7G.DADO_ORIGEM,37,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_PERIODOLAUDO' )TEG7H
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7H.DADO_ORIGEM,34,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7H.DADO_ORIGEM,38,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_INICIOLAUDO' )TEG7I
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7I.DADO_ORIGEM,33,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7I.DADO_ORIGEM,37,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FIMLAUDO' )TEG7J
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7J.DADO_ORIGEM,30,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7J.DADO_ORIGEM,34,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_ESPECIALIDADETRATAM' )TEG7K
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7K.DADO_ORIGEM,45,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7K.DADO_ORIGEM,49,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FREQUENCIA' )TEG7L
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7L.DADO_ORIGEM,32,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7L.DADO_ORIGEM,36,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_INICIOTRATAMENTO' )TEG7M
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7M.DADO_ORIGEM,38,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7M.DADO_ORIGEM,42,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_FIMTRATAMENTO' )TEG7N
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7N.DADO_ORIGEM,35,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7N.DADO_ORIGEM,39,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_QTDE_SESSOES' )TEG7O
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7O.DADO_ORIGEM,34,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7O.DADO_ORIGEM,38,15)
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_ABONO' )TEG7P 
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7P.DADO_ORIGEM,27,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7P.DADO_ORIGEM,31,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='CONDUTA_CONCOMITASEMDATA' )TEG7Q 
ON C1.CODIGO_CONDUTA = SUBSTR(TEG7Q.DADO_ORIGEM,25,15) 
LEFT OUTER JOIN (SELECT * FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG7' AND DADO_DESTINO ='PROCEDIMENTOXCONDUTA_APENASDATAINICIO' )TEG7R 
ON C1.TIPO_PROCEDIMENTO = SUBSTR(TEG7R.DADO_ORIGEM,38,4) AND C1.CODIGO_CONDUTA = SUBSTR(TEG7R.DADO_ORIGEM,42,15)

where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2 where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
--AND C2.DATA_RESCISAO IS NULL --comentado em 11/5/0
AND c2.codigo = C1.CODIGO_CONTRATO --'000000000912674';
AND c2.TIPO_CONTRATO = C1.TIPO_CONTRATO
AND C2.CODIGO_EMPRESA = C1.CODIGO_EMPRESA
;
--FIM---------------------------------- TEG7 -- VALIDAR SE ESTA NAS REGRAS ATUAIS MAEPADAS PELA GESER PARA PREENCHIMENTO DE FICHAS MEDICAS DA TABELA DE CONVERSAO TEG7----------------------------------
--FIM----------------------------------TEG6 -- VALIDAR SE ESTA NO PUBLICO DA TABELA DE CONVERSAO TEG6----------------------------------

dbms_output.put_line('--vVINCULO: ' || vVINCULO || ' vSITUACAO_FUNCIONAL: ' || vSITUACAO_FUNCIONAL ||' vCONTROLE_FOLHA: '|| vCONTROLE_FOLHA ||' vE_AFASTAMENTO: '|| vE_AFASTAMENTO|| ' vSUSPENDE_REMUNERA: ' || vSUSPENDE_REMUNERA);
dbms_output.put_line('--EMPRESATIPOCONTRATOVINCULO: '|| vPUBLICO_ATUAL || ' CONTROLE_FOLHAE_AFASTAMENTOSUSPENDE_REMUNERA: ' ||vSTATUS_SITUACAO_FUNCIONAL);
dbms_output.put_line('--vPROCXCOND_PERMITIDA: '|| vPROCXCOND_PERMITIDA || ' vPROCXCOND_DATADEFERIDO: '||vPROCXCOND_DATADEFERIDO || ' vPROCXCOND_DATAINDEFERIDO: ' || vPROCXCOND_DATAINDEFERIDO);
dbms_output.put_line('--vCONDUTA_CONCOMITASEMDATA: '|| vCONDUTA_CONCOMITASEMDATA || ' vPROCXCOND_APENASDATAINICIO: '|| vPROCXCOND_APENASDATAINICIO || ' vCONCOMITA_DT_DEFERIDO: '|| vCONCOMITA_DT_DEFERIDO);
dbms_output.put_line('--vPROCXCOND_SEMDATAS: ' || vPROCXCOND_SEMDATAS || ' vPROCXCOND_LIMITEDIAS: ' || vPROCXCOND_LIMITEDIAS || ' vLIMITEDIAS: ' || vLIMITEDIAS || ' vMINIMODIAS: ' ||vMINIMODIAS);
dbms_output.put_line('--vPROCXCOND_MINIMODIAS: ' || vPROCXCOND_MINIMODIAS || ' vPROCXCOND_REAVALIACAO: '|| vPROCXCOND_REAVALIACAO || ' vPROCXCOND_PERIODOLAUDO: ' || vPROCXCOND_PERIODOLAUDO);
dbms_output.put_line('--vPROCXCOND_INICIOLAUDO: ' || vPROCXCOND_INICIOLAUDO ||' vPROCXCOND_FIMLAUDO: ' || vPROCXCOND_FIMLAUDO || ' vPROCXCOND_ESPECIALIDADETRATA: ' || vPROCXCOND_ESPECIALIDADETRATA);
dbms_output.put_line('--vPROCXCOND_FREQUENCIA: ' || vPROCXCOND_FREQUENCIA || ' vPROCXCOND_INICIOTRATAMENTO: ' || vPROCXCOND_INICIOTRATAMENTO || ' vPROCXCOND_FIMTRATAMENTO: ' || vPROCXCOND_FIMTRATAMENTO || ' vPROCXCOND_QTDE_SESSOES: ' || vPROCXCOND_QTDE_SESSOES || ' vPROCXCOND_ABONO: ' || vPROCXCOND_ABONO);


--inicio-----------------------------------------------------------------------MAIS BMS ATIVOS?
SELECT CASE WHEN X3.SOMA = 0 THEN 'NAO' ELSE 'SIM' END MAIS_BMS_ATIVOS INTO vTEM_MAIS_BM_ATIVO FROM(
SELECT COUNT(1)SOMA FROM(
select c2.codigo_empresa, c2.tipo_contrato, c2.codigo, c2.codigo_pessoa, sf2.codigo cod_sit_func, sf2.descricao situacao_funcional, c2.data_rescisao from(
select c.codigo_empresa, c.tipo_contrato, c.codigo, c.codigo_pessoa, sf.codigo cod_sit_func, sf.descricao situacao_funcional, c.data_rescisao 
from rhpess_contrato c
left outer join rhparm_sit_func sf on sf.codigo = c.situacao_funcional
where c.codigo = C1.CODIGO_CONTRATO--'000000000912674'
and c.ano_mes_referencia = (select max(aux.ano_mes_referencia) from rhpess_contrato aux where aux.codigo_empresa = c.codigo_empresa and aux.tipo_contrato = c.tipo_contrato and aux.codigo = c.codigo)
)x
left outer join rhpess_contrato c2 ON x.CODIGO_EMPRESA = C2.CODIGO_EMPRESA AND X.CODIGO_PESSOA = C2.CODIGO_PESSOA
left outer join rhparm_sit_func sf2 on sf2.codigo = c2.situacao_funcional
where c2.ano_mes_referencia = (select max(aux2.ano_mes_referencia) from rhpess_contrato aux2 where aux2.codigo_empresa = c2.codigo_empresa and aux2.tipo_contrato = c2.tipo_contrato and aux2.codigo = c2.codigo)
AND C2.DATA_RESCISAO IS NULL
AND c2.codigo <> C1.CODIGO_CONTRATO--'000000000912674'
)X2
)X3;
--fim-----------------------------------------------------------------------MAIS BMS ATIVOS?


----------------------------------------------------------------popular o campo OCORRENCIA nas 3 tabelas
--SELECT X.OCORRENCIA INTO vOCORRENCIA FROM (
--select case when max1 is null then 1 else max1 end ocorrencia from(select max(a.ocorrencia)+1 max1 from RHMEDI_FICHA_MED a where a.codigo_empresa = vCODIGO_EMPRESA 
--AND A.CODIGO_PESSOA = vCODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = to_date(C1.DATAOCORRENCIA,'dd/mm/YYyy') /*and a.tipo_contrato = vTIPO_CONTRATO*/))X;


-------------------------------------------------------------------popular PESSOA ATENDENTE
SELECT X.PESSOA INTO vATENDENTE FROM( (select min(codigo) pessoa from rhpess_pessoa where cpf = LPAD(TRIM(C1.CODIGO_ATENDENTE),11,'0') 
and codigo_empresa = vCODIGO_EMPRESA and dt_ult_alter_usua = (select max (a.dt_ult_alter_usua) from rhpess_pessoa a 
where a.codigo = rhpess_pessoa.codigo and a.codigo_empresa = rhpess_pessoa.codigo_empresa )))X;


--*/
dbms_output.put_line('--'||C1.CODIGO_CONTRATO ||'-'||C1.DT_REG_OCORRENCIA||'-'||C1.TIPO_PROCEDIMENTO||'-'||C1.CODIGO_CONDUTA);
dbms_output.put_line('--TEM MAIS DE 1 BM ATIVO? ' || vTEM_MAIS_BM_ATIVO);
--dbms_output.put_line('--vCONTADOR1: '|| vCONTADOR1);
dbms_output.put_line(/*'--vOCORRENCIA: '||vOCORRENCIA ||*/ '--vATENDENTE: '|| vATENDENTE||' vCODIGO_EMPRESA:' || vCODIGO_EMPRESA ||' vTIPO_CONTRATO: ' || vTIPO_CONTRATO || ' C1.CODIGOCONTRATO: '||C1.CODIGO_CONTRATO || ' vCODIGO_PESSOA: '||vCODIGO_PESSOA  );

--for i in 1..C1.QUANT loop

---------------------------------------------------------FOR PARA PEGAR COM BM/DIA/PROCEDIMENTO/CONDUTA-----------------------------------------------------------------------
FOR C2 IN (
SELECT 
ID, ROW_NUMBER() OVER (PARTITION BY CODIGOEMPRESA, CODIGOTIPOCONTRATO, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, CODIGOCONDUTA
ORDER BY CODIGOEMPRESA, CODIGOTIPOCONTRATO, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, CODIGOCONDUTA, DOENCA ) AS ORDEM_DOENCA_FICHA,
AUTOIDFICHAATENDIMENTO,SEQUENCIAL_TEG,CODIGOEMPRESA,CODIGOTIPOCONTRATO,CODIGOCONTRATO,DATAOCORRENCIA,ATENDENTE,TIPOPROCEDIMENTO,MODALIDADE,DATAINICIOAFAST,DATAFIMAFAST,DATAINICIALINDEFERIMENTO,DATAFINALINDEFERIMENTO,DATARETORNOREAVALIACAO,DATACIENCIADECISAO,CODIGOCONDUTA,PERIODOLAUDO,INICIOLAUDO,FINALLAUDO,DOENCA,ESPECIALIDADETRATAMENTO,FREQUENCIA_SESSOES,PERIODOINICIALTRATAMENTO
,QTDE_SESSOES, ABONO, MOTIVO, EXAMECLINICO,
CASE
WHEN MODALIDADE = 'A' THEN '1'
WHEN MODALIDADE = 'B' THEN '2'
WHEN MODALIDADE = 'C' THEN '3'
WHEN MODALIDADE = 'D' THEN '4'
WHEN MODALIDADE = 'E' THEN '5'
WHEN MODALIDADE = 'F' THEN '6'
WHEN MODALIDADE = 'G' THEN '7'
WHEN MODALIDADE = 'H' THEN '8'
WHEN MODALIDADE = 'I' THEN '9'
WHEN MODALIDADE = 'J' THEN '10'
WHEN MODALIDADE = 'K' THEN '11'
WHEN MODALIDADE = 'L' THEN '11'
WHEN MODALIDADE = 'M' THEN '12'
WHEN MODALIDADE = 'N' THEN '13'
WHEN MODALIDADE = 'O' THEN '14'
WHEN MODALIDADE = 'P' THEN '15'
WHEN MODALIDADE = 'Q' THEN '16'
WHEN MODALIDADE = 'R' THEN '17'
WHEN MODALIDADE = 'S' THEN '18'
WHEN MODALIDADE = 'T' THEN '19'
WHEN MODALIDADE = 'U' THEN '20'
WHEN MODALIDADE = 'V' THEN '21'
WHEN MODALIDADE = 'W' THEN '22'
WHEN MODALIDADE = 'X' THEN '23'
WHEN MODALIDADE = 'Y' THEN '24'
WHEN MODALIDADE = 'Z' THEN '25'
END MODALIDADE_NUMERO
,POSITIVOEXAME, RECONSIDERACAO  --NOVO EM 15/9/20
FROM SUGESP_ARQUIVOS_FICHA  
WHERE DATA_PROCESSAMENTO IS NULL
AND CODIGOEMPRESA IS NOT NULL
and codigoempresa in (SELECT SUBSTR(DADO_ORIGEM,27,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,27,4) )
and codigotipocontrato in (SELECT SUBSTR(DADO_ORIGEM,31,4)empresa FROM RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO = 'TEG6' AND DADO_DESTINO ='EMPRESATIPOCONTRATOVINCULO'group by SUBSTR(DADO_ORIGEM,31,4) )
AND SEQUENCIAL_TEG = C1.SEQUENCIAL 
-- AND DATAINICIOAFAST = C1.DATA_INICIO_AFAST AND DATAFIMAFAST = C1.DATA_FIM_AFAST
AND CODIGOEMPRESA = C1.CODIGO_EMPRESA AND CODIGOTIPOCONTRATO = C1.TIPO_CONTRATO
AND CODIGOCONTRATO = C1.CODIGO_CONTRATO AND DATAOCORRENCIA = C1.DT_REG_OCORRENCIA AND TIPOPROCEDIMENTO = C1.TIPO_PROCEDIMENTO AND CODIGOCONDUTA = C1.CODIGO_CONDUTA
group by
ID,AUTOIDFICHAATENDIMENTO,SEQUENCIAL_TEG,CODIGOEMPRESA,CODIGOTIPOCONTRATO,CODIGOCONTRATO,DATAOCORRENCIA,ATENDENTE,TIPOPROCEDIMENTO,MODALIDADE,DATAINICIOAFAST,DATAFIMAFAST,DATAINICIALINDEFERIMENTO,DATAFINALINDEFERIMENTO,DATARETORNOREAVALIACAO,DATACIENCIADECISAO,CODIGOCONDUTA,PERIODOLAUDO,INICIOLAUDO,FINALLAUDO,DOENCA,ESPECIALIDADETRATAMENTO,FREQUENCIA_SESSOES,PERIODOINICIALTRATAMENTO
,QTDE_SESSOES, ABONO, MOTIVO, EXAMECLINICO
,POSITIVOEXAME, RECONSIDERACAO  --NOVO EM 15/9/20
ORDER BY ORDEM_DOENCA_FICHA, CODIGOCONTRATO, DATAOCORRENCIA, TIPOPROCEDIMENTO, CODIGOCONDUTA, DOENCA
)LOOP

dbms_output.put_line('--C2.ID: ' || C2.ID);

--INICIO-------------------------------TEM FICHA NO BM NO PERIODO DEFERIDO DA NOVA FICHA?
SELECT SUM(RETORNO) INTO vCONCOMITA_DT_DEFERIDO FROM
(SELECT CASE WHEN SUM(X.RETORNO)=0 THEN 0 ELSE X.RETORNO END AS RETORNO FROM
(SELECT COUNT(1) RETORNO FROM RHMEDI_FICHA_MED
WHERE TRUNC(TO_DATE(C2.DATAINICIOAFAST,'DD/MM/YYYY')) BETWEEN TRUNC(TO_DATE(DATA_INI_AFAST,'DD/MM/YYYY')) AND TRUNC(TO_DATE(DATA_FIM_AFAST,'DD/MM/YYYY'))
AND CODIGO_EMPRESA = vCODIGO_EMPRESA
AND TIPO_CONTRATO = vTIPO_CONTRATO
AND CODIGO_CONTRATO = C2.CODIGOCONTRATO
UNION ALL
SELECT COUNT(1) RETORNO FROM RHMEDI_FICHA_MED
WHERE TRUNC(TO_DATE(C2.DATAFIMAFAST,'DD/MM/YYYY')) BETWEEN TRUNC(TO_DATE(DATA_INI_AFAST,'DD/MM/YYYY')) AND TRUNC(TO_DATE(DATA_FIM_AFAST,'DD/MM/YYYY'))
AND CODIGO_EMPRESA = vCODIGO_EMPRESA
AND TIPO_CONTRATO = vTIPO_CONTRATO
AND CODIGO_CONTRATO = C2.CODIGOCONTRATO
)X
GROUP BY X.RETORNO);
--FIM----------------------------------TEM FICHA NO BM NO PERIODO DEFERIDO DA NOVA FICHA?

--inicio----novo em 04/12/20
IF vCONCOMITA_DT_DEFERIDO <> 0 THEN
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'NAO' WHERE ID = C2.ID; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  NAO, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));
END IF;
--fim----novo em 04/12/20


--inicio--------------------------------------------------------------popular o campo OCORRENCIA nas 3 tabelas
SELECT X.OCORRENCIA INTO vOCORRENCIA FROM (
select case when max1 is null then 1 else max1 end ocorrencia from(select max(a.ocorrencia)+1 max1 from RHMEDI_FICHA_MED a 
where a.codigo_empresa = vCODIGO_EMPRESA AND A.CODIGO_PESSOA = vCODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = to_date(C1.DT_REG_OCORRENCIA,'dd/mm/YYyy') /*and a.tipo_contrato = vTIPO_CONTRATO*/))X;
--fim--------------------------------------------------------------popular o campo OCORRENCIA nas 3 tabelas


--em 11/4/20--inicio ---------------------------IF para começar a gravar nas tabelas-----------------------------------------------------------------------
--inicio------------------------------------------rodar direto
--IF vCONCOMITA_DT_DEFERIDO = 0 THEN --comentado 21/4/20 4h17
dbms_output.put_line('vCONCOMITA_DT_DEFERIDO: '|| vCONCOMITA_DT_DEFERIDO || ' C2.ORDEM_DOENCA_FICHA:' ||C2.ORDEM_DOENCA_FICHA);



BEGIN --EXCEPTION
--inicio ------------------------FICHAS COM PARTE DE DEFERIMENTO, INDEFERIMENTO OU SEM DATAS QUE NÃO SEJAM: PARA APOSENTADORIA ou ENCAMINHAMENTO PARA O INSS----------------
IF C2.ORDEM_DOENCA_FICHA = 1 AND
vPROCXCOND_APENASDATAINICIO = 'NAO' AND vCONDUTA_CONCOMITASEMDATA = 'NAO'--parte nova em 17/4/20
and vCONCOMITA_DT_DEFERIDO = 0 --colocado aqui em 21/4/20 4h19
AND 
(
  (vDATA_RESCISAO IS NULL --comentado 22/7/22 email (ERRO DE PROCESSAMENTO - IMPORTAÇÃO TEG)--AND vCONTROLE_FOLHA <> 'S'
  )
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'S') --COMENTADO EM 24/9/20--AND TRUNC(C2.DATAOCORRENCIA) <= TRUNC(vDATA_RESCISAO))
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'D' AND (TRUNC(C2.DATAINICIOAFAST) <= TRUNC(vDATA_RESCISAO)OR TRUNC(C2.DATAINICIALINDEFERIMENTO) <= TRUNC(vDATA_RESCISAO) ) )--NOVO EM 24/9/20
)--NOVO 11/5/20

THEN 

--vDOENCA := C2.DOENCA;--NOVO EM 10/6/20
--IF  vCONTADOR2 = 1 THEN
dbms_output.put_line('--FICHAS COM PARTE DE DEFERIMENTO, INDEFERIMENTO OU SEM DATAS QUE NÃO SEJAM: PARA APOSENTADORIA ou ENCAMINHAMENTO PARA O INSS-- C2.ORDEM_DOENCA_FICHA:' || C2.ORDEM_DOENCA_FICHA|| ' C2.TIPOPROCEDIMENTO/vPROCEDIMENTO: '|| vPROCEDIMENTO);
--/*
--comentado em 27/1/20 --IF C2.CODIGO_PESSOA IS NOT NULL and C2.PERIODOLAUDO_AJUSTADO >= 0 and C2.PERIODOLAUDO_AJUSTADO < 9999 AND C2.CODIGOEMPRESA in ('0001','1700') THEN
INSERT INTO RHMEDI_FICHA_MED(EMPRESA_ATENDENTE, LOGIN_USUARIO, DT_ULT_ALTER_USUA, TIPO_CONTRATO, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, OCORRENCIA, NATUREZA_EXAME, 
CODIGO_ATENDENTE, DATA_INI_AFAST, DATA_FIM_AFAST, TEXTO05, TEXTO02, DT_PREV_RETORNO, CODIGO_PESSOA, CODIGO_CONTRATO, C_LIVRE_DATA01, C_LIVRE_DATA02, LOCAL_ATENDIMENTO
,C_LIVRE_SELEC02, DATA_CONCLUSAO, INDIC_REFERENCIA
,INFO_MESMO_MOTIVO, C_LIVRE_OPCAO02, C_LIVRE_OPCAO01, BENEFICIO, PROV_EMISSAO_CAT, NEXO_CAUSAL, PRIMEIRO_CONTATO, IND_EF_RETRO_ESOCIAL, IND_REC_EX_TOXIC_RESC, IND_DOENCA_ACIDENTE, IND_PROVENIENTE_TRABALHO, INDIC_OCUPACIONAL, IND_INTERNACAO)--NOVO EM 2/6/21 
VALUES ('0001', 'pr114641_via_imp_ficha', SYSDATE, C2.CODIGOTIPOCONTRATO, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO, TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vOCORRENCIA ,  C2.TIPOPROCEDIMENTO 
,vATENDENTE , TO_DATE(C2.DATAINICIOAFAST ,'DD/MM/YYYY'), TO_DATE(C2.DATAFIMAFAST ,'DD/MM/YYYY'), SUBSTR(C2.MOTIVO,1,2000) ,SUBSTR(C2.EXAMECLINICO,1,2000) 
, TO_DATE(C2.DATARETORNOREAVALIACAO ,'DD/MM/YYYY'), vCODIGO_PESSOA, C2.CODIGOCONTRATO , TO_DATE(C2.DATAINICIALINDEFERIMENTO,'DD/MM/YYYY'), TO_DATE(C2.DATAFINALINDEFERIMENTO,'DD/MM/YYYY'), 
C2.SEQUENCIAL_TEG, C2.MODALIDADE_NUMERO, C2.DATACIENCIADECISAO, C2.RECONSIDERACAO
,'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'--NOVO EM 2/6/21 
); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
--*/
dbms_output.put_line('--*************************************GRAVOU RHMEDI_FICHA_MED');

--dbms_output.put_line('--C1.FICHA_DIA: ' ||C1.FICHA_DIA/*||' vCONTADOR1: ' ||vCONTADOR1*/);
dbms_output.put_line('--QUANTIDADE DE FICHA MEDICA NO ARTERH DENTRO DESTE NOVO PERIODO DE DEFERIMENTO? ' || vCONCOMITA_DT_DEFERIDO);
dbms_output.put_line(/*'--C1.FICHA_DIA: ' ||C1.FICHA_DIA|| '*/ '--vOCORRENCIA: ' ||vOCORRENCIA);
dbms_output.put_line('-- C2.DATAINICIOAFAST: '|| C2.DATAINICIOAFAST || ' C2.DATAFIMAFAST:'|| C2.DATAFIMAFAST || ' C2.DATAINICIALINDEFERIMENTO:' || C2.DATAINICIALINDEFERIMENTO|| ' C2.DATAFINALINDEFERIMENTO:' || C2.DATAFINALINDEFERIMENTO);

dbms_output.put_line('GRAVA PRIMEIRA CONDUTA E DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);
--/*
INSERT INTO RHMEDI_RL_FICH_PRO(LOGIN_USUARIO, DT_ULT_ALTER_USUA, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA,
CODIGO_PESSOA, CODIGO_PROC_MED, C_LIVRE_SELEC01 ,C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_PROC_MED) 
VALUES ('pr114641_via_imp_ficha', SYSDATE,'N','N','N',C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO, TO_DATE(C2.DATAOCORRENCIA,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.CODIGOCONDUTA 
,CASE WHEN C2.PERIODOLAUDO < 0 OR C2.PERIODOLAUDO > 9999 THEN 0 ELSE C2.PERIODOLAUDO END--,C2.PERIODOLAUDO_AJUSTADO
,TO_DATE(C2.INICIOLAUDO ,'DD/MM/YYYY'), TO_DATE(C2.FINALLAUDO ,'DD/MM/YYYY'), vOCORRENCIA ,  vCONTADOR2); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
--*/
dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_PRO');

IF C2.DOENCA IS NULL THEN
dbms_output.put_line('SEM DOENCA');
--PR_FICHA_MEDICA_ORIGEM_TEG;---------------PARA JÁ GERAR SIT FUNC/PONTO
ELSE
dbms_output.put_line('TEM DOENCA');
--/*
SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_DOENCA_CADASTRADA INTO vDOENCA_CADASTRADA FROM( SELECT COUNT(1)QUANT FROM RHMEDI_DOENCA WHERE CODIGO = C2.DOENCA);
IF vDOENCA_CADASTRADA = 'SIM' 
--inicio--parte nova em 13/5/20
and vPROCXCOND_APENASDATAINICIO = 'NAO' AND vCONDUTA_CONCOMITASEMDATA = 'NAO'--parte nova em 17/4/20
and vCONCOMITA_DT_DEFERIDO = 0 --colocado aqui em 21/4/20 4h19
AND 
(
  (vDATA_RESCISAO IS NULL --comentado 22/7/22 email (ERRO DE PROCESSAMENTO - IMPORTAÇÃO TEG)--AND vCONTROLE_FOLHA <> 'S'
  )
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'S') --COMENTADO EM 24/9/20--AND TRUNC(C2.DATAOCORRENCIA) <= TRUNC(vDATA_RESCISAO))
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'D' AND (TRUNC(C2.DATAINICIOAFAST) <= TRUNC(vDATA_RESCISAO)OR TRUNC(C2.DATAINICIALINDEFERIMENTO) <= TRUNC(vDATA_RESCISAO) ) )--NOVO EM 24/9/20

)--NOVO 11/5/20
--fim--parte nova em 13/5/20
THEN
dbms_output.put_line('INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03) 
VALUES (''pr114641_via_imp_ficha'', SYSDATE, '''|| C2.CODIGOEMPRESA ||''' , '''|| C2.AUTOIDFICHAATENDIMENTO ||''' , '' TO_DATE('''|| C2.DATAOCORRENCIA ||''',''DD/MM/YYYY''),'''|| vCODIGO_PESSOA ||''' , '''|| C2.DOENCA 
||''', substr(''' || C2.ESPECIALIDADETRATAMENTO||''',1,40) , substr('''|| C2.FREQUENCIA_SESSOES||''',1,40) , NULL, NULL 
,'|| vOCORRENCIA_ATUAL ||''' , '''||  vOCOR_DOENCA ||''' , '''|| C2.QTDE_SESSOES ||''' , '''|| C2.ABONO ||'''); COMMIT;');

INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA, OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, DOENCA_TRABALHO) 
VALUES ('pr114641_via_imp_ficha', SYSDATE, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO , TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.DOENCA 
, substr(C2.ESPECIALIDADETRATAMENTO,1,40) , substr(C2.FREQUENCIA_SESSOES,1,40) , NULL, NULL -- C2.PERIODOINICIALTRATAMENTO , C2.PERIODOFINALTRATAMENTO 
, vOCORRENCIA , vCONTADOR2, C2.QTDE_SESSOES, C2.ABONO, C2.POSITIVOEXAME, 'N', 'N', 'N'); COMMIT;
dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_DOE--primeira doenca');
vDOENCA := C2.DOENCA;--NOVO EM 10/6/20
--novo local em 7/5/20
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'SIM' WHERE ID = C2.ID; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  SIM, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));

UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
PR_FICHA_MEDICA_ORIGEM_TEG;---------------PARA JÁ GERAR SIT FUNC/PONTO
dbms_output.put_line('--##################################RODOU PR_FICHA_MEDICA_ORIGEM_TEG');

vPODE_PROXIMAS_DOENCAS:= 'SIM';
dbms_output.put_line('vPODE_PROXIMAS_DOENCAS: '||vPODE_PROXIMAS_DOENCAS);

ELSE
dbms_output.put_line('--DOENCA NÃO CADASTRADA: ' || C2.DOENCA);
END IF;
--*/

END IF;--DO IF C2.DOENCA IS NULL THEN

ELSE -- para mais de uma doença na ficha
--dbms_output.put_line('verificar se é nova CONDUTA ou DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);
dbms_output.put_line('verificar se é nova DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);

--nova conduta
if c2.CODIGOCONDUTA <> vCONDUTA then
--dbms_output.put_line('GRAVA nova CONDUTA , LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA );
dbms_output.put_line('NAO GRAVA nova CONDUTA NA MESMA FICHA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA );
end if;

dbms_output.put_line('vPODE_PROXIMAS_DOENCAS: '||vPODE_PROXIMAS_DOENCAS||' C2.DOENCA:' ||C2.DOENCA || ' vDOENCA: '||vDOENCA ); 

--INICIO--------------------------------nova doenca
--/* --comentado 19/11/20 para rodar o arquivo PBH de reprocesamento voltar depois
if C2.DOENCA <> vDOENCA 
--AND vPODE_PROXIMAS_DOENCAS = 'SIM'--comentado em 10/6/20
then
SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_DOENCA_CADASTRADA INTO vDOENCA_CADASTRADA FROM( SELECT COUNT(1)QUANT FROM RHMEDI_DOENCA WHERE CODIGO = C2.DOENCA);

--inicio--------------------------------------------------------------popular o campo OCORRENCIA das demais DOENCAS
SELECT X.OCORRENCIA INTO vOCORRENCIA_ATUAL FROM (
select case when max1 is null then 1 else max1 end ocorrencia from(select max(a.ocorrencia) max1 from RHMEDI_FICHA_MED a 
where a.codigo_empresa = vCODIGO_EMPRESA AND A.CODIGO_PESSOA = vCODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = to_date(C2.DATAOCORRENCIA,'dd/mm/YYyy') 
--and a.tipo_contrato = vTIPO_CONTRATO
)
)X;
--fim--------------------------------------------------------------popular o campo OCORRENCIA das demais DOENCAS

--inicio--------------------------------------------------------------popular o campo OCOR_DOENCA das demais DOENCAS
SELECT X.OCOR_DOENCA INTO vOCOR_DOENCA FROM (
select case when max1 is null then 1 else max1+1 end OCOR_DOENCA from(select max(a.OCOR_DOENCA) max1 from RHMEDI_RL_FICH_DOE a 
where a.codigo_empresa = vCODIGO_EMPRESA AND A.CODIGO_PESSOA = vCODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = to_date(C2.DATAOCORRENCIA,'dd/mm/YYyy') and a.ocorrencia = vOCORRENCIA_ATUAL 
--and a.tipo_contrato = vTIPO_CONTRATO
)
)X;
--fim--------------------------------------------------------------popular o campo OCOR_DOENCA das demais DOENCAS

--INICIO--------------------------- NOVO EM 18/11/20 --PARA NÃO GRAVAR DOENCA NO REPROCESSAMENTO DOS ARQUIVOS DA PBH SE PERIODO DEFERIMENTO ESTIVER ALTERADO
--nao deu certo
--select a.DATA_INI_AFAST, a.DATA_FIM_AFAST INTO vDATA_INI_AFAST ,vDATA_FIM_AFAST  from RHMEDI_FICHA_MED a 
--where a.codigo_empresa = vCODIGO_EMPRESA AND A.CODIGO_PESSOA = vCODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = to_date(C2.DATAOCORRENCIA,'dd/mm/YYyy')
--and a.ocorrencia = 
--(select max(x.ocorrencia)from RHMEDI_FICHA_MED x 
--where a.codigo_empresa = x.CODIGO_EMPRESA AND A.CODIGO_PESSOA = x.CODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = TRUNC(x.DT_REG_OCORRENCIA))
--;
--fim------------------------------NOVO EM 18/11/20 --PARA NÃO GRAVAR DOENCA NO REPROCESSAMENTO DOS ARQUIVOS DA PBH SE PERIODO DEFERIMENTO ESTIVER ALTERADO


dbms_output.put_line('--vOCORRENCIA_ATUAL: '||vOCORRENCIA_ATUAL);
--dbms_output.put_line('GRAVA nova DOENCA , LINHA '||vCONTADOR2 || ' C2.DOENCA: '|| C2.DOENCA);
dbms_output.put_line('GRAVA nova DOENCA na mesma FICHA, LINHA '||vCONTADOR2 || ' C2.DOENCA: '|| C2.DOENCA);
dbms_output.put_line('--vDOENCA_CADASTRADA: '||vDOENCA_CADASTRADA || ' vPROCXCOND_APENASDATAINICIO: '||vPROCXCOND_APENASDATAINICIO||' vCONDUTA_CONCOMITASEMDATA:'||vCONDUTA_CONCOMITASEMDATA||' vPODE_PROXIMAS_DOENCAS:'||vPODE_PROXIMAS_DOENCAS);

IF vDOENCA_CADASTRADA = 'SIM' 
--inicio--parte nova em 13/5/20
and vPROCXCOND_APENASDATAINICIO = 'NAO' AND vCONDUTA_CONCOMITASEMDATA = 'NAO'--parte nova em 17/4/20
--and vCONCOMITA_DT_DEFERIDO = 0 --colocado aqui em 21/4/20 4h19
AND ((vDATA_RESCISAO IS NULL --comentado 22/7/22 email (ERRO DE PROCESSAMENTO - IMPORTAÇÃO TEG)--AND vCONTROLE_FOLHA <> 'S'
)OR(vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'S' AND TRUNC(C2.DATAOCORRENCIA) <= TRUNC(vDATA_RESCISAO) ))--NOVO 11/5/20
--AND vPODE_PROXIMAS_DOENCAS = 'SIM'--comentado em 10/6/20
--fim--parte nova em 13/5/20
--comentado em 19/11/20--AND ( TRUNC(vDATA_INI_AFAST) = TRUNC(C2.DATAINICIOAFAST) AND TRUNC(vDATA_FIM_AFAST) = TRUNC(C2.DATAFIMAFAST))--NOVO EM 18/11/20
THEN
dbms_output.put_line('--vOCORRENCIA_ATUAL: '||vOCORRENCIA_ATUAL||' vOCOR_DOENCA: '||vOCOR_DOENCA);

dbms_output.put_line('INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03) 
VALUES (''pr114641_via_imp_ficha'', SYSDATE, '''|| C2.CODIGOEMPRESA ||''' , '''|| C2.AUTOIDFICHAATENDIMENTO ||''' , '' TO_DATE('''|| C2.DATAOCORRENCIA ||''',''DD/MM/YYYY''),'''|| vCODIGO_PESSOA ||''' , '''|| C2.DOENCA 
||''', substr(''' || C2.ESPECIALIDADETRATAMENTO||''',1,40) , substr('''|| C2.FREQUENCIA_SESSOES||''',1,40) , NULL, NULL 
,'|| vOCORRENCIA_ATUAL ||''' , '''||  vOCOR_DOENCA ||''' , '''|| C2.QTDE_SESSOES ||''' , '''|| C2.ABONO ||'''); COMMIT;');

INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, DOENCA_TRABALHO) 
VALUES ('pr114641_via_imp_ficha', SYSDATE, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO , TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.DOENCA 
, substr(C2.ESPECIALIDADETRATAMENTO,1,40) , substr(C2.FREQUENCIA_SESSOES,1,40) , NULL, NULL -- C2.PERIODOINICIALTRATAMENTO , C2.PERIODOFINALTRATAMENTO 
, vOCORRENCIA_ATUAL ,  vOCOR_DOENCA, C2.QTDE_SESSOES, C2.ABONO, C2.POSITIVOEXAME, 'N', 'N', 'N'); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_DOE-demais doencas');

--novo local em 7/5/20
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'SIM' WHERE ID = C2.ID; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  SIM, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));

--PR_RHMEDI_FICHA_MED_MANUAL;---------------PARA JÁ GERAR SIT FUNC/PONTO
SELECT MAX(ID)INTO vID FROM SUGESP_FICHAS_MEDICAS;
PR_RHMEDI_FICHA_MED_MANUAL('RHMEDI_RL_FICH_DOE', C2.CODIGOEMPRESA,  vCODIGO_PESSOA, to_CHAR(C2.DATAOCORRENCIA,'YYYYMMDD'), vOCORRENCIA_ATUAL, 'M', vID);---------------PARA JÁ GERAR SIT FUNC/PONTO
dbms_output.put_line('--##################################RODOU PR_RHMEDI_FICHA_MED_MANUAL');
ELSE
dbms_output.put_line('--DOENCA NÃO pode ser CADASTRADA verificar: ' || C2.DOENCA);
END IF;


end if;
--*/ --comentado 19/11/20 para rodar o arquivo PBH de reprocesamento voltar depois
--FIM--------------------------------nova doenca

END IF;--DO IF C2.ORDEM_DOENCA_FICHA = 1 THEN  --IF vCONTADOR2 = 1 THEN
--fim ------------------------FICHAS COM PARTE DE DEFERIMENTO, INDEFERIMENTO OU SEM DATAS QUE NÃO SEJAM: PARA APOSENTADORIA ou ENCAMINHAMENTO PARA O INSS-------------------


--inicio--------------------------------------------------------------------------------------FICHA PARA APOSENTADORIA --parte nova em 17/4/20---------------------------
IF C2.ORDEM_DOENCA_FICHA = 1 AND
vPROCXCOND_APENASDATAINICIO = 'SIM' 
and vCONCOMITA_DT_DEFERIDO = 0 --colocado aqui em 21/4/20 4h19
AND 
(
  (vDATA_RESCISAO IS NULL --comentado 22/7/22 email (ERRO DE PROCESSAMENTO - IMPORTAÇÃO TEG)--AND vCONTROLE_FOLHA <> 'S'
  )
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'S') --COMENTADO EM 24/9/20--AND TRUNC(C2.DATAOCORRENCIA) <= TRUNC(vDATA_RESCISAO))
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'D' AND (TRUNC(C2.DATAINICIOAFAST) <= TRUNC(vDATA_RESCISAO)OR TRUNC(C2.DATAINICIALINDEFERIMENTO) <= TRUNC(vDATA_RESCISAO) ) )--NOVO EM 24/9/20
)--NOVO 11/5/20
and vCONDUTA_CONCOMITASEMDATA = 'NAO'--NOVO EM 12/5/20
THEN 

dbms_output.put_line('--FICHA PARA APOSENTADORIA -- C2.ORDEM_DOENCA_FICHA:' || C2.ORDEM_DOENCA_FICHA|| ' C2.TIPOPROCEDIMENTO/vPROCEDIMENTO: '|| vPROCEDIMENTO);
--/*
--comentado em 27/1/20 --IF C2.CODIGO_PESSOA IS NOT NULL and C2.PERIODOLAUDO_AJUSTADO >= 0 and C2.PERIODOLAUDO_AJUSTADO < 9999 AND C2.CODIGOEMPRESA in ('0001','1700') THEN
INSERT INTO RHMEDI_FICHA_MED(EMPRESA_ATENDENTE, LOGIN_USUARIO, DT_ULT_ALTER_USUA, TIPO_CONTRATO, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, OCORRENCIA, NATUREZA_EXAME, 
CODIGO_ATENDENTE, DATA_INI_AFAST, DATA_FIM_AFAST, TEXTO05, TEXTO02, DT_PREV_RETORNO, CODIGO_PESSOA, CODIGO_CONTRATO, C_LIVRE_DATA01, C_LIVRE_DATA02, LOCAL_ATENDIMENTO
,C_LIVRE_SELEC02, DATA_CONCLUSAO, INDIC_REFERENCIA
,INFO_MESMO_MOTIVO, C_LIVRE_OPCAO02, C_LIVRE_OPCAO01, BENEFICIO, PROV_EMISSAO_CAT, NEXO_CAUSAL, PRIMEIRO_CONTATO, IND_EF_RETRO_ESOCIAL, IND_REC_EX_TOXIC_RESC, IND_DOENCA_ACIDENTE, IND_PROVENIENTE_TRABALHO, INDIC_OCUPACIONAL, IND_INTERNACAO)--NOVO EM 2/6/21 
VALUES ('0001', 'pr114641_via_imp_ficha', SYSDATE, C2.CODIGOTIPOCONTRATO, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO, TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vOCORRENCIA ,  C2.TIPOPROCEDIMENTO 
,vATENDENTE , TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY') --ALTERADO EM 29/11/21 EMAIL (Re: AFASTAMENTO NO CT03 DO SISTEMA ARTRH BM 89984-8) --TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY')+1
, TO_DATE(vDT_FIM_AFAST_PREL_APOSENTA,'DD/MM/YYYY') , 
SUBSTR(C2.MOTIVO,1,2000) ,SUBSTR(C2.EXAMECLINICO,1,2000) 
, TO_DATE(C2.DATARETORNOREAVALIACAO ,'DD/MM/YYYY'), vCODIGO_PESSOA, C2.CODIGOCONTRATO , TO_DATE(C2.DATAINICIALINDEFERIMENTO,'DD/MM/YYYY'), TO_DATE(C2.DATAFINALINDEFERIMENTO,'DD/MM/YYYY'), 
C2.SEQUENCIAL_TEG, C2.MODALIDADE_NUMERO, C2.DATACIENCIADECISAO, C2.RECONSIDERACAO
,'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'--NOVO EM 2/6/21 
); COMMIT;

UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
--*/
dbms_output.put_line('--*************************************GRAVOU RHMEDI_FICHA_MED');

--dbms_output.put_line('--C1.FICHA_DIA: ' ||C1.FICHA_DIA/*||' vCONTADOR1: ' ||vCONTADOR1*/);
dbms_output.put_line('--QUANTIDADE DE FICHA MEDICA NO ARTERH DENTRO DESTE NOVO PERIODO DE DEFERIMENTO? ' || vCONCOMITA_DT_DEFERIDO);
dbms_output.put_line(/*'--C1.FICHA_DIA: ' ||C1.FICHA_DIA|| '*/ '--vOCORRENCIA: ' ||vOCORRENCIA);
dbms_output.put_line('-- C2.DATAINICIOAFAST: '|| C2.DATAINICIOAFAST || ' C2.DATAFIMAFAST:'|| C2.DATAFIMAFAST || ' C2.DATAINICIALINDEFERIMENTO:' || C2.DATAINICIALINDEFERIMENTO|| ' C2.DATAFINALINDEFERIMENTO:' || C2.DATAFINALINDEFERIMENTO);

dbms_output.put_line('GRAVA PRIMEIRA CONDUTA E DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);
--/*
INSERT INTO RHMEDI_RL_FICH_PRO(LOGIN_USUARIO, DT_ULT_ALTER_USUA, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA,
CODIGO_PESSOA, CODIGO_PROC_MED, C_LIVRE_SELEC01 ,C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_PROC_MED) 
VALUES ('pr114641_via_imp_ficha', SYSDATE,'N','N','N',C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO, TO_DATE(C2.DATAOCORRENCIA,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.CODIGOCONDUTA 
,CASE WHEN C2.PERIODOLAUDO < 0 OR C2.PERIODOLAUDO > 9999 THEN 0 ELSE C2.PERIODOLAUDO END--,C2.PERIODOLAUDO_AJUSTADO
,TO_DATE(C2.INICIOLAUDO ,'DD/MM/YYYY'), TO_DATE(C2.FINALLAUDO ,'DD/MM/YYYY'), vOCORRENCIA ,  vCONTADOR2); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
--*/
dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_PRO');

--novo nesse local em 24/11/20
PR_FICHA_MEDICA_ORIGEM_TEG;---------------PARA JÁ GERAR SIT FUNC/PONTO
dbms_output.put_line('--##################################RODOU PR_FICHA_MEDICA_ORIGEM_TEG');

--novo local em 7/5/20
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'SIM' WHERE ID = C2.ID; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  SIM, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));

/*--comentado em 5/10/20 devido autorização da GESER combiando com GEVIF fazer manualmente o lançamento
delete RHCGED_ALT_SIT_FUN where codigo_empresa = C2.CODIGOEMPRESA and  tipo_contrato = C2.CODIGOTIPOCONTRATO and  codigo = C2.CODIGOCONTRATO and trunc(data_inic_situacao) = TO_DATE(C2.DATAINICIOAFAST ,'DD/MM/YYYY')+1 and cod_sit_funcional = SUBSTR(C1.DADO_DESTINO_TC1,1,4); COMMIT;
insert into RHCGED_ALT_SIT_FUN (ind_ef_retro_esocial,codigo_empresa, tipo_contrato, codigo, data_inic_situacao, cod_sit_funcional, LOGIN_USUARIO, DT_ULT_ALTER_USUA)
values ('N', C2.CODIGOEMPRESA, C2.CODIGOTIPOCONTRATO, C2.CODIGOCONTRATO, TO_DATE(C2.DATAOCORRENCIA,'DD/MM/YYYY')+1,  SUBSTR(C1.DADO_DESTINO_TC1,1,4), 'pr114641_via_imp_ficha', SYSDATE);COMMIT;
--SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C1.CODIGO_EMPRESA ,C1.TIPO_CONTRATO , C1.CODIGO_CONTRATO, 'pr114641_via_imp_ficha');COMMIT;
dbms_output.put_line('--*************************************GRAVOU RHCGED_ALT_SIT_FUN');

SUGESP_ALT_SIT_FUNC_ULT_CONTRA(C2.CODIGOEMPRESA, C2.CODIGOTIPOCONTRATO, C2.CODIGOCONTRATO, 'pr114641_via_imp_ficha');---------------PARA ATUALIZAR O ULTIMO CONTRATO
dbms_output.put_line('--##################################RODOU SUGESP_ALT_SIT_FUNC_ULT_CONTRA');
*/


END IF;
--fim--------------------------------------------------------------------------------------FICHA PARA APOSENTADORIA --parte nova em 17/4/20----------------------------------

--/* --INCIO--COMENTADO TEMPORARIAMENTE 12/5/20 18H40  PARA VERIFICAR ERRO EM TEMPO DE EXECUCAO: ORA-00001: restrição exclusiva (ARTERH.RHMEDI_RL_FIC_DO_P) violada ORA-06512: em line 1089
--INICIO------------------------------------------------------------------------------ENCAMINHAMENTO PARA O INSS---------------------------------------------------
IF vCONDUTA_CONCOMITASEMDATA = 'SIM' 
AND 
(
  (vDATA_RESCISAO IS NULL --comentado 22/7/22 email (ERRO DE PROCESSAMENTO - IMPORTAÇÃO TEG)--AND vCONTROLE_FOLHA <> 'S'
  )
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'S') --COMENTADO EM 24/9/20--AND TRUNC(C2.DATAOCORRENCIA) <= TRUNC(vDATA_RESCISAO))
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'D' AND (TRUNC(C2.DATAINICIOAFAST) <= TRUNC(vDATA_RESCISAO)OR TRUNC(C2.DATAINICIALINDEFERIMENTO) <= TRUNC(vDATA_RESCISAO) ) )--NOVO EM 24/9/20
)--NOVO 11/5/20
THEN
dbms_output.put_line('--ENCAMINHAMENTO PARA O INSS-- C2.ORDEM_DOENCA_FICHA:' || C2.ORDEM_DOENCA_FICHA|| ' C2.TIPOPROCEDIMENTO/vPROCEDIMENTO: '|| vPROCEDIMENTO);
INSERT INTO RHMEDI_FICHA_MED(EMPRESA_ATENDENTE, LOGIN_USUARIO, DT_ULT_ALTER_USUA, TIPO_CONTRATO, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, OCORRENCIA, NATUREZA_EXAME, 
CODIGO_ATENDENTE, TEXTO05, TEXTO02, DT_PREV_RETORNO, CODIGO_PESSOA, CODIGO_CONTRATO, LOCAL_ATENDIMENTO
,C_LIVRE_SELEC02, DATA_CONCLUSAO, INDIC_REFERENCIA
,INFO_MESMO_MOTIVO, C_LIVRE_OPCAO02, C_LIVRE_OPCAO01, BENEFICIO, PROV_EMISSAO_CAT, NEXO_CAUSAL, PRIMEIRO_CONTATO, IND_EF_RETRO_ESOCIAL, IND_REC_EX_TOXIC_RESC, IND_DOENCA_ACIDENTE, IND_PROVENIENTE_TRABALHO, INDIC_OCUPACIONAL, IND_INTERNACAO)--NOVO EM 2/6/21 
VALUES ('0001', 'pr114641_via_imp_ficha', SYSDATE, C2.CODIGOTIPOCONTRATO, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO, TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vOCORRENCIA ,  C2.TIPOPROCEDIMENTO 
,vATENDENTE ,  SUBSTR(C2.MOTIVO,1,2000) ,SUBSTR(C2.EXAMECLINICO,1,2000) 
, TO_DATE(C2.DATARETORNOREAVALIACAO ,'DD/MM/YYYY'), vCODIGO_PESSOA, C2.CODIGOCONTRATO, C2.SEQUENCIAL_TEG, C2.MODALIDADE_NUMERO, C2.DATACIENCIADECISAO, C2.RECONSIDERACAO
,'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N', 'N'--NOVO EM 2/6/21 
); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
dbms_output.put_line('--*************************************GRAVOU RHMEDI_FICHA_MED');

dbms_output.put_line('--QUANTIDADE DE FICHA MEDICA NO ARTERH DENTRO DESTE NOVO PERIODO DE DEFERIMENTO? ' || vCONCOMITA_DT_DEFERIDO);
dbms_output.put_line('--vOCORRENCIA: ' ||vOCORRENCIA);
dbms_output.put_line('-- C2.DATAINICIOAFAST: '|| C2.DATAINICIOAFAST || ' C2.DATAFIMAFAST:'|| C2.DATAFIMAFAST || ' C2.DATAINICIALINDEFERIMENTO:' || C2.DATAINICIALINDEFERIMENTO|| ' C2.DATAFINALINDEFERIMENTO:' || C2.DATAFINALINDEFERIMENTO);

dbms_output.put_line('GRAVA PRIMEIRA CONDUTA E DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);

INSERT INTO RHMEDI_RL_FICH_PRO(LOGIN_USUARIO, DT_ULT_ALTER_USUA, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA,
CODIGO_PESSOA, CODIGO_PROC_MED, C_LIVRE_SELEC01 ,C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_PROC_MED) 
VALUES ('pr114641_via_imp_ficha', SYSDATE,'N','N','N',C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO, TO_DATE(C2.DATAOCORRENCIA,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.CODIGOCONDUTA 
,CASE WHEN C2.PERIODOLAUDO < 0 OR C2.PERIODOLAUDO > 9999 THEN 0 ELSE C2.PERIODOLAUDO END--,C2.PERIODOLAUDO_AJUSTADO
,TO_DATE(C2.INICIOLAUDO ,'DD/MM/YYYY'), TO_DATE(C2.FINALLAUDO ,'DD/MM/YYYY'), vOCORRENCIA ,  vCONTADOR2); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;

dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_PRO');

IF C2.DOENCA IS NULL THEN
dbms_output.put_line('SEM DOENCA');
--PR_FICHA_MEDICA_ORIGEM_TEG;---------------PARA JÁ GERAR SIT FUNC/PONTO
ELSE
dbms_output.put_line('TEM DOENCA');

SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_DOENCA_CADASTRADA INTO vDOENCA_CADASTRADA FROM( SELECT COUNT(1)QUANT FROM RHMEDI_DOENCA WHERE CODIGO = C2.DOENCA);
IF vDOENCA_CADASTRADA = 'SIM' THEN
dbms_output.put_line('INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03) 
VALUES (''pr114641_via_imp_ficha'', SYSDATE, '''|| C2.CODIGOEMPRESA ||''' , '''|| C2.AUTOIDFICHAATENDIMENTO ||''' , '' TO_DATE('''|| C2.DATAOCORRENCIA ||''',''DD/MM/YYYY''),'''|| vCODIGO_PESSOA ||''' , '''|| C2.DOENCA 
||''', substr(''' || C2.ESPECIALIDADETRATAMENTO||''',1,40) , substr('''|| C2.FREQUENCIA_SESSOES||''',1,40) , NULL, NULL 
,'|| vOCORRENCIA_ATUAL ||''' , '''||  vOCOR_DOENCA ||''' , '''|| C2.QTDE_SESSOES ||''' , '''|| C2.ABONO ||'''); COMMIT;');

INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA, OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, DOENCA_TRABALHO) 
VALUES ('pr114641_via_imp_ficha', SYSDATE, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO , TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.DOENCA 
, substr(C2.ESPECIALIDADETRATAMENTO,1,40) , substr(C2.FREQUENCIA_SESSOES,1,40) , NULL, NULL -- C2.PERIODOINICIALTRATAMENTO , C2.PERIODOFINALTRATAMENTO 
, vOCORRENCIA , vCONTADOR2, C2.QTDE_SESSOES, C2.ABONO, C2.POSITIVOEXAME, 'N', 'N', 'N'); COMMIT;
dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_DOE--primeira doenca');

vPODE_PROXIMAS_DOENCAS:= 'SIM';
dbms_output.put_line('vPODE_PROXIMAS_DOENCAS: '||vPODE_PROXIMAS_DOENCAS);

--novo local em 7/5/20
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'SIM' WHERE ID = C2.ID; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  SIM, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));

UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
PR_FICHA_MEDICA_ORIGEM_TEG;---------------PARA JÁ GERAR SIT FUNC/PONTO
dbms_output.put_line('--##################################RODOU PR_FICHA_MEDICA_ORIGEM_TEG');
ELSE
dbms_output.put_line('--DOENCA NÃO CADASTRADA: ' || C2.DOENCA);
END IF;

END IF;--DO IF C2.DOENCA IS NULL THEN

ELSE -- para mais de uma doença na ficha
--dbms_output.put_line('verificar se é nova CONDUTA ou DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);
dbms_output.put_line('verificar se é nova DOENCA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA || ' C2.DOENCA: '|| C2.DOENCA);

--nova conduta
if c2.CODIGOCONDUTA <> vCONDUTA then
--dbms_output.put_line('GRAVA nova CONDUTA , LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA );
dbms_output.put_line('NAO GRAVA nova CONDUTA NA MESMA FICHA, LINHA '||vCONTADOR2 ||' C2.CODIGOCONDUTA: '||C2.CODIGOCONDUTA );
end if;

dbms_output.put_line('C2.DOENCA:' ||C2.DOENCA || ' vDOENCA: '||vDOENCA ); 
--nova doenca
if C2.DOENCA <> vDOENCA 
AND vPODE_PROXIMAS_DOENCAS = 'SIM'
then
SELECT CASE WHEN QUANT = 0 THEN 'NAO' ELSE 'SIM' END TEM_DOENCA_CADASTRADA INTO vDOENCA_CADASTRADA FROM( SELECT COUNT(1)QUANT FROM RHMEDI_DOENCA WHERE CODIGO = C2.DOENCA);

--inicio--------------------------------------------------------------popular o campo OCORRENCIA das demais DOENCAS
SELECT X.OCORRENCIA INTO vOCORRENCIA_ATUAL FROM (
select case when max1 is null then 1 else max1 end ocorrencia from(select max(a.ocorrencia) max1 from RHMEDI_FICHA_MED a 
where a.codigo_empresa = vCODIGO_EMPRESA AND A.CODIGO_PESSOA = vCODIGO_PESSOA and TRUNC(a.DT_REG_OCORRENCIA) = to_date(C2.DATAOCORRENCIA,'dd/mm/YYyy') ))X;
--fim--------------------------------------------------------------popular o campo OCORRENCIA das demais DOENCAS
dbms_output.put_line('--vOCORRENCIA_ATUAL: '||vOCORRENCIA_ATUAL);

IF vDOENCA_CADASTRADA = 'SIM'
--INICIO-- PARTE NOVA EM 13/5/20
AND vCONDUTA_CONCOMITASEMDATA = 'SIM' 
AND 
(
  (vDATA_RESCISAO IS NULL --comentado 22/7/22 email (ERRO DE PROCESSAMENTO - IMPORTAÇÃO TEG)--AND vCONTROLE_FOLHA <> 'S'
  )
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'S') --COMENTADO EM 24/9/20--AND TRUNC(C2.DATAOCORRENCIA) <= TRUNC(vDATA_RESCISAO))
  OR
  (vDATA_RESCISAO IS NOT NULL AND vCONTROLE_FOLHA = 'D' AND (TRUNC(C2.DATAINICIOAFAST) <= TRUNC(vDATA_RESCISAO)OR TRUNC(C2.DATAINICIALINDEFERIMENTO) <= TRUNC(vDATA_RESCISAO) ) )--NOVO EM 24/9/20
)--NOVO 11/5/20
AND vPODE_PROXIMAS_DOENCAS = 'SIM'
--FIM-- PARTE NOVA EM 13/5/20
THEN
dbms_output.put_line('GRAVA nova DOENCA na mesma FICHA, LINHA '||vCONTADOR2 || ' C2.DOENCA: '|| C2.DOENCA);
INSERT INTO RHMEDI_RL_FICH_DOE(LOGIN_USUARIO, DT_ULT_ALTER_USUA, CODIGO_EMPRESA, C_LIVRE_VALOR01, DT_REG_OCORRENCIA, CODIGO_PESSOA, COD_DOENCA, C_LIVRE_DESCR01, 
C_LIVRE_DESCR02, C_LIVRE_DATA01, C_LIVRE_DATA02, OCORRENCIA,  OCOR_DOENCA, C_LIVRE_VALOR03, C_LIVRE_DESCR03, C_LIVRE_OPCAO01, C_LIVRE_OPCAO02, C_LIVRE_OPCAO03, DOENCA_TRABALHO) 
VALUES ('pr114641_via_imp_ficha', SYSDATE, C2.CODIGOEMPRESA , C2.AUTOIDFICHAATENDIMENTO , TO_DATE(C2.DATAOCORRENCIA ,'DD/MM/YYYY'), vCODIGO_PESSOA , C2.DOENCA 
, substr(C2.ESPECIALIDADETRATAMENTO,1,40) , substr(C2.FREQUENCIA_SESSOES,1,40) , NULL, NULL -- C2.PERIODOINICIALTRATAMENTO , C2.PERIODOFINALTRATAMENTO 
, vOCORRENCIA_ATUAL ,  vCONTADOR2, C2.QTDE_SESSOES, C2.ABONO, C2.POSITIVOEXAME, 'N', 'N', 'N'); COMMIT;
UPDATE SUGESP_FICHAS_MEDICAS SET PROCESSADO = NULL WHERE ID = (SELECT MAX(ID) FROM SUGESP_FICHAS_MEDICAS); COMMIT;
dbms_output.put_line('--*************************************GRAVOU RHMEDI_RL_FICH_DOE--demais doencas conduta 38');

--novo local em 7/5/20
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'SIM' WHERE ID = C2.ID; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  SIM, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));

--PR_RHMEDI_FICHA_MED_MANUAL;---------------PARA JÁ GERAR SIT FUNC/PONTO
SELECT MAX(ID)INTO vID FROM SUGESP_FICHAS_MEDICAS;
PR_RHMEDI_FICHA_MED_MANUAL('RHMEDI_RL_FICH_DOE', C2.CODIGOEMPRESA,  vCODIGO_PESSOA, to_CHAR(C2.DATAOCORRENCIA,'YYYYMMDD'), vOCORRENCIA_ATUAL, 'M', vID);---------------PARA JÁ GERAR SIT FUNC/PONTO
dbms_output.put_line('--##################################RODOU PR_RHMEDI_FICHA_MED_MANUAL--conduta 38');
ELSE
dbms_output.put_line('--DOENCA NÃO CADASTRADA: ' || C2.DOENCA);
END IF;


end if;
END IF;
--FIM------------------------------------------------------------------------------ENCAMINHAMENTO PARA O INSS------------------------------------------------------
--*/ --FIM--COMENTADO TEMPORARIAMENTE 12/5/20 18H40 PARA VERIFICAR ERRO EM TEMPO DE EXECUCAO: ORA-00001: restrição exclusiva (ARTERH.RHMEDI_RL_FIC_DO_P) violada ORA-06512: em line 1089

EXCEPTION WHEN OTHERS THEN
err_msg := SQLCODE||' '||SUBSTR(SQLERRM, 1, 4000);
dbms_output.put_line('err_msg:' ||err_msg);

INSERT INTO SUGESP_AJUSTE_LOTE_CAMPO_HIST(CODIGO_EMPRESA, TIPO_CONTRATO, CODIGO_CONTRATO, CAMPO_VALOR_1,  DATA_DADOS, CONSIDERACOES, CAMPO_VALOR_2)
VALUES(C2.CODIGOEMPRESA,C2.CODIGOTIPOCONTRATO, C2.CODIGOCONTRATO,'LOG EXECUCAO PROCEDURE PR_GRAVA_FICHA_MEDICA_TEG', SYSDATE, err_msg, C2.ID
);COMMIT;
END;--BEGIN EXCEPTION
--/*
vPROCEDIMENTO := C2.TIPOPROCEDIMENTO;
vCONDUTA := C2.CODIGOCONDUTA;
--vDOENCA := C2.DOENCA;--COMENTADO EM 10/6/20
vCONTADOR2 := vCONTADOR2 + 1;
--vCONTADOR1 := vOCORRENCIA + 1 ;
--*/
----comentado 21/4/20 4h17 --END IF; --FIM DO IF vCONCOMITA_DT_DEFERIDO = 0 THEN
--em 11/4/20--FIM ---------------------------IF para começar a gravar nas tabelas-----------------------------------------------------------------------
--fim------------------------------------------rodar direto

/*
vPROCEDIMENTO := C2.TIPOPROCEDIMENTO;
vCONDUTA := C2.CODIGOCONDUTA;
vDOENCA := C2.DOENCA;
vCONTADOR2 := vCONTADOR2 + 1;
--vCONTADOR1 := vOCORRENCIA + 1 ;
*/


/*--comentado em 7/5/20 pois estava gravando como PROCESSADO = SIM alguns que na realidade não foram
-- MARCAR COMO PROCESSADO
UPDATE SUGESP_ARQUIVOS_FICHA  SET DATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  'SIM' 
WHERE 
ID = C2.ID
--AUTOIDFICHAATENDIMENTO = C2.AUTOIDFICHAATENDIMENTO AND SEQUENCIAL_TEG = C2.SEQUENCIAL_TEG AND CODIGOEMPRESA = C2.CODIGOEMPRESA AND CODIGOTIPOCONTRATO = C2. CODIGOTIPOCONTRATO
--AND CODIGOCONTRATO = C2.CODIGOCONTRATO AND DATAOCORRENCIA = C2.DATAOCORRENCIA AND ATENDENTE = C2.ATENDENTE 
--AND TIPOPROCEDIMENTO = C2.TIPOPROCEDIMENTO AND CODIGOCONDUTA = C2.CODIGOCONDUTA AND DOENCA = C2.DOENCA
--AND ORDEM_DOENCA_FICHA = C2.ORDEM_DOENCA_FICHA
; COMMIT;
dbms_output.put_line('--grava SUGESP_ARQUIVOS_FICHADATA_PROCESSAMENTO = SYSDATE, STATUS_PROCESSAMENTO =  SIM, ID: '|| C2.ID || ' SYSDATE:' || TO_DATE(SYSDATE, 'DD/MM/YYYY HH24:MI:SS'));
*/

END LOOP; --C2 

--END LOOP; --vQUANT

vPROCEDIMENTO := NULL;
vCONDUTA := NULL;
--vDOENCA := NULL;--COMENTADO EM 10/6/20
vCONTADOR2 := 1;




ELSE
dbms_output.put_line('--NAO FAZER NADA: MAIS DE 1 ou NENHUM BM ATIVO COM O MESMO CODIGO NA BASE, BM: '||C1.CODIGO_CONTRATO ||' C1.CODIGOEMPRESA: '||C1.CODIGO_EMPRESA||' C1.CODIGOTIPOCONTRATO:' ||C1.TIPO_CONTRATO ||' DATA ATENDIMENTO: '||C1.DT_REG_OCORRENCIA||' PROCEDIMENTO: '||C1.TIPO_PROCEDIMENTO);

END IF; --MAIS DE UM BM NO MESMO CODIGO ATIVO NAO FAZ NADA
--vCONTADOR1 := vCONTADOR1+1 ;
dbms_output.put_line('------------------------------------------------------------------------------------------------------------------------------------------------------');

END LOOP;--C1

END LOOP; --vLOTES

--END LOOP;--C0

END;

END;
