
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_SUGESP_RHORGA_AGRUP_TIPO_G" (CODIGO_EMPRESA IN VARCHAR2, COD_AGRUP1 IN VARCHAR2, COD_AGRUP2 IN VARCHAR2, COD_AGRUP3 IN VARCHAR2, COD_AGRUP4 IN VARCHAR2, COD_AGRUP5 IN VARCHAR2, COD_AGRUP6 IN VARCHAR2)
AS
--KELLYSSON 14/5/19
BEGIN

DECLARE
   vCODIGO_EMPRESA VARCHAR2(4);
   vCOD_AGRUP1 VARCHAR2(6);
   vCOD_AGRUP2 VARCHAR2(6);
   vCOD_AGRUP3 VARCHAR2(6);
   vCOD_AGRUP4 VARCHAR2(6);
   vCOD_AGRUP5 VARCHAR2(6);
   vCOD_AGRUP6 VARCHAR2(6);

BEGIN

   vCODIGO_EMPRESA := CODIGO_EMPRESA;
   vCOD_AGRUP1 := COD_AGRUP1;
   vCOD_AGRUP2 := COD_AGRUP2;
   vCOD_AGRUP3 := COD_AGRUP3;
   vCOD_AGRUP4 := COD_AGRUP4;
   vCOD_AGRUP5 := COD_AGRUP5;
   vCOD_AGRUP6 := COD_AGRUP6;

for c1 in(

  SELECT * FROM SUGESP_RHORGA_AGRUP_TIPO_G WHERE   CODIGO_EMPRESA = vCODIGO_EMPRESA and COD_AGRUP1 = vCOD_AGRUP1 and COD_AGRUP2 = vCOD_AGRUP2 and COD_AGRUP3 = vCOD_AGRUP3
  and COD_AGRUP4 = vCOD_AGRUP4 and COD_AGRUP5 = vCOD_AGRUP5 and COD_AGRUP6 = vCOD_AGRUP6
  AND ID = (SELECT MAX(ID) FROM SUGESP_RHORGA_AGRUP_TIPO_G WHERE   CODIGO_EMPRESA = vCODIGO_EMPRESA and COD_AGRUP1 = vCOD_AGRUP1 and COD_AGRUP2 = vCOD_AGRUP2 and COD_AGRUP3 = vCOD_AGRUP3
  and COD_AGRUP4 = vCOD_AGRUP4 and COD_AGRUP5 = vCOD_AGRUP5 and COD_AGRUP6 = vCOD_AGRUP6)
)

loop

-----INICIO--------------------1ª PARTE -----------TROCOU O GESTOR DO LOCAL ATIVO
IF (C1.TIPO_DML = 'U' AND C1.OLD_CONTRATO_RESP <> C1.NEW_CONTRATO_RESP AND C1.NEW_DATA_EXTINCAO IS NULL)THEN
--ELSIF (UPDATING AND :OLD.CONTRATO_RESP <> :NEW.CONTRATO_RESP ) THEN


---****************PRIMEIRO FINALIZA O REGISTRO ABERTO NO ANTIGO GESTOR
--tabela RHUSER_PESSOA_RESPONSAVEL
--select * from RHUSER_PESSOA_RESPONSAVEL WHERE id = (Select id_rhuser_pessoa_responsavel From rhuser_pessoa_resp_agrupador
UPDATE RHUSER_PESSOA_RESPONSAVEL SET DT_FIM_RESPONSABILIDADE = SYSDATE, UPDATED = SYSDATE, UPDATEDBY = C1.NEW_LOGIN_USUARIO
WHERE DT_FIM_RESPONSABILIDADE is null and ID =
(SELECT ID_RHUSER_PESSOA_RESPONSAVEL FROM rhuser_pessoa_resp_agrupador WHERE DT_FIM_RESPONSAVEL IS NULL AND CODIGO_EMPRESA = '0001' and TIPO_AGRUP = 'G' AND ID_AGRUP =
            (
            SELECT ID_AGRUP FROM RHORGA_AGRUPADOR WHERE CODIGO_EMPRESA = '0001' AND TIPO_AGRUP = 'G' AND COD_AGRUP1 = C1.COD_AGRUP1 AND COD_AGRUP2 = C1.COD_AGRUP2 AND COD_AGRUP3 = C1.COD_AGRUP3
            AND COD_AGRUP4 = C1.COD_AGRUP4 AND COD_AGRUP5 = C1.COD_AGRUP5 AND COD_AGRUP6 = C1.COD_AGRUP6
            ));
COMMIT;

--tabela rhuser_pessoa_resp_agrupador --NOVO EM 28/2/19

UPDATE rhuser_pessoa_resp_agrupador SET DT_FIM_RESPONSAVEL = SYSDATE, UPDATED = SYSDATE, UPDATEDBY = C1.NEW_LOGIN_USUARIO
WHERE ID =
      (SELECT ID FROM rhuser_pessoa_resp_agrupador WHERE DT_FIM_RESPONSAVEL IS NULL AND CODIGO_EMPRESA = '0001' and TIPO_AGRUP = 'G' AND ID_AGRUP =
            (
            SELECT ID_AGRUP FROM RHORGA_AGRUPADOR WHERE CODIGO_EMPRESA = '0001' AND TIPO_AGRUP = 'G' AND COD_AGRUP1 = C1.COD_AGRUP1 AND COD_AGRUP2 = C1.COD_AGRUP2 AND COD_AGRUP3 = C1.COD_AGRUP3
            AND COD_AGRUP4 = C1.COD_AGRUP4 AND COD_AGRUP5 = C1.COD_AGRUP5 AND COD_AGRUP6 = C1.COD_AGRUP6
            )
      );
commit;

/*
---****************SEGUNDO CRIA REGISTRO DO NOVO GESTOR
--tabela RHUSER_PESSOA_RESPONSAVEL
INSERT INTO RHUSER_PESSOA_RESPONSAVEL (
ID,
ID_PROCESSO,
ID_TAREFA,
CODIGO_EMPRESA,
CODIGO_USUARIO,
CODIGO_EMPRESA_PESSOA_RESP,
CODIGO_PESSOA_RESP,
CODIGO_CONTRATO_RESP,
TIPO_CONTRATO_RESP,
CODIGO_EMPRESA_CONTRATO,
DT_INICIO_RESPONSABILIDADE,
DT_FIM_RESPONSABILIDADE,
CREATED,
CREATEDBY,
UPDATED,
UPDATEDBY,
NOME_COMPOSTO,
MOTIVO_DELEGACAO,
ID_DELEGACAO_SUBSTITUICAO)
VALUES
(
(SELECT MAX(ID)+1 FROM RHUSER_PESSOA_RESPONSAVEL),
2,
NULL,
C1.CODIGO_EMPRESA,
C1.NEW_LOGIN_USUARIO,
C1.CODIGO_EMPRESA,
C1.NEW_COD_PESSOA_RESP,
C1.NEW_CONTRATO_RESP,
C1.NEW_TIPO_CONT_RESP,
C1.NEW_COD_EMPRESA_PESS,
SYSDATE,
NULL,
SYSDATE,
C1.NEW_LOGIN_USUARIO,
SYSDATE,
C1.NEW_LOGIN_USUARIO,
(select C.CODIGO||' - '||NVL(TRIM(P.NOME_SOCIAL),TRIM(P.NOME_ACESSO)) ||' - '||C.TIPO_CONTRATO||' - '|| NVL(TRIM(C1.TEXTO_ASSOCIADO),TRIM(C1.DESCRICAO))from RHPESS_CONTRATO C left outer join RHPESS_PESSOA P ON P.CODIGO_EMPRESA = C.CODIGO_EMPRESA AND P.CODIGO = C.CODIGO_PESSOA WHERE C.ANO_MES_REFERENCIA = (select max(ANO_MES_REFERENCIA) from RHPESS_CONTRATO AUX where AUX.CODIGO_EMPRESA = C.CODIGO_EMPRESA and AUX.TIPO_CONTRATO = C.TIPO_CONTRATO and AUX.CODIGO = C.CODIGO)AND C.CODIGO_EMPRESA = C1.NEW_COD_EMPRESA_PESS AND C.TIPO_CONTRATO = C1.NEW_TIPO_CONT_RESP AND C.CODIGO = C1.NEW_CONTRATO_RESP),
--:NEW.COD_AGRUP1|| '.'|| :NEW.COD_AGRUP2|| '.'|| :NEW.COD_AGRUP3|| '.'|| :NEW.COD_AGRUP4|| '.'|| :NEW.COD_AGRUP5|| '.'|| :NEW.COD_AGRUP6|| '-'|| :NEW.DESCRICAO|| '-'|| :NEW.ABREVIACAO,
'F',
C1.ID_AGRUP ----TESTES VOLTAR DEPOIS PARA NULL
);
COMMIT;

--tabela rhuser_pessoa_resp_agrupador --NOVO EM 28/2/19
INSERT INTO rhuser_pessoa_resp_agrupador (
ID,
ID_RHUSER_PESSOA_RESPONSAVEL,
CODIGO_EMPRESA,
TIPO_AGRUP,
ID_AGRUP,
CREATED,
CREATEDBY,
UPDATED,
UPDATEDBY,
DT_INICIO_RESPONSAVEL,
NOME_AGRUPADOR_COMPOSTO)
VALUES
(
(SELECT MAX(ID)+1 FROM rhuser_pessoa_resp_agrupador),
(SELECT MAX(ID) FROM RHUSER_PESSOA_RESPONSAVEL),
C1.CODIGO_EMPRESA,
'G',
C1.ID_AGRUP,
SYSDATE,
C1.NEW_LOGIN_USUARIO,
SYSDATE,
C1.NEW_LOGIN_USUARIO,
SYSDATE,
C1.COD_AGRUP1|| '.'|| C1.COD_AGRUP2|| '.'|| C1.COD_AGRUP3|| '.'|| C1.COD_AGRUP4|| '.'|| C1.COD_AGRUP5|| '.'|| C1.COD_AGRUP6|| '-'|| NVL(TRIM(C1.TEXTO_ASSOCIADO),TRIM(C1.DESCRICAO))|| '-'|| C1.ABREVIACAO
);
commit;
*/
-----FIM----------------------1ª PARTE -----------TROCOU O GESTOR DO LOCAL ATIVO

-----INICIO----------------------------2ª PARTE -------------LOCAL SENDO INATIVO
ELSIF (C1.TIPO_DML = 'U' AND C1.OLD_DATA_EXTINCAO IS NOT NULL AND C1.NEW_DATA_EXTINCAO IS NULL)THEN
--ELSIF (UPDATING AND :OLD.CONTRATO_RESP <> :NEW.CONTRATO_RESP ) THEN


---****************PRIMEIRO FINALIZA O REGISTRO ABERTO NO ANTIGO GESTOR
--tabela RHUSER_PESSOA_RESPONSAVEL
--select * from RHUSER_PESSOA_RESPONSAVEL WHERE id = (Select id_rhuser_pessoa_responsavel From rhuser_pessoa_resp_agrupador
UPDATE RHUSER_PESSOA_RESPONSAVEL SET DT_FIM_RESPONSABILIDADE = SYSDATE, UPDATED = SYSDATE, UPDATEDBY = C1.NEW_LOGIN_USUARIO
WHERE DT_FIM_RESPONSABILIDADE is null and ID =
(SELECT ID_RHUSER_PESSOA_RESPONSAVEL FROM rhuser_pessoa_resp_agrupador WHERE DT_FIM_RESPONSAVEL IS NULL AND CODIGO_EMPRESA = '0001' and TIPO_AGRUP = 'G' AND ID_AGRUP =
            (
            SELECT ID_AGRUP FROM RHORGA_AGRUPADOR WHERE CODIGO_EMPRESA = '0001' AND TIPO_AGRUP = 'G' AND COD_AGRUP1 = C1.COD_AGRUP1 AND COD_AGRUP2 = C1.COD_AGRUP2 AND COD_AGRUP3 = C1.COD_AGRUP3
            AND COD_AGRUP4 = C1.COD_AGRUP4 AND COD_AGRUP5 = C1.COD_AGRUP5 AND COD_AGRUP6 = C1.COD_AGRUP6
            ));
COMMIT;

--tabela rhuser_pessoa_resp_agrupador --NOVO EM 28/2/19

UPDATE rhuser_pessoa_resp_agrupador SET DT_FIM_RESPONSAVEL = SYSDATE, UPDATED = SYSDATE, UPDATEDBY = C1.NEW_LOGIN_USUARIO
WHERE ID =
      (SELECT ID FROM rhuser_pessoa_resp_agrupador WHERE DT_FIM_RESPONSAVEL IS NULL AND CODIGO_EMPRESA = '0001' and TIPO_AGRUP = 'G' AND ID_AGRUP =
            (
            SELECT ID_AGRUP FROM RHORGA_AGRUPADOR WHERE CODIGO_EMPRESA = '0001' AND TIPO_AGRUP = 'G' AND COD_AGRUP1 = C1.COD_AGRUP1 AND COD_AGRUP2 = C1.COD_AGRUP2 AND COD_AGRUP3 = C1.COD_AGRUP3
            AND COD_AGRUP4 = C1.COD_AGRUP4 AND COD_AGRUP5 = C1.COD_AGRUP5 AND COD_AGRUP6 = C1.COD_AGRUP6
            )
      );
commit;


-----FIM-------------------------------2ª PARTE -------------LOCAL SENDO INATIVO


---INICIO------------------------------3ª PARTE -------------LOCAL SENDO REATIVO
--INICIALMENTE NENHUMA PARTE NA PROCEDURE
-----FIM-------------------------------3ª PARTE -------------LOCAL SENDO REATIVO

END IF;



end loop;

END;
END;