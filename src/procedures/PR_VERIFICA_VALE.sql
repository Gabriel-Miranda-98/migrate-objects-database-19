
  CREATE OR REPLACE EDITIONABLE PROCEDURE "ARTERH"."PR_VERIFICA_VALE" (V_CODIGO_EMPRESA CHAR, V_TIPO_CONTRATO  CHAR,  V_CPF VARCHAR2, V_TIPO_VALE CHAR,DATA_INI DATE,DATA_FIM DATE,tipo VARCHAR2 , ALT_DEFINITIVA CHAR,data_vale1 DATE,data_vale2 DATE)
  AS
    CONT        NUMBER;
    VERIFICADOR NUMBER;
    dados DADOS_RETORNO_FUN;
    COD_LINHA             VARCHAR2(15 BYTE);
    COD_ITNERARIO         CHAR(4 BYTE);
    vQTDE_LINHAS_AFETADAS NUMBER;

BEGIN
  dados      :=DADOS_RETORNO_FUN(NULL,NULL,NULL);
  VERIFICADOR:=0;
  /*O SELECT ABAIXO RETORNA SE O CPF POSSUI VALE ATIVO OU NÃO. OU SEJA, SE POSSUI VALE EM ABERTO E QUE ATENDE TODAS AS REGRAS ABAIXO*/
  SELECT COUNT(1)QUANT
  INTO VERIFICADOR
  FROM ARTERH.RHVALE_TRANSPORTE VL
  LEFT OUTER JOIN ARTERH.RHVALE_ITINERARIO IT
  ON IT.CODIGO=VL.CODIGO_ITINERARIO
  LEFT OUTER JOIN ARTERH.RHVALE_LINHA_TRANS LI
  ON LI.CODIGO    =VL.CODIGO_LINHA
  AND IT.TIPO_VALE=LI.TIPO_VALE
  LEFT OUTER JOIN
    (SELECT *
    FROM ARTERH.RHPESS_CONTRATO CN
    WHERE CN.ANO_MES_REFERENCIA=
      (SELECT MAX(AUX.ANO_MES_REFERENCIA)
      FROM ARTERH.RHPESS_CONTRATO AUX
      WHERE AUX.TIPO_CONTRATO =CN.TIPO_CONTRATO
      AND AUX.CODIGO_EMPRESA  = CN.CODIGO_EMPRESA
      AND AUX.CODIGO          =CN.CODIGO
      )
    ) CN
  ON CN.CODIGO         =VL.CODIGO_CONTRATO
  AND CN.TIPO_CONTRATO =VL.TIPO_CONTRATO
  AND CN.CODIGO_EMPRESA=VL.CODIGO_EMPRESA
  LEFT OUTER JOIN ARTERH.RHPESS_PESSOA P
  ON P.CODIGO             =CN.CODIGO_PESSOA
  AND P.CODIGO_EMPRESA    =CN.CODIGO_EMPRESA
  WHERE CN.CODIGO_EMPRESA =V_CODIGO_EMPRESA
  AND CN.TIPO_CONTRATO    = V_TIPO_CONTRATO
  AND LI.TIPO_VALE        =V_TIPO_VALE
  AND P.CPF               =V_CPF
  AND CN.DATA_RESCISAO IS NULL /*INCLUIDO EM 22/06/2022 */
  AND  VL.CODIGO_LINHA NOT IN (SELECT DADO_DESTINO FROM ARTERH.RHINTE_ED_IT_CONV XL WHERE XL.CODIGO_CONVERSAO='VRLC'
AND TRIM(VL.CODIGO_LINHA)=TRIM(XL.DADO_ORIGEM))
  AND (
         (VL.DATA_INI_VIGENCIA BETWEEN data_vale1 AND data_vale2)
         OR (VL.DATA_INI_VIGENCIA <=data_vale1 and VL.DATA_fim_VIGENCIA is null)
           OR (data_vale1 BETWEEN VL.DATA_INI_VIGENCIA and VL.DATA_fim_VIGENCIA )
         )
  AND   OCORRENCIA          =
        (SELECT MAX (AUX.OCORRENCIA)
        FROM ARTERH.RHVALE_TRANSPORTE AUX
         LEFT OUTER JOIN
        (SELECT *
        FROM ARTERH.RHPESS_CONTRATO CN
        WHERE CN.ANO_MES_REFERENCIA=
          (SELECT MAX(AUX.ANO_MES_REFERENCIA)
          FROM ARTERH.RHPESS_CONTRATO AUX
          WHERE AUX.TIPO_CONTRATO=CN.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA =CN.CODIGO_EMPRESA
          AND AUX.CODIGO         = CN.CODIGO
          )
        ) CN
      ON CN.CODIGO         =aux.CODIGO_CONTRATO
      AND CN.TIPO_CONTRATO =aux.TIPO_CONTRATO
      AND CN.CODIGO_EMPRESA=aux.CODIGO_EMPRESA
      LEFT OUTER JOIN ARTERH.RHPESS_PESSOA PAUX
      ON PAUX.CODIGO             =CN.CODIGO_PESSOA
      AND PAUX.CODIGO_EMPRESA    =CN.CODIGO_EMPRESA
        WHERE AUX.CODIGO_EMPRESA  =VL.CODIGO_EMPRESA
        AND AUX.TIPO_CONTRATO     =VL.TIPO_CONTRATO
        AND AUX.CODIGO_LINHA      =VL.CODIGO_LINHA
        AND AUX.CODIGO_ITINERARIO =VL.CODIGO_ITINERARIO
        AND P.CPF=PAUX.CPF
        AND (
         (AUX.DATA_INI_VIGENCIA BETWEEN data_vale1 AND data_vale2)
         OR (AUX.DATA_INI_VIGENCIA <= data_vale1 and AUX.DATA_fim_VIGENCIA is null)
                  OR (data_vale1 BETWEEN VL.DATA_INI_VIGENCIA and VL.DATA_fim_VIGENCIA )
         )
        );
  -- SE NÃO POSSUIR VALE DENTRO DO MES DE EXECUÇÃO E O TIPO = INCLUIR E       ALT_DEFINITIVA = S
  DBMS_Output.PUT_LINE('VERIFICADOR ' || VERIFICADOR);
  IF VERIFICADOR          =0 AND TIPO='INCLUIR' AND ALT_DEFINITIVA= 'S' THEN
    dados                :=OBETER_CONTRATO_VALE(V_CODIGO_EMPRESA,V_TIPO_CONTRATO,V_CPF);
      IF dados.TIPO_CONTRATO IS NOT NULL THEN 
          SELECT SUBSTR(DADO_DESTINO,0,15) AS CODIGO_LINHA,
            SUBSTR(DADO_DESTINO,16,4)      AS CODIGO_ITNERARIO
          INTO COD_LINHA,
            COD_ITNERARIO
          FROM ARTERH.RHINTE_ED_IT_CONV
          WHERE CODIGO_CONVERSAO ='VRLI'
          AND DADO_ORIGEM        =dados.TIPO_CONTRATO;
        ---  chama função de incluir
          DBMS_Output.PUT_LINE('INCLUIR_VALE ');
          vQTDE_LINHAS_AFETADAS :=INCLUIR_VALE(dados.CODIGO_EMPRESA,dados.TIPO_CONTRATO, dados.CODIGO_CONTRATO,COD_LINHA,COD_ITNERARIO,DATA_INI,DATA_FIM);
      END IF;

  -- SE NÃO POSSUIR VALE DENTRO DO MES DE EXECUÇÃO E O TIPO = INCLUIR E       ALT_DEFINITIVA = N  
  ELSIF VERIFICADOR        =0 AND TIPO='INCLUIR' AND ALT_DEFINITIVA='N' THEN
      dados                 :=OBETER_CONTRATO_VALE(V_CODIGO_EMPRESA,V_TIPO_CONTRATO, V_CPF);
  IF dados.TIPO_CONTRATO IS NOT NULL THEN 
    SELECT SUBSTR(DADO_DESTINO,0,15) AS CODIGO_LINHA,
      SUBSTR(DADO_DESTINO,16,4)      AS CODIGO_ITNERARIO
    INTO COD_LINHA,
      COD_ITNERARIO
    FROM ARTERH.RHINTE_ED_IT_CONV
    WHERE CODIGO_CONVERSAO ='VRLI'
    AND DADO_ORIGEM        =dados.TIPO_CONTRATO;
    vQTDE_LINHAS_AFETADAS :=INCLUIR_VALE(dados.CODIGO_EMPRESA,dados.TIPO_CONTRATO, dados.CODIGO_CONTRATO,COD_LINHA,COD_ITNERARIO,DATA_INI,DATA_FIM);
    END IF;

  ELSIF VERIFICADOR!=0 THEN
    BEGIN
      dados:=DADOS_RETORNO_FUN(NULL,NULL,NULL);
      CONT :=0;
      FOR C1 IN
      (SELECT VL.CODIGO_EMPRESA,
        VL.TIPO_CONTRATO,
        VL.CODIGO_CONTRATO,
        P.CPF,
        VL.DATA_INI_VIGENCIA,
        VL.DATA_FIM_VIGENCIA,
        VL.CODIGO_LINHA,
        VL.CODIGO_ITINERARIO
      FROM ARTERH.RHVALE_TRANSPORTE VL
      LEFT OUTER JOIN ARTERH.RHVALE_ITINERARIO IT
      ON IT.CODIGO=VL.CODIGO_ITINERARIO
      LEFT OUTER JOIN ARTERH.RHVALE_LINHA_TRANS LI
      ON LI.CODIGO    =VL.CODIGO_LINHA
      AND IT.TIPO_VALE=LI.TIPO_VALE
      LEFT OUTER JOIN
        (SELECT *
        FROM ARTERH.RHPESS_CONTRATO CN
        WHERE CN.ANO_MES_REFERENCIA=
          (SELECT MAX(AUX.ANO_MES_REFERENCIA)
          FROM ARTERH.RHPESS_CONTRATO AUX
          WHERE AUX.TIPO_CONTRATO=CN.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA =CN.CODIGO_EMPRESA
          AND AUX.CODIGO         = CN.CODIGO
          )
        ) CN
      ON CN.CODIGO         =VL.CODIGO_CONTRATO
      AND CN.TIPO_CONTRATO =VL.TIPO_CONTRATO
      AND CN.CODIGO_EMPRESA=VL.CODIGO_EMPRESA
      LEFT OUTER JOIN ARTERH.RHPESS_PESSOA P
      ON P.CODIGO             =CN.CODIGO_PESSOA
      AND P.CODIGO_EMPRESA    =CN.CODIGO_EMPRESA
      WHERE CN.CODIGO_EMPRESA =V_CODIGO_EMPRESA
      AND CN.TIPO_CONTRATO    =V_TIPO_CONTRATO
      AND LI.TIPO_VALE        =V_TIPO_VALE
      AND P.CPF               =V_CPF
      AND  VL.CODIGO_LINHA NOT IN (SELECT DADO_DESTINO FROM ARTERH.RHINTE_ED_IT_CONV XL WHERE XL.CODIGO_CONVERSAO='VRLC'
AND TRIM(VL.CODIGO_LINHA)=TRIM(XL.DADO_ORIGEM))
      AND (
         (VL.DATA_INI_VIGENCIA BETWEEN data_vale1 AND data_vale2)
         OR (VL.DATA_INI_VIGENCIA <=data_vale1 and VL.DATA_fim_VIGENCIA is null)
           OR (data_vale1 BETWEEN VL.DATA_INI_VIGENCIA and VL.DATA_fim_VIGENCIA )
         )
      AND OCORRENCIA          =
        (SELECT MAX (AUX.OCORRENCIA)
        FROM ARTERH.RHVALE_TRANSPORTE AUX
         LEFT OUTER JOIN
        (SELECT *
        FROM ARTERH.RHPESS_CONTRATO CN
        WHERE CN.ANO_MES_REFERENCIA=
          (SELECT MAX(AUX.ANO_MES_REFERENCIA)
          FROM ARTERH.RHPESS_CONTRATO AUX
          WHERE AUX.TIPO_CONTRATO=CN.TIPO_CONTRATO
          AND AUX.CODIGO_EMPRESA =CN.CODIGO_EMPRESA
          AND AUX.CODIGO         = CN.CODIGO
          )
        ) CN
      ON CN.CODIGO         =aux.CODIGO_CONTRATO
      AND CN.TIPO_CONTRATO =aux.TIPO_CONTRATO
      AND CN.CODIGO_EMPRESA=aux.CODIGO_EMPRESA
      LEFT OUTER JOIN ARTERH.RHPESS_PESSOA PAUX
      ON PAUX.CODIGO             =CN.CODIGO_PESSOA
      AND PAUX.CODIGO_EMPRESA    =CN.CODIGO_EMPRESA
        WHERE AUX.CODIGO_EMPRESA  =VL.CODIGO_EMPRESA
        AND AUX.TIPO_CONTRATO     =VL.TIPO_CONTRATO
        AND AUX.CODIGO_LINHA      =VL.CODIGO_LINHA
        AND AUX.CODIGO_ITINERARIO =VL.CODIGO_ITINERARIO
        AND P.CPF=PAUX.CPF
        AND (
         (AUX.DATA_INI_VIGENCIA BETWEEN data_vale1 AND data_vale2)
         OR (AUX.DATA_INI_VIGENCIA <= data_vale1 and AUX.DATA_fim_VIGENCIA is null)
           OR (data_vale1 BETWEEN VL.DATA_INI_VIGENCIA and VL.DATA_fim_VIGENCIA )
         )
        )
        -- AND DATA_INI_VIGENCIA=DATA_FIM
      )
      LOOP
        DBMS_Output.PUT_LINE('Entrou no loop');
        DBMS_Output.PUT_LINE('C1.DATA_INI_VIGENCIA ' || C1.DATA_INI_VIGENCIA);
        DBMS_Output.PUT_LINE('C1.DATA_FIM_VIGENCIA ' || C1.DATA_FIM_VIGENCIA);
        DBMS_Output.PUT_LINE('DATA_INI ' || DATA_INI);
        DBMS_Output.PUT_LINE('DATA_FIM ' || DATA_FIM);
        DBMS_Output.PUT_LINE('ALT_DEFINITIVA ' || ALT_DEFINITIVA);
        CONT                      :=CONT+1;
        DBMS_Output.PUT_LINE('pr verifica');
        IF TIPO                    ='INCLUIR' THEN
          IF C1.DATA_INI_VIGENCIA IS NOT NULL AND C1.DATA_FIM_VIGENCIA IS NULL AND DATA_INI>= C1.DATA_INI_VIGENCIA THEN
            DBMS_Output.PUT_LINE('JA POSSUI REGISTRO ATIVO');
          ELSIF C1.DATA_INI_VIGENCIA IS NOT NULL AND C1.DATA_FIM_VIGENCIA IS NOT NULL AND C1.DATA_FIM_VIGENCIA <DATA_INI THEN
            IF ALT_DEFINITIVA         ='S' THEN 
            dados                  :=OBETER_CONTRATO_VALE( V_CODIGO_EMPRESA,V_TIPO_CONTRATO,V_CPF);
                IF dados.TIPO_CONTRATO IS NOT NULL THEN 
                DBMS_Output.PUT_LINE('dados.TIPO_CONTRATO ' || ALT_DEFINITIVA);
                  SELECT SUBSTR(DADO_DESTINO,0,15) AS CODIGO_LINHA,
                    SUBSTR( DADO_DESTINO,16,4)     AS CODIGO_ITNERARIO
                  INTO COD_LINHA,
                    COD_ITNERARIO
                  FROM ARTERH.RHINTE_ED_IT_CONV
                  WHERE CODIGO_CONVERSAO ='VRLI'
                  AND DADO_ORIGEM        = dados.TIPO_CONTRATO;
                  DBMS_Output.PUT_LINE('cria vale');
                  vQTDE_LINHAS_AFETADAS :=INCLUIR_VALE(dados.CODIGO_EMPRESA, dados.TIPO_CONTRATO, dados.CODIGO_CONTRATO,COD_LINHA,COD_ITNERARIO , DATA_INI,DATA_FIM);
                END IF;
            ELSIF ALT_DEFINITIVA     ='N' THEN
            dados                 :=OBETER_CONTRATO_VALE(V_CODIGO_EMPRESA, V_TIPO_CONTRATO,V_CPF);
               IF dados.TIPO_CONTRATO IS NOT NULL THEN 
                  SELECT SUBSTR(DADO_DESTINO,0,15) AS CODIGO_LINHA,
                    SUBSTR( DADO_DESTINO, 16,4)    AS CODIGO_ITNERARIO
                  INTO COD_LINHA,
                    COD_ITNERARIO
                  FROM ARTERH.RHINTE_ED_IT_CONV
                  WHERE CODIGO_CONVERSAO ='VRLI'
                  AND DADO_ORIGEM        = dados.TIPO_CONTRATO;
                  vQTDE_LINHAS_AFETADAS :=INCLUIR_VALE(dados.CODIGO_EMPRESA, dados.TIPO_CONTRATO, dados.CODIGO_CONTRATO,COD_LINHA,COD_ITNERARIO , DATA_INI,DATA_FIM);
                END IF;
            END IF;           
          END IF;
        ELSIF C1.DATA_INI_VIGENCIA IS NOT NULL AND C1.DATA_FIM_VIGENCIA IS NULL AND TIPO                    ='EXCLUIR' THEN
          DBMS_Output.PUT_LINE('CHAMOU REGISTRO PARA FINALZIAR COM DATA FIM ' ||TO_DATE( TO_DATE(DATA_INI,'DD/MM/rrrr')-1,'DD/MM/rrrr'));
              IF C1.DATA_INI_VIGENCIA >TO_DATE( TO_DATE(DATA_INI,'DD/MM/rrrr')-1,'DD/MM/rrrr')  THEN
               vQTDE_LINHAS_AFETADAS :=ATUALIZAR_VALE (C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO ,C1.DATA_INI_VIGENCIA,ADD_MONTHS(LAST_DAY(TO_DATE(data_vale1,'DD/MM/RRRR')),-1), C1.CODIGO_LINHA ,C1.CODIGO_ITINERARIO);
              ELSE
               vQTDE_LINHAS_AFETADAS :=ATUALIZAR_VALE (C1.CODIGO_EMPRESA, C1.TIPO_CONTRATO, C1.CODIGO_CONTRATO ,C1.DATA_INI_VIGENCIA,TO_DATE( DATA_INI,'DD/MM/rrrr')-1, C1.CODIGO_LINHA ,C1.CODIGO_ITINERARIO);
              END IF;

        END IF;
      END LOOP;
    END;
  END IF;
END;
