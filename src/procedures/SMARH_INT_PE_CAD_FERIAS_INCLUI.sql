
  CREATE OR REPLACE EDITIONABLE PROCEDURE "PONTO_ELETRONICO"."SMARH_INT_PE_CAD_FERIAS_INCLUI" (DATA_INICIO IN VARCHAR2,DATA_FIM IN VARCHAR2)
AS
BEGIN
  DECLARE
    vCONTADOR    NUMBER;
    vDATA_INICIO VARCHAR2(10);
    vDATA_FIM    VARCHAR2(10);
BEGIN
    dbms_output.enable(NULL);
    vCONTADOR    :=0;
    vDATA_INICIO := DATA_INICIO;
    vDATA_FIM    := DATA_FIM;
    FOR C1 IN
    (SELECT  LTRIM(XX.CODIGO_CONTRATO,0)||XX.TIPO_CONTRATO||XX.CODIGO_EMPRESA||XX.CODIGO_JUSTIFICATIVA||XX.DATA_INICIO||XX.DATA_FIM AS CODIGO_LEGADO ,XX.* FROM (
select X.PK_ARTE, x.empresa,x.AGRUPAMENTO_EMPRESA,x.codigo_empresa,x.tipo_contrato,x.codigo_contrato,X.TIPO,X.SITUACAO_PONTO AS CODIGO_JUSTIFICATIVA,CASE
        WHEN TO_DATE(x.DT_INI_GOZO,'DD/MM/YYYY')<= TO_DATE(x.FECHAMENTO_SISTEMA,'DD/MM/YYYY')  and x.FECHAMENTO_SISTEMA IS NOT NULL
        THEN TO_CHAR(TO_DATE(x.FECHAMENTO_SISTEMA,'DD/MM/YYYY')+1,'DD/MM/YYYY')
        WHEN TO_DATE(x.DT_INI_GOZO,'DD/MM/YYYY')>TO_DATE(x.FECHAMENTO_SISTEMA,'DD/MM/YYYY') AND x.FECHAMENTO_SISTEMA IS NOT  NULL
        THEN DT_INI_GOZO
        ELSE x.DT_INI_GOZO
      END AS DATA_INICIO,X.DT_FIM_GOZO AS DATA_FIM ,X.DT_SAIU_ARTE,'FERIAS' ORIGEM,X.DESCRICAO_JUSTIFICATIVA  from (
SELECT
  TG.CODIGO_EMPRESA,--PK6
  CASE
    WHEN TG.CODIGO_EMPRESA = '0001'
    THEN 'PREF.MUN.BELO HORIZONTE'
    WHEN TG.CODIGO_EMPRESA = '0098'
    THEN 'PREF.MUN.BH CONTRATOS'
  END          AS EMPRESA,
  'ADM DIRETA' AS AGRUPAMENTO_EMPRESA,
  PF.SITUACAO_PONTO,
  TG.TIPO_CONTRATO,                            --PK5
  TG.CODIGO_CONTRATO,                          --pk1
  TG.NEW_DT_INI_AQUISICAO AS DT_INI_AQUISICAO, --PK2 novo 27/12/2016
  TG.NEW_TIPO_FERIAS      AS TIPO_FERIAS,      --PK3 novo 27/12/2016
  TG.NEW_PERIODO          AS PERIODO,          --PK4 novo 27/12/2016
  to_char(TG.NEW_DT_INI_GOZO,'dd/mm/yyyy')      AS DT_INI_GOZO,
  CASE
    WHEN TG.NEW_STATUS_CONFIRMACAO =1
    THEN TG.NEW_DT_FIM_GOZO
    WHEN TG.NEW_STATUS_CONFIRMACAO in ('5','D')
    THEN
      (SELECT MAX(DT.DATA_DIA)
      FROM PONTO_ELETRONICO.SUGESP_BI_RHFERI_FERIAS fe,
        ARTERH.RHTABS_DATAS DT
      WHERE fe.CODIGO_EMPRESA     =TG.CODIGO_EMPRESA
      AND fe.TIPO_CONTRATO        = TG.TIPO_CONTRATO
      AND fe.NEW_DT_INI_AQUISICAO =TG.NEW_DT_INI_AQUISICAO
      AND fe.NEW_DT_FIM_AQUISICAO =TG.NEW_DT_FIM_AQUISICAO
      AND fe.CODIGO_CONTRATO      = TG.codigo_contrato
      AND DT.DATA_DIA BETWEEN TG.NEW_DT_INI_GOZO AND TG.NEW_DT_RETORNO-1
      AND fe.NEW_STATUS_CONFIRMACAO =TG.NEW_STATUS_CONFIRMACAO
      AND DT.DATA_DIA NOT          IN
        (SELECT F.DATA_DIA
        FROM ARTERH.RHPARM_CALEND_DT F
        WHERE F.CODIGO  = '0001'
        AND DT.DATA_DIA = F.DATA_DIA))
        else TG.NEW_DT_FIM_GOZO
  END DT_FIM_GOZO,
  SYSDATE              AS DT_SAIU_ARTE,
  'INCLUIR'            AS TIPO ,
  TG.DT_ULT_ALTER_USUA AS DT_ULT_ALTER_USUA,
 /* CASE WHEN  CASE WHEN TO_CHAR(W.FECHAMENTO_AGRUPADOR,'DD/MM/YYYY') IS NOT NULL THEN TO_CHAR(W.FECHAMENTO_AGRUPADOR,'DD/MM/YYYY') WHEN TO_CHAR(W.FECHAMENTO_ORGANOGRAMA,'DD/MM/YYYY') IS NOT NULL THEN TO_CHAR(add_months(W.FECHAMENTO_ORGANOGRAMA,-1),'DD/MM/YYYY')
          WHEN W.FECHAMENTO_AGRUPADOR IS NULL AND W.FECHAMENTO_ORGANOGRAMA IS NULL THEN TO_CHAR(add_months((SELECT MAX(W.FECHAMENTO_AGRUPADOR)AS DATA_FINAL FROM ARTERH.SUGESP_DATA_APURACAO_FREQUENC W),-1),'DD/MM/YYYY')
          ELSE TO_CHAR(add_months(W.FECHAMENTO_GERAL,-1),'DD/MM/YYYY')
          END >=LAST_DAY(SYSDATE) THEN LAST_DAY(ADD_MONTHS(SYSDATE,-1)) ELSE  CASE WHEN TO_CHAR(W.FECHAMENTO_AGRUPADOR,'DD/MM/YYYY') IS NOT NULL THEN TO_CHAR(W.FECHAMENTO_AGRUPADOR,'DD/MM/YYYY') WHEN TO_CHAR(W.FECHAMENTO_ORGANOGRAMA,'DD/MM/YYYY') IS NOT NULL THEN TO_CHAR(add_months(W.FECHAMENTO_ORGANOGRAMA,-1),'DD/MM/YYYY')
          WHEN W.FECHAMENTO_AGRUPADOR IS NULL AND W.FECHAMENTO_ORGANOGRAMA IS NULL THEN TO_CHAR(add_months((SELECT MAX(W.FECHAMENTO_AGRUPADOR)AS DATA_FINAL FROM ARTERH.SUGESP_DATA_APURACAO_FREQUENC W),-1),'DD/MM/YYYY')
          ELSE TO_CHAR(add_months(W.FECHAMENTO_GERAL,-1),'DD/MM/YYYY')
          END
          END */
          (SELECT    dado_origem FROM     ARTERH.rhinte_ed_it_conv cv WHERE codigo_conversao = 'FCPT' AND TO_DATE(dado_origem,'DD/MM/YYYY') = (SELECT MAX(TO_DATE(AUX.dado_origem,'DD/MM/YYYY')) FROM arterh.rhinte_ed_it_conv aux WHERE cv.codigo_conversao = aux.codigo_conversao))          FECHAMENTO_SISTEMA
          ,PF.DESCRICAO AS DESCRICAO_JUSTIFICATIVA
,TG.CODIGO_EMPRESA||TG.TIPO_CONTRATO||TG.CODIGO_CONTRATO 
||CASE WHEN TG.TIPO_COMANDO = 'D' THEN TG.OLD_DT_INI_AQUISICAO ELSE TG.NEW_DT_INI_AQUISICAO END-- DT_INI_AQUISICAO,
||CASE WHEN TG.TIPO_COMANDO = 'D' THEN TG.OLD_TIPO_FERIAS ELSE TG.NEW_TIPO_FERIAS END --TIPO_FERIAS,
||CASE WHEN TG.TIPO_COMANDO = 'D' THEN TG.OLD_PERIODO ELSE TG.NEW_PERIODO END --PERIODO
PK_ARTE
  FROM PONTO_ELETRONICO.SUGESP_BI_RHFERI_FERIAS TG
  LEFT OUTER JOIN ARTERH.RHPESS_CONTRATO B
  ON B.CODIGO_EMPRESA=TG.CODIGO_EMPRESA
  AND B.TIPO_CONTRATO=TG.TIPO_CONTRATO
  AND B.CODIGO=TG.CODIGO_CONTRATO
  LEFT OUTER JOIN  ARTERH.RHPARM_SIT_FUNC S
  ON S.CODIGO=B.SITUACAO_FUNCIONAL
  LEFT OUTER JOIN ARTERH.RHPARM_P_FERI PF
  ON PF.CODIGO_EMPRESA= TG.CODIGO_EMPRESA
  AND PF.CODIGO= TG.NEW_TIPO_FERIAS
  LEFT OUTER JOIN
          (SELECT * FROM ARTERH.RHINTE_ED_IT_CONV WHERE CODIGO_CONVERSAO='PONT')PONTR
          ON   SUBSTR(PONTR.DADO_ORIGEM,20,4)=TG.CODIGO_EMPRESA
          AND SUBSTR(PONTR.DADO_ORIGEM,24,4)=TG.TIPO_CONTRATO

   WHERE SUBSTR(PONTR.DADO_ORIGEM,20,4)IS NOT NULL
              AND TG.NEW_DT_INI_GOZO        IS NOT NULL
              AND TG.NEW_DT_FIM_GOZO        IS NOT NULL
              AND TG.NEW_STATUS_CONFIRMACAO IN('1','5','D')

              AND B.ANO_MES_REFERENCIA       =(SELECT MAX(ANO_MES_REFERENCIA)
              FROM ARTERH.RHPESS_CONTRATO AUX WHERE AUX.CODIGO_EMPRESA = B.CODIGO_EMPRESA
              AND AUX.TIPO_CONTRATO    = B.TIPO_CONTRATO
              AND AUX.CODIGO           = B.CODIGO
              AND AUX.ANO_MES_REFERENCIA <=(SELECT data_do_sistema FROM ARTERH.rhparm_p_sist))
              AND S.CONTROLE_FOLHA NOT IN ('D','S')
              AND B.DATA_RESCISAO      IS NULL
              AND B.situacao_funcional <>1002
              AND TG.NEW_DT_INI_GOZO   >= TO_DATE('01/01/2021', 'DD/MM/YYYY')
              AND TG.TIPO_COMANDO      IN('I','U')
            --  AND TG.CODIGO_CONTRATO IN LPAD('1182364',15,0)
              AND TG.DT_ULT_ALTER_USUA  =(SELECT MAX (AUX.DT_ULT_ALTER_USUA)
              FROM PONTO_ELETRONICO.SUGESP_BI_RHFERI_FERIAS AUX
              WHERE AUX.CODIGO_EMPRESA=TG.CODIGO_EMPRESA
              AND AUX.CODIGO_CONTRATO = TG.CODIGO_CONTRATO
              AND AUX.TIPO_CONTRATO   = TG.TIPO_CONTRATO
              AND AUX.NEW_TIPO_FERIAS = TG.NEW_TIPO_FERIAS
               AND AUX.NEW_PERIODO=TG.NEW_PERIODO
              AND AUX.NEW_DT_INI_AQUISICAO =TG.NEW_DT_INI_AQUISICAO
              AND AUX.NEW_DT_FIM_AQUISICAO =TG.NEW_DT_FIM_AQUISICAO
             /* AND AUX.NEW_DT_INI_GOZO=TG.NEW_DT_INI_GOZO
              AND AUX.NEW_DT_FIM_GOZO=TG.NEW_DT_FIM_GOZO*/
          --   AND AUX.NEW_STATUS_CONFIRMACAO IN('1','5','D')
              )
             AND EXISTS (SELECT CODIGO_CONTRATO FROM ARTERH.RHFERI_FERIAS F
              WHERE F.CODIGO_CONTRATO=TG.CODIGO_CONTRATO
              AND F.TIPO_CONTRATO=TG.TIPO_CONTRATO
              AND F.CODIGO_EMPRESA=TG.CODIGO_EMPRESA
              AND F.TIPO_FERIAS=TG.NEW_TIPO_FERIAS
                AND F.DT_INI_AQUISICAO =TG.NEW_DT_INI_AQUISICAO
              AND F.DT_FIM_AQUISICAO =TG.NEW_DT_FIM_AQUISICAO
              AND F.DT_INI_GOZO=TG.NEW_DT_INI_GOZO
              AND F.DT_FIM_GOZO=TG.NEW_DT_FIM_GOZO)

        AND (TRUNC(TG.DT_ULT_ALTER_USUA) BETWEEN vDATA_INICIO AND vDATA_FIM)
)x
WHERE ((TO_DATE(X.DT_INI_GOZO)>CASE WHEN TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020','DD/MM/YYYY') ELSE TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY') END)
or
(TO_DATE(X.DT_FIM_GOZO)>CASE WHEN TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY') IS NULL THEN TO_DATE('01/01/2020','DD/MM/YYYY') ELSE TO_DATE(X.FECHAMENTO_SISTEMA,'DD/MM/YYYY') END)
)
)xx
/* Gabriel aqui ativar para validar se as ferias nÃ£o esta concomitando com um afastamento sem data fim
WHERE NOT EXISTS (SELECT X.* FROM (SELECT SF.CODIGO_EMPRESA,SF.TIPO_CONTRATO,SF.CODIGO,S.CODIGO as SITUACAO_FUNCIONAL,S.DESCRICAO,S.CONTROLE_FOLHA,SF.DATA_INIC_SITUACAO,SF.DATA_FIM_SITUACAO FROM ARTERH.RHCGED_ALT_SIT_FUN SF 
INNER JOIN ARTERH.RHPARM_SIT_FUNC S
ON S.CODIGO=SF.COD_SIT_FUNCIONAL
AND S.SITUACAO_PONTO IS NOT NULL
AND S.CONTROLE_FOLHA NOT IN ('D','S')
LEFT OUTER JOIN ARTERH.RHINTE_ED_IT_CONV CV 
ON CV.CODIGO_CONVERSAO = 'CESS' 
AND CV.DADO_ORIGEM = s.CODIGO
WHERE SF.CODIGO_EMPRESA='0001' AND TIPO_CONTRATO='0001' AND SF.DATA_FIM_SITUACAO IS NULL  
AND CV.DADO_ORIGEM IS NULL
)X
WHERE X.CODIGO_EMPRESA=XX.CODIGO_EMPRESA
AND X.TIPO_CONTRATO=XX.TIPO_CONTRATO
AND X.codigo=xx.codigo_contrato
and xx.DATA_INICIO>=x.DATA_INIC_SITUACAO
)*/
              )
    LOOP
      vCONTADOR :=vCONTADOR+1;
      dbms_output.put_line(vCONTADOR);
      dbms_output.put_line(vDATA_INICIO||'-'||vDATA_FIM);
      INSERT
      INTO PONTO_ELETRONICO.SMARH_INT_PE_AFASTAMENTOS_V1
        (
          EMPRESA,
          AGRUPAMENTO_EMPRESA,
          CODIGO_LEGADO,
          TIPO,
          CODIGO_EMPRESA,
          TIPO_CONTRATO,
          CODIGO_CONTRATO,
          CODIGO_JUSTIFICATIVA,
          DESCRICAO,
          DATA_INICIO,
          DATA_FIM,
          DT_SAIU_ARTE,
          ORIGEM
,CODIGO_INTEGRA_ARTE
,PK_ARTE
        )
        VALUES
        (
          C1.EMPRESA,
          C1.AGRUPAMENTO_EMPRESA,
          C1.CODIGO_LEGADO,
          C1.TIPO,
          C1.CODIGO_EMPRESA,
          C1.TIPO_CONTRATO,
          C1.CODIGO_CONTRATO,
          C1.CODIGO_JUSTIFICATIVA,
          C1.DESCRICAO_JUSTIFICATIVA,
          C1.DATA_INICIO,
          C1.DATA_FIM,
          C1.DT_SAIU_ARTE,
          C1.ORIGEM
  ,PONTO_ELETRONICO.SEQUENCE_INTEGRA_ARTE.NEXTVAL   
  ,C1.PK_ARTE --NOVO EM 30/8/22
          );
      COMMIT;
    END LOOP;
  END;
END SMARH_INT_PE_CAD_FERIAS_INCLUI;